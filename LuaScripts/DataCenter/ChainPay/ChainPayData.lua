---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/1/6 14:43
---

local ChainPayData = BaseClass("ChainPayData")

local function __init(self)
    self.actId = 0
    self.boxes = {}
    self.groupDict = {}
end

local function __delete(self)
    self.actId = nil
    self.boxes = nil
    self.groupDict = nil
end

local function GetBoxById(self, boxId)
    for _, box in ipairs(self.boxes) do
        if box.id == boxId then
            return box
        end
    end
    return nil
end

local function GetRedNum(self)
    local redNum = 0
    local index = self:GetLastReceivedIndex() + 1
    local box = self.boxes[index]
    if box and (box.state == ChainPayBoxState.Default and box:IsFree() or box.state == ChainPayBoxState.Unlocked) then
        redNum = 1
    end
    if self:IsNew() then
        redNum = 1
    end
    return redNum
end

local function GetLastReceivedIndex(self)
    local index = 0
    for i, box in ipairs(self.boxes) do
        if box.state == ChainPayBoxState.Received then
            index = i
        else
            break
        end
    end
    return index
end

local function IsNew(self)
    local actData = DataCenter.ActivityListDataManager:GetActivityDataById(tostring(self.actId))
    if actData == nil then
        return false
    end
    local visitTime = tonumber(Setting:GetPrivateString(SettingKeys.CHAIN_PAY_VISIT_TIME .. self.actId, "0")) or 0
    return visitTime < actData.startTime
end

ChainPayData.__init = __init
ChainPayData.__delete = __delete

ChainPayData.GetBoxById = GetBoxById
ChainPayData.GetRedNum = GetRedNum
ChainPayData.GetLastReceivedIndex = GetLastReceivedIndex
ChainPayData.IsNew = IsNew

return ChainPayData
