---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by w.
--- DateTime: 2022/12/28 17:15
---

---@class ParkourBattleData
local ParkourBattleData = BaseClass("ParkourBattleData")
local ConstLW = require("Scene.LWBattle.Const")

local function __init(self,id)
    self:InitData(id)
end
local function __delete(self)
    
end

local function Contains(self,x,z)
    for _,v in pairs(self.bossRect) do
        if v.xMin<x and x<v.xMax and v.zMin<z and z<v.zMax then
            return true
        end
    end
    return false
end


local function InitData(self,stageMetaId)
    self.metaId = stageMetaId
    local line = LocalController:instance():getLine(LuaEntry.Player:GetABTestTableName(TableName.LW_Stage_Feature), stageMetaId)
    self.meta = line
    
    --出生点
    local initPos = string.split(line:getValue("birth_point") or "", "|")
    self.initPosX = tonumber(initPos[1])
    self.initPosY = tonumber(initPos[2])
    --终点
    self.endLine = line:getValue("boss_line")
    local boss_area_str = line:getValue("boss_area")
    boss_area_str = string.split(boss_area_str,";")
    self.bossRect={}
    for _,v in pairs(boss_area_str) do
        local rect={}
        local boss_area_param = string.split(v,"|")
        rect.xMin=BARRAGE_SCENE_CENTER-tonumber(boss_area_param[2])*0.5
        rect.xMax=BARRAGE_SCENE_CENTER+tonumber(boss_area_param[2])*0.5
        rect.zMin=tonumber(boss_area_param[1])
        rect.zMax=tonumber(boss_area_param[1]) + tonumber(boss_area_param[3])
        table.insert(self.bossRect,rect)
    end
    self.moveSpeedX = line:getValue("speed_x")
    self.moveSpeedZ = line:getValue("speed_z")
    self.moveDeltaMulti = 1
    
    --场景
    self.sceneCfgArr = {}
    local sceneIdArray = string.split(line:getValue("scene") or "", ",")
    local offset = 0;
    for _, sceneId in ipairs(sceneIdArray) do
        local sceneMeta = LocalController:instance():getLine(LuaEntry.Player:GetABTestTableName(TableName.LW_Scene), sceneId)
        local sceneCfg = {}
        sceneCfg.meta = sceneMeta
        sceneCfg.offset = offset
        sceneCfg.isDeco = false
        table.insert(self.sceneCfgArr, sceneCfg)
        offset = offset + sceneMeta.scene_size
    end
    local sceneMeta = LocalController:instance():getLine(LuaEntry.Player:GetABTestTableName(TableName.LW_Scene), line:getValue("scene_tail"))
    local sceneCfg = {}
    sceneCfg.meta = sceneMeta
    sceneCfg.offset = offset
    sceneCfg.isDeco = true
    table.insert(self.sceneCfgArr, sceneCfg)
    offset = offset + sceneMeta.scene_size

    -- head
    sceneCfg = {}
    sceneCfg.meta = sceneMeta
    sceneCfg.offset = -1 * sceneMeta.scene_size
    sceneCfg.isDeco = true
    table.insert(self.sceneCfgArr, sceneCfg)

    -- 从表读胜利条件
    self.winCondition = {}
    local winParam = string.split( self.meta.win_condition,"|")
    local winType = tonumber(winParam[1])
    self.winCondition.winType = winType

    if winType == ConstLW.ParkourWinType.KillTargetMonster then
        self.winCondition.needKillTarget={}
        local targetIds = string.split( winParam[2],",")
        local targetNums = string.split( winParam[3] or "1",",")
        local needValue=0
        for i = 1, #targetIds do
            --self.winCondition.needKillTarget[targetIds[i]]=targetNums[i]
            local target={}
            target.id=tonumber(targetIds[i])
            local need = tonumber(targetNums[i]) 
            target.need=need
            target.finish=0
            needValue = needValue + need
            self.winCondition.needKillTarget[target.id]=target
        end
        self.winCondition.needKillTargetNum = needValue
    elseif(winType == ConstLW.ParkourWinType.SaveWorker) then
        self.winCondition.needSaveNum = tonumber(winParam[2])
    elseif(winType == ConstLW.ParkourWinType.KillMonster) then
        self.winCondition.needKillNum = tonumber(winParam[2])
    elseif winType == ConstLW.ParkourWinType.KillBoss then
        self.winCondition.needKillNum = tonumber(winParam[2])
    end
    
    --boss阶段显示摇杆操作
    local bossControlValue = line:getValue("boss_control")
    self.teamBossControlState = ConstLW.ParkourTeamBossControlState.AllDirection
    if bossControlValue == 2 then
        self.teamBossControlState = ConstLW.ParkourTeamBossControlState.Horizontal
    elseif bossControlValue == 1 then
        self.teamBossControlState = ConstLW.ParkourTeamBossControlState.Stay
    end
    --self.bossControl = bossControlValue == "" or bossControlValue == "0"

    --1:结算时显示伤害统计 其他：旧版显示击杀数
    --self.showStatistic = line:getValue("end_type") == "1"
    self.showStatistic = true -- TODO: Beef 先显示
    
    self.battleType = line:getValue("type")
    
    self.title = line:getValue("title")
    self.target = line:getValue("target")
    self.hideTitle = line:getValue("if_title") == "1"

    local special_pos = line:getValue("special_pos")
    if not string.IsNullOrEmpty(special_pos) then
        local specialPosArray = string.split(special_pos, "|")
        self.specialPos = {}
        for i = 1, #specialPosArray do
            table.insert(self.specialPos, tonumber(specialPosArray[i]))
        end
    end

end

ParkourBattleData.__init = __init
ParkourBattleData.__delete = __delete
ParkourBattleData.InitData = InitData
ParkourBattleData.Contains = Contains
return ParkourBattleData

