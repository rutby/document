---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/10/25 15:04
---
local WorldAllianceCityData = BaseClass("WorldAllianceCityData")

local function __init(self)
    self.cityId = 0
    self.attackList = {}
    self.defenceList = {}
    self.battleStartTime =0 
    self.armyUnit = {}
    self.firstOccupyInfo = nil
    self.armyNum = 0
    self.maxArmyNum = 0
    self.durabilityMax = 0
    self.selfKillPoint = 0
end

local function __delete(self)
    self.cityId =nil
    self.attackList = nil
    self.defenceList = nil
    self.firstOccupyInfo = nil
    self.durabilityMax = nil
    self.selfKillPoint = 0
end

local function ParseData(self, message)
    if message ==nil then
        return
    end
    if message["cityId"]~=nil then
        self.cityId = message["cityId"]
    end
    if message["battleStartTime"]~=nil then
        self.battleStartTime = message["battleStartTime"]
    end
    if message["armyUnit"]~=nil then
        self.armyUnit = PBController.ParsePb1(message["armyUnit"], "protobuf.ArmyUnitInfo")
    end
    self:SetArmyBlood()
    self.attackList = {}
    self.defenceList = {}
    if message["attackInfos"]~=nil then
        local arr = message["attackInfos"]
        table.walk(arr,function(k,v)
            local oneData = {}
            if v["alAbbr"]~=nil then
                oneData.alAbbr = v["alAbbr"]
            end
            if v["alName"]~=nil then
                oneData.alName = v["alName"]
            end
            if v["point"]~=nil then
                oneData.point = v["point"]
            end
            if v["alId"]~=nil then
                oneData.allianceId = v["alId"]
            end
            if v["buildPoint"]~=nil then
                oneData.buildPoint = v["buildPoint"]
            end
            table.insert(self.attackList,oneData)
        end)
        table.sort(self.attackList, function(a, b)
            if a.point ~= b.point then
                return a.point > b.point
            else
                return false
            end
        end)
    end

    if message["defendInfo"]~=nil then
        local arr = message["defendInfo"]
        local oneData = {}
        if arr["alAbbr"]~=nil then
            oneData.alAbbr = arr["alAbbr"]
        end
        if arr["alName"]~=nil then
            oneData.alName = arr["alName"]
        end
        table.insert(self.defenceList,oneData)
    end
    if message["durabilityMax"] then
        self.durabilityMax = message["durabilityMax"]
    end

    self.firstOccupyInfo = nil
    if message["firstOccupyInfo"]~=nil then
        local obj = message["firstOccupyInfo"]
        if obj~=nil then
            self.firstOccupyInfo = {}
            if obj["firstOccupyTime"]~=nil then
                self.firstOccupyInfo.firstOccupyTime = obj["firstOccupyTime"]
            end
            if obj["alAbbr"]~=nil then
                self.firstOccupyInfo.alAbbr = obj["alAbbr"]
            end
            if obj["alName"]~=nil then
                self.firstOccupyInfo.alName = obj["alName"]
            end
            if obj["alIcon"]~=nil then
                self.firstOccupyInfo.alIcon = obj["alIcon"]
            end
        end
    end

    if message["selfKillPoint"]~=nil then
        self.selfKillPoint = message["selfKillPoint"]
    end
end

local function SetArmyBlood(self)
    if self.armyUnit~=nil then
        self.armyNum = 0
        self.maxArmyNum = 0
        local soldier = self.armyUnit.soldiers
        if soldier~=nil then
            for k,v in pairs(soldier) do
                local template = DataCenter.ArmyTemplateManager:GetArmyTemplate(tonumber(v.armsId))
                if template ~= nil then
                    local curNum = v.total-v.lost
                    local hp = template.health
                    self.armyNum = self.armyNum +(hp*curNum)
                    self.maxArmyNum = self.maxArmyNum+(hp*v.total)
                end
            end
        end
    end
end
WorldAllianceCityData.__init = __init
WorldAllianceCityData.__delete = __delete
WorldAllianceCityData.ParseData = ParseData
WorldAllianceCityData.SetArmyBlood = SetArmyBlood
return WorldAllianceCityData