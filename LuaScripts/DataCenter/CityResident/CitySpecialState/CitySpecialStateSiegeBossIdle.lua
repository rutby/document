---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/2 10:44
---

local CitySpecialStateBase = require "DataCenter.CityResident.CitySpecialState.CitySpecialStateBase"
local CitySpecialStateSiegeBossIdle = BaseClass("CitySpecialStateSiegeBossIdle", CitySpecialStateBase)

local SpawnDelay = 8

local function OnUpdate(self, deltaTime)
    self.spawnCd = self.spawnCd - deltaTime
    if self.spawnCd < 0 then
        self.spawnCd = DataCenter.CitySiegeManager:GetSpawnInterval()
        
        local line = LocalController:instance():getLine(TableName.CitySiegeZombie, self.data.zombieId)
        if line.canSpawn == 1 then
            local curTime = UITimeManager:GetInstance():GetServerTime()
            local dayNight = DataCenter.VitaManager:GetDayNight(curTime)
            local vitaTime = VitaUtil.RealTimeToVita(curTime)
            local todayMinute = VitaUtil.VitaTimeTodayMinute(vitaTime)
            
            -- 生成丧尸(6 ~ 7 点不生成、深夜不生成)
            if (todayMinute < 6 * 60 or todayMinute >= 7 * 60) and dayNight ~= VitaDefines.DayNight.LateAtNight then
                local count = DataCenter.CitySiegeManager:GetSpawnCount()
                local lifetime = DataCenter.CitySiegeManager:GetZombieLifetime()
                DataCenter.CitySiegeManager:SpawnZombieAround(self.data.zombieId, count, lifetime)
                local duration = self.data:GetAnimDuration("show")
                self.data:PlayAnim("show")
                self.data:WaitForFinish(duration)
            end
            
            -- 喊话
            local triggerType = nil
            if dayNight == VitaDefines.DayNight.Day then
                triggerType = CityResidentDefines.TalkTriggerType.BossSiegeDay
            elseif dayNight == VitaDefines.DayNight.Night then
                if DataCenter.CityResidentManager:IsZombieInvade() then
                    triggerType = CityResidentDefines.TalkTriggerType.BossSiegeNightInvade
                else
                    triggerType = CityResidentDefines.TalkTriggerType.BossSiegeNight
                end
            end
            if triggerType then
                local param = {}
                param.type = triggerType
                param.rUuid = self.data.uuid
                param.bgType = 2
                param.worldOffset = Vector3.New(0, 4, 0)
                DataCenter.CityResidentManager:TryResidentTalk(param)
            end
        end
    end
end

local function OnEnter(self)
    self.spawnCd = SpawnDelay
    
    local line = LocalController:instance():getLine(TableName.CitySiegeZombie, self.data.zombieId)
    local rot = Quaternion.Euler(0, line.spawn_Rotation or 0, 0)
    self.data:Idle()
    self.data:PlayAnim("idle")
    self.data:SetRot(rot)
end

local function OnFinish(self)
    self.data:PlayAnim("idle")
end

CitySpecialStateSiegeBossIdle.OnUpdate = OnUpdate
CitySpecialStateSiegeBossIdle.OnEnter = OnEnter
CitySpecialStateSiegeBossIdle.OnFinish = OnFinish

return CitySpecialStateSiegeBossIdle