---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/11/23 10:52
---

local CityHeroStateBase = require "DataCenter.CityResident.CityHeroState.CityHeroStateBase"
local CityHeroStateAttack = BaseClass("CityHeroStateAttack", CityHeroStateBase)

local function OnUpdate(self, deltaTime)
    local zombieData = self.data.target
    if zombieData then
        if not self.fired then
            self.time = self.time + deltaTime
            if self.time > self.fireDelay then
                self.fired = true
                self:Fire()
            end
        end
    else
        self.data:Refresh()
    end
end

local function OnEnter(self)
    local zombieData = self.data.target
    if zombieData then
        self.time = 0
        self.fired = false
        self.fireDelay = 0
        for _, cfg in pairs(CityResidentDefines.HeroConfig) do
            if cfg.uuid == self.data.uuid then
                self.fireDelay = cfg.fireDelay
                self.fireSound = cfg.fireSound
            end
        end
        
        self.data:LookAt(zombieData:GetPos())
        self.data:ShowHeroWeapon()
        self.data:ShowFireParticle()
        self.data:Idle()
        local animName = CityResidentDefines.AnimName.Attack01
        local duration = self.data:GetAnimDuration(animName)
        self.data:PlayAnim(animName, nil, true)
        self.data:WaitForFinish(duration)
    else
        self.data:Refresh()
    end
end

local function OnExit(self)
    if self.delayTimer then
        self.delayTimer:Stop()
        self.delayTimer = nil
    end
end

local function OnFinish(self)
    self.data:HideFireParticle()
    local zombieData = self.data.target
    if zombieData then
        if zombieData:IsDead() then
            zombieData.attacker = nil
            self.data.target = nil
            self.data:SetState(CityResidentDefines.HeroState.GoToIdle)
            self.data:SearchZombie()
        else
            self:OnEnter()
        end
    end
end

local function Fire(self)
    local zombieData = self.data.target
    if zombieData then
        local lod = CS.SceneManager.World:GetLodLevel()
        if lod <= 1 then
            self.data.obj:Play3DSound(self.fireSound)
        end
        --zombieData:LookAt(self.data:GetPos())
        zombieData:Hurt(1)
        if not zombieData:IsDead() then
            zombieData:SetState(CityResidentDefines.ZombieState.Hurt)
        end
    end
end

CityHeroStateAttack.OnUpdate = OnUpdate
CityHeroStateAttack.OnEnter = OnEnter
CityHeroStateAttack.OnExit = OnExit
CityHeroStateAttack.OnFinish = OnFinish
CityHeroStateAttack.Fire = Fire

return CityHeroStateAttack