---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/22 17:37
---

---
--- 主城动物管理器
---
local CityResidentAnimalManager = BaseClass("CityResidentAnimalManager")

local function __init(self)
    self.created = false
    self.nextUuid = 300000
    self.wayPointToDataDict = {} -- Dict<wayPoint.id, data>
end

local function __delete(self)
    self:DestroyAll()
end

local function CreateAtWayPoint(self, wayPoint)
    local data = self:GetDataByWayPointId(wayPoint.id)
    if data then
        return data
    end
    
    local uuid = self:GetNextUuid()
    local param = {}
    param.pos = self:GetWanderPos(wayPoint.pos)
    param.rot = Quaternion.Euler(0, math.random(0, 360), 0)
    param.animalType = CityResidentDefines.AnimalType.Deer
    data = DataCenter.CityResidentManager:AddData(uuid, CityResidentDefines.Type.Animal, param)
    self.wayPointToDataDict[wayPoint.id] = data
    return data
end

local function DestroyAll(self)
    if not self.created then
        return
    end
    
    local dataList = DataCenter.CityResidentManager:GetDataListByType(CityResidentDefines.Type.Animal)
    for _, data in ipairs(dataList) do
        DataCenter.CityResidentManager:RemoveData(data.uuid)
    end
    
    self.created = false
end

local function GetNextUuid(self)
    self.nextUuid = self.nextUuid + 1
    return self.nextUuid
end

local function GetWanderPos(self, pos)
    local radius = CityResidentDefines.AnimalWanderRange
    local angle = math.random(0, 360)
    local dir = Vector3.New(radius, 0, 0)
    dir = Quaternion.Euler(0, angle, 0) * dir
    return pos + dir * radius
end

local function IsCreateDayNight(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local dayNight = DataCenter.VitaManager:GetDayNight(curTime)
    return dayNight ~= VitaDefines.DayNight.LateAtNight
end

local function GetDataByWayPointId(self, id)
    return self.wayPointToDataDict[id]
end

local function ClearDataByWayPoint(self, id)
    self.wayPointToDataDict[id] = nil
end

local function OnDayNightChange(self)
    if not DataCenter.CityResidentManager:IsEngaged() then
        return
    end
    
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local dayNight = DataCenter.VitaManager:GetDayNight(curTime)
    if dayNight == VitaDefines.DayNight.LateAtNight then
        self:DestroyAll()
    end
end

CityResidentAnimalManager.__init = __init
CityResidentAnimalManager.__delete = __delete

CityResidentAnimalManager.CreateAtWayPoint = CreateAtWayPoint
CityResidentAnimalManager.DestroyAll = DestroyAll
CityResidentAnimalManager.GetNextUuid = GetNextUuid
CityResidentAnimalManager.GetWanderPos = GetWanderPos
CityResidentAnimalManager.IsCreateDayNight = IsCreateDayNight
CityResidentAnimalManager.GetDataByWayPointId = GetDataByWayPointId
CityResidentAnimalManager.ClearDataByWayPoint = ClearDataByWayPoint

CityResidentAnimalManager.OnDayNightChange = OnDayNightChange

return CityResidentAnimalManager