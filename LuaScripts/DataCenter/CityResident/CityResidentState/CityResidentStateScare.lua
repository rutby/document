---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/11/23 10:52
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateScare = BaseClass("CityResidentStateScare", CityResidentStateBase)

local function OnUpdate(self, deltaTime)
    -- 减少心情值
    self.moodCd = self.moodCd - deltaTime
    if self.moodCd <= 0 then
        local deltaMood = CityResidentDefines.ResidentScareMood
        self.moodCd = CityResidentDefines.ResidentScareMoodInterval
        local hudParam = {}
        hudParam.type = CityHudType.PopText
        hudParam.pos = self.data:GetPos()
        hudParam.icon = string.format(LoadPath.UIVita, "UItemperature_icon_mood03")
        hudParam.text = "<color=red>" .. deltaMood .. "</color>"
        hudParam.offset = Vector3.New(0, 50, 0)
        hudParam.duration = 1
        hudParam.location = CityHudLocation.World
        DataCenter.CityHudManager:Create(hudParam)
        self.data.residentData:ChangeMood(deltaMood)
    end

    local curTime = UITimeManager:GetInstance():GetServerTime()
    if curTime - self.data.scareStartTime >= CityResidentDefines.ResidentScareDuration * 1000 then
        self.data:Refresh()
    end
end

local function OnEnter(self)
    self.moodCd = CityResidentDefines.ResidentScareMoodInterval
    
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.data.scareStartTime = curTime
    self.data:PlayAnim(CityResidentDefines.AnimName.Run)
    self.data:ShowTool("")
    self.data:SetSpeed(DataCenter.CityResidentManager:GetResidentRunSpeed())
    self.data:SetAutoAnim(true)
    
    local hideBUuid = nil
    if self.data:IsInBuilding() and not self.data:IsInDestroyedBuilding() then
        hideBUuid = self.data.atBUuid
    else
        local curPos = self.data:GetPos()
        local minDisSqr = (curPos.x - 101) ^ 2 + (curPos.z - 101) ^ 2 -- 到大本的距离
        local minDisBUuid = 0
        for _, buildId in ipairs(CityResidentDefines.ScareHideBuildIds) do
            local buildData = DataCenter.BuildManager:GetFunbuildByItemID(buildId)
            if buildData and buildData.level > 0 and buildData:GetCurStamina() > 0 then
                local buildTemplate = DataCenter.BuildTemplateManager:GetBuildingDesTemplate(buildId)
                local buildPos = buildTemplate:GetPosition()
                local disSqr = (curPos.x - buildPos.x) ^ 2 + (curPos.z - buildPos.z) ^ 2
                if disSqr < minDisSqr then
                    minDisSqr = disSqr
                    minDisBUuid = buildData.uuid
                end
            end
        end
        if minDisBUuid ~= 0 then
            hideBUuid = minDisBUuid
        end
    end
    
    if hideBUuid then
        -- 躲到建筑
        local wayPoint = DataCenter.CityResidentManager.occupyMgr:TryOccupyRandomWayPoint(self.data.uuid, hideBUuid, CityResidentDefines.WayPointFlag.SafeHide)
        if wayPoint then
            self.data:GoToBuildingPos(hideBUuid, wayPoint.pos, false)
        else
            self.data:Refresh()
        end
    else
        -- 躲到大本
        local mask = DataCenter.CityResidentManager:GetCurrentCityMask()
        local pos = WayPointUtil.GetRandomPos(mask, CityResidentDefines.WayPointFlag.SafeHide)
        self.data:GoToCityPos(pos)
    end
    
    -- 小人说话
    local param = {}
    param.type = CityResidentDefines.TalkTriggerType.ResidentScare
    param.rUuid = self.data.uuid
    param.bgType = 2
    DataCenter.CityResidentManager:TryResidentTalk(param)
    
    self.data.drunkEndTime = 0
    self.data:CheckShowDanger()
    
    --if self.data ~=nil and self.data:HasObj() then
    --    self.data.obj:Play3DSound("Effect_people_scare")
    --end
    --todo:受到惊吓
end

local function OnExit(self)
    self.data:CheckShowDanger()
    DataCenter.CityResidentManager.occupyMgr:ReleaseWayPoint(self.data.uuid)
    --if self.data ~=nil and self.data:HasObj() then
    --    self.data.obj:Stop3DSound()
    --end
end

local function OnFinish(self)
    self.data:SetState(CityResidentDefines.State.ScareHide)
end

CityResidentStateScare.OnUpdate = OnUpdate
CityResidentStateScare.OnEnter = OnEnter
CityResidentStateScare.OnExit = OnExit
CityResidentStateScare.OnFinish = OnFinish

return CityResidentStateScare