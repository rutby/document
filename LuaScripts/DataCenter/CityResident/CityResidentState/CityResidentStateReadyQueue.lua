---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/2/26 19:28
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateReadyQueue = BaseClass("CityResidentStateReadyQueue", CityResidentStateBase)

local function OnEnter(self)
    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end
    local mainBuildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.FUN_BUILD_MAIN)
    local mainPos = mainBuildData:GetCenterVec()
    if self.data.immediate then
        -- 引导时立刻出现
        local _, toPos = DataCenter.CityResidentManager:GetReadyQueuePos(self.data.readyIndex)
        if toPos then
            self.data:SetPos(toPos)
            self.data:LookAt(mainPos)
        end
        self.data:OnFinish()
        self.data.immediate = false
        return
    end
    local pos = self.data:GetPos()
    if pos.x < 0 then
        self.timer = TimerManager:GetInstance():DelayInvoke(function()
            self.timer = nil
            if self.data and self.data:HasObj() then
                local fromPos, toPos = DataCenter.CityResidentManager:GetReadyQueuePos(self.data.readyIndex)
                if fromPos and toPos then
                    self.data:SetPos(fromPos)
                    self.data:SetAutoAnim(true)
                    self.data:GoToCityPos(toPos)
                end
            end
        end, CityResidentDefines.ResidentReadyQueueInterval * self.data.readyIndex)
    else
        local _, toPos = DataCenter.CityResidentManager:GetReadyQueuePos(self.data.readyIndex)
        if toPos then
            self.data:SetAutoAnim(true)
            self.data:GoToCityPos(toPos)
        end
    end
end

local function OnExit(self)
    DataCenter.CityHudManager:Destroy(self.data.uuid, CityHudType.ReadyQueue)
end

local function OnFinish(self)
    local mainBuildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.FUN_BUILD_MAIN)
    local mainPos = mainBuildData:GetCenterVec()
    
    self.data:Idle()
    self.data:PlayAnim(CityResidentDefines.AnimName.Idle)
    self.data:LookAt(mainPos)
    self.data:CheckShowReadyQueueHud()
end

CityResidentStateReadyQueue.OnEnter = OnEnter
CityResidentStateReadyQueue.OnExit = OnExit
CityResidentStateReadyQueue.OnFinish = OnFinish

return CityResidentStateReadyQueue