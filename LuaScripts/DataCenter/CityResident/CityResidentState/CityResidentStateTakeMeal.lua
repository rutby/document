---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/12/20 14:33
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateTakeMeal = BaseClass("CityResidentStateTakeMeal", CityResidentStateBase)

local function OnEnter(self)
    local mealCount = LuaEntry.Resource:GetCntByResType(ResourceType.Meal)
    if mealCount >= 1 then
        local furnitureInfoList = DataCenter.FurnitureManager:GetFurnitureByFurnitureId(FurnitureType.FoodWindow)
        local furnitureInfo = furnitureInfoList[1]
        local duration = DataCenter.FurnitureManager:GetFurnitureLocalNum(furnitureInfo.uuid, 1)
        if self.data.foodWindowTf then
            self.data:LookAt(self.data.foodWindowTf.position)
            self.data:Idle()
            self.data:PlayAnim(CityResidentDefines.AnimName.TakeUp)
            self.data:WaitForFinish(duration)

            local hudParam = {}
            hudParam.uuid = self.data.uuid
            hudParam.type = CityHudType.ProductSlider
            hudParam.pos = self.data:GetPos()
            hudParam.icon = nil
            hudParam.offset = Vector3.New(0, 80, 0)
            hudParam.scale = 0.8
            hudParam.duration = duration
            hudParam.location = CityHudLocation.World
            DataCenter.CityHudManager:Create(hudParam)
            return
        end
    end
    self:TalkNoFood()
    self.data:SetState(CityResidentDefines.State.Rest)
end

local function OnExit(self)
    DataCenter.CityHudManager:Destroy(self.data.uuid, CityHudType.ProductSlider)
end

local function OnFinish(self)
    LuaEntry.Resource:ChangeMealCount(-1)
    self.data:SetState(CityResidentDefines.State.GoToEat)
end

CityResidentStateTakeMeal.OnEnter = OnEnter
CityResidentStateTakeMeal.OnExit = OnExit
CityResidentStateTakeMeal.OnFinish = OnFinish

return CityResidentStateTakeMeal