---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/22 18:55
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateHuntAttack = BaseClass("CityResidentStateHuntAttack", CityResidentStateBase)
local Resource = CS.GameEntry.Resource

local JavelinDelay = 0.5
local JavelinSpeed = 20
local JavelinHeight = 0.3

local function OnEnter(self)
    local career = self.data:GetCareer()
    local workFlag = CityResidentDefines.WorkWayPointFlag[career]
    if workFlag then
        local mask = DataCenter.CityResidentManager:GetCurrentCityMask()
        local wayPoint = DataCenter.CityResidentManager.occupyMgr:TryOccupyNearWayPoint(self.data.uuid, mask, workFlag)
        if wayPoint then
            local animalData = DataCenter.CityResidentManager.animalMgr:GetDataByWayPointId(wayPoint.id)
            if animalData == nil then
                animalData = DataCenter.CityResidentManager.animalMgr:CreateAtWayPoint(wayPoint)
            end
            self.data.target = animalData
            local targetPos = animalData:GetPos()

            if animalData.state == CityResidentDefines.AnimalState.Dead then
                self:OnFinish()
            else
                local animName = CityResidentDefines.AnimName.Javelin
                local duration = self.data:GetAnimDuration(animName)
                self.data:Idle()
                self.data:PlayAnim(animName)
                self.data:ShowTool("HandJavelin")
                self.data:LookAt(targetPos)
                self.data:WaitForFinish(duration)
                
                -- 标枪
                self.timer = TimerManager:GetInstance():DelayInvoke(function()
                    local pos = self.data.obj.rightHandTf.position
                    local toPos = Vector3.New(targetPos.x, 0.5, targetPos.z)
                    local dir = toPos - pos
                    local dis = Vector3.Magnitude(dir)
                    if dis > JavelinHeight then
                        local time = dis / JavelinSpeed
                        toPos = toPos - dir * JavelinHeight
                        self.req = Resource:InstantiateAsync("Assets/Main/Prefab_Dir/Home/Tools/HandJavelin.prefab")
                        self.req:completed('+', function(req)
                            if not self.data:HasObj() then
                                req:Destroy()
                                return
                            end

                            local go = req.gameObject
                            local tf = go.transform
                            tf.position = pos
                            tf.up = dir
                            tf:DOMove(toPos, time):SetEase(CS.DG.Tweening.Ease.Linear):OnComplete(function()
                                req:Destroy()
                            end)
                        end)
                    end
                end, JavelinDelay)
            end
        end
    end
end

local function OnExit(self)
    local career = self.data:GetCareer()
    local workFlag = CityResidentDefines.WorkWayPointFlag[career]
    if workFlag then
        DataCenter.CityResidentManager.occupyMgr:ReleaseWayPoint(self.data.uuid)
    end

    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end

    if self.req then
        self.req:Destroy()
        self.req = nil
    end
end

local function OnFinish(self)
    self.data:ShowTool("")
    self.data:SetState(CityResidentDefines.State.HuntHarvest)
    if self.data.target then
        self.data.target:Die()
    end
end

CityResidentStateHuntAttack.OnEnter = OnEnter
CityResidentStateHuntAttack.OnExit = OnExit
CityResidentStateHuntAttack.OnFinish = OnFinish

return CityResidentStateHuntAttack