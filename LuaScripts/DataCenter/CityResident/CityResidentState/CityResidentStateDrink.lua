---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/11 11:15
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateDrink = BaseClass("CityResidentStateDrink", CityResidentStateBase)

local function OnEnter(self)
    local tf, fUuid = DataCenter.CityResidentManager.occupyMgr:TryOccupyFurnitureTransform(self.data.uuid, FurnitureType.BarSeat)
    if tf then
        local duration = DataCenter.FurnitureManager:GetFurnitureLocalNum(fUuid, 1)
        self.data:SetPos(tf.position)
        self.data:SetRot(tf.rotation)
        self.data:Idle()
        self.data:ShowTool("")
        self.data:PlayAnim(CityResidentDefines.AnimName.Eat)
        self.data:WaitForFinish(duration)

        local hudParam = {}
        hudParam.uuid = self.data.uuid
        hudParam.type = CityHudType.ProductSlider
        hudParam.icon = string.format(LoadPath.UIVita, "icon_beer")
        hudParam.pos = self.data:GetPos()
        hudParam.offset = Vector3.New(0, 80, 0)
        hudParam.duration = duration
        hudParam.location = CityHudLocation.World
        hudParam.fUuid = fUuid
        DataCenter.CityHudManager:Create(hudParam)
        
        self.fUuid = fUuid
        EventManager:GetInstance():Broadcast(EventId.CityResidentEnterFurniture, { rUuid = self.data.uuid, fUuid = fUuid })
        return
    end
    
    self.data:SetState(CityResidentDefines.State.GoToIdle)
end

local function OnExit(self)
    self.data:ShowTool("")
    DataCenter.CityHudManager:Destroy(self.data.uuid, CityHudType.ProductSlider)
    DataCenter.CityResidentManager.occupyMgr:ReleaseOccupyFurnitureTransform(self.data.uuid)

    EventManager:GetInstance():Broadcast(EventId.CityResidentExitFurniture, { rUuid = self.data.uuid, fUuid = self.fUuid })
end

local function OnFinish(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.data.drunkEndTime = curTime + CityResidentDefines.ResidentDrunkDuration * 1000
    self.data:Refresh()

    local fUuid = self.fUuid
    local icon = DataCenter.FurnitureManager:GetFurnitureEffectIcon(fUuid)
    local count = DataCenter.FurnitureManager:GetFurnitureLocalNum(fUuid, 2)
    self:ShowFurnitureProductGain(icon, count)
end

CityResidentStateDrink.OnEnter = OnEnter
CityResidentStateDrink.OnExit = OnExit
CityResidentStateDrink.OnFinish = OnFinish

return CityResidentStateDrink