---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/11 11:26
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateBartenderMix = BaseClass("CityResidentStateBartenderMix", CityResidentStateBase)

local function OnEnter(self)
    local fUuid = self.data.residentData.fUuid
    local furnitureInfo = DataCenter.FurnitureManager:GetFurnitureByUuid(fUuid)
    if furnitureInfo then
        local furnitureTf = DataCenter.FurnitureObjectManager:GetTransformByFurnitureUuid(fUuid)
        if furnitureTf then
            local duration = DataCenter.FurnitureManager:GetFurnitureLocalNum(fUuid, 1)
            duration = duration / self.data:GetWorkSpeedFactor()
            local tf = DataCenter.CityResidentManager:GetFurnitureInteractTransform(fUuid, 1)
            if tf then
                self.data:SetRot(tf.rotation)
            else
                self.data:LookAt(furnitureTf.position)
            end
            self.data:Idle()
            self.data:ShowTool("")
            self.data:PlayAnim(CityResidentDefines.AnimName.Research)
            self.data:WaitForFinish(duration)
            
            local hudParam = {}
            hudParam.uuid = self.data.uuid
            hudParam.type = CityHudType.ProductSlider
            hudParam.pos = self.data:GetPos()
            hudParam.offset = Vector3.New(0, 80, 0)
            hudParam.duration = duration
            hudParam.location = CityHudLocation.World
            hudParam.fUuid = fUuid
            DataCenter.CityHudManager:Create(hudParam)
            
            self.fUuid = fUuid
            EventManager:GetInstance():Broadcast(EventId.CityResidentEnterFurniture, { rUuid = self.data.uuid, fUuid = fUuid })
            return
        end
    end
    
    self.data:Refresh()
end

local function OnExit(self)
    self.data:ShowTool("")
    DataCenter.CityHudManager:Destroy(self.data.uuid, CityHudType.ProductSlider)
    EventManager:GetInstance():Broadcast(EventId.CityResidentExitFurniture, { rUuid = self.data.uuid, fUuid = self.fUuid })
end

local function OnFinish(self)
    self.data:SetState(CityResidentDefines.State.BartenderServe)
end

CityResidentStateBartenderMix.OnEnter = OnEnter
CityResidentStateBartenderMix.OnExit = OnExit
CityResidentStateBartenderMix.OnFinish = OnFinish

return CityResidentStateBartenderMix