---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/11/23 10:52
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateEat = BaseClass("CityResidentStateEat", CityResidentStateBase)

local function OnEnter(self)
    local tf, fUuid = DataCenter.CityResidentManager.occupyMgr:TryOccupyFurnitureTransform(self.data.uuid, FurnitureType.DiningTable)
    if tf then
        self.data:SetPos(tf.position)
        self.data:SetRot(tf.rotation)
        self.data:Idle()
        self.data:PlayAnim(CityResidentDefines.AnimName.Eat)
        self.data:WaitForFinish(4)

        --local offset = Vector3.New(-10, 90, 0)
        --self:ShowFurnitureResidentSlider(fUuid, FurniturePara1Type.Stamina, offset)

        self.fUuid = fUuid
        EventManager:GetInstance():Broadcast(EventId.CityResidentEnterFurniture, { rUuid = self.data.uuid, fUuid = fUuid })
    else
        self.data:Refresh()
    end
end

local function OnExit(self)
    self.data:ShowTool("")
    --DataCenter.CityHudManager:Destroy(self.data.uuid, CityHudType.ResidentSlider)
    DataCenter.CityResidentManager.occupyMgr:ReleaseOccupyFurnitureTransform(self.data.uuid)

    EventManager:GetInstance():Broadcast(EventId.CityResidentExitFurniture, { rUuid = self.data.uuid, fUuid = self.fUuid })
end

local function OnFinish(self)
    self.data:SetState(CityResidentDefines.State.Rest)
    
    local icon = string.format(LoadPath.UIVita, "survivor_icon_healthy06")
    local count = math.floor(DataCenter.VitaManager:GetMealHungerAdd())
    local dataTemp = self.data
    --dataTemp.obj:Play3DSound("Effect_people_eatFinish")
    --TimerManager:GetInstance():DelayInvoke(function()
    --    if dataTemp ~=nil and dataTemp:HasObj() then
    --        dataTemp.obj:Stop3DSound()
    --    end
    --end, 1)
    --todo:吃饱啦！
    self:ShowFurnitureProductGain(icon, count)
end

CityResidentStateEat.OnEnter = OnEnter
CityResidentStateEat.OnExit = OnExit
CityResidentStateEat.OnFinish = OnFinish

return CityResidentStateEat