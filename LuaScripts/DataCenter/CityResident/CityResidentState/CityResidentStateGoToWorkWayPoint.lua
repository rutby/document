---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/4/15 12:05
---

local CityResidentStateBase = require "DataCenter.CityResident.CityResidentState.CityResidentStateBase"
local CityResidentStateGoToWorkWayPoint = BaseClass("CityResidentStateGoToWorkWayPoint", CityResidentStateBase)

local function OnEnter(self)
    local mask = DataCenter.CityResidentManager:GetCurrentCityMask()
    local career = self.data:GetCareer()
    local workFlag = CityResidentDefines.WorkWayPointFlag[career]
    local wayPoint = DataCenter.CityResidentManager.occupyMgr:TryOccupyRandomWayPoint(self.data.uuid, mask, workFlag)
    if wayPoint then
        if workFlag == CityResidentDefines.WayPointFlag.Hunting then
            local animalData = DataCenter.CityResidentManager.animalMgr:GetDataByWayPointId(wayPoint.id)
            if animalData == nil then
                DataCenter.CityResidentManager.animalMgr:CreateAtWayPoint(wayPoint)
            end
        end
        
        self.data:ShowTool("")
        self.data:SetAutoAnim(true)
        self.data:GoToCityPos(wayPoint.pos)
        return
    end
    
    self.data:SetState(CityResidentDefines.State.Idle)
end

local function OnExit(self)
    DataCenter.CityResidentManager.occupyMgr:ReleaseWayPoint(self.data.uuid)
end

local function OnFinish(self)
    local career = self.data:GetCareer()
    local workFlag = CityResidentDefines.WorkWayPointFlag[career]
    if workFlag == CityResidentDefines.WayPointFlag.Hunting then
        self.data:SetState(CityResidentDefines.State.HuntAttack)
        return
    end
    
    self.data:SetState(CityResidentDefines.State.Work)
end

CityResidentStateGoToWorkWayPoint.OnEnter = OnEnter
CityResidentStateGoToWorkWayPoint.OnExit = OnExit
CityResidentStateGoToWorkWayPoint.OnFinish = OnFinish

return CityResidentStateGoToWorkWayPoint