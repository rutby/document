---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/3/29 18:57
---

local CityZombieStateBase = require "DataCenter.CityResident.CityZombieState.CityZombieStateBase"
local CityZombieStateAttackWall = BaseClass("CityZombieStateAttackWall", CityZombieStateBase)

local DamageDelay = 0.3

local function OnUpdate(self, deltaTime)
    if self.wallData and self.wallData.created and not self.wallData:IsBroken() then
        if not self.damaged then
            self.time = self.time + deltaTime
            if self.time >= DamageDelay then
                local damage = DataCenter.CityResidentManager:GetZombieAttackDamage()
                self.wallData:Hurt(damage)
                self.damaged = true
            end
        end
    else
        self.data:SetState(CityResidentDefines.ZombieState.InvadeWalk)
    end
end

local function OnEnter(self)
    self.wallData = DataCenter.CityWallManager:GetData(self.data.attackWallId)
    if self.wallData and self.wallData.created and not self.wallData:IsBroken() then
        self.time = 0
        self.damaged = false
        local animName = CityResidentDefines.AnimName.Attack1
        local duration = self.data:GetAnimDuration(animName)
        self.data:Idle()
        self.data:PlayAnim(animName, 1, true)
        self.data:WaitForFinish(duration)
        self.data:LookAt(self.wallData.pos)
    else
        self.data:SetState(CityResidentDefines.ZombieState.InvadeWalk)
    end
end

local function OnExit(self)
    self.wallData = nil
end

local function OnFinish(self)
    self:OnEnter()
end

CityZombieStateAttackWall.OnUpdate = OnUpdate
CityZombieStateAttackWall.OnEnter = OnEnter
CityZombieStateAttackWall.OnExit = OnExit
CityZombieStateAttackWall.OnFinish = OnFinish

return CityZombieStateAttackWall