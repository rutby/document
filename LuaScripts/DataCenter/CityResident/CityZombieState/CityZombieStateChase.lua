---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/3/25 11:32
---

local CityZombieStateBase = require "DataCenter.CityResident.CityZombieState.CityZombieStateBase"
local CityZombieStateChase = BaseClass("CityZombieStateChase", CityZombieStateBase)

local Interval = 0.7

local function OnUpdate(self, deltaTime)
    -- 追击
    if self.data.target and not self.data.target:IsDead() then
        self.cd = self.cd - deltaTime
        if self.cd <= 0 then
            self.cd = Interval
            local mask = DataCenter.CityResidentManager:GetCurrentCityMask()
            local pos = self.data.target:GetPos()
            if self.data.chaseOutside then
                -- 丧尸在围栏外
                local flag = self.data.target:GetEndWayPointFlag()
                if (flag & CityResidentDefines.WayPointFlag.Outside) ~= 0 then
                    -- 小人在围栏外
                    self.data:GoToPosDirectly(pos)
                else
                    -- 小人在围栏内
                    self.data:GoToPos(pos, mask, CityResidentDefines.WayPointFlag.All, "isOutside=1")
                end
            else
                -- 正常追击
                self.data:GoToPos(pos, mask, CityResidentDefines.WayPointFlag.All)
            end
        end
        return
    end
    
    -- 结束
    self.data:Refresh()
end

local function OnEnter(self)
    self.cd = 0
    self.data:PlayAnim(CityResidentDefines.AnimName.Walk1)
    self.data:SetSpeed(DataCenter.CityResidentManager:GetZombieChaseSpeed())
end

local function OnFinish(self)
    self.data:Refresh()
end

CityZombieStateChase.OnUpdate = OnUpdate
CityZombieStateChase.OnEnter = OnEnter
CityZombieStateChase.OnFinish = OnFinish

return CityZombieStateChase