---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/3/25 11:32
---

local CityZombieStateBase = require "DataCenter.CityResident.CityZombieState.CityZombieStateBase"
local CityZombieStateAttack = BaseClass("CityZombieStateAttack", CityZombieStateBase)
local Localization = CS.GameEntry.Localization

local Duration = 1.5
local FireDelay = 0.3

local function OnUpdate(self, deltaTime)
    if self.data.target and not self.data.target:IsDead() then
        if not self.fired then
            self.time = self.time + deltaTime
            if self.time >= FireDelay then
                local dodgeRate = LuaEntry.Effect:GetGameEffect(EffectDefine.RESIDENT_DODGE_RATE)
                local ran = math.random() * 100
                if ran < dodgeRate then
                    -- 闪避
                    local hudParam = {}
                    hudParam.type = CityHudType.PopText
                    hudParam.pos = self.data.target:GetPos()
                    hudParam.text = "<color=red>" .. Localization:GetString("261018") .. "</color>"
                    hudParam.offset = Vector3.New(0, 50, 0)
                    hudParam.duration = 1
                    hudParam.location = CityHudLocation.World
                    DataCenter.CityHudManager:Create(hudParam)
                else
                    -- 命中
                    local damage = DataCenter.CityResidentManager:GetZombieAttackDamage()
                    self.data.target:Hurt(damage)
                end
                self.fired = true
            end
        end
    end
end

local function OnEnter(self)
    self.time = 0
    self.fired = false
    self.data:Idle()
    self.data:PlayAnim(CityResidentDefines.AnimName.Attack1)
    self.data:WaitForFinish(Duration)
    if self.data.target then
        local pos = self.data.target:GetPos()
        self.data:LookAt(Vector3.New(pos.x, 0, pos.z))
    end
end

local function OnFinish(self)
    self.data:PlayAnim(CityResidentDefines.AnimName.Idle)
    if DataCenter.CityResidentManager:IsZombieInvade() then
        self.data:SearchResident(true)
    else
        self.data:Refresh()
    end
end

CityZombieStateAttack.OnUpdate = OnUpdate
CityZombieStateAttack.OnEnter = OnEnter
CityZombieStateAttack.OnFinish = OnFinish

return CityZombieStateAttack