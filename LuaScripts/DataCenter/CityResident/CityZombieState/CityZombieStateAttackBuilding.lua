---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/3/28 17:54
---

local CityZombieStateBase = require "DataCenter.CityResident.CityZombieState.CityZombieStateBase"
local CityZombieStateAttackBuilding = BaseClass("CityZombieStateAttackBuilding", CityZombieStateBase)
local Resource = CS.GameEntry.Resource

local Tolerance = 0.1

local function OnEnter(self)
    local pos = DataCenter.CityResidentManager.occupyMgr:TryOccupyAttackBuildPos(self.data.uuid, self.data.targetBUuid)
    if pos then
        local buildData = DataCenter.BuildManager:GetBuildingDataByUuid(self.data.targetBUuid)
        if buildData and buildData:GetCurStamina() > 0 then
            local animName = CityResidentDefines.AnimName.Attack1
            local duration = self.data:GetAnimDuration(animName)
            self.data:Idle()
            self.data:PlayAnim(animName)
            self.data:WaitForFinish(Mathf.RandomFloat(duration - Tolerance, duration + Tolerance))
            
            local buildTemplate = DataCenter.BuildTemplateManager:GetBuildingDesTemplate(buildData.itemId)
            local buildPos = buildTemplate:GetPosition()
            self.data:LookAt(Vector3.New(buildPos.x, 0, buildPos.z))
            return
        end
    end
    
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.data.ignoreBUuidTimeDict[self.data.targetBUuid] = curTime
    self.data:Refresh()
end

local function OnExit(self)
    DataCenter.CityResidentManager.occupyMgr:ReleaseAttackBuildPos(self.data.uuid)
end

local function OnFinish(self)
    self.data:PlayAnim(CityResidentDefines.AnimName.Idle)
    
    local bUuid = self.data.targetBUuid
    local buildData = DataCenter.BuildManager:GetBuildingDataByUuid(bUuid)
    if buildData then
        local damage = DataCenter.CityResidentManager:GetZombieAttackDamage()
        local oldDestroyType = buildData:GetDestroyType()
        buildData:Hurt(damage)
        local newDestroyType = buildData:GetDestroyType()
        if oldDestroyType ~= newDestroyType then
            DataCenter.BuildManager:SendRuinBuilding(bUuid, math.abs(buildData.deltaStamina))
        end
        DataCenter.CityResidentManager:ScareResidentsByBUuid(bUuid)
        DataCenter.BuildManager:PlayHurtEffect(bUuid)
        EventManager:GetInstance():Broadcast(EventId.BuildingStaminaChanged, bUuid)
    end
    
    self:OnEnter()
end

CityZombieStateAttackBuilding.OnEnter = OnEnter
CityZombieStateAttackBuilding.OnExit = OnExit
CityZombieStateAttackBuilding.OnFinish = OnFinish

return CityZombieStateAttackBuilding