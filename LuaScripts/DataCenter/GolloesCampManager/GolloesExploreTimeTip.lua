---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/1 21:50
---

local GolloesExploreTimeTip = BaseClass("GolloesExploreTimeTip")
local ResourceManager = CS.GameEntry.Resource

local function Init(self, request)
    if request then
        self.request = request
        self.gameObject = request.gameObject
        self.transform = request.gameObject.transform
    end
end

local function SetTime(self, worldMarch)
    if (not SceneUtils.GetIsInWorld()) or IsNull(self.gameObject) then
        return
    end
    self.gameObject:SetActive(true)
    
    local pointId = worldMarch.targetUuid
    local pointPos = SceneUtils.TileIndexToWorld(pointId)
    local worldTroop = WorldTroopManager:GetInstance():GetTroop(worldMarch.uuid)

    if worldMarch and worldTroop then
        self.gameObject:SetActive(true)
        self.gameObject.transform:SetParent(worldTroop:GetTransform())--CS.SceneManager.World.DynamicObjNode)
        self.gameObject.transform.position = pointPos
        self.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
        self.gameObject.name = "GolloesExploreTime" .. worldMarch.ownerFormationUuid
        self.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
    
        self.changeSceneCircleSlider = self.transform:GetComponent(typeof(CS.ChangeSceneCircleSlider))
        self.golloesExploreTimeN = self.changeSceneCircleSlider.transform:Find("PosGo/TimeText"):GetComponent(typeof(CS.SuperTextMesh))
        --local serverT = UITimeManager:GetInstance():GetServerTime()
        --local startT = serverT - (serverT % 1)
        local startT = worldMarch.startTime
        self.golloesExploreEndT = worldMarch.endTime
        self.changeSceneCircleSlider:Init(startT,self.golloesExploreEndT)
        self:AddGolloesExploreTimer()
        self:SetGolloesExploreTime()
    end
end

local function Refresh(self, worldMarch)
    self:SetTime(worldMarch)
end


local function AddGolloesExploreTimer(self)
    self.GolloesExploreTimerAction = function()
        self:SetGolloesExploreTime()
    end

    if self.golloesExploreTimer == nil then
        self.golloesExploreTimer = TimerManager:GetInstance():GetTimer(1, self.GolloesExploreTimerAction , self, false,false,false)
    end
    self.golloesExploreTimer:Start()
end

local function SetGolloesExploreTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = self.golloesExploreEndT - curTime
    if remainTime > 0 then
        self.golloesExploreTimeN.text = UITimeManager:GetInstance():MilliSecondToFmtString(remainTime)
    else
        self.golloesExploreTimeN.text = UITimeManager:GetInstance():MilliSecondToFmtString(0)
        self:DelGolloesExploreTimer()
    end
end

local function DelGolloesExploreTimer(self)
    if self.golloesExploreTimer ~= nil then
        self.golloesExploreTimer:Stop()
        self.golloesExploreTimer = nil
    end
end

local function Recycle(self)
    self:DelGolloesExploreTimer()
end


GolloesExploreTimeTip.Init = Init
GolloesExploreTimeTip.SetTime = SetTime
GolloesExploreTimeTip.Refresh = Refresh
GolloesExploreTimeTip.Recycle = Recycle
GolloesExploreTimeTip.AddGolloesExploreTimer = AddGolloesExploreTimer
GolloesExploreTimeTip.SetGolloesExploreTime = SetGolloesExploreTime
GolloesExploreTimeTip.DelGolloesExploreTimer = DelGolloesExploreTimer

return GolloesExploreTimeTip