---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 26/2/2024 下午8:44
---
local DailyPackageManager = BaseClass("DailyPackageManager");

function DailyPackageManager:__init()
    self.customPackageLists = {}
    self.curSelectId = 0
end

function DailyPackageManager:__delete()
    self.customPackageLists = {}
    self.curSelectId = 0
end

function DailyPackageManager:GetDailyPackagePreview()
    SFSNetwork.SendMessage(MsgDefines.GetDailyPackageInfos)
end
function DailyPackageManager:UpdateDailyPackage(message)
    if message ==nil then
        return
    end
    self.customPackageLists = {}
    self.curSelectId = 0
    if message["customPackages"]~=nil then
        self.customPackageLists = message["customPackages"]
    end
    if message["selectId"]~=nil then
        self.curSelectId = message["selectId"]
    end
    
end

function DailyPackageManager:CheckShowRed()
    local curTime = UITimeManager:GetInstance():GetServerSeconds()
    local lastEnterTime = Setting:GetPrivateInt("LastDailyPackageTime",0)
    local show =false
    if Mathf.Abs(curTime-lastEnterTime)>=24*60*60 then
        local str = Setting:GetPrivateString("LastPackageList","")
        local arr = string.split(str,";")
        if #self.customPackageLists~=#arr then
            if #self.customPackageLists>1 then
                show = true
            end
        else
            if #self.customPackageLists>1 then
                table.sort(self.customPackageLists,function(a,b)
                    return a<b
                end)
                for i = 1,#arr do
                    if show ==false then
                        if self.customPackageLists[i]~=toInt(arr[i]) then
                            show = true
                        end
                    end
                end
            end
        end
    end
    if show ==true then
        local curId = DataCenter.DailyPackageManager:GetCurSelectId()
        local itemStr = GetTableData("custom_dailypackage", curId, "item")
        if itemStr~=nil and itemStr~="" then
            local arr = string.split(itemStr,"|")
            if #arr>0 then
                for i=1,#arr do
                    local packageArr = string.split(arr[i], ";")
                    local giftPackageId = packageArr[#packageArr]
                    local info = GiftPackageData.get(tostring(giftPackageId))
                    if info ~= nil and info:isBought() then --如果当前有已购买的，就没有红点
                        return false
                    end
                end
            end
        end
    end
    return show
end

function DailyPackageManager:OnChooseListClick()
    local curTime = UITimeManager:GetInstance():GetServerSeconds()
    local startZeroTime =UITimeManager:GetInstance():GetTodayZeroServerTime(curTime)
    Setting:SetPrivateString("LastDailyPackageTime",startZeroTime)
    local str = ""
    table.sort(self.customPackageLists,function(a,b)
        return a<b
    end)
    for i = 1, #self.customPackageLists do
        if i < #self.customPackageLists then
            str = str..self.customPackageLists[i]..";"
        else
            str = str..self.customPackageLists[i]
        end
    end
    Setting:SetPrivateString("LastPackageList",str)
    EventManager:GetInstance():Broadcast(EventId.RefreshWelfareRedDot)
end

function DailyPackageManager:OnChooseUpdate(message)
    if message == nil then
        return
    end
    if message["selectId"]~=nil then
        self.curSelectId = message["selectId"]
    end
end
function DailyPackageManager:GetCurSelectId()
    return self.curSelectId
end
function DailyPackageManager:GetPackageList()
    return self.customPackageLists
end

return DailyPackageManager