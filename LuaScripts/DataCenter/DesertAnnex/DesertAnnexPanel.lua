---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/28 19:11
---

local DesertAnnexPanel = BaseClass("DesertAnnexPanel")
local DesertAnnexItem = require "DataCenter.DesertAnnex.DesertAnnexItem"
local Resource = CS.GameEntry.Resource

local list_path = "Auto/Root/List"

local ItemPath = "Assets/Main/Prefabs/World/DesertAnnexItem.prefab"
local ItemSpace = 0.5

local function __init(self)
    self.pointId = 0
    self.params = {}
    self.req = nil
    self.itemList = {}
end

local function OnCreate(self)
    self.gameObject = self.req.gameObject
    self.transform = self.gameObject.transform
    self.list_tf = self.transform:Find(list_path)
    self:Refresh()
end

local function OnDestroy(self)
    self:ClearItems()
    self.gameObject = nil
    self.transform = nil
    if self.req ~= nil then
        self.req:Destroy()
        self.req = nil
    end
end

local function Init(self, pointId, params, req)
    self.pointId = pointId
    self.params = params
    self.req = req
end

local function Refresh(self)
    local pos = SceneUtils.TileIndexToWorld(self.pointId)
    self.transform:Set_position(pos.x, pos.y, pos.z)
    self:ShowItems()
end

local function ShowItems(self)
    self:ClearItems()
    for i, param in ipairs(self.params) do
        local req = Resource:InstantiateAsync(ItemPath)
        req:completed('+', function()
            if req.isError then
                self.itemList[i] = nil
                return
            end
            local go = req.gameObject
            go.name = "DesertAnnexItem_" .. i
            go.transform:SetParent(self.list_tf)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go.transform.localPosition = self:GetItemPos(i)
            go.transform.localRotation = Quaternion.identity
            self.itemList[i]:OnCreate()
        end)
        self.itemList[i] = DesertAnnexItem.New()
        self.itemList[i]:Init(param, req)
    end
end

local function ClearItems(self)
    for _, item in pairs(self.itemList) do
        item:OnDestroy()
    end
    self.itemList = {}
end

local function GetItemPos(self, index)
    local left = -ItemSpace * (#self.params - 1) * 0.5
    local x = left + ItemSpace * (index - 1)
    return Vector3.New(x, 0, 0)
end

DesertAnnexPanel.__init = __init
DesertAnnexPanel.OnCreate = OnCreate
DesertAnnexPanel.OnDestroy = OnDestroy

DesertAnnexPanel.Init = Init
DesertAnnexPanel.Refresh = Refresh
DesertAnnexPanel.ShowItems = ShowItems
DesertAnnexPanel.ClearItems = ClearItems
DesertAnnexPanel.GetItemPos = GetItemPos

return DesertAnnexPanel