---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/27 18:27
---

local DesertOperateManager = BaseClass("DesertOperateManager")

local DesertOperateType =
{
    PickUp = "PickUp", -- 收起建筑
    --GiveUp = "GiveUp", -- 放弃地块
    --CancelGiveUp = "CancelGiveUp", -- 取消放弃地块
    
    RapidRepair = "RapidRepair", -- 专精技能：快速维修
    Landmine = "Landmine", -- 专精技能：地雷
    BuildingShield = "BuildingShield", -- 专精技能：坚盾
    FormationBuff = "FormationBuff", ----专精技能：急救
    UpgradeDesert = "UpgradeDesert", ----专精技能：升级地块
    MadWarriorBuff = "MadWarriorBuff",---专精技能：狂战士
}

local function __init(self)
    self.opDict = {}
    self.desert_talent_mine_time = 0 
    for _, type in pairs(DesertOperateType) do
        local op = require ("DataCenter.DesertOperate.Ops.Op" .. type)
        self.opDict[type] = op.New()
    end
end

local function __delete(self)
    
end

local function GetOp(self, type)
    return self.opDict[type]
end

local function GetOpList(self, uuid)
    local list = {}
    for _, op in pairs(self.opDict) do
        op:Init(uuid)
        if op:CanShow() then
            table.insert(list, op)
        end
    end
    table.sort(list, function(opA, opB)
        return opA:GetOrder() < opB:GetOrder()
    end)
    return list
end

local function CanShowPanel(self, uuid)
    for _, op in pairs(self.opDict) do
        op:Init(uuid)
        if op:CanShow() then
            return true
        end
    end
    return false
end

local function UpdateDesertMineStartTime(self,message)
    if message["desert_talent_mine"]~=nil then
        self.desert_talent_mine_time = message["desert_talent_mine"]
    end
end
local function GetCurDesertMineCount(self)
    --if self.desert_talent_mine_time<=0 then
    --    return 0
    --end
    local maxNum = self:GetMaxMineCount()
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local oneTime = LuaEntry.DataConfig:TryGetNum("desert_talent_mine", "k3")*1000
    local showNum = math.floor((curTime-self.desert_talent_mine_time)/math.max(oneTime,1))
    local realNum = math.min(showNum,maxNum)
    return realNum
end
local function GetMaxMineCount(self)
    local k4 = LuaEntry.DataConfig:TryGetNum("desert_talent_mine", "k4")
    local addNum = LuaEntry.Effect:GetGameEffect(EffectDefine.MASTERY_EFFECT_30415)
    return k4+addNum
end

local function GetDesertMineStartTime(self)
    return self.desert_talent_mine_time
end


DesertOperateManager.__init = __init
DesertOperateManager.__delete = __delete
DesertOperateManager.GetMaxMineCount = GetMaxMineCount
DesertOperateManager.GetCurDesertMineCount = GetCurDesertMineCount
DesertOperateManager.GetOp = GetOp
DesertOperateManager.GetOpList = GetOpList
DesertOperateManager.CanShowPanel = CanShowPanel
DesertOperateManager.UpdateDesertMineStartTime = UpdateDesertMineStartTime
DesertOperateManager.GetDesertMineStartTime =GetDesertMineStartTime
return DesertOperateManager