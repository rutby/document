---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/29 10:50
---

-- 专精技能：地雷
local OpLandmine = BaseClass("OpLandmine", OpBase)
local base = OpBase
local Localization = CS.GameEntry.Localization
local function Init(self, uuid)
    base.Init(self, uuid)
    self.masteryId = 0
end
local function CanShow(self)
    if self:IsDesert() and self.desertData.ownerUid == LuaEntry.Player.uid then
        if LuaEntry.Effect:GetGameEffect(EffectDefine.MASTERY_EFFECT_30414) > 0 then
            self.masteryId = MasteryIdEnum.LandmineBig
        elseif LuaEntry.Effect:GetGameEffect(EffectDefine.MASTERY_EFFECT_30413) > 0 then
            self.masteryId = MasteryIdEnum.Landmine
        end
        if self.masteryId~=0 then
            self.template = DataCenter.MasteryManager:GetTemplateById(self.masteryId)
            if self.template~=nil then
                self.state, self.endTime = self:GetState()
                return true
            end
        end
    end
    return false
end
local function GetTitle(self)
    local str = ""
    if self.template~=nil then
        local name = Localization:GetString(DataCenter.MasteryManager:GetName(self.template.tempData:getValue("id")))
        local curNum = DataCenter.DesertOperateManager:GetCurDesertMineCount()
        local maxNum = DataCenter.DesertOperateManager:GetMaxMineCount()

        str = name.." ("..Localization:GetString("111217",(math.floor(curNum).."/"..math.floor(maxNum)))..") "
    end
    return str
end
local function GetIcon(self)
    if self.template~=nil then
        return string.format(LoadPath.UIMastery .. self.template.tempData:getValue("icon"))
    end
    return ""
end
local function GetDesc(self)
    if self.template~=nil then
        return DataCenter.MasteryManager:GetDescStr(self.template.tempData:getValue("id"))
    end
    return ""
end

local function GetBtnText(self)
    return Localization:GetString("110046")
end

local function GetBtnState(self)
    if self.state == MasterySkillState.Normal then
        return DesertOperateBtnState.Green
    elseif self.state == MasterySkillState.CD then
        if DataCenter.DesertOperateManager:GetCurDesertMineCount()>0 then
            return DesertOperateBtnState.Green
        end
        return DesertOperateBtnState.Gray
    end
    return DesertOperateBtnState.Gray
end

local function OnClick(self, view, item)
    if self.state == MasterySkillState.Normal or self.state == MasterySkillState.CD then
        if self.desertData.mineId ~= nil and self.desertData.mineId > 0 then
            -- 已有地雷
            UIUtil.ShowTipsId(120447)
            return
        end
        local curTime = UITimeManager:GetInstance():GetServerTime()
        if curTime <= self.desertData.protectEndTime then
            -- 保护中
            UIUtil.ShowTipsId(110731)
            return
        end
        local marchDict = DataCenter.WorldMarchDataManager:GetMarchesTargetForMine()
        for _, march in pairs(marchDict) do
            if march.targetUuid == self.uuid and march.ownerUid ~= LuaEntry.Player.uid and march:GetMarchTargetType() == MarchTargetType.ATTACK_DESERT and march.inBattle == true then
                -- 交战中
                UIUtil.ShowTipsId(110731)
                return
            end
        end
        SFSNetwork.SendMessage(MsgDefines.UserAddDesertMine,self.uuid,LuaEntry.Player:GetCurServerId())
        view:Close()
    elseif self.state == MasterySkillState.Locked then
        DataCenter.MasteryManager:ShowHome(self.template.tempData:getValue("home"), self.template.group)
    end
end

local function TimerAction(self, view, item)
    if self.state == MasterySkillState.CD then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local restTime = self.endTime - curTime
        if restTime >= 0 then
        else
            self.state, self.endTime = self:GetState()
            item:Refresh()
        end
    end
end

local function GetState(self)
    if LuaEntry.Effect:GetGameEffect(EffectDefine.MASTERY_EFFECT_30414) > 0 or LuaEntry.Effect:GetGameEffect(EffectDefine.MASTERY_EFFECT_30413) > 0 then
        local desert_talent_mine_time = DataCenter.DesertOperateManager:GetDesertMineStartTime()
        local maxNum = DataCenter.DesertOperateManager:GetMaxMineCount()
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local oneTime = LuaEntry.DataConfig:TryGetNum("desert_talent_mine", "k3")*1000
        local showNum = math.floor((curTime-desert_talent_mine_time)/math.max(oneTime,1))
        if showNum<maxNum then
            local endTime = desert_talent_mine_time+oneTime*(showNum+1)
            return MasterySkillState.CD,endTime
        else
            return MasterySkillState.Normal, 0
        end
    end
    return MasterySkillState.Locked, 0
end

OpLandmine.Init = Init
OpLandmine.OnClick = OnClick
OpLandmine.GetTitle = GetTitle
OpLandmine.GetState = GetState
OpLandmine.TimerAction =TimerAction
OpLandmine.GetBtnState =GetBtnState
OpLandmine.GetBtnText = GetBtnText
OpLandmine.GetDesc =GetDesc
OpLandmine.GetIcon =GetIcon
OpLandmine.CanShow = CanShow
return OpLandmine