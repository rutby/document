---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/22/21 6:16 PM
---
local MonthCardInfo = BaseClass("MonthCardInfo")
local M = MonthCardInfo

function M:__init()
    self._serverData = nil -- 服务器传过来的月卡数据

    self._showTypeParsed = false
    self._showIndexList = {}
    self._itemDescList = {}
    self._resourceList = {}    --资源道具列表
    self._rewards = {}         --奖励列表
    self._accelerateList = {}  --加速道具列表
    self._diamond = 0
    self._buildingSpeedUp = 0
    self._techSpeedUp = 0
    self._stone = 0
    self._iron = 0
end

---更新数据
---@param data table
function M:update(data)
    self._serverData = data
    self._showTypeParsed = false

    --下面几个字段比较特殊，没有从缓存的服务器数据读取，因为客户端会修改，老代码逻辑如此
    self._times = data.times
    self._canTimes = data.canTimes
    self._accepted = data.accepted
    self._isBought = data.available
end

function M:getID()
    return self._serverData and self._serverData.itemId or "-1"
end

---月卡返现次数
function M:getCount()
    return self._serverData and self._serverData.count or 0
end

---领取次数
function M:getTimes()
    return self._times
end

---累积的未领取次数
function M:getCanTimes()
    return self._canTimes
end

function M:getRemainDays()
    return self:getCount() - self:getCanTimes() - self:getTimes()
end

---是否购买
function M:isBought()
    return self._isBought
end

---礼包价格
function M:getPrice()
    return self._serverData and self._serverData.dollar or 0
end

function M:getProductID()
    if CS.SDKManager.IS_UNITY_ANDROID() then
        return self._serverData and self._serverData.product_id_google
    elseif CS.SDKManager.IS_UNITY_IPHONE() then
        return self._serverData and self._serverData.product_id_ios
    end
end


---是否可以领取奖励
function M:canReceive()
    return self:getCanTimes() > 0--self:getTimes() < self:getCount() and not self:isAccepted()
end

---当天是否领取过奖励
function M:isAccepted()
    return self._accepted
end

---月卡广告顺序
function M:getShowIndexList()
    self:tryParseShowType()
    return self._showIndexList
end

---月卡赠送加速总和（小时），建筑加速和科技加速
function M:getSpeedUp()
    self:tryParseShowType()
    return self._buildingSpeedUp, self._techSpeedUp
end

---月卡赠送钻石数目
function M:getDiamond()
    self:tryParseShowType()
    return self._diamond
end

---月卡赠送资源总和，石头和铁
function M:getResource()
    self:tryParseShowType()
    return self._stone, self._iron
end

--- 由 show_type 68 决定 第一个是英雄ID 后面两个是建筑ID  配置：（A, B, C)
function M:getRewards()
    self:tryParseShowType()
    return self._rewards
end

---月卡赠送资源道
function M:getResourceList()
    self:tryParseShowType()
    return self._resourceList
end

---月卡赠送加速道具
function M:getAccelerateList()
    self:tryParseShowType()
    return self._accelerateList
end

function M:getDescList()
    self:tryParseShowType()
    return self._itemDescList
end

---根据show_type字段进行具体内容解析
function M:tryParseShowType()
    if self._showTypeParsed then
        return
    end

    self._showTypeParsed = true
    local showType = self._serverData and self._serverData.show_type or ""
    if string.IsNullOrEmpty(showType) then
        return
    end

    local arr = string.split(showType, '|')
    for _, v in ipairs(arr) do
        if not string.IsNullOrEmpty(v) then
            local arr1 = string.split(v, ';')
            if #arr1 == 2 then
                self:onParseShowTypeItem(arr1[1], arr1[2])
            end
        end
    end
end

function M:onParseShowTypeItem(k, v)
    if k == "7" then
        --月卡广告顺序，逗号分割
        self._showIndexList = {}
        local arr = string.split(v, ',')
        for _, v in ipairs(arr) do
            table.insert(self._showIndexList, tonumber(v))
        end
    elseif k == "8" then
        --月卡赠送加速总和，逗号分割建筑加速和科技加速
        local arr = string.split(v, ',')
        if #arr == 2 then
            self._buildingSpeedUp = tonumber(arr[1])
            self._techSpeedUp = tonumber(arr[2])
        end
    elseif k == "9" then
        --月卡赠送钻石数目
        self._diamond = tonumber(v)
    elseif k == "29" then
        --月卡赠送资源总和，逗号分割石头和铁
        local arr = string.split(v, ',')
        if #arr == 2 then
            self._stone = tonumber(arr[1])
            self._iron = tonumber(arr[2])
        end
    elseif k == "63" then
        local arr = string.split(v, ',')
        for _, v in ipairs(arr) do
            table.insert(self._itemDescList, tonumber(v))
        end
    elseif k == "22" then
        local arr = string.split(v, ',')
        for _, v in ipairs(arr) do
            table.insert(self._accelerateList, v)
        end
    elseif k == "23" then
        local arr = string.split(v, ',')
        for _, v in ipairs(arr) do
            table.insert(self._resourceList, v)
        end
    elseif k == "68" then
        local arr = string.split(v, ',')
        for _, v in ipairs(arr) do
            table.insert(self._rewards, v)
        end
    end
end

function M:received()
    self._times = self._times + 1
    self._canTimes = self._canTimes - 1
    if self._canTimes < 0 then
        self._canTimes = 0
    end

    self._accepted = true
end

function M:updateOnDayChange()
    self._canTimes = self._canTimes + 1

    -- RemainDays 小于0 说明到期了所以领取次数不应该加一
    if self:getRemainDays() < 0 then
        self._canTimes = self._canTimes - 1
    end
    self._accepted = false
end

function M:dispose()
    self._serverData = nil
end

return M