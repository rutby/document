---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/10 14:26
---

local CampEffectManager = BaseClass("CampEffectManager")
local CampEffectTemplate = require "DataCenter.CampEffect.CampEffectTemplate"

local function __init(self)
    self.templateDict = {}

    LocalController:instance():visitTable(HeroUtils.GetHeroCampXmlName(), function(id, lineData)
        local template = CampEffectTemplate.New()
        template:InitData(lineData)
        self.templateDict[id] = template
    end)
end

local function __delete(self)
    self.templateDict = nil
end

local function GetTemplate(self, id)
    return self.templateDict[tonumber(id)]
end

local function GetAllTemplates(self)
    local list = table.values(self.templateDict)
    table.sort(list, function(templateA, templateB)
        return templateA.id < templateB.id
    end)
    return list
end


function CampEffectManager:GetCampEffectInfoByHeroData(heroList)
    local campDic = {}
    if heroList ~= nil then
        for _, heroData in pairs(heroList) do
            local camp = HeroUtils.GetCamp(heroData)
            if camp ~= nil and camp >= 0 then
                if campDic[camp] == nil then
                    campDic[camp] = 1
                else
                    campDic[camp] = campDic[camp] + 1
                end
            end
        end
    end
    local list = {}
    for k, v in pairs(campDic) do
        table.insert(list, { camp = k, count = v })
    end
    if list[2] ~= nil then
        table.sort(list, function(a, b)
            return a.count > b.count
        end)
    end
   
    local info = {}
    local v1Camp = list[1] and list[1].camp or -1
    local v1Count = list[1] and list[1].count or 0
    local v2Camp = list[2] and list[2].camp or -1
    local v2Count = list[2] and list[2].count or 0
    if v1Count == 5 then
        info.type = CampEffectType.Fetter_5
        info.camps = { v1Camp }
    elseif v1Count == 4 then
        info.type = CampEffectType.Fetter_4
        info.camps = { v1Camp }
    elseif v1Count == 3 and v2Count == 2 then
        info.type = CampEffectType.Fetter_3_2
        info.camps = { v1Camp, v2Camp }
    elseif v1Count == 3 and v2Count ~= 2 then
        info.type = CampEffectType.Fetter_3
        info.camps = { v1Camp }
    else
        info.type = CampEffectType.None
        info.camps = {}
    end

    info.template = self:GetTemplate(info.type)
    return info
end

local function GetCampEffectInfoByHeroUuids(self, heroUuids)
    return self:GetCampEffectInfoByHeroData(HeroUtils.GetPveHeroDataListByUuids(heroUuids))
end

CampEffectManager.__init = __init
CampEffectManager.__delete = __delete
CampEffectManager.GetTemplate = GetTemplate
CampEffectManager.GetAllTemplates = GetAllTemplates
CampEffectManager.GetCampEffectInfoByHeroUuids = GetCampEffectInfoByHeroUuids

return CampEffectManager
