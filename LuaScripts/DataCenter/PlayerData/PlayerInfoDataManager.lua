---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/8/27 18:38
---
local PlayerInfoDataManager = BaseClass("PlayerInfoDataManager");

local function __init(self)
    self.otherPlayerData = {}
    self.selfPlayerData =nil
end

local function __delete(self)
    self.otherPlayerData = nil
    self.selfPlayerData = nil
end

local function RefreshSelfPlayerData(self,message)
    if self.selfPlayerData ==nil then
        self.selfPlayerData = BasePlayerInfo.New()
    end
    self.selfPlayerData:ParseData(message)
	self.selfPlayerData.updateTime = UITimeManager:GetInstance():GetServerTime()
end

local function RefreshOtherPlayerData(self,message)
    local data = BasePlayerInfo.New()
    data:ParseData(message)
	data.updateTime = UITimeManager:GetInstance():GetServerTime()
    self.otherPlayerData[data.uid] = data
end

local function RefreshPlayerData(self,message)
    if message["uid"]~=nil then
        if message["uid"] == self:GetSelfUid() then
            --Logger.Log("refreshSelf")
            self:RefreshSelfPlayerData(message)
        else
            --Logger.Log("refreshOther")
            self:RefreshOtherPlayerData(message)
        end
    end
end

local function GetPlayerDataByUid(self,uid)
	local curTime = UITimeManager:GetInstance():GetServerTime()
	local retPlayerInfo = nil
	-- 这里其实都存在一个map即可，没太大必要分成两个地方存
    if uid == self:GetSelfUid() then
        --Logger.Log("getSelf")
		retPlayerInfo = self.selfPlayerData
    else
        --Logger.Log("getOther")
		retPlayerInfo = self.otherPlayerData[uid]
    end
	
	if retPlayerInfo ~= nil then
		local timeDiff = curTime - retPlayerInfo.updateTime
		-- 15秒，这里存的是ms
		if timeDiff <= 15000 then
			return retPlayerInfo
		end
	end
	
	return nil
end

local function GetSelfUid(self)
    return LuaEntry.Player:GetUid()
end

local function ChangeSelfName(self,name)
    if (self.selfPlayerData ~= nil) then
        self.selfPlayerData:ChangeSelfName(name)
    end
    
end

local function ChangeSelfMood(self,moodStr)
    if (self.selfPlayerData ~= nil) then
        self.selfPlayerData:ChangeMoodStr(moodStr)
    end
end

PlayerInfoDataManager.__init = __init
PlayerInfoDataManager.__delete = __delete
PlayerInfoDataManager.RefreshPlayerData = RefreshPlayerData
PlayerInfoDataManager.GetPlayerDataByUid = GetPlayerDataByUid
PlayerInfoDataManager.GetSelfUid = GetSelfUid
PlayerInfoDataManager.RefreshSelfPlayerData = RefreshSelfPlayerData
PlayerInfoDataManager.RefreshOtherPlayerData = RefreshOtherPlayerData
PlayerInfoDataManager.ChangeSelfName = ChangeSelfName
PlayerInfoDataManager.ChangeSelfMood = ChangeSelfMood
return PlayerInfoDataManager