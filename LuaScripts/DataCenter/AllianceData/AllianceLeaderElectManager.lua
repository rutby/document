---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/10/25 20:36
---

local AllianceLeaderElectManager = BaseClass("AllianceLeaderElectManager");

local function __init(self)
    self.leaderCandidates = {}
    self.autoJoin = 0
    self.autoJoinTimer = nil
    self:AddListener()
end

local function AddListener(self)
    --EventManager:GetInstance():AddListener(EventId.TrainingArmy, self.OnBuildTrainingStartSignal)
end

local function RemoveListener(self)
    --EventManager:GetInstance():RemoveListener(EventId.GetAllDetectInfo, self.CheckDetectEventSignal)
end

local function __delete(self)
    self.leaderCandidates = nil
    self.autoJoin = nil
    self.autoJoinTimer = nil
end

local function UpdateCandidates(self, msg)
    self.leaderCandidates = {}
    for i, v in ipairs(msg.candidateInfo) do
        table.insert(self.leaderCandidates, v)
    end
end

local function UpdateOneCandidateInfo(self, candidate)
    if self.leaderCandidates then
        for i, v in ipairs(self.leaderCandidates) do
            if v.uid == candidate.uid then
                v.voteNum = candidate.voteNum
                v.name = candidate.name
                v.pic = candidate.pic
                v.picVer = candidate.picVer 
                break
            end
        end
    end
end

local function UpdateAutoJoinSignal(self, autoJoin)
    self.autoJoin = autoJoin
    if self.autoJoin == 1 then
        self:AddAutoJoinTimer()
    else
        self:DelAutoJoinTimer()
    end
end

local function AddAutoJoinTimer(self)
    if self.autoJoinTimer == nil then
        self.autoJoinTimer = TimerManager:GetInstance():GetTimer(0.5, function()
            self:DelAutoJoinTimer()
            UIUtil.ShowMessage(CS.GameEntry.Localization:GetString("390866"),2,nil,nil,function ()
                SFSNetwork.SendMessage(MsgDefines.AutoJoinAlliance)
            end,function()
                SFSNetwork.SendMessage(MsgDefines.AutoJoinAlliance)
            end,function()
                SFSNetwork.SendMessage(MsgDefines.AutoJoinAlliance)
            end)
        end , self, true,false,false)
        
        self.autoJoinTimer:Start()
    end
end

local function DelAutoJoinTimer(self)
    if self.autoJoinTimer ~= nil then
        self.autoJoinTimer:Stop()
        self.autoJoinTimer = nil
    end
end


local function GetAlLeaderCandidates(self)
    return self.leaderCandidates
end

--0：可投票；1：不可用（无联盟）2:过期；3：已投票；
local function GetAlLeaderVoteStatus(self)
    local hasAlliance = LuaEntry.Player:IsInAlliance()
    if not hasAlliance then
        return 1
    else
        local allianceBaseData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBaseData.sysAlState == 2 then
            if allianceBaseData.voted == 0 then
                return 0
            else
                return 3
            end
        else
            return 2
        end
    end
end

--0：可报名；1：不可用（无联盟）2:过期；3：已报名；
local function GetAlLeaderElectStatus(self)
    local hasAlliance = LuaEntry.Player:IsInAlliance()
    if not hasAlliance then
        return 1
    else
        local allianceBaseData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBaseData.sysAlState == 1 then
            if allianceBaseData.elected == 0 then
                return 0
            else
                return 3
            end
        else
            return 2
        end
    end
    --[[
    local hasAlliance = LuaEntry.Player:IsInAlliance()
    if not hasAlliance then
        return 1
    else
        local allianceBaseData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBaseData.elected == 1 then
            return 3
        else
            local time0 = allianceBaseData.createTime
            local time2 = LuaEntry.DataConfig:TryGetNum("system_alliance", "k2")
            local time5 = LuaEntry.DataConfig:TryGetNum("system_alliance", "k5")
            local endElectT = time0 + time2 * 3600000
            local startElectT = endElectT - time5 * 3600000
            local curTime = UITimeManager:GetInstance():GetServerTime()
            if curTime < startElectT or curTime > endElectT then
                return 0
            else
                return 2
            end
        end
    end
    --]]
end

--是否会自动迁城
local function IsAutoJoin(self)
    return self.autoJoin == 1
end


AllianceLeaderElectManager.__init = __init
AllianceLeaderElectManager.__delete = __delete
AllianceLeaderElectManager.AddListener = AddListener
AllianceLeaderElectManager.RemoveListener = RemoveListener
AllianceLeaderElectManager.UpdateCandidates = UpdateCandidates
AllianceLeaderElectManager.UpdateOneCandidateInfo = UpdateOneCandidateInfo
AllianceLeaderElectManager.GetAlLeaderVoteStatus = GetAlLeaderVoteStatus
AllianceLeaderElectManager.GetAlLeaderElectStatus = GetAlLeaderElectStatus
AllianceLeaderElectManager.GetAlLeaderCandidates = GetAlLeaderCandidates
AllianceLeaderElectManager.UpdateAutoJoinSignal = UpdateAutoJoinSignal
AllianceLeaderElectManager.AddAutoJoinTimer = AddAutoJoinTimer
AllianceLeaderElectManager.DelAutoJoinTimer = DelAutoJoinTimer
AllianceLeaderElectManager.IsAutoJoin = IsAutoJoin

return AllianceLeaderElectManager