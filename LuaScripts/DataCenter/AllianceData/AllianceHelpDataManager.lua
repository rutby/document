---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/10 19:22
---
local AllianceHelpDataManager = BaseClass("AllianceHelpDataManager");

local function __init(self)
    self.helpNum = 0
    self.otherHelpInfoList ={}
    self.myHelpInfoList ={}
    self.todayHelpPoint = 0
    self.refreshTime = 0
end

local function __delete(self)
    self.helpNum = nil
    self.otherHelpInfoList =nil
    self.myHelpInfoList =nil
    self.todayHelpPoint = nil
    self.refreshTime = nil
end

local function Reset(self)
    self.helpNum = 0
    self.otherHelpInfoList ={}
    self.myHelpInfoList ={}
    self.todayHelpPoint = 0
    self.refreshTime = 0
end

local function GetTodayHelpPoint(self)
    return self.todayHelpPoint
end

local function ResetTodayHelpPoint(self)
    self.todayHelpPoint = 0
end

local function UpdateHelpInfoList(self,message)
    if message["helpArr"]~=nil then
        self.otherHelpInfoList ={}
        self.myHelpInfoList ={}
        table.walk(message["helpArr"],function (k,v)
            local info = AllianceHelpInfo.New()
            info:ParseData(v)
            if info.helpId ~= nil and info.helpId ~=""then
                if info.stats ==1 then
                    if info:CheckIsFinish() ==false then
                        self.otherHelpInfoList[info.helpId] =info
                    end
                elseif info.stats ==0 then
                    self.myHelpInfoList[info.helpId] =info
                end
            end
            
        end)
        self:SetHelpNum(table.count(self.otherHelpInfoList))
    end
    if message["refreshTime"]~=nil then
        self.refreshTime = message["refreshTime"]
    end
    if message["todayHelpPoint"]~=nil then
        if not message['uid'] or message["uid"] == LuaEntry.Player.uid then
            self.todayHelpPoint = message["todayHelpPoint"]
        end
    end
end

local function RefreshAllianceHelp(self,message)
    if message["helpId"]~=nil then
        local helpId = message["helpId"]
        local currentNum = message["nowCount"]
        if self.otherHelpInfoList[helpId]~=nil then
            local data = self.otherHelpInfoList[helpId]
            data:SetNowCount(currentNum)
            if data:CheckIsFinish() then
                self:OnFinishAllianceHelp(helpId)
            end
        elseif self.myHelpInfoList[helpId]~=nil then
            local data = self.myHelpInfoList[helpId]
            data:SetNowCount(currentNum)
        end
    end
    if message["uid"] and message["uid"] == LuaEntry.Player.uid and message["accPoint"] then
        DataCenter.AllianceShopDataManager:SetAccPoint(message["accPoint"])
    end
end

local function OnFinishAllianceHelp(self,helpId)
    if self.otherHelpInfoList[helpId]~=nil then
        self.otherHelpInfoList[helpId] =nil
    end
    self:SetHelpNum(table.count(self.otherHelpInfoList))
end

local function OnHelpAll(self)
    self.otherHelpInfoList ={}
    self:SetHelpNum(0)
end

local function SetHelpNum(self,count)
    if count >0 then
        self.helpNum = count
    else
        self.helpNum = 0
    end
    EventManager:GetInstance():Broadcast(EventId.UpdateMainAllianceRedCount)
end

local function GetHelpNum(self)
    return self.helpNum
end

local function GetSelfHelpList(self)
    return self.myHelpInfoList
end

local function GetOtherHelpList(self)
    return self.otherHelpInfoList
end


AllianceHelpDataManager.__init = __init
AllianceHelpDataManager.__delete = __delete
AllianceHelpDataManager.Reset = Reset
AllianceHelpDataManager.UpdateHelpInfoList = UpdateHelpInfoList
AllianceHelpDataManager.RefreshAllianceHelp = RefreshAllianceHelp
AllianceHelpDataManager.OnFinishAllianceHelp = OnFinishAllianceHelp
AllianceHelpDataManager.OnHelpAll = OnHelpAll
AllianceHelpDataManager.SetHelpNum = SetHelpNum
AllianceHelpDataManager.GetHelpNum = GetHelpNum
AllianceHelpDataManager.GetSelfHelpList = GetSelfHelpList
AllianceHelpDataManager.GetOtherHelpList = GetOtherHelpList
AllianceHelpDataManager.GetTodayHelpPoint =GetTodayHelpPoint
AllianceHelpDataManager.ResetTodayHelpPoint =ResetTodayHelpPoint
return AllianceHelpDataManager