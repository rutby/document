---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/7/14 11:30
---AllianceAutoInviteManager

local AllianceAutoInviteManager = BaseClass("AllianceAutoInviteManager");

local function Startup()
end

local function __init(self)
    self.autoInviteList = {}
    self.unreadCount = 0
    self:AddListener()
end

local function AddListener(self)
    --EventManager:GetInstance():AddListener(EventId.TrainingArmy, self.OnBuildTrainingStartSignal)
end

local function RemoveListener(self)
    --EventManager:GetInstance():RemoveListener(EventId.GetAllDetectInfo, self.CheckDetectEventSignal)
end

local function __delete(self)
    self.autoInviteList = nil
    self.unreadCount = nil
end

local function GetInviteInfoReq(self)
    SFSNetwork.SendMessage(MsgDefines.GetAllianceAutoInviteInfo)
end

local function AcceptAllianceAutoInviteReq(self, allianceId)
    SFSNetwork.SendMessage(MsgDefines.AcceptAllianceAutoInvite, allianceId)
end

local function UpdateAutoInviteList(self, t)
    if not t["inviteArr"] then
        return
    end

    self.autoInviteList = {}
    for i, v in ipairs(t["inviteArr"]) do
        local newAutoInvite = AllianceAutoInviteData.New()
        newAutoInvite:ParseData(v)
        table.insert(self.autoInviteList, newAutoInvite)
    end
    self.unreadCount = #self.autoInviteList
    EventManager:GetInstance():Broadcast(EventId.OnGetNewAllianceAutoInvite)
end

local function UpdateOneAutoInvite(self, t)
    local newAutoInvite = AllianceAutoInviteData.New()
    newAutoInvite:ParseData(t)
    table.insert(self.autoInviteList, newAutoInvite)
    self.unreadCount = self.unreadCount + 1
    EventManager:GetInstance():Broadcast(EventId.OnGetNewAllianceAutoInvite)
end

local function ResetUnreadCount(self)
    self.unreadCount = 0
end

local function GetUnreadCount(self)
    return self.unreadCount
end

local function GetAutoInviteList(self)
    local retList = {}
    for i, v in ipairs(self.autoInviteList) do
        if v:CheckIfIsValid() then
            table.insert(retList, v)
        end
    end
    return retList
end

local function CheckIfNeedAutoInviteChatRoom(self)
    if LuaEntry.Player.serverType == ServerType.NORMAL or LuaEntry.Player.serverType == ServerType.EDEN_SERVER then
        local tempList = self:GetAutoInviteList()
        return tempList and #tempList > 0
    end
    return false
end

local function TryClearAllInvites(self)
    local tempList = self:GetAutoInviteList()
    if tempList and #tempList > 0 then
        local curAlId = LuaEntry.Player.allianceId
        for i, v in ipairs(tempList) do
            if v.allianceId == curAlId then
                self:ClearAllInvite()
                break
            end
        end
    end
end

local function ClearAllInvite(self)
    self.autoInviteList = {}
    self.unreadCount = 0
    EventManager:GetInstance():Broadcast(EventId.OnGetNewAllianceAutoInvite)
end


AllianceAutoInviteManager.Startup = Startup
AllianceAutoInviteManager.__init = __init
AllianceAutoInviteManager.__delete = __delete
AllianceAutoInviteManager.AddListener = AddListener
AllianceAutoInviteManager.RemoveListener = RemoveListener

AllianceAutoInviteManager.GetInviteInfoReq = GetInviteInfoReq
AllianceAutoInviteManager.AcceptAllianceAutoInviteReq = AcceptAllianceAutoInviteReq
AllianceAutoInviteManager.UpdateAutoInviteList = UpdateAutoInviteList
AllianceAutoInviteManager.UpdateOneAutoInvite = UpdateOneAutoInvite
AllianceAutoInviteManager.GetAutoInviteList = GetAutoInviteList
AllianceAutoInviteManager.CheckIfNeedAutoInviteChatRoom = CheckIfNeedAutoInviteChatRoom
AllianceAutoInviteManager.ClearAllInvite = ClearAllInvite
AllianceAutoInviteManager.ResetUnreadCount = ResetUnreadCount
AllianceAutoInviteManager.GetUnreadCount = GetUnreadCount
AllianceAutoInviteManager.TryClearAllInvites = TryClearAllInvites


return AllianceAutoInviteManager