---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 3/24/22 9:25 PM
---
local PveBattleMessage = BaseClass("PveBattleMessage", SFSBaseMessage)
local Localization = CS.GameEntry.Localization

local base = SFSBaseMessage

local function OnCreate(self, param)
    base.OnCreate(self)
    local level = param["level"] or 0
    local trigger = param["trigger"] or 0
    local heroes = param["heroes"] or {}
    local armys = param["armys"] or {}
    if level ~= nil then
        self.sfsObj:PutInt("level", level)
    end
    if trigger ~= nil then
        self.sfsObj:PutInt("trigger", trigger)
    end
    local sfsHeroes = SFSArray.New()
    for _, v in pairs(heroes) do
        local index = v["index"] 
        local uuid = v["uuid"]
        local obj = SFSObject.New()
        obj:PutInt("index",index)
        obj:PutLong("uuid", uuid)
        sfsHeroes:AddSFSObject(obj)
    end
    self.sfsObj:PutSFSArray("heroes", sfsHeroes)
    local formationArray = SFSArray.New()
    table.walk(armys,function (k,v)
        local obj = SFSObject.New()
        obj:PutUtfString("armyId",tostring(k))
        obj:PutInt("count", v)
        formationArray:AddSFSObject(obj)
    end)
    self.sfsObj:PutSFSArray("formations", formationArray)
    if param.x ~= nil and param.y ~= nil then
        self.sfsObj:PutFloat("x", param.x)
        self.sfsObj:PutFloat("y", param.y)
    end
end

local function HandleMessage(self, t)
    base.HandleMessage(self, t)
    Logger.Log(t)
    local errCode =  t["errorCode"]
    if errCode ~= nil then
        UIUtil.ShowTipsId(errCode)
        return
    end
    if (t == nil) then
        return
    end
    local battleContent = ""
    if (t["battleContent"] ~= nil) then
        battleContent = t["battleContent"]
    elseif t["battleContentArr"] ~= nil then
        local tabCnt = table.count(t["battleContentArr"])
        if (tabCnt > 0) then
            for i = 1, tabCnt do
                battleContent = battleContent .. t["battleContentArr"][i]
            end
        end
    end

    local detailContent = ""
    if (t["detailContent"] ~= nil) then
        detailContent = t["detailContent"]
    elseif t["detailContentArr"] ~= nil then
        local tabCnt = table.count(t["detailContentArr"])
        if (tabCnt > 0) then
            for i = 1, tabCnt do
                detailContent = detailContent .. t["detailContentArr"][i]
            end
        end
    end

    local expContent = t["heroExpReward"]
    PveActorMgr:GetInstance():ParseData(battleContent, detailContent, expContent)
    DataCenter.BattleLevel:OnBattleMessage(t)
end

PveBattleMessage.OnCreate = OnCreate
PveBattleMessage.HandleMessage = HandleMessage

return PveBattleMessage