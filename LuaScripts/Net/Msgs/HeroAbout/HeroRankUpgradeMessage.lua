---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhangliheng.
--- DateTime: 2022/1/19 17:32
---


local HeroRankUpgradeMessage = BaseClass("HeroRankUpgradeMessage", SFSBaseMessage)
local base = SFSBaseMessage
local Localization = CS.GameEntry.Localization
local HeroInfo = require "DataCenter.HeroData.HeroInfo"

local function OnCreate(self, heroUuid)
    base.OnCreate(self)
    self.sfsObj:PutLong('uuid', heroUuid)
end

local function HandleMessage(self, message)
    base.HandleMessage(self, message)

    if message['errorCode'] ~= nil then
        local lang = Localization:GetString(message['errorCode'])
        UIUtil.ShowTips(lang or message['errorCode'])
        return
    end
    SoundUtil.PlayEffect(SoundAssets.Music_Effect_Hero_Upgrade3)
    
    --更新资源
    local res = message['resource']
    if res ~= nil then
        LuaEntry.Resource:UpdateResource(res)
    end

    local hero = message["hero"]
    if hero ~= nil then
        local uuid = hero["uuid"]
        local oldHeroData = DeepCopy(DataCenter.HeroDataManager:GetHeroByUuid(uuid))
        DataCenter.HeroDataManager:UpdateOneHero(hero)
        local newHeroData = DataCenter.HeroDataManager:GetHeroByUuid(uuid)
        if oldHeroData and newHeroData then
            local curRankId = newHeroData:GetCurMilitaryRankId()
            local stage = tonumber(GetTableData(TableName.HeroMilitaryRank, curRankId, "stage"))
            if stage == 0 then
                newHeroData:UpdateHeroSkill()
                -- 升到整星
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroEtoileUp, NormalPanelAnim, oldHeroData, newHeroData)
            else
                local oldPower = HeroUtils.GetHeroPower(oldHeroData)
                local newPower = HeroUtils.GetHeroPower(newHeroData)
                if newPower > oldPower then
                    GoToUtil.ShowPower({ power = newPower - oldPower })
                end
            end
        end
        EventManager:GetInstance():Broadcast(EventId.HeroRankUpSuccess, uuid)
    end

    EventManager:GetInstance():Broadcast(EventId.RefreshHeroEffectSkill)
    EventManager:GetInstance():Broadcast(EventId.HeroStationUpdate)
end

HeroRankUpgradeMessage.OnCreate = OnCreate
HeroRankUpgradeMessage.HandleMessage = HandleMessage

return HeroRankUpgradeMessage