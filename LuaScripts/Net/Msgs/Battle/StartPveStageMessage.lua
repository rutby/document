---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by admin.
--- DateTime: 2023/1/5 20:34
---
local StartPveStageMessage = BaseClass("StartPveStageMessage", SFSBaseMessage)
local base = SFSBaseMessage
local Localization = CS.GameEntry.Localization

local function OnCreate(self,stageGroupId,stageId,formationTemplateId,formations,heroInfos,chipSetId)
    base.OnCreate(self)
    
    self.sfsObj:PutInt("stageGroupId",stageGroupId)
    self.sfsObj:PutInt("stageId",stageId)
    self.sfsObj:PutInt("index", formationTemplateId)
    
    --  local formationArray = SFSArray.New()
    --  table.walk(formations,function (k,v)
    --      local key = k
    --      if type(key) == "number" then
    --          key = tostring(key)
    --      end
    --      local obj = SFSObject.New()
    --      obj:PutUtfString("armyId",key)
    --      obj:PutInt("count", v)
    --      formationArray:AddSFSObject(obj)
    --  end)
    
    --  self.sfsObj:PutSFSArray("formations", formationArray)
    
    local heroArray = SFSArray.New()
    table.walk(heroInfos,function (k,v)
        local key = k
        if type(key) == "number" then
            key = tostring(key)
        end
        local obj = SFSObject.New()
        obj:PutUtfString("index", key)
        obj:PutLong("heroUuid",v)
        heroArray:AddSFSObject(obj)
    end)
    
    self.sfsObj:PutSFSArray("heroInfos", heroArray)

    --打点
    local stage=string.format("%s/%s",stageGroupId, stageId)
    --PostEventLog.Track(PostEventLog.Defines.BattleBarrageStart,{stageId = tostring(stageId)})

    if chipSetId and chipSetId > 0 and chipSetId <=4 then
        self.sfsObj:PutInt("chipEquipGroup", chipSetId)
    end
end

local function HandleMessage(self, t)
    base.HandleMessage(self, t)
    local errCode =  t["errorCode"]
    if errCode ~= nil then
        UIUtil.ShowTipsId(errCode) 
    else
        DataCenter.ArmyFormationDataManager:UpdateTemplateFormationListData(t)
        EventManager:GetInstance():Broadcast(EventId.ArmyFormatUpdate)
        --UIUtil.ShowTipsId(300056) 
        
        --进入战斗
        --DataCenter.StageManager:UpdateData(t["stageGroupId"], t["stageId"])
        -- DataCenter.ZombieBattleManager:Destroy()
        -- local param = {}
        -- param.type = PVEType.Barrage
        -- param.levelId = DataCenter.StageManager.stageId
        -- param.levelGroupId = DataCenter.StageManager.stageGroupMetaId
        -- DataCenter.ZombieBattleManager:Enter(param)
        -- if t.idleRewardStageId and t.lastIdleRewardTimeStamp then
        --     DataCenter.StageManager:UpdateHangUpReward(t.lastIdleRewardTimeStamp,t.idleRewardStageId)
        -- end

        -- 这里或许应该用服务器下发的阵容数据再更新一次战斗阵容
        DataCenter.ZombieBattleManager:StartBattle()
        if t.idleRewardStageId and t.lastIdleRewardTimeStamp then
            DataCenter.StageManager:UpdateHangUpReward(t.lastIdleRewardTimeStamp,t.idleRewardStageId)
        end
    end
end

StartPveStageMessage.OnCreate = OnCreate
StartPveStageMessage.HandleMessage = HandleMessage

return StartPveStageMessage