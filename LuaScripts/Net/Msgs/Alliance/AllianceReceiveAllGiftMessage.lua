---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/6/24 10:52
---
local AllianceReceiveAllGiftMessage = BaseClass("AllianceReceiveAllGiftMessage", SFSBaseMessage)
local base = SFSBaseMessage
local Localization = CS.GameEntry.Localization
local function OnCreate(self,type)
    base.OnCreate(self)
    self.sfsObj:PutInt("type", type)
end

local function HandleMessage(self, t)
    base.HandleMessage(self, t)
    local errCode =  t["errorCode"]
    if errCode ~= nil then
        UIUtil.ShowTipsId(errCode) 
    else
        if t["receiveResult"]~=nil then
            local receiveResult = t["receiveResult"]
            if receiveResult==1 then
                DataCenter.AllianceGiftDataManager:RetBaseData(t)

                if t["results"] then
                    for i, v in ipairs(t["results"]) do
                        DataCenter.AllianceGiftDataManager:SetGiftReceive(v.uuid, v.receiveTime)
                    end
                end
                
                if t["allianceNewMail"]~=nil then
                    DataCenter.AllianceGiftDataManager:UpdateGiftNum(t["allianceNewMail"])
                    EventManager:GetInstance():Broadcast(EventId.UpdateAllianceGiftNum)
                end
                if t["info"]~=nil then
                    local list = t["info"]
                    local tempMsg = {}
                    tempMsg.reward = {}
                    table.walk(list,function(k,v)
                        if v["type"]== 11 then
                            local addScore = v["value"]
                            local accPoint = DataCenter.AllianceShopDataManager:GetAccPoint()
                            DataCenter.AllianceShopDataManager:SetAccPoint(accPoint+addScore)
                        end
                        table.insert(tempMsg.reward, v)
                    end)
                    DataCenter.RewardManager:ShowCommonReward(tempMsg)
                end

                if t["reward"] then
                    for k,v in pairs(t["reward"]) do
                        DataCenter.RewardManager:AddOneReward(v)
                    end
                end
                
                EventManager:GetInstance():Broadcast(EventId.RefreshAllianceGift)
                UIUtil.ShowTipsId(170003) 
            end
        end
    end
end

AllianceReceiveAllGiftMessage.OnCreate = OnCreate
AllianceReceiveAllGiftMessage.HandleMessage = HandleMessage

return AllianceReceiveAllGiftMessage