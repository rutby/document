---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/8/13 16:44
---
local WorldMarchTileUI = BaseClass("WorldMarchTileUI")
local Localization = CS.GameEntry.Localization

local march_time_obj_path = "scaleNode/GameObject/marchTimeBg"
local march_time_txt_path = "scaleNode/GameObject/marchTimeBg/marchTime"
local march_wait_obj_path = "scaleNode/GameObject/marchWaitBg"
local march_wait_txt_path = "scaleNode/GameObject/marchWaitBg/marchDes"
local march_btn_1_path = "scaleNode/GameObject/BuildBtnGo/btn1"
local march_btn_1_img_path = "scaleNode/GameObject/BuildBtnGo/btn1/Image"
local march_btn_1_txtBg_path = "scaleNode/GameObject/BuildBtnGo/btn1/Rect_BtnNameBg1"
local march_btn_1_txt_path = "scaleNode/GameObject/BuildBtnGo/btn1/Rect_BtnNameBg1/Txt_BtnName1"
local march_btn_2_path = "scaleNode/GameObject/BuildBtnGo/btn2"
local march_btn_2_img_path = "scaleNode/GameObject/BuildBtnGo/btn2/Image"
local march_btn_2_txtBg_path = "scaleNode/GameObject/BuildBtnGo/btn2/Rect_BtnNameBg2"
local march_btn_2_txt_path = "scaleNode/GameObject/BuildBtnGo/btn2/Rect_BtnNameBg2/Txt_BtnName2"
local march_btn_3_path = "scaleNode/GameObject/BuildBtnGo/btn3"
local march_btn_3_img_path = "scaleNode/GameObject/BuildBtnGo/btn3/Image"
local march_btn_3_txtBg_path = "scaleNode/GameObject/BuildBtnGo/btn3/Rect_BtnNameBg3"
local march_btn_3_txt_path = "scaleNode/GameObject/BuildBtnGo/btn3/Rect_BtnNameBg3/Txt_BtnName3"
local march_btn_4_path = "scaleNode/GameObject/BuildBtnGo/btn4"
local march_btn_4_img_path = "scaleNode/GameObject/BuildBtnGo/btn4/Image"
local march_btn_4_txtBg_path = "scaleNode/GameObject/BuildBtnGo/btn4/Rect_BtnNameBg4"
local march_btn_4_txt_path = "scaleNode/GameObject/BuildBtnGo/btn4/Rect_BtnNameBg4/Txt_BtnName4"
local march_btn_5_path = "scaleNode/GameObject/BuildBtnGo/btn5"
local march_btn_5_img_path = "scaleNode/GameObject/BuildBtnGo/btn5/Image"
local march_btn_5_txtBg_path = "scaleNode/GameObject/BuildBtnGo/btn5/Rect_BtnNameBg5"
local march_btn_5_txt_path = "scaleNode/GameObject/BuildBtnGo/btn5/Rect_BtnNameBg5/Txt_BtnName5"
local btn_obj_path = "scaleNode/GameObject/BuildBtnGo"
local BtnPosition = {}
BtnPosition[2] = { Vector3.New(-84,-35,0),Vector3.New(84,-35,0)}
BtnPosition[3] = { Vector3.New(-134,-5,0), Vector3.New(134,-5,0)}
BtnPosition[4] = {Vector3.New(-84,-35,0),Vector3.New(84,-35,0),
                   Vector3.New(-193,60,0),Vector3.New(193,60,0)}
BtnPosition[5] = { Vector3.New(-126,-27,0),Vector3.New(114,-27,0),
                   Vector3.New(-219,60,0),Vector3.New(219,60,0)}
--创建
local function OnCreate(self,go)
    if go ~= nil then
        self.request = go
        self.gameObject = go.gameObject
        self.transform = go.gameObject.transform
    end
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
end

local function ComponentDefine(self)
    self.march_time_obj = self.transform:Find(march_time_obj_path).gameObject
    self.march_wait_obj = self.transform:Find(march_wait_obj_path).gameObject
    self.btn_obj = self.transform:Find(btn_obj_path).gameObject
    self.onClick1 = function()
        self:OnBtn1Click()
    end
    self.onClick2 = function()
        self:OnBtn2Click()
    end
    self.onClick3 = function()
        self:OnBtn3Click()
    end
    self.onClick4 = function()
        self:OnBtn4Click()
    end
    self.onClick5 = function()
        self:OnBtn5Click()
    end
    self.march_time_txt = self.transform:Find(march_time_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_wait_txt = self.transform:Find(march_wait_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_btn_1 = self.transform:Find(march_btn_1_path):GetComponent(typeof(CS.UnityEngine.UI.Button))
    self.march_btn_1.onClick:AddListener(self.onClick1)
    self.march_btn_1_img = self.transform:Find(march_btn_1_img_path):GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_1_txtBg = self.transform:Find(march_btn_1_txtBg_path).gameObject--:GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_1_txt = self.transform:Find(march_btn_1_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_btn_2 = self.transform:Find(march_btn_2_path):GetComponent(typeof(CS.UnityEngine.UI.Button))
    self.march_btn_2.onClick:AddListener(self.onClick2)
    self.march_btn_2_img = self.transform:Find(march_btn_2_img_path):GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_2_txtBg = self.transform:Find(march_btn_2_txtBg_path).gameObject--:GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_2_txt = self.transform:Find(march_btn_2_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_btn_3 = self.transform:Find(march_btn_3_path):GetComponent(typeof(CS.UnityEngine.UI.Button))
    self.march_btn_3.onClick:AddListener(self.onClick3)
    self.march_btn_3_img = self.transform:Find(march_btn_3_img_path):GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_3_txtBg = self.transform:Find(march_btn_3_txtBg_path).gameObject--:GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_3_txt = self.transform:Find(march_btn_3_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_btn_4 = self.transform:Find(march_btn_4_path):GetComponent(typeof(CS.UnityEngine.UI.Button))
    self.march_btn_4.onClick:AddListener(self.onClick4)
    self.march_btn_4_img = self.transform:Find(march_btn_4_img_path):GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_4_txtBg = self.transform:Find(march_btn_4_txtBg_path).gameObject--:GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_4_txt = self.transform:Find(march_btn_4_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.march_btn_5 = self.transform:Find(march_btn_5_path):GetComponent(typeof(CS.UnityEngine.UI.Button))
    self.march_btn_5.onClick:AddListener(self.onClick5)
    self.march_btn_5_img = self.transform:Find(march_btn_5_img_path):GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_5_txtBg = self.transform:Find(march_btn_5_txtBg_path).gameObject--:GetComponent(typeof(CS.UnityEngine.UI.Image))
    self.march_btn_5_txt = self.transform:Find(march_btn_5_txt_path):GetComponent(typeof(CS.TextMeshProUGUIEx))
    self.isUpdate = false
    self.totalTime = 0
    self.btnListType = {}
    self.__update_handle = function() self:Update() end
    UpdateManager:GetInstance():AddUpdate(self.__update_handle)
end

local function ComponentDestroy(self)
    self.isUpdate = false
    self:RemoveTimer()
    pcall(function()
        self.march_btn_1.onClick:Clear()
        self.march_btn_2.onClick:Clear()
        self.march_btn_3.onClick:Clear()
        self.march_btn_4.onClick:Clear()
        self.march_btn_5.onClick:Clear()
    end)

    self.march_time_obj = nil
    self.march_time_txt = nil
    self.march_btn_1 = nil
    self.march_btn_1_img = nil
    self.march_btn_2 = nil
    self.march_btn_2_img = nil
    self.march_btn_3 = nil
    self.march_btn_3_img = nil
    
end
local function RemoveTimer(self)
    UpdateManager:GetInstance():RemoveUpdate(self.__update_handle)
    self.__update_handle = nil
end

local function GetMarchUuid(self)
    return self.marchUuid
end
local function RefreshTroop(self,marchUuid)
    self.isUpdate = false
    self.marchUuid = marchUuid
    local marchInfo = DataCenter.WorldMarchDataManager:GetMarch(self.marchUuid)
    if marchInfo~=nil then
        self.btnListType = {}
        EventManager:GetInstance():Broadcast(EventId.OnClickMarch,marchInfo.ownerFormationUuid)
        if marchInfo.ownerUid == LuaEntry.Player.uid then
            self.btnListType = {}
            if marchInfo:GetMarchType() ~= NewMarchType.ASSEMBLY_MARCH then
                if marchInfo:GetMarchType() == NewMarchType.DIRECT_MOVE_MARCH then
                    table.insert(self.btnListType,WorldMarchTileBtnType.March_ViewTroop)
                elseif marchInfo:GetMarchType() ~= NewMarchType.GOLLOES_EXPLORE and marchInfo:GetMarchType() ~= NewMarchType.GOLLOES_TRADE and marchInfo:GetMarchTargetType() ~= MarchTargetType.SAMPLE then
                    if marchInfo:GetMarchType() ~= NewMarchType.SCOUT and marchInfo:GetMarchType() ~= NewMarchType.RESOURCE_HELP then
                        if LuaEntry.Player.serverType ~= ServerType.DRAGON_BATTLE_FIGHT_SERVER then
                            local list = DataCenter.ItemData:GetItemList(GOODS_TYPE.SPEED_WORLD_MARCH,GOODS_TYPE2.MarchSpeedItem)
                            if list~=nil and #list>0 then
                                table.insert(self.btnListType,WorldMarchTileBtnType.March_Speed)
                            else
                                local buildData = DataCenter.BuildManager:GetAllBuildingByItemIdWithoutPickUp(BuildingTypes.FUN_BUILD_SPEED)
                                if buildData ~= nil and table.count(buildData) > 0 then
                                    table.insert(self.btnListType,WorldMarchTileBtnType.March_Speed)
                                end
                            end
                        end
                        
                        table.insert(self.btnListType,WorldMarchTileBtnType.March_ViewTroop)
                        if DataCenter.DesertOperateManager:CanShowPanel(marchInfo.ownerFormationUuid) then
                            table.insert(self.btnListType, WorldMarchTileBtnType.March_Operate)
                        end
                    end
                    table.insert(self.btnListType,WorldMarchTileBtnType.March_Callback)
                end
            end
            
            if WorldMarchEmotionManager:GetInstance():Enabled() then
                if marchInfo:GetMarchType() == NewMarchType.NORMAL then
                    table.insert(self.btnListType, WorldMarchTileBtnType.March_Emotion)
                end
            end
            
            --if marchInfo.type ~= CS.NewMarchType.SCOUT and marchInfo.type ~= CS.NewMarchType.RESOURCE_HELP then
            --    table.insert(self.btnListType,WorldMarchTileBtnType.None)
            --    table.insert(self.btnListType,WorldMarchTileBtnType.March_Stop)
            --end
            
        elseif marchInfo:GetMarchType() ~= NewMarchType.MONSTER_SIEGE then
            local data =  DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
            if data~=nil then
                local allianceUid = data.uid
                if marchInfo.allianceUid~=nil and marchInfo.allianceUid~="" and marchInfo.allianceUid == allianceUid then
                    if marchInfo:GetMarchType() ~= NewMarchType.ASSEMBLY_MARCH then
                        table.insert(self.btnListType,WorldMarchTileBtnType.March_ViewTroop)
                    end
                else
                    --table.insert(self.btnListType,WorldMarchTileBtnType.None)
                    
                    if marchInfo:GetMarchType() ~= NewMarchType.ASSEMBLY_MARCH then
                        table.insert(self.btnListType,WorldMarchTileBtnType.March_ViewTroop)
                    end
                    table.insert(self.btnListType,WorldMarchTileBtnType.March_Attack)
                    table.insert(self.btnListType, WorldMarchTileBtnType.March_Scout)
                end
            else
                if marchInfo:GetMarchType() ~= NewMarchType.ASSEMBLY_MARCH then
                    table.insert(self.btnListType,WorldMarchTileBtnType.March_ViewTroop)
                end
                table.insert(self.btnListType,WorldMarchTileBtnType.March_Attack)
                table.insert(self.btnListType, WorldMarchTileBtnType.March_Scout)
            end
        end
        local totalCount = #self.btnListType
        if totalCount>0 then
            local a,b = math.modf(totalCount/2)
            if b<=0 then
                table.insert(self.btnListType,WorldMarchTileBtnType.None)
            end
        end
        if marchInfo:GetMarchType() == NewMarchType.ASSEMBLY_MARCH and marchInfo:GetMarchStatus() == MarchStatus.WAIT_THRONE and marchInfo.inBattle == false then
            local index = -1
            if marchInfo.allianceUid == LuaEntry.Player.allianceId then
                index = DataCenter.WorldMarchDataManager:GetRallyMarchIndexByUuid(marchInfo.uuid)
            end
            self.march_wait_obj:SetActive(true)
            if index>0 then
                self.march_wait_txt.text = Localization:GetString("250039",index) 
            else
                self.march_wait_txt.text = Localization:GetString("250040")
            end
            DataCenter.GuideManager:CheckDoTriggerGuide(GuideTriggerType.WaitRallyTeamMarch, SaveGuideDoneValue)
        else
            self.march_wait_obj:SetActive(false)
        end
        --if CrossServerUtil:GetIsCrossServer() and CrossServerUtil:GetCrossServerIsInSameSeason() == false then
        --    if marchInfo.ownerUid ~= LuaEntry.Player.uid then
        --        self.btnListType = {}
        --    end
        --end
        
        if marchInfo:GetIsBroken() then
            if marchInfo.ownerUid == LuaEntry.Player.uid and marchInfo:GetMarchType() == NewMarchType.NORMAL and marchInfo:GetMarchStatus() == MarchStatus.STATION then
                self.btnListType = {}
                table.insert(self.btnListType,WorldMarchTileBtnType.March_Callback)
                self.btn_obj.gameObject:SetActive(true)
                self:RefreshBtn()
            else
                self.btn_obj.gameObject:SetActive(false)
            end
        elseif #self.btnListType<=0 then
            self.btn_obj.gameObject:SetActive(false)
        else
            self.btn_obj.gameObject:SetActive(true)
            self:RefreshBtn()
        end
        
        --self:UpdatePosition()
        self:OnMarchUpdate()
    end
    
    self.isUpdate = true
    self:Update()
end

local function OnBtn1Click(self)
    local type = self.btnListType[1]
    if type~=nil and type~= WorldMarchTileBtnType.None then
        WorldMarchTileUIManager:GetInstance():OnBtnClick(type,self.marchUuid)
    end
end
local function OnBtn2Click(self)
    local type = self.btnListType[2]
    if type~=nil and type~= WorldMarchTileBtnType.None then
        WorldMarchTileUIManager:GetInstance():OnBtnClick(type,self.marchUuid)
    end
end
local function OnBtn3Click(self)
    local type = self.btnListType[3]
    if type~=nil and type~= WorldMarchTileBtnType.None then
        WorldMarchTileUIManager:GetInstance():OnBtnClick(type,self.marchUuid)
    end
end
local function OnBtn4Click(self)
    local type = self.btnListType[4]
    if type~=nil and type~= WorldMarchTileBtnType.None then
        WorldMarchTileUIManager:GetInstance():OnBtnClick(type,self.marchUuid)
    end
end
local function OnBtn5Click(self)
    local type = self.btnListType[5]
    if type~=nil and type~= WorldMarchTileBtnType.None then
        WorldMarchTileUIManager:GetInstance():OnBtnClick(type,self.marchUuid)
    end
end

local function RefreshBtn(self)
    table.sort(self.btnListType,function(a,b)
        return a<b
    end)
    local count = #self.btnListType
    if count==1 then
        self.march_btn_4.gameObject:SetActive(false)
        self.march_btn_5.gameObject:SetActive(false)
        self.march_btn_2.gameObject:SetActive(false)
        self.march_btn_3.gameObject:SetActive(false)
        local type1 = self.btnListType[1]
        if type1~=nil and type1~=WorldMarchTileBtnType.None then
            self.march_btn_1.gameObject:SetActive(true)
            local img1 = WorldMarchBtnTypeImage[type1]
            self.march_btn_1_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img1))
            local name1 = WorldMarchBtnTypeName[type1]
            self.march_btn_1_txtBg.gameObject:SetActive(name1)
            if name1 then
                self.march_btn_1_txt.text = Localization:GetString(name1)
            end
        else
            self.march_btn_1.gameObject:SetActive(false)
        end
    elseif count ==3 then
        self.march_btn_4.gameObject:SetActive(false)
        self.march_btn_5.gameObject:SetActive(false)
        local type1 = self.btnListType[1]
        local type2 = self.btnListType[2]
        local type3 = self.btnListType[3]
        if type1~=nil and type1~=WorldMarchTileBtnType.None then
            self.march_btn_1.gameObject:SetActive(true)
            local img1 = WorldMarchBtnTypeImage[type1]
            self.march_btn_1_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img1))
            local name1 = WorldMarchBtnTypeName[type1]
            self.march_btn_1_txtBg.gameObject:SetActive(name1)
            if name1 then
                self.march_btn_1_txt.text = Localization:GetString(name1)
            end
            self.march_btn_2.gameObject.transform.localPosition = BtnPosition[3][1]
            self.march_btn_3.gameObject.transform.localPosition = BtnPosition[3][2]
        else
            self.march_btn_1.gameObject:SetActive(false)
            self.march_btn_2.gameObject.transform.localPosition = BtnPosition[2][1]
            self.march_btn_3.gameObject.transform.localPosition = BtnPosition[2][2]
        end
        if type2~=nil and type2~=WorldMarchTileBtnType.None then
            self.march_btn_2.gameObject:SetActive(true)
            local img2 = WorldMarchBtnTypeImage[type2]
            self.march_btn_2_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img2))
            local name2 = WorldMarchBtnTypeName[type2]
            self.march_btn_2_txtBg.gameObject:SetActive(name2)
            if name2 then
                self.march_btn_2_txt.text = Localization:GetString(name2)
            end
        else
            self.march_btn_2.gameObject:SetActive(false)
        end
        if type3~=nil and type3~=WorldMarchTileBtnType.None then
            self.march_btn_3.gameObject:SetActive(true)
            local img3 = WorldMarchBtnTypeImage[type3]
            self.march_btn_3_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img3))
            local name3 = WorldMarchBtnTypeName[type3]
            self.march_btn_3_txtBg.gameObject:SetActive(name3)
            if name3 then
                self.march_btn_3_txt.text = Localization:GetString(name3)
            end
        else
            self.march_btn_3.gameObject:SetActive(false)
        end
    elseif count ==5 then
        local type1 = self.btnListType[1]
        local type2 = self.btnListType[2]
        local type3 = self.btnListType[3]
        local type4 = self.btnListType[4]
        local type5 = self.btnListType[5]
        if type1~=nil and type1~=WorldMarchTileBtnType.None then
            self.march_btn_1.gameObject:SetActive(true)
            local img1 = WorldMarchBtnTypeImage[type1]
            self.march_btn_1_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img1))
            local name1 = WorldMarchBtnTypeName[type1]
            self.march_btn_1_txtBg.gameObject:SetActive(name1)
            if name1 then
                self.march_btn_1_txt.text = Localization:GetString(name1)
            end
            self.march_btn_2.gameObject.transform.localPosition = BtnPosition[5][1]
            self.march_btn_3.gameObject.transform.localPosition = BtnPosition[5][2]
            self.march_btn_4.gameObject.transform.localPosition = BtnPosition[5][3]
            self.march_btn_5.gameObject.transform.localPosition = BtnPosition[5][4]
        else
            self.march_btn_1.gameObject:SetActive(false)
            self.march_btn_2.gameObject.transform.localPosition = BtnPosition[4][1]
            self.march_btn_3.gameObject.transform.localPosition = BtnPosition[4][2]
            self.march_btn_4.gameObject.transform.localPosition = BtnPosition[4][3]
            self.march_btn_5.gameObject.transform.localPosition = BtnPosition[4][4]
        end
        if type2~=nil and type2~=WorldMarchTileBtnType.None then
            self.march_btn_2.gameObject:SetActive(true)
            local img2 = WorldMarchBtnTypeImage[type2]
            self.march_btn_2_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img2))
            local name2 = WorldMarchBtnTypeName[type2]
            self.march_btn_2_txtBg.gameObject:SetActive(name2)
            if name2 then
                self.march_btn_2_txt.text = Localization:GetString(name2)
            end
        else
            self.march_btn_2.gameObject:SetActive(false)
        end
        if type3~=nil and type3~=WorldMarchTileBtnType.None then
            self.march_btn_3.gameObject:SetActive(true)
            local img3 = WorldMarchBtnTypeImage[type3]
            self.march_btn_3_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img3))
            local name3 = WorldMarchBtnTypeName[type3]
            self.march_btn_3_txtBg.gameObject:SetActive(name3)
            if name3 then
                self.march_btn_3_txt.text = Localization:GetString(name3)
            end
        else
            self.march_btn_3.gameObject:SetActive(false)
        end
        if type4~=nil and type4~=WorldMarchTileBtnType.None then
            self.march_btn_4.gameObject:SetActive(true)
            local img4 = WorldMarchBtnTypeImage[type4]
            self.march_btn_4_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img4))
            local name4 = WorldMarchBtnTypeName[type4]
            self.march_btn_4_txtBg.gameObject:SetActive(name4)
            if name4 then
                self.march_btn_4_txt.text = Localization:GetString(name4)
            end
        else
            self.march_btn_4.gameObject:SetActive(false)
        end
        if type5~=nil and type5~=WorldMarchTileBtnType.None then
            self.march_btn_5.gameObject:SetActive(true)
            local img5 = WorldMarchBtnTypeImage[type5]
            self.march_btn_5_img:LoadSprite(string.format(LoadPath.UIBuildBtns,img5))
            local name5 = WorldMarchBtnTypeName[type5]
            self.march_btn_5_txtBg.gameObject:SetActive(name5)
            if name5 then
                self.march_btn_5_txt.text = Localization:GetString(name5)
            end
        else
            self.march_btn_5.gameObject:SetActive(false)
        end
    else
        self.march_btn_1.gameObject:SetActive(false)
        self.march_btn_2.gameObject:SetActive(false)
        self.march_btn_3.gameObject:SetActive(false)
        self.march_btn_4.gameObject:SetActive(false)
        self.march_btn_5.gameObject:SetActive(false)
    end
end

local function Update(self)
    if self.isUpdate then
        self.totalTime = self.totalTime + Time.deltaTime
        if self.totalTime>1 then
            local marchInfo = DataCenter.WorldMarchDataManager:GetMarch(self.marchUuid)
            if marchInfo~=nil then
                local curTime = UITimeManager:GetInstance():GetServerTime()
                local endTime = marchInfo.endTime
                local leftTime = endTime - curTime
                if leftTime >= 1000 then -- 1s
                    self.march_time_txt.text = UITimeManager:GetInstance():MilliSecondToFmtString(leftTime)
                else
                    if marchInfo:GetMarchStatus() == MarchStatus.ATTACKING and not marchInfo.inBattle then
                        self.march_time_txt.text = Localization:GetString("390789")
                    else
                        self.march_time_obj.gameObject:SetActive(false)
                        self.isUpdate = false
                    end
                end
            end
            self.totalTime = 0
        end
    end
end

local function OnMarchUpdate(self)
    local marchInfo = DataCenter.WorldMarchDataManager:GetMarch(self.marchUuid)
    if marchInfo~=nil then
        if marchInfo.inBattle==true or marchInfo:GetMarchStatus() == MarchStatus.MOVING or marchInfo:GetMarchStatus() == MarchStatus.CHASING or marchInfo:GetMarchStatus() == MarchStatus.BACK_HOME or marchInfo:GetMarchStatus() == MarchStatus.ATTACKING or marchInfo:GetMarchStatus() == MarchStatus.IN_WORM_HOLE or marchInfo:GetMarchStatus() == MarchStatus.CROSS_SERVER or marchInfo:GetMarchStatus() == MarchStatus.SAMPLING or marchInfo:GetMarchStatus() == MarchStatus.PICKING or marchInfo:GetMarchStatus() == MarchStatus.DESTROY_WAIT or marchInfo:GetMarchStatus() == MarchStatus.TRANSPORT_BACK_HOME then
            self.isUpdate = true
            self.march_time_obj.gameObject:SetActive(true)
            self.totalTime = 1
            self:Update()
        else
            self.march_time_obj.gameObject:SetActive(false)
            self.isUpdate = false
        end
    end
end


local function UpdatePosition(self)
    local troop = WorldTroopManager:GetInstance():GetTroop(self.marchUuid)
    if troop~=nil then
        self.transform.position = troop:GetPosition()
    end
end


WorldMarchTileUI.OnCreate = OnCreate
WorldMarchTileUI.OnDestroy = OnDestroy
WorldMarchTileUI.ComponentDefine = ComponentDefine
WorldMarchTileUI.ComponentDestroy = ComponentDestroy
WorldMarchTileUI.UpdatePosition = UpdatePosition
WorldMarchTileUI.Update = Update
WorldMarchTileUI.RemoveTimer =RemoveTimer
WorldMarchTileUI.OnMarchUpdate = OnMarchUpdate
WorldMarchTileUI.RefreshTroop = RefreshTroop
WorldMarchTileUI.OnBtn1Click =OnBtn1Click
WorldMarchTileUI.OnBtn2Click =OnBtn2Click
WorldMarchTileUI.OnBtn3Click =OnBtn3Click
WorldMarchTileUI.RefreshBtn =RefreshBtn
WorldMarchTileUI.GetMarchUuid = GetMarchUuid
WorldMarchTileUI.OnBtn4Click = OnBtn4Click
WorldMarchTileUI.OnBtn5Click = OnBtn5Click
return WorldMarchTileUI