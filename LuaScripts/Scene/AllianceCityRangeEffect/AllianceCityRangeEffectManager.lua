---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/1/5 21:09
---
local AllianceCityRangeEffectManager = BaseClass("AllianceCityRangeEffectManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local function __init(self)
    self.effectInstance =nil
    self.lodCache = 1
    self.showType = -1
    self.curCityId = -1
    self:AddListener()
end

local function __delete(self)
    self:RemoveEffect()
    self:RemoveListener()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.ChangeCameraLod, self.ChangeCameraLodSignal)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():AddListener(EventId.OnEnterCity, self.OnEnterCity)

end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.ChangeCameraLod, self.ChangeCameraLodSignal)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterCity, self.OnEnterCity)
end

local function RemoveAllTips(data)
    AllianceCityRangeEffectManager:GetInstance():RemoveEffect()
end
local function OnEnterWorld(data)
end
local function OnEnterCity(data)
    AllianceCityRangeEffectManager:GetInstance():RemoveEffect()
end
local function ChangeCameraLodSignal(lod)
    AllianceCityRangeEffectManager:GetInstance():UpdateLod(lod)
end

local function UpdateLod(self, lod)
    if self.lodCache ~=lod then
        self.lodCache =lod
        if self.effectInstance~=nil and self.effectInstance.gameObject~=nil then
            self.effectInstance.gameObject:SetActive(self.lodCache <=2)
        end
    end
end

local function ShowPos(self,cityId)
    local hide = true
    local model = ""
    local cacheShowType = self.showType
    local pointV2 = -1
    local cityData = DataCenter.WorldAllianceCityDataManager:GetAllianceCityDataByCityId(cityId)
    if cityData~=nil then
        if cityData.allianceId~=nil and cityData.allianceId~="" then
            local template = DataCenter.AllianceCityTemplateManager:GetTemplate(cityId)
            if template~=nil then
                self.curCityId = cityId
                hide = false
                pointV2 = template.pos
                if cityData.allianceId==LuaEntry.Player.allianceId then
                    self.showType =1
                    model = "Assets/Main/Prefabs/CityScene/WorldDesertCityEffectAlliance.prefab"
                else
                    self.showType =2
                    model = "Assets/Main/Prefabs/CityScene/WorldDesertCityEffectOther.prefab"
                end
            end
            
        end
    end
    if hide == false then
        if cacheShowType~=self.showType then
            self:RemoveEffect()
        end
        local posV3 = SceneUtils.TileToWorld(pointV2,ForceChangeScene.World)
        if self.effectInstance~=nil then
            if self.effectInstance.gameObject~=nil then
                self.effectInstance.gameObject:SetActive(true)
                self.effectInstance.gameObject.transform.position = posV3
            end
        else
            local request = ResourceManager:InstantiateAsync(model)
            self.effectInstance = request
            request:completed('+', function()
                if request.isError then
                    self.effectInstance = nil
                    return
                end
                request.gameObject:SetActive(true)
                request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
                request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                request.gameObject.transform.position = posV3
            end)
        end
    else
        self:RemoveEffect() 
    end
    
end

local function HidePos(self,cityId)
    if cityId == self.curCityId then
        if self.effectInstance~=nil then
            if self.effectInstance.gameObject~=nil then
                self.effectInstance.gameObject:SetActive(false)
            end
        end
    end
end
local function RemoveEffect(self)
    if self.effectInstance ~= nil then
        self.effectInstance:Destroy()
        self.effectInstance = nil
    end
end

AllianceCityRangeEffectManager.OnEnterWorld = OnEnterWorld
AllianceCityRangeEffectManager.OnEnterCity = OnEnterCity
AllianceCityRangeEffectManager.__init = __init
AllianceCityRangeEffectManager.__delete = __delete
AllianceCityRangeEffectManager.AddListener = AddListener
AllianceCityRangeEffectManager.RemoveListener = RemoveListener
AllianceCityRangeEffectManager.RemoveEffect = RemoveEffect
AllianceCityRangeEffectManager.ShowPos = ShowPos
AllianceCityRangeEffectManager.HidePos = HidePos
AllianceCityRangeEffectManager.RemoveAllTips =RemoveAllTips
AllianceCityRangeEffectManager.UpdateLod= UpdateLod
AllianceCityRangeEffectManager.ChangeCameraLodSignal = ChangeCameraLodSignal
return AllianceCityRangeEffectManager