---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 27/3/2024 下午2:21
---
local base = WorldTroopStateBase
local WorldTroopStateIdle = BaseClass("WorldTroopStateIdle",WorldTroopStateBase)
local Const = require"Scene.WorldTroopManager.Const"

function WorldTroopStateIdle:__init(worldTroop,stateMachine)
    base.__init(self,worldTroop,stateMachine)
end

function WorldTroopStateIdle:__delete()
    base.__delete(self)
end
function WorldTroopStateIdle:OnStateEnter()
    if self.worldTroop == nil then
        return
    end
    EventManager:GetInstance():Broadcast(EventId.CheckTroopStateIcon,self.worldTroop:GetMarchUUID())
    self.targetPos = self.worldTroop:GetMarchTargetPos()
    if self.worldTroop:GetMarchStatus() == MarchStatus.STATION then
        self.worldTroop:SetRotation(self.worldTroop:GetStationRotation())
    end
    self.worldTroop:PlayAnim(Const.WorldTroopAnim.Anim_Idle)
    WorldTroopManager:GetInstance():UpdateListRemove(self.worldTroop:GetMarchUUID())
    self:OnTroopChange()
    
end

function WorldTroopStateIdle:OnStateLeave()

end

function WorldTroopStateIdle:OnStateUpdate()

end

function WorldTroopStateIdle:OnTroopChange()
    if self.worldTroop == nil then
        return
    end
    if self.worldTroop:IsBattle() == false then
        if self.worldTroop:GetMarchStatus() == MarchStatus.CHASING 
                or self.worldTroop:GetMarchStatus() == MarchStatus.MOVING 
                or self.worldTroop:GetMarchStatus() == MarchStatus.IN_WORM_HOLE then
            if self.worldTroop:GetMovePathCount() > 1 then
                local targetPos = self.worldTroop:GetMarchTargetPos()
                if targetPos~= self.targetPos then
                    self:ChangeState(Const.WorldTroopState.Move)
                end
            end
        elseif self.worldTroop:GetMarchStatus() == MarchStatus.DESTROY_WAIT then
            self:ChangeState(Const.WorldTroopState.AttackBuild)
        elseif self.worldTroop:GetMarchStatus() == MarchStatus.TRANSPORT_BACK_HOME then
            self:ChangeState(Const.WorldTroopState.TransPortBackHome)
        elseif self.worldTroop:GetMarchStatus() == MarchStatus.PICKING or self.worldTroop:GetMarchStatus() == MarchStatus.SAMPLING then
            self:ChangeState(Const.WorldTroopState.PickGarbageMovetoGarbage)
        end
    else
        self:ChangeState(Const.WorldTroopState.Attack)
        
    end
end
return WorldTroopStateIdle