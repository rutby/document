---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/3/6 14:31
---
local WorldAlCenterSelectEffectManager = BaseClass("WorldAlCenterSelectEffectManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local ColorSelf = Color.New(0,1,0,1)
local ColorOther = Color.New(1,0,0,1)
local function __init(self)
    self.rangeObjMat = nil
    self:AddListener()
end

local function __delete(self)
    self:RemoveListener()
    self:RemoveEffect()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():AddListener(EventId.OnEnterCity, self.OnEnterCity)

end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterCity, self.OnEnterCity)
end

local function RemoveAllTips(data)
    WorldAlCenterSelectEffectManager:GetInstance():RemoveEffect()
end
local function OnEnterWorld(data)
end
local function OnEnterCity(data)
    WorldAlCenterSelectEffectManager:GetInstance():RemoveEffect()
end

local function ShowPos(self,pointId,state)
    if self.effectInstance~=nil then
        if self.effectInstance.gameObject~=nil then
            self.effectInstance.gameObject:SetActive(true)
            local posV3 = SceneUtils.TileIndexToWorld(pointId,ForceChangeScene.World)
            self.effectInstance.gameObject.transform.position = posV3
            if self.rangeObjMat~=nil then
                if state == BuildPutState.Ok then
                    self.rangeObjMat.color = ColorSelf
                else
                    self.rangeObjMat.color = ColorOther
                end
            end
        end
    else
        local request = ResourceManager:InstantiateAsync("Assets/Main/Prefabs/Building/AllianceSelectRange.prefab")
        self.effectInstance = request
        local pointIndex = pointId
        request:completed('+', function()
            if request.isError then
                self.effectInstance = nil
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            local posV3 = SceneUtils.TileIndexToWorld(pointIndex,ForceChangeScene.World)
            request.gameObject.transform.position = posV3
            local range = request.gameObject.transform:Find("range"):GetComponent(typeof(CS.UnityEngine.Renderer))
            if range~=nil then
                self.rangeObjMat = range.material
            end
            if state == BuildPutState.Ok then
                self.rangeObjMat.color = ColorSelf
            else
                self.rangeObjMat.color = ColorOther
            end
        end)
    end
end

local function HidePos(self)
    self:RemoveEffect()
end
local function RemoveEffect(self)
    if self.effectInstance ~= nil then
        self.effectInstance:Destroy()
        self.effectInstance = nil
    end
end

WorldAlCenterSelectEffectManager.OnEnterWorld = OnEnterWorld
WorldAlCenterSelectEffectManager.OnEnterCity = OnEnterCity
WorldAlCenterSelectEffectManager.__init = __init
WorldAlCenterSelectEffectManager.__delete = __delete
WorldAlCenterSelectEffectManager.AddListener = AddListener
WorldAlCenterSelectEffectManager.RemoveListener = RemoveListener
WorldAlCenterSelectEffectManager.RemoveEffect = RemoveEffect
WorldAlCenterSelectEffectManager.ShowPos = ShowPos
WorldAlCenterSelectEffectManager.HidePos = HidePos
WorldAlCenterSelectEffectManager.RemoveAllTips =RemoveAllTips
return WorldAlCenterSelectEffectManager