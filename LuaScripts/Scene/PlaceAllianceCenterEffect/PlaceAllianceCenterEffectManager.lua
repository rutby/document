---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/3/6 10:35
---
local PlaceAllianceCenterEffectManager = BaseClass("PlaceAllianceCenterEffectManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local function __init(self)
    self:AddListener()
    self.placeLevelList = {}
    self.OnCreateTips = {}
    self.canPlaceEmpty = false
    self.showEffect = false
end

local function __delete(self)
    self.placeLevelList = {}
    self.canPlaceEmpty = false
    self.showEffect = false
    self:RemoveListener()
    self:RemoveAllEffect()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():AddListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():AddListener(EventId.DesertInView, self.ShowDesertSignal)
    EventManager:GetInstance():AddListener(EventId.DesertOutView, self.HideDesertSignal)
end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():RemoveListener(EventId.DesertInView, self.ShowDesertSignal)
    EventManager:GetInstance():RemoveListener(EventId.DesertOutView, self.HideDesertSignal)
end

local function RemoveAllTips(data)
    PlaceAllianceCenterEffectManager:GetInstance():RemoveAllEffect()
end
local function OnEnterWorld(data)
end
local function OnEnterCity(data)
    PlaceAllianceCenterEffectManager:GetInstance():RemoveAllEffect()
end

local function ShowDesertSignal(data)
    PlaceAllianceCenterEffectManager:GetInstance():CheckShowDesert(tonumber(data))
end

local function HideDesertSignal(data)
    PlaceAllianceCenterEffectManager:GetInstance():RemoveOneEffect(tonumber(data))
end


local function EnterPlaceAllianceCenterMode(self,needList,canPlaceEmpty)
    self.placeLevelList = needList
    self.canPlaceEmpty = canPlaceEmpty
    self.showEffect = true
    if CS.SceneManager.World.GetDesertPointList ~= nil then
        local desertMap = CS.SceneManager.World:GetDesertPointList()
        if desertMap ~= nil and desertMap.Count > 0 then
            for k,v in pairs(desertMap) do
                local desertData = v:GetWorldDesertInfo()
                if desertData~=nil then
                    local playerType = desertData:GetPlayerType()
                    if (playerType == CS.PlayerType.PlayerNone and self.canPlaceEmpty == true ) or (playerType == CS.PlayerType.PlayerSelf or playerType == CS.PlayerType.PlayerAlliance or playerType == CS.PlayerType.PlayerAllianceLeader) then
                        local desertId = desertData.desertId
                        local desertLevel = GetTableData(TableName.Desert, desertId, "desert_level")
                        if desertId~=nil then
                            if self.placeLevelList[desertLevel]~=nil then
                                self:ShowOneEffect(desertData.uuid,desertData.pointIndex)
                            end
                        end
                    end
                end
            end

        end
        
    end
    
end

local function QuitPlaceAllianceCenterMode(self)
    self:RemoveAllEffect()
    self.placeLevelList = {}
    self.canPlaceEmpty = false
    self.showEffect = false
end

local function CheckShowDesert(self,uuid)
    if self.showEffect ==false then
        return
    end
    if SceneUtils.GetIsInWorld() == false then
        return
    end
    if CS.SceneManager.World.GetDesertInfoByUuid ==nil then
        return
    end
    local desertData = CS.SceneManager.World:GetDesertInfoByUuid(uuid)
    if desertData~=nil then
        local playerType = desertData:GetPlayerType()
        if (playerType == CS.PlayerType.PlayerNone and self.canPlaceEmpty == true ) or (playerType == CS.PlayerType.PlayerSelf or playerType == CS.PlayerType.PlayerAlliance or playerType == CS.PlayerType.PlayerAllianceLeader) then
            local desertId = desertData.desertId
            local desertLevel = GetTableData(TableName.Desert, desertId, "desert_level")
            if desertId~=nil then
                if self.placeLevelList[desertLevel]~=nil then
                    self:ShowOneEffect(uuid,desertData.pointIndex)
                end
            end
        end
        
    end
end

local function ShowOneEffect(self,uuid,pointIndex)
    if SceneUtils.GetIsInWorld() == false then
        return
    end
    if self.OnCreateTips[uuid] == nil then
        local modelName ="Assets/Main/Prefabs/BuildEffect/CanPutEffect.prefab"
        local request = ResourceManager:InstantiateAsync(modelName)
        self.OnCreateTips[uuid] = request
        request:completed('+', function()
            if request.isError then
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            local posV3 = SceneUtils.TileIndexToWorld(pointIndex,ForceChangeScene.World)
            request.gameObject.transform.position = posV3
        end)
    end
end

local function RemoveOneEffect(self,uuid)
    local request = self.OnCreateTips[uuid]
    if request ~= nil then
        request:Destroy()
        self.OnCreateTips[uuid] = nil
    end
end

local function RemoveAllEffect(self)
    if self.OnCreateTips~=nil then
        for k,v in pairs(self.OnCreateTips) do
            v:Destroy()
        end
        self.OnCreateTips = {}
    end
end

PlaceAllianceCenterEffectManager.OnEnterWorld = OnEnterWorld
PlaceAllianceCenterEffectManager.OnEnterCity = OnEnterCity
PlaceAllianceCenterEffectManager.__init = __init
PlaceAllianceCenterEffectManager.__delete = __delete
PlaceAllianceCenterEffectManager.AddListener = AddListener
PlaceAllianceCenterEffectManager.RemoveListener = RemoveListener
PlaceAllianceCenterEffectManager.RemoveOneEffect = RemoveOneEffect
PlaceAllianceCenterEffectManager.RemoveAllTips =RemoveAllTips
PlaceAllianceCenterEffectManager.RemoveAllEffect =RemoveAllEffect
PlaceAllianceCenterEffectManager.ShowOneEffect = ShowOneEffect
PlaceAllianceCenterEffectManager.CheckShowDesert = CheckShowDesert
PlaceAllianceCenterEffectManager.QuitPlaceAllianceCenterMode =QuitPlaceAllianceCenterMode
PlaceAllianceCenterEffectManager.EnterPlaceAllianceCenterMode = EnterPlaceAllianceCenterMode
PlaceAllianceCenterEffectManager.ShowDesertSignal = ShowDesertSignal
PlaceAllianceCenterEffectManager.HideDesertSignal = HideDesertSignal
return PlaceAllianceCenterEffectManager