---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/8/10 17:05
---
local CityDomeProtectEffectManager = BaseClass("CityDomeProtectEffectManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local CityDomeProtectEffect = require "Scene.CityDomeProtectEffect.CityDomeProtectEffect"
local function __init(self)
    self.allEffect = {} --所有建筑特效
    self.OnCreateEffect ={}
    self:AddListener()
end

local function __delete(self)
    for k,v in pairs(self.allEffect) do
        local request = v.request
        v:OnDestroy()
        request:Destroy()
    end
    for k,v in pairs(self.OnCreateEffect) do
        v:Destroy()
    end
    self.OnCreateEffect = nil
    self.allEffect = nil
    self:RemoveListener()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.CheckDomeOpen, self.BuildInViewSignal)
    EventManager:GetInstance():AddListener(EventId.WORLD_BUILD_OUT_VIEW, self.BuildOutViewSignal)
    --EventManager:GetInstance():AddListener(EventId.CityDomeShow, self.CityDomeShowSignal)
    --EventManager:GetInstance():AddListener(EventId.CityDomeHide, self.CityDomeHideSignal)
    --EventManager:GetInstance():AddListener(EventId.ShowDomeGlass, self.BuildInViewSignal)
end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.CheckDomeOpen, self.BuildInViewSignal)
    EventManager:GetInstance():RemoveListener(EventId.WORLD_BUILD_OUT_VIEW, self.BuildOutViewSignal)
    --EventManager:GetInstance():RemoveListener(EventId.CityDomeShow, self.CityDomeShowSignal)
    --EventManager:GetInstance():RemoveListener(EventId.CityDomeHide, self.CityDomeHideSignal)
    --EventManager:GetInstance():RemoveListener(EventId.ShowDomeGlass, self.BuildInViewSignal)
end

local function RemoveAllTips(data)
    CityDomeProtectEffectManager:GetInstance():RemoveAllEffect()
end

local function RemoveAllEffect(self)
    for k,v in pairs(self.allEffect) do
        local request = v.request
        v:OnDestroy()
        request:Destroy()
    end
    for k,v in pairs(self.OnCreateEffect) do
        v:Destroy()
    end
    self.OnCreateEffect = {}
    self.allEffect = {}
end
local function ShowBuildProtectEffect(self,bUuid,posIndex,endTime,domeLv,skinId)
    local param = {}
    param.bUuid = bUuid
    param.posIndex = posIndex
    param.endTime = endTime
    param.domeLv = domeLv
    if self.allEffect[bUuid]==nil and self.OnCreateEffect[bUuid] == nil then
        --local prefabName = string.format(UIAssets.CityDomeProtectEffect,domeLv);
        local request = ResourceManager:InstantiateAsync("Assets/Main/Prefabs/World/CityDomeProtectEffect_new.prefab")
        self.OnCreateEffect[bUuid] = request
        request:completed('+', function()
            self.OnCreateEffect[bUuid] =nil
            if request.isError then
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            local scale = 1
            if skinId~=nil and skinId>0 then
                scale =1.086
            end
            request.gameObject.transform:Set_localScale(scale, scale, scale)
            local effect = CityDomeProtectEffect.New()
            effect:OnCreate(request)
            effect:ReInit(param)
            self.allEffect[bUuid] = effect
        end)
    --elseif self.allEffect[bUuid]~=nil then
    --    local temp = self.allEffect[bUuid]
    --    if temp ~= nil then
    --        if temp:GetDomeLevel()~= domeLv then
    --            self:RemoveBuildProtectEffect(bUuid)
    --            local prefabName = string.format(UIAssets.CityDomeProtectEffect,domeLv);
    --            local request = ResourceManager:InstantiateAsync(prefabName)
    --            self.OnCreateEffect[bUuid] = request
    --            request:completed('+', function()
    --                self.OnCreateEffect[bUuid] =nil
    --                if request.isError then
    --                    return
    --                end
    --                request.gameObject:SetActive(true)
    --                request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
    --                request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
    --                local effect = CityDomeProtectEffect.New()
    --                effect:OnCreate(request)
    --                effect:ReInit(param)
    --                self.allEffect[bUuid] = effect
    --            end)
    --        end
    --    end
    end
end


local function RemoveBuildProtectEffect(self,bUuid)
    local temp = self.allEffect[bUuid]
    if temp ~= nil then
        local request = temp.request
        temp:OnDestroy()
        request:Destroy()
        self.allEffect[bUuid] = nil
    end
    if self.OnCreateEffect[bUuid]~=nil then
        self.OnCreateEffect[bUuid]:Destroy()
        self.OnCreateEffect[bUuid] = nil
    end
end

local function BuildInViewSignal(uuid)
    CityDomeProtectEffectManager:GetInstance():CheckShowEffect(tonumber(uuid))
end

local function BuildOutViewSignal(uuid)
    CityDomeProtectEffectManager:GetInstance():RemoveBuildProtectEffect(tonumber(uuid))
end

local function CityDomeShowSignal(uuid)
    CityDomeProtectEffectManager:GetInstance():ShowDome(tonumber(uuid))
end

local function CityDomeHideSignal(uuid)
    CityDomeProtectEffectManager:GetInstance():HideDome(tonumber(uuid))
end

local function CheckShowEffect(self,bUuid)
    local info = DataCenter.WorldPointManager:GetBuildDataByUuid(bUuid)
    if info~=nil then
        if info.itemId == BuildingTypes.FUN_BUILD_MAIN then
            if info.protectEndTime~=nil and info.protectEndTime>=0 then
                local curTime = UITimeManager:GetInstance():GetServerSeconds()
                if curTime< info.protectEndTime then
                    local levelTemplate = DataCenter.BuildTemplateManager:GetBuildingLevelTemplate(info.itemId, info.level)
                    if levelTemplate ~= null then
                        self:ShowBuildProtectEffect(info.uuid,info.mainIndex,info.protectEndTime,levelTemplate.offer_range,info.skinId)
                    end
                else
                    self:RemoveBuildProtectEffect(info.uuid)
                end
            end
        end
    end
end


local function TimeCallBack(bUuid)
    CityDomeProtectEffectManager:GetInstance():RemoveOneEffect(bUuid)
end


local function ShowDome(self,bUuid)
    local temp = self.allEffect[bUuid]
    if temp ~= nil then
        temp:Show()
    end
end
local function HideDome(self,bUuid)
    local temp = self.allEffect[bUuid]
    if temp ~= nil then
        local info = DataCenter.WorldPointManager:GetBuildDataByUuid(bUuid)
        if info~=nil then
            if info.itemId == BuildingTypes.FUN_BUILD_MAIN then
                if info.ownerUid == LuaEntry.Player.uid then
                    temp:Hide()
                end
            end
            
        end
    end
end
CityDomeProtectEffectManager.__init = __init
CityDomeProtectEffectManager.__delete = __delete
CityDomeProtectEffectManager.AddListener = AddListener
CityDomeProtectEffectManager.RemoveListener = RemoveListener
CityDomeProtectEffectManager.BuildInViewSignal = BuildInViewSignal
CityDomeProtectEffectManager.BuildOutViewSignal = BuildOutViewSignal
CityDomeProtectEffectManager.RemoveBuildProtectEffect= RemoveBuildProtectEffect
CityDomeProtectEffectManager.CheckShowEffect = CheckShowEffect
CityDomeProtectEffectManager.ShowBuildProtectEffect = ShowBuildProtectEffect
CityDomeProtectEffectManager.TimeCallBack = TimeCallBack
CityDomeProtectEffectManager.ShowDome =ShowDome
CityDomeProtectEffectManager.HideDome =HideDome
CityDomeProtectEffectManager.CityDomeHideSignal = CityDomeHideSignal
CityDomeProtectEffectManager.CityDomeShowSignal = CityDomeShowSignal
CityDomeProtectEffectManager.RemoveAllEffect = RemoveAllEffect
CityDomeProtectEffectManager.RemoveAllTips = RemoveAllTips
return CityDomeProtectEffectManager