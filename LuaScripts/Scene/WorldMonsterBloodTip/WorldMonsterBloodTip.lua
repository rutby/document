---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 24/4/2024 上午11:54
---
local WorldMonsterBloodTip = BaseClass("WorldMonsterBloodTip")
local hp_spr_path = "Transform/back/hp"
local hp_red_spr_path ="Transform/back/hp/hpRed"
local blood_num_path = "Transform/back/hp/bloodNum"
local attack_name_path = "Transform/back/monsterNameBg/monsterName"
local icon_path = "Transform/back/monsterNameBg/icon"
local monsterBg = "Transform/back/monsterNameBg"
local ResourceManager = CS.GameEntry.Resource
local Localization = CS.GameEntry.Localization
--创建
local function OnCreate(self,go)
    if go ~= nil then
        self.request = go
        self.gameObject = go.gameObject
        self.transform = go.gameObject.transform
    end
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetHP(1,1)
    self:ComponentDestroy()
end
local function Hit(self)

end

local function ComponentDefine(self)
    self.hp_spr = self.transform:Find(hp_spr_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.hp_spr_red = self.transform:Find(hp_red_spr_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.icon = self.transform:Find(icon_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.attack_name = self.transform:Find(attack_name_path):GetComponent(typeof(CS.SuperTextMesh))
    self.blood_num = self.transform:Find(blood_num_path):GetComponent(typeof(CS.SuperTextMesh))
    self.cacheHpImg = ""
    self.startBloodPercent = 0
    self.endBloodPercent = 0
    self.curHp =-1
    self.isDoAnim = false
    self.cacheName = ""
    --self.__update_handle = function() self:Update() end
    --UpdateManager:GetInstance():AddUpdate(self.__update_handle)
end

local function ComponentDestroy(self)
    self.hp_spr = nil
    self.icon = nil
    self.attack_name = nil
    self.blood_num = nil
    self.cacheHpImg = nil
    self.cacheBloodPercent =nil
end

local function RemoveTimer(self)
    --UpdateManager:GetInstance():RemoveUpdate(self.__update_handle)
    --self.__update_handle = nil
end

local function ShowAnger(self)
end

local function ShowExploreInfo(self, pointIndex, soliderNum, hp, hpMax)
    local data = DataCenter.WorldPointManager:GetExplorePointInfoByIndex(pointIndex)
    if data ~= nil then
        local name = DataCenter.DetectEventTemplateManager:GetRealName(data.eventId)
        self:SetName(name)
        self:SetHP(hp, hpMax)
    end
end

local function ShowMarchInfo(self,marchInfo,isCreate)
    if isCreate== true then
        local monsterInfo = PBController.ParsePbFromBytes(marchInfo.extraInfo, "protobuf.WorldPointMonster")
        if monsterInfo.type == NewMarchType.MONSTER or monsterInfo.type == NewMarchType.BOSS
                or monsterInfo.type == NewMarchType.CHALLENGE_BOSS or monsterInfo.type == NewMarchType.MONSTER_SIEGE then
            local nameStr = DataCenter.MonsterTemplateManager:GetTableValue( monsterInfo.monsterId, "name")
            local name = Localization:GetString(nameStr)
            self:SetName(name)
        end
        self:SetHP(1, 1)
    end
end


local function SetName(self,name,allianceAbbr)
    local newName = ""
    if allianceAbbr~=nil and allianceAbbr~="" then
        newName = "["..allianceAbbr.."]"..name
    else
        newName = name
    end
    if self.cacheName~= newName then
        self.cacheName = newName
        self.attack_name.text = newName
    end

    --local nameWidth = self.player_name:GetWidth()
    --local size = self.name_bg.size
    --size.x = math.max(nameWidth+0.7,1.93)
    --self.name_bg.size = size
end


local function SetHP(self,hp,maxhp)
    if hp>1 and hp == self.curHp then
        return
    end
    self.curHp = hp
    if hp>1 then
        self.blood_num.text = hp
    else
        self.blood_num.text = ""
    end
    local percent =  hp/math.max(maxhp,1)
    if percent<=0 then
        percent = 0
    elseif percent>=1 then
        percent = 1
    end
    self.curTime =0
    self.startBloodPercent = self.endBloodPercent
    self.endBloodPercent = percent
    --if self.startBloodPercent~=0 then
    --    self.hp_spr_red.size = Vector2.New((self.startBloodPercent*1.39),0.17)
    --    self.deltaPro = self.endBloodPercent - self.startBloodPercent
    --    self.isDoAnim = true
    --    self:Update()
    --end
    local spr = ""
    if percent<0.3 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_red.png"
    elseif percent>=0.3 and percent<0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_yellow.png"
    elseif percent>=0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_green.png"
    end
    if self.cacheHpImg~=spr then
        self.hp_spr:LoadSprite(spr)
        self.cacheHpImg =spr
    end
    self.hp_spr.size = Vector2.New((percent*1.39),0.17)
end

--local function Update(self)
--    if self.isDoAnim then
--        self.curTime = self.curTime+Time.deltaTime
--        if self.curTime > 0.3 then
--            self.hp_spr_red.size = Vector2.New((self.endBloodPercent*1.39),0.17)
--            self.isDoAnim = false
--        else
--            local changePro = (self.curTime/0.3)
--            local curPro = self.startBloodPercent + (changePro*self.deltaPro)
--            if curPro<0 then
--                curPro =0
--            elseif curPro>=1 then
--                curPro = 1
--            end
--            self.hp_spr_red.size = Vector2.New((curPro*1.39),0.17)
--        end
--    end
--end

local function SetAnger(self,anger,maxAnger)
end

local function SetCarAnger(self,anger,maxAnger)
end
local function SetSelectCircle(self,value)
end

local function ShowBattleRedName(self)
end
local function HideSkillHeadEffect(self)

end
local function SetSelectRotation(self,value)  end



local function SetForWasteland(self)
    local obj = self.transform:Find(monsterBg)
    if (obj ~= nil) then
        obj.gameObject:SetActive(false)
    end
    self:SetHP(100, 100)
end

local function SetPowerInPve(self, value)
    local obj = self.transform:Find(monsterBg)
    if (obj ~= nil) then
        obj.gameObject:SetActive(true)
    end
    self.attack_name.text = value
    self.hp_spr.gameObject:SetActive(false)
end

local function SetForPve(self)
    local obj = self.transform:Find(monsterBg)
    if (obj ~= nil) then
        obj.gameObject:SetActive(false)
    end
    self.hp_spr.gameObject:SetActive(true)
    self:SetHP(100, 100)
end

local function SetEdenPoint(self)

end
WorldMonsterBloodTip.SetForPve = SetForPve
WorldMonsterBloodTip.SetPowerInPve = SetPowerInPve
WorldMonsterBloodTip.SetForWasteland = SetForWasteland
WorldMonsterBloodTip.OnCreate = OnCreate
WorldMonsterBloodTip.OnDestroy = OnDestroy
WorldMonsterBloodTip.ComponentDefine = ComponentDefine
WorldMonsterBloodTip.ComponentDestroy = ComponentDestroy
WorldMonsterBloodTip.ShowMarchInfo =ShowMarchInfo
WorldMonsterBloodTip.SetName = SetName
WorldMonsterBloodTip.SetHP = SetHP
WorldMonsterBloodTip.SetAnger =SetAnger
WorldMonsterBloodTip.ShowExploreInfo = ShowExploreInfo
WorldMonsterBloodTip.ShowAnger=ShowAnger
WorldMonsterBloodTip.Hit=Hit
WorldMonsterBloodTip.SetSelectCircle =SetSelectCircle
WorldMonsterBloodTip.SetSelectRotation =SetSelectRotation
WorldMonsterBloodTip.ShowBattleRedName =ShowBattleRedName
WorldMonsterBloodTip.HideSkillHeadEffect =HideSkillHeadEffect
WorldMonsterBloodTip.Update =Update
WorldMonsterBloodTip.RemoveTimer = RemoveTimer
WorldMonsterBloodTip.SetCarAnger =SetCarAnger
WorldMonsterBloodTip.SetEdenPoint =SetEdenPoint
return WorldMonsterBloodTip