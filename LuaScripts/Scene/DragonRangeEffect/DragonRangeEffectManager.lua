---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/6/19 21:27
---
local DragonRangeEffectManager = BaseClass("DragonRangeEffectManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local function __init(self)
    self:AddListener()
end

local function __delete(self)
    self:RemoveListener()
    self:RemoveAllEffect()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():AddListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():AddListener(EventId.QuitDragonWorld, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.DragonInfoRefresh, self.ShowAllTips)
    EventManager:GetInstance():AddListener(EventId.EnterDragonWorld, self.ShowAllTips)
end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():RemoveListener(EventId.QuitDragonWorld, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.DragonInfoRefresh, self.ShowAllTips)
    EventManager:GetInstance():RemoveListener(EventId.EnterDragonWorld, self.ShowAllTips)
end

local function RemoveAllTips(data)
    DragonRangeEffectManager:GetInstance():RemoveAllEffect()
end
local function ShowAllTips(data)
    DragonRangeEffectManager:GetInstance():ShowPos()
end
local function OnEnterWorld(data)
end
local function OnEnterCity(data)
    DragonRangeEffectManager:GetInstance():RemoveAllEffect()
end

local function ShowPos(self)
    if LuaEntry.Player.serverType ~= ServerType.DRAGON_BATTLE_FIGHT_SERVER then
        return
    end
    if self.effectInstanceLeft ~=nil and self.effectInstanceRight ~=nil then
        return
    end
    local dragonInfo = DataCenter.ActDragonManager:GetDragonInfo()

    if not dragonInfo then
        return
    end
    local selfSide = 0
    if dragonInfo.matchResult == 1 then
        local vsInfoArr = dragonInfo.vsInfoArr
        if vsInfoArr then
            for i = 1 ,table.count(vsInfoArr) do
                if vsInfoArr[i].allianceId == LuaEntry.Player:GetAllianceUid() then     --蓝方
                    selfSide = vsInfoArr[i].side
                end
            end
        end
    end
    local leftPos = {}
    local rightPos = {}
    if selfSide == 1 then
        leftPos.x = (537+(12/2))*2
        leftPos.y = 0
        leftPos.z = (537+(12/2))*2
        
        rightPos.x = (451+(12/2))*2
        rightPos.y = 0
        rightPos.z = (451+(12/2))*2
    else
        leftPos.x = (451+(12/2))*2
        leftPos.y = 0
        leftPos.z = (451+(12/2))*2

        rightPos.x = (537+(12/2))*2
        rightPos.y = 0
        rightPos.z = (537+(12/2))*2
    end
    if self.effectInstanceLeft == nil then
        local request = ResourceManager:InstantiateAsync("Assets/Main/Prefab_Dir/DragonBuilding/DragonRangeBlue.prefab")
        self.effectInstanceLeft = request
        request:completed('+', function()
            if request.isError then
                self.effectInstance = nil
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            local posV3 = leftPos
            request.gameObject.transform.position = posV3
        end)
    end

    if self.effectInstanceRight == nil then
        local request = ResourceManager:InstantiateAsync("Assets/Main/Prefab_Dir/DragonBuilding/DragonRangeRed.prefab")
        self.effectInstanceRight = request
        request:completed('+', function()
            if request.isError then
                self.effectInstance = nil
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            local posV3 = rightPos
            request.gameObject.transform.position = posV3
        end)
    end
end

local function RemoveEffect(self)
    if self.effectInstanceLeft ~= nil then
        self.effectInstanceLeft:Destroy()
        self.effectInstanceLeft = nil
    end
    if self.effectInstanceRight ~= nil then
        self.effectInstanceRight:Destroy()
        self.effectInstanceRight = nil
    end
end

local function RemoveAllEffect(self)
    self:RemoveEffect()
end

DragonRangeEffectManager.OnEnterWorld = OnEnterWorld
DragonRangeEffectManager.OnEnterCity = OnEnterCity
DragonRangeEffectManager.__init = __init
DragonRangeEffectManager.__delete = __delete
DragonRangeEffectManager.AddListener = AddListener
DragonRangeEffectManager.RemoveListener = RemoveListener
DragonRangeEffectManager.RemoveEffect = RemoveEffect
DragonRangeEffectManager.ShowPos = ShowPos
DragonRangeEffectManager.RemoveAllTips =RemoveAllTips
DragonRangeEffectManager.RemoveAllEffect =RemoveAllEffect
DragonRangeEffectManager.ShowAllTips =ShowAllTips
return DragonRangeEffectManager