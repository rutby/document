---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/9/18 17:57
---
local WorldDesertLevelUpManager = BaseClass("WorldDesertLevelUpManager", Singleton)
local ResourceManager = CS.GameEntry.Resource
local function __init(self)
    self:AddListener()
    self.OnCreateTips = {}
end

local function __delete(self)
    self:RemoveAllEffect()
    self:RemoveListener()
end

local function AddListener(self)
    EventManager:GetInstance():AddListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.MergeEnter, self.RemoveAllTips)
    EventManager:GetInstance():AddListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():AddListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():AddListener(EventId.DesertUpdateLevelInView, self.ShowDesertSignal)
    EventManager:GetInstance():AddListener(EventId.DesertUpdateLevelOutView, self.HideDesertSignal)
end

local function RemoveListener(self)
    EventManager:GetInstance():RemoveListener(EventId.PveLevelEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.MergeEnter, self.RemoveAllTips)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterWorld, self.OnEnterWorld)
    EventManager:GetInstance():RemoveListener(EventId.OnEnterCity, self.OnEnterCity)
    EventManager:GetInstance():RemoveListener(EventId.DesertUpdateLevelInView, self.ShowDesertSignal)
    EventManager:GetInstance():RemoveListener(EventId.DesertUpdateLevelOutView, self.HideDesertSignal)
end

local function RemoveAllTips(data)
    WorldDesertLevelUpManager:GetInstance():RemoveAllEffect()
end
local function OnEnterWorld(data)
end
local function OnEnterCity(data)
    WorldDesertLevelUpManager:GetInstance():RemoveAllEffect()
end

local function ShowDesertSignal(data)
    WorldDesertLevelUpManager:GetInstance():CheckShowDesert(tonumber(data))
end

local function HideDesertSignal(data)
    WorldDesertLevelUpManager:GetInstance():RemoveOneEffect(tonumber(data))
end


local function CheckShowDesert(self,uuid)
    if self.showEffect ==false then
        return
    end
    if SceneUtils.GetIsInWorld() == false then
        return
    end
    if CS.SceneManager.World.GetDesertInfoByUuid ==nil then
        return
    end
    local desertData = CS.SceneManager.World:GetDesertInfoByUuid(uuid)
    if desertData~=nil then
        if desertData.oriDesertId~=nil and desertData.oriDesertId ~= desertData.desertId and  desertData.oriDesertId > 0 then
            self:ShowOneEffect(uuid,desertData.pointIndex)
        end
    end
end

local function ShowOneEffect(self,uuid,pointIndex)
    if SceneUtils.GetIsInWorld() == false then
        return
    end
    if self.OnCreateTips[uuid] == nil then
        local modelName ="Assets/Main/Prefabs/Building/DesertLevelUp.prefab"
        local request = ResourceManager:InstantiateAsync(modelName)
        self.OnCreateTips[uuid] = request
        request:completed('+', function()
            if request.isError then
                return
            end
            request.gameObject:SetActive(true)
            request.gameObject.transform:SetParent(CS.SceneManager.World.DynamicObjNode)
            request.gameObject.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            local posV3 = SceneUtils.TileIndexToWorld(pointIndex,ForceChangeScene.World)
            request.gameObject.transform.position = posV3
        end)
    end
end

local function RemoveOneEffect(self,uuid)
    local request = self.OnCreateTips[uuid]
    if request ~= nil then
        request:Destroy()
        self.OnCreateTips[uuid] = nil
    end
end

local function RemoveAllEffect(self)
    if self.OnCreateTips~=nil then
        for k,v in pairs(self.OnCreateTips) do
            v:Destroy()
        end
        self.OnCreateTips = {}
    end
end

WorldDesertLevelUpManager.OnEnterWorld = OnEnterWorld
WorldDesertLevelUpManager.OnEnterCity = OnEnterCity
WorldDesertLevelUpManager.__init = __init
WorldDesertLevelUpManager.__delete = __delete
WorldDesertLevelUpManager.AddListener = AddListener
WorldDesertLevelUpManager.RemoveListener = RemoveListener
WorldDesertLevelUpManager.RemoveOneEffect = RemoveOneEffect
WorldDesertLevelUpManager.RemoveAllTips =RemoveAllTips
WorldDesertLevelUpManager.RemoveAllEffect =RemoveAllEffect
WorldDesertLevelUpManager.ShowOneEffect = ShowOneEffect
WorldDesertLevelUpManager.CheckShowDesert = CheckShowDesert
WorldDesertLevelUpManager.ShowDesertSignal = ShowDesertSignal
WorldDesertLevelUpManager.HideDesertSignal = HideDesertSignal
return WorldDesertLevelUpManager