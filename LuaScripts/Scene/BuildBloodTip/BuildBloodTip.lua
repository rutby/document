---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/8/3 14:19
---
local BuildBloodTip = BaseClass("BuildBloodTip")
local time_text_path = "PosGo/Bg/TimeText"
local slider_path = "PosGo/Bg/Slider"
local bg_path = "PosGo/Bg"

local PositionDelta7 = Vector3.New(-6,5,-6)
local PositionDelta = Vector3.New(0,5,0)
local SliderLength = Vector2.New(4.692847,0.63)
--创建
local function OnCreate(self,go)
    if go ~= nil then
        self.request = go
        self.gameObject = go.gameObject
        self.transform = go.gameObject.transform
    end
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:RemoveTimer()
    self:ComponentDestroy()
end

local function ComponentDefine(self)
    self.time_text = self.transform:Find(time_text_path):GetComponent(typeof(CS.SuperTextMesh))
    self.slider = self.transform:Find(slider_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.bg = self.transform:Find(bg_path)
    self.isDoAnim = false
    self.__update_handle = function() self:Update() end
    UpdateManager:GetInstance():AddUpdate(self.__update_handle)
end

local function ComponentDestroy(self)
    self.time_text = nil
    self.slider = nil
    self.bg = nil
end
local function RemoveTimer(self)
    if self.__update_handle ~=nil then
        UpdateManager:GetInstance():RemoveUpdate(self.__update_handle)
        self.__update_handle = nil
    end
end

local function StartShowBlood(self,param)
    self.data = param
    self:UpdatePosition(self.data.pointId)
    self.curTime =0
    self.curSize = Vector2.New(SliderLength.x,SliderLength.y)
    self.startPro = self.data.startValue / self.data.maxValue
    self.targetPro = self.data.targetValue/ self.data.maxValue
    self.deltaPro = self.targetPro- self.startPro
    self.isDoAnim = true
    self:Update()
end

local function RefreshSlider(self,value)
    if value >= 0 and value <= 1 then
        self.curSize.x = SliderLength.x * value
        if IsNull(self.slider) == false then
            self.slider.size = self.curSize
        end
    end
    
end

local function Update(self)
    if self.isDoAnim then
        self.curTime = self.curTime+Time.deltaTime
        if self.curTime > 2.5 then
            self:RemoveTimer()
            BuildBloodManager:GetInstance():RemoveOneEffect(self.data.bUuid)
        else
            if self.curTime<=2 then
                local changePro = self.curTime/2
                local curPro = self.startPro + (changePro*self.deltaPro)
                self:RefreshSlider(curPro)
                local temp = math.floor(curPro*self.data.maxValue)
                if IsNull(self.time_text) == false then
                    self.time_text.text = string.GetFormattedSeperatorNum(temp).."/"..string.GetFormattedSeperatorNum(self.data.maxValue)
                end
            end
            
        end
    end
end



--更新时间条位置
local function UpdatePosition(self,index)
    local worldPos = nil
    if self.data.tiles == BuildTilesSize.Seven then
        worldPos = SceneUtils.TileIndexToWorld(index) + PositionDelta7
    else
        worldPos = BuildingUtils.GetBuildModelCenterVec(index, self.data.tiles)+Vector3.New(0,self.data.tiles*2,0)
    end
    if IsNull(self.gameObject) ==false then
        self.transform.position = worldPos
    end
end


BuildBloodTip.OnCreate = OnCreate
BuildBloodTip.OnDestroy = OnDestroy
BuildBloodTip.ComponentDefine = ComponentDefine
BuildBloodTip.ComponentDestroy = ComponentDestroy
BuildBloodTip.RefreshSlider = RefreshSlider
BuildBloodTip.UpdatePosition = UpdatePosition
BuildBloodTip.Update = Update
BuildBloodTip.StartShowBlood = StartShowBlood
BuildBloodTip.RemoveTimer =RemoveTimer
return BuildBloodTip