---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2023/4/26 17:42
---僵尸攻击物体AI
local ZombieBaseAI = require("Scene.PVEBattleLevel.Character.AI.ZombieBaseAI")
local ZombieAI = require("Scene.PVEBattleLevel.Character.AI.ZombieAI")
local ZombieAttackObjectAI = BaseClass("ZombieAttackObjectAI",ZombieAI)

function ZombieAttackObjectAI:Move_Update(deltaTime)
    ZombieAI.Move_Update(self,deltaTime)
    if self.m_states:CurrentStateEqual(ZombieBaseAI.StateType.MoveState) then
        --说明还在追击状态
        self:ChooseNearestRoleTarget()
        --检测是否追出范围了
        self:CheckOutChaseRadius()
    end
    if self.m_target == nil then
        self.m_states:SetState(ZombieBaseAI.StateType.FindTargetState)
    end
end

function ZombieAttackObjectAI:AttackTarget_Update(deltaTime)
    ZombieAI.AttackTarget_Update(self,deltaTime)
    if self.m_states:CurrentStateEqual(ZombieAI.StateType.AttackState) then
        --说明还在攻击状态
        self:ChooseNearestRoleTarget()
    end
end

function ZombieAttackObjectAI:ChooseNearestRoleTarget()
    if not self.m_target.isPlayer then
        --当前目标不是玩家
        local newTarget = self.battleLevel.RoleMgr:SearchEnemyTarget(self.m_owner:GetPosition(),self.chaseRadius,self.m_owner:GetType())
        if newTarget then
            local newDis = Vector3.Distance(self.m_owner:GetPosition(),newTarget:GetPosition()) - newTarget:GetModelRadius()
            local dis = Vector3.Distance(self.m_owner:GetPosition(),self.m_target:GetPosition()) - self.m_target:GetModelRadius()
            if newDis < dis then
                self.m_target = newTarget --切换更近的玩家目标
            end
        end
    end
end

function ZombieAttackObjectAI:SearchEnemyTarget()
    local target = ZombieBaseAI.SearchEnemyTarget(self)
    if target == nil then
        target = self.battleLevel.ObjMgr:SearchInteractiveTarget(self.m_owner:GetPosition(),self.chaseRadius)
    end
    return target
end
--检测是否超出范围
function ZombieAttackObjectAI:CheckOutChaseRadius()
    if self.m_target.isPlayer then
        local dis = Vector3.Distance(self.m_owner:GetPosition(),self.m_target:GetPosition()) - self.m_target:GetModelRadius()
        if dis > self.chaseRadius then
            self.m_target = nil
        end
    end
end

function ZombieAttackObjectAI:CheckDisengageDistance(dis)
    return false
end
function ZombieAttackObjectAI:CheckMoveRange(ownerPos)
    return false
end
function ZombieAttackObjectAI:CanPatrol()
    return false
end
function ZombieAttackObjectAI:CanVigilance()
    return false
end

return ZombieAttackObjectAI