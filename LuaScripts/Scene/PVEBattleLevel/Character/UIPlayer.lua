---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2022/11/16 12:04
---
local UIPlayer = BaseClass("UIPlayer")
local PlayerSkin = require "Scene.PVEBattleLevel.Character.PlayerSkin"
local PvePlayerInfo = require "DataCenter.Survival.Character.PvePlayerInfo"
local Resource = CS.GameEntry.Resource
local RenderTextureFormat = CS.UnityEngine.RenderTextureFormat
local RenderTexture = CS.UnityEngine.RenderTexture

local speedRotate = 10

function UIPlayer:__init(parent,info,rawImage)
    self.m_parent = parent
    self.m_info = info
    self.m_rawImage = rawImage
    self.isDrag = false
    self:__create()
end

function UIPlayer:__create()
    self.m_rawImage:SetColorRGBA(1,1,1,0)
    --self.m_req = Resource:InstantiateAsync(string.format(LoadPath.PlayerPrefabPath,"uiactor"))
    --self.m_req:completed("+",function(req)
			
	local str = string.format(LoadPath.PlayerPrefabPath,"uiactor")
	self.m_req = CommonUtil.LoadResAsync(str, function(req)
        self.m_gameObject = self.m_req.gameObject
        self.m_transform = self.m_gameObject.transform
        --self.m_transform:SetParent(self.m_parent)
        -- self.m_transform.anchoredPosition3D = Vector3.New(-28,-50,0)
        --self.m_transform:Set_anchoredPosition3D(0,0,200)
        --self.m_transform:Set_localScale(1,1,1)
        
        self.m_skin = PlayerSkin.New(self.m_transform,self.m_info,self.m_gameObject.layer)
        --self.m_skin:SetLocalPosition(0,-180,-100)
        self.m_skin:SetLocalEulerAngles(0,180,0)
        --self.m_skin:SetLocalScale(200,200,200)

        self.m_animator = self.m_transform:GetComponentInChildren(typeof(CS.UnityEngine.Animator))
        
        self.m_camera = self.m_transform:Find("Camera"):GetComponent(typeof(CS.UnityEngine.Camera))
    
        self:__initEvent()
        self:__createRenderTexture()
        self:PlayDefaultAnim(0)
    end)
end

function UIPlayer:__initEvent()
    self.EquipSlotChangedHandler = function(data)
        self:EquipSlotChanged(data)
    end
    self.m_info:AddListener(PvePlayerInfo.PvePlayerInfoEventId.EquipChanged, self.EquipSlotChangedHandler)
    
    self.uiEventTrigger = self.m_rawImage.gameObject:GetComponent(typeof(CS.UIEventTrigger))
    self.uiEventTrigger.onBeginDrag = BindCallback(self,self.OnBeginDrag)
    self.uiEventTrigger.onDrag = BindCallback(self,self.OnDrag)
    self.uiEventTrigger.onEndDrag = BindCallback(self,self.OnEndDrag)
end

function UIPlayer:__createRenderTexture()
    local rt = RenderTexture.GetTemporary(1920,1080,0,RenderTextureFormat.ARGB32)
    rt.name = "UIPlayerTexture"
    self.m_renderTexture = rt
    self.m_rawImage:SetTexture(rt)
    self.m_rawImage:SetNativeSize()
    self.m_rawImage:SetColorRGBA(1,1,1,1)
    self.m_camera.targetTexture = rt
end

function UIPlayer:OnBeginDrag(eventData)
    self.isDrag = true
end

function UIPlayer:OnDrag(eventData)
    if not self.isDrag then
        return
    end
    local pointDisX = eventData.delta.x;
    local zSpeed = (-pointDisX) * Time.deltaTime;
    if pointDisX > 0 then
        self.m_skin:Rotate(0,pointDisX * zSpeed * speedRotate, 0);
    else
        self.m_skin:Rotate(0,-1 * pointDisX * zSpeed * speedRotate, 0);
    end
end

function UIPlayer:OnEndDrag(eventData)
    self.isDrag = false
end

function UIPlayer:PlayDefaultAnim(fixedTransitionDuration)
    local anim = self.m_info:GetDefaultAnimName()
    if string.IsNullOrEmpty(anim) then
        anim = PlayerAnimationName.Idle
    end
    self.m_animator:CrossFadeInFixedTime(anim,fixedTransitionDuration,0)
end

function UIPlayer:EquipSlotChanged(data)
    self.m_skin:EquipSlotChanged(data)
    local partType = data["partType"]
    if partType == SurvivalEquipType.Weapon then
        self:PlayDefaultAnim(0.2)
    end
end

function UIPlayer:SetActive(value)
    self.m_gameObject:SetActive(value)
end

function UIPlayer:DestroyRenderTexture()
    if self.m_rawImage ~= nil then
        self.m_rawImage:SetTexture(nil)
        self.m_rawImage = nil
    end
    if self.m_camera ~= nil then
        self.m_camera.targetTexture = nil
        self.m_camera = nil
    end
    if self.m_renderTexture ~= nil then
        RenderTexture.ReleaseTemporary(self.m_renderTexture)
        self.m_renderTexture = nil
    end
end

function UIPlayer:Destroy()
    if (self.EquipSlotChangedHandler ~= nil) then
        self.m_info:RemoveListener(PvePlayerInfo.PvePlayerInfoEventId.EquipChanged, self.EquipSlotChangedHandler)
    end
    self.m_info = nil
    self.m_req:Destroy()
    self.m_req = nil
    if (self.m_skin ~= nil) then
        self.m_skin:SetLocalScale(1,1,1)
        self.m_skin:Destroy()
    end
    self.m_skin = nil
    self.m_parent = nil
    if self.uiEventTrigger ~= nil then
        self.uiEventTrigger.onBeginDrag = nil
        self.uiEventTrigger.onDrag = nil
        self.uiEventTrigger.onEndDrag = nil
        self.uiEventTrigger = nil
    end
    self:DestroyRenderTexture()
end

return UIPlayer