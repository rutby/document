---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by qiyonghui.
--- DateTime: 2023/6/6 17:11
---CharacterPeeOrStoolState 大小便状态机
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
---@class CharacterBuildState | CharacterBaseState
local CharacterPeeOrStoolState = BaseClass("CharacterBuildState",CharacterBaseState)
local CharacterStateType = require("Scene.PVEBattleLevel.Character.State.CharacterStateType")
--PeeOrStool
function CharacterPeeOrStoolState:OnEnter()
    self.m_totalTime = LuaEntry.DataConfig:TryGetNum("pee", "k4")--洗澡动画播放时长x秒
    self.batheTimer = 0
    self:PlayAnim()
    self:AddTimer()
end

function CharacterPeeOrStoolState:PlayAnim()
    self.m_owner:HideWeapon() --隐藏武器
    local isStoolState = self.m_owner.info:IsStoolState()
    local rectangle = nil
    if isStoolState then
        --播放大便动画
        self.m_owner:PlayAnim("shit")
        UIUtil.ShowCharacterDialog(Localization:GetString(820718), self.m_owner)
        rectangle = CS.UnityEngine.Vector4.New(0.45,0.49,0.5,0.58)
    else
        --播放小便动画
        self.m_owner:PlayAnim("pee")
        UIUtil.ShowCharacterDialog(Localization:GetString(820716), self.m_owner)
        rectangle = CS.UnityEngine.Vector4.New(0.48,0.52,0.48,0.53)

        local weaponRootR = "To_unity"
        local peeTransform = self.m_owner.m_transform:Find(weaponRootR)
        self.m_peeEffectReq = CommonUtil.LoadResAsync("Assets/_Art_LastDay/Effect/Prefab/Eff_nanzhu_niaoniao.prefab",
                function(req)
                    local transform = req.gameObject.transform
                    transform:SetParent(peeTransform)
                    transform:Set_localPosition(0, 0.868, 0)
                    local quaternion = Quaternion.Euler(0, 0, 0)
                    transform:Set_localRotation(quaternion.x, quaternion.y, quaternion.z, quaternion.w)
                    transform:Set_localScale(1,1,1)
                end
        )
    end
    DataCenter.BatheManager:ToggleMosaicRenderPassFeature(true,rectangle)
end


function CharacterPeeOrStoolState:DestroyAsset()
    if self.m_peeEffectReq ~= nil then
        self.m_peeEffectReq:Destroy() --这里会回收gameobject
        self.m_peeEffectReq = nil
    end
end

function CharacterPeeOrStoolState:AddTimer()
    self:DeleteTimer()
    self.timer = TimerManager:GetInstance():GetTimer(1, self.Tick , self, false, false, false)
    self.timer:Start()
end

function CharacterPeeOrStoolState:DeleteTimer()
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

function CharacterPeeOrStoolState:Tick()
    self.batheTimer = self.batheTimer + 1
    if self.batheTimer >= self.m_totalTime then
        self.batheTimer = 0
        self:OnExit()
    end
end

function CharacterPeeOrStoolState:OnExit()
    local rectangle = CS.UnityEngine.Vector4.New(0,0,0,0)
    DataCenter.BatheManager:ToggleMosaicRenderPassFeature(false,rectangle)
    self.m_owner:ShowWeapon() --显示武器
    self:DeleteTimer()
    self:OnStateComplete()
    self:DestroyAsset()
end

function CharacterPeeOrStoolState:AllowStopByType(type)
    return CharacterStateType.Die == type
end

return CharacterPeeOrStoolState