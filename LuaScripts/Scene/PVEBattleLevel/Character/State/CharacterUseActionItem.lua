---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by qiyonghui.
--- DateTime: 2023/6/19 17:11
---CharacterUseActionItem 使用有动作的道具状态机
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
---@class CharacterUseActionItem | CharacterBaseState
local CharacterUseActionItem = BaseClass("CharacterUseActionItem",CharacterBaseState)
local CharacterStateType = require("Scene.PVEBattleLevel.Character.State.CharacterStateType")

local animType = {
    eat = 1,--吃
    water = 2,--喝
}
function CharacterUseActionItem:SetData(data)
    CharacterBaseState.SetData(self,data)
    self.selectItemData = data
end

function CharacterUseActionItem:OnEnter()
    self:PlayAnim()
end

function CharacterUseActionItem:PlayAnim()
    local totalTime = 3
    --只显示一次进度条
    local isShowUseItemPrograssBar = Setting:GetPrivateBool("isShowUseItemPrograssBar",true)
    if isShowUseItemPrograssBar then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIPrograssBar, { anim = true }, {objId = nil,totalTime = totalTime})
        Setting:SetPrivateBool("isShowUseItemPrograssBar",false)
    end
    self.delayTimer = TimerManager:GetInstance():DelayInvoke(function()
        self:OnExit()
        self.delayTimer = nil
    end,totalTime)
    self.m_owner:HideWeapon() --隐藏武器
    local goods = DataCenter.ItemTemplateManager:GetItemTemplate(self.selectItemData.itemId)
    --判断type2
    --1=吃的，吃东西动作（本期）
    --2=喝的，喝的动作，可能本期没有
    --3=药品，使用的动作，可能本期没有
    local animName = ""
    if goods.type2 == animType.eat then
        animName = "eat"
    elseif goods.type2 == animType.water then
        animName = "water"
    end
    if animName ~= "" then
        self.m_owner:PlayAnim(animName)
    end
end


function CharacterUseActionItem:OnExit()
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIPrograssBar)
    if self.delayTimer then
        self.delayTimer:Stop()
        self.delayTimer = nil
    end
    if self.m_owner then
        self.m_owner:ShowWeapon() --显示武器
    end
    self:OnStateComplete()
end

function CharacterUseActionItem:AllowStopByType(type)
    --return CharacterStateType.Die == type
    -- 使用物品 允许任何状态打断
    return true
end

return CharacterUseActionItem