---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2023/1/12 11:22
---释放技能状态，只有死亡可以打断，要不然不允许任何打断，直到技能释放结束
local CharacterStateType = require("Scene.PVEBattleLevel.Character.State.CharacterStateType")
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
local CharacterSkillState = BaseClass("CharacterSkillState",CharacterBaseState)

function CharacterSkillState:OnEnter()
    local skillId = self.m_data.skillId
    local target = self.m_data.target
    self:LookAt(target)
    self.skillCompleteHandler = function()
        self:OnSkillComplete()
    end
    self.m_owner.skillManager:AddListener(PveSkillEventId.SkillComplete,self.skillCompleteHandler)
    self.m_owner.skillManager:DoSkill(skillId,target)
end 

function CharacterSkillState:LookAt(target)
    local selfPos = self.m_owner:GetPosition()
    local offset = target:GetPosition() - selfPos
    offset.y = 0
    local lookRot = Quaternion.LookRotation(Vector3.Normalize(offset), Vector3.up)
    self.m_owner:SetRotation(lookRot)
end

function CharacterSkillState:OnSkillComplete()
    self:OnExit()
end

function CharacterSkillState:OnExit()
    self.m_owner.skillManager:DestroySkillList()
    self.m_owner.skillManager:RemoveListener(PveSkillEventId.SkillComplete,self.skillCompleteHandler)
    self.skillCompleteHandler = nil
    self:OnStateComplete()
end 

function CharacterSkillState:AllowStopByType(type)
    return CharacterStateType.Die == type
end

function CharacterSkillState:Destroy()
    if self.skillCompleteHandler ~= nil then
        self.m_owner.skillManager:RemoveListener(PveSkillEventId.SkillComplete,self.skillCompleteHandler)
        self.skillCompleteHandler = nil
    end
    CharacterBaseState.Destroy(self)
end

return CharacterSkillState