---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2023/3/21 17:39
---翻越，跨越，用于翻桌子
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
local CharacterStrideOverState = BaseClass("CharacterStrideOverState",CharacterBaseState)
local SU_Util = require("Scene.PVEBattleLevel.Utils.SU_Util")
local CharacterController = typeof(CS.UnityEngine.CharacterController)

function CharacterStrideOverState:__init(owner,type,completeHandler)
    CharacterBaseState.__init(self,owner,type,completeHandler)
    self.characterController = owner:GetTransform():GetComponent(CharacterController)
end

function CharacterStrideOverState:SetData(data)
    self.target = data
end

function CharacterStrideOverState:OnEnter()
    local angle = self.target:GetStriderOverAngle()
    if IsNull(angle) then
        Logger.LogError("CharacterStrideOverState Error: not found forward angle!!!!")
        self:OnExit()
        return
    end
    self.m_owner:PlayAnim(self.m_owner:GetStrideOverAnimName())
    self:__addEvent()
    self:LookAt(angle)
    --self:UpdateTargetPosition() --使用动画位移，这里先暂时不用了
    self.m_owner:SetApplyRootMotion(true)
    self.characterController.enabled = false --翻越的时候禁用碰撞
    self.target:HideEventPointEffect()
end

function CharacterStrideOverState:UpdateTargetPosition()
    local forward = self.m_owner:GetForward()
    local newPos = Vector3.New(forward.x,forward.y,forward.z)
    newPos = newPos:Mul(2.5)
    newPos = self.m_owner:GetPosition() + newPos
    self.targetPos = newPos
    self.playerPos = self.m_owner:GetPosition()
end

function CharacterStrideOverState:LookAt(eulerAngleY)
    local ownerPos = self.m_owner:GetPosition()
    local targetPos = self.target:GetPosition()
    local angle = SU_Util.GetAngle(targetPos,ownerPos) % 360
    local newAngle = 180 + eulerAngleY
    if angle > 90 + eulerAngleY and angle < 270 + eulerAngleY then
        newAngle = eulerAngleY
    end

    self.m_owner:SetRotation(Quaternion.Euler(0, newAngle, 0))
end

function CharacterStrideOverState:OnUpdate(deltaTime)
    --使用动画位移，这里先暂时不用了
    --self.m_owner:SetPosition(Vector3.Lerp(self.playerPos,self.targetPos,deltaTime))
end

function CharacterStrideOverState:__addEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_playEnd = function() self:__onAnimPlayEnd()  end
    end
end

function CharacterStrideOverState:__removeEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_playEnd = nil
    end
end

function CharacterStrideOverState:__onAnimPlayEnd()
    self:OnExit()
end

function CharacterStrideOverState:OnExit()
    self.characterController.enabled = true
    self.m_owner:SetApplyRootMotion(false)
    self.target:ShowEventPointEffect()
    self.target = nil
    self:__removeEvent()
    self:OnStateComplete()
end
--不允许打断
function CharacterStrideOverState:AllowStopByType(type)
    return false
end

function CharacterStrideOverState:Destroy()
    if not IsNull(self.characterController) then
        self.characterController.enabled = true
        self.characterController = nil
    end
    self.target = nil
    self.m_owner:SetApplyRootMotion(false)
    self:__removeEvent()
    CharacterBaseState.Destroy(self)
end

return CharacterStrideOverState