---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2022/9/23 18:38
---
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
local CharacterDeadState = BaseClass("CharacterDeadState",CharacterBaseState)
local Resource = CS.GameEntry.Resource
 
function CharacterDeadState:OnEnter()
    -- 播放死亡动画
    local dieAnim = self.m_owner:GetDeadAnimName()
    self.m_owner:PlayAnim(dieAnim)
    self.m_owner:EnableCollider(false) --关闭身上碰撞盒
    self.m_owner:EnableNavmeshAgent(false) --关闭身上导航代理
    self.m_owner:RemoveEffectAfterDead() -- 移除身上的特效
    --self.m_owner:HideHpBar() --隐藏头上血条
    -- 播放死亡声音
    local prefabName = self.m_owner:GetPrefabName()
    if string.contains(dieAnim,"zombie_") then
        local timeIndex = math.random(1, 4)
        local str = "Effect_pve_zombie_die0"..timeIndex
        SoundUtil.PlayEffect(str)
    end
    --SUSoundUtil.PlayActorActionSound(prefabName, 'dead')
    if (self.m_owner:GetType() == CharacterType.Zombie) then
        local zombie = self.m_owner
        if zombie ~= nil then
            zombie.battleLevel:ZombieToDeadItem(zombie)
            zombie:SetDeadState()
        end
        
        
		---- FIXME : 因为这里是个异步处理，这个时候正好切场景了会如何？？
        --TimerManager:GetInstance():DelayInvoke(
		--	function()
		--		local zombie = self.m_owner
		--		if zombie ~= nil then
		--			zombie.battleLevel:ZombieToDeadItem(zombie)
		--		end
        --end, 1.0)
        --TimerManager:GetInstance():DelayInvoke(
        --    function()
        --        local zombie = self.m_owner
        --        if zombie ~= nil then
        --            zombie:SetDeadState()
        --        end
        --    end, 0.5)
    end
end

function CharacterDeadState:ChangeCharacterState()
    if self.m_owner:GetCurBlood() > 0 then
        self:OnExit()
    end
end

function CharacterDeadState:OnExit()
    self:OnStateComplete()
end

function CharacterDeadState:IsOnly()
    return true
end

function CharacterDeadState:AllowStopByType(type)
    return false
end

function CharacterDeadState:Destroy()
    CharacterBaseState.Destroy(self)
end

return CharacterDeadState