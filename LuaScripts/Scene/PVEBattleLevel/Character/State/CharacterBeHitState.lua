---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2023/3/29 14:24
---人物被击动作
local CharacterStateType = require("Scene.PVEBattleLevel.Character.State.CharacterStateType")
local CharacterBaseState = require("Scene.PVEBattleLevel.Character.State.CharacterBaseState")
local CharacterBeHitState = BaseClass("CharacterBeHitState",CharacterBaseState)
local Const = require "Scene.PVEBattleLevel.Const"
local NavMesh = CS.UnityEngine.AI.NavMesh

function CharacterBeHitState:SetData(data)
    CharacterBaseState.SetData(self,data)

    local weaponData = data.weaponData
    for i, v in ipairs(weaponData) do
        if v.type == Const.BeHitType.Back then
            self.backDistance = v.para
        end
    end

    self.dir = data.dir
end

function CharacterBeHitState:OnEnter()
    self.m_owner:PlayAnim(self.m_owner:GetBeHitAnimName())
    --self:__addEvent()
    self.backDistance = self.backDistance or 0.5
    self:UpdateBackPosition()
    
end
--添加击退效果
function CharacterBeHitState:UpdateBackPosition()
    local forward = self.m_owner:GetForward()
    local newPos = self.dir or Vector3.New(forward.x,forward.y,forward.z)
    newPos = newPos:Mul(-self.backDistance)
    newPos = self.m_owner:GetPosition() + newPos
    self.targetPos = newPos
    self.playerPos = self.m_owner:GetPosition()
end

function CharacterBeHitState:OnUpdate(deltaTime)
    local isEnd = false
    local dstPos = Vector3.Lerp(self.playerPos,self.targetPos,10 * deltaTime)
    local ret, sampleHit = NavMesh.SamplePosition(dstPos, 0.1, NavMesh.AllAreas)
    if ret then
        --dstPos = sampleHit.position
        self.m_owner:SetPosition(dstPos)
    else
        --超出导航网格范围了，直接结束
        isEnd = true
    end
    if Vector3.Distance(self.playerPos,self.targetPos) < 0.01 or isEnd then
        self:OnExit()
    end
end

function CharacterBeHitState:__addEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_playEnd = function() self:__onAnimPlayEnd()  end
    end
end

function CharacterBeHitState:__removeEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_playEnd = nil
    end
end

function CharacterBeHitState:__onAnimPlayEnd()
    self:OnExit()
end

function CharacterBeHitState:OnExit()
    --self:__removeEvent()
    self:OnStateComplete()
end

function CharacterBeHitState:AllowStopByType(type)
    return CharacterStateType.Die == type
end

function CharacterBeHitState:Destroy()
    self:__removeEvent()
    CharacterBaseState.Destroy(self)
end

return CharacterBeHitState