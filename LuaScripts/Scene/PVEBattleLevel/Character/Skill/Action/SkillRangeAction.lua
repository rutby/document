---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1022.
--- DateTime: 2023/1/12 22:25
---范围攻击
local SkillBaseAction = require("Scene.PVEBattleLevel.Character.Skill.Action.SkillBaseAction")
local SkillRangeAction = BaseClass("SkillRangeAction",SkillBaseAction)
local SkillEnum = require("Scene.PVEBattleLevel.Character.Skill.SkillEnum")
local Resource = CS.GameEntry.Resource

function SkillRangeAction:__addEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_attackDone = function() self:__onAttackDone() end
        self.m_owner.animEvent.animation_playEnd = function() self:__onAnimPlayEnd()  end
    end
end

function SkillRangeAction:__removeEvent()
    if self.m_owner.animEvent then
        self.m_owner.animEvent.animation_attackDone = nil
        self.m_owner.animEvent.animation_playEnd = nil
    end
end

function SkillRangeAction:Start()
    self:__addEvent()
    self.m_owner:PlayAnim(self.m_template.action)
    self.m_owner:SetAnimSpeed(self.m_template.speed)
end

function SkillRangeAction:__onAttackDone()
    local rangeObj = self:CreateRangeObject()
    if rangeObj ~= nil then
        local enemyList = DataCenter.BattleLevel.RoleMgr:SearchEnemyByRangeObject(self.m_owner:GetType(),rangeObj)
        for _,enemy in ipairs(enemyList) do
            self.m_owner:AttackEnemy(enemy,self.m_template.damage)

            --播放被击特效
            if enemy.PlayBeAttackVFX ~= nil then
                enemy:PlayBeAttackVFX(self.m_template.action)
            end
        end
    end
    
    self:PlayEffect()
    
    local prefabName = self.m_owner:GetPrefabName()
    --SUSoundUtil.PlayActorActionSound(prefabName, 'attack')
end

function SkillRangeAction:__onAnimPlayEnd()
    self.m_owner:SetAnimSpeed(1)
    self:Complete()
end

function SkillRangeAction:PlayEffect()
    local effectName = self.m_template.actionEffect
    if not string.IsNullOrEmpty(effectName) then
        self.actionEffect = Resource:InstantiateAsync(string.format(SkillEnum.SkillEffectPath,effectName))
        self.actionEffect:completed("+",function()
            local gameObject = self.actionEffect.gameObject
            local transform = gameObject.transform
            local pos = self.m_owner:GetPosition()
            local forward = self.m_owner:GetForward()
            transform:Set_position(pos.x,pos.y,pos.z)
            transform:Set_forward(forward.x,forward.y,forward.z)
            
            local particles = gameObject:GetComponentsInChildren(typeof(CS.UnityEngine.ParticleSystem))
            local effect
            for i = 0, particles.Length - 1 do
                effect = particles[i]
                effect:Simulate(0)
                effect:Play()
            end
        end)
    end
end

function SkillRangeAction:ClearEffect()
    if self.actionEffect ~= nil then
        self.actionEffect:Destroy()
        self.actionEffect = nil
    end
end

function SkillRangeAction:Complete()
    self:__removeEvent()
    self:ClearEffect()
    self.m_owner:SetAnimSpeed(1)
    self.m_target = nil
    SkillBaseAction.Complete(self)
end

function SkillRangeAction:Destroy()
    self:__removeEvent()
    self:ClearEffect()
    self.m_target = nil
    SkillBaseAction.Destroy(self)
end

return SkillRangeAction