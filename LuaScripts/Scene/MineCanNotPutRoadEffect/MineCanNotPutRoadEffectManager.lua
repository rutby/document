---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/11/7 11:13
---

local effect_prefab = "Assets/_Art/Effect/prefab/scene/Build/XuanQu/VFX_qc_jzjinzhi_red.prefab"
local text_prefab = "Assets/Main/Prefabs/CityScene/MineName.prefab"
local Localization = CS.GameEntry.Localization
local MineCanNotPutRoadEffect = require "Scene.MineCanNotPutRoadEffect.MineCanNotPutRoadEffect"
local MineName = require "Scene.MineCanNotPutRoadEffect.MineName"
local MineCanNotPutRoadEffectManager = BaseClass("MineCanNotPutRoadEffectManager")
local ResourceManager = CS.GameEntry.Resource

local function __init(self)
    self.effect = {}
    self.effectRequest = {}
    self.currentShowPointIndex = -1
    self.buildId = -1
    self.names = {}
    self.nameRequest = {}

end

local function __delete(self)
    self.effect = {}
    self.effectRequest = {}
    self.names = {}
    self.nameRequest = {}

    self.currentShowPointIndex = -1
    self.buildId = -1
end

local function AddEffects(self)
    local allShowPoints = self:GetAllMinePoints()
    if table.count(self.effectRequest) == table.count(allShowPoints) then
        return
    end
    self:RemoveAllEffects()
    table.walk(allShowPoints, function (_, v)
        self:AddOneEffect(v)
    end)
    self:AddMineName()
end

local function AddMineName(self)
    local allShowPoints = self:GetMineMainPoints()
    if table.count(self.nameRequest) == table.count(allShowPoints) then
        return
    end
    self:RemoveAllNames()
end

local function RemoveAllEffects(self)
    table.walk(self.effect, function (k, v)
        v:OnDestroy()
    end)
    self.effect = {}
    table.walk(self.effectRequest, function (k, v)
        v:Destroy()
    end)
    self.effectRequest = {}
    self:RemoveAllNames()
end

local function RemoveAllNames(self)
    table.walk(self.names, function (k, v)
        v:OnDestroy()
    end)
    self.names = {}
    table.walk(self.nameRequest, function (k, v)
        v:Destroy()
    end)
    self.nameRequest = {}
end

local function GetAllMinePoints(self)
end

local function GetMineMainPoints(self)
end

local function AddOneEffect(self, pointIndex)
    if self.effect[pointIndex] ~= nil or self.effectRequest[pointIndex] ~= nil then
        return
    end
    local request = ResourceManager:InstantiateAsync(effect_prefab)
    self.effectRequest[pointIndex] = request
    request:completed('+', function()
        if request.isError then
            return
        end
        request.gameObject:SetActive(true)
        local mineEffect = MineCanNotPutRoadEffect.New()
        mineEffect:OnCreate(request)
        mineEffect:ReInit(pointIndex)
        self.effect[pointIndex] = mineEffect
    end)
end

local function AddOneName(self, pointIndex, nameStr)
    if self.names[pointIndex] ~= nil or self.nameRequest[pointIndex] ~= nil then
        return
    end
    local request = ResourceManager:InstantiateAsync(text_prefab)
    self.nameRequest[pointIndex] = request
    request:completed('+', function()
        if request.isError then
            return
        end
        request.gameObject:SetActive(true)
        local mineName = MineName.New()
        mineName:OnCreate(request)
        mineName:ReInit(pointIndex, nameStr)
        self.names[pointIndex] = mineName
    end)
end

MineCanNotPutRoadEffectManager.__init = __init
MineCanNotPutRoadEffectManager.__delete = __delete
MineCanNotPutRoadEffectManager.AddEffects = AddEffects
MineCanNotPutRoadEffectManager.RemoveAllEffects = RemoveAllEffects
MineCanNotPutRoadEffectManager.GetAllMinePoints = GetAllMinePoints
MineCanNotPutRoadEffectManager.AddOneEffect = AddOneEffect
MineCanNotPutRoadEffectManager.AddMineName = AddMineName
MineCanNotPutRoadEffectManager.RemoveAllNames = RemoveAllNames
MineCanNotPutRoadEffectManager.AddOneName = AddOneName
MineCanNotPutRoadEffectManager.GetMineMainPoints = GetMineMainPoints

return MineCanNotPutRoadEffectManager