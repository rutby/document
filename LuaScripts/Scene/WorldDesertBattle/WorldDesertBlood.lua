---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/1/4 15:01
---
local WorldDesertBlood = BaseClass("WorldDesertBlood")
local hp_spr_path = "Transform/back/hp"
local hp_red_spr_path ="Transform/back/hp/hpRed"
local blood_num_path = "Transform/back/hp/bloodNum"
local attack_name_path = "Transform/back/monsterNameBg/monsterName"
local icon_path = "Transform/back/monsterNameBg/icon"
local monsterBg = "Transform/back/monsterNameBg"
local ResourceManager = CS.GameEntry.Resource
local Localization = CS.GameEntry.Localization
--创建
local function OnCreate(self,go)
    if go ~= nil then
        self.request = go
        self.gameObject = go.gameObject
        self.transform = go.gameObject.transform
    end
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:RemoveTimer()
    self:SetHP(1,1)
    self:ComponentDestroy()
end

local function ComponentDefine(self)
    self.hp_spr = self.transform:Find(hp_spr_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.hp_spr_red = self.transform:Find(hp_red_spr_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.icon = self.transform:Find(icon_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.attack_name = self.transform:Find(attack_name_path):GetComponent(typeof(CS.SuperTextMesh))
    self.blood_num = self.transform:Find(blood_num_path):GetComponent(typeof(CS.SuperTextMesh))
    self.cacheHpImg = ""
    self.startBloodPercent = 0
    self.endBloodPercent = 0
    self.isDoAnim = false
    self.checkTime = 0
    self.__update_handle = function() self:Update() end
    UpdateManager:GetInstance():AddUpdate(self.__update_handle)
end

local function ComponentDestroy(self)
    self.hp_spr = nil
    self.icon = nil
    self.attack_name = nil
    self.blood_num = nil
    self.cacheHpImg = nil
    self.cacheBloodPercent =nil
end

local function RemoveTimer(self)
    UpdateManager:GetInstance():RemoveUpdate(self.__update_handle)
    self.__update_handle = nil
end



local function ShowBloodInfo(self,pointIndex,initHealth,curHealth)
    self.checkTime = 0
    local desertId = 0
    self.pointId = pointIndex
    local posV3 = SceneUtils.TileIndexToWorld(self.pointId,ForceChangeScene.World)
    self.transform.position = posV3
    local name = Localization:GetString("110245")
    local worldTileInfo = CS.SceneManager.World:GetWorldTileInfo(self.pointId)
    if worldTileInfo~=nil then
        local desertInfo = worldTileInfo:GetWorldDesertInfo()
        if desertInfo~=nil then
            desertId = desertInfo.desertId
        end
    end
    if desertId == 0 then
        local zoneId = CS.SceneManager.World:GetZoneIdByPosId(self.pointId-1)
        local id = DataCenter.WorldDesertRefreshTemplateManager:GetEmptyDesertIdByCityId(zoneId)
        if id~=nil then
            desertId = id
        end

    end

    if desertId~=0 then
        local level = GetTableData(TableName.Desert, desertId, "desert_level")
        local nameStr = GetTableData(TableName.Desert, desertId, "desert_name")
        if level>0 then
            name = "Lv."..level.." "..Localization:GetString(nameStr)
        end
    end
    self.attack_name.text = name
    self:SetHP(curHealth,initHealth)
end



local function SetHP(self,hp,maxhp)
    if IsNull(self.gameObject) then
        return
    end
    if hp>1 then
        self.blood_num.text = hp
    else
        self.blood_num.text = ""
    end
    local percent =  hp/math.max(maxhp,1)
    if percent<=0 then
        percent = 0
    elseif percent>=1 then
        percent = 1
    end
    self.curTime =0
    self.startBloodPercent = self.endBloodPercent
    self.endBloodPercent = percent
    if self.startBloodPercent~=0 then
        self.hp_spr_red.size = Vector2.New((self.startBloodPercent*1.39),0.17)
        self.deltaPro = self.endBloodPercent - self.startBloodPercent
        self.isDoAnim = true
        self:Update()
    end
    local spr = ""
    if percent<0.3 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_red.png"
    elseif percent>=0.3 and percent<0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_yellow.png"
    elseif percent>=0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_monster_green.png"
    end
    if self.cacheHpImg~=spr then
        self.hp_spr:LoadSprite(spr)
        self.cacheHpImg =spr
    end
    self.hp_spr.size = Vector2.New((percent*1.39),0.17)
end

local function Update(self)
    if self.isDoAnim then
        self.checkTime = 0
        self.curTime = self.curTime+Time.deltaTime
        if self.curTime > 0.3 then
            if IsNull(self.gameObject) ==false then
                self.hp_spr_red.size = Vector2.New((self.endBloodPercent*1.39),0.17)
            end
            self.isDoAnim = false
        else
            local changePro = (self.curTime/0.3)
            local curPro = self.startBloodPercent + (changePro*self.deltaPro)
            if curPro<0 then
                curPro =0
            elseif curPro>=1 then
                curPro = 1
            end
            if IsNull(self.gameObject) ==false then
                self.hp_spr_red.size = Vector2.New((curPro*1.39),0.17)
            end
        end
    end
    if self.checkTime~=nil then
        self.checkTime = self.checkTime +Time.deltaTime
        if self.checkTime>=2 then
            self.checkTime =0
            WorldDesertBattleManager:GetInstance():RemoveOneEffect(self.pointId)
        end
    end
end

WorldDesertBlood.OnCreate = OnCreate
WorldDesertBlood.OnDestroy = OnDestroy
WorldDesertBlood.ComponentDefine = ComponentDefine
WorldDesertBlood.ComponentDestroy = ComponentDestroy
WorldDesertBlood.SetHP = SetHP
WorldDesertBlood.ShowBloodInfo=ShowBloodInfo
WorldDesertBlood.Update =Update
WorldDesertBlood.RemoveTimer = RemoveTimer
return WorldDesertBlood