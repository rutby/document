---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/1/4 15:01
---
local WorldDesertHeadUI = BaseClass("WorldDesertHeadUI")
local hp_spr_path = "Transform/back/hp"
local hp_red_spr_path ="Transform/back/hpRed"
local hero_head_bg_path ="Transform/back/hero_head_bg"
local player_name_path = "Transform/NameBg/playerName"
local city_name_path = "Transform/NameBg/cityName"
local hero_head_icon_path = "Transform/back/hero_head_icon"
local ResourceManager = CS.GameEntry.Resource
local Localization = CS.GameEntry.Localization
--创建
local function OnCreate(self,go)
    if go ~= nil then
        self.request = go
        self.gameObject = go.gameObject
        self.transform = go.gameObject.transform
    end
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetHP(1,1)
    self:ComponentDestroy()
end


local function ComponentDefine(self)
    self.hp_spr = self.transform:Find(hp_spr_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.hp_slider = self.transform:Find(hp_spr_path):GetComponent(typeof(CS.SceneSpriteSlider))
    self.hp_red_slider = self.transform:Find(hp_red_spr_path):GetComponent(typeof(CS.SceneSpriteSlider))
    self.hero_head_bg = self.transform:Find(hero_head_bg_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.hero_head_icon = self.transform:Find(hero_head_icon_path):GetComponent(typeof(CS.UnityEngine.SpriteRenderer))
    self.player_name = self.transform:Find(player_name_path):GetComponent(typeof(CS.SuperTextMesh))
    self.city_name = self.transform:Find(city_name_path):GetComponent(typeof(CS.SuperTextMesh))
    self.cacheHpImg = ""
    self.startBloodPercent = 0
    self.endBloodPercent = 0
end

local function ComponentDestroy(self)
    self.hp_spr = nil
    self.hp_slider = nil
    self.hp_red_slider = nil
    self.icon = nil
    self.player_name = nil
    self.city_name = nil
    self.cacheHpImg = nil
    self.startBloodPercent = nil
    self.endBloodPercent = nil
    self.hero_head_bg = nil
end

local function InitInfo(self,pointIndex,initHealth,curHealth,marchUuid)
    if IsNull(self.gameObject) then
        return
    end
    self.pointId= pointIndex
    local posV3 = SceneUtils.TileIndexToWorld(self.pointId,ForceChangeScene.World)
    self.transform.position = posV3
    self.hero_head_bg.gameObject:SetActive(true)
    self.hero_head_icon.gameObject:SetActive(true)
    self.player_name.text = ""
    self.city_name.text = ""
    local info = DataCenter.WorldMarchDataManager:GetMarch(marchUuid)
    if info~=nil then
        if info.allianceAbbr~=nil and info.allianceAbbr~="" then
            self.player_name.text = "["..info.allianceAbbr.."]"..info.ownerName
        else
            self.player_name.text = info.ownerName
        end
        local armyInfo = info:GetFirstArmyInfo()
        if armyInfo~=nil and armyInfo.HeroInfos~=nil then
            local heroData = armyInfo.HeroInfos[1]
            if heroData~=nil then
                local rarity = tonumber(GetTableData(HeroUtils.GetHeroXmlName(), heroData.heroId, "rarity"))
                local isReachMax = heroData:GetIsAllSKillReachMax()
                if isReachMax~=nil and isReachMax == true then
                    if rarity ~= HeroUtils.RarityType.S then
                        isReachMax = false
                    end
                else
                    isReachMax = false
                end
                self.hero_head_bg:LoadSprite(HeroUtils.GetCircleQualityIconPath(rarity,isReachMax))
                local icon = HeroUtils.GetHeroIconRoundPath(heroData.heroId)
                self.hero_head_icon:LoadSprite(icon)
            end
        end
    end
    local desertId = 0
    local name = Localization:GetString("110245")
    local worldTileInfo = CS.SceneManager.World:GetWorldTileInfo(self.pointId)
    if worldTileInfo~=nil then
        local desertInfo = worldTileInfo:GetWorldDesertInfo()
        if desertInfo~=nil then
            desertId = desertInfo.desertId
        end
    end
    if desertId == 0 then
        local zoneId = CS.SceneManager.World:GetZoneIdByPosId(self.pointId-1)
        local id = DataCenter.WorldDesertRefreshTemplateManager:GetEmptyDesertIdByCityId(zoneId)
        if id~=nil then
            desertId = id
        end
        
    end
    
    if desertId~=0 then
        local level = GetTableData(TableName.Desert, desertId, "desert_level")
        local nameStr = GetTableData(TableName.Desert, desertId, "desert_name")
        if level>0 then
            name = "Lv."..level.." "..Localization:GetString(nameStr)
        end
    end
    
    self.city_name.text = name
    self:SetHP(curHealth,initHealth)
end

local function SetHP(self,hp,maxhp)
    if IsNull(self.gameObject) then
        return
    end
    self.hp_red_slider:Init(math.max(maxhp,1),self.cacheBloodHp)
    local percent =  hp/math.max(maxhp,1)
    local spr = ""
    if percent<0.3 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_player_red.png"
    elseif percent>=0.3 and percent<0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_player_yellow.png"
    elseif percent>=0.7 then
        spr ="Assets/Main/Sprites/UI/UIWorldBattle/UIWorldBattle_pro_player_green.png"
    end
    if self.cacheHpImg~=spr then
        self.hp_spr:LoadSprite(spr)
        self.cacheHpImg =spr
    end
    self.cacheBloodHp = hp
    self.hp_slider:Init(math.max(maxhp,1),hp)
end


WorldDesertHeadUI.OnCreate = OnCreate
WorldDesertHeadUI.OnDestroy = OnDestroy
WorldDesertHeadUI.ComponentDefine = ComponentDefine
WorldDesertHeadUI.ComponentDestroy = ComponentDestroy
WorldDesertHeadUI.InitInfo = InitInfo
WorldDesertHeadUI.SetHP = SetHP
return WorldDesertHeadUI