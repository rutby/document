---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wsf.
--- DateTime: 2024/1/19 5:20 PM
--- 护盾buff
---

local base = require("Scene.LWBattle.Buff.BuffBase")
---@class Scene.LWBattle.Buff.BuffShield : Scene.LWBattle.Buff.BuffBase
local BuffShield = BaseClass("BuffShield", base)

function BuffShield:__init(logic, mgr, unit, meta, id, caster)
    self.logic = logic
    self.caster = caster
    self.subType = self.meta.sub_type
    self.shieldValue = 0
end

function BuffShield:__delete()
    self:Destroy()
end

function BuffShield:Destroy()
    base.Destroy(self)
    self.caster = nil
    self.shieldValue = 0
end

function BuffShield:OnUpdate()
    base.OnUpdate(self)

    if self.shieldValue <= 0 then
        self:End()
    end
end

function BuffShield:OnStart()
    local para = self.meta.para
    if self.subType == BuffSubType.ShieldFromValue then
        if para then
            self.shieldValue = para
        end
    elseif self.subType == BuffSubType.ShieldFromCasterHp then
        --if para then
        --    for i, v in pairs(para) do
        --        local value = self.unit:GetProperty(i) * v
        --        self.shieldValue = self.shieldValue + value
        --    end
        if self.caster then
            if para and self.caster.maxBlood then
                self.shieldValue = self.caster.maxBlood * para
            end
        else
            Logger.LogError("BuffShield OnStart caster is nil. metaId : ".. self.meta.id)
        end
    end
    --elseif self.subType == BuffSubType.ShieldFromCasterProperty then
    --    if self.caster then
    --        if para then
    --            for i, v in pairs(para) do
    --                local value = self.caster:GetProperty(i) * v
    --                self.shieldValue = self.shieldValue + value
    --            end
    --        end
    --    else
    --        Logger.LogError("BuffShield OnStart caster is nil. metaId : ".. self.meta.id)
    --    end
    --end

    self.mgr:RegisterShieldBuff(self)
end

function BuffShield:OnEnd()
    self.shieldValue = 0
    
    self.mgr:UnregisterShieldBuff(self)
end

---@return number 获取当前buff带来的护盾值
function BuffShield:GetShieldValue()
    return self.shieldValue
end


---@return number 护盾吸收后的剩余伤害值
function BuffShield:ReduceShieldValue(hurt)
    if hurt <= self.shieldValue then
        self.shieldValue = self.shieldValue - hurt
        return 0
    end
    
    local remain = hurt - self.shieldValue
    self.shieldValue = 0
    return remain
    
end

function BuffShield:ReduceAll()
    self.shieldValue = 0
end

return BuffShield