---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wsf.
--- DateTime: 2023/11/14 7:29 PM
--- 开火状态 跑酷塔防模式 寻找技能范围内的敌人
local FORWARD=Vector3.New(0,0,25)

local FireStateDefenseStraight = BaseClass("FireStateDefenseStraight")
function FireStateDefenseStraight:__init(unit)
    self.unit = unit---@type Scene.LWBattle.BarrageBattle.Unit.Member
end

function FireStateDefenseStraight:__delete()
    self.unit = nil
end

function FireStateDefenseStraight:OnEnter()
    if self.unit:IsMoving() then
        self.unit:PlaySimpleAnim(AnimName.Run)
    else
        self.unit:PlaySimpleAnim(AnimName.Idle)
    end
end

function FireStateDefenseStraight:OnExit()
    self.unit.skillManager:Interrupt()
end

function FireStateDefenseStraight:OnUpdate()
    if self.unit.skillManager:GetCastingSkill() then    --施法阶段
        return
    end
    local skill=self.unit.skillManager:GetActiveSkill()
    if skill then
        if skill:IsBuffSkill() then
            --buff型技能，不用瞄准、目标是个table
            self.unit.skillManager:ActiveCast(skill,skill:SearchTarget())

            if self.unit.unitType and self.unit.unitType == UnitType.TacticalWeapon then
                EventManager:GetInstance():Broadcast(EventId.OnPVETacticalWeaponCastSkill, skill)
            end
        else
            local target = self:GetTarget(skill)
            if target then
                self.unit.skillManager:ActiveCast(skill,target)

                if self.unit.unitType and self.unit.unitType == UnitType.TacticalWeapon then
                    EventManager:GetInstance():Broadcast(EventId.OnPVETacticalWeaponCastSkill, skill)
                end
            end
        end
    else
        if self.unit:IsMoving() then
            self.unit:CrossFadeSimpleAnim(AnimName.Run,1,0.2)
        else
            self.unit:CrossFadeSimpleAnim(AnimName.Idle,1,0.2)
        end
    end
end

--获取目标：如果被嘲讽且普攻，则目标是嘲讽目标；否则正常索敌
function FireStateDefenseStraight:GetTarget(skill)
    if skill:IsNormalAttack() then
        local tauntTarget = self.unit:GetTauntTarget()
        if tauntTarget then
            return tauntTarget
        end
    end
    local ret = skill:SearchTarget()
    return ret
end

return FireStateDefenseStraight
