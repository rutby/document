---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wsf.
--- DateTime: 2023/11/14 2:42 PM
--- 塔防模式怪物跑过来状态
---
local Const = require("Scene.LWBattle.Const")
---@class Scene.LWBattle.ParkourBattle.Monster.MonsterImpl.FSM.CommonAI.DefenseRunState 
local DefenseRunState = BaseClass("DefenseRunState")
local ZombieCommonAI = require "Scene.LWBattle.AI.ZombieCommonAI"
local CHECK_TARGET_IN_RANGE_CD = 0.5--检查目标是否在射程内cd

function DefenseRunState:__init(unit)
    self.unit = unit

    self.checkTargetInRangeCd=0
    self.ai=ZombieCommonAI.New(self.unit)---@type Scene.LWBattle.AI.ZombieCommonAI
    self.hasAlerted = false
end

function DefenseRunState:__delete()
    self.unit = nil
    if self.timer then
        self.timer:Stop()
        self.timer=nil
    end

end

function DefenseRunState:OnEnter()
    --self.zombie:RemoveDestination()
    local pos = self.unit:GetPosition()
    self.unit.agent:SetCurPosition(pos.x,pos.z)
    self.unit:PlaySimpleAnim(ZombieAnim.Run,1)
    local curPos = self.unit:GetPosition()
    if not self.hasAlerted then
        -- alert 过就不往下走了，避免掏屁股
        local posZ = self.unit.logic.team:GetPositionZ()
        self.unit:SetDestination(curPos.x, posZ)
    end

    if (not self.unit.IsImprisoning) or (not self.unit:IsImprisoning()) then
        self.unit.agent.speed = self.unit.logic:GetMoveSpeedZ()
    end

    self.checkTargetInRangeCd=0
    self.idleCd = 0
end
function DefenseRunState:OnExit()

end

function DefenseRunState:OnUpdate()

    if self.checkTargetInRangeCd<=0 then
        self.checkTargetInRangeCd=CHECK_TARGET_IN_RANGE_CD
        if self:CheckTargetInSight() then
            return
        end
    else
        self.checkTargetInRangeCd = self.checkTargetInRangeCd - Time.deltaTime
    end

end

function DefenseRunState:CheckTargetInSight()
    if not self.unit.isAlert then
        self.unit.isAlert = self.unit:CheckEnemyInAlertRange()
    end
    if self.unit.isAlert then
        self.hasAlerted = true
        local nextSkill=self.unit.skillManager:GetActiveSkillIgnoreRange()
        if nextSkill then
            local target = self.ai:GetTarget(nextSkill)
            local inRange=nextSkill:IsTargetInRange(target)
            if inRange then
                if nextSkill:IsBuffSkill() then --buff型技能，target是unit table
                    if #target > 0 then
                        local targetPos = target[1]:GetPosition()
                        self.unit:SetDestination(targetPos.x,targetPos.z)
                        self.unit.transform:LookAt(targetPos)
                    end
                else --子弹型技能，target是unit
                    if target.GetPosition then
                        local targetPos = target:GetPosition()
                        self.unit:SetDestination(targetPos.x,targetPos.z)
                        self.unit.transform:LookAt(targetPos)
                    end
                end
                self.unit.fsm:ChangeState(ZombieState.Attack,nextSkill,target)
            elseif target then
                self.unit.fsm:ChangeState(ZombieState.Run)
            else
                self.unit.fsm:ChangeState(ZombieState.Run)
            end
        end
    end
    return self.unit.isAlert
end


return DefenseRunState
