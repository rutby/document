---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 3/29/22 11:15 AM
---
--[[
    增加护盾  {0}发动了{1}！{2}获得了一个护盾效果
]]
local base = require "Scene.BattlePveModule.SkillModule.Skill.SkillBase"
local Skill_Shield = BaseClass("Skill_Shield", base)
local Const= require "Scene.BattlePveModule.Const"

function Skill_Shield:DoAttack( actionItem, callback ,maxTime)
    base.DoAttack(self, actionItem, callback)
    -- 普攻的展示为 发起发做攻击处理, 受击方做受击处理
    local _atkIdx = actionItem:GetTriggerIndex()
    local _atkCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_atkIdx)
    local _atkModelObj = PveActorMgr:GetInstance():GetModelMgr():GetModelObjByHeroId(_atkCampType, actionItem:GetHeroId())
    local _defIdx = actionItem:GetTargetIndex()
    local _defCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_defIdx)
    if (_atkModelObj == nil ) then
        -- 这个时候表示没有找到实体.直接进行下一步
        self:DoCallback()
        return
    end
    if (PveActorMgr:GetInstance():IsStopPlay()) then
        self:DoCallback()
        return
    end
    
    -- 有些英雄在起初攻击的时候会有前摇,看英雄来处理
    --_atkModelObj:BeginAttack()
    
    --local str = "增加护盾"
    local time = 1
    if actionItem._actionData~=nil and actionItem._actionData["param"]~=nil then
        time = actionItem._actionData["param"]
    end
    local _modelMgr = PveActorMgr:GetInstance():GetModelMgr()
    local _targetModelList = _defCampType == Const.CampType.Player and _modelMgr:GetModelListByCamp(Const.CampType.Player) or _modelMgr:GetModelListByCamp(Const.CampType.Target)
    local heroId = actionItem:GetHeroId()
    local skillId = actionItem._actionData["skillId"] or 0
    local rarity = GetTableData(HeroUtils.GetHeroXmlName(),tonumber(heroId), "rarity")
    local effectName = GetTableData(TableName.SkillTab, skillId, "skill_anim")
    local delayFinishTime = 2
    if maxTime~=nil then
        delayFinishTime = maxTime
    end
    if LuaEntry.DataConfig:CheckSwitch("s_skill") and rarity == 1 then
        if effectName~=nil and effectName~="" then
            PveActorMgr:GetInstance():ShowSHeroLevelSkill(heroId,skillId,_atkCampType == Const.CampType.Target)
            TimerManager:GetInstance():DelayInvoke(function()
                -- 执行回调
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        --modelObj:FlyText(str)
                        modelObj:ShowShield(time)
                    end
                end

                -- 执行回调
                self:DoCallback()
            end, 4* PveActorMgr:GetInstance():GetSpeed())
        else
            TimerManager:GetInstance():DelayInvoke(function()
                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        --modelObj:FlyText(str)
                        modelObj:ShowShield(time)
                    end
                end

                -- 执行回调
                self:DoCallback()
            end, 2* PveActorMgr:GetInstance():GetSpeed())
            TimerManager:GetInstance():DelayInvoke(function()
                -- 执行回调
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
            end,delayFinishTime*PveActorMgr:GetInstance():GetSpeed())
        end

    else
        for _, modelObj in pairs(_targetModelList) do
            if (not modelObj:IsDead()) then
                --modelObj:FlyText(str)
                modelObj:ShowShield(time)
            end
        end

        -- 执行回调
        self:DoCallback()
    end
    
end

return Skill_Shield