---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 3/29/22 11:15 AM
---
local base = require "Scene.BattlePveModule.SkillModule.Skill.SkillBase"
local Skill_ShieldAttack = BaseClass("Skill_ShieldAttack", base)
local Const= require "Scene.BattlePveModule.Const"

--[[
    攻击护盾  {0}对{1}发动了普通攻击，{1}损失了{2}护盾值  
]]
function Skill_ShieldAttack:DoAttack( actionItem, callback ,maxTime)
    base.DoAttack(self, actionItem, callback)
    -- 普攻的展示为 发起发做攻击处理, 受击方做受击处理
    local _atkIdx = actionItem:GetTriggerIndex()
    local _atkCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_atkIdx)
    local _atkModelObj = PveActorMgr:GetInstance():GetModelMgr():GetModelObjByHeroId(_atkCampType, actionItem:GetHeroId())
    local _defIdx = actionItem:GetTargetIndex()
    local _defCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_defIdx)
    if (_atkModelObj == nil ) then
        -- 这个时候表示没有找到实体.直接进行下一步
        self:DoCallback()
        return
    end

    -- 有些英雄在起初攻击的时候会有前摇,看英雄来处理
    --_atkModelObj:BeginAttack()
    if (PveActorMgr:GetInstance():IsStopPlay()) then
        self:DoCallback()
        return
    end
    local value = "护盾 -" .. tostring(actionItem:GetActionValue())
    local _modelMgr = PveActorMgr:GetInstance():GetModelMgr()
    local _targetModelList = _defCampType == Const.CampType.Player and _modelMgr:GetModelListByCamp(Const.CampType.Player) or _modelMgr:GetModelListByCamp(Const.CampType.Target)
    local heroId = actionItem:GetHeroId()
    local skillId = actionItem._actionData["skillId"] or 0
    local rarity = GetTableData(HeroUtils.GetHeroXmlName(),tonumber(heroId), "rarity")
    local effectName = GetTableData(TableName.SkillTab, skillId, "skill_anim")
    local delayFinishTime = 2
    if maxTime~=nil then
        delayFinishTime = maxTime
    end
    if LuaEntry.DataConfig:CheckSwitch("s_skill") and rarity == 1 then
        if effectName~=nil and effectName~="" then
            PveActorMgr:GetInstance():ShowSHeroLevelSkill(heroId,skillId,_atkCampType == Const.CampType.Target)
            TimerManager:GetInstance():DelayInvoke(function()
                -- 执行回调
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
                -- 对方受击

                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        modelObj:FlyText(value)
                        modelObj:PlayEffectUpgrade()
                    end
                end

                -- 执行回调
                self:DoCallback()
            end, 4* PveActorMgr:GetInstance():GetSpeed())
        else
            TimerManager:GetInstance():DelayInvoke(function()
                -- 对方受击
                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        modelObj:FlyText(value)
                        modelObj:PlayEffectUpgrade()
                    end
                end

                -- 执行回调
                self:DoCallback()
            end, 2* PveActorMgr:GetInstance():GetSpeed())
            TimerManager:GetInstance():DelayInvoke(function()
                -- 执行回调
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
            end,delayFinishTime*PveActorMgr:GetInstance():GetSpeed())
        end

    else
        -- 对方受击

        for _, modelObj in pairs(_targetModelList) do
            if (not modelObj:IsDead()) then
                modelObj:FlyText(value)
                modelObj:PlayEffectUpgrade()
            end
        end

        -- 执行回调
        self:DoCallback()
    end
    
end

return Skill_ShieldAttack