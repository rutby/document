---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 3/29/22 12:28 PM
---
--[[
    添加怒气,这个情况下我们不做人物起手动作,只是在发起者模型上飘个字描述下
]]
local base = require "Scene.BattlePveModule.SkillModule.Skill.SkillBase"
local Skill_AddAnger = BaseClass("Skill_AddAnger", base)
local Const= require "Scene.BattlePveModule.Const"
local Localization = CS.GameEntry.Localization
--[[
    增加怒气  {0}获得了{1}怒气
]]

function Skill_AddAnger:DoAttack( actionItem, callback ,maxTime)
    base.DoAttack(self, actionItem, callback)
    local _atkIdx = actionItem:GetTriggerIndex()
    local _atkCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_atkIdx)
    local _atkModelObj = PveActorMgr:GetInstance():GetModelMgr():GetModelObjByHeroId(_atkCampType, actionItem:GetHeroId())
    local _defIdx = actionItem:GetTargetIndex()
    local _defCampType = PveActorMgr:GetInstance():GetCampTypeByTriggerIndex(_defIdx)
    if (_atkModelObj == nil) then
        -- 这个时候表示没有找到实体.直接进行下一步
        self:DoCallback()
        return
    end
    if (PveActorMgr:GetInstance():IsStopPlay()) then
        self:DoCallback()
        return
    end
    local value = Localization:GetString("400020").."+" .. tostring(actionItem:GetActionValue())
    -- 有些英雄在起初攻击的时候会有前摇,看英雄来处理
    local _modelMgr = PveActorMgr:GetInstance():GetModelMgr()
    local _targetModelList = _defCampType == Const.CampType.Player and _modelMgr:GetModelListByCamp(Const.CampType.Player) or _modelMgr:GetModelListByCamp(Const.CampType.Target)
    local heroId = actionItem:GetHeroId()
    local skillId = actionItem._actionData["skillId"] or 0
    local rarity = GetTableData(HeroUtils.GetHeroXmlName(),tonumber(heroId), "rarity")
    local effectName = GetTableData(TableName.SkillTab, skillId, "skill_anim")
    local delayFinishTime = 2
    if maxTime~=nil then
        delayFinishTime = maxTime
    end
    if LuaEntry.DataConfig:CheckSwitch("s_skill") and rarity == 1 then
        if effectName~=nil and effectName~="" then
            PveActorMgr:GetInstance():ShowSHeroLevelSkill(heroId,skillId,_atkCampType == Const.CampType.Target)
            TimerManager:GetInstance():DelayInvoke(function()
                -- 执行回调
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        modelObj:FlyText(value)
                        modelObj:PlayEffectUpgrade()
                    end
                end
                -- 执行回调
                self:DoCallback()
            end, 4* PveActorMgr:GetInstance():GetSpeed())
        else
            TimerManager:GetInstance():DelayInvoke(function()
                for _, modelObj in pairs(_targetModelList) do
                    if (not modelObj:IsDead()) then
                        modelObj:FlyText(value)
                        modelObj:PlayEffectUpgrade()
                    end
                end
            end, 2*PveActorMgr:GetInstance():GetSpeed())
            TimerManager:GetInstance():DelayInvoke(function()
                PveActorMgr:GetInstance():HideSHeroLevelSkill()
                -- 执行回调
                self:DoCallback()
            end,delayFinishTime*PveActorMgr:GetInstance():GetSpeed())
        end
    else
        for _, modelObj in pairs(_targetModelList) do
            if (not modelObj:IsDead()) then
                modelObj:FlyText(value)
                modelObj:PlayEffectUpgrade()
            end
        end
        -- 执行回调
        self:DoCallback()
    end
end

return Skill_AddAnger