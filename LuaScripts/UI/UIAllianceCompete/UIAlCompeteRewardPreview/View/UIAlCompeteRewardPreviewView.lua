---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/8/23 22:01
---

local UIAlCompeteRewardPreviewView = BaseClass("UIAlCompeteRewardPreviewView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local AllianceCompetePerReward = require "UI.UIAllianceCompete.UIAllianceCompeteReward.Component.AllianceCompetePerReward"

local title_path = "UICommonMidPopUpTitle/bg_mid/titleText"
local content_path = "ScrollView/Viewport/Content"
local closeBtn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
local dailyReward_path = "ScrollView/Viewport/Content/DailyRewards"
local weeklyReward_path = "ScrollView/Viewport/Content/WeeklyRewards"
local maskBtn_path = "UICommonMidPopUpTitle/panel"


local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()

    self:ShowRewards()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()  
        self.ctrl:CloseSelf()
    end)
    self.maskBtnN = self:AddComponent(UIButton, maskBtn_path)
    self.maskBtnN:SetOnClick(function()  
        self.ctrl:CloseSelf()
    end)
    self.titleTxtN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.contentN = self:AddComponent(UIBaseContainer, content_path)
    self.dailyRewardsN = self:AddComponent(AllianceCompetePerReward, dailyReward_path)
    self.weeklyRewardsN = self:AddComponent(AllianceCompetePerReward, weeklyReward_path)
end

local function ComponentDestroy(self)
    self.closeBtnN = nil
    self.titleTxtN = nil
    self.contentN = nil
end

local function DataDefine(self)
    self.dayRewards = nil
    self.weekRewards = nil
end

local function DataDestroy(self)
    self.dayRewards = nil
    self.weekRewards = nil
end

local function OnAddListener(self)
    self:AddUIListener(EventId.AllianceCompeteRewardsReposition, self.RepositionAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.AllianceCompeteRewardsReposition, self.RepositionAll)
end


local function ShowRewards(self)
    self.actInfo = DataCenter.ActivityListDataManager:GetActivityDataById(EnumActivity.AllianceCompete.ActId)
    if self.actInfo == nil then
        return
    end

    self.titleTxtN:SetLocalText(130065)

    self.dayRewards = {}
    self.weekRewards = {}
    if self.actInfo.reward_goods then
        local strRewards = string.split(self.actInfo.reward_goods, "^")
        for index, strRewards in ipairs(strRewards) do
            local rewardsList = {}
            local tempRewardList = string.split(strRewards, "|")
            for i, v in ipairs(tempRewardList) do
                local newReward = {}
                local param = string.split(v, ";")
                if #param == 1 then
                    newReward.type = tonumber(param[1])
                    newReward.value = 1
                else
                    newReward.type = tonumber(param[2])
                    newReward.value = {
                        id = param[1],
                        num = 1,
                    }
                end
                table.insert(rewardsList, newReward)
            end
            if index == 1 then
                self.dayRewards = rewardsList
            elseif index == 2 then
                self.weekRewards = rewardsList
            end
        end
    end
    
    self:ShowDailyRewards()
    self:ShowWeeklyRewards()
    self:RepositionAll()
end

local function ShowDailyRewards(self)
    local strTip = Localization:GetString("372154", 0)
    self.dailyRewardsN:ShowRewards(Localization:GetString("372162"), strTip, self.dayRewards, true)
end

local function ShowWeeklyRewards(self)
    local strTip = Localization:GetString("372155", 0)
    self.weeklyRewardsN:ShowRewards(Localization:GetString("361053"), strTip, self.weekRewards, true)
end

local function RepositionAll(self)
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.contentN.rectTransform)
end


UIAlCompeteRewardPreviewView.OnCreate = OnCreate
UIAlCompeteRewardPreviewView.OnDestroy = OnDestroy
UIAlCompeteRewardPreviewView.OnEnable = OnEnable
UIAlCompeteRewardPreviewView.OnDisable = OnDisable
UIAlCompeteRewardPreviewView.ComponentDefine = ComponentDefine
UIAlCompeteRewardPreviewView.ComponentDestroy = ComponentDestroy
UIAlCompeteRewardPreviewView.DataDefine = DataDefine
UIAlCompeteRewardPreviewView.DataDestroy = DataDestroy
UIAlCompeteRewardPreviewView.OnAddListener = OnAddListener
UIAlCompeteRewardPreviewView.OnRemoveListener = OnRemoveListener

UIAlCompeteRewardPreviewView.ShowRewards = ShowRewards
UIAlCompeteRewardPreviewView.ShowDailyRewards = ShowDailyRewards
UIAlCompeteRewardPreviewView.ShowWeeklyRewards = ShowWeeklyRewards
UIAlCompeteRewardPreviewView.RepositionAll = RepositionAll

return UIAlCompeteRewardPreviewView