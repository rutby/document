---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/2 20:22
---
local RankListItem = require "UI.UIRank.UIRankDetailList.Component.RankListItem"
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"
local UIHeroPluginUpgradePluginIcon = require "UI.UIHeroPluginUpgrade.Component.UIHeroPluginUpgradePluginIcon"
local UIRankDetailListView = BaseClass("UIRankDetailListView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization

local txt_title_path ="UICommonFullTop/imgTitle/Common_img_title/titleText"
local close_btn_path = "UICommonFullTop/CloseBtn"
local closeAll_btn_path = "UICommonFullTop/imgTitle/CloseAllBtn"
local name_des_path = "UICommonFullTop/Bg2/select/nameDes"
local power_des_path = "UICommonFullTop/Bg2/select/powerDes"
local power2_des_path = "UICommonFullTop/Bg2/select/power2Des"
local country_path = "UICommonFullTop/Bg2/select/country"

local player_flag_path = "UICommonFullTop/Bg2/selfObj/playerFlag"
local player_icon_path = "UICommonFullTop/Bg2/selfObj/playerFlag/UIPlayerHead/HeadIcon"
local playerIconFg_path = "UICommonFullTop/Bg2/selfObj/playerFlag/UIPlayerHead/Foreground"
local alliance_flag_path ="UICommonFullTop/Bg2/selfObj/allianceFlag"
local allianceFlagItem_path = "UICommonFullTop/Bg2/selfObj/allianceFlag/AllianceFlag"
local self_power_des_path ="UICommonFullTop/Bg2/selfObj/PowerGo/powerDesTxt"
local self_power2_des_path ="UICommonFullTop/Bg2/selfObj/power2DesTxt"
local self_country__path ="UICommonFullTop/Bg2/selfObj/country"
local num_txt_path = "UICommonFullTop/Bg2/selfObj/numTxt"
local first_txt_path = "UICommonFullTop/Bg2/selfObj/firstTxt"
local second_txt_path = "UICommonFullTop/Bg2/selfObj/secondTxt"
local power_txt_path = "UICommonFullTop/Bg2/selfObj/PowerGo/powerTxt"
local power2_txt_path = "UICommonFullTop/Bg2/selfObj/power2Txt"
local direction_icon_path = "UICommonFullTop/Bg2/selfObj/PowerGo/direction_icon"
local hero_plugin_path = "UICommonFullTop/Bg2/selfObj/PowerGo/UIHeroPluginBtn"
local self_obj_path = "UICommonFullTop/Bg2/selfObj"
local scroll_path = "UICommonFullTop/Bg2/ScrollView"

local function OnCreate(self)
    base.OnCreate(self)
    self.type,self.serverId = self:GetUserData()
    self.txt_title = self:AddComponent(UITextMeshProUGUIEx, txt_title_path)
    self.name_des = self:AddComponent(UITextMeshProUGUIEx, name_des_path)
    self.power_des = self:AddComponent(UITextMeshProUGUIEx, power_des_path)
    self.power2_des = self:AddComponent(UITextMeshProUGUIEx, power2_des_path)
    self._country_txt = self:AddComponent(UITextMeshProUGUIEx,country_path)
    self.self_power_des = self:AddComponent(UITextMeshProUGUIEx, self_power_des_path)
    self.self_power2_des = self:AddComponent(UITextMeshProUGUIEx, self_power2_des_path)
    self.self_country = self:AddComponent(UIImage,self_country__path)
    self.num_txt = self:AddComponent(UITextMeshProUGUIEx, num_txt_path)
    self.first_txt = self:AddComponent(UITextMeshProUGUIEx, first_txt_path)
    self.second_txt = self:AddComponent(UITextMeshProUGUIEx, second_txt_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx, power_txt_path)
    self.power2_txt = self:AddComponent(UITextMeshProUGUIEx, power2_txt_path)
	self.self_obj = self:AddComponent(UIBaseContainer, self_obj_path)
	self.player_img = self:AddComponent(UIPlayerHead, player_icon_path)
    self.playerHeadFg = self:AddComponent(UIImage, playerIconFg_path)
    
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()  
        self.ctrl:CloseSelf()
    end)
    self.closeAll_btn = self:AddComponent(UIButton, closeAll_btn_path)
    self.closeAll_btn:SetOnClick(function()  
        self.ctrl:Close()
    end)
    
    self.player_flag = self:AddComponent(UIBaseContainer,player_flag_path)
    self.alliance_flag = self:AddComponent(UIBaseContainer,alliance_flag_path)
    self.allianceFlagItem = self:AddComponent(AllianceFlagItem, allianceFlagItem_path)
    
    self.ScrollView = self:AddComponent(UIScrollView, scroll_path)
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnRankItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnRankItemMoveOut(itemObj, index)
    end)
    self.direction_icon = self:AddComponent(UIImage, direction_icon_path)
    self.hero_plugin = self:AddComponent(UIHeroPluginUpgradePluginIcon, hero_plugin_path)

    self:InitViewText(self.type)
end

local function OnDestroy(self)
    self:ClearScroll()
    self.type =nil
    self.txt_title = nil
    self.name_des = nil
    self.power_des = nil
    self.power2_des = nil
    self.self_power_des = nil
    self.self_power2_des = nil
    self.self_country = nil
    self.num_txt = nil
    self.first_txt = nil
    self.second_txt = nil
    self.power_txt = nil
    self.power2_txt = nil
    self.close_btn = nil
    self.return_btn = nil
    self.player_flag = nil
    self.alliance_flag = nil
    self.ScrollView = nil
    self.rankList =nil
	self.player_img=nil
    self.playerHeadFg = nil
    base.OnDestroy(self)
end

local function InitViewText(self,type)
    self._country_txt:SetLocalText(143589)
    if type == RankType.AllianceKill then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(129093) 
        self.name_des:SetLocalText(390288) 
        self.power_des:SetLocalText(104225) 
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(100196) 
        self.self_power2_des:SetActive(false)
        SFSNetwork.SendMessage(MsgDefines.AllianceKillRankList)
    elseif type == RankType.AlliancePower then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(129094) 
        self.name_des:SetLocalText(390288) 
        self.power_des:SetLocalText(100644) 
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(100644) 
        self.self_power2_des:SetActive(false)
        SFSNetwork.SendMessage(MsgDefines.AllianceRankList)
    elseif type == RankType.CommanderKill then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(129095) 
        self.name_des:SetLocalText(100184) 
        self.power_des:SetLocalText(104225) 
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(100196) 
        self.self_power2_des:SetActive(false)
		self.player_img:SetData(LuaEntry.Player:GetUid(),LuaEntry.Player:GetPic(),LuaEntry.Player.picVer)
        SFSNetwork.SendMessage(MsgDefines.PlayerKillRankList)
    elseif type == RankType.CommanderPower then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(129096) 
        self.name_des:SetLocalText(100184) 
        self.power_des:SetLocalText(100644) 
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(100644) 
        self.self_power2_des:SetActive(false)
        self.player_img:SetData(LuaEntry.Player:GetUid(),LuaEntry.Player:GetPic(),LuaEntry.Player.picVer)
        SFSNetwork.SendMessage(MsgDefines.PlayerRankList)
    elseif type == RankType.CommanderBase then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(129097) 
        self.name_des:SetLocalText(100184) 
        self.power_des:SetLocalText(GameDialogDefine.LEVEL) 
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(GameDialogDefine.LEVEL) 
        self.self_power2_des:SetActive(false)
        self.player_img:SetData(LuaEntry.Player:GetUid(),LuaEntry.Player:GetPic(),LuaEntry.Player.picVer)
		SFSNetwork.SendMessage(MsgDefines.PlayerBaseRankList)
    elseif type == RankType.SeasonForce then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(110455)
        self.name_des:SetLocalText(100184)
        self.power_des:SetLocalText(110453)
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power_des:SetLocalText(110453)
        self.self_power2_des:SetActive(false)
        self.player_img:SetData(LuaEntry.Player:GetUid(),LuaEntry.Player:GetPic(),LuaEntry.Player.picVer)
        SFSNetwork.SendMessage(MsgDefines.DesertForceServerRank)
    elseif type == RankType.OtherServerAlliancePower then
        self.self_obj:SetActive(false)
        self.txt_title:SetLocalText(129094)
        self.name_des:SetLocalText(390288)
        self.power_des:SetLocalText(100644)
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        --self.self_power_des:SetLocalText(100644)
        --self.self_power2_des:SetActive(false)
        if self.serverId~=nil then
            SFSNetwork.SendMessage(MsgDefines.AllianceRankLimit,self.serverId)
        end
    elseif type == RankType.HeroPluginRank then
        self.self_obj:SetActive(true)
        self.txt_title:SetLocalText(GameDialogDefine.HERO_PLUGIN_RANK)
        self.name_des:SetLocalText(100184)
        self.power_des:SetLocalText(GameDialogDefine.HERO_PLUGIN_SCORE)
        self.power2_des:SetActive(false)
        self._country_txt:SetActive(true)
        self.self_power2_des:SetActive(false)
        self.player_img:SetData(LuaEntry.Player:GetUid(),LuaEntry.Player:GetPic(),LuaEntry.Player.picVer)
        DataCenter.HeroPluginRankManager:SendGetPluginRank()
    end
    if LuaEntry.Player:IsHideCountryFlag() then
        self._country_txt:SetActive(false)
    end
    local fgImg = LuaEntry.Player:GetHeadBgImg()
    if not string.IsNullOrEmpty(fgImg) then
        self.playerHeadFg:SetActive(true)
        self.playerHeadFg:LoadSprite(fgImg)

    else
        self.playerHeadFg:SetActive(false)
    end
end
local function RefreshRankList(self)
    self.rankList = self.ctrl:GetRankList(self.type)
    if #self.rankList >0 then
        self.ScrollView:SetTotalCount(#self.rankList)
        self.ScrollView:RefillCells()
    end
    if self.type ~= RankType.OtherServerAlliancePower then
        self:RefreshSelfContent()
    end
    
end

local function RefreshSelfContent(self)
    local currentData = self.ctrl:GetSelfData(self.type)
    local countryTab = currentData.country
    for i = 1, #self.rankList do
        if self.type == RankType.CommanderPower or self.type == RankType.CommanderKill or self.type == RankType.CommanderBase then
            if self.rankList[i].uid == LuaEntry.Player.uid then
                currentData = self.rankList[i]
            end
        elseif self.type == RankType.AlliancePower or self.type == RankType.AllianceKill then
            if self.rankList[i].uid == LuaEntry.Player.allianceId then
                currentData = self.rankList[i]
            end
        end
    end
    currentData.country = countryTab
	if currentData.isAlliance==true then
		self.alliance_flag:SetActive(true)
		self.player_flag:SetActive(false)
        self.allianceFlagItem:SetData(currentData.icon)
	else
		self.alliance_flag:SetActive(false)
		self.player_flag:SetActive(true)
	end
	
    self.num_txt:SetText(currentData.rank)
    self.first_txt:SetText(currentData.firstName)
    self.second_txt:SetText(currentData.secondName)
    self.power_txt:SetText(currentData.power)
    if currentData.directionIcon ~= nil and currentData.directionIcon ~= "" then
        self.direction_icon:SetActive(true)
        self.direction_icon:LoadSprite(currentData.directionIcon)
    else
        self.direction_icon:SetActive(false)
    end
    if currentData.plugin ~= nil then
        self.hero_plugin:SetActive(true)
        local param = {}
        param.level = currentData.lv
        param.camp = currentData.camp
        param.callback = function()
            local uiParam = {}
            uiParam.plugin = currentData.plugin
            uiParam.lv = currentData.lv
            uiParam.camp = currentData.camp
            uiParam.score = currentData.power
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroPluginRankInfo, { anim = true, playEffect = false }, uiParam)
        end
        self.hero_plugin:ReInit(param)
    else
        self.hero_plugin:SetActive(false)
    end
  
    if not string.IsNullOrEmpty(currentData.power2) then
        self.power2_txt:SetActive(true)
        self.power2_txt:SetText(currentData.power2)
    else
        self.power2_txt:SetActive(false)
    end

    if currentData.country == "" or LuaEntry.Player:IsHideCountryFlag() then
        self.self_country:SetActive(false)
    else
        self.self_country:SetActive(true)
        self.self_country:LoadSprite(currentData.country:GetNationFlagPath())
    end
end

local function Init(self)
    self.num_txt:SetText("")
    self.second_txt:SetText("")
    self.self_power_des:SetText("")
    self.self_power2_des:SetText("")
    self.power_txt:SetText("")
    self.power2_txt:SetText("")
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnRankItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(RankListItem, itemObj)
    cellItem:SetItemShow(self.rankList[index])
end
local function OnRankItemMoveOut(self, itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, RankListItem)
end
local function ClearScroll(self)
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(RankListItem)
end
local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.PlayerRank, self.RefreshRankList)
    self:AddUIListener(EventId.AllianceRank, self.RefreshRankList)
    self:AddUIListener(EventId.DesertForceRank, self.RefreshRankList)
    self:AddUIListener(EventId.OtherServerAlliancePowerRank,self.RefreshRankList)
    self:AddUIListener(EventId.RefreshHeroPluginRank,self.RefreshRankList)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.PlayerRank, self.RefreshRankList)
    self:RemoveUIListener(EventId.AllianceRank, self.RefreshRankList)
    self:RemoveUIListener(EventId.DesertForceRank, self.RefreshRankList)
    self:RemoveUIListener(EventId.OtherServerAlliancePowerRank,self.RefreshRankList)
    self:RemoveUIListener(EventId.RefreshHeroPluginRank,self.RefreshRankList)
end

local function OnPlayerDetailClick(self,uid)
    self.ctrl:OnPlayerDetailClick(uid)
end

local function OnAllianceDetailClick(self,uid,allianceName)
    self.ctrl:OnAllianceDetailClick(uid,allianceName)
end

UIRankDetailListView.OnCreate= OnCreate
UIRankDetailListView.OnDestroy = OnDestroy
UIRankDetailListView.InitViewText = InitViewText 
UIRankDetailListView.RefreshRankList = RefreshRankList
UIRankDetailListView.RefreshSelfContent = RefreshSelfContent
UIRankDetailListView.OnEnable = OnEnable
UIRankDetailListView.OnDisable = OnDisable
UIRankDetailListView.OnRankItemMoveIn = OnRankItemMoveIn
UIRankDetailListView.OnRankItemMoveOut = OnRankItemMoveOut
UIRankDetailListView.ClearScroll = ClearScroll
UIRankDetailListView.OnAddListener = OnAddListener
UIRankDetailListView.OnRemoveListener = OnRemoveListener
UIRankDetailListView.Init = Init
UIRankDetailListView.OnPlayerDetailClick = OnPlayerDetailClick
UIRankDetailListView.OnAllianceDetailClick = OnAllianceDetailClick
return UIRankDetailListView