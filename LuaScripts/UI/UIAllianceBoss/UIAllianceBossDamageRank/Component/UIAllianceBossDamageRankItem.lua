---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/4/24 12:02
---
local UIAllianceBossDamageRankItem = BaseClass("UIAllianceBossDamageRankItem",UIBaseContainer)
local base = UIBaseContainer
local UICommonItem = require "UI.UICommonItem.UICommonItem"
local player_name_path = "Name"
local abbr_path = "AllianceName"
local power_path = "Score"
local flag_path = "rankImg"
local rank_path = "Rank"
local player_icon_path="UIPlayerHead/HeadIcon"
local playerHeadFg_path = "UIPlayerHead/Foreground"
local btn_path = "showButton"
local content_path ="Content"
local Localization = CS.GameEntry.Localization

local function OnCreate(self)
    base.OnCreate(self)
    self.player_name = self:AddComponent(UITextMeshProUGUIEx,player_name_path)
    self.abbr = self:AddComponent(UITextMeshProUGUIEx,abbr_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx,power_path)
    self.rank = self:AddComponent(UITextMeshProUGUIEx,rank_path)
    self.flag = self:AddComponent(UIImage,flag_path)
    self.player_img =self:AddComponent(UIPlayerHead,player_icon_path)
    self.playerHeadFg = self:AddComponent(UIImage, playerHeadFg_path)

    self.btn = self:AddComponent(UIButton, btn_path)
    self.btn:SetOnClick(function()
        -- SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClick()
    end)
    self.content = self:AddComponent(UIBaseContainer,content_path)
    self.cells = {}
end

local function SetItemShow(self, data)
    self.data = data
    if data.rank>0 then
        self.rank:SetText(math.floor(data.rank))
        if data.rank==1 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg01.png")
        elseif data.rank ==2 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg02.png")
        elseif data.rank ==3 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg03.png")
        else
            self.flag:SetActive(false)
        end
    else
        self.flag:SetActive(false)
        self.rank:SetText(Localization:GetString("361054"))
    end
    self.power_txt:SetText(string.GetFormattedSeperatorNum(math.floor(data.score)))
    if data.unit~=nil then
        self.player_name:SetText(data.unit.name)
        self.player_img:SetData(data.uid, data.unit.pic, data.unit.picVer)
        local headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(data.unit.headSkinId, data.unit.headSkinET, data.unit.headFrame~=nil and data.unit.headFrame ==1)
        if headBgImg ~= nil then
            self.playerHeadFg:SetActive(true)
            self.playerHeadFg:LoadSprite(headBgImg)
        else
            self.playerHeadFg:SetActive(false)
        end
        --if data.unit.headFrame~=nil and data.unit.headFrame ==1  then
        --    self.playerHeadFg:SetActive(true)
        --else
        --    self.playerHeadFg:SetActive(false)
        --end
        local abbrStr = ""
        if data.unit.alAbbr~=nil then
            abbrStr = data.unit.alAbbr
        end
        if abbrStr~="" then
            self.abbr:SetText("["..abbrStr.."]")
        else
            self.abbr:SetText("")
        end
    end
    
end

local function SetData(self,data)
    self.data = data
    if data.rank>0 then
        self.rank:SetText(math.floor(data.rank))
        if data.rank==1 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg01.png")
        elseif data.rank ==2 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg02.png")
        elseif data.rank ==3 then
            self.flag:SetActive(true)
            self.flag:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg03.png")
        else
            self.flag:SetActive(false)
        end
    else
        self.flag:SetActive(false)
        self.rank:SetText(Localization:GetString("361054"))
    end
    self.power_txt:SetText(string.GetFormattedSeperatorNum(math.floor(data.score)))

    self.player_name:SetLocalText(372761,data.serverId,data.name)
    self.player_img:SetData(data.uid, data.pic,data.picVer)
    self.abbr:SetLocalText(311026,data.abbr,data.allianceName)
    self:OnCreateShowReward()
end

local function OnClick(self)
    if self.data.uid ~= LuaEntry.Player.uid then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo,{ anim = true, hideTop = true},self.data.uid)
    end
end

local function OnDestroy(self)
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)

end

local function OnDisable(self)
    if self.cells then
        for _,v in ipairs(self.cells) do
            self:GameObjectDestroy(v)
        end
    end
    self.cells = {}
    base.OnDisable(self)
end

local function OnCreateShowReward(self)
    local rewardList = DataCenter.AllianceBossManager:GetDamageRewardListData()
    if rewardList then
        for _,v in ipairs(rewardList) do
            if self.data.rank >= v['start'] and self.data.rank <= v['end'] then
                local reward = v.reward
                for k,v in ipairs(reward) do
                    self.cells[k] = self:GameObjectInstantiateAsync(UIAssets.UICommonItemSize, function(request)
                        if request.isError then
                            return
                        end
                        if self.content ~= nil then
                            local go = request.gameObject
                            go.gameObject:SetActive(true)
                            go.transform:SetParent(self.content.transform)
                            -- go.transform:Set_localScale(0.5, 0.5, 0.5)
                            local nameStr = tostring(NameCount)
                            go.name = nameStr
                            NameCount = NameCount + 1
                            local cell = self.content:AddComponent(UICommonItem, nameStr)
                            local para = {}
                            para.rewardType = v.type
                            if type(v.value) == 'number' then
                                para.count = v.value
                            else
                                para.itemId = v.value.id
                                para.count = v.value.num
                            end

                            cell:ReInit(para)
                        end
                    end)
                end
            end
        end
    end
end

UIAllianceBossDamageRankItem.OnCreate = OnCreate
UIAllianceBossDamageRankItem.SetItemShow = SetItemShow
UIAllianceBossDamageRankItem.OnClick = OnClick
UIAllianceBossDamageRankItem.OnDestroy =OnDestroy
UIAllianceBossDamageRankItem.OnEnable = OnEnable
UIAllianceBossDamageRankItem.OnDisable = OnDisable
UIAllianceBossDamageRankItem.SetData =SetData
UIAllianceBossDamageRankItem.OnCreateShowReward =OnCreateShowReward
return UIAllianceBossDamageRankItem