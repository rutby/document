---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/12/1 11:22
---

local base = require "UI.UICityHud.Component.UICityHudBase"
local UICityHudBuildTime = BaseClass("UICityHudBuildTime", base)

local slider_path = "Root/Slider"
local text_path = "Root/Slider/slider_text"

local SliderLength = 211

local function ComponentDefine(self)
    base.ComponentDefine(self)
    self.slider = self:AddComponent(UISlider, slider_path)
    self.text = self:AddComponent(UITextMeshProUGUIEx, text_path)
end

local function DataDefine(self)
    base.DataDefine(self)
    self.lastTime = 0
    self.lastCurTime = 0
end

local function SetParam(self, param)
    base.SetParam(self, param)
    self.root_go.transform.localPosition = param.offset or Vector3.zero
end

function UICityHudBuildTime:Update()
    if not self.active then
        return
    end
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local buildData = DataCenter.BuildManager:GetBuildingDataByUuid(self.param.uuid)
    local changeTime = buildData.updateTime - curTime
    local maxTime = buildData.updateTime - buildData.startTime
    if changeTime < maxTime and changeTime > 0 then
        local tempTimeSec = math.ceil(changeTime / 1000)
        if tempTimeSec ~= self.lastTime then
            self.lastTime = tempTimeSec
            local str
            if changeTime <= 60000 then -- 阿柴的规则
                str = math.floor(changeTime / 1000) .. "s"
            else
                str = UITimeManager:GetInstance():MilliSecondToFmtString(changeTime)
            end
            self.text:SetText(str)
        end

        if maxTime > 0 then
            local tempValue = 1 - changeTime / maxTime
            if TimeBarUtil.CheckIsNeedChangeBar(changeTime, buildData.updateTime - self.lastCurTime, maxTime, SliderLength) then
                self.lastCurTime = curTime
                self.slider:SetValue(tempValue)
            end
        end
    else
        if self.lastTime ~= 0 then
            self.lastTime = 0
            self.slider:SetValue(1)
            self.text:SetText("")
            DataCenter.CityHudManager:Destroy(self.param.uuid, self.param.type)
        end
    end
end


UICityHudBuildTime.ComponentDefine = ComponentDefine
UICityHudBuildTime.DataDefine = DataDefine
UICityHudBuildTime.SetParam = SetParam

return UICityHudBuildTime