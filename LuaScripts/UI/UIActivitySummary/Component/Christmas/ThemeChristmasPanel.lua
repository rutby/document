---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/12/4 22:43
---ThemeChristmasPanel.lua


local base = UIBaseView--Variable
local ThemeChristmasPanel = BaseClass("ThemeChristmasPanel", base)--Variable
local Localization = CS.GameEntry.Localization
local ThemeActivityItem = require "UI.UIActivitySummary.Component.ThemeActivityItems.ThemeActivityItem_Activity"
local ThemePackStoreItem = require "UI.UIActivitySummary.Component.ThemeActivityItems.ThemeActivityItem_PackStore"
local ThemeGiftPackItem = require "UI.UIActivitySummary.Component.ThemeActivityItems.ThemeActivityItem_GiftPack"
local UIScrollPackContent = require "UI.UIScrollPack.Component.UIScrollPackContent"

local title_path = "Top/title"
local closeBtn_path = "BtnClose"
local remainTime_path = "Top/remainTime"
local infoBtn_path = "Top/title/infoBtn"
local res1_path = "Res1"
local resIcon_path = "Res1/resIcon1"
local resCount_path = "Res1/resNum1"
local res2_path = "Res2"
local resIcon2_path = "Res2/resIcon2"
local resCount2_path = "Res2/resNum2"
local activityItem_path = "Top/activityMain/activity"
local activity5Item_path = "layoutL/activity5"
local packStore_path = "Top/activityMain/packStore"
local tipTxt1_path = "Top/subTitle"
local tipTxt2_path = "Top/actTime"
local packagePanel_path = "packagePanel"
local hidePackPanelBtn_path = "packagePanel/Back"
local packageItem_path = "packagePanel/UIScrollPackContent"
local package_path = "layoutL/package"

local ActivityStatus = {
    Notice = 1,
    Open = 2,
    Close = 3,
}

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:DelCountDownTimer()
    self:DataDestroy()
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    self:RefreshAll()
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.RefreshItems, self.RefreshResCount)
    self:AddUIListener(EventId.UpdateGiftPackData, self.RefreshPackage)
end


local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.RefreshItems, self.RefreshResCount)
    self:RemoveUIListener(EventId.UpdateGiftPackData, self.RefreshPackage)
    base.OnRemoveListener(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UIText, title_path)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.remainTimeN = self:AddComponent(UIText, remainTime_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.res1N = self:AddComponent(UIBaseContainer, res1_path)
    self.resIconN = self:AddComponent(UIImage, resIcon_path)
    self.resCountN = self:AddComponent(UIText, resCount_path)
    self.res2N = self:AddComponent(UIBaseContainer, res2_path)
    self.resIcon2N = self:AddComponent(UIImage, resIcon2_path)
    self.resCount2N = self:AddComponent(UIText, resCount2_path)
    self.activityItemsTbN = {}
    for i = 1, 4 do
        local tempPath = activityItem_path .. i
        local tempItem = self:AddComponent(ThemeActivityItem, tempPath)
        table.insert(self.activityItemsTbN, tempItem)
    end
    local activityItem5 = self:AddComponent(ThemeActivityItem, activity5Item_path)
    table.insert(self.activityItemsTbN, activityItem5)
    
    self.tipTxt1N = self:AddComponent(UIText, tipTxt1_path)
    self.tipTxt1N:SetText(Localization:GetString("372338"))
    self.tipTxt2N = self:AddComponent(UIText, tipTxt2_path)
    self.tipTxt2N:SetText(Localization:GetString("372391"))
    self.packagePanelN = self:AddComponent(UIBaseContainer, packagePanel_path)
    self.packageItemN = self:AddComponent(UIScrollPackContent, packageItem_path)
    self.hidePackPanelBtnN = self:AddComponent(UIButton, hidePackPanelBtn_path)
    self.hidePackPanelBtnN:SetOnClick(function()
        self:ShowPackagePanel(false)
    end)
    self.packageN = self:AddComponent(ThemeGiftPackItem, package_path)
    self.packStoreN = self:AddComponent(ThemePackStoreItem, packStore_path)
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.closeBtnN = nil
    self.remainTimeN = nil
    self.activityItemsTbN = nil
    self.infoBtnN = nil
    self.resIconN = nil
    self.resCountN = nil
    self.resIcon2N = nil
    self.resCount2N = nil
end

local function DataDefine(self)
    self.activityInfo = nil
    self.activityStatus = nil
    self.endTime = nil
    self.endTimeTip = nil
    self.isShowPackPanel = false
    self.pveActStatus = EnumActivityStatus.Open
end

local function DataDestroy(self)
    self.activityInfo = nil
    self.activityStatus = nil
    self.endTime = nil
    self.endTimeTip = nil
    self.isShowPackPanel = nil
    self.pveActStatus = nil
end

local function ShowPanel(self, actInfo)
    self.activityInfo = actInfo
    self:RefreshAll()
end

local function RefreshAll(self)
    if not self.activityInfo then
        return
    end
    
    self.titleN:SetText(Localization:GetString(self.activityInfo.name))

    local serverTime = UITimeManager:GetInstance():GetServerTime()
    if self.activityInfo.endTime > serverTime then
        self.activityStatus = ActivityStatus.Open
    else
        self.activityStatus = ActivityStatus.Close
    end

    if self.activityStatus == ActivityStatus.Open then
        self.endTime = self.activityInfo.endTime
        self.endTimeTip = "371061"
        self:AddCountDownTimer()
        self:RefreshRemainTime()
        self:ShowActivityMain()
    else
        self:DelCountDownTimer()
        self.remainTimeN:SetText(Localization:GetString("370100"))
    end

    self:RefreshResCount()
    self:RefreshPackage()
    self:RefreshPackStore()
end

local function RefreshResCount(self)
    local strItemId = self.activityInfo.para2
    local itemIds = string.split(strItemId, ";")
    if #itemIds > 0 and not string.IsNullOrEmpty(itemIds[1]) then
        self.res1N:SetActive(true)
        local goods = DataCenter.ItemTemplateManager:GetItemTemplate(itemIds[1])
        self.resIconN:LoadSprite(string.format(LoadPath.ItemPath, goods.icon))
        local item = DataCenter.ItemData:GetItemById(itemIds[1])
        local hasCount = item and item.count or 0
        self.resCountN:SetText(hasCount)
    else
        self.res1N:SetActive(false)
    end

    if #itemIds > 1 and not string.IsNullOrEmpty(itemIds[2]) then
        self.res2N:SetActive(true)
        local goods = DataCenter.ItemTemplateManager:GetItemTemplate(itemIds[2])
        self.resIcon2N:LoadSprite(string.format(LoadPath.ItemPath, goods.icon))
        local item = DataCenter.ItemData:GetItemById(itemIds[2])
        local hasCount = item and item.count or 0
        self.resCount2N:SetText(hasCount)
    else
        self.res2N:SetActive(false)
    end
end


local function RefreshPackage(self)
    local packageArr = string.split(self.activityInfo.para3, ";")
    for i, packageId in ipairs(packageArr) do
        local packInfo = GiftPackageData.get(packageId)
        if packInfo then
            self.curPackageInfo = packInfo
            self.packageN:SetActive(true)
            self.packageN:SetItem(self.activityInfo, packInfo)
            return
        end
    end
    self.curPackageInfo = nil
    self.packageN:SetActive(false)
end

local function RefreshPackStore(self)
    local rechargeId = GetTableData("recharge", ChristmasCumulateRechargeId, "para2")
    local hasCumulateRecharge = DataCenter.CumulativeRechargeManager:CheckIsShow(tonumber(rechargeId))
    self.packStoreN:SetActive(true)
    self.packStoreN:SetItem(self.activityInfo, WelfareTagType.CumulativeRecharge, ChristmasCumulateRechargeId, hasCumulateRecharge)
end

local function ShowActivityMain(self)

    local actIdList = string.split(self.activityInfo.para1, ";")

    for i, v in ipairs(self.activityItemsTbN) do
        if i <= #actIdList and not string.IsNullOrEmpty(actIdList[i]) then
            v:SetActive(true)
            v:SetItem( actIdList[i])
        else
            v:SetActive(false)
        end
    end
end

local function AddCountDownTimer(self)
    self.CountDownTimerAction = function()
        self:RefreshRemainTime()
    end

    if self.countDownTimer == nil then
        self.countDownTimer = TimerManager:GetInstance():GetTimer(1, self.CountDownTimerAction , self, false,false,false)
    end
    self.countDownTimer:Start()
end

local function RefreshRemainTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = self.endTime - curTime
    if remainTime > 0 then
        self.remainTimeN:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(remainTime))
    else
        self.remainTimeN:SetText("")
        self:DelCountDownTimer()
        self:RefreshAll()
    end
end

local function DelCountDownTimer(self)
    if self.countDownTimer ~= nil then
        self.countDownTimer:Stop()
        self.countDownTimer = nil
    end
end


local function OnClickInfoBtn(self)
    UIUtil.ShowIntro(Localization:GetString(tostring(self.activityInfo.name)), Localization:GetString("100239"), Localization:GetString(tostring(self.activityInfo.story)))
end


local function ShowPackagePanel(self, isShow)
    DataCenter.ThemeActivityManager:SetPackageOld(self.activityInfo)
    self:RefreshPackage()

    if not isShow then
        self.packagePanelN:SetActive(false)
    else
        self.packagePanelN:SetActive(true)
        self.packageItemN:SetData(self.curPackageInfo, function()
            self:ShowPackagePanel(false)
        end)
    end
end


local function OnClickCloseBtn(self)
    self.view.ctrl:CloseSelf()
end


ThemeChristmasPanel.OnCreate = OnCreate
ThemeChristmasPanel.OnDestroy = OnDestroy
ThemeChristmasPanel.OnEnable = OnEnable
ThemeChristmasPanel.OnDisable = OnDisable
ThemeChristmasPanel.OnAddListener = OnAddListener
ThemeChristmasPanel.OnRemoveListener = OnRemoveListener
ThemeChristmasPanel.ComponentDefine = ComponentDefine
ThemeChristmasPanel.ComponentDestroy = ComponentDestroy
ThemeChristmasPanel.DataDefine = DataDefine
ThemeChristmasPanel.DataDestroy = DataDestroy

ThemeChristmasPanel.InitUI = InitUI
ThemeChristmasPanel.ShowPanel = ShowPanel
ThemeChristmasPanel.RefreshAll = RefreshAll
ThemeChristmasPanel.RefreshPackStore = RefreshPackStore
ThemeChristmasPanel.ShowActivityMain = ShowActivityMain
ThemeChristmasPanel.ShowPackagePanel = ShowPackagePanel
ThemeChristmasPanel.RefreshResCount = RefreshResCount
ThemeChristmasPanel.RefreshPackage = RefreshPackage
ThemeChristmasPanel.AddCountDownTimer = AddCountDownTimer
ThemeChristmasPanel.RefreshRemainTime = RefreshRemainTime
ThemeChristmasPanel.DelCountDownTimer = DelCountDownTimer
ThemeChristmasPanel.OnClickCloseBtn = OnClickCloseBtn
ThemeChristmasPanel.OnClickInfoBtn = OnClickInfoBtn

return ThemeChristmasPanel