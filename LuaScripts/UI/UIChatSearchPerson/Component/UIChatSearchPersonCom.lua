---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/24/21 11:13 AM
---
---

-- 组件信息
local ChatUserItem = require "UI.UIChatSearchPerson.Component.UIChatSearchUserItem"

local UIChatSearchPersonCom = BaseClass("UIChatSearchPersonCom", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local _cp_inputField = "InputField"
local _cp_inputField_text = "InputField/Placeholder"
local _cp_scrollContent = "showList/Viewport/Content"
local _cp_btnSearch = "btnSearch"
local _cp_btnInvite = "btnInvite"
local _cp_txtInvite = "btnInvite/txtInvite"



function UIChatSearchPersonCom:ComponentDefine()
    self._btnSearch = self:AddComponent(UIButton, _cp_btnSearch)
    self._btnSearch:SetOnClick(BindCallback(self, self.OnClickBtnSearch))

    self._inputField = self:AddComponent(UIInput, _cp_inputField)
    self._inputField_text = self:AddComponent(UIText, _cp_inputField_text)
    self._scrollContent = self:AddComponent(UIBaseContainer, _cp_scrollContent)
    
    self._btnInvite = self:AddComponent(UIButton, _cp_btnInvite)
    self._btnInvite:SetOnClick(BindCallback(self, self.OnClickInvite))
    
    self._txtInvite = self:AddComponent(UIText, _cp_txtInvite)

end

function UIChatSearchPersonCom:DataInit()
    self._freeUserItemList = {}
    self._userItemList = {}
    self._loadingPrefab = {}
    self._prefabNameIndex = 0
    self.uidArr = {}
    self.roomName = ""
end

function UIChatSearchPersonCom:OnCreate()
    base.OnCreate(self)
    self:DataInit()
    self:ComponentDefine()
    self._inputField_text:SetLocalText(290039) 
    self._txtInvite:SetLocalText(390198) 
end

function UIChatSearchPersonCom:ReInit()
    self:DataInit()
    self._scrollContent:DestroyChildNode()
    self._inputField:SetText("")
end

-- 打开
function UIChatSearchPersonCom:OnEnable()
    base.OnEnable(self)
end

-- 关闭
function UIChatSearchPersonCom:OnDisable()
    base.OnDisable(self)
end

function UIChatSearchPersonCom:OnAddListener()
    self:AddUIListener(ChatEventEnum.CHAT_ROOM_INVITE_SEARCH_PLAYER_RESULT, self.UpdateUserList);
end

function UIChatSearchPersonCom:OnRemoveListener()
    self:RemoveUIListener(ChatEventEnum.CHAT_ROOM_INVITE_SEARCH_PLAYER_RESULT, self.UpdateUserList);
end

-- 搜索
function UIChatSearchPersonCom:OnClickBtnSearch()
    local _strInput = self._inputField:GetText()
    if (string.IsNullOrEmpty(_strInput)) then
        UIUtil.ShowTipsId(120193) 
        return
    end
    local param = {}
    param["searchKey"] = _strInput
    param["page"] = 1
    EventManager:GetInstance():Broadcast(ChatEventEnum.SEARCH_PLAYER_COMMAND,param)
end

function UIChatSearchPersonCom:OnClickInvite()
    self.uidArr = {}
    self.roomName = ""
    local str = ""
    local spaceStr = ','
    local myName = ChatInterface.getPlayerName()
    for _, userItem in pairs(self._userItemList) do
        -- 未选择
        if (not userItem:GetToggle()) then
            goto continue
        end
        local userInfo = userItem:GetUserData()
        -- 没有玩家信息
        if userInfo == nil then
            goto continue
        end
        -- 组装信息
        local memberName = ""
        if userInfo.name then
            memberName = userInfo.name
            table.insert(self.uidArr, userInfo.uid)
        elseif userInfo.learderName then
            memberName = userInfo.learderName
            table.insert(self.uidArr, userInfo.learderUid)
        end
        if myName ~= memberName then
            if str ~= '' then
                str = str .. spaceStr .. memberName
            else
                str = memberName
            end
        end
        ::continue::
    end
    --如果就自己的话 直接创建房间 还有别人的话就弹出提示弹窗
    if str == "" then
        self.roomName = myName
        self:CreateRoom()
    else
        self.roomName = myName .. spaceStr .. str
        local endStr = Localization:GetString("290025", str)
        self:GotoAlterView(endStr)
    end
end

-- 发送消息之前,依赖于选择玩家列表中的数据,组装信息
function UIChatSearchPersonCom:CreateRoom()
	
	if self.uidArr == nil or #self.uidArr == 0 then
		UIUtil.ShowMessage(message, 1, GameDialogDefine.CONFIRM, "290036", 
			function()
				
			end)
		return
	end
	
	local roomId = self.view.ctrl.chatRoomdId
    if roomId == nil then
        -- 创建聊天室
        -- 两个参数：一个是uid数组，一个是用户名字拼接的字符串（name,name1,name2,name3）
		local t = {type = 0, name = self.roomName, memberList = self.uidArr}
        EventManager:GetInstance():Broadcast(ChatInterface.getEventEnum().CHAT_ROOM_CREATE_COMMAND, t)
    else
        -- 两个参数：一个是uid数组，一个是当前频道ID
		local t = {roomId = roomId, uidArr = self.uidArr}
		EventManager:GetInstance():Broadcast(ChatInterface.getEventEnum().ROOM_INVITE_COMMAND, t)
    end
	
    self.view.ctrl:CloseSelf()
end

function UIChatSearchPersonCom:GotoAlterView( message )
    UIUtil.ShowMessage(message, 1, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL, function()
        self:CreateRoom()
    end)
end

-- 刷新界面
function UIChatSearchPersonCom:UpdateUserList( _list )
    if ( _list == nil )then
        return
    end
    self._loadingPrefab = {}
    self._scrollContent:DestroyChildNode()
    for index, userInfo in pairs(_list) do
        self:AddUserItem(userInfo, index)
    end
end

function UIChatSearchPersonCom:AddUserItem(userInfo, index)
    if #self._freeUserItemList > 0 then
        local temp = table.remove(self._freeUserItemList)
        if temp ~= nil then
            temp:SetActive(true)
            temp:setData(userInfo)
            temp.transform:SetParent(self._scrollContent.transform)
            temp.transform:SetAsLastSibling()
            self._userItemList[index] = temp
        end
    else
        local req = self:GameObjectInstantiateAsync(UIAssets.UIChatSearchPersonItem,
                function(request)
                    self:AddUserItemDone(request, userInfo, index)
                end)
        self._loadingPrefab[req] = true
    end
end

-- 创建房间异步结束
function UIChatSearchPersonCom:AddUserItemDone(request, userInfo, index)
    if request.isError then
        return
    end

    local go = request.gameObject
    go.transform:SetParent(self._scrollContent.transform)
    go.transform:SetAsLastSibling()
    go.name = "user".."..."..self._prefabNameIndex
    local temp = self._scrollContent:AddComponent(ChatUserItem, go.name)
    self._prefabNameIndex = self._prefabNameIndex + 1
    if self._loadingPrefab[request] then
        self._loadingPrefab[request] = nil
        go:SetActive(true)
        self._userItemList[index] = temp
        self._userItemList[index]:SetData(userInfo)
    else
        go:SetActive(false)
        table.insert(self._freeUserItemList,temp)
    end
end



return UIChatSearchPersonCom