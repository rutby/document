---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2022/3/9 17:23
---

local UIGarageRefitItemTip = BaseClass("UIGarageRefitItemTip", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local Resource = CS.GameEntry.Resource
local UIGarageRefitItemTipLine = require "UI.UIGarageRefit.Component.UIGarageRefitItemTipLine"

local close_path = "Close"
local root_path = "Root"
local top_text_path = "Root/Content/Top/TopText"
local bottom_path = "Root/Content/Bottom"
local left_arrow_path = "Root/LeftArrow"
local right_arrow_path = "Root/RightArrow"

local OFFSET_X = 80
local OFFSET_Y = 40

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self:OnClose()
    end)
    self.root_anim = self:AddComponent(UIAnimator, root_path)
    self.top_text = self:AddComponent(UITextMeshProUGUIEx, top_text_path)
    self.bottom_go = self:AddComponent(UIBaseContainer, bottom_path)
    self.left_arrow_go = self:AddComponent(UIBaseContainer, left_arrow_path)
    self.right_arrow_go = self:AddComponent(UIBaseContainer, right_arrow_path)
end

local function ComponentDestroy(self)
    self.close_btn = nil
    self.root_anim = nil
    self.top_text = nil
    self.bottom_go = nil
    self.left_arrow_go = nil
    self.right_arrow_go = nil
end

local function DataDefine(self)
    self.reqs = {}
    self.active = false
end

local function DataDestroy(self)
    self.reqs = nil
    self.active = nil
end

local function OnEnable(self)
    base.OnEnable(self)
    self.active = true
end

local function OnDisable(self)
    self.active = false
    base.OnDisable(self)
end

local function SetData(self, part, bindGo)
    if part.type == 1 or part.type == 3 then
        self.left_arrow_go:SetActive(true)
        self.right_arrow_go:SetActive(false)
        self.root_anim.rectTransform.pivot = Vector2.New(0, 1)
        self.transform.position = bindGo.transform.position + Vector3.New(OFFSET_X, OFFSET_Y, 0)
    else
        self.left_arrow_go:SetActive(false)
        self.right_arrow_go:SetActive(true)
        self.root_anim.rectTransform.pivot = Vector2.New(1, 1)
        self.transform.position = bindGo.transform.position + Vector3.New(-OFFSET_X, OFFSET_Y, 0)
    end
    self.root_anim:Play("CommonPopup_movein", 0, 0)
    
    self.reqs = {}
    local partTemplate = DataCenter.GarageRefitManager:GetPartTemplate(part.type, part.level)
    if partTemplate then
        self.top_text:SetText(Localization:GetString(partTemplate:getValue("name")) .. " Lv." .. part.level)
        local effects = partTemplate:getValue("effect")
        local effectVas = partTemplate:getValue("effect_num")
        for i = 1, #effects do
            local line = LocalController:instance():getLine(TableName.EffectNumDesc, tostring(effects[i]))
            local key = line.des
            local descType = tonumber(line.type)
            local effectStr = Localization:GetString(key)
            local effectValStr = "+" .. effectVas[i]
            if descType == 1 then
                effectValStr = effectValStr .. "%"
            elseif descType == 2 then
                effectValStr = effectValStr .. "â€°"
            end
            
            local req = Resource:InstantiateAsync(UIAssets.UIGarageRefitItemTipLine)
            req:completed('+', function()
                if req.isError then
                    return
                end
                
                if not self.gameObject or not self.active then
                    req:Destroy()
                    return
                end
                
                local go = req.gameObject
                go:SetActive(true)
                go.name = "Line_" .. tostring(i)
                
                local tf = go.transform
                tf:SetParent(self.bottom_go.transform)
                tf:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                
                local item = self.bottom_go:AddComponent(UIGarageRefitItemTipLine, go)
                item:SetData(effectStr, effectValStr)
                CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.bottom_go.transform)
                
                self.reqs[i] = req
            end)
        end
    end
end

local function OnClose(self)
    self.bottom_go:RemoveComponents(UIGarageRefitItemTipLine)
    for _, req in pairs(self.reqs) do
        req:Destroy()
    end
    self:SetActive(false)
end

UIGarageRefitItemTip.OnCreate= OnCreate
UIGarageRefitItemTip.OnDestroy = OnDestroy
UIGarageRefitItemTip.ComponentDefine = ComponentDefine
UIGarageRefitItemTip.ComponentDestroy = ComponentDestroy
UIGarageRefitItemTip.DataDefine = DataDefine
UIGarageRefitItemTip.DataDestroy = DataDestroy
UIGarageRefitItemTip.OnEnable = OnEnable
UIGarageRefitItemTip.OnDisable = OnDisable

UIGarageRefitItemTip.SetData = SetData
UIGarageRefitItemTip.OnClose = OnClose

return UIGarageRefitItemTip