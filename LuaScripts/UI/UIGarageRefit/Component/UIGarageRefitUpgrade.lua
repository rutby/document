---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2022/3/9 19:19
---

local UIGarageRefitUpgrade = BaseClass("UIGarageRefitUpgrade", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local Resource = CS.GameEntry.Resource
local UIGarageRefitItem = require "UI.UIGarageRefit.Component.UIGarageRefitItem"
local UIGarageRefitUpgradeLine = require "UI.UIGarageRefit.Component.UIGarageRefitUpgradeLine"

local title_path = "UICommonRewardPopUp/Panel/ImgTitleBg/TextTitle"
local next_path = "UICommonRewardPopUp/Panel"
local root_path = "Root"
local item_path = "Root/UIGarageRefitItem"
local content_path = "Root/Content"

local PART_COUNT = 4

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.title_text = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.title_text:SetLocalText(120062)
    self.next_btn = self:AddComponent(UIButton, next_path)
    self.next_btn:SetOnClick(function()
        self:Next()
    end)
    self.root_anim = self:AddComponent(UIAnimator, root_path)
    self.item = self:AddComponent(UIGarageRefitItem, item_path)
    self.content_go = self:AddComponent(UIBaseContainer, content_path)
end

local function ComponentDestroy(self)
    self.title_text = nil
    self.next_btn = nil
    self.root_anim = nil
    self.item = nil
    self.item_anim = nil
    self.content_go = nil
end

local function DataDefine(self)
    self.reqs = {}
    self.active = false
    self.levels = nil
    self.typeList = {}
    self.onClose = nil
end

local function DataDestroy(self)
    self.reqs = nil
    self.active = nil
    self.levels = nil
    self.typeList = nil
    self.onClose = nil
end

local function OnEnable(self)
    base.OnEnable(self)
    self.active = true
end

local function OnDisable(self)
    self.active = false
    base.OnDisable(self)
end

local function SetData(self, refitData, typeList)
    self.levels = {}
    for type = 1, PART_COUNT do
        self.levels[type] = refitData.parts[type] and refitData.parts[type].level or 0
    end
    self.typeList = typeList
    self:Show()
end

local function Show(self)
    if not self.levels or table.IsNullOrEmpty(self.typeList) then
        self:SetActive(false)
        return
    end

    self.root_anim:Play("V_ui_bujianshengji_01_anim", 0, 0)
    
    local type = table.remove(self.typeList, 1)
    local rightLevel = self.levels[type]
    local leftLevel = rightLevel - 1
    self.levels[type] = rightLevel
    
    local leftPartTemplate = DataCenter.GarageRefitManager:GetPartTemplate(type, leftLevel)
    local rightPartTemplate = DataCenter.GarageRefitManager:GetPartTemplate(type, rightLevel)
    self.item:SetTemplate(rightPartTemplate)

    self.reqs = {}
    local effects = rightPartTemplate:getValue("effect")
    local effectVas = rightPartTemplate:getValue("effect_num")
    local lEffectVas = {}
    if leftPartTemplate~=nil then
        lEffectVas = leftPartTemplate:getValue("effect_num")
    end
    local count = #effects
    for i = 1, count do
        local line = LocalController:instance():getLine(TableName.EffectNumDesc, tostring(effects[i]))
        local desc = Localization:GetString(line.des)
        local descType = tonumber(line.type)
        local leftVal = "+" .. (leftPartTemplate and lEffectVas[i] or 0)
        local rightVal = "+" .. effectVas[i]
        
        if descType == 1 then
            leftVal = leftVal .. "%"
            rightVal = rightVal .. "%"
        elseif descType == 2 then
            leftVal = leftVal .. "‰"
            rightVal = rightVal .. "‰"
        end
        
        local req = Resource:InstantiateAsync(UIAssets.UIGarageRefitUpgradeLine)
        req:completed('+', function()
            if req.isError then
                return
            end
            
            if not self.gameObject or not self.active then
                req:Destroy()
                return
            end
            
            local go = req.gameObject
            go:SetActive(true)
            go.name = "Line_" .. tostring(i)
            
            local tf = go.transform
            tf:SetParent(self.content_go.transform)
            tf:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            
            local item = self.content_go:AddComponent(UIGarageRefitUpgradeLine, go)
            item:SetData(desc, leftVal, rightVal)
            CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.content_go.transform)
            
            self.reqs[i] = req
        end)
    end
end

local function Next(self)
    -- 检查下一个
    self:ClearItems()
    if not table.IsNullOrEmpty(self.typeList) then
        self:Show()
    else
        if self.onClose then
            self.onClose()
        end
        self:SetActive(false)
    end
end

local function ClearItems(self)
    self.content_go:RemoveComponents(UIGarageRefitUpgradeLine)
    for _, req in pairs(self.reqs) do
        req:Destroy()
    end
end

local function SetOnClose(self, onClose)
    self.onClose = onClose
end

UIGarageRefitUpgrade.OnCreate= OnCreate
UIGarageRefitUpgrade.OnDestroy = OnDestroy
UIGarageRefitUpgrade.ComponentDefine = ComponentDefine
UIGarageRefitUpgrade.ComponentDestroy = ComponentDestroy
UIGarageRefitUpgrade.DataDefine = DataDefine
UIGarageRefitUpgrade.DataDestroy = DataDestroy
UIGarageRefitUpgrade.OnEnable = OnEnable
UIGarageRefitUpgrade.OnDisable = OnDisable

UIGarageRefitUpgrade.SetData = SetData
UIGarageRefitUpgrade.ClearItems = ClearItems
UIGarageRefitUpgrade.Show = Show
UIGarageRefitUpgrade.Next = Next
UIGarageRefitUpgrade.SetOnClose = SetOnClose

return UIGarageRefitUpgrade