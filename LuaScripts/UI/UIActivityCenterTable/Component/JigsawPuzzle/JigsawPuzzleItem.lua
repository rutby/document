---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/8/16 14:31
---JigsawPuzzleItem
local JigsawPuzzleItem = BaseClass("JigsawPuzzleItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local bgBtn_path = "offset"
local jigsawImg_path = "offset/jigsawImg"
local jigsawSelected_path = "offset/jigsawImg/selected"
local stars_path = "offset/stars/star/starFill"
local status_path = "offset/status"
local boxBtn_path = "offset/box"
local locked_path = "offset/jigsawImg/locked"
local newDot_path = "offset/NewDot"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.bgBtnN = self:AddComponent(UIButton, bgBtn_path)
    self.bgBtnN:SetOnClick(function()
        self:OnClickSelectBtn()
    end)
    self.jigsawImgN = self:AddComponent(UIImage, jigsawImg_path)
    self.jigsawSelectedN = self:AddComponent(UIBaseContainer, jigsawSelected_path)
    self.starsTbN = {}
    for i = 1, 3 do
        local tempPath = stars_path .. i
        local newStar = self:AddComponent(UIBaseContainer, tempPath)
        table.insert(self.starsTbN, newStar)
    end
    self.statusTipN = self:AddComponent(UIText, status_path)
    self.boxBtnN = self:AddComponent(UIButton, boxBtn_path)
    self.boxBtnN:SetOnClick(function()
        self:OnClickBoxBtn()
    end)
    self.lockedN = self:AddComponent(UIBaseContainer, locked_path)
    self.newDotN = self:AddComponent(UIBaseContainer, newDot_path)
    self.newDotN:SetActive(false)
end

--控件的销毁
local function ComponentDestroy(self)
    self.bgBtnN = nil
    self.jigsawImgN = nil
    self.jigsawSelectedN = nil
    self.starsTbN = nil
    self.statusTipN = nil
    self.boxBtnN = nil
end

--变量的定义
local function DataDefine(self)
    self.jigsawTemplate = nil
end

--变量的销毁
local function DataDestroy(self)
    self.jigsawTemplate = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnJigsawPuzzleEnd, self.OnFinishJigsaw)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnJigsawPuzzleEnd, self.OnFinishJigsaw)
    base.OnRemoveListener(self)
end


local function SetItem(self, jigsawTemplate, isSelected, selectCallback, showRewardCallback)
    self.jigsawTemplate = jigsawTemplate
    self.isUnlocked, self.unlockNeedDay = jigsawTemplate:CheckIfUnlocked()
    self.OnSelectCallback = selectCallback
    self.OnShowRewardCallbabck = showRewardCallback
    
    self.jigsawSelectedN:SetActive(isSelected)
    local scaleX = isSelected and 1 or 0.92
    self:SetLocalScaleXYZ(scaleX, scaleX, 1)
    self:RefreshAll()
end

local function RefreshAll(self)
    if IsNull(self.gameObject) then
        return
    end
    
    local picName = self.jigsawTemplate.jigsawImg or "UIactivities_pt_pic_01"
    local tempPath = string.format("Assets/Main/TextureEx/UIJigsawPuzzle/%s.png", picName)
    self.jigsawImgN:LoadSprite(tempPath)

    local jigsawInfo = DataCenter.JigsawPuzzleManager:GetJigsawInfo(self.jigsawTemplate.activityId, self.jigsawTemplate.id)

    local tempTime = 9999
    if jigsawInfo and jigsawInfo.bestScoreS > 0 then
        tempTime = jigsawInfo.bestScoreS
    end
    local starNum = DataCenter.JigsawPuzzleManager:GetStarNum(self.jigsawTemplate, tempTime)
    for i, v in ipairs(self.starsTbN) do
        v:SetActive(i <= starNum)
    end

    if starNum == 3 then
        self.boxBtnN:SetActive(false)
    else
        self.boxBtnN:SetActive(true)
    end

    if not self.isUnlocked then
        self.lockedN:SetActive(true)
        self.jigsawImgN:SetColor(GrayColor)
        self.statusTipN:SetText(Localization:GetString("372365", self.unlockNeedDay))
        self.newDotN:SetActive(false)
    else
        self.lockedN:SetActive(false)
        self.jigsawImgN:SetColor(WhiteColor)
        if jigsawInfo and jigsawInfo.bestScoreS > 0 then
            self.statusTipN:SetText(Localization:GetString("372353", UITimeManager:GetInstance():SecondToFmtStringWithoutHour(jigsawInfo.bestScoreS)))
        else
            self.statusTipN:SetText(Localization:GetString("372352"))
        end
        local isNew = DataCenter.JigsawPuzzleManager:CheckIfJigsawIsNew(self.jigsawTemplate.id)
        self.newDotN:SetActive(isNew)
    end

end

local function OnFinishJigsaw(self)
    self:RefreshAll()
end



local function SetSelectByExternal(self, isSelected)
    local scaleX = isSelected and 1 or 0.92
    self.transform:DOScale(Vector3.New(scaleX, scaleX, 1), 0.1)
    --self:SetLocalScaleXYZ(scaleX, scaleX, 1)
    self.jigsawSelectedN:SetActive(isSelected)
end

local function SetNewDotVisible(self, isVisible)
    self.newDotN:SetActive(isVisible)
end

local function OnClickSelectBtn(self)
    --if not self.isUnlocked or not self.OnSelectCallback then
    --    return
    --end
    if self.OnSelectCallback then
        self.OnSelectCallback(self.jigsawTemplate.id)
    end
end

local function OnClickBoxBtn(self)
    if self.OnShowRewardCallbabck then
        self.OnShowRewardCallbabck(self.jigsawTemplate.id, self.boxBtnN.transform.position)
    end
end

JigsawPuzzleItem.OnCreate = OnCreate
JigsawPuzzleItem.OnDestroy = OnDestroy
JigsawPuzzleItem.ComponentDefine = ComponentDefine
JigsawPuzzleItem.ComponentDestroy = ComponentDestroy
JigsawPuzzleItem.DataDefine = DataDefine
JigsawPuzzleItem.DataDestroy = DataDestroy
JigsawPuzzleItem.OnAddListener = OnAddListener
JigsawPuzzleItem.OnRemoveListener = OnRemoveListener

JigsawPuzzleItem.SetItem = SetItem
JigsawPuzzleItem.RefreshAll = RefreshAll
JigsawPuzzleItem.OnFinishJigsaw = OnFinishJigsaw
JigsawPuzzleItem.SetSelectByExternal = SetSelectByExternal
JigsawPuzzleItem.SetNewDotVisible = SetNewDotVisible
JigsawPuzzleItem.OnClickSelectBtn = OnClickSelectBtn
JigsawPuzzleItem.OnClickBoxBtn = OnClickBoxBtn

return JigsawPuzzleItem

