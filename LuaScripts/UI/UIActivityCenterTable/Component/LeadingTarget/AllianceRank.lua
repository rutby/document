---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl
--- DateTime: 
---

local AllianceRank = BaseClass("AllianceRank", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local RankListItem = require "UI.UIActivityCenterTable.Component.LeadingTarget.RankListItem"
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"

-- 创建
function AllianceRank:OnCreate()
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
function AllianceRank:OnDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
function AllianceRank:ComponentDefine()
    self._selfRank_txt = self:AddComponent(UITextMeshProUGUI,"selfObj/Txt_SelfRank")
    self._selfAllianceName_txt = self:AddComponent(UITextMeshProUGUI,"selfObj/Txt_SelfAllianceName")
    self._selfAllianceLeader_txt = self:AddComponent(UITextMeshProUGUI,"selfObj/Txt_SelfAllianceLeader")
    self._selfForce_txt = self:AddComponent(UITextMeshProUGUI,"selfObj/Txt_SelfForce")
    self._selfTime_txt = self:AddComponent(UITextMeshProUGUI,"selfObj/Txt_SelfTime")
    self._selfCountry_img = self:AddComponent(UIImage,"selfObj/Img_SelfCountry")
    self._allianceFlag_rect = self:AddComponent(UIBaseContainer,"selfObj/allianceFlag")
    self.allianceFlag = self:AddComponent(AllianceFlagItem,"selfObj/allianceFlag/AllianceFlag")

    self.name_des = self:AddComponent(UITextMeshProUGUI,"select/nameDes")
    self.name_des:SetLocalText(390288)
    self._country_txt = self:AddComponent(UITextMeshProUGUI,"select/country")
    self._country_txt:SetLocalText(143589)
    self._desertDesc_txt = self:AddComponent(UITextMeshProUGUI,"select/Txt_DesertDesc")
    self._desertDesc_txt:SetLocalText(361029)
    self._desertTime_txt = self:AddComponent(UITextMeshProUGUI,"select/Txt_DesertTime")
    self._desertTime_txt:SetLocalText(372356)
    self.ScrollView = self:AddComponent(UIScrollView, "ScrollView")
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnRankItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnRankItemMoveOut(itemObj, index)
    end)
    
    self._noRankTips_txt = self:AddComponent(UITextMeshProUGUI,"Txt_NoRankTips")
end

--控件的销毁
function AllianceRank:ComponentDestroy()
    self.titleN = nil 
    self.progN = nil
    self.contentN = nil
    self.claimBtnN = nil
    self.claimBtnTxtN = nil
    self.claimedTxtN = nil
    self.goBtnN = nil
    self.goBtnTxtN = nil
    self.bgN = nil
end

--变量的定义
function AllianceRank:DataDefine()
  
end

--变量的销毁
function AllianceRank:DataDestroy()

end

function AllianceRank:SetData()
    SFSNetwork.SendMessage(MsgDefines.GetRank,RankType.ActLeadingQuestAllianceRank)
    self._noRankTips_txt:SetActive(false)
    local allianceData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
    if allianceData~=nil and LuaEntry.Player:IsInAlliance()  then
        self._selfAllianceLeader_txt:SetText(allianceData.leaderName)
        self._selfAllianceName_txt:SetLocalText(311026,allianceData.abbr,allianceData.allianceName)
        self._allianceFlag_rect:SetActive(true)
        self.allianceFlag:SetData(allianceData.icon)
    else
        self._selfAllianceName_txt:SetText("-")
        self._selfAllianceLeader_txt:SetText("-")
        self._allianceFlag_rect:SetActive(false)
    end
end

function AllianceRank:OnRefresh(message)
    self.rankList = message["allianceRanking"]
    if message["selfRanking"] and message["selfRanking"] ~= 5000 then
        self._selfRank_txt:SetText(message["selfRanking"])
    else
        self._selfRank_txt:SetText("-")
    end
    if self.rankList and table.count(self.rankList) > 0 then
        self._noRankTips_txt:SetActive(false)
        --找自己的排行信息
        local data = nil
        local index = "-"
        local allianceData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceData~=nil and LuaEntry.Player:IsInAlliance()  then
            for i = 1 ,table.count(self.rankList) do
                if self.rankList[i].uid == allianceData.uid then
                    data = self.rankList[i]
                    index = i
                    break
                end
            end
        end
        if data then
            self._selfForce_txt:SetText(data.score)
            self._selfTime_txt:SetText(UITimeManager:GetInstance():TimeStampToTimeForServerMinute(data.reachTime))
        else
            self._selfForce_txt:SetText("-")
            self._selfTime_txt:SetText("-")
        end

        if LuaEntry.Player:IsHideCountryFlag() then
            self._selfCountry_img:SetActive(false)
        else
            if allianceData~=nil and LuaEntry.Player:IsInAlliance()  then
                self._selfCountry_img:SetActive(true)
                local countryConfig = DataCenter.NationTemplateManager:GetNationTemplate(allianceData:GetCountryFlagTemplate())
                self._selfCountry_img:LoadSprite(countryConfig:GetNationFlagPath())
            else
                self._selfCountry_img:SetActive(false)
            end
        end
        
        self.ScrollView:SetTotalCount(#self.rankList)
        self.ScrollView:RefillCells()
    else
        self._noRankTips_txt:SetActive(true)
        self._noRankTips_txt:SetLocalText(110535)
    end
end

function AllianceRank:OnRankItemMoveIn(itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(RankListItem, itemObj)
    cellItem:SetItemShow(self.rankList[index],index,true)
end

function AllianceRank:OnRankItemMoveOut(itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, RankListItem)
end

function AllianceRank:ClearScroll()
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(RankListItem)
end

return AllianceRank