---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/8/30 16:00
---

local AllianceArmsActivityMain = BaseClass("AllianceArmsActivityMain", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local AllianceArmsBox = require "UI.UIActivityCenterTable.Component.AllianceArms.AllianceArmsActivityBoxItem"
local AllianceArmsCondition = require "UI.UIActivityCenterTable.Component.AllianceArms.AllianceArmsActivityConditionItem"
local AllianceScoreProg = require "UI.UIActivityCenterTable.Component.AllianceArms.AllianceArmsScoreProgress"
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"

local sliderDataTb = {
    {
        num = 0,
        percent = 0,
    },
    {
        num = 20,
        percent = 0.15,
    },
    {
        num = 50,
        percent = 0.5,
    },
    {
        num = 100,
        percent = 0.85,
    }
}

local titleBg_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader"
local goldNum_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ImageGold/goldNum"
local titleTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/titleTxt"
local titleName_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/titleName"
local descTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Img_DescBg/descTxt"
local RewardTips_path = "Imagetips"
local readyGo_path = "bgReady"
local leftBtn_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/leftBtn"
local rightBtn_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/rightBtn"
local closeTipsBtn_path = "Imagetips/bgBtn"
local myScoreTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Button calendar/myScoreTxt"
local myScorePreTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Button calendar/myScorePreTxt"
local rankPreTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ButtonRanking/rankPreTxt"
local rankTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ButtonRanking/rankTxt"
local cdTxt_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Image Time/txtTime"
local boxContainer_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor"
local cdTrs_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Image Time"
local goldGo_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ImageGold"
local scoreGo_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Button calendar"
local rankGo_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ButtonRanking"
local AllianceArmRaceIconItem_path = "Imagetips/Scroll View/Viewport/Content/AllianceArmRaceIconItem"
local tipIconContainer_path = "Imagetips/Scroll View/Viewport/Content"
local infoTxt_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/botTitle/infoTxt"
local rankBtn_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/ButtonRanking"
local leftImg_path = "Imagetips/leftImg"
local rightImg_path = "Imagetips/rightImg"
local valuaTipsTxt_path = "Imagetips/diamondbg/valuaTipsTxt"
local scoreBtn_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/Button calendar"
local botttomTipTxt_path = "Imagetips/bottomLegGo/bg/botttomTipTxt"
local gotoLegBtn_path = "Imagetips/bottomLegGo/bg/gotoLegBtn"
local bottomLegGo_path = "Imagetips/bottomLegGo"
local noAllianceGo_path = "noAllianceGo"
local noAllianceTxt_path = "noAllianceGo/noAllianceTxt"
local legIconImg_path = "Imagetips/bottomLegGo/bg/bg2/legIconImg"
local conditionItem_path = "ScrollRoot/ScrollView/Viewport/Content/Image Lower part/AllianceArmConditionItem"
local bottomDesTxt_path = "Imagetips/bottomLegGo/bg/bottomDesTxt"
local Viewport1_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport1"
local Viewport2_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport2"
local groupBox1_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport1/content1/group1/groupBox1"
local groupBox2_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport1/content1/group1/groupBox2"
local groupBox3_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport1/content1/group1/groupBox3"
local groupBox4_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport2/content2/group2/groupBox4"
local groupBox5_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport2/content2/group2/groupBox5"
local groupBox6_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport2/content2/group2/groupBox6"
local infoBtn_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/infoBtn"
local scoreCardBtn_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/scoreCardBtn"
local scoreCardIcon_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/scoreCardBtn/scoreCardIcon"
local scoreCardName_path = "ScrollRoot/ScrollView/Viewport/Content/ImageTitleheader/scoreCardBtn/scoreCardName"
local scoreCardGo_path = "scoreCardGo"
local scoreCardBgBtn_path = "scoreCardGo"
local cardItem_path = "scoreCardGo/BgImg/cardItem"
                         --ScrollView/Viewport/Content/ImageLowerpart
local conditionTrs_path = "ScrollRoot/ScrollView/Viewport/Content/Image Lower part"
local slider1_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport1/content1/slider1"
local slider2_path = "ScrollRoot/ScrollView/Viewport/Content/Imagefloor/Viewport2/content2/slider2"
local contentVerticalGroup_path = "ScrollRoot/ScrollView/Viewport/Content"
local contentSv_path = "ScrollRoot/ScrollView"
local readyTip1_path = "bgReady/readyDes1Txt"
local readyTip2_path = "bgReady/readyDes2Txt"


local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    --RefreshAll(self)
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:StopTimer()
    base.OnDestroy(self)
end

--
local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.AllianceArms_OpenBox, self.OpenRewardTips)
    self:AddUIListener(EventId.RefreshAllianceArmsUI, self.RefreshAll)
    self:AddUIListener(EventId.OnUpdateActivityEventData, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.AllianceArms_OpenBox, self.OpenRewardTips)
    self:RemoveUIListener(EventId.RefreshAllianceArmsUI, self.RefreshAll)
    self:RemoveUIListener(EventId.OnUpdateActivityEventData, self.RefreshAll)
    base.OnRemoveListener(self) 
end


local function ComponentDefine(self)
    self.titleBg = self:AddComponent(UIImage, titleBg_path)
    self.goldNum = self:AddComponent(UIText, goldNum_path)
    self.titleTxt = self:AddComponent(UIText, titleTxt_path)
    self.titleName = self:AddComponent(UIText, titleName_path)
    self.descTxt = self:AddComponent(UIText, descTxt_path)
    self.RewardTips = self:AddComponent(UIBaseContainer, RewardTips_path)
    self.readyGo = self:AddComponent(UIBaseContainer, readyGo_path)
    self.leftBtn = self:AddComponent(UIButton, leftBtn_path)
    self.leftBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickLeftBtn()
    end)
    self.rightBtn = self:AddComponent(UIButton, rightBtn_path)
    self.rightBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickRightBtn()
    end)
    self.conditionTrs = self:AddComponent(UIBaseContainer, conditionTrs_path)
    self.closeTipsBtn = self:AddComponent(UIButton, closeTipsBtn_path)
    self.closeTipsBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickCloseTipBtn()
    end)
    self.myScoreTxt = self:AddComponent(UIText, myScoreTxt_path)
    self.myScorePreTxt = self:AddComponent(UIText, myScorePreTxt_path)
    self.rankPreTxt = self:AddComponent(UIText, rankPreTxt_path)
    self.rankPreTxt:SetLocalText(361055)
    self.rankTxt = self:AddComponent(UIText, rankTxt_path)
    self.cdTxt = self:AddComponent(UIText, cdTxt_path)
    self.boxContainer = self:AddComponent(UIBaseContainer, boxContainer_path)
    self.cdTrs = self:AddComponent(UIBaseContainer, cdTrs_path)
    self.goldGo = self:AddComponent(UIBaseContainer, goldGo_path)
    self.scoreGo = self:AddComponent(UIBaseContainer, scoreGo_path)
    self.rankGo = self:AddComponent(UIBaseContainer, rankGo_path)
    --self.AllianceArmRaceIconItem = self:AddComponent(UIText, AllianceArmRaceIconItem_path)--MK 
    --self.tipIconContainer = self:AddComponent(UIBaseContainer, tipIconContainer_path)--MK 
    self.infoTxt = self:AddComponent(UIText, infoTxt_path)
    self.rankBtn = self:AddComponent(UIButton, rankBtn_path)
    self.rankBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
       self:OnClickRankBtn()
    end)
    self.leftImg = self:AddComponent(UIImage, leftImg_path)
    self.rightImg = self:AddComponent(UIImage, rightImg_path)
    self.valuaTipsTxt = self:AddComponent(UIText, valuaTipsTxt_path)
    self.scoreBtn = self:AddComponent(UIButton, scoreBtn_path)
    self.scoreBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickScoreBtn()
    end)
    self.botttomTipTxt = self:AddComponent(UIText, botttomTipTxt_path)
    self.gotoLegBtn = self:AddComponent(UIButton, gotoLegBtn_path)
    self.gotoLegBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickGotoLegBtn()
    end)
    self.bottomLegGo = self:AddComponent(UIBaseContainer, bottomLegGo_path)
    self.noAllianceGo = self:AddComponent(UIBaseContainer, noAllianceGo_path)
    self.noAllianceTxt = self:AddComponent(UIText, noAllianceTxt_path)
    self.legIconImg = self:AddComponent(UIImage, legIconImg_path)
    self.conditionItem = self:AddComponent(UIBaseContainer, conditionItem_path)
    self.bottomDesTxt = self:AddComponent(UIText, bottomDesTxt_path)
    self.Viewport1 = self:AddComponent(UIBaseContainer, Viewport1_path)
    self.firstGroupGo = self.Viewport1
    self.Viewport2 = self:AddComponent(UIBaseContainer, Viewport2_path)
    self.secondGroupGo = self.Viewport2
    self.firstBoxes = {}
    table.insert(self.firstBoxes, self:AddComponent(AllianceArmsBox, groupBox1_path))
    table.insert(self.firstBoxes, self:AddComponent(AllianceArmsBox, groupBox2_path))
    table.insert(self.firstBoxes, self:AddComponent(AllianceArmsBox, groupBox3_path))
    self.secondBoxes = {}
    table.insert(self.secondBoxes, self:AddComponent(AllianceArmsBox, groupBox4_path))
    table.insert(self.secondBoxes, self:AddComponent(AllianceArmsBox, groupBox5_path))
    table.insert(self.secondBoxes, self:AddComponent(AllianceArmsBox, groupBox6_path))
    --self.groupBox1 = self:AddComponent(UIText, titleBg_path)
    --self.groupBox2 = self:AddComponent(UIText, titleBg_path)
    --self.groupBox3 = self:AddComponent(UIText, titleBg_path)
    --self.groupBox4 = self:AddComponent(UIText, titleBg_path)
    --self.groupBox5 = self:AddComponent(UIText, titleBg_path)
    --self.groupBox6 = self:AddComponent(UIText, titleBg_path)
    self.infoBtn = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickInfoBtn()
    end)
    self.scoreCardBtn = self:AddComponent(UIButton, scoreCardBtn_path)
    --self.scoreCardBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
    --    self:OnClickScoreCardBtn()
    --end)
    self.scoreCardIcon = self:AddComponent(UIImage, scoreCardIcon_path)
    self.scoreCardName = self:AddComponent(UIText, scoreCardName_path)
    self.scoreCardGo = self:AddComponent(UIBaseContainer, scoreCardGo_path)
    self.scoreCardBgBtn = self:AddComponent(UIButton, scoreCardBgBtn_path)
    --self.scoreCardBgBtn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
    --    self:OnClickScoreCardBgBtn()
    --end)
    self.cardItem = self:AddComponent(UIBaseContainer, cardItem_path)
    --self.conditionTrs = self:AddComponent(UIBaseContainer, conditionTrs_path)
    self.slider1 = self:AddComponent(AllianceScoreProg, slider1_path)
    self.slider2 = self:AddComponent(AllianceScoreProg, slider2_path)
    self.contentVerticalGroup = self:AddComponent(UIBaseContainer, contentVerticalGroup_path)
    self.contentSv = self:AddComponent(UIBaseContainer, contentSv_path)
    self.readyTip1 = self:AddComponent(UIText, readyTip1_path)
    self.readyTip1:SetLocalText(361030) 
    self.readyTip2 = self:AddComponent(UIText, readyTip2_path)
    self.readyTip2:SetLocalText(361031) 
end

local function ComponentDestroy(self)
    
end

local function InitUI(self)
    self:RefreshAll()
    local actInfo = DataCenter.ActivityListDataManager:GetActivityDataById(EnumActivity.AllianceCompete.ActId)
    if actInfo then
        SFSNetwork.SendMessage(MsgDefines.ActivityEventInfoGet,tostring(actInfo.activityId))
    end
end

local function RefreshAll(self)
    self:SetActive(true)
    self.curPage = 1
    self.leftBtn:SetActive(false)
    local showArrow = LuaEntry.DataConfig:CheckSwitch("armsbox_only_3")
    self.rightBtn:SetActive(showArrow)
    self.activityInfo = DataCenter.ActivityListDataManager:GetActivityDataById(EnumActivity.AllianceCompete.ActId)
    self:RefreshData(true)
end

local function RefreshData(self)
    self.RewardTips:SetActive(false)
    self.titleTxt:SetLocalText(self.activityInfo.activityName)
    self.titleName:SetLocalText(372284)
    self.descTxt:SetLocalText(self.activityInfo.desc_info) 
    self.myScorePreTxt:SetLocalText(361029) 
    if self.activityInfo.ranking == nil or self.activityInfo.ranking <= 0 then
        self.rankTxt:SetText("+999") 
    else
        self.rankTxt:SetText(self.activityInfo.ranking)
    end
    self.infoTxt:SetLocalText(370018) 

    --.rankGo:SetActive(false)
    --self.scoreGo:SetActive(false)
    self.goldGo:SetActive(false)
    self.infoBtn.gameObject:SetActive(false)

    self:OpenTimer()
    if self:IsShowReady() then
        self.readyGo:SetActive(true)
        self.boxContainer:SetActive(false)
        self.scoreCardBtn:SetActive(false)
        return
    else
        --self.rankGo:SetActive(true)
        --self.scoreGo:SetActive(true)
        self.goldGo:SetActive(true)
        self:RefreshScoreCard()
    end

    self.boxContainer:SetActive(true)
    self.eventInfo = self.activityInfo:GetEventInfo()
    if self.eventInfo == nil then
        return
    end
    local myAllianceId = LuaEntry.Player:GetAllianceUid()
    if myAllianceId ~= nil and self.eventInfo.vsAllianceList ~= nil then
        local myScore = 0
        local vs = self.eventInfo.vsAllianceList[myAllianceId]
        if vs ~= nil then
            myScore = self.eventInfo.vsAllianceList[myAllianceId].alScore
        end
        local scoreStr = string.GetFormattedStr(myScore)
        self.myScoreTxt:SetText(scoreStr)
        self.infoBtn:SetActive(false)
    else
        self.myScoreTxt:SetText(0)
        if self.eventInfo.vsAllianceList == nil then
            --self.rankGo:SetActive(false)
            --self.scoreGo:SetActive(false)
            self.infoBtn.gameObject:SetActive(true)
        end
    end
    --暂注:策划需求调整,目前不先不使用此逻辑
    -- local isInAlliance = AllianceManager:isInAlliance()
    -- if isInAlliance then
    --     self.conditionTrs.gameObject:SetActive(true)
    --     self.noAllianceGo:SetActive(false)
    -- else
    --     self.conditionTrs.gameObject:SetActive(false)
    --     self.noAllianceGo:SetActive(true)
    -- end
    -- printInfo("self.eventInfo.currentScore="..self.eventInfo.currentScore)
    local score = string.GetFormattedSeperatorNum(tostring(self.eventInfo.currentScore))
    self.goldNum:SetText(score)
    local curTime =  UITimeManager:GetInstance():GetServerTime()
    self.readyGo:SetActive(curTime < self.eventInfo.startTime)

    self.firstGroupGo:SetActive(false)
    self.secondGroupGo:SetActive(true)

    self.curPage = 1
    self:RefreshGroupBoxes(0 , 1)
    self:SetProgress()
    self:RefreshCondition()
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.contentVerticalGroup.transform)
end

local function OpenTimer(self)
    if self.deltaTimer == nil then
        self.deltaTimer = TimerManager:GetInstance():GetTimer(1, self.OnTimer , self, false,false,false)
        self.deltaTimer:Start()
        --self.deltaTimer = DeltaTimer.New(function ()
        --    self:OnTimer()
        --end, 1, -1, true)
        --self.deltaTimer:Start()
    else
        self.deltaTimer:Reset()
    end
    self:OnTimer()
end

local function IsShowReady(self)
    local isReady = false
    local curTime = tonumber(UITimeManager:GetInstance():GetServerTime())
    local readyTime = self.activityInfo.readyTime
    local endTime = self.activityInfo.endTime
    if readyTime < curTime and endTime > 0  then
        if self.activityInfo.startTime > curTime then
            isReady = true
        end
    end
    return isReady
end

local function RefreshScoreCard(self)
    self.scoreCardBtn:SetActive(false)
    --
    --local buffDataManager = GameEntry.Data.BuffData
    --self.buffData  = buffDataManager:GetBuffByType(self.CardItemType)
    --if self.buffData ~= nil then
    --    local buffTable = CS.LF.LuaHelper.Table:GetDataRow(CSTableName.Status, self.buffData.BuffId);
    --    if buffTable == nil then
    --        printInfo("未查找到配置表Status数据，self.buffData.BuffId="..self.buffData.BuffId)
    --        return
    --    end
    --    self.buffId = self.buffData.BuffId
    --    local icon = buffTable:GetString("icon")
    --    self.scoreCardName:SetText({"151328"})
    --    SetSpriteOfImage(self.scoreCardIcon, CS.LFDefines.AtlasAssets.ItemIcons, icon)
    --    -- scoreCardBtn
    --    self.scoreCardBtn.gameObject:SetActive(true)
    --else
    --    self.scoreCardBtn.gameObject:SetActive(false)
    --end

end

local function RefreshGroupBoxes(self, formIndex , toIndex)
    if self.firstGroupGo:GetActive() == false then
        self.firstGroupGo:SetActive(true)
        self.secondGroupGo:SetActive(false)
        self.boxUIList = {}
        for i = 1  , 3 do
            local box = self.firstBoxes[i]
            local index = (toIndex-1)*3 + i
            local isGet = self:GetBoxReceiveState(index)
            box:SetBoxInfo(index,isGet,self.eventInfo.gemPriceList[index])
            box:ShowDiamond(true)
            box:SetLocked(index)
            --MK CS方法 UIPersonalArmsBoxCtrl.cs
            --box:SetBoxInfo(index,isGet,self.eventInfo.gemPriceList[index])
            --box:ShowDiamond(true)
            --box:SetLocked(index)
        end
    elseif self.secondGroupGo:GetActive() == false then
        self.firstGroupGo:SetActive(false)
        self.secondGroupGo:SetActive(true)
        --同时初始化toIndex
        for i = 1  , 3 do
            local box = self.secondBoxes[i]
            local index = (toIndex-1)*3 + i
            local isGet = self:GetBoxReceiveState(index)
            box:SetBoxInfo(index,isGet,self.eventInfo.gemPriceList[index])
            box:ShowDiamond(true)
            box:SetLocked(index)
            --MK CS方法
            --box:SetBoxInfo(index,isGet,self.eventInfo.gemPriceList[index])
            --box:ShowDiamond(true)
            --box:SetLocked(index)
        end
    end
end

local function SetProgress(self)
    local curScore, score1 ,  score2 , score3
    curScore = tonumber(self.eventInfo.currentScore)
    local tempInitScore = 0
    local count = #self.eventInfo.targetList
    for i = 1 , 3 do
        local fd = math.fmod(i , 3)
        local index = 0
        if fd == 1 then
            index = (self.curPage-1)*3 + fd
            score1 = tonumber(self.eventInfo.targetList[index])
        elseif fd == 2  then
            index =  (self.curPage-1)*3 + fd
            score2 = tonumber(self.eventInfo.targetList[index])
        elseif fd == 0 then
            index = self.curPage*3
            score3 = tonumber(self.eventInfo.targetList[index])
        end
    end
    sliderDataTb[1].num = 0
    sliderDataTb[2].num = score1
    sliderDataTb[3].num = score2
    sliderDataTb[4].num = score3
    self.slider1:SetCurProg(curScore, sliderDataTb)
    self.slider2:SetCurProg(curScore, sliderDataTb)
    --MK UINotSameSlider.cs
    --self.slider1:SetSliderInit(curScore , score1 , score2, score3)
    --self.slider2:SetSliderInit(curScore , score1 , score2, score3)
end

local function RefreshCondition(self)
    self.conditionTrs.gameObject:SetActive(true)
    self.conditionItem.gameObject:GameObjectCreatePool();--MK:初始化
    self.conditionTrs:RemoveComponents(AllianceArmsCondition)
    self.conditionItem.gameObject:GameObjectRecycleAll()

    local count = #self.eventInfo.scoreIdListNew
    for i = 1 , count do
        local item = self.conditionItem.gameObject:GameObjectSpawn(self.conditionTrs.transform)
        item.name = "item" .. i
        local obj = self.conditionTrs:AddComponent(AllianceArmsCondition, item.name)
        obj:RefreshData(self.eventInfo.scoreIdListNew[i] , i)
    end
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.conditionTrs.transform)
    --CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.contentSv.transform)
    
end

local function OnTimer(self)
    if self.activityInfo == nil then
        self.cdTxt:SetText("")
        return;
    end
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local endTime = self.activityInfo.endTime
    local startTime = self.activityInfo.startTime
    local readyTime = self.activityInfo.readyTime
    if startTime == nil or endTime == nil then
        Logger.LogError("活动时间不正确")
        self:StopTimer()
        return
    end
    local leftTime = endTime - curTime
    --printInfo("a*************"..startTime..",endTime="..endTime..",readyTime="..readyTime..",curTime="..curTime..",leftTime="..leftTime)
    if startTime < curTime and leftTime > 0 then
        if self.readyGo ~= nil and self.readyGo:GetActiveInHierarchy() then
            self.readyGo:SetActive(false)
        end
        --self.cdTrs.transform:Set_localPosition(8,-132,0)
        self.cdTxt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(leftTime))
    elseif startTime > curTime and (curTime > readyTime) then
        local leftTime = startTime - curTime
        if self.readyGo ~= nil and self.readyGo:GetActiveInHierarchy() then
            self.readyGo:SetActive(true)
        end
        self.cdTxt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(leftTime))
        --self.cdTrs.transform:Set_localPosition(8,-280,0)
    else
        --self.cdTrs.transform:Set_localPosition(8,-280,0)
        self.cdTxt:SetText({"370100"})
        if self.readyGo ~= nil and self.readyGo:GetActiveInHierarchy() then
            self.readyGo:SetActive(true)
        end
    end
end

--获取宝箱领取状态
local function GetBoxReceiveState(self, index)
    local getFlag = nil
    local isGet = 1
    local canReceiveFlag = nil
    if self.eventInfo.rewardFlagList ~= nil then
        canReceiveFlag = self.eventInfo.rewardFlagList[index]
    end
    if canReceiveFlag ~= nil and tonumber(canReceiveFlag) == index then
        isGet = 2
    end
    if self.eventInfo.newRewardFlagList ~= nil then
        getFlag = self.eventInfo.newRewardFlagList[index]
    end
    if getFlag ~= nil and tonumber(getFlag) == index then
        isGet = 3
    end
    return isGet
end

local function StopTimer(self)
    if self.deltaTimer ~= nil then
        self.deltaTimer:Stop()
        self.deltaTimer = nil
    end
end

local function OpenRewardTips(self, index)
    if self.activityInfo ~= nil then
        --已领取
        if self.eventInfo.newRewardFlagList ~= nil and self.eventInfo.newRewardFlagList[index] == index then
            self:ShowRewardTips(index)
            return
        end
        --不可领取,查看tips
        if tonumber(self.eventInfo.currentScore) < tonumber(self.eventInfo.targetList[index]) then
            --打开tips
            self:ShowRewardTips(index)
            return
        end
        --未解锁,useNum= 0：默认1-3解锁， 1: 1-6宝箱解锁，2：1-9宝箱全部解锁, 3:再来一份
        --local useNum = LuaEntry.Effect:GetGameEffect(EffectDefine.APS_ALLIANCE_ARMS_USE_NUM)

        local unlocked = false
        if index <= 3 then
            unlocked = true
        elseif index <= 6 then
            unlocked = LuaEntry.Effect:GetGameEffect(EffectDefine.APS_ALCOMPETE_ACT_UNLOCK_BOX_2) == 1
        elseif index <= 9 then
            unlocked = LuaEntry.Effect:GetGameEffect(EffectDefine.APS_ALCOMPETE_ACT_UNLOCK_BOX_3) == 1
        end

        if not unlocked then
            self:ShowRewardTips(index)
            return
        end
        
        --if useNum == 0 and self.curPage > 1  then
        --    self:ShowRewardTips(index)
        --    return
        --elseif useNum == 1 and self.curPage > 2 then
        --    self:ShowRewardTips(index)
        --    return
        --end
        --可领取
        self.view.ctrl:SendActivityGetRewardCommand(self.eventInfo.actId , self.eventInfo.targetList[index] , self.eventInfo.type)
        --ActivityControllerInst:SendActivityGetRewardCommand(self.eventInfo.actId , self.eventInfo.targetList[index] , self.eventInfo.type)
    end
end

local function ShowRewardTips(self, index)
    local newIndex = (index - 1) % 3 + 1 
    local isUp = false
    local x = self.firstBoxes[newIndex].transform.position.x
    local y = self.firstBoxes[newIndex].transform.position.y
    local offset = 100
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIActivityRewardTip,Localization:GetString("370101", self.eventInfo.gemPriceList[index]),EnumActivity.AllianceCompete.EventType,x,y,isUp,self.eventInfo.rewardScoreIndexArr[index],offset)
    
    --[[
    --方案一 
    local rewardList = CS.ActivityController.Instance:LuaParseRewards(self.activityInfo.serverActivity , index-1)
    local dataCount = rewardList:Size()
    --方案二
    -- local rewardSfsList = CS.ActivityController.Instance:LuaParseRewards(self.activityInfo.serverActivity)   
    -- local rewardList = CS.RewardController.Instance:HandleRewardInfos(rewardSfsList)
    -- local dataCount = rewardList.Count
    local objCount = #self.itemIconList
    if dataCount > objCount then
        local needNum = dataCount - objCount
        for i = 1 , needNum do
            local item = require(ActivityPath.AllianceArmRaceIconItem).create(self.AllianceArmRaceIconItem , self.tipIconContainer)
            table.insert(self.itemIconList , item)
        end
    end
    for i = 1 , #self.itemIconList do
        local icon = self.itemIconList[i]
        if i <= dataCount then
            --方案一
            local reward = rewardList:GetSFSObject(i-1)
            --方案二
            -- local reward = rewardList[i-1]
            icon:SetData(reward)
        else
            icon:OnHide()
        end
    end
    self.RewardTips:SetActiveEx(true)
    self.bottomLegGo:SetActiveEx(false)
    local bottomOffsetState = false
    if self.curPage > 1 then
        --local scienceName = GameEntry.DataTable:GetString(CSTableName.Science, self.legendIdList[self.curPage-1], "name")
        local scienceName = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage-1], "name");
        self.botttomTipTxt:SetText({scienceName})
        --local scienceIcon = GameEntry.DataTable:GetString(CSTableName.Science, self.legendIdList[self.curPage-1], "icon")
        local scienceIcon = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage-1], "icon");
        SetSpriteOfImage(self.legIconImg, CS.LFDefines.AtlasAssets.ScienceIcons, scienceIcon);

        --local description = GameEntry.DataTable:GetString(CSTableName.Science, self.legendIdList[self.curPage-1], "description")
        local description = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage-1], "description");
        self.bottomDesTxt:SetText({description})
        local useNum = tonumber(GameEntry.Data.Effect:GetEffectValueApplyOnGlobal(220))
        if useNum == 0 then
            self.bottomLegGo:SetActiveEx(true)
            bottomOffsetState = true
        elseif useNum == 1 then
            if self.curPage == 0 then
                self.bottomLegGo:SetActiveEx(true)
                bottomOffsetState = true
            end
        elseif useNum == 2 then
            self.bottomLegGo:SetActiveEx(false)
        elseif useNum == 3 then--再来一份
            if self.curPage == 3 then
                local scienceName = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage], "name")
                self.botttomTipTxt:SetText({scienceName})
                local scienceIcon = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage], "icon")
                SetSpriteOfImage(self.legIconImg, CS.LFDefines.AtlasAssets.ScienceIcons, scienceIcon);
                local description = CS.LF.LuaHelper.Table:GetString(CS.LFDefines.TableName.Science, self.legendIdList[self.curPage-1], "description")
                self.bottomDesTxt:SetText({description})
                self.bottomLegGo:SetActiveEx(true)
                bottomOffsetState = true
            end
        end
    end

    local fd = math.fmod(index , 3)
    if fd == 1 then
        self.RewardTips.transform.localPosition = Vector3.New(-50,0,0)
        self.leftImg.gameObject:SetActiveEx(true)
        self.rightImg.gameObject:SetActiveEx(false)
    elseif fd == 2 then
        local offsetX = 0
        if bottomOffsetState == true then
            offsetX = -150
            self.leftImg.gameObject:SetActiveEx(false)
            self.rightImg.gameObject:SetActiveEx(true)
        else
            self.leftImg.gameObject:SetActiveEx(true)
            self.rightImg.gameObject:SetActiveEx(false)
            offsetX = 250
        end
        self.RewardTips.transform.localPosition = Vector3.New(offsetX,0,0)
    elseif fd == 0 then
        self.RewardTips.transform.localPosition = Vector3.New(140,0,0)
        self.leftImg.gameObject:SetActiveEx(false)
        self.rightImg.gameObject:SetActiveEx(true)
    end
    self.valuaTipsTxt:SetText({"370101",self.eventInfo.valueList[index]})
    --]]
end


local function OnClickLeftBtn(self)
    if self.curPage > 1 then
        self:RefreshGroupBoxes(self.curPage , self.curPage - 1 , true)
        self.curPage = self.curPage - 1
        if self.curPage < 3 then
            self.rightBtn:SetActive(true)
        end
        if self.curPage == 1 then
            self.leftBtn:SetActive(false)
        end
    else
        return
    end
    self:SetProgress()
end

local function OnClickRightBtn(self)
    if self.curPage < 3 then
        self:RefreshGroupBoxes(self.curPage , self.curPage + 1 , true)
        self.curPage = self.curPage + 1
        if self.curPage > 1 then
            self.leftBtn:SetActive(true)
        end
        if self.curPage == 3 then
            self.rightBtn:SetActive(false)
        end
    else
        return
    end
    self:SetProgress()
end

local function OnClickRankBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceCompeteRank, { anim = true })
end

local function OnClickCloseTipBtn(self)
    self.RewardTips:SetActiveEx(false)
end

local function OnClickGotoLegBtn(self)
    
end

local function OnClickInfoBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.infoBtn.transform.position + Vector3.New(-20, 0, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString("361074")
    param.dir = UIHeroTipView.Direction.LEFT
    param.defWidth = 180
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
    
    --MK 打开通用界面
    --CS.LFCommonTitleTip.Show(CS.LFCommonTips.Direction.LEFT, "", _lang("361074"), "", Vector2.New(position.x - 1.5, position.y - 0.06), 1.0, 250, nil)
end

local function OnClickScoreCardBgBtn(self)
    --self.scoreCardGo:SetActiveEx(false)
    --self:StopCardTimer()
end

local function OnClickScoreCardBtn(self)
    --self.scoreCardGo:SetActiveEx(true)
    --self:StopCardTimer()
    --self:InitScoreCard()
end

local function OnClickScoreBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceCompeteMain, { anim = true, UIMainAnim = UIMainAnimType.AllHide })
    self.view.ctrl:CloseSelf()
end



AllianceArmsActivityMain.OnCreate = OnCreate
AllianceArmsActivityMain.OnDestroy = OnDestroy
AllianceArmsActivityMain.ComponentDefine = ComponentDefine
AllianceArmsActivityMain.ComponentDestroy = ComponentDestroy
AllianceArmsActivityMain.OnAddListener = OnAddListener
AllianceArmsActivityMain.OnRemoveListener = OnRemoveListener

AllianceArmsActivityMain.InitUI = InitUI
AllianceArmsActivityMain.RefreshAll = RefreshAll
AllianceArmsActivityMain.RefreshData = RefreshData
AllianceArmsActivityMain.OpenTimer = OpenTimer
AllianceArmsActivityMain.IsShowReady = IsShowReady
AllianceArmsActivityMain.RefreshScoreCard = RefreshScoreCard
AllianceArmsActivityMain.RefreshGroupBoxes = RefreshGroupBoxes
AllianceArmsActivityMain.SetProgress = SetProgress
AllianceArmsActivityMain.RefreshCondition = RefreshCondition
AllianceArmsActivityMain.OnTimer = OnTimer
AllianceArmsActivityMain.GetBoxReceiveState = GetBoxReceiveState
AllianceArmsActivityMain.StopTimer = StopTimer
AllianceArmsActivityMain.OpenRewardTips = OpenRewardTips
AllianceArmsActivityMain.ShowRewardTips = ShowRewardTips

AllianceArmsActivityMain.OnClickLeftBtn = OnClickLeftBtn
AllianceArmsActivityMain.OnClickRightBtn = OnClickRightBtn
AllianceArmsActivityMain.OnClickRankBtn = OnClickRankBtn
AllianceArmsActivityMain.OnClickCloseTipBtn = OnClickCloseTipBtn
AllianceArmsActivityMain.OnClickGotoLegBtn = OnClickGotoLegBtn
AllianceArmsActivityMain.OnClickInfoBtn = OnClickInfoBtn
AllianceArmsActivityMain.OnClickScoreCardBgBtn = OnClickScoreCardBgBtn
AllianceArmsActivityMain.OnClickScoreCardBtn = OnClickScoreCardBtn
AllianceArmsActivityMain.OnClickScoreBtn = OnClickScoreBtn


return AllianceArmsActivityMain