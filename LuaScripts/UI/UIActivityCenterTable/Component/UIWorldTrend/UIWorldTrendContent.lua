---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime: 
---
local UIWorldTrendContent = BaseClass("UIWorldTrendContent", UIBaseContainer)
local base = UIBaseContainer
local WorldTrendWeekCell = require "UI.UIActivityCenterTable.Component.UIWorldTrend.WorldTrendWeekCell"
local WorldTrendTab = require "UI.UIActivityCenterTable.Component.UIWorldTrend.WorldTrendTab"
local UIWorldTrendRewardItem = require "UI.UIActivityCenterTable.Component.UIWorldTrend.UIWorldTrendRewardItem"
local Localization = CS.GameEntry.Localization
local defaultColor = Color32.New(220/255.0, 120/255.0, 39/255.0, 1)

-- 创建
function UIWorldTrendContent:OnCreate()
    base.OnCreate(self)
    
    self._weekName_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Txt_WeekName")
    
    self.weekContent   = self:AddComponent(UIBaseContainer,"Rect_Bg/Rect_Week")
    self._rect_img     = self:AddComponent(UIImage,"Rect_Bg/Img_BgIcon")
    self._title_txt    = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_TaskInfo/Txt_Title")
    self._completes_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_TaskInfo/Txt_Completes")
    self._taskPro_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_TaskInfo/Txt_TaskPro")
    self._time_txt     = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_TaskInfo/Rect_Time/Txt_Time")
    self._time_img     = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_TaskInfo/Rect_Time/Img_TimeIcon")

    self.rewardList = {}
    local tempItem = self:AddComponent(UIBaseContainer, "Rect_Bg/ScrollView/Viewport/Content")
    for i = 1, 3 do
        self.rewardList[i] = tempItem:AddComponent(UIWorldTrendRewardItem, "UIRewardCell"..i)
        self.rewardList[i]:SetActive(false)
    end

    self.funcList = {}
    for i = 1, 3 do
        self.funcList[i] = {}
        self.funcList[i].btn = tempItem:AddComponent(UIButton, "Btn_FuncBg"..i)
        self.funcList[i].btn:SetOnClick(function()
            self:OnClickFuncUnlock(i)
        end)
        self.funcList[i].Unlock = tempItem:AddComponent(UIImage,"Btn_FuncBg"..i.."/Img_FuncUnlock"..i)
        self.funcList[i].UnlockCopy = tempItem:AddComponent(UIImage,"Btn_FuncBg"..i.."/Img_FuncUnlockCopy"..i)
    end
    
    self.tabList = self:AddComponent(WorldTrendTab, "Rect_Bg/Rect_Tab")
    
    self._rect_reward = self:AddComponent(UIBaseContainer,"Rect_Bg/Rect_Reward")
    self._reward_txt   = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_Reward/Txt_Reward")
    self._reward_txt:SetLocalText(170008)

    self._reward_btn = self:AddComponent(UIButton,"Rect_Bg/Btn_Reward")
    self._reward_btn:SetOnClick(function()
        self:OnBtnClick()
    end)
    self._btnReward_txt   = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Btn_Reward/Txt_BtnReward")
    self._btnReward_txt:SetLocalText(170004)

    self._lvTips_lv = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Txt_LvTips")

    self._rank_rect = self:AddComponent(UIBaseContainer,"Rect_Bg/Rect_Rank")
    self._complete_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Rect_Rank/Txt_Complete")
    self._rank_btn = self:AddComponent(UIButton,"Rect_Bg/Rect_Rank/Btn_Rank")
    self._rank_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickSendRank()
    end)
    
    self._taskState_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bg/Txt_TaskState")
    
    self._taskInfo_rect = self:AddComponent(UIBaseContainer,"Rect_Bg/Rect_TaskInfo")

    self.timer = nil
    self.timer_action = function()
        self:RefreshTime()
    end
end

-- 销毁
function UIWorldTrendContent:OnDestroy()
    base.OnDestroy(self)
    self:DeleteTimer()
end

-- 显示
function UIWorldTrendContent:OnEnable()
    base.OnEnable(self)
end

-- 隐藏
function UIWorldTrendContent:OnDisable()
    base.OnDisable(self)
end

-- 全部刷新
function UIWorldTrendContent:ReInit(weekList,targetWeek,targetIndex)
    self:DeleteTimer()
    self.weekList = weekList
    if self.weekCell and table.count(self.weekCell) > 0 then
        for i = 1, #self.weekCell do
            self.weekCell[i]:ReInit(self.weekList[i],i, function(week,index)
                self:ClickWeek(week,index)
            end)
        end
        if self.targetWeek and self.targetIndex then
            self:ClickWeek(self.targetWeek,self.targetIndex)
        end
    else
        self:SetAllCellDestroy()
        self.model = {}
        self.weekCell = {}
        for i = 1, #self.weekList do
            --复制基础prefab，每次循环创建一次
            self.model[i] = self:GameObjectInstantiateAsync(UIAssets.WorldTrendWeekCell, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.weekContent.transform)
                go.transform:Set_localScale(1,1,1)
                go.name ="week" .. i
                local cell = self.weekContent:AddComponent(WorldTrendWeekCell,go.name)
                cell:ReInit(self.weekList[i],i, function(week,index)
                    self:ClickWeek(week,index)
                end)
                self.weekCell[i] = cell
                if targetWeek and targetWeek == i then
                    cell:OnClickWeek(targetIndex)
                end
            end)
        end
        self.tabList:SetCallBack(function(info,index) self:OnClickTab(info,index) end)
    end
    
    if DataCenter.WorldTrendManager.NewOngoing and DataCenter.WorldTrendManager.NewOngoing ~= 0 then
        --local id = Setting:GetPrivateInt(SettingKeys.LAST_WORLD_TREDN, 0)
        Setting:SetPrivateInt(SettingKeys.LAST_WORLD_TREDN, tonumber(DataCenter.WorldTrendManager.NewOngoing))
    end
end


function UIWorldTrendContent:SetAllCellDestroy()
    self.weekContent:RemoveComponents(WorldTrendWeekCell)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
end

--切换周
function UIWorldTrendContent:ClickWeek(week,targetIndex)
    local list = self.weekList[week]
    self.targetWeek = week
    for i = 1, #self.weekCell do
        self.weekCell[i]:SetSelect(i == week)
    end

    self.tabList:ReInit(list)

    if targetIndex then
        self:OnClickTab(list[targetIndex],targetIndex)
    else
        self:OnClickTab(list[1],1)
    end
end

function UIWorldTrendContent:OnClickTab(info,index)
    self.curInfo = info
    self.targetIndex = index
    self.tabList:SetSelect(index)

    local str = string.split(self.curInfo.show_type,";")
    
    local week = Localization:GetString("372632",str[1])
    self._weekName_txt:SetText(week..": "..Localization:GetString(str[2]))
    self:DeleteTimer()
    self._time_txt:SetText("")
    self._rect_reward:SetActive(false)
    self._lvTips_lv:SetActive(false)
    self._reward_btn:SetActive(false)
    self._lvTips_lv:SetLocalText(302235,self.curInfo.levelLimit)
    self.isReceiveReward = false        --是否能领奖
    for i = 1 ,3 do
        self.funcList[i].btn:SetActive(false)
    end

    for i = 1, 3 do
        self.rewardList[i]:SetActive(false)
        self.rewardList[i]:SetRewardState(false)
        self.rewardList[i]:SetReceiveState(false)
        self.rewardList[i]:SetQuestState(false)
    end
    
    --设置奖励
    self:SetReward(false)
    --默认奖励状态
    self:SetRewardState(false)

    self:SetItemState()
end

--设置条目状态
function UIWorldTrendContent:SetItemState()

    local template = DataCenter.WorldTrendTemplateManager:GetTemplateById(self.curInfo.id)
    if template == nil  then
        return
    end
    self._rect_img:LoadSprite(template:GetIcon(true))
    self._title_txt:SetLocalText(template.name)
    self._completes_txt:SetText(template:GetDesc())
    self._complete_txt:SetText("")
    self._taskState_txt:SetActive(false)
    self._taskPro_txt:SetText("")
    self._taskPro_txt:SetText(Localization:GetString("310000")..Localization:GetString("150033",self.curInfo.taskNum, self.curInfo.taskNeedNum))
    --type 7 18 20 联盟相关
    self._rank_rect:SetActive(self.curInfo.type == 7 or self.curInfo.type == 18 or self.curInfo.type == 20)

    if self.curInfo.type == 7 or self.curInfo.type == 18 or self.curInfo.type == 20 then
        self._taskInfo_rect:SetAnchoredPositionXY(278,57)
        self:SetAllianceTips(true)
    else
        self._taskInfo_rect:SetAnchoredPositionXY(278,111)
    end
    
    local curTime = UITimeManager:GetInstance():GetServerTime()
    if self.curInfo.status == DataCenter.WorldTrendManager.ServerTrendsStatus.Prepare then
        --未开始
        self:SetReward(true)
        self._taskState_txt:SetActive(true)
        self._taskState_txt:SetLocalText(372853)
        --即将开启
        --local isAboutToOpen = self.curInfo.startTime > 0 and self.curInfo.startTime > curTime
        --if isAboutToOpen then
            self:RefreshTime()
            self:AddTimer()
        --else
            --未开启
            --self._time_img:SetActive(false)
            --self._time_txt:SetLocalText(120018)
        --end
    elseif self.curInfo.status == DataCenter.WorldTrendManager.ServerTrendsStatus.Ongoing then
        --进行中
        self._taskPro_txt:SetText(Localization:GetString("310000")..Localization:GetString("150033",self.curInfo.taskNum, self.curInfo.taskNeedNum))
        self:SetReward(false)
        if self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.Received then
            --已领取
            self:InitFinishAcceptReward()
            self._rect_reward:SetActive(true)
        elseif self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.Unreceived then
            --可领奖
            self._reward_btn:SetActive(true)
            if self.curInfo.levelLimit > DataCenter.BuildManager.MainLv then
                self.isReceiveReward = false
                self._lvTips_lv:SetActive(true)
            else
                self.isReceiveReward = true
            end
            self:SetReceiveState(self.isReceiveReward)
            self._time_img:SetActive(false)
            self._time_txt:SetText(Localization:GetString("390979",UITimeManager:GetInstance():TimeStampToDayForLocal(self.curInfo.finishTime)))   --于xx时间完成
        elseif self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.NotSuccess then
            if self.curInfo.endTime == 0 then
                self._time_img:SetActive(false)
                 self._time_txt:SetText("")
            else
                --开启倒计时
                self:RefreshTime()
                self:AddTimer()
                self._taskState_txt:SetActive(true)
                self._taskState_txt:SetLocalText(302049)
            end
        end
    elseif self.curInfo.status == DataCenter.WorldTrendManager.ServerTrendsStatus.Fail then
        --截止时间未完成
        self:SetReward(false)
        self._time_img:SetActive(false)
        self._time_txt:SetText(template:GetQuestTypeContent())   --未达成或者所在联盟未达成
        self._taskState_txt:SetActive(true)
        self._taskState_txt:SetLocalText(170009)
    elseif self.curInfo.status == DataCenter.WorldTrendManager.ServerTrendsStatus.Finish then
        --已完成
        self:SetReward(false)
        if self.curInfo.type == 7 or self.curInfo.type == 18 or self.curInfo.type == 20 then
            self:SetAllianceTips()
        end
        if self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.NotJoin then
            self:InitFinishAcceptReward()
        elseif self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.Unreceived then
            --可领奖
            if self.curInfo.levelLimit > DataCenter.BuildManager.MainLv then
                self.isReceiveReward = false
                self._lvTips_lv:SetActive(true)
            else
                self._reward_btn:SetActive(true)
                self.isReceiveReward = true
            end
            self:SetReceiveState(self.isReceiveReward)
            self._time_img:SetActive(false)
            self._time_txt:SetText(Localization:GetString("390979",UITimeManager:GetInstance():TimeStampToDayForLocal(self.curInfo.finishTime)))   --于xx时间完成
        elseif self.curInfo.rewardStatus == DataCenter.WorldTrendManager.ServerTrendsRewardStatus.Received then
            --已领奖
            self:InitFinishAcceptReward()
            self._rect_reward:SetActive(true)
        end
    end
end

--设置奖励
function UIWorldTrendContent:SetReward(isGary)
    if self.curInfo.rewardList then
        for i = 1, #self.curInfo.rewardList do
            if self.rewardList[i] then
                self.rewardList[i]:SetActive(true)
                self.rewardList[i]:RefreshData(self.curInfo.rewardList[i])
                self.rewardList[i]:SetQuestState(isGary)
            end
        end 
        if self.curInfo.functionIds and next(self.curInfo.functionIds) then
            for i = 1 ,table.count(self.curInfo.functionIds) do
                if self.funcList[i] then
                    self.funcList[i].btn:SetActive(true)
                    local template = DataCenter.WorldTrendTemplateManager:GetFuncInfoById(self.curInfo.functionIds[i])
                    self.funcList[i].Unlock:LoadSprite(template:GetIcon(), nil, function()
                        self.funcList[i].Unlock:SetNativeSize()
                    end)
                    self.funcList[i].UnlockCopy:SetActive(isGary)
                    self.funcList[i].UnlockCopy:LoadSprite(template:GetIcon(), nil, function()
                        self.funcList[i].UnlockCopy:SetNativeSize()
                    end)
                end
            end
        end
    end
end

function UIWorldTrendContent:InitFinishAcceptReward()
    self:SetRewardState(true)
    self._time_img:SetActive(false)
    self._time_txt:SetText(Localization:GetString("390979",UITimeManager:GetInstance():TimeStampToDayForLocal(self.curInfo.finishTime)))
end

--设置奖励状态
function UIWorldTrendContent:SetRewardState(isReceive)
    if self.curInfo.rewardList then
        for i = 1, #self.curInfo.rewardList do
            if self.rewardList[i] then
                self.rewardList[i]:SetRewardState(isReceive)
            end
        end
    end
end

--设置是否可领奖设置特效
function UIWorldTrendContent:SetReceiveState(isReceive)
    if self.curInfo.rewardList then
        for i = 1, #self.curInfo.rewardList do
            if self.rewardList[i] then
                self.rewardList[i]:SetReceiveState(isReceive)
            end
        end
    end
    --self._itemEffect_rect:SetActive(isReceive)
end

function UIWorldTrendContent:SetAllianceTips(default)
    if default then
        self._complete_txt:SetLocalText(110535)
    else
        local rankInfo = DataCenter.WorldTrendManager.rankInfo
        local cond = ""
        if rankInfo and next(rankInfo) then
            -- self._allianceTips_txt:SetActive(true)
            for i = 1 ,table.count(rankInfo) do
                if i > 1 then
                    cond = cond .. "、"
                end
                cond = cond .."["..rankInfo[i].abbr.."]"..rankInfo[i].fullName
            end
        end
        self._complete_txt:SetText(Localization:GetString("302723")..cond)
    end
   
   -- self._allianceTips_txt:SetText(Localization:GetString("302723")..cond)
end

function UIWorldTrendContent:AddTimer()
    if self.curInfo.endTime == 0 then
        return
    end
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end
    self.timer:Start()
end

function UIWorldTrendContent:DeleteTimer()
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

function UIWorldTrendContent:RefreshTime()
    local curTime = UITimeManager:GetInstance():GetServerTime()
    --未开始
    if self.curInfo.startTime > curTime then
        self._time_img:SetActive(true)
        self._time_txt:SetLocalText(302178,UITimeManager:GetInstance():MilliSecondToFmtString(self.curInfo.startTime - curTime))
    elseif self.curInfo.startTime - curTime <= 0 or self.param.endTime > curTime  then
        --进行中
        --self._questState_txt:SetActive(false)
        --self._timeLayout:SetActive(false)
        --self._progress_img:SetActive(true)
        self:SetReward(false)
        self._time_img:SetActive(true)
        self._time_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString((self.curInfo.endTime - curTime)))
    elseif self.param.endTime - curTime <= 0 then
        --已结束
        self:DeleteTimer()
        self:SetItemState()
        --self:SetUnlockTxt()
    end
end

--请求领奖
function UIWorldTrendContent:OnBtnClick()
    if self.isReceiveReward then
        DataCenter.WorldTrendManager:SendServerTrendsReward(self.curInfo.id)
    else
        UIUtil.ShowTips(Localization:GetString("302235",self.curInfo.levelLimit))
    end
end

function UIWorldTrendContent:OnClickFuncUnlock(index)
    if self.curInfo.functionIds and next(self.curInfo.functionIds) and self.curInfo.functionIds[index] then
        local template = DataCenter.WorldTrendTemplateManager:GetFuncInfoById(self.curInfo.functionIds[index])
        local param = {}
        param["title"] = template:GetName()
        param["desc"] = template:GetDesc()
        param["alignObject"] = self.funcList[index].Unlock
        param.type = "desc"
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemTips,{anim = true}, param)
    end
end

--请求排行榜信息
function UIWorldTrendContent:OnClickSendRank()
    DataCenter.WorldTrendManager:SetParam(self.curInfo)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIWorldTrendRank,{anim = true},self.curInfo.id)
    --DataCenter.WorldTrendManager:SendServerTrendsRank(self.param.id)
end


return UIWorldTrendContent