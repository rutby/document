---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime: 
---
local ActSevenDayItem = BaseClass("ActSevenDayItem",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local RewardUtil = require "Util.RewardUtil"
local ActivityRewardItem = require "UI.UIActivityCenterTable.Component.UIActivitySevenDay.ActivityRewardItem"
local UIGray = CS.UIGray
local Txt_Name = "Txt_Name"
local Txt_Score = "Txt_Score"
local Txt_TaskTarget = "Txt_TaskTarget"
local Btn_Reward = "Btn_Reward"
local Txt_Reward = "Btn_Reward/Txt_Reward"
local Txt_Gray = "Btn_Reward/Txt_Gray"
local Btn_Go = "Btn_Go"
local Txt_Go = "Btn_Go/Txt_Go"
local Btn_Locked = "Btn_Locked"
local Txt_Locked = "Btn_Locked/Txt_Locked"
local Txt_Completed = "Txt_Completed"
local Img_integral = "Txt_Score/Img_integral"
local Rect_Reward = "Rect_Reward"
function ActSevenDayItem:OnCreate()
    base.OnCreate(self)
    
    --任务名称
    self._name_txt = self:AddComponent(UITextMeshProUGUI,Txt_Name)

    --任务积分
    self._score_txt  = self:AddComponent(UITextMeshProUGUI,Txt_Score)
    
    self._taskTarget_txt = self:AddComponent(UITextMeshProUGUI,Txt_TaskTarget)

    self._reward_btn = self:AddComponent(UIButton,Btn_Reward)
    self._reward_txt = self:AddComponent(UITextMeshProUGUI,Txt_Reward)
    self._gray_txt = self:AddComponent(UITextMeshProUGUI,Txt_Gray)
    self._gray_txt:SetLocalText(170004) 
    self._reward_txt:SetLocalText(170004) 
    self._reward_btn:SetOnClick(function()
        self:OnClickReward()
    end)

    self._go_btn = self:AddComponent(UIButton,Btn_Go)
    self._go_txt = self:AddComponent(UITextMeshProUGUI,Txt_Go)
    self._go_txt:SetLocalText(110003) 
    self._go_btn:SetOnClick(function()
        self:OnClickGo()
    end)
    
    self._locked_btn = self:AddComponent(UIButton, Btn_Locked)
    UIGray.SetGray(self._locked_btn.transform, true)
    self._locked_txt = self:AddComponent(UITextMeshProUGUI, Txt_Locked)
    self._locked_txt:SetLocalText(120050)
    
    --self._completed_img = self:AddComponent(UIImage,"Img_Completed")
    self._completed_txt = self:AddComponent(UITextMeshProUGUI,Txt_Completed)
    self._completed_txt:SetLocalText(170008) 

    self.rewardRect = self:AddComponent(UIBaseContainer, Img_integral)

    self.content = self:AddComponent(UIBaseContainer,Rect_Reward)
end

function ActSevenDayItem:OnDestroy()
    self:SetAllCellDestroy()
    self._name_txt = nil
    self._score_txt = nil
    
    base.OnDestroy(self)
end

function ActSevenDayItem:OnEnable()
    base.OnEnable(self)
end

function ActSevenDayItem:OnDisable()

    base.OnDisable(self)
end

function ActSevenDayItem:RefreshData(param,days)
    self.param = param
    self.taskId = param.id
    self.taskValue = DataCenter.TaskManager:FindTaskInfo(self.taskId)
    self.template = LocalController:instance():getLine(DataCenter.QuestTemplateManager:GetTableName(), self.taskId)
    if param.day > days then
        -- 未解锁
        self._reward_btn:SetActive(false)
        self._go_btn:SetActive(false)
        self._locked_btn:SetActive(true)
        self._completed_txt:SetActive(false)
    else
        local state = self.taskValue.state
        if state == 2 then
            --已领取
            self._reward_btn:SetActive(false)
            self._go_btn:SetActive(false)
            self._locked_btn:SetActive(false)
            self._completed_txt:SetActive(true)
        elseif state == 1 then
            --可领取
            self._reward_btn:SetActive(true)
            self._go_btn:SetActive(false)
            self._locked_btn:SetActive(false)
            self._completed_txt:SetActive(false)
            self._reward_txt:SetActive(true)
            self._gray_txt:SetActive(false)
            UIGray.SetGray(self._reward_btn.transform, false, true)
        else
            self._locked_btn:SetActive(false)
            self._completed_txt:SetActive(false)
            --前往
            if self.template.gotype2 > 0 then
                self._go_btn:SetActive(true)
                self._reward_btn:SetActive(false)
            else
                self._reward_btn:SetActive(true)
                self._go_btn:SetActive(false)
                self._reward_txt:SetActive(false)
                self._gray_txt:SetActive(true)
                UIGray.SetGray(self._reward_btn.transform, true, false)
            end
        end
    end

    -- local isProcess = questXml:GetInt("progress")
    local process = ""
    local feizi = self.taskValue.num        
    local feimu = self.template.para2
    if (feizi - feimu) >= 0 then
        feizi = feimu
    end
    feizi = string.GetFormattedSeperatorNum(feizi)
    feimu = string.GetFormattedSeperatorNum(feimu)
    process = "("..feizi.."/"..feimu..")"
    self._name_txt:SetText(DataCenter.QuestTemplateManager:GetDesc(self.template))
    
    self._taskTarget_txt:SetText(process)

    self._score_txt:SetText(param.point)

    self:RefreshReward(self.taskValue.rewardList)
end

function ActSevenDayItem:SetAllCellDestroy()
    self.content:RemoveComponents(ActivityRewardItem)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
end

function ActSevenDayItem:RefreshReward(list)
    self:SetAllCellDestroy()
    self.showList = self.view.ctrl:RewardItemList(list)
    self.model = {}
    
    --local horizontalLayoutGroup = self.content.transform:GetComponent(typeof(CS.UnityEngine.UI.HorizontalLayoutGroup))
    --horizontalLayoutGroup.spacing = -77
    
    if self.showList ~= nil then
        for i = 1, table.length(self.showList) do
            --复制基础prefab，每次循环创建一次
            self.model[i] = self:GameObjectInstantiateAsync(UIAssets.UICommonItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                --go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                --go.transform:Set_pivot(0,1)
                go.transform:Set_localScale(0.7, 0.7, 0.7)
                go.name ="item" .. i
                local cell = self.content:AddComponent(ActivityRewardItem,go.name)
                cell:RefreshData(self.showList[i])
                self.showList[i].iconImg = go.transform:Find("UICommonItem/clickBtn/ItemIcon")
            end)
        end
    end
end

--任务奖励
function ActSevenDayItem:GetForward()
    local tempType = {}
    for i, v in ipairs(self.taskValue.rewardList) do
        if v.rewardType == RewardType.METAL or v.rewardType == RewardType.WATER or v.rewardType == RewardType.ELECTRICITY then
            tempType = {ResourceType.Metal,ResourceType.Electricity,ResourceType.Water}
            break
        end
    end
    EventManager:GetInstance():Broadcast(EventId.RefreshTopResByPickUp,tempType)
    for i, v in ipairs(self.taskValue.rewardList) do
        local rewardType = v.rewardType
        local itemId = v.itemId
        local pic =RewardUtil.GetPic(v.rewardType,itemId)
        local img = self.showList[i].iconImg
        if pic~="" then
            UIUtil.DoFly(tonumber(rewardType),3,pic,img.transform.position,Vector3.New(0,0,0))
        end
    end
end

function ActSevenDayItem:OnClickReward()
    self:GetForward()
    local rewardTyp= RewardType.SEVENDAY_SCORE
    local flyPos = self.param.flyPos.position
    local pic= string.format(LoadPath.UISevenDay,"UI7day_icon_integral")
    UIUtil.DoFly(tonumber(rewardTyp),5,pic,self.rewardRect.transform.position,flyPos,40,40)
    self.view.ctrl:GetSevenDayTaskReward(self.taskId)
end

function ActSevenDayItem:OnClickGo()
    GoToUtil.GoToByQuestId(self.template)
end

return ActSevenDayItem