---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/1/13 0:24
---SeasonPassPrivilegePanel.lua

local SeasonPassPrivilegePanel = BaseClass("SeasonPassPrivilegePanel", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local SeasonPassPrivilegeItem = require "UI.UIActivityCenterTable.Component.SeasonPass.SeasonPassPrivilegeItem"

local PackageDescConf = {
    320605, 320604, 320629
}

local scrollRect_path = "scrollRect"
local content_path = "scrollRect/Content"
local tip_path = "privilegeTip"
local packageIcon_path = "packageIcon"
--local packageDesc_path = "packageDesc"
local unlockBtn_path = "unlockBtn"
local unlockBtnTxt_path = "unlockBtn/unlockTxt"
local activatedTip_path = "activated"
local packageDesc_path = "layout/desc_"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ClearScroll()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.scrollRectN = self:AddComponent(UIScrollRect, scrollRect_path)
    self.contentN = self:AddComponent(GridInfinityScrollView, content_path)
    self.tipsN = self:AddComponent(UIText, tip_path)
    self.tipsN:SetLocalText(320628)
    self.listGO = {}
    local bindFunc1 = BindCallback(self, self.OnInitScroll)
    local bindFunc2 = BindCallback(self, self.OnUpdateScroll)
    local bindFunc3 = BindCallback(self, self.OnDestroyScrollItem)
    self.contentN:Init(bindFunc1,bindFunc2, bindFunc3)
    self.packageIconN = self:AddComponent(UIImage, packageIcon_path)
    --self.packageDescN = self:AddComponent(UIText, packageDesc_path)
    self.unlockBtnN = self:AddComponent(UIButton, unlockBtn_path)
    self.unlockBtnN:SetOnClick(function()
        self:OnClickUnlockBtn()
    end)
    self.unlockBtnTxtN = self:AddComponent(UIText, unlockBtnTxt_path)
    for i = 1, 3 do
        local tempGo = self:AddComponent(UIText, packageDesc_path.. i)
        tempGo:SetLocalText(PackageDescConf[i])
    end
    self.activatedTipN = self:AddComponent(UIText, activatedTip_path)
    self.activatedTipN:SetLocalText(280124)
end

--控件的销毁
local function ComponentDestroy(self)
    
end

--变量的定义
local function DataDefine(self)
    self.activityId = nil
end

--变量的销毁
local function DataDestroy(self)
    self.activityId = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnSeasonPassInfoUpdate, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnSeasonPassInfoUpdate, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function ShowPanel(self, activityId)
    self.activityId = activityId
    DataCenter.SeasonPassManager:GetExtraRewardsReq()
    
    self:RefreshAll()
end

local function RefreshAll(self)
    if IsNull(self.gameObject) then
        return
    end
    self.actData = DataCenter.SeasonPassManager:GetSeasonPassInfo(self.activityId)
    self.privilegeList = DataCenter.SeasonPassManager:GetPrivilegeList(self.activityId)
    self.contentN:SetItemCount(#self.privilegeList)
    
    local superPackage = DataCenter.SeasonPassManager:GetSuperPackageInfo(self.activityId)
    local bgParam = superPackage:getPopupImageMini()
    if bgParam and bgParam ~= "" then
        local bgPath = string.format("Assets/Main/Sprites/UI/UIweeklyPackage/%s", bgParam)
        self.packageIconN:LoadSprite(bgPath)
    end
    --self.packageDescN:SetLocalText(143622)

    self.unlockBtnN:SetActive(true)
    if self.actData.passInfo.unlock == 0 then
        self.unlockBtnTxtN:SetLocalText(130056)
        self.activatedTipN:SetActive(false)
    elseif self.actData.passInfo.unlock == 1 then
        self.unlockBtnTxtN:SetLocalText(129278)
        self.activatedTipN:SetActive(false)
    else
        self.unlockBtnN:SetActive(false)
        self.activatedTipN:SetActive(true)
    end
    
end


local function OnInitScroll(self,go,index)
    local item = self.scrollRectN:AddComponent(SeasonPassPrivilegeItem, go)
    self.listGO[go] = item
end

local function OnUpdateScroll(self,go,index)
    local sub = self.privilegeList[index + 1]
    local cellItem = self.listGO[go]
    if sub == nil then
        return
    end
    cellItem:SetData(self.activityId, sub)
end

local function OnDestroyScrollItem(self,go, index)

end

local function ClearScroll(self)
    self.scrollRectN:RemoveComponents(SeasonPassPrivilegeItem)
    self.contentN:DestroyChildNode()
end

local function OnClickUnlockBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UISeasonPassPackage, self.activityId)
end

SeasonPassPrivilegePanel.OnCreate = OnCreate
SeasonPassPrivilegePanel.OnDestroy = OnDestroy
SeasonPassPrivilegePanel.ComponentDefine = ComponentDefine
SeasonPassPrivilegePanel.ComponentDestroy = ComponentDestroy
SeasonPassPrivilegePanel.DataDefine = DataDefine
SeasonPassPrivilegePanel.DataDestroy = DataDestroy
SeasonPassPrivilegePanel.OnAddListener = OnAddListener
SeasonPassPrivilegePanel.OnRemoveListener = OnRemoveListener

SeasonPassPrivilegePanel.ShowPanel = ShowPanel
SeasonPassPrivilegePanel.RefreshAll = RefreshAll
SeasonPassPrivilegePanel.OnInitScroll = OnInitScroll
SeasonPassPrivilegePanel.OnUpdateScroll = OnUpdateScroll
SeasonPassPrivilegePanel.OnDestroyScrollItem = OnDestroyScrollItem
SeasonPassPrivilegePanel.ClearScroll = ClearScroll
SeasonPassPrivilegePanel.OnClickUnlockBtn = OnClickUnlockBtn

return SeasonPassPrivilegePanel