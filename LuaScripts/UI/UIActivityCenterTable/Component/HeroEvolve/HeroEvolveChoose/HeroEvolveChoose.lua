---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/25 14:43
---
local HeroEvolveChoose = BaseClass("HeroEvolveChoose", UIBaseContainer)
local base = UIBaseContainer
local Cell = require "UI.UIActivityCenterTable.Component.HeroEvolve.HeroEvolveChoose.Component.HeroEvolveChooseCell"
local title_path = "chooseTitle"
local scroll_view_path = "chooseScrollView"

local choose_btn_path = "chooseBtn"
local choose_btn_text_path = "chooseBtn/chooseBtnText"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.title_path = self:AddComponent(UIText, title_path)
    self.title_path:SetLocalText(361092, "s"..DataCenter.SeasonDataManager:GetSeasonId())
    self.scroll_view = self:AddComponent(UIScrollView, scroll_view_path)
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateCell(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteCell(itemObj, index)
    end)
    self.choose_btn = self:AddComponent(UIButton, choose_btn_path)
    self.choose_btn_text = self:AddComponent(UIText, choose_btn_text_path)
    self.choose_btn_text:SetLocalText(110108)
    self.choose_btn:SetOnClick(function()
        self:OnChooseClick()
    end)

end

--控件的销毁
local function ComponentDestroy(self)
    self:ClearScroll()
end

--变量的定义
local function DataDefine(self)

end

--变量的销毁
local function DataDestroy(self)

end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.HeroEvolveCellSelect, self.OnSelectEvent)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.HeroEvolveCellSelect, self.OnSelectEvent)
    base.OnRemoveListener(self)
end

local function OnSelectEvent(self, para)
    self.curSelect = para
    self:RefreshChooseBtn()
end

local function SetData(self, activityId)
    self.activityId = activityId
    self.dataList = HeroEvolveController:GetInstance():GetHeroChoosePanelData(self.activityId)
    self:ShowCells()
    self:RefreshChooseBtn()
end

local function OnCreateCell(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scroll_view:AddComponent(Cell, itemObj)
    local data =  self.dataList[index]
    cellItem:SetData(data, self.curSelect)
end

local function OnDeleteCell(self,itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, Cell)
end

local function ClearScroll(self)
    self.scroll_view:ClearCells()
    self.scroll_view:RemoveComponents(Cell)
end

local function ShowCells(self)
    self:ClearScroll()
    local count = #self.dataList
    if count == 0 then
        return
    end
    self.scroll_view:SetTotalCount(count)
    self.scroll_view:RefillCells()
end

local function RefreshChooseBtn(self)
    local showFlag = false
    if self.dataList then
        for _, v in ipairs(self.dataList) do
            if v.heroId == self.curSelect then
                if not v.hasHero then
                    showFlag = true
                    break
                end
            end
        end
    end
    self.choose_btn:SetActive(showFlag)
end

local function OnChooseClick(self)
    if self.dataList then
        for _, v in ipairs(self.dataList) do
            if v.heroId == self.curSelect then
                if not v.hasHero then
                    HeroEvolveController:GetInstance():SetForceShowChoose(false)
                    DataCenter.HeroEvolveActivityManager:HeroEvolveActivityChooseHero(v.activityId, v.heroId)
                    return
                end
            end
        end
    end
end

HeroEvolveChoose.OnChooseClick = OnChooseClick
HeroEvolveChoose.OnCreate = OnCreate
HeroEvolveChoose.OnDestroy = OnDestroy
HeroEvolveChoose.ComponentDefine = ComponentDefine
HeroEvolveChoose.ComponentDestroy = ComponentDestroy
HeroEvolveChoose.DataDefine = DataDefine
HeroEvolveChoose.DataDestroy = DataDestroy
HeroEvolveChoose.SetData = SetData
HeroEvolveChoose.OnAddListener = OnAddListener
HeroEvolveChoose.OnRemoveListener = OnRemoveListener
HeroEvolveChoose.OnSelectEvent = OnSelectEvent
HeroEvolveChoose.OnCreateCell = OnCreateCell
HeroEvolveChoose.OnDeleteCell = OnDeleteCell
HeroEvolveChoose.ClearScroll = ClearScroll
HeroEvolveChoose.ShowCells = ShowCells
HeroEvolveChoose.RefreshChooseBtn = RefreshChooseBtn

return HeroEvolveChoose