---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/8 17:02
--- AlContributeRankItem.lua

local BarterShopItem = BaseClass("BarterShopItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIGray = CS.UIGray
local UICommonItem = require "UI.UICommonItem.UICommonItem"

local rank_path = "rank"
local player_path = "player"
local playerHead_path = "player/UIPlayerHead/HeadIcon"
local playerHeadFg_path = "player/UIPlayerHead/Foreground"
local playerHeadBtn_path = "player/UIPlayerHead"
local name_path = "player/playerName"
local empty_path = "empty"
local emptyTip_path = "empty/emptyTip"
local exploitRank_path = "exploitRank"
local exploitRankImg_path = "imgExploitRank"
local weekScore_path = "weekScore"
local reward_path = "rewards/rewardItem_"
local rankStar_path = "imgExploitRank/rankStar/starImage"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.rankN = self:AddComponent(UIText, rank_path)
    self.playerN = self:AddComponent(UIBaseContainer, player_path)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.playerHeadBtnN = self:AddComponent(UIButton, playerHeadBtn_path)
    self.playerHeadBtnN:SetOnClick(function()
        self:OnClickPlayerHeadBtn()
    end)
    self.nameN = self:AddComponent(UIText, name_path)
    self.emptyN = self:AddComponent(UIBaseContainer, empty_path)
    self.emptyTipN = self:AddComponent(UIText, emptyTip_path)
    self.emptyTipN:SetLocalText(391071)
    self.exploitRank = self:AddComponent(UIText, exploitRank_path)
    self.exploitRankImg = self:AddComponent(UIImage, exploitRankImg_path)
    self.weekScoreN = self:AddComponent(UIText, weekScore_path)
    self.rewardsTbN = {}
    for i = 1, 3 do
        local reward = self:AddComponent(UICommonItem, reward_path .. i)
        table.insert(self.rewardsTbN, reward)
    end
    
    self.rankStarList = {}
    for i = 1, 4 do
        local rankStar = self:AddComponent(UIBaseContainer, rankStar_path .. i)
        table.insert(self.rankStarList, rankStar)
    end
end

--控件的销毁
local function ComponentDestroy(self)
    
end

--变量的定义
local function DataDefine(self)
    self.rankInfo = nil
end

--变量的销毁
local function DataDestroy(self)
    self.rankInfo = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.BarterShopExchangeSucc, self.OnGetBarterSucc)

end

local function OnRemoveListener(self)
    --self:RemoveUIListener(EventId.BarterShopExchangeSucc, self.OnGetBarterSucc)
    base.OnRemoveListener(self)
end


local function SetItem(self, rank, rankInfo, isSelf)
    self.rankInfo = rankInfo
    
    local rewards = DataCenter.AlContributeManager:GetRewardsByRank(rank)
    for i, v in ipairs(self.rewardsTbN) do
        if i <= #rewards then
            v:SetActive(true)
            v:ReInit(rewards[i])
        else
            v:SetActive(false)
        end
    end


	local exploitScore = 0
	if rankInfo then
		exploitScore = rankInfo.historyScore
	end
	local exploitRank = DataCenter.AlContributeManager:GetExploitRankByScore(exploitScore)
	local starNum = DataCenter.AlContributeManager: GetConfigDataByRank(exploitRank, "star")
	for i, v in ipairs(self.rankStarList) do
		if i <= starNum then
			v:SetActive(true)
		else
			v:SetActive(false)
		end
	end
	local exploitPath = DataCenter.AlContributeManager:GetExploitImgPathByScore(exploitScore)
	self.exploitRankImg:LoadSprite(exploitPath)
	local exploitName = DataCenter.AlContributeManager:GetExploitNameByRank(exploitRank)
	self.exploitRank:SetText(exploitName)
   
    if rankInfo then
        self.weekScoreN:SetText(string.GetFormattedSeperatorNum(rankInfo.score or 0))
        if rank <= 0 then
            self.rankN:SetText("-")
        else
            self.rankN:SetText(rank)
        end

        self.playerN:SetActive(true)
        self.playerHeadN:SetData(rankInfo.uid, rankInfo.pic, rankInfo.picVer)
        
        local headBgImg = ""
        if rank > 3 or isSelf then
            if rankInfo.uid == LuaEntry.Player.uid then
                headBgImg = DataCenter.DecorationDataManager:GetSelfHeadFrame()
            else
                headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(rankInfo.headSkinId, rankInfo.headSkinET)
            end
        end
        if not string.IsNullOrEmpty(headBgImg) then
            self.playerHeadFgN:SetActive(true)
            self.playerHeadFgN:LoadSprite(headBgImg)
        else
            self.playerHeadFgN:SetActive(false)
        end
        local name = rankInfo.name
        if not string.IsNullOrEmpty(rankInfo.abbr) then
            name = "[" .. rankInfo.abbr .. "] " .. rankInfo.name
        end
        self.nameN:SetText(name)
        self.emptyN:SetActive(false)
    else
        self.rankN:SetText(rank)

        self.playerN:SetActive(false)
        self.emptyN:SetActive(true)
        self.weekScoreN:SetText(0)
    end
end

local function OnClickPlayerHeadBtn(self)
    if self.rankInfo then
        if self.rankInfo.uid ~= LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo, self.rankInfo.uid)
        end
    end
end


BarterShopItem.OnCreate = OnCreate
BarterShopItem.OnDestroy = OnDestroy
BarterShopItem.ComponentDefine = ComponentDefine
BarterShopItem.ComponentDestroy = ComponentDestroy
BarterShopItem.DataDefine = DataDefine
BarterShopItem.DataDestroy = DataDestroy
BarterShopItem.OnAddListener = OnAddListener
BarterShopItem.OnRemoveListener = OnRemoveListener

BarterShopItem.SetItem = SetItem
BarterShopItem.OnClickPlayerHeadBtn = OnClickPlayerHeadBtn

return BarterShopItem