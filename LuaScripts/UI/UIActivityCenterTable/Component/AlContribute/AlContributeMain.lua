---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/8 16:22
--- AlContributeMain.lua


local BarterShopMain = BaseClass("BarterShopMain", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local AlContributeRankItem = require "UI.UIActivityCenterTable.Component.AlContribute.AlContributeRankItem"

local title_path = "RightView/Top/title"
local desc_path = "RightView/Top/actTime"
local remainTime_path = "RightView/Top/remainTime"
local infoBtn_path = "RightView/Top/title/infoBtn"
local getBtn_path = "RightView/Rect_Bottom/getScoreBtn"
local getScoreBtnTxt_path = "RightView/Rect_Bottom/getScoreBtn/getScoreBtnTxt"
local getScoreRed_path = "RightView/Rect_Bottom/getScoreBtn/RedPoint"
local getScoreRedTxt_path = "RightView/Rect_Bottom/getScoreBtn/RedPoint/getScoreRedNumTxt"
local shopBtn_path = "RightView/Rect_Bottom/shopBtn"
local shopBtnTxt_path = "RightView/Rect_Bottom/shopBtn/shopBtnTxt"
local topPos_path = "RightView/Rect_Bottom/topRank/topRank_"
local headRank_path = "RightView/Rect_Bottom/head/headRank"
local headName_path = "RightView/Rect_Bottom/head/headName"
local headExploitRank_path = "RightView/Rect_Bottom/head/headExploitRank"
local headWeekScore_path = "RightView/Rect_Bottom/head/headWeekScore"
local headReward_path = "RightView/Rect_Bottom/head/headWeekRewards"
local scrollRect_path = "RightView/Rect_Bottom/ScrollView"
local content_path = "RightView/Rect_Bottom/ScrollView/Content"
local myRankItem_path = "RightView/Rect_Bottom/selfRank"
local btnExploitRankDetail_path = "RightView/Rect_Bottom/btnExploitRankDetail"
local txtExploitRankDetail_path = "RightView/Rect_Bottom/btnExploitRankDetail/exploitDetailTxt"
local ExploitRankDetailRed_path = "RightView/Rect_Bottom/btnExploitRankDetail/RedPoint"
local txtExploitRankDetailRed_path = "RightView/Rect_Bottom/btnExploitRankDetail/RedPoint/exploitRankDetailTxt"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DelCountDownTimer()
    self:ClearItemCell()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.descN = self:AddComponent(UIText, desc_path)
    self.descN:SetLocalText("372745")
    self.titleN = self:AddComponent(UIText, title_path)
    self.remainTimeN = self:AddComponent(UIText, remainTime_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.getScoreBtnN = self:AddComponent(UIButton, getBtn_path)
    self.getScoreBtnN:SetOnClick(function()
        self:OnClickGetScoreBtn()
    end)
    self.getScoreBtnTxtN = self:AddComponent(UIText, getScoreBtnTxt_path)
    self.getScoreBtnTxtN:SetLocalText(372750)
    self.getScoreRedN = self:AddComponent(UIBaseContainer, getScoreRed_path)
    self.getScoreRedTxt = self:AddComponent(UIText, getScoreRedTxt_path)
    self.shopBtnN = self:AddComponent(UIButton, shopBtn_path)
    self.shopBtnN:SetOnClick(function()
        self:OnClickShopBtn()
    end)
    self.shopBtnTxtN = self:AddComponent(UIText, shopBtnTxt_path)
    self.shopBtnTxtN:SetLocalText(372751)
    self.topPosTbN = {}
    for i = 1, 3 do
        local posItem = self:AddComponent(AlContributeRankItem, topPos_path .. i)
        table.insert(self.topPosTbN, posItem)
    end
    self.headRankN = self:AddComponent(UIText, headRank_path)
    self.headRankN:SetText("")
    self.headNameN = self:AddComponent(UIText, headName_path)
    self.headNameN:SetLocalText(100184)
    self.headHistoryScoreN = self:AddComponent(UIText, headExploitRank_path)
    self.headHistoryScoreN:SetLocalText(372854)
    self.headWeekScoreN = self:AddComponent(UIText, headWeekScore_path)
    self.headWeekScoreN:SetLocalText(372747)
    self.headRewardN = self:AddComponent(UIText, headReward_path)
    self.headRewardN:SetLocalText(372749)
    self.scrollRectN = self:AddComponent(UIBaseContainer, scrollRect_path)
    self.contentN = self:AddComponent(GridInfinityScrollView, content_path)
    local bindFunc1 = BindCallback(self, self.OnInitScroll)
    local bindFunc2 = BindCallback(self, self.OnUpdateScroll)
    local bindFunc3 = BindCallback(self, self.OnDestroyScrollItem)
    self.contentN:Init(bindFunc1,bindFunc2, bindFunc3)
    self.myRankItemN = self:AddComponent(AlContributeRankItem, myRankItem_path)
    self.btnExploitRankDetail = self:AddComponent(UIButton,btnExploitRankDetail_path)
    self.btnExploitRankDetail:SetOnClick(function()
        self:OnClickExploitRankDetailBtn()
    end)
    self.txtExploitRankDetail = self:AddComponent(UIText,txtExploitRankDetail_path)
    self.txtExploitRankDetail:SetLocalText(372854)
    self.ExploitRankDetailRed = self:AddComponent(UIImage,ExploitRankDetailRed_path)
    self.txtExploitRankDetailRed = self:AddComponent(UIText,txtExploitRankDetailRed_path)
end

local function ComponentDestroy(self)
    self.descN = nil
    self.remainTimeN = nil
    self.infoBtnN = nil
    self.getScoreBtnN = nil
    self.getScoreBtnTxtN = nil
    self.shopBtnN = nil
    self.shopBtnTxtN = nil
    self.topPosTbN = nil
    self.headRankN = nil
    self.headNameN = nil
    self.headHistoryScoreN = nil
    self.headWeekScoreN = nil
    self.headRewardN = nil
    self.scrollRectN = nil
    self.contentN = nil
    self.myRankItemN = nil
end

local function DataDefine(self)
    self.activityId = nil
    self.activityInfo = nil
    self.rankList = {}
    self.listGO = {}
end

local function DataDestroy(self)
    self.activityId = nil
    self.activityInfo = nil
    self.rankList = nil
    self.listGO = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnAlContributeRankInfoUpdate, self.RefreshAll)
    self:AddUIListener(EventId.OnAlContributeBoxStatusChange, self.RefreshAll)
    self:AddUIListener(EventId.UpdateSelfExploit, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnAlContributeRankInfoUpdate, self.RefreshAll)
    self:RemoveUIListener(EventId.OnAlContributeBoxStatusChange, self.RefreshAll)
    self:RemoveUIListener(EventId.UpdateSelfExploit, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function SetData(self, activityId, id)
    self.activityId = id
    self.actId = activityId
    
    if not self.activityId then
        return
    end
    self.activityInfo = DataCenter.ActivityListDataManager:GetActivityDataById(tostring(self.activityId))
    if not self.activityInfo then
        return
    end

    DataCenter.ActivityListDataManager:SetActivityVisitedEndTime(self.activityId)
    
    DataCenter.AlContributeManager:GetRankListReq()
    
    self.endTime = self.activityInfo.endTime
    self:AddCountDownTimer()
    
    --self:RefreshAll()
end

local function RefreshAll(self)
    if IsNull(self.gameObject) then
        return
    end
    
    self:RefreshRanks()

    self.titleN:SetLocalText(self.activityInfo.desc_info)
    
    local getScoreRedNum = DataCenter.AlContributeManager:GetUnclaimedBoxCount()
    self.getScoreRedN:SetActive(getScoreRedNum > 0)
    self.getScoreRedTxt:SetText(getScoreRedNum)
    
    self:RefreshExploitRankDetailRed()
end

local function RefreshRanks(self)
    self.rankList, self.selfRank = DataCenter.AlContributeManager:GetRankList()
    for i, v in ipairs(self.topPosTbN) do
        v:SetItem(i, self.rankList[i], false)
    end
    
    local rankCount = DataCenter.AlContributeManager:GetMaxRankListCount()
    self.contentN:SetItemCount(rankCount - 3)
    
    self.selfRank.uid = LuaEntry.Player.uid
    self.selfRank.name = LuaEntry.Player.name
    self.selfRank.pic = LuaEntry.Player.pic
    self.selfRank.picVer = LuaEntry.Player.picVer
    if LuaEntry.Player:IsInAlliance() then
        local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBase then
            self.selfRank.abbr = allianceBase.abbr
            self.selfRank.allianceName = allianceBase.allianceName
        end
    end
    self.myRankItemN:SetItem(self.selfRank.rank, self.selfRank, true)
end

local function RefreshExploitRankDetailRed(self)
    local unTakeNum = DataCenter.AlContributeManager:GetUnTakeExploitRewardNum()
    self.ExploitRankDetailRed:SetActive(unTakeNum > 0)
    self.txtExploitRankDetailRed:SetText(unTakeNum)
end

local function OnInitScroll(self,go,index)
    local item = self.scrollRectN:AddComponent(AlContributeRankItem, go)
    self.listGO[go] = item
end

local function OnUpdateScroll(self,go,index)
    go.name = index + 1
    local cellItem = self.listGO[go]
    if not cellItem then
        return
    end
    local rankInfo = self.rankList[index + 4]
    cellItem:SetItem(index + 4, rankInfo, false)
end

local function OnDestroyScrollItem(self,go, index)

end

local function ClearItemCell(self)
    self.scrollRectN:RemoveComponents(AlContributeRankItem)
    self.contentN:DestroyChildNode()
end


local function AddCountDownTimer(self)
    self.CountDownTimerAction = function()
        self:RefreshRemainTime()
    end

    if self.countDownTimer == nil then
        self.countDownTimer = TimerManager:GetInstance():GetTimer(1, self.CountDownTimerAction , self, false,false,false)
    end
    self.countDownTimer:Start()
    self:RefreshRemainTime()
end

local function RefreshRemainTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = self.endTime - curTime
    if remainTime >= 0 then
        self.remainTimeN:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(remainTime))
    else
        self.remainTimeN:SetText("")
    end
end

local function DelCountDownTimer(self)
    if self.countDownTimer ~= nil then
        self.countDownTimer:Stop()
        self.countDownTimer = nil
    end
end


local function OnClickGetScoreBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlContribute, self.activityId)
end

local function OnClickShopBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UICommonShop, 5)
end

local function OnClickInfoBtn(self)
    UIUtil.ShowIntro(Localization:GetString("372743"), Localization:GetString("170001"), Localization:GetString(self.activityInfo.story))
end

local function OnClickExploitRankDetailBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlContributeRankInfo, self.activityId)
end

BarterShopMain.OnCreate = OnCreate
BarterShopMain.OnDestroy = OnDestroy
BarterShopMain.ComponentDefine = ComponentDefine
BarterShopMain.ComponentDestroy = ComponentDestroy
BarterShopMain.DataDefine = DataDefine
BarterShopMain.DataDestroy = DataDestroy
BarterShopMain.OnAddListener = OnAddListener
BarterShopMain.OnRemoveListener = OnRemoveListener

BarterShopMain.SetData = SetData
BarterShopMain.RefreshAll = RefreshAll
BarterShopMain.RefreshRanks = RefreshRanks
BarterShopMain.OnInitScroll = OnInitScroll
BarterShopMain.OnUpdateScroll = OnUpdateScroll
BarterShopMain.OnDestroyScrollItem = OnDestroyScrollItem
BarterShopMain.AddCountDownTimer = AddCountDownTimer
BarterShopMain.RefreshRemainTime = RefreshRemainTime
BarterShopMain.DelCountDownTimer = DelCountDownTimer
BarterShopMain.ClearItemCell = ClearItemCell
BarterShopMain.OnClickGetScoreBtn = OnClickGetScoreBtn
BarterShopMain.OnClickShopBtn = OnClickShopBtn
BarterShopMain.OnClickInfoBtn = OnClickInfoBtn
BarterShopMain.OnClickExploitRankDetailBtn = OnClickExploitRankDetailBtn
BarterShopMain.RefreshExploitRankDetailRed = RefreshExploitRankDetailRed

return BarterShopMain