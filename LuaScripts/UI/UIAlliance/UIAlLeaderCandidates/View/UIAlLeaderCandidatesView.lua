---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
---

local base = UIBaseView--Variable
local UIAlLeaderCandidatesView = BaseClass("UIAlLeaderCandidatesView", base)--Variable
local UIAlLeaderCandidatesItem = require "UI.UIAlliance.UIAlLeaderCandidates.Component.UIAlLeaderCandidatesItem"
local UIGray = CS.UIGray
local Localization = CS.GameEntry.Localization
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"

local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local desc_path = "ImgBg/desc"
local infoBtn_path = "ImgBg/desc/infoBtn"
local joinBtn_path = "ImgBg/joinBtn"    
local joinBtnTxt_path = "ImgBg/joinBtn/joinBtnTxt"
local closeBtn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local svCandidates_path = "ImgBg/ScrollView"
local empty_path = "ImgBg/empty"
local voteTimes_path = "ImgBg/remainTimes"
local voteTimesNum_path = "ImgBg/remainTimes/remainTimesNum"
local voteTips_path = "ImgBg/remainTimes/remainTimesNum/remainTimesTip"

local function OnCreate(self)
    base.OnCreate(self)
    DataCenter.AlLeaderElectManager:SetCurStageChecked()
    self:ComponentDefine()
    self:DataDefine()
    self:RefreshAll()
    SFSNetwork.SendMessage(MsgDefines.GetAlLeaderElectCandidates)
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.titleN:SetLocalText(390923)
    self.descN = self:AddComponent(UITextMeshProUGUIEx, desc_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.joinBtnN = self:AddComponent(UIButton, joinBtn_path)
    self.joinBtnN:SetOnClick(function()
        self:OnClickJoinBtn()
    end)
    self.joinBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, joinBtnTxt_path)
    --self.joinBtnTxtN:SetLocalText(390926)
    self.closeBtnN= self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.svCandidatesN = self:AddComponent(UIScrollView, svCandidates_path)
    self.svCandidatesN:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.svCandidatesN:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    self.emptyN = self:AddComponent(UITextMeshProUGUIEx, empty_path)
    self.emptyN:SetLocalText(390946)
    self.voteTimesN = self:AddComponent(UITextMeshProUGUIEx, voteTimes_path)
    self.voteTimesN:SetLocalText(390928)
    self.voteTimesNumN = self:AddComponent(UITextMeshProUGUIEx, voteTimesNum_path)
    self.voteTipsN = self:AddComponent(UITextMeshProUGUIEx, voteTips_path)
    self.voteTipsN:SetActive(false)
    --self.voteTipsN:SetLocalText(390935)
end

local function ComponentDestroy(self)
    
end

local function DataDefine(self)
    self.candidatesList = {}
end

local function DataDestroy(self)
    self.candidatesList = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnUpdateCandidates)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnUpdateCandidates)
end

local function OnUpdateCandidates(self, uid)
    if not uid then
        self:RefreshAll()
    end
end

local function RefreshAll(self)
    self.candidatesList = DataCenter.AlLeaderElectManager:GetCandidatesList()
    
    local tempStage = DataCenter.AlLeaderElectManager:GetCurElectStage()
    if tempStage < SysAlState.R4Reuslt then
        self.descN:SetLocalText(390931)
    else
        self.descN:SetLocalText(390942)
    end

    if tempStage == SysAlState.R4Elect or tempStage == SysAlState.LeaderElect then
        local myVoted = DataCenter.AlLeaderElectManager:GetMyVoted()
        local maxNum = 0
        if tempStage == SysAlState.R4Elect then
            maxNum = LuaEntry.DataConfig:TryGetNum("union_Election", "k8")
        elseif tempStage == SysAlState.LeaderElect then
            maxNum = LuaEntry.DataConfig:TryGetNum("union_Election", "k11")
        end
        local remainTimes = maxNum - (#myVoted)
        remainTimes = remainTimes < 0 and 0 or remainTimes
        self.voteTimesNumN:SetText(remainTimes)
    else
        self.voteTimesNumN:SetText(0)
    end

    if tempStage == SysAlState.SignUp or tempStage == SysAlState.R4Elect then
        self.joinBtnN:SetActive(true)
        local mainLv = DataCenter.BuildManager.MainLv
        local voteLv = LuaEntry.DataConfig:TryGetNum("union_Election", "k7")
        if mainLv < voteLv then
            self.joinBtnTxtN:SetLocalText(390926)
            UIGray.SetGray(self.joinBtnN.transform, true, true)
        else
            local signedUp = DataCenter.AlLeaderElectManager:CheckIfSignedUp()
            local txtId = signedUp and 302039 or 390926
            self.joinBtnTxtN:SetLocalText(txtId)
            UIGray.SetGray(self.joinBtnN.transform, signedUp, not signedUp)
        end
    else
        self.joinBtnN:SetActive(false)
    end
    
    self:ShowCandidates()
end

local function ShowCandidates(self)
    if #self.candidatesList > 0 then
        self.svCandidatesN:SetActive(true)
        self.emptyN:SetActive(false)
        self.svCandidatesN:SetTotalCount(#self.candidatesList)
        self.svCandidatesN:RefillCells()
    else
        self.svCandidatesN:SetActive(false)
        self.emptyN:SetActive(true)
    end
end

local function OnItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.svCandidatesN:AddComponent(UIAlLeaderCandidatesItem, itemObj)
    cellItem:SetItem(self.candidatesList[index])
end

local function OnItemMoveOut(self, itemObj, index)
    self.svCandidatesN:RemoveComponent(itemObj.name, UIAlLeaderCandidatesItem)
end

local function ClearScroll(self)
    self.svCandidatesN:ClearCells()
    self.svCandidatesN:RemoveComponents(UIAlLeaderCandidatesItem)
end

local function OnClickCloseBtn(self)
    self.ctrl:CloseSelf()
end

local function OnClickJoinBtn(self)
    local mainLv = DataCenter.BuildManager.MainLv
    local voteLv = LuaEntry.DataConfig:TryGetNum("union_Election", "k7")
    if mainLv < voteLv then
        UIUtil.ShowTips(Localization:GetString("390953", voteLv))
    else
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlLeaderElectSignUp)
    end
end

local function OnClickInfoBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.infoBtnN.transform.position + Vector3.New(0, 10, 0) * scaleFactor
    local infoStr = Localization:GetString("390934")

    local param = UIHeroTipView.Param.New()
    param.content = infoStr
    param.dir = UIHeroTipView.Direction.RIGHT
    param.defWidth = 400
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

UIAlLeaderCandidatesView.OnCreate = OnCreate
UIAlLeaderCandidatesView.OnDestroy = OnDestroy
UIAlLeaderCandidatesView.OnAddListener = OnAddListener
UIAlLeaderCandidatesView.OnRemoveListener = OnRemoveListener
UIAlLeaderCandidatesView.ComponentDefine = ComponentDefine
UIAlLeaderCandidatesView.ComponentDestroy = ComponentDestroy
UIAlLeaderCandidatesView.DataDefine = DataDefine
UIAlLeaderCandidatesView.DataDestroy = DataDestroy

UIAlLeaderCandidatesView.OnUpdateCandidates = OnUpdateCandidates
UIAlLeaderCandidatesView.RefreshAll = RefreshAll
UIAlLeaderCandidatesView.ShowCandidates = ShowCandidates
UIAlLeaderCandidatesView.OnItemMoveIn = OnItemMoveIn
UIAlLeaderCandidatesView.OnItemMoveOut = OnItemMoveOut
UIAlLeaderCandidatesView.ClearScroll = ClearScroll
UIAlLeaderCandidatesView.OnClickCloseBtn = OnClickCloseBtn
UIAlLeaderCandidatesView.OnClickJoinBtn = OnClickJoinBtn
UIAlLeaderCandidatesView.OnClickInfoBtn = OnClickInfoBtn

return UIAlLeaderCandidatesView