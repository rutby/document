---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/10/26 19:31
---

local UIAlLeaderCandidatesItem = BaseClass("UIAlLeaderCandidatesItem",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIGray = CS.UIGray
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"

local headIcon_path = "Bg/UIPlayerHead/HeadIcon"
local headFg_path = "Bg/UIPlayerHead/Foreground"
local name_path = "Bg/name"
local power_path = "Bg/power"
local votes_path = "Bg/vote/voteText"
local sloganBtn_path = "Bg/detail"
local slogan_path = "Bg/detail/slogan"
local editBtn_path = "Bg/GameObject/editBtn"
local editBtnTxt_path = "Bg/GameObject/editBtn/editBtnTxt"
local voteBtn_path = "Bg/GameObject/voteBtn"
local voteBtnTxt_path = "Bg/GameObject/voteBtn/voteBtnTxt"

-- 创建 
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.headIconN = self:AddComponent(UIPlayerHead, headIcon_path)
    self.headFgN = self:AddComponent(UIImage, headFg_path)
    self.nameN = self:AddComponent(UITextMeshProUGUIEx, name_path)
    self.powerN = self:AddComponent(UITextMeshProUGUIEx, power_path)
    self.votesN = self:AddComponent(UITextMeshProUGUIEx, votes_path)
    self.sloganBtnN = self:AddComponent(UIButton, sloganBtn_path)
    self.sloganBtnN:SetOnClick(function()
        self:OnClickSloganBtn()
    end)
    self.sloganN = self:AddComponent(UITextMeshProUGUIEx, slogan_path)
    self.editBtnN = self:AddComponent(UIButton, editBtn_path)
    self.editBtnN:SetOnClick(function()
        self:OnClickEditBtn()
    end)
    self.editBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, editBtnTxt_path)
    self.editBtnTxtN:SetLocalText(390927)
    self.voteBtnN = self:AddComponent(UIButton, voteBtn_path)
    self.voteBtnN:SetOnClick(function()
        self:OnClickVoteBtn()
    end)
    self.voteBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, voteBtnTxt_path)
    self.voteBtnTxtN:SetLocalText(390861)
end

--控件的销毁
local function ComponentDestroy(self)
    self.headIconN = nil
    self.headFgN = nil
    self.nameN = nil
    self.powerN = nil
    self.votesN = nil
    self.sloganN = nil
    self.editBtnN = nil
    self.voteBtnN = nil
end

--变量的定义
local function DataDefine(self)
end

--变量的销毁
local function DataDestroy(self)
end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
end

local function OnCandidateInfoUpdated(self, uid)
    if uid and uid == self.candidateInfo.uid then
        self:RefreshItem()
    end
end

local function SetItem(self, candidateInfo)
    self.candidateInfo = candidateInfo
    
    self:RefreshItem()
end

local function RefreshItem(self)
    self.headIconN:SetData(self.candidateInfo.uid, self.candidateInfo.pic, self.candidateInfo.picVer)
    local tempFg = self.candidateInfo:GetHeadBgImg()
    if tempFg then
        self.headFgN:SetActive(true)
        self.headFgN:LoadSprite(tempFg)
    else
        self.headFgN:SetActive(false)
    end
    self.nameN:SetText(self.candidateInfo.name)
    self.powerN:SetText(string.GetFormattedSeperatorNum(self.candidateInfo.power))
    self.votesN:SetText(self.candidateInfo.voteNum)
    self.sloganN:SetText(self.candidateInfo.voteSlogan)

    local curStage = DataCenter.AlLeaderElectManager:GetCurElectStage()
    if curStage == SysAlState.R4Elect or curStage == SysAlState.LeaderElect then
        local myVotedList = DataCenter.AlLeaderElectManager:GetMyVoted()
        if table.hasvalue(myVotedList, self.candidateInfo.uid) then
            self.voteBtnTxtN:SetLocalText(390862)
            UIGray.SetGray(self.voteBtnN.transform, true, false)
        else
            self.voteBtnTxtN:SetLocalText(390861)
            UIGray.SetGray(self.voteBtnN.transform, false, true)
        end
    else
        UIGray.SetGray(self.voteBtnN.transform, true, false)
    end
    
    if self.candidateInfo.uid == LuaEntry.Player.uid then
        self.editBtnN:SetActive(true)
    else
        self.editBtnN:SetActive(false)
    end
    
end

local function OnClickEditBtn(self)
    local strDefault = self.candidateInfo.voteSlogan
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceChangeAnnounce,{anim = true}, 3, strDefault)
end

local function OnClickVoteBtn(self)
    local myVoted = DataCenter.AlLeaderElectManager:GetMyVoted()
    local maxNum = 0
    local curStage = DataCenter.AlLeaderElectManager:GetCurElectStage()
    if curStage == SysAlState.R4Elect then
        maxNum = LuaEntry.DataConfig:TryGetNum("union_Election", "k8")
    elseif curStage == SysAlState.LeaderElect then 
        maxNum = LuaEntry.DataConfig:TryGetNum("union_Election", "k11")
    end
    local remainTimes = maxNum - (#myVoted)
    if remainTimes <= 0 then
        UIUtil.ShowTipsId(390949)
        return
    end
    UIUtil.ShowMessage(Localization:GetString("390937", self.candidateInfo.name), 2, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL, function()
        SFSNetwork.SendMessage(MsgDefines.AlLeaderElectVote, self.candidateInfo.uid)
    end, nil)
end

local function OnClickSloganBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.sloganBtnN.transform.position + Vector3.New(0, 20, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    param.content = self.candidateInfo.voteSlogan
    param.dir = UIHeroTipView.Direction.RIGHT
    param.defWidth = 300
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end


UIAlLeaderCandidatesItem.OnCreate = OnCreate
UIAlLeaderCandidatesItem.OnDestroy = OnDestroy
UIAlLeaderCandidatesItem.OnEnable = OnEnable
UIAlLeaderCandidatesItem.OnDisable = OnDisable
UIAlLeaderCandidatesItem.ComponentDefine = ComponentDefine
UIAlLeaderCandidatesItem.ComponentDestroy = ComponentDestroy
UIAlLeaderCandidatesItem.DataDefine = DataDefine
UIAlLeaderCandidatesItem.DataDestroy = DataDestroy
UIAlLeaderCandidatesItem.OnAddListener = OnAddListener
UIAlLeaderCandidatesItem.OnRemoveListener = OnRemoveListener

UIAlLeaderCandidatesItem.SetItem = SetItem
UIAlLeaderCandidatesItem.OnCandidateInfoUpdated = OnCandidateInfoUpdated
UIAlLeaderCandidatesItem.RefreshItem = RefreshItem
UIAlLeaderCandidatesItem.OnClickEditBtn = OnClickEditBtn
UIAlLeaderCandidatesItem.OnClickVoteBtn = OnClickVoteBtn
UIAlLeaderCandidatesItem.OnClickSloganBtn = OnClickSloganBtn

return UIAlLeaderCandidatesItem