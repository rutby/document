---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/8 18:40
---
local AllianceGiftDataShow =
{
    title = "",
    name = "",
    des = "",
    time = "",
    itemList={}
}
local OneData = DataClass("OneData", AllianceGiftDataShow)
local UIAllianceGiftInfoCtrl = BaseClass("UIAllianceGiftInfoCtrl", UIBaseCtrl)
local Localization = CS.GameEntry.Localization
local function CloseSelf(self)
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIAllianceGiftInfo)
end

local function Close(self)
    UIManager:GetInstance():DestroyWindowByLayer(UILayer.Normal)
end

local function InitData(self,uuid)
    SFSNetwork.SendMessage(MsgDefines.AllianceGiftInfo,uuid)
    self.uuid = uuid
end


local function OnGetClick(self)
    SFSNetwork.SendMessage(MsgDefines.AllianceGiftGetReward,self.uuid,0)
    self:CloseSelf()
end

local function GetAllianceGiftData(self)
    local oneData = OneData.New()
    local giftData = DataCenter.AllianceGiftDataManager:GetGiftDataByUuid(self.uuid)
    if giftData~=nil then
        local nameDialog = GetTableData(TableName.AllianceGiftGroup,giftData.groupId, "name")
        local message = GetTableData(TableName.AllianceGiftGroup,giftData.groupId, "message")
        local giftType = GetTableData(TableName.AllianceGiftGroup,giftData.groupId, "type")
        oneData.title = Localization:GetString(nameDialog)
        if v.fromMsg ~= nil and v.fromMsg.fromType == "exchange" then
            oneData.name = Localization:GetString(message,Localization:GetString(nameDialog))
        elseif v.fromMsg ~= nil and v.fromMsg.fromType == "monster" then
            local monsterName = Localization:GetString(v.fromMsg.name)
            oneData.title = Localization:GetString(nameDialog, v.fromMsg.level)
            oneData.name = Localization:GetString(message,giftData.userName,monsterName)
        else
            oneData.name = Localization:GetString(message,Localization:GetString(giftData.name),Localization:GetString(nameDialog))
        end
    end
    
    if giftData.reward ~= nil and #giftData.reward > 0 then
        local tempList = {}
        table.walk(giftData.reward,function (k,v)
            local item = {}
            local type = v["type"]
            if type~=7 then
                item.itemId = ""
                item.iconName = DataCenter.RewardManager:GetPicByType(type)
                item.itemName = Localization:GetString(CS.ResourceUtils.GetRewardTypeName(type))
                item.itemColor = DataCenter.ItemTemplateManager:GetToolBgByColor(4)
                item.count = string.GetFormattedSeperatorNum(v["value"])
                item.itemFlag = ""
                item.atlas = AtlasAssets.ResourceAtlas
            else
                local id = v["value"]["id"]
                local goods = DataCenter.ItemTemplateManager:GetItemTemplate(id)
                if goods~=nil then
                    item.itemId = id
                    item.iconName = goods.icon
                    item.count = string.GetFormattedSeperatorNum(v["value"]["num"])
                    item.itemName = DataCenter.ItemTemplateManager:GetName(id)
                    item.itemColor = DataCenter.ItemTemplateManager:GetToolBgByColor(goods.color)
                    local itemType = goods.type
                    if itemType == 2 then -- SPD
                        if goods.para1 ~= nil and goods.para1 ~= "" then
                            local para1 = goods.para1
                            local temp = string.split(para1,';')
                            if temp ~= nil and #temp > 1 then
                                item.itemFlag = temp[1]..temp[2]
                            end
                        end
                    elseif itemType == 3 then -- USE
                        local type2 = goods.type2
                        if type2 ~= 999 and goods.para ~= nil and goods.para ~= "" then
                            local res_num = tonumber(goods.para)
                            item.itemFlag = string.GetFormattedStr(res_num)
                        end
                    else
                        item.itemFlag = ""
                    end
                    item.atlas = AtlasAssets.ItemAtlas
                end
            end
            table.insert(tempList,item)
        end)
        oneData.itemList = tempList
    end
    oneData.time = UITimeManager:GetInstance():TimeStampToTimeForLocal(giftData.createTime)
    return oneData
end

UIAllianceGiftInfoCtrl.CloseSelf =CloseSelf
UIAllianceGiftInfoCtrl.Close =Close
UIAllianceGiftInfoCtrl.GetAllianceGiftData =GetAllianceGiftData
UIAllianceGiftInfoCtrl.OnGetClick = OnGetClick
UIAllianceGiftInfoCtrl.InitData = InitData
return UIAllianceGiftInfoCtrl