---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
---

local base = UIBaseView--Variable
local UIAlLeaderVoteView = BaseClass("UIAlLeaderVoteView", base)--Variable
local AlLeaderCandidateItem = require "UI.UIAlliance.UIAlLeaderVote.Component.AlLeaderCandidateItem"

local titleTxt_path = "UICommonMidPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
local svContent_path = "ImgBg/ScrollView/Viewport/Content"
local template_path = "ImgBg/template(inactive)/voteItem"
local confirmBtn_path = "ImgBg/confirmBtn"
local confirmBtnTxt_path = "ImgBg/confirmBtn/confirmBtnTxt"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
    SFSNetwork.SendMessage(MsgDefines.GetAlLeaderCandidates)
end

local function OnDestroy(self)
    
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleTxtN = self:AddComponent(UITextMeshProUGUIEx, titleTxt_path)
    self.titleTxtN:SetLocalText(390873) 
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.svContentN = self:AddComponent(UIBaseContainer, svContent_path)
    self.templateN = self:AddComponent(UIBaseContainer, template_path)
    self.templateN.gameObject:GameObjectCreatePool()
    self.confirmBtnN = self:AddComponent(UIButton, confirmBtn_path)
    self.confirmBtnN:SetOnClick(function()
        self:OnClickConfirmBtn()
    end)
    self.confirmBtnTxtN = self:AddComponent(UIText, confirmBtnTxt_path)
    self.confirmBtnTxtN:SetLocalText(390861) 
end

local function ComponentDestroy(self)
    self.titleTxtN = nil
    self.closeBtnN = nil
    self.svContentN = nil
    self.templateN = nil
    self.confirmBtnTxtN = nil
end

local function DataDefine(self)
    
end

local function DataDestroy(self)
    
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.AlLeaderCandidateUpdate, self.RefreshUI)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.AlLeaderCandidateUpdate, self.RefreshUI)
end

local function RefreshUI(self)
    self:SetCurCandidateUid(nil)
    
    self:RefreshCandidates()
end

local function RefreshCandidates(self)
    self.svContentN:RemoveComponents(AlLeaderCandidateItem)
    self.templateN.gameObject:GameObjectRecycleAll()

    local list = DataCenter.AllianceLeaderElectManager:GetAlLeaderCandidates()
    if list~=nil and #list>0 then
        for i = 1, table.length(list) do
            if list[i].type == 25 then
                self:SetRewardHero(list[i])
            else
                local item = self.templateN.gameObject:GameObjectSpawn(self.svContentN.transform)
                item.name = "candidate_" .. i
                local obj = self.svContentN:AddComponent(AlLeaderCandidateItem,item.name)
                local tempParam =  AlLeaderCandidateItem.Param.New()
                tempParam.uid = list[i].uid
                tempParam.name = list[i].name
                tempParam.voteNum = list[i].voteNum
                tempParam.pic = list[i].pic
                tempParam.picVer = list[i].picVer
                tempParam.isSelected = false
                obj:SetItem(tempParam)
            end
        end
    end
end

local function SetCurCandidateUid(self, uid, isOn)
    if self.curCandidateUid == uid and not isOn then
        self.curCandidateUid = nil
    elseif self.curCandidateUid ~= uid and isOn then
        self.curCandidateUid = uid
    end
    
    if self.curCandidateUid then
        CS.UIGray.SetGray(self.confirmBtnN.transform, false, true)
    else
        CS.UIGray.SetGray(self.confirmBtnN.transform, true, false)
    end
end

local function OnClickConfirmBtn(self)
    SFSNetwork.SendMessage(MsgDefines.AllianceLeaderVote, self.curCandidateUid)
    self.ctrl:CloseSelf()
end

UIAlLeaderVoteView.OnCreate = OnCreate
UIAlLeaderVoteView.OnDestroy = OnDestroy
UIAlLeaderVoteView.OnAddListener = OnAddListener
UIAlLeaderVoteView.OnRemoveListener = OnRemoveListener
UIAlLeaderVoteView.ComponentDefine = ComponentDefine
UIAlLeaderVoteView.ComponentDestroy = ComponentDestroy
UIAlLeaderVoteView.DataDefine = DataDefine
UIAlLeaderVoteView.DataDestroy = DataDestroy

UIAlLeaderVoteView.OnClickConfirmBtn = OnClickConfirmBtn
UIAlLeaderVoteView.RefreshUI = RefreshUI
UIAlLeaderVoteView.RefreshCandidates = RefreshCandidates
UIAlLeaderVoteView.SetCurCandidateUid = SetCurCandidateUid

return UIAlLeaderVoteView