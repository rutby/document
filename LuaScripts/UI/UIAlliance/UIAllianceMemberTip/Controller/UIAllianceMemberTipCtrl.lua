---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/22 11:15
---
local UIAllianceMemberTipCtrl = BaseClass("UIAllianceMemberTipCtrl", UIBaseCtrl)
local Localization = CS.GameEntry.Localization

local function CloseSelf(self)
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIAllianceMemberTip)
end

local function Close(self)
    UIManager:GetInstance():DestroyWindowByLayer(UILayer.Normal)
end

--openType:AllianceMemberOpenType
local function GetAllianceMemberBtnList(self,rank,uid,selfRank,UIName,playerName, openType)
    local list = {}
    
    if openType == AllianceMemberOpenType.AllianceMember or openType == AllianceMemberOpenType.OtherAlMember then
        local item1 ={}
        item1.type = AllianceMemberManageType.MemberData
        item1.name = Localization:GetString("100092")
        item1.uid =uid
        item1.playerName = playerName
        item1.UIName =UIName
        item1.selfRank = selfRank
        table.insert(list,item1)

        local item7 ={}
        item7.type = AllianceMemberManageType.Mail
        item7.name = Localization:GetString("290038")
        item7.uid =uid
        item7.UIName =UIName
        item7.playerName = playerName
        item7.selfRank = selfRank
        table.insert(list,item7)

        if selfRank>rank then
            if selfRank == 5 then
                local item5 ={}
                item5.type = AllianceMemberManageType.LeaderTrans
                item5.name = Localization:GetString("390274")
                item5.uid =uid
                item5.UIName =UIName
                item5.playerName = playerName
                item5.selfRank = selfRank
                table.insert(list,item5)
            end
            if selfRank>2 then
                local item2 ={}
                item2.type = AllianceMemberManageType.MemberRankChange
                item2.name = Localization:GetString("390127")
                item2.uid =uid
                item2.UIName =UIName
                item2.playerName = playerName
                item2.selfRank = selfRank
                table.insert(list,item2)
            end

            --if selfRank-rank > 1 then
            --    
            --end
            --if rank>1 then
            --    local item3 ={}
            --    item3.type = AllianceMemberManageType.MemberDown
            --    item3.name = Localization:GetString("390128")
            --    item3.uid =uid
            --    item3.UIName =UIName
            --    item3.playerName = playerName
            --    table.insert(list,item3)
            --end
            local item4 ={}
            item4.type = AllianceMemberManageType.MemberQuit
            item4.name = Localization:GetString("390129")
            item4.uid =uid
            item4.UIName =UIName
            item4.playerName = playerName
            item4.selfRank = selfRank
            table.insert(list,item4)
        elseif selfRank>3 and rank ==5 then
            local item6 ={}
            item6.type = AllianceMemberManageType.LeaderReplace
            item6.name = Localization:GetString("390190")
            item6.uid =uid
            item6.UIName =UIName
            item6.playerName = playerName
            item6.selfRank = selfRank
            table.insert(list,item6)
        end
    end
    --MK_临时关闭联盟资源援助
    --if openType ~= AllianceMemberOpenType.GolloesTrande and openType ~= AllianceMemberOpenType.OtherAlMember then
    --    local item8 ={}
    --    item8.type = AllianceMemberManageType.ResSupport
    --    item8.name = Localization:GetString("140044")
    --    item8.uid =uid
    --    item8.UIName =UIName
    --    item8.playerName = playerName
    --    item8.selfRank = selfRank
    --    table.insert(list,item8)
    --end
    if openType == AllianceMemberOpenType.GolloesTrande then
        local item9 ={}
        item9.type = AllianceMemberManageType.GolloesTrade
        item9.name = Localization:GetString("320248")
        item9.uid =uid
        item9.UIName =UIName
        item9.playerName = playerName
        item9.selfRank = selfRank
        table.insert(list,item9)
    end

    return list
end

local function OnMemberBtnClick(self,type,uid,UIName,playerName,selfRank)
    if type == AllianceMemberManageType.LeaderTrans then
        local memberData = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
        local message = Localization:GetString("390130",memberData.name)
        UIUtil.ShowMessage(message, 1, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL,function()
            SFSNetwork.SendMessage(MsgDefines.AllianceLeaderTrans,uid)
        end, function()
        end)
    elseif type == AllianceMemberManageType.LeaderReplace then
        local memberData = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
        local dt = UITimeManager:GetInstance():GetServerTime()- memberData.offLineTime
        local k7 = LuaEntry.DataConfig:TryGetNum("alliance_cost", "k7")
        if dt<=7*24*60*60*1000 or memberData.online then
            UIUtil.ShowTips(Localization:GetString("390191",k7))
        else
            local message = Localization:GetString("390192",k7)
            UIUtil.ShowMessage(message, 1, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL,function()
                SFSNetwork.SendMessage(MsgDefines.AllianceLeaderReplace,uid)
            end, function()
            end)
        end
    elseif type == AllianceMemberManageType.MemberQuit then
        local official = DataCenter.AllianceMemberDataManager:GetOfficialByUid(uid)
        if official~=nil and official~="" then
            UIUtil.ShowTipsId(390303) 
        else
            local memberData = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
            local message = Localization:GetString("390094",memberData.name)
            UIUtil.ShowMessage(message, 1, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL,function()
                SFSNetwork.SendMessage(MsgDefines.AllianceKickMember,uid)
            end, function()
            end)
        end
    elseif type == AllianceMemberManageType.MemberRankChange then
        local memberData = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
        if memberData~=nil and selfRank>2 then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceRankSelect,memberData.rank,uid,selfRank-1)
        end
        
    elseif type == AllianceMemberManageType.MemberData then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo,{ anim = true},uid)
        self:CloseSelf()
    elseif type == AllianceMemberManageType.Mail then
        local userId = uid
        local roomId = ChatManager2:GetInstance().Room:GetPrivateRoomByUserId(userId)
        local param = {}
        param["roomId"] = roomId
        param["userId"] = userId
        param["username"] = playerName
        GoToUtil.GotoOpenView(UIWindowNames.UIChatNew,{anim = false, hideTop = true ,UIMainAnim = UIMainAnimType.AllHide},param)
    elseif type == AllianceMemberManageType.ResSupport then
        local buildList = DataCenter.BuildManager:GetAllBuildingByItemIdWithoutPickUp(BuildingTypes.FUND_BUILD_ALLIANCE_CENTER)
        if buildList==nil or table.count(buildList) == 0 or buildList[1]==nil then
            UIUtil.ShowTipsId(390836) 
            return
        end
        local memberInfo = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
        if memberInfo.pointId == 0 then
            UIUtil.ShowTipsId(129072) 
            return
        end
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIResSupport,uid)
        self:CloseSelf()
    elseif type == AllianceMemberManageType.GolloesTrade then
        local memberInfo = DataCenter.AllianceMemberDataManager:GetAllianceMemberByUid(uid)
        if memberInfo.pointId == 0 then
            UIUtil.ShowTipsId(320250) 
            return
        end
        UIManager:GetInstance():DestroyWindow(UIWindowNames.UIAllianceMemberDetail)
        --UIUtil.ShowMessage(Localization:GetString("320258", playerName),2,nil,nil,function ()
        --end,nil,nil)
        self:StartTrade(memberInfo.pointId)
        UIUtil.ShowTipsId(320331)
        self:CloseSelf()
    end
    self:CloseSelf()
end

local function StartTrade(self, pointId)
    local worldMarch, formationInfo = DataCenter.GolloesCampManager:GetGolloesMarchByType(GolloesType.Trader)
    
    local freeUuid = formationInfo.uuid
    local marchTargetType = MarchTargetType.GOLLOES_TRADE
    local sfsObj = SFSObject.New()
    sfsObj:PutLong("uuid", freeUuid)
    local formationArray = SFSArray.New()
    sfsObj:PutSFSArray("formations", formationArray)
    local heroArray = SFSArray.New()
    sfsObj:PutSFSArray("heroInfos", heroArray)

    local dataObj = sfsObj
    local startPoint = 0;
    local buildList = DataCenter.BuildManager:GetAllBuildingByItemIdWithoutPickUp(BuildingTypes.FUN_BUILD_GROCERY_STORE)
    if buildList~=nil and table.count(buildList) > 0 and buildList[1]~=nil then
        startPoint = buildList[1].pointId
    end
    MarchUtil.StartMarch(marchTargetType, pointId, -1, -1, 0, freeUuid, 1, dataObj,startPoint)
    self:CloseSelf()
end


UIAllianceMemberTipCtrl.CloseSelf =CloseSelf
UIAllianceMemberTipCtrl.Close =Close
UIAllianceMemberTipCtrl.GetAllianceMemberBtnList = GetAllianceMemberBtnList
UIAllianceMemberTipCtrl.OnMemberBtnClick = OnMemberBtnClick

return UIAllianceMemberTipCtrl