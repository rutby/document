---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/11/13 15:40
---
local UIAllianceDetailView = BaseClass("UIAllianceDetailView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"

local txt_title_path ="UICommonMidPopUpTitle/bg_mid/titleText"
local close_btn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonMidPopUpTitle/panel"
local name_path = "ImgBg/TopInfo/name"

local power_txt_path = "ImgBg/TopInfo/layout/power/powerTxt"
local leader_path = "ImgBg/TopInfo/layout/leader"
local leader_txt_path = "ImgBg/TopInfo/layout/leader/leaderTxt"
local land_path = "ImgBg/TopInfo/layout/language"
local land_txt_path = "ImgBg/TopInfo/layout/language/languageTxt"
--local gift_path = "ImgBg/TopInfo/gift"
local gift_txt_path = "ImgBg/TopInfo/layout/gift/giftTxt"
local people_path = "ImgBg/TopInfo/layout/people"
local people_txt_path = "ImgBg/TopInfo/layout/people/peopleTxt"
local des_txt_path = "ImgBg/Align/ScrollView/Viewport/Content/desTxt"
local comment_btn_path = "ImgBg/Align/commentButton"
local comment_txt_path = "ImgBg/Align/commentButton/commentText"
local mail_btn_path = "ImgBg/Align/layout/mailButton"
local mail_txt_path = "ImgBg/Align/layout/mailButton/mailText"
local mem_btn_path = "ImgBg/Align/layout/memberButton"
local mem_txt_path = "ImgBg/Align/layout/memberButton/memberText"
local join_set_tip_path = "ImgBg/Align/joinSet/joinSetTip"
local level_set_txt_path = "ImgBg/Align/joinSet/levelSetTxt"
local power_set_txt_path = "ImgBg/Align/joinSet/powerSetTxt"
local career_set_tip_path = "ImgBg/Align/joinSet/careerSetTip"
local career_set_txt_path = "ImgBg/Align/joinSet/careerSetTxt"
local allianceFlag_path = "ImgBg/TopInfo/icon/AllianceFlag"
local countryFlag_path = "ImgBg/TopInfo/layout/language/languageTxt/countryFlag"

local function OnCreate(self)
    base.OnCreate(self)
    local allianceName,allianceId = self:GetUserData()
    self.allianceId = allianceId
    SFSNetwork.SendMessage(MsgDefines.GetAllianceInfo,allianceId)
    --self.ctrl:SendSearchMessageToServer(1,1,allianceName,0)
    self.txt_title = self:AddComponent(UITextMeshProUGUIEx, txt_title_path)
    self.txt_title:SetLocalText(GameDialogDefine.ALLIANCE) 
    self.name = self:AddComponent(UITextMeshProUGUIEx,name_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx,power_txt_path)
    self.leader = self:AddComponent(UITextMeshProUGUIEx,leader_path)
    self.leader_txt = self:AddComponent(UITextMeshProUGUIEx,leader_txt_path)
    self.land = self:AddComponent(UITextMeshProUGUIEx,land_path)
    self.land_txt = self:AddComponent(UITextMeshProUGUIEx,land_txt_path)
    --self.gift = self:AddComponent(UITextMeshProUGUIEx,gift_path)
    self.gift_txt = self:AddComponent(UITextMeshProUGUIEx,gift_txt_path)
    self.people = self:AddComponent(UITextMeshProUGUIEx,people_path)
    self.people_txt = self:AddComponent(UITextMeshProUGUIEx,people_txt_path)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx,des_txt_path)

    self.power_txt:SetLocalText(100644) 
    self.leader:SetLocalText(390006) 
    self.land:SetLocalText(100101) 
    --self.gift:SetLocalText(390445) 
    self.people:SetLocalText(390098) 

    self.join_set_tip = self:AddComponent(UITextMeshProUGUIEx, join_set_tip_path)
    self.join_set_tip:SetLocalText(390846)
    self.level_set_txt = self:AddComponent(UITextMeshProUGUIEx, level_set_txt_path)
    self.power_set_txt = self:AddComponent(UITextMeshProUGUIEx, power_set_txt_path)
    self.career_set_tip = self:AddComponent(UITextMeshProUGUIEx, career_set_tip_path)
    self.career_set_tip:SetLocalText(395405)
    self.career_set_txt = self:AddComponent(UITextMeshProUGUIEx, career_set_txt_path)
    self.AllianceFlag = self:AddComponent(AllianceFlagItem, allianceFlag_path)
    self.countryFlagN = self:AddComponent(UIImage, countryFlag_path)
    self.countryFlagN:SetActive(not LuaEntry.Player:IsHideCountryFlag())
    
    self.commentBtnImg = self:AddComponent(UIImage, comment_btn_path)
    
    self.comment_btn = self:AddComponent(UIButton, comment_btn_path)
    self.comment_btn :SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickCommentBtn() 
    end)
    self.goTextMat = self.transform:Find("ImgBg/Align/commentButton/goTextMat"):GetComponent(typeof(CS.UnityEngine.MeshRenderer))
    self.comment_txt = self:AddComponent(UITextMeshProUGUIEx,comment_txt_path)
    self.comment_txt:SetLocalText(390009)
    self.mail_btn = self:AddComponent(UIButton, mail_btn_path)
    self.mail_btn :SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnMailClick()
        --UIUtil.ShowTipsId(120018) 
    end)
    self.mail_txt = self:AddComponent(UITextMeshProUGUIEx,mail_txt_path)
    self.mail_txt:SetLocalText(390086) 

    self.mem_btn = self:AddComponent(UIButton, mem_btn_path)
    self.mem_btn :SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnMemberClick()
    end)
    self.mem_txt = self:AddComponent(UITextMeshProUGUIEx,mem_txt_path)
    self.mem_txt:SetLocalText(390199) 
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()  
        self.ctrl:CloseSelf()
    end)

    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.return_btn:SetOnClick(function()  
        self.ctrl:CloseSelf()
    end)
end

local function OnDestroy(self)
    self.name = nil
    self.power_txt = nil
    self.leader = nil
    self.leader_txt = nil
    self.land = nil
    self.land_txt = nil
    --self.gift = nil
    self.gift_txt = nil
    self.people = nil
    self.people_txt = nil
    self.des_txt = nil
    self.item_prefab = nil
    self.join_set_tip = nil
    self.level_set_txt = nil
    self.power_set_txt = nil
    self.career_set_tip = nil
    self.career_set_txt = nil
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnRefresh(self)
    self.data = self.view.ctrl:GetAllianceData(self.allianceId)
	if self.data then
	    self.name:SetText("<" .. self.data.abbr .. "> " .. self.data.allianceName)--(self.data.allianceName)
        self.power_txt:SetText(string.GetFormattedSeperatorNum(self.data.fightPower))
        local leaderName = self.data.leaderUid == "" and Localization:GetString("100206") or self.data.leaderName
	    self.leader_txt:SetText(leaderName)
        local languageId = self.data.language == "" and 115600 or self.data.language
	    self.land_txt:SetLocalText(languageId) 
	    self.gift_txt:SetLocalText(300665,self.data.giftLevel)
	    self.people_txt:SetText(self.data.curMember.."/"..self.data.maxMember)
	    if self.data.announce~=nil and self.data.announce~="" then
	        self.des_txt:SetText(self.data.announce)
	    else
	        self.des_txt:SetLocalText(390118) 
	    end

        self.AllianceFlag:SetData(self.data.icon)
        
        local nationTemplate = self.data:GetCountryFlagTemplate()
        self.countryFlagN:LoadSprite(nationTemplate:GetNationFlagPath())
        
        if self.data.castleRestrictionN > 0 or self.data.powerRestrictionN > 0 then
            if self.data.castleRestrictionN > 0 then
                self.level_set_txt:SetActive(true)
                self.level_set_txt:SetText(Localization:GetString("100082").." > "..self.data.castleRestrictionN)
            else
                self.level_set_txt:SetActive(false)
            end
            if self.data.powerRestrictionN > 0 then
                self.power_set_txt:SetActive(true)
                self.power_set_txt:SetText(Localization:GetString("100644").." > "..string.GetFormattedSeperatorNum(self.data.powerRestrictionN))
            else
                self.power_set_txt:SetActive(false)
            end
        else
            self.power_set_txt:SetActive(true)
            self.power_set_txt:SetLocalText(150014) 
            self.level_set_txt:SetActive(false)
        end

        self.career_set_tip:SetActive(false)
        self.career_set_txt:SetActive(false)

        self.commentBtnImg:LoadSprite(string.format(LoadPath.CommonNewPath,"Common_btn_blue_big"))
        self.comment_txt:SetMaterial(self.goTextMat.sharedMaterials[1])
        if LuaEntry.Player:IsInAlliance() then
            self.comment_btn:SetActive(true)
            self.comment_txt:SetLocalText(390009)
        else
            if self.data.createServer == LuaEntry.Player:GetSelfServerId() then
                self.comment_btn:SetActive(true)
                if self.data.applied == 1 then
                    --cancel
                    self.commentBtnImg:LoadSprite(string.format(LoadPath.CommonNewPath,"Common_btn_red101"))
                    self.comment_txt:SetMaterial(self.goTextMat.sharedMaterials[3])
                    self.comment_txt:SetLocalText(GameDialogDefine.CANCEL)
                else
                    if self.data.recruitTotal == 0 then
                        --join
                        self.comment_txt:SetLocalText(110037)
                    else
                        --apply
                        self.commentBtnImg:LoadSprite(string.format(LoadPath.CommonNewPath,"Common_btn_green101"))
                        self.comment_txt:SetMaterial(self.goTextMat.sharedMaterials[2])
                        self.comment_txt:SetLocalText(110090)
                    end
                end
            else
                self.comment_btn:SetActive(false)
            end
        end
	else
        self.comment_btn:SetActive(false)
		self.name:SetText("")
		self.power_txt:SetText("0")
		self.leader_txt:SetText("")
		self.land_txt:SetText("")
		self.gift_txt:SetText("")
		self.people_txt:SetText("0/0")
		self.des_txt:SetText("")
		self.level_set_txt:SetText("")
		self.power_set_txt:SetText("")
        local nationTemplate = DataCenter.NationTemplateManager:GetNationTemplate(DefaultNation)
        self.countryFlagN:LoadSprite(nationTemplate:GetNationFlagPath())
	end
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.SearchAllianceSuccess, self.OnRefresh)
    self:AddUIListener(EventId.AllianceBaseDataUpdated, self.OnRefresh)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.SearchAllianceSuccess, self.OnRefresh)
    self:RemoveUIListener(EventId.AllianceBaseDataUpdated, self.OnRefresh)
end

local function OnMemberClick(self)
    if not self.data then
        UIUtil.ShowTips(Localization:GetString("E100086"))
        return
    end
    self.ctrl:OnAllianceMemberClick(self.allianceId)
end

local function OnMailClick(self)
    if not self.data then
        UIUtil.ShowTips(Localization:GetString("E100086"))
        return
    end
    self.ctrl:OnLeaderMailClick(self.data.leaderUid,self.data.leaderName)
end

local function OnClickCommentBtn(self)
    if LuaEntry.Player:IsInAlliance() then
        UIUtil.ShowTipsId(120018)
    else
        if not self.data then
            UIUtil.ShowTips(Localization:GetString("E100086"))
            return
        end
        if self.data.applied == 1 then
            SFSNetwork.SendMessage(MsgDefines.AlCancelApply,self.allianceId)
            self.data.applied = 0
            self:OnRefresh()
        else
            local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
            if seasonId == 5 then
                if DataCenter.RobotWarsManager:GetSelfCamp()>0 and DataCenter.GloryManager:IsSameCampByAllianceId(self.allianceId) == false then
                    return UIUtil.ShowTipsId(111093)
                end
            end
            local tempType = self.data.recruitTotal == 0 and 0 or 1
            SFSNetwork.SendMessage(MsgDefines.AlApply,self.allianceId,tempType,self.data.language)
            if tempType == 1 then
                self.data.applied = 1
                self:OnRefresh()
            end
        end
    end
    self.ctrl:CloseSelf()
end

UIAllianceDetailView.OnCreate = OnCreate
UIAllianceDetailView.OnDestroy = OnDestroy
UIAllianceDetailView.OnRefresh = OnRefresh
UIAllianceDetailView.OnEnable = OnEnable
UIAllianceDetailView.OnDisable = OnDisable
UIAllianceDetailView.OnAddListener = OnAddListener
UIAllianceDetailView.OnRemoveListener = OnRemoveListener
UIAllianceDetailView.OnMemberClick = OnMemberClick
UIAllianceDetailView.OnMailClick =OnMailClick
UIAllianceDetailView.OnClickCommentBtn =OnClickCommentBtn
return UIAllianceDetailView