---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/8/10 18:05
---
local AllianceWarPlayerSoliderItem = require "UI.UIAlliance.UIAllianceWarDetail.Component.AllianceWarPlayerSoliderItem"
local AllianceWarTroops = BaseClass("AllianceWarTroops",UIBaseContainer)
local base = UIBaseContainer
local SoldierType = { TANK = 1, INFANTRY = 2 ,PLANE = 3} --坦克，步兵，飞机

function AllianceWarTroops:OnCreate()
    base.OnCreate(self)
    
    self.type1_obj = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType1")
    self.type2_obj = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType2")
    self.type3_obj = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType3")
    self.soldiersObj_rect ={[1] = self.type1_obj,[2] = self.type2_obj,[3] = self.type3_obj}
    self.type1_amount_txt = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType1/Txt_Amount1")
    self.type2_amount_txt = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType2/Txt_Amount2")
    self.type3_amount_txt = self:AddComponent(UITextMeshProUGUIEx,"mainContent/soldierType3/Txt_Amount3")
    self.soldiersNum_txt ={[1] = self.type1_amount_txt,[2] = self.type2_amount_txt,[3] = self.type3_amount_txt}
    for i = 1, 3 do
        self.soldiersNum_txt[i]:SetText("")
    end
    self.showBtn_btn = self:AddComponent(UIButton, "mainContent/Btn_ShowBtn")
    self.showBtn_btn:SetOnClick(function ()
        self:OnShowClick()
    end)
    
    self.arrowSelect_img = self:AddComponent(UIImage,"mainContent/ImgArrowSelect")
    self.arrowNormal_img = self:AddComponent(UIImage,"mainContent/ImgArrowNormal")
    self.content_rect = self:AddComponent(UIBaseContainer, "armyContent")

    self.model = {}
end

function AllianceWarTroops:OnDestroy()
    self:SetAllCellDestroy()
    for i = 1, 3 do
        self.soldiersNum_txt[i] = nil
        self.soldiersObj_rect[i] = nil
    end
    self.showBtn_btn = nil 
    self.arrowSelect_img = nil
    self.arrowNormal_img = nil
    base.OnDestroy(self)
end

function AllianceWarTroops:OnEnable()
    base.OnEnable(self)
end

function AllianceWarTroops:OnDisable()
    self.content_rect:RemoveComponents(AllianceWarPlayerSoliderItem)
    base.OnDisable(self)
end

function AllianceWarTroops:SetAllCellDestroy()
    self.content_rect:RemoveComponents(AllianceWarPlayerSoliderItem)
    if next(self.model) then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end

function AllianceWarTroops:RefreshData(param)
    self.showSolider = false
    self.arrowSelect_img:SetActive(true)
    self.arrowNormal_img:SetActive(false)
    for i = 1, 3 do
        self.soldiersObj_rect[i]:SetActive(false)
    end
    local info = {}
    table.walk(param, function(k,v)
        if info[v.type] == nil then
            info[v.type] = v.num
        else
            info[v.type] = info[v.type] + v.num
        end
    end)
    table.walk(info, function(k,v)
            self.soldiersObj_rect[k]:SetActive(true)
            self.soldiersNum_txt[k]:SetText(v)
    end)
end

function AllianceWarTroops:OnShowClick()
    self:SetAllCellDestroy()
    if self.showSolider then
        self.arrowSelect_img:SetActive(true)
        self.arrowNormal_img:SetActive(false)
        self.content_rect:SetActive(false)
        self.showSolider =false
    else
        self.arrowSelect_img:SetActive(false)
        self.arrowNormal_img:SetActive(true)
        self.content_rect:SetActive(true)
        self.showSolider =true
        local list = self.view.ctrl:GetAllSoldiersInfo()
        if list~=nil then
            table.walk(list, function(k,v)
                --复制基础prefab，每次循环创建一次
                self.model[k] = self:GameObjectInstantiateAsync(UIAssets.AllianceWarPlayerSoliderItem, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go:SetActive(true)
                    go.transform:SetParent(self.content_rect.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    go.name = k
                    local cell = self.content_rect:AddComponent(AllianceWarPlayerSoliderItem,go.name)
                    cell:SetData(DataCenter.ArmyTemplateManager:GetArmyTemplate(tonumber(k)),v.num)
                end)
            end)
        end
    end
end

return AllianceWarTroops