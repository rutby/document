---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
---

local UIHeroTipsView = require "UI.UIHeroTips.View.UIHeroTipsView"
local base = UIBaseView--Variable
local UISetAlOfficialPosView = BaseClass("UISetAlOfficialPosView", base)--Variable
local Localization = CS.GameEntry.Localization
local SetAlOfficialPosItem = require "UI.UIAlliance.UISetAlOfficialPos.Component.SetAlOfficialPosItem"

local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local posIcon_path = "offset/pos/posIcon"
local posTip_path = "offset/pos/posTip"
local memberSr_path = "offset/memberList"
local memberContent_path = "offset/memberList/Viewport/Content"
local confirmBtn_path = "offset/confirmBtn"
local confirmBtnTxt_path = "offset/confirmBtn/confirmTxt"
local noR4Tip_path = "offset/noR4Tip"
local setTip_path = "offset/setTip"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
    self:InitUI()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UIText, title_path)
    self.titleN:SetLocalText(391072)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
       self:OnClickCloseBtn() 
    end)
    self.posIconN = self:AddComponent(UIImage, posIcon_path)
    self.posTipN = self:AddComponent(UIText, posTip_path)
    self.memberSrN = self:AddComponent(UIScrollRect, memberSr_path)
    self.memberContentN = self:AddComponent(UIBaseContainer, memberContent_path)
    self.noR4TipN = self:AddComponent(UIText, noR4Tip_path)
    self.noR4TipN:SetLocalText(391102)
    self.setTipN = self:AddComponent(UIText, setTip_path)
    self.setTipN:SetLocalText(391073)
    self.memberItemList = {}
    self.confirmBtnN = self:AddComponent(UIButton, confirmBtn_path)
    self.confirmBtnN:SetOnClick(function()
        self:OnClickConfirmBtn()
    end)
    self.confirmBtnTxtN = self:AddComponent(UIText, confirmBtnTxt_path)
    self.confirmBtnTxtN:SetLocalText(110006)
end

local function ComponentDestroy(self)
    self:ClearReq()
end

local function DataDefine(self)
    self.reqDic = {}
    self.officialPos = 1
    self.curUid = nil
    self.origUid = nil
    self.memberItemDic = {}
end

local function DataDestroy(self)
    self.reqDic = nil
    self.officialPos = nil
    self.curUid = nil
    self.origUid = nil
    self.memberItemDic = nil
end

--[[
local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end
--]]

local function InitUI(self)
    
    self.officialPos, self.origUid = self:GetUserData()
    self.curUid = self.origUid
    
    self:RefreshAll()
end

local function RefreshAll(self)
    self.posIconN:LoadSprite(string.format("Assets/Main/Sprites/UI/UIAlliance/%s", AllianceOfficialPosConf[self.officialPos].icon))
    self.posTipN:SetLocalText(AllianceOfficialPosConf[self.officialPos].tip)
    
    self:RefreshMemberList()
end

local function RefreshMemberList(self)
    self:ClearReq()
    
    local memberList = self.ctrl:GetMemberListByRank(4)
    if #memberList > 0 then
        self.memberSrN:SetActive(true)
        self.noR4TipN:SetActive(false)
        if memberList ~= nil then
            for k,v in ipairs(memberList) do
                self.reqDic[v.uid] = self:GameObjectInstantiateAsync(UIAssets.SetAlOfficialPosItem, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.gameObject:SetActive(true)
                    go.transform:SetParent(self.memberContentN.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local cell = self.memberContentN:AddComponent(SetAlOfficialPosItem,nameStr)
                    cell:SetItem(v, v.uid == self.curUid)
                    self.memberItemDic[v.uid] = cell
                end)
            end
        end
    else
        self.memberSrN:SetActive(false)
        self.noR4TipN:SetActive(true)
    end 
end

local function ClearReq(self)
    if self.req ~= nil then
        for k,v in pairs(self.req) do
            self:GameObjectDestroy(v)
        end
    end
    self.req = {}
end

local function OnClickCloseBtn(self)
    self.ctrl:CloseSelf()
end

local function OnClickConfirmBtn(self)
    if self.curUid ~= self.origUid then
        local pos = self.curUid and self.officialPos or 0
        local uid = self.curUid and self.curUid or self.origUid
        SFSNetwork.SendMessage(MsgDefines.SetAllianceOfficialPos, uid, pos)
    end
    
    self.ctrl:CloseSelf()
end

local function TrySelectMember(self, uid)
    if uid == self.curUid then
        if self.memberItemDic[self.curUid] then
            self.memberItemDic[self.curUid]:SetIsSelected(false)
        end
        self.curUid = nil
    else
        if self.curUid and self.memberItemDic[self.curUid] then
            self.memberItemDic[self.curUid]:SetIsSelected(false)
        end 
        self.memberItemDic[uid]:SetIsSelected(true)
        self.curUid = uid
    end
    
end



UISetAlOfficialPosView.OnCreate = OnCreate 
UISetAlOfficialPosView.OnDestroy = OnDestroy
--UISetAlOfficialPosView.OnAddListener = OnAddListener
--UISetAlOfficialPosView.OnRemoveListener = OnRemoveListener
UISetAlOfficialPosView.ComponentDefine = ComponentDefine
UISetAlOfficialPosView.ComponentDestroy = ComponentDestroy
UISetAlOfficialPosView.DataDefine = DataDefine
UISetAlOfficialPosView.DataDestroy = DataDestroy

UISetAlOfficialPosView.InitUI = InitUI
UISetAlOfficialPosView.RefreshAll = RefreshAll
UISetAlOfficialPosView.RefreshMemberList = RefreshMemberList
UISetAlOfficialPosView.ClearReq = ClearReq
UISetAlOfficialPosView.OnClickCloseBtn = OnClickCloseBtn
UISetAlOfficialPosView.OnClickConfirmBtn = OnClickConfirmBtn
UISetAlOfficialPosView.TrySelectMember = TrySelectMember

return UISetAlOfficialPosView