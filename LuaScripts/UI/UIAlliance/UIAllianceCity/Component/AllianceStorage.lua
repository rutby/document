---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/29 11:14
---

local base = UIBaseContainer--Variable
local AllianceStorage = BaseClass("AllianceStorage", base)--Variable
local AllianceStorageResItem = require "UI.UIAlliance.UIAllianceCity.Component.AllianceStorageResItem"
local AllianceStorageRecordItem = require "UI.UIAlliance.UIAllianceCity.Component.AllianceStorageRecordItem"
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local Localization = CS.GameEntry.Localization

local resContent_path = "Maintitlebg/res"
local recordContainer_path = "record/hasRecord"
local svRecord_path = "record/hasRecord/ScrollView"
local noRecordTip_path = "record/noRecordtxt"
local storageTip_path = "Maintitlebg/storageTip"
local infoBtn_path = "Maintitlebg/infoBtn"
local storageDesc_path = "desc"
local recordTip_path = "record/recordTip"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.resContentN = self:AddComponent(UIBaseContainer, resContent_path)
    self.recordContainerN = self:AddComponent(UIBaseContainer, recordContainer_path)
    self.svRecordN = self:AddComponent(UIScrollView, svRecord_path)
    self.svRecordN:SetOnItemMoveIn(function(itemObj, index)
        self:OnRecordItemMoveIn(itemObj, index)
    end)
    self.svRecordN:SetOnItemMoveOut(function(itemObj, index)
        self:OnRecordItemMoveOut(itemObj, index)
    end)
    self.noRecordTipN = self:AddComponent(UITextMeshProUGUIEx, noRecordTip_path)
    self.noRecordTipN:SetLocalText(390992)
    self.storageTipN = self:AddComponent(UITextMeshProUGUIEx, storageTip_path)
    self.storageTipN:SetLocalText(390963)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.storageDescN = self:AddComponent(UITextMeshProUGUIEx, storageDesc_path)
    self.storageDescN:SetLocalText(390972)
    self.recordTipN = self:AddComponent(UITextMeshProUGUIEx, recordTip_path)
    self.recordTipN:SetLocalText(390969)
end

local function ComponentDestroy(self)

end

local function DataDefine(self)
    self.recordList = {}
end

local function DataDestroy(self)
    self.recordList = nil
end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnRecvAllianceStorageInfo, self.RefreshAll)

end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnRecvAllianceStorageInfo, self.RefreshAll)
    base.OnRemoveListener(self)
end



local function InitData(self)
    SFSNetwork.SendMessage(MsgDefines.GetAllianceStorageInfo)
end

local function RefreshAll(self)
    self:RefreshRes()
    self:RefreshRecords()
end

local function RefreshRes(self)
    self:SetAllResCellsDestroy()

    local rewardTypes = DataCenter.AllianceStorageManager:GetAlStorageContent()
    self.resModels = {}

    for i = 1, table.length(rewardTypes) do
        --复制基础prefab，每次循环创建一次
        self.resModels[i] = self:GameObjectInstantiateAsync(UIAssets.AllianceStorageResItem, function(request)
            if request.isError then
                return
            end
            local go = request.gameObject;
            --go.gameObject:SetActive(true)
            go.transform:SetParent(self.resContentN.transform)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go.name = i
            local cell = self.resContentN:AddComponent(AllianceStorageResItem,go.name)
            cell:SetItem(rewardTypes[i])
        end)
    end

end


local function SetAllResCellsDestroy(self)
    self.resContentN:RemoveComponents(AllianceStorageResItem)
    if self.resModels ~= nil then
        for k,v in pairs(self.resModels) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
end

local function RefreshRecords(self)
    self.recordList = DataCenter.AllianceStorageManager:GetStorageRecords()
    if #self.recordList > 0 then
        self.recordContainerN:SetActive(true)
        self.noRecordTipN:SetActive(false)

        self.svRecordN:SetTotalCount(#self.recordList)
        self.svRecordN:RefillCells()
    else
        self.recordContainerN:SetActive(false)
        self.noRecordTipN:SetActive(true)
    end
end

local function OnRecordItemMoveIn(self, itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.svRecordN:AddComponent(AllianceStorageRecordItem, itemObj)
    local recordInfo = self.recordList[index]
    cellItem:SetItem(recordInfo, index)
end

local function OnRecordItemMoveOut(self, itemObj, index)
    self.svRecordN:RemoveComponent(itemObj.name, AllianceStorageRecordItem)
end

local function ClearScroll(self)
    self.svRecordN:ClearCells()
    self.svRecordN:RemoveComponents(AllianceStorageRecordItem)
end

local function OnClickInfoBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.infoBtnN.transform.position + Vector3.New(-10, 0, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString("390971")
    param.dir = UIHeroTipView.Direction.LEFT
    param.defWidth = 400
    param.pivot = 0.66
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

AllianceStorage.OnCreate = OnCreate
AllianceStorage.OnDestroy = OnDestroy
AllianceStorage.OnAddListener = OnAddListener
AllianceStorage.OnRemoveListener = OnRemoveListener
AllianceStorage.ComponentDefine = ComponentDefine
AllianceStorage.ComponentDestroy = ComponentDestroy
AllianceStorage.DataDefine = DataDefine
AllianceStorage.DataDestroy = DataDestroy
AllianceStorage.InitData = InitData
AllianceStorage.RefreshAll = RefreshAll
AllianceStorage.RefreshRes = RefreshRes
AllianceStorage.SetAllResCellsDestroy = SetAllResCellsDestroy
AllianceStorage.RefreshRecords = RefreshRecords
AllianceStorage.OnRecordItemMoveIn = OnRecordItemMoveIn
AllianceStorage.OnRecordItemMoveOut = OnRecordItemMoveOut
AllianceStorage.ClearScroll = ClearScroll
AllianceStorage.OnClickInfoBtn = OnClickInfoBtn

return AllianceStorage