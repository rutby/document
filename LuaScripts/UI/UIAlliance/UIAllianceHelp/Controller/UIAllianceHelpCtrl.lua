---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/14 15:33
---
local AllianceHelpDataShow =
{
    helpId ="",
    uid = "",
    name ="",
    des ="",
    isSelf = false,
    nowCount = 0,
    maxCount =0,
}
local OneData = DataClass("OneData", AllianceHelpDataShow)
local UIAllianceHelpCtrl = BaseClass("UIAllianceHelpCtrl", UIBaseCtrl)
local Localization = CS.GameEntry.Localization
local function CloseSelf(self)
    
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIAllianceHelp, {anim = true})
end

local function Close(self)
    UIManager:GetInstance():DestroyWindowByLayer(UILayer.Normal)
end

local function InitData(self)
    SFSNetwork.SendMessage(MsgDefines.AllianceShowHelp)
end

local function GetAllianceHelpList(self)
    local showList = {}

    local otherList = DataCenter.AllianceHelpDataManager:GetOtherHelpList()
    if otherList ~=nil then
        table.walk(otherList,function (k,v)
            local oneData = OneData.New()
            oneData.helpId = v.helpId
            oneData.uid = v.senderId
            oneData.pic = v.pic
            oneData.picVer = v.picVer
            oneData.headBg = v:GetHeadBgImg()
            oneData.name = v.name
            oneData.isSelf = false
            oneData.reduceSec = v.reduceSec
            oneData.nowCount = v.nowCount
            oneData.maxCount = v.maxCount
            if v.helpType == AllianceHelpType.Queue then
                if v.queueType == NewQueueType.Science then
                    local science = DataCenter.ScienceManager:GetScienceTemplate(tonumber(v.itemId))
                    if science~=nil then
                        oneData.des = Localization:GetString("390113", Localization:GetString(science.name))
                    end
                elseif v.queueType == NewQueueType.Hospital then
                    oneData.des = Localization:GetString("390114")
                end
            elseif v.helpType == AllianceHelpType.Building then
                oneData.des = Localization:GetString("390115", v.level,
                        Localization:GetString(GetTableData(DataCenter.BuildTemplateManager:GetTableName(), v.itemId + v.level,"name")))
            elseif v.helpType == AllianceHelpType.FIX_BUILDING then
                oneData.des = Localization:GetString("390885", v.level,
                        Localization:GetString(GetTableData(DataCenter.BuildTemplateManager:GetTableName(), v.itemId + v.level,"name"))
                                .. "("..Localization:GetString("104202")..")")
            end
            table.insert(showList,oneData)
        end)
    end
    
    local selfList = DataCenter.AllianceHelpDataManager:GetSelfHelpList()
    if selfList ~=nil then
        table.walk(selfList,function (k,v)
            local oneData = OneData.New()
            oneData.helpId = v.helpId
            oneData.uid = v.senderId
            oneData.name = v.name
            oneData.isSelf = true
            oneData.pic = v.pic
            oneData.picVer = v.picVer
            oneData.headBg = v:GetHeadBgImg()
            oneData.reduceSec = v.reduceSec
            oneData.nowCount = v.nowCount
            oneData.maxCount = v.maxCount
            if v.helpType == AllianceHelpType.Queue then
                if v.queueType == NewQueueType.Science then
                    local science = DataCenter.ScienceManager:GetScienceTemplate(tonumber(v.itemId))
                    if science~=nil then
                        oneData.des = Localization:GetString("390113", Localization:GetString(science.name))
                    end
                elseif v.queueType == NewQueueType.Hospital then
                    oneData.des = Localization:GetString("390114")
                end
            elseif v.helpType == AllianceHelpType.Building then
                oneData.des = Localization:GetString("390115", v.level,
                        Localization:GetString(GetTableData(DataCenter.BuildTemplateManager:GetTableName(), v.itemId + v.level,"name")))
            elseif v.helpType == AllianceHelpType.FIX_BUILDING then
                oneData.des = Localization:GetString("390885", v.level,
                        Localization:GetString(GetTableData(DataCenter.BuildTemplateManager:GetTableName(), v.itemId + v.level,"name"))
                                .. "("..Localization:GetString("104202")..")")
            end
            table.insert(showList,oneData)
        end)
    end
    
    return showList
end

local function GetAllianceHelpSliderData(self)
    local oneData = {}
    oneData.todayHelpPoint = DataCenter.AllianceHelpDataManager:GetTodayHelpPoint()
    oneData.maxHelpCount = LuaEntry.DataConfig:TryGetNum("alliance_help", "k4")
    return oneData
end

local function OnHelpClick(self,helpId,uid)
    SFSNetwork.SendMessage(MsgDefines.AllianceRenderHelp,helpId,uid)
end
local function OnHelpAllClick(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    SFSNetwork.SendMessage(MsgDefines.AlHelpAll,math.floor(curTime))
end

UIAllianceHelpCtrl.CloseSelf =CloseSelf
UIAllianceHelpCtrl.Close =Close
UIAllianceHelpCtrl.GetAllianceHelpList =GetAllianceHelpList
UIAllianceHelpCtrl.InitData = InitData
UIAllianceHelpCtrl.OnHelpClick = OnHelpClick
UIAllianceHelpCtrl.OnHelpAllClick = OnHelpAllClick
UIAllianceHelpCtrl.GetAllianceHelpSliderData = GetAllianceHelpSliderData
return UIAllianceHelpCtrl