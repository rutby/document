---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/8/10 18:05
---
local AllianceWarPlayerSoliderItem = require "UI.UIAlliance.UIAllianceAlertDetail.Component.AllianceAlertSoliderItem"
local UIAllianceHeroCell = require "UI.UIChatNew.Component.RadarAlarmCells.UIAllianceHeroCell"
local AllianceAlertPlayerItem = BaseClass("AllianceAlertPlayerItem",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local name_path = "mainContent/nameTxt"
local power_path = "mainContent/powerTxt"
local slider_path = "mainContent/Slider"
local time_txt_path = "mainContent/Slider/TimeTxt"
local state_path= "mainContent/stateTxt"
local show_btn_path ="mainContent/showButton"
local close_img_path = "mainContent/ImgArrowNormal"
local open_img_path = "mainContent/ImgArrowSelect"
local marchPos_btn_path = "mainContent/Btn_MarchPos"
local _content_rect = "mainContent/Content"
local content_path = "armyContent"
local playerHead_path = "mainContent/UIPlayerHead/HeadIcon"
local playerHeadBg_path = "mainContent/UIPlayerHead/Foreground"
local SliderLength = 141
local function OnCreate(self)
    base.OnCreate(self)
    self.isUpdate =false
    self.lastChangeTextDeltaTime =0
    self.lastChangeImageDeltaTime =0
    self.name = self:AddComponent(UITextMeshProUGUIEx,name_path)
    self.power = self:AddComponent(UITextMeshProUGUIEx,power_path)
    self.state = self:AddComponent(UITextMeshProUGUIEx,state_path)
    self.state:SetLocalText(390141)
    self.close_img = self:AddComponent(UIImage,close_img_path)
    self.open_img = self:AddComponent(UIImage,open_img_path)
    self.show_btn = self:AddComponent(UIButton, show_btn_path)
    self.show_btn:SetOnClick(function ()
        self:OnShowClick()
    end)

    self.slider = self:AddComponent(UISlider,slider_path)
    self.time_txt = self:AddComponent(UITextMeshProUGUIEx,time_txt_path)
    
    self._content_rect = self:AddComponent(UIBaseContainer,_content_rect)
    self.modelHero = {}

    self.content = self:AddComponent(UIBaseContainer,content_path)

    self.playerHead = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadBg = self:AddComponent(UIImage, playerHeadBg_path)
    self.playerHeadBg.transform:SetAsLastSibling()

    self.marchPos_btn = self:AddComponent(UIButton,marchPos_btn_path)
    self.marchPos_btn:SetOnClick(function ()
        self:OnClickPos()
    end)
    
    self.model = {}
end

local function OnDestroy(self)
    self:DeleteTimer()
    self:SetAllCellDestroy()
    self:SetAllCellDestroyHero()
    self.name = nil
    self.power = nil
    self.state = nil
    
    self.isUpdate = nil
    self.playerHead = nil
    base.OnDestroy(self)
end

--isAlert是否盟友被单打标志
local function RefreshData(self,data,isAlert)
    self.data = data
    self.marchPos_btn:SetActive(isAlert)
    self.timer_action = function(temp)  self:RefreshTime() end
    self:AddTimer()
    self:RefreshTime()
    self:SetAllCellDestroyHero()
    self.showSolider = false
    if data.baseInfo.type == NewMarchType.MONSTER_SIEGE then
        --黑骑士攻城 ownerName 实际上是野怪id
        local name = DataCenter.MonsterTemplateManager:GetTableValue(tonumber(data.baseInfo.ownerName), "name")
        if name then
            self.name:SetLocalText(name)
        else
            self.name:SetText(data.baseInfo.ownerName)
        end
    else
        self.name:SetText(data.baseInfo.ownerName)
        if data.baseInfo.allianceAbbr then
            self.name:SetText("[".. data.baseInfo.allianceAbbr .."]"..data.baseInfo.ownerName)
        end
    end
    
    self.playerHead:SetData(data.baseInfo.ownerUid,data.baseInfo.pic,data.baseInfo.picVer)

    local headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(data.baseInfo.headSkinId, data.baseInfo.headSkinET, data.baseInfo.headFrame == 1)
    if headBgImg ~= nil then
        self.playerHeadBg:SetActive(true)
        self.playerHeadBg:LoadSprite(headBgImg)
    else
        self.playerHeadBg:SetActive(false)
    end
    
    self.open_img:SetActive(true)
    self.close_img:SetActive(false)
    self.content:SetActive(false)
    self._content_rect:RemoveComponents(UIAllianceHeroCell)
    self.heroList = {}
    --英雄
    local list = data.armyInfo
    if next(list) then
        table.sort(list.heros, function(a,b)
            if a.heroQuality > b.heroQuality then
                return true
            elseif a.heroQuality == b.heroQuality then
                if a.heroLevel > b.heroLevel then
                    return true
                end
                return false
            end
        end)
        for i = 1, table.length(list.heros) do
            --复制基础prefab，每次循环创建一次
            self.modelHero[i] = self:GameObjectInstantiateAsync(UIAssets.AllianceHeroCell, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go:SetActive(true)
                go.transform:SetParent(self._content_rect.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                NameCount = NameCount + 1
                local nameStr = tostring(NameCount)
                go.name = nameStr
                local cell = self._content_rect:AddComponent(UIAllianceHeroCell, go.name)
                cell:ReInit(list.heros[i])
            end)
        end
        local count = 0
        for i = 1, table.length(list.soldiers) do
            count = list.soldiers[i].total + count
        end
        self.power:SetText(string.GetFormattedSeperatorNum(count))
    end
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    if self.data.baseInfo.status == MarchStatus.MOVING then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        --大于现在时间还在行军中
        if self.data.baseInfo.endTime > curTime then
            local deltaTime = self.data.baseInfo.endTime - curTime
            local maxTime = self.data.baseInfo.endTime - self.data.baseInfo.startTime
            local tempValue = 1 - deltaTime / maxTime
            self.slider:SetValue(tempValue)
            self.state:SetActive(false)
            self.time_txt:SetActive(true)
            self.time_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
        else
            self.time_txt:SetActive(false)
            self:DeleteTimer()
            self.slider:SetActive(false)
            self.state:SetActive(true)
            self.state:SetLocalText(141029)
        end
    else
        self.time_txt:SetActive(false)
        self:DeleteTimer()
        self.slider:SetActive(false)
        self.state:SetActive(true)
        self.state:SetLocalText(141029)
    end
end

local function SetAllCellDestroy(self)
    self.content:RemoveComponents(AllianceWarPlayerSoliderItem)
    if next(self.model) then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end

local function SetAllCellDestroyHero(self)
    self._content_rect:RemoveComponents(UIAllianceHeroCell)
    if next(self.modelHero) then
        for k,v in pairs(self.modelHero) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.modelHero ={}
end

local function SetHeroAct(self)
end

local function OnShowClick(self)
    self:SetAllCellDestroy()
    if self.showSolider then
        self.open_img:SetActive(true)
        self.close_img:SetActive(false)
        self.content:SetActive(false)
        self.showSolider =false
    else
        self.open_img:SetActive(false)
        self.close_img:SetActive(true)
        self.content:SetActive(true)
        self.showSolider =true
        --士兵
        local list = self.data.armyInfo
        if next(list) then
            table.sort(list.soldiers, function(a,b)
                local aData = DataCenter.ArmyTemplateManager:GetArmyTemplate(tonumber(a.armsId))
                local bData = DataCenter.ArmyTemplateManager:GetArmyTemplate(tonumber(b.armsId))
                if aData.level > bData.level then
                    return true
                elseif aData.level == bData.level then
                    if aData.arm > bData.arm then
                        return true
                    end
                    return false
                end
            end)
            for i = 1, table.length(list.soldiers) do
                --复制基础prefab，每次循环创建一次
                self.model[i] = self:GameObjectInstantiateAsync(UIAssets.AllianceWarPlayerSoliderItem, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go:SetActive(true)
                    go.transform:SetParent(self.content.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    go.name = "item"..i
                    local cell = self.content:AddComponent(AllianceWarPlayerSoliderItem,go.name)
                    cell:SetData(list.soldiers[i].armsId,list.soldiers[i].total)
                end)
            end
        end
    end
end

local function OnClickPos(self)
    local pos = SceneUtils.GetMarchCurPos(self.data.baseInfo)
    self.view.ctrl:OnClickPosBtn(pos,true,self.data.uuid,self.data.baseInfo.server,self.data.baseInfo.worldId)
    --local info = CS.SceneManager.World:GetMarch(self.data.uuid)
    --if info then
    --    local v3 = {}
    --    v3.x = info.position.x
    --    v3.y = info.position.y
    --    v3.z = info.position.z
    --    self.view.ctrl:OnClickPosBtn(v3,true,self.data.uuid)
    --end
end

AllianceAlertPlayerItem.OnCreate = OnCreate
AllianceAlertPlayerItem.OnDestroy = OnDestroy
AllianceAlertPlayerItem.OnEnable = OnEnable
AllianceAlertPlayerItem.OnDisable = OnDisable
AllianceAlertPlayerItem.RefreshData = RefreshData
AllianceAlertPlayerItem.SetHeroAct = SetHeroAct
AllianceAlertPlayerItem.OnShowClick =OnShowClick
AllianceAlertPlayerItem.SetAllCellDestroy =SetAllCellDestroy
AllianceAlertPlayerItem.SetAllCellDestroyHero =SetAllCellDestroyHero
AllianceAlertPlayerItem.DeleteTimer = DeleteTimer
AllianceAlertPlayerItem.AddTimer = AddTimer
AllianceAlertPlayerItem.RefreshTime = RefreshTime
AllianceAlertPlayerItem.OnClickPos = OnClickPos 
return AllianceAlertPlayerItem