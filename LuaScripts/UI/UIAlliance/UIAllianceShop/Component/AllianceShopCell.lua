---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guqu.
--- DateTime: 2020/9/24 15:03
---
local AllianceShopCell = BaseClass("AllianceShopCell", UIBaseContainer)
local base = UIBaseContainer
local UICommonItem = require "UI.UICommonItem.UICommonItem"

local item_quality_path = "item/rect/commonItem/clickBtn/ImgQuality"
local item_icon_path = "item/rect/commonItem/clickBtn/ItemIcon"
local num_text_path = "item/rect/commonItem/clickBtn/NumText"
local flag_text_path = "item/rect/commonItem/clickBtn/FlagGo/FlagText"
local itemBtn_path = "item/rect/commonItem/clickBtn"
local btn_path = "item/rect/buyBtn"
local priceIcon_path = "item/rect/buyBtn/price/icon"
local priceTxt_path = "item/rect/buyBtn/price"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self.item_quality = self:AddComponent(UIImage, item_quality_path)
    self.item_icon = self:AddComponent(UIImage, item_icon_path)
    self.num_text = self:AddComponent(UITextMeshProUGUIEx, num_text_path)
    self.flag_text = self:AddComponent(UITextMeshProUGUIEx, flag_text_path)
    self.itemBtn = self:AddComponent(UIButton, itemBtn_path)
    self.itemBtn:SetOnClick(function()
        self:OnItemBtnClick()
    end)
    self.btn = self:AddComponent(UIButton, btn_path)
    self.btn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBtnClick()
    end)
    self.priceIcon = self:AddComponent(UIImage, priceIcon_path)
    self.priceTxt = self:AddComponent(UITextMeshProUGUIEx, priceTxt_path)
end

local function OnBtnClick(self)
    self.view.ctrl:SelectOneItem(self.itemId)
end

local function OnItemBtnClick(self)
    local itemData = self.view.ctrl:GetItemData(self.itemId)
    local param = {}
    param["itemName"] = itemData.itemName
    param["itemDesc"] = itemData.des
    param["alignObject"] = self.item_icon
    param.isLocal = true
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemTips,{anim = true}, param)
end

local function SetItemShow(self, itemId)
    self.itemId = itemId
    
    local itemData = self.view.ctrl:GetItemData(self.itemId)
    local currentItemId = self.view.ctrl:GetCurrentItemId()
    self.num_text:SetText(itemData.count)
    if itemData.count == "" then
        self.num_text:SetActive(false)
    else
        self.num_text:SetActive(true)
    end
    self.item_quality:LoadSprite(itemData.itemColor)
    self.item_icon:LoadSprite(itemData.iconName)
    self.flag_text:SetText(itemData.itemFlag)
    self.priceTxt:SetText(string.GetFormattedSeperatorNum(itemData.price))

    if self.view.ctrl:GetTab() == 2 then
        local itemTemplate = DataCenter.ItemTemplateManager:GetItemTemplate(self.itemId)
        local shopItemData = DataCenter.AllianceShopDataManager:GetAllianceShopOneData(self.itemId)
        local allianceNum = -1
        if itemTemplate.allianceNum then
            allianceNum = itemTemplate.allianceNum
        end
        if allianceNum > 0 and shopItemData ~= nil then
            allianceNum = allianceNum - tonumber(shopItemData.buyCount)
            if allianceNum < 0 then
                allianceNum = 0
            end
        end
        --  allianceNum < 0 代表无限量
        if allianceNum ~= 0 then
            CS.UIGray.SetGray(self.transform, false, true)
        else
            CS.UIGray.SetGray(self.transform, true, true)
        end
    else
        CS.UIGray.SetGray(self.transform, false, true)
    end

    if self.view.ctrl:GetTab() == 1 then
        self.priceIcon:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/UIAlliance_icon_acc")
    else
        self.priceIcon:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/UIAlliance_icon_alliance_point")
    end
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.CLICK_ALLIANCE_SHOP_ITEM, self.RefreshItemState)

end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.CLICK_ALLIANCE_SHOP_ITEM, self.RefreshItemState)
end

local function RefreshItemState(self,data)
    if self.itemId == data then
        
    end
end

local function GetPos(self)
    if self.flag_text then
        return self.flag_text.transform.position
    end
end

AllianceShopCell.OnCreate = OnCreate
AllianceShopCell.OnAddListener = OnAddListener
AllianceShopCell.OnBtnClick = OnBtnClick
AllianceShopCell.SetItemShow = SetItemShow
AllianceShopCell.OnRemoveListener= OnRemoveListener
AllianceShopCell.RefreshItemState = RefreshItemState
AllianceShopCell.GetPos = GetPos
AllianceShopCell.OnItemBtnClick = OnItemBtnClick
return AllianceShopCell