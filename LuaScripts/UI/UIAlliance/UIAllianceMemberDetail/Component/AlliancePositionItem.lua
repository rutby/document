---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/5/16 6:59
---

local AlliancePositionItem = BaseClass("AlliancePositionItem", UIBaseContainer)
local base = UIBaseContainer
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local Localization = CS.GameEntry.Localization

local add_path = "GameObject/head/Add"
local playerHead_path = "GameObject/head/PlayerHead/UIPlayerHead/HeadIcon"
local playerHeadContainer_path = "GameObject/head/PlayerHead"
local playerHeadFg_path = "GameObject/head/PlayerHead/UIPlayerHead/Foreground"
local headBtn_path = "GameObject/head"
local playerName_path = "GameObject/playerName"
local playerPos_path = "GameObject/posName"
local posBtn_path = "GameObject/posName"
local posImg_path = "GameObject/Image"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.addN = self:AddComponent(UIBaseContainer, add_path)
    self.playerHeadContainerN = self:AddComponent(UIBaseContainer, playerHeadContainer_path)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.headBtnN = self:AddComponent(UIButton, headBtn_path)
    self.headBtnN:SetOnClick(function()
        self:OnClickHeadBtn()
    end)
    self.playerNameN = self:AddComponent(UITextMeshProUGUIEx, playerName_path)
    self.playerPosN = self:AddComponent(UITextMeshProUGUIEx, playerPos_path)
    self.posBtnN = self:AddComponent(UIButton, posBtn_path)
    self.posBtnN:SetOnClick(function()
        self:OnClickPosBtn()
    end)
    self.posImgN = self:AddComponent(UIImage, posImg_path)
    self.posImgN:SetActive(false)--需求
end

--控件的销毁
local function ComponentDestroy(self)
    self.addN = nil
    self.playerHeadN = nil
    self.playerHeadFgN = nil
    self.headBtnN = nil
    self.playerNameN = nil
    self.playerPosN = nil
    self.posBtnN = nil
end

--变量的定义
local function DataDefine(self)
    self.officialPos = nil
    self.memberInfo = nil
end

--变量的销毁
local function DataDestroy(self)
    self.officialPos = nil
    self.memberInfo = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnAllianceOfficialPosChange, self.RefreshAll)

end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnAllianceOfficialPosChange, self.RefreshAll)
    base.OnRemoveListener(self)
end


local function SetItem(self, pos)
    self.officialPos = pos
    
    self:RefreshAll()
end

local function RefreshAll(self)
    self.memberInfo = self.view:GetMemberInfoByPos(self.officialPos)-- DataCenter.AllianceMemberDataManager:GetMemberInfoByOfficialPos(self.officialPos)
    if self.memberInfo then
        self.addN:SetActive(false)
        self.playerHeadContainerN:SetActive(true)
        self.playerHeadN:SetData(self.memberInfo.uid, self.memberInfo.pic, self.memberInfo.picVer)
        local headFg = self.memberInfo:GetHeadBgImg()
        if headFg then
            self.playerHeadFgN:SetActive(true)
            self.playerHeadFgN:LoadSprite(headFg)
        else
            self.playerHeadFgN:SetActive(false)
        end
        self.playerNameN:SetText(self.memberInfo.name)
    else
        self.addN:SetActive(true)
        self.playerHeadContainerN:SetActive(false)
        self.playerNameN:SetLocalText(391071)
    end
    self.playerPosN:SetLocalText(AllianceOfficialPosConf[self.officialPos].name)
    self.posImgN:LoadSprite(string.format("Assets/Main/Sprites/UI/UIAlliance/%s", AllianceOfficialPosConf[self.officialPos].icon))
end


local function OnClickHeadBtn(self)
    if self.memberInfo then
        if self.memberInfo.uid ~= LuaEntry.Player.uid then
            local x = self.playerHeadContainerN.transform.position.x
            local y = self.playerHeadContainerN.transform.position.y
            if self.view.OnShowAllianceMemberTips then
                self.view:OnShowAllianceMemberTips(self.memberInfo.uid,self.memberInfo.rank,x,y,self.memberInfo.name)
            end
        end
    else
        if self.view.ctrl:CheckIsSelfAll() then
            if DataCenter.AllianceBaseDataManager:IsSelfLeader() then
                local uid = self.memberInfo and self.memberInfo.uid or nil
                UIManager:GetInstance():OpenWindow(UIWindowNames.UISetAlOfficialPos,{anim = true}, self.officialPos, uid)
            else
                UIUtil.ShowTipsId(391103)
            end
        end
    end
end

local function OnClickPosBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.posBtnN.transform.position + Vector3.New(30, 10, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString(AllianceOfficialPosConf[self.officialPos].tip)
    param.dir = UIHeroTipView.Direction.ABOVE
    param.defWidth = 240
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

AlliancePositionItem.OnCreate = OnCreate
AlliancePositionItem.OnDestroy = OnDestroy
AlliancePositionItem.ComponentDefine = ComponentDefine
AlliancePositionItem.ComponentDestroy = ComponentDestroy
AlliancePositionItem.DataDefine = DataDefine
AlliancePositionItem.DataDestroy = DataDestroy
AlliancePositionItem.OnAddListener = OnAddListener
AlliancePositionItem.OnRemoveListener = OnRemoveListener

AlliancePositionItem.SetItem = SetItem
AlliancePositionItem.RefreshAll = RefreshAll
AlliancePositionItem.OnClickHeadBtn = OnClickHeadBtn
AlliancePositionItem.OnClickPosBtn = OnClickPosBtn

return AlliancePositionItem