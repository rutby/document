---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 
--- DateTime:
---
local AllyView = BaseClass("AllyView",UIBaseContainer)
local base = UIBaseContainer
local AllianceAllyItem = require "UI.UIAlliance.UIAllianceWarMainTable.Component.AllianceAllyItem"
local Localization = CS.GameEntry.Localization

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function ComponentDefine(self)
    self.content = self:AddComponent(UIBaseContainer,"Viewport/Content")
end

local function DataDefine(self)
    self.march = {}
    self.cell = {}
    self.isWait = false
end

local function Clear(self)
    self.cell = {}
    self.content:RemoveComponents(AllianceAllyItem)
    if self.march~=nil then
        for k,v in pairs(self.march) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.march = {}
end

local function OnDestroy(self)
    self:Clear()
    self.cell = nil
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ReInit(self)
    SFSNetwork.SendMessage(MsgDefines.GetAllianceAlertInfo,LuaEntry.Player:GetSelfServerId())
end

local function CreateList(self,index,isRefreshAlert)
    self.list = self.view.ctrl:GetAllianceWarIdList(index, self.arrowUuid)
    self.AllianceAlertIdList =  DataCenter.AllianceAlertDataManager:GetAllianceAlertByIdList()
    local tempCount = table.count(self.list) + table.count(self.AllianceAlertIdList)
    for i = 1 ,#self.cell do
        self.cell[i]:SetActive(false)
    end
    --存在刷新
    for i = 1, tempCount do
        if self.march[i] then
            local sub = self.list[i]
            local isAlert = false
            if not sub then
                sub = self.AllianceAlertIdList[i - table.count(self.list)]
                isAlert = true
            end
            if self.cell[i] then
                self.cell[i]:SetUuid(sub)
                self.cell[i]:RefreshData(isAlert)
                self.cell[i]:SetActive(true)
                if isAlert then
                    local alertInfo = DataCenter.AllianceAlertDataManager:GetAllianceAlertDataByKey(sub)
                    if alertInfo.marchInfo and next(alertInfo.marchInfo) then
                        self.cell[i]:CreateList()
                    else
                        self.view.ctrl:OpenAlertInfo(alertInfo)
                    end
                end
            end
        else
            --复制基础prefab，每次循环创建一次
            self.march[i] = self:GameObjectInstantiateAsync(UIAssets.AllianceAllyItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cellItem = self.content:AddComponent(AllianceAllyItem,nameStr)
                local sub = self.list[i]
                local isAlert = false
                if not sub then
                    sub = self.AllianceAlertIdList[i - table.count(self.list)]
                    isAlert = true
                    local alertInfo = DataCenter.AllianceAlertDataManager:GetAllianceAlertDataByKey(sub)
                    self.view.ctrl:OpenAlertInfo(alertInfo)
                end
                cellItem:SetUuid(sub)
                cellItem:RefreshData(isAlert)
                self.cell[i] = cellItem
            end)
        end
    end
end

local function RefreshAlertItem(self,index)
    self.list = self.view.ctrl:GetAllianceWarIdList(index, self.arrowUuid)
    self.AllianceAlertIdList =  DataCenter.AllianceAlertDataManager:GetAllianceAlertByIdList()
    local tempCount = table.count(self.list) + table.count(self.AllianceAlertIdList)
    for i = 1, tempCount do
        if self.cell[i] then
            local sub = self.list[i]
            if not sub then
                sub = self.AllianceAlertIdList[i - table.count(self.list)]
                if sub then
                    self.cell[i]:SetUuid(sub)
                end
                self.cell[i]:CreateList()
            end
        end
    end
end

AllyView.OnCreate = OnCreate
AllyView.ComponentDefine = ComponentDefine
AllyView.DataDefine = DataDefine
AllyView.OnDestroy = OnDestroy
AllyView.OnEnable = OnEnable
AllyView.OnDisable = OnDisable
AllyView.ReInit = ReInit
AllyView.RefreshAlertItem = RefreshAlertItem
AllyView.Clear = Clear
AllyView.CreateList = CreateList
return AllyView