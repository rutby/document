---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/7 20:32
--- CommonShopAlContributePanel.lua


local base = UIBaseContainer--Variable
local CommonShopAlContributePanel = BaseClass("CommonShopAlContributePanel", base)--Variable
local Localization = CS.GameEntry.Localization
local CommonGoodsShopItem = require "UI.UICommonShop.Component.CommonShopGoods.CommonGoodsShopItem"

local content_path = "Anim/ScrollView/Content"
local anim_path = "Anim"
local refreshTip_path = "Anim/Top/refreshTip"
local refreshCd_path = "Anim/Top/refreshTip/refreshCd"
local scoreNum_path = "Anim/Top/MyToken/MyTokenCount"
local getScoreBtn_path = "Anim/Top/MyToken/MyTokenAdd/MyTokenAddBtn"
local exploitRank_path = "Anim/Top/exploitRank"
local exploitInfoBtn_path = "Anim/Top/infoBtn"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DelRefreshCdTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.animN = self:AddComponent(UIAnimator, anim_path)
    self.refreshTipN = self:AddComponent(UITextMeshProUGUIEx, refreshTip_path)
    self.refreshTipN:SetText("")
    self.refreshCdN = self:AddComponent(UITextMeshProUGUIEx, refreshCd_path)
    self.scoreNumN = self:AddComponent(UITextMeshProUGUIEx, scoreNum_path)
    self.getScoreBtnN = self:AddComponent(UIButton, getScoreBtn_path)
    self.getScoreBtnN:SetOnClick(function()
        self:OnClickGetScoreBtn()
    end)
    self.exploitRankN = self:AddComponent(UITextMeshProUGUIEx, exploitRank_path)
    self.exploitInfoBtn = self:AddComponent(UIButton, exploitInfoBtn_path)
    self.exploitInfoBtn:SetOnClick(function()
        self:OnClickExploitInfoBtn()
    end)
end

local function ComponentDestroy(self)
    self:ClearItemCell()
end

local function DataDefine(self)
    self.curShowType = nil
    self.goodsList = {}
    self.model = {}
    self.listGO = {}
    self.next_timer_callback = function()
        self:NextFrameTimeCallback()
    end
end

local function DataDestroy(self)
    self:DeleteNextFrameTimer()
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:AddUIListener(EventId.UpdateGold, self.RefreshAll)
    self:AddUIListener(EventId.RefreshItems, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:RemoveUIListener(EventId.UpdateGold, self.RefreshAll)
    self:RemoveUIListener(EventId.RefreshItems, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function ShowPanel(self, shopType)
    self.curShowType = shopType

    self:RefreshAll()
end

local function RefreshAll(self, shopType)
    if shopType and shopType ~= self.curShowType then
        return
    end

    --local limitCount = LuaEntry.DataConfig:TryGetNum("aps_exploit_para", "k1")
    local tempCount = DataCenter.ItemData:GetItemCount(AlContributeItemId)
    self.scoreNumN:SetText(tempCount)-- .. "/" .. limitCount)

    local nextWeek = UITimeManager:GetInstance():GetNextWeekDay(5)
    self.refreshCdEndT = nextWeek
    self:AddRefreshCdTimer()
    self:ShowCells()
    
    local exploitRank = DataCenter.CommonShopManager:GetSelfExploitRank()
    local exploitName = DataCenter.AlContributeManager:GetExploitNameByRank(exploitRank)
    self.exploitRankN:SetLocalText(372859, exploitName)
end

local function OnInitScroll(self,go,index)
    local item = self:AddComponent(CommonGoodsShopItem, go)
    self.listGO[go] = item
end

local function OnUpdateScroll(self,go,index)
    local conf = self.goodsList[index + 1]
    go.name = conf.id
    local cellItem = self.listGO[go]
    if not cellItem then
        return
    end
    cellItem:SetItem(self.goodsList[index + 1])
end

local function OnDestroyScrollItem(self,go, index)

end

local function ClearItemCell(self)
    if self.contentN ~= nil then
        self:RemoveComponents(CommonGoodsShopItem)
        self.contentN:DestroyChildNode()
    end
end


local function SetAllCellDestroy(self)
    self.contentN:RemoveComponents(CommonGoodsShopItem)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end

local function AddRefreshCdTimer(self)
    self.RefreshCdTimerAction = function()
        self:SetRefreshCd()
    end

    if self.refreshCdTimer == nil then
        self.refreshCdTimer = TimerManager:GetInstance():GetTimer(1, self.RefreshCdTimerAction , self, false,false,false)
    end
    self.refreshCdTimer:Start()
    
    self:SetRefreshCd()
end

local function SetRefreshCd(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = math.ceil(self.refreshCdEndT - curTime)
    if remainTime > 0 then
        self.refreshCdN:SetText(Localization:GetString("104209", UITimeManager:GetInstance():MilliSecondToFmtString(remainTime)))
    else
        self.refreshCdN:SetText("")
        self:DelRefreshCdTimer()
        SFSNetwork.SendMessage(MsgDefines.GetCommonShopInfo, self.curShowType)
    end
end

local function DelRefreshCdTimer(self)
    if self.refreshCdTimer ~= nil then
        self.refreshCdTimer:Stop()
        self.refreshCdTimer = nil
    end
end

local function OnClickGetScoreBtn(self)
    local activityInfo = DataCenter.AlContributeManager:GetActivityInfo()
    if activityInfo then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlContribute, activityInfo.id)
    end
end

local function OnClickExploitInfoBtn(self)
    local activityInfo = DataCenter.AlContributeManager:GetActivityInfo()
    if activityInfo then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlContributeRankInfo, activityInfo.id)
    end
end

function CommonShopAlContributePanel:ShowCells()
    if self.contentN == nil then
        self:AddNextFrameTimer()
    else
        self:RefreshCells()
    end
end

function CommonShopAlContributePanel:RefreshCells()
    self.goodsList = DataCenter.CommonShopManager:GetGoodsListByShopType(self.curShowType)
    self.contentN:SetItemCount(#self.goodsList)
end

function CommonShopAlContributePanel:AddNextFrameTimer()
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(NextFrameTime, self.next_timer_callback,self, true, false, false)
    end
    self.timer:Start()
end

function CommonShopAlContributePanel:DeleteNextFrameTimer()
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

function CommonShopAlContributePanel:NextFrameTimeCallback()
    self:DeleteNextFrameTimer()
    self.contentN = self:AddComponent(GridInfinityScrollView, content_path)
    local bindFunc1 = BindCallback(self, self.OnInitScroll)
    local bindFunc2 = BindCallback(self, self.OnUpdateScroll)
    local bindFunc3 = BindCallback(self, self.OnDestroyScrollItem)
    self.contentN:Init(bindFunc1, bindFunc2, bindFunc3)
    self:RefreshCells()
end

CommonShopAlContributePanel.OnCreate = OnCreate
CommonShopAlContributePanel.OnDestroy = OnDestroy
CommonShopAlContributePanel.OnAddListener = OnAddListener
CommonShopAlContributePanel.OnRemoveListener = OnRemoveListener
CommonShopAlContributePanel.ComponentDefine = ComponentDefine
CommonShopAlContributePanel.ComponentDestroy = ComponentDestroy
CommonShopAlContributePanel.DataDefine = DataDefine
CommonShopAlContributePanel.DataDestroy = DataDestroy

CommonShopAlContributePanel.ShowPanel = ShowPanel
CommonShopAlContributePanel.RefreshAll = RefreshAll
CommonShopAlContributePanel.OnInitScroll = OnInitScroll
CommonShopAlContributePanel.OnUpdateScroll = OnUpdateScroll
CommonShopAlContributePanel.OnDestroyScrollItem = OnDestroyScrollItem
CommonShopAlContributePanel.ClearItemCell = ClearItemCell
CommonShopAlContributePanel.OnItemMoveIn = OnItemMoveIn
CommonShopAlContributePanel.OnItemMoveOut = OnItemMoveOut
CommonShopAlContributePanel.AddRefreshCdTimer = AddRefreshCdTimer
CommonShopAlContributePanel.SetRefreshCd = SetRefreshCd
CommonShopAlContributePanel.DelRefreshCdTimer = DelRefreshCdTimer
CommonShopAlContributePanel.RefreshList = RefreshList
CommonShopAlContributePanel.SetAllCellDestroy = SetAllCellDestroy
CommonShopAlContributePanel.OnClickGetScoreBtn = OnClickGetScoreBtn
CommonShopAlContributePanel.OnClickExploitInfoBtn = OnClickExploitInfoBtn


return CommonShopAlContributePanel