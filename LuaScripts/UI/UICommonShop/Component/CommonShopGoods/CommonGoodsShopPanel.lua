---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/1/19 17:20
---
local base = UIBaseContainer--Variable
local CommonGoodsShopPanel = BaseClass("CommonGoodsShopPanel", base)--Variable
local Localization = CS.GameEntry.Localization
local CommonGoodsShopItem = require "UI.UICommonShop.Component.CommonShopGoods.CommonGoodsShopItem"

local content_path = "Anim/ScrollView/Content"
local anim_path = "Anim"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.animN = self:AddComponent(UIAnimator, anim_path)
end

local function ComponentDestroy(self)
    self:ClearItemCell()
end

local function DataDefine(self)
    self.curShowType = nil
    self.goodsList = {}
    self.goodsItemsList = {}
    self.model = {}
    self.listGO = {}
    self.next_timer_callback = function()
        self:NextFrameTimeCallback()
    end
end

local function DataDestroy(self)
    self:DeleteNextFrameTimer()
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:AddUIListener(EventId.RefreshItems, self.RefreshAll)
    self:AddUIListener(EventId.UpdateGold, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:RemoveUIListener(EventId.RefreshItems, self.RefreshAll)
    self:RemoveUIListener(EventId.UpdateGold, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function ShowPanel(self, shopType)
    self.curShowType = shopType
    
    self:RefreshAll()
end

local function RefreshAll(self, shopType)
    if shopType and shopType ~= self.curShowType then
        return
    end

    self:ShowCells()
end


local function OnInitScroll(self,go,index)
    local item = self:AddComponent(CommonGoodsShopItem, go)
    self.listGO[go] = item
end

local function OnUpdateScroll(self,go,index)
    local conf = self.goodsList[index + 1]
    go.name = conf.id
    local cellItem = self.listGO[go]
    if not cellItem then
        return
    end
    cellItem:SetItem(self.goodsList[index + 1])
end

local function OnDestroyScrollItem(self,go, index)
    
end

local function ClearItemCell(self)
    if self.contentN ~= nil then
        self:RemoveComponents(CommonGoodsShopItem)
        self.contentN:DestroyChildNode()
    end
end

function CommonGoodsShopPanel:ShowCells()
    if self.contentN == nil then
        self:AddNextFrameTimer()
    else
        self:RefreshCells()
    end
end

function CommonGoodsShopPanel:RefreshCells()
    self.goodsList = DataCenter.CommonShopManager:GetGoodsListByShopType(self.curShowType)
    self.contentN:SetItemCount(#self.goodsList)
end

function CommonGoodsShopPanel:AddNextFrameTimer()
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(NextFrameTime, self.next_timer_callback,self, true, false, false)
    end
    self.timer:Start()
end

function CommonGoodsShopPanel:DeleteNextFrameTimer()
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

function CommonGoodsShopPanel:NextFrameTimeCallback()
    self:DeleteNextFrameTimer()
    self.contentN = self:AddComponent(GridInfinityScrollView, content_path)
    local bindFunc1 = BindCallback(self, self.OnInitScroll)
    local bindFunc2 = BindCallback(self, self.OnUpdateScroll)
    local bindFunc3 = BindCallback(self, self.OnDestroyScrollItem)
    self.contentN:Init(bindFunc1, bindFunc2, bindFunc3)
    self:RefreshCells()
end

CommonGoodsShopPanel.OnCreate = OnCreate
CommonGoodsShopPanel.OnDestroy = OnDestroy
CommonGoodsShopPanel.OnAddListener = OnAddListener
CommonGoodsShopPanel.OnRemoveListener = OnRemoveListener
CommonGoodsShopPanel.ComponentDefine = ComponentDefine
CommonGoodsShopPanel.ComponentDestroy = ComponentDestroy
CommonGoodsShopPanel.DataDefine = DataDefine
CommonGoodsShopPanel.DataDestroy = DataDestroy

CommonGoodsShopPanel.ShowPanel = ShowPanel
CommonGoodsShopPanel.RefreshAll = RefreshAll
CommonGoodsShopPanel.OnInitScroll = OnInitScroll
CommonGoodsShopPanel.OnUpdateScroll = OnUpdateScroll
CommonGoodsShopPanel.OnDestroyScrollItem = OnDestroyScrollItem
CommonGoodsShopPanel.ClearItemCell = ClearItemCell


return CommonGoodsShopPanel