---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/10 11:34
---

local UICampBonus = BaseClass("UICampBonus", UIBaseView)
local base = UIBaseView
local UICampBonusItem = require "UI.UICampBonus.Component.UICampBonusItem"

local close_path = "Close"
local arrow_path = "Panel/Arrow"
local panel_path = "Panel"
local title_path = "Panel/TitleBg/Title"
local desc_path = "Panel/Desc"
local item_list_path = "Panel/ItemList"

local PADDING = 248

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.arrow_go = self:AddComponent(UIBaseContainer, arrow_path)
    self.panel_anim = self:AddComponent(UIAnimator, panel_path)
    self.title_text = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.title_text:SetLocalText(310151)
    self.desc_text = self:AddComponent(UITextMeshProUGUIEx, desc_path)
    self.desc_text:SetLocalText(133046)
    self.item_list_go = self:AddComponent(UIBaseContainer, item_list_path)
end

local function ComponentDestroy(self)
    self.close_btn = nil
    self.arrow_go = nil
    self.panel_anim = nil
    self.desc_text = nil
    self.item_list_go = nil
end

local function DataDefine(self)
    self.param = nil
    self.dataList = {}
    self.itemReqs = {}
end

local function DataDestroy(self)
    self.param = nil
    self.dataList = nil
    self.itemReqs = nil
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ReInit(self)
    self.param = self:GetUserData()
    if IsNull(self.param.alignObject) then
        self.ctrl:CloseSelf()
        return
    end
    
    self.dataList = self:GetDataListInternal()
    self:ShowItems()
    
    local pos = self.param.alignObject.transform.position + (self.param.offset or VecZero)
    --self.arrow_go.transform.position = pos + Vector3.New(0, 2.5, 0)
    --pos.x = Mathf.Clamp(pos.x, PADDING, Screen.width - PADDING)
    self.panel_anim.transform.position = pos
    self.panel_anim:Play("CommonPopup_movein", 0, 0)
end

local function ShowItems(self)
    self:ClearItems()
    for i, data in pairs(self.dataList) do
        self.itemReqs[i] = self:GameObjectInstantiateAsync(UIAssets.UICampBonusItem, function(req)
            if req.isError then
                return
            end
            local go = req.gameObject
            go:SetActive(true)
            go.transform:SetParent(self.item_list_go.transform)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go.name = "Item_" .. i
            local item = self.item_list_go:AddComponent(UICampBonusItem, go.name)
            item:SetData(data)
        end)
    end
end

local function ClearItems(self)
    self.item_list_go:RemoveComponents(UICampBonusItem)
    for _, req in pairs(self.itemReqs) do
        req:Destroy()
    end
    self.itemReqs = {}
end

local function GetDataListInternal(self)
    local dataList = {}
    
    local templates = DataCenter.CampEffectManager:GetAllTemplates()
    for i, template in pairs(templates) do
        local data = {}
        data.template = template
        data.camps = {}
        data.effectExtra = self.param.extraVal
        data.isOn = false
        dataList[i] = data
    end
    
    local info = DataCenter.CampEffectManager:GetCampEffectInfoByHeroData(self.param.heroDataList)
    if info.type ~= CampEffectType.None then
        dataList[info.type].isOn = true
        for i=1,#dataList do
            dataList[i].camps = info.camps
        end 
    end
    
    return dataList
end

UICampBonus.OnCreate = OnCreate
UICampBonus.OnDestroy = OnDestroy
UICampBonus.ComponentDefine = ComponentDefine
UICampBonus.ComponentDestroy = ComponentDestroy
UICampBonus.DataDefine = DataDefine
UICampBonus.DataDestroy = DataDestroy
UICampBonus.OnEnable = OnEnable
UICampBonus.OnDisable = OnDisable

UICampBonus.ReInit = ReInit
UICampBonus.ShowItems = ShowItems
UICampBonus.ClearItems = ClearItems
UICampBonus.GetDataListInternal = GetDataListInternal

return UICampBonus