---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 24224.
--- DateTime: 2022/12/9 18:22
---
local RewardItem = require "UI.UIWorldPoint.Component.WorldPointRewardItem"
local AllianceRewardTop = BaseClass("AllianceRewardTop", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

-- 创建
function AllianceRewardTop:OnCreate()
    base.OnCreate(self)
    self.title = self:AddComponent(UIText,"Text_title")
    self.slider = self:AddComponent(UISlider,"Slider")
    self._num_txt = self:AddComponent(UIText,"rewardNum")
    self.Text_reward = self:AddComponent(UIText,"Text_num/Text_des")
    self.Text_reward:SetText(Localization:GetString("370101",""))
    self.Text_num = self:AddComponent(UIText,"Text_num")
    self.reward_layout = self:AddComponent(UIBaseContainer,"ScrollView/Viewport/Content")
    self.img = self:AddComponent(UIImage,"boxObj/ItemIcon")
    self.restNum = 0
    self.totalNum = 0
end

-- 销毁
function AllianceRewardTop:OnDestroy()
    self:ClearItemCell()
    base.OnDestroy(self)
end

-- 显示
function AllianceRewardTop:OnEnable()
    base.OnEnable(self)
end

-- 隐藏
function AllianceRewardTop:OnDisable()
    base.OnDisable(self)
end
function AllianceRewardTop:InitData(packageId)
    self.packageData = self.view.ctrl:GetPackageData(packageId)
    if self.packageData~=nil then
        local index = self.packageData.order
        if index == 2 then
            self.title:SetText(Localization:GetString("110301"))
        elseif index == 3 then
            self.title:SetText(Localization:GetString("110302"))
        else
            self.title:SetText(Localization:GetString("110303"))
        end
        if index ==1 or index ==2 then
            self.img:LoadSprite("Assets/Main/Sprites/UI/UIAllianceArmament/UIAllianceArmament_img_reward05.png")
        elseif index ==3 then
            self.img:LoadSprite("Assets/Main/Sprites/UI/UIAllianceArmament/UIAllianceArmament_img_reward03.png")
        else
            self.img:LoadSprite("Assets/Main/Sprites/UI/UIAllianceArmament/UIAllianceArmament_img_reward01.png")
        end
        self.restNum = self.packageData.numRest
        self.totalNum = self.packageData.numTotal
        self:RefreshSlider()
        local oneData = {}
        oneData.diamonds = self.packageData.diamonds
        oneData.rewardList = self.view.ctrl:GetRewards(self.packageData.rewardInfo)
        self:RefreshList(oneData)
    end
end
function AllianceRewardTop:RefreshList(data)
    self:ClearItemCell()
    local count = data.diamonds
    self.Text_num:SetText(string.GetFormattedSeperatorNum(math.floor(count)))
    local list = data.rewardList
    if #list >0 then
        local num =0
        for i = 1, table.length(list) do
            --复制基础prefab，每次循环创建一次
            num = num+1
            self.rewardModel[i] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.reward_layout.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cell = self.reward_layout:AddComponent(RewardItem,nameStr)
                cell:RefreshData(list[i])
            end)
        end
    end
end
function AllianceRewardTop:ClearItemCell()
    self.reward_layout:RemoveComponents(RewardItem)
    if self.rewardModel~=nil then
        for k,v in pairs(self.rewardModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.rewardModel ={}
end

function AllianceRewardTop:RefreshSlider()
    local percent = math.min(1,(self.restNum/math.max(self.totalNum,1)))
    self.slider:SetValue(percent)
    self._num_txt:SetText(Localization:GetString("110315",(self.restNum.."/"..self.totalNum)))
end

function AllianceRewardTop:AddMember()
    self.restNum = self.restNum-1
    if self.restNum<=0 then
        self.restNum = 0
    end
    self:RefreshSlider()
end
function AllianceRewardTop:DecMember()
    self.restNum = self.restNum+1
    if self.restNum>=self.totalNum then
        self.restNum = self.totalNum
    end
    self:RefreshSlider()
end
function AllianceRewardTop:CheckIsEmpty()
    if self.restNum<=0 then
        return true
    end
    return false
end
return AllianceRewardTop