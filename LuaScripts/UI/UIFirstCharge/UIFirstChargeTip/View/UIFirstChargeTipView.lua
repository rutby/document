---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime: 

local UIFirstChargeTipView = BaseClass("UIFirstChargeTipView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local UICommonItemChange = require "UI.UICommonItem.UICommonItemChange"
--创建
function UIFirstChargeTipView:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

-- 销毁
function UIFirstChargeTipView:OnDestroy()
    self:ClearScroll()
    base.OnDestroy(self)
end

function UIFirstChargeTipView:ComponentDefine()
    self._close_btn = self:AddComponent(UIButton,"UICommonMidPopUpTitle/bg_mid/CloseBtn")
    self._back_btn = self:AddComponent(UIButton,"UICommonMidPopUpTitle/panel")
    self._title_txt = self:AddComponent(UITextMeshProUGUIEx,"UICommonMidPopUpTitle/bg_mid/titleText")

    self._back_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)
    self._close_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)

    self.scroll_view = self:AddComponent(UIScrollView, "Rect_Bottom/ScrollView")
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    
    self._tips1_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_Tips1")
    self._tips2_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_Tips2")
    self._tips3_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_Tips3")
    self._tips4_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_Tips4")
    
    self._buy_btn = self:AddComponent(UIButton,"Rect_Bottom/Btn_Buy")
    self._buy_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickCurBuy()
    end)
    self._buy_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Btn_Buy/Txt_Buy")
    
    self._buyMax_btn = self:AddComponent(UIButton,"Rect_Bottom/Btn_BuyMax")
    self._buyMax_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickMaxBuy()
    end)
    self._price_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Btn_BuyMax/Txt_Price")

    self._firstGold_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_FirstGold")
    self._firstGold1_txt = self:AddComponent(UITextMeshProUGUIEx,"Rect_Bottom/Txt_FirstGold/Txt_FirstGold1")
end

function UIFirstChargeTipView:OnEnable()
    base.OnEnable(self)
    self:ReInit()
end

function UIFirstChargeTipView:OnDisable()
    base.OnDisable(self)
end     

function UIFirstChargeTipView:ReInit()
    self._tips2_txt:SetLocalText(321179)
    self._tips3_txt:SetLocalText(321180)
    self._tips4_txt:SetLocalText(321177)
    self._firstGold1_txt:SetLocalText(321176)
    local firstDayGift = LuaEntry.DataConfig:TryGetStr("first_pay_choosen", "k1")
    if firstDayGift then
        self.giftList = string.split(firstDayGift,";")
        -- 获取最高档位礼包信息
        self.maxGiftInfo =  GiftPackageData.get(self.giftList[#self.giftList])
        self._price_txt:SetText(self.maxGiftInfo:getPriceText())
        -- 获取当前选中的礼包信息
        local selectChoose = self:GetUserData()
        self.curGiftInfo =  GiftPackageData.get(self.giftList[selectChoose])
    
        self._tips1_txt:SetLocalText(321178,self.curGiftInfo:getNameText())
        self._buy_txt:SetLocalText(321181,self.curGiftInfo:getNameText())

        local diamondWorth = tonumber(self.maxGiftInfo:getDiamond())
        if diamondWorth and diamondWorth > 0 then
            self._firstGold_txt:SetText(string.GetFormattedSeperatorNum(diamondWorth))
        end
    end
    local giftInfo = DataCenter.ActFirstChargeData:GetChargeInfo()
    
    self.offsetPos = Vector3.New(35,15,0)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    self.offsetPos.x = self.offsetPos.x * scaleFactor
    self.offsetPos.y = self.offsetPos.y * scaleFactor
    self:ShowReward(giftInfo)
   
end

function UIFirstChargeTipView:ShowReward(giftInfo)
    self.list = DataCenter.RewardManager:ReturnRewardParamForMessage(giftInfo["showReward"])
    local heroData = nil
    for i = 1, #self.list do
        if self.list[i].rewardType == RewardType.HERO then
            heroData = self.list[i]
            table.remove(self.list,i)
            break
        end
    end
    if heroData then
        table.insert(self.list,1,heroData)
    end
    self.scroll_view:SetTotalCount(#self.list)
    self.scroll_view:RefillCells()
end

function UIFirstChargeTipView:OnItemMoveIn(itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scroll_view:AddComponent(UICommonItemChange, itemObj)
    cellItem:ReInit(self.list[index])
    if self.list[index].rewardType == RewardType.HERO then
        cellItem:SetHeroTypeTipPos(self.offsetPos)
    end
end

function UIFirstChargeTipView:OnItemMoveOut(itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, UICommonItemChange)
end

function UIFirstChargeTipView:ClearScroll()
    self.scroll_view:ClearCells()
    self.scroll_view:RemoveComponents(UICommonItemChange)
end

--买当前
function UIFirstChargeTipView:OnClickCurBuy()
    if self.curGiftInfo then
        self.ctrl:CloseSelf()
        DataCenter.PayManager:CallPayment(self.curGiftInfo, UIWindowNames.UIFirstChargeTip)
    end
end
--买最高
function UIFirstChargeTipView:OnClickMaxBuy()
    if self.maxGiftInfo then
        self.ctrl:CloseSelf()
        DataCenter.PayManager:CallPayment(self.maxGiftInfo, UIWindowNames.UIFirstChargeTip)
    end
end


return UIFirstChargeTipView