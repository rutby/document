---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/28 10:54
---

local UIGloryBattlePrepare = BaseClass("UIGloryBattlePrepare", UIBaseContainer)
local base = UIBaseContainer
local UIGloryBattleTop = require "UI.UIGlory.UIGloryBattle.Component.UIGloryBattleTop"
local Localization = CS.GameEntry.Localization

local battle_top_path = "UIGloryBattleTop"
local attack_btn_path = "BtnList/Attack"
local attack_text_path = "BtnList/Attack/AttackText"
local find_btn_path = "BtnList/Find"
local find_text_path = "BtnList/Find/FindText"
local bottom_desc_path = "BtnList/Attack/BottomDesc"
local intro_path = "Center/Intro_%s"
local intro_desc_path = "Center/Intro_%s/IntroDesc_%s"
local left_path = "Left"
local right_path = "Right"

local IntroCount = 6

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.battle_top = self:AddComponent(UIGloryBattleTop, battle_top_path)
    self.battle_top.view = self.view
    self.attack_btn = self:AddComponent(UIButton, attack_btn_path)
    self.attack_btn:SetOnClick(function()
        self:OnAttackClick()
    end)
    self.attack_text = self:AddComponent(UIText, attack_text_path)
    self.find_btn = self:AddComponent(UIButton, find_btn_path)
    self.find_btn:SetOnClick(function()
        self:OnFindClick()
    end)
    self.find_text = self:AddComponent(UIText, find_text_path)
    self.find_text:SetLocalText(302873)
    self.bottom_desc_text = self:AddComponent(UIText, bottom_desc_path)
    self.intro_goes = {}
    self.intro_desc_texts = {}
    for i = 1, IntroCount do
        self.intro_goes[i] = self:AddComponent(UIBaseContainer, string.format(intro_path, i))
        self.intro_desc_texts[i] = self:AddComponent(UIText, string.format(intro_desc_path, i, i))
    end
    self.intro_desc_texts[1]:SetLocalText(302993)
    self.intro_desc_texts[2]:SetLocalText(302994)
    self.intro_desc_texts[3]:SetLocalText(302995)
    self.intro_desc_texts[4]:SetLocalText(302996)
    self.intro_desc_texts[5]:SetLocalText(302997)
    self.intro_desc_texts[6]:SetLocalText(302998)
    self.left_btn = self:AddComponent(UIButton, left_path)
    self.left_btn:SetOnClick(function()
        self:OnLeftClick()
    end)
    self.right_btn = self:AddComponent(UIButton, right_path)
    self.right_btn:SetOnClick(function()
        self:OnRightClick()
    end)
end

local function ComponentDestroy(self)
    self.battle_top = nil
    self.attack_btn = nil
    self.attack_text = nil
    self.find_btn = nil
    self.find_text = nil
    self.bottom_desc_text = nil
    self.intro_goes = nil
    self.intro_desc_texts = nil
    self.left_btn = nil
    self.right_btn = nil
end

local function DataDefine(self)
    self.period = GloryPeriod.None
    self.battleState = GloryBattleState.None
    self.introIndex = 1
end

local function DataDestroy(self)
    self.period = nil
    self.battleState = nil
    self.introIndex = nil
end

local function OnEnable(self)
    base.OnEnable(self)
    self:Refresh()
    self.introIndex = 1
    self:RefreshIntro()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GloryGetAct, self.OnGloryGetAct)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.GloryGetAct, self.OnGloryGetAct)
    base.OnRemoveListener(self)
end

local function Refresh(self)
    self.isLock = false
    self.battleState = DataCenter.GloryManager:GetBattleState()
    self.period = DataCenter.GloryManager:GetPeriod()
    CS.UIGray.SetGray(self.attack_btn.transform, false, true)
    if self.period == GloryPeriod.Prepare then
        self.attack_text:SetLocalText(302769)
        self.find_btn:SetActive(false)
        self.bottom_desc_text:SetText(DataCenter.GloryManager:GetOpenFightWeekDayDesCurWeek())
    elseif self.period == GloryPeriod.Start then
        if self.battleState == GloryBattleState.None then
            self.attack_text:SetLocalText(302812)
            self.find_btn:SetActive(false)
            local curTime = UITimeManager:GetInstance():GetServerTime()
            local weekDay = UITimeManager:GetInstance():GetWeekdayIndex(curTime)
            local list = DataCenter.GloryManager:GetCloseFightDayCurWeek()
            if list~=nil and list[weekDay]~=nil then
                self.isLock = true
                CS.UIGray.SetGray(self.attack_btn.transform, true, true)
            end
            self.bottom_desc_text:SetText(DataCenter.GloryManager:GetOpenFightWeekDayDesCurWeek())
        elseif self.battleState == GloryBattleState.Before then
            self.attack_text:SetLocalText(302831)
            self.find_btn:SetActive(true)
            self.bottom_desc_text:SetLocalText(302814)
        end
    end
end

local function RefreshIntro(self)
    for i = 1, IntroCount do
        self.intro_goes[i]:SetActive(i == self.introIndex)
    end
end

local function OnAttackClick(self)
    if self.period == GloryPeriod.Prepare then
        -- 宣战记录
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIGloryAllianceDeclareRecord)
    elseif self.period == GloryPeriod.Start then
        if self.battleState == GloryBattleState.None then
            -- 宣战
            if self.isLock == true then
                UIUtil.ShowTipsId(308042)
                return
            end
            if DataCenter.AllianceBaseDataManager:IsR4orR5() then
                if not DataCenter.GloryManager:HasEnoughScoreToDeclare() then
                    -- 积分不足
                    UIUtil.ShowTips(Localization:GetString("302841", DataCenter.GloryManager:GetDeclareNeedScore()))
                elseif not DataCenter.GloryManager:HasEnoughTimeToDeclare() then
                    -- 今日剩余时间不足
                    UIUtil.ShowTipsId(302842)
                else
                    -- 打开宣战界面
                    UIManager:GetInstance():OpenWindow(UIWindowNames.UIGloryDeclare)
                end
            else
                -- 权限不足
                UIUtil.ShowTipsId(300752)
            end
        elseif self.battleState == GloryBattleState.Before then
            -- 前往站场
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIGloryFront)
        end
    end
end

local function OnFindClick(self)
    DataCenter.GloryManager:GoToOpponent()
end

local function OnGloryGetAct(self)
    self:Refresh()
end

local function OnLeftClick(self)
    self.introIndex = (self.introIndex - 2) % IntroCount + 1
    self:RefreshIntro()
end

local function OnRightClick(self)
    self.introIndex = self.introIndex % IntroCount + 1
    self:RefreshIntro()
end

UIGloryBattlePrepare.OnCreate= OnCreate
UIGloryBattlePrepare.OnDestroy = OnDestroy
UIGloryBattlePrepare.ComponentDefine = ComponentDefine
UIGloryBattlePrepare.ComponentDestroy = ComponentDestroy
UIGloryBattlePrepare.DataDefine = DataDefine
UIGloryBattlePrepare.DataDestroy = DataDestroy
UIGloryBattlePrepare.OnEnable = OnEnable
UIGloryBattlePrepare.OnDisable = OnDisable
UIGloryBattlePrepare.OnAddListener = OnAddListener
UIGloryBattlePrepare.OnRemoveListener = OnRemoveListener

UIGloryBattlePrepare.Refresh = Refresh
UIGloryBattlePrepare.RefreshIntro = RefreshIntro
UIGloryBattlePrepare.OnAttackClick = OnAttackClick

UIGloryBattlePrepare.OnGloryGetAct = OnGloryGetAct
UIGloryBattlePrepare.OnFindClick = OnFindClick
UIGloryBattlePrepare.OnLeftClick = OnLeftClick
UIGloryBattlePrepare.OnRightClick = OnRightClick

return UIGloryBattlePrepare