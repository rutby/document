---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/28 20:32
---

local UIGloryInfoHistory = BaseClass("UIGloryInfoHistory", UIBaseContainer)
local base = UIBaseContainer
local UIGloryInfoHistoryItem = require "UI.UIGlory.UIGloryInfo.Component.UIGloryInfoHistoryItem"
local Localization = CS.GameEntry.Localization

local scroll_view_path = "ScrollView"
local content_path = "ScrollView/Viewport/Content"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.scroll_view = self:AddComponent(UIScrollView, scroll_view_path)
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateCell(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteCell(itemObj, index)
    end)
    self.event_trigger = self:AddComponent(UIEventTrigger, content_path)
    self.event_trigger:OnDrag(function(eventData)
        self:OnDrag(eventData)
    end)
    self.event_trigger:OnBeginDrag(function(eventData)
        self:OnBeginDrag(eventData)
    end)
    self.event_trigger:OnEndDrag(function(eventData)
        self:OnEndDrag(eventData)
    end)
end

local function ComponentDestroy(self)
    self.scroll_view = nil
    self.event_trigger = nil
end

local function DataDefine(self)
    self.itemDict = {}
    self.dataList = {}
    self.detailList = {}
    self.detailCtDict = {}
    self.warData = nil
    self.curPage = 0
end

local function DataDestroy(self)
    self.itemDict = nil
    self.dataList = nil
    self.detailList = nil
    self.detailCtDict = nil
    self.warData = nil
    self.curPage = nil
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GloryGetBattleDetail, self.OnGloryGetBattleDetail)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.GloryGetBattleDetail, self.OnGloryGetBattleDetail)
    base.OnRemoveListener(self)
end

local function OnCreateCell(self, itemObj, index)
    itemObj.name = tostring(index)
    local item = self.scroll_view:AddComponent(UIGloryInfoHistoryItem, itemObj)
    item:SetData(self.dataList[index])
    self.itemDict[index] = item

    -- 能看到最后一条时，请求新数据
    if index == #self.dataList then
        self:RequestNextPage()
    end
end

local function OnDeleteCell(self, itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, UIGloryInfoHistoryItem)
    self.itemDict[index] = nil
end

local function ShowScroll(self)
    local count = #self.dataList
    if count > 0 then
        self.scroll_view:SetActive(true)
        self.scroll_view:SetTotalCount(count)
        if self.curPage == 1 then
            self.scroll_view:RefillCells()
        end
    else
        self.scroll_view:SetActive(false)
    end
    self.view:ShowEmpty(count == 0)
end

local function OnDrag(self, eventData)
    self.scroll_view:OnDrag(eventData)
end

local function OnBeginDrag(self, eventData)
    self.scroll_view:OnBeginDrag(eventData)
end

local function OnEndDrag(self, eventData)
    self.scroll_view:OnEndDrag(eventData)
end

local function ReInit(self)
    self.warData = DataCenter.GloryManager:GetWarData()
    if self.curPage == 0 then
        self.detailList = {}
        self.detailCtDict = {}
        self:RequestNextPage()
    end
    self:Refresh()
end

local function RequestNextPage(self)
    DataCenter.GloryManager:SendGetBattleDetail(LuaEntry.Player.allianceId, self.warData.startTime, self.curPage + 1)
end

local function Refresh(self)
    self.dataList = self:GetDataListInternal()
    self:ShowScroll()
end

local function GetDataListInternal(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local dataList = {}
    for _, detail in ipairs(self.detailList) do
        local data = {}
        data.type = UIGloryInfoHistoryItem.ItemType.Detail
        data.detail = detail
        data.time = detail.ct
        if detail.t == GloryBattleDetailType.Win then
            if self.warData.endTime > 0 and curTime >= self.warData.endTime then
                -- 战斗结束
                local data = {}
                data.type = UIGloryInfoHistoryItem.ItemType.Line
                data.lineText = Localization:GetString("302861") .. " " .. UITimeManager:GetInstance():TimeStampToTimeForServer(self.warData.endTime)
                data.time = self.warData.endTime
                table.insert(dataList, data)
            end
        end
        table.insert(dataList, data)
    end
    if #dataList > 0 then
        if self.warData.readyTime > 0 and curTime >= self.warData.readyTime then
            -- 对决开始
            local data = {}
            data.type = UIGloryInfoHistoryItem.ItemType.Line
            data.lineText = Localization:GetString("302860") .. " " .. UITimeManager:GetInstance():TimeStampToTimeForServer(self.warData.readyTime)
            data.time = self.warData.readyTime
            table.insert(dataList, data)
        end
    end
    
    table.sort(dataList, function(dataA, dataB)
        return dataA.time < dataB.time
    end)
    return dataList
end

local function OnGloryGetBattleDetail(self)
    local changed = false
    for _, detail in ipairs(DataCenter.GloryManager:GetBattleDetailList()) do
        if not self.detailCtDict[detail.ct] then
            self.detailCtDict[detail.ct] = true
            changed = true
            table.insert(self.detailList, detail)
        end
    end
    if changed then
        self.curPage = self.curPage + 1
        self:Refresh()
    end
end

UIGloryInfoHistory.OnCreate= OnCreate
UIGloryInfoHistory.OnDestroy = OnDestroy
UIGloryInfoHistory.ComponentDefine = ComponentDefine
UIGloryInfoHistory.ComponentDestroy = ComponentDestroy
UIGloryInfoHistory.DataDefine = DataDefine
UIGloryInfoHistory.DataDestroy = DataDestroy
UIGloryInfoHistory.OnEnable = OnEnable
UIGloryInfoHistory.OnDisable = OnDisable
UIGloryInfoHistory.OnAddListener = OnAddListener
UIGloryInfoHistory.OnRemoveListener = OnRemoveListener

UIGloryInfoHistory.OnCreateCell = OnCreateCell
UIGloryInfoHistory.OnDeleteCell = OnDeleteCell
UIGloryInfoHistory.ShowScroll = ShowScroll
UIGloryInfoHistory.OnDrag = OnDrag
UIGloryInfoHistory.OnBeginDrag = OnBeginDrag
UIGloryInfoHistory.OnEndDrag = OnEndDrag

UIGloryInfoHistory.ReInit = ReInit
UIGloryInfoHistory.RequestNextPage = RequestNextPage
UIGloryInfoHistory.Refresh = Refresh
UIGloryInfoHistory.GetDataListInternal = GetDataListInternal

UIGloryInfoHistory.OnGloryGetBattleDetail = OnGloryGetBattleDetail

return UIGloryInfoHistory