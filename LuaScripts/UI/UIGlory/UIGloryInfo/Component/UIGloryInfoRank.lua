---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/28 20:32
---

local UIGloryInfoRank = BaseClass("UIGloryInfoRank", UIBaseContainer)
local base = UIBaseContainer
local UIGloryInfoRankItem = require "UI.UIGlory.UIGloryInfo.Component.UIGloryInfoRankItem"
local Localization = CS.GameEntry.Localization

local rank_path = "Head/Rank"
local filter_path = "Head/Rank/Filter"
local name_path = "Head/Name"
local score_path = "Head/Score"
local sort_path = "Head/Score/Sort"
local scroll_view_path = "ScrollView"

local FilterType =
{
    Whole = 1,
    Ally = 2,
}

local SortType =
{
    Asc = 1,
    Desc = 2,
}

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.rank_text = self:AddComponent(UIText, rank_path)
    self.rank_text:SetLocalText(150118)
    self.filter_btn = self:AddComponent(UIButton, filter_path)
    self.filter_btn:SetOnClick(function()
        self:OnFilterClick()
    end)
    self.name_text = self:AddComponent(UIText, name_path)
    self.name_text:SetLocalText(302129)
    self.score_text = self:AddComponent(UIText, score_path)
    self.score_text:SetLocalText(361001)
    self.sort_btn = self:AddComponent(UIButton, sort_path)
    self.sort_btn:SetOnClick(function()
        self:OnSortClick()
    end)
    self.scroll_view = self:AddComponent(UIScrollView, scroll_view_path)
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateCell(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteCell(itemObj, index)
    end)
end

local function ComponentDestroy(self)
    self.rank_text = nil
    self.filter_btn = nil
    self.name_text = nil
    self.score_text = nil
    self.sort_btn = nil
    self.scroll_view = nil
end

local function DataDefine(self)
    self.leftAllianceId = ""
    self.rightAllianceId = ""
    self.leftRecord = nil
    self.rightRecord = nil
    self.dataList = {}
    self.filterType = FilterType.Whole
    self.sortType = SortType.Desc
end

local function DataDestroy(self)
    self.leftAllianceId = nil
    self.rightAllianceId = nil
    self.leftRecord = nil
    self.rightRecord = nil
    self.dataList = nil
    self.filterType = nil
    self.sortType = nil
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GloryGetMemberRecord, self.OnGloryGetMemberRecord)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.GloryGetMemberRecord, self.OnGloryGetMemberRecord)
    base.OnRemoveListener(self)
end

local function OnCreateCell(self, itemObj, index)
    itemObj.name = tostring(index)
    local item = self.scroll_view:AddComponent(UIGloryInfoRankItem, itemObj)
    item:SetData(self.dataList[index])
end

local function OnDeleteCell(self, itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, UIGloryInfoRankItem)
end

local function ShowScroll(self)
    local count = #self.dataList
    if count > 0 then
        self.scroll_view:SetActive(true)
        self.scroll_view:SetTotalCount(count)
        self.scroll_view:RefillCells()
    else
        self.scroll_view:SetActive(false)
    end
    self.view:ShowEmpty(count == 0)
end

-- leftAllianceId: string
-- rightAllianceId: string
-- readyTime: long
local function ReInit(self, leftAllianceId, rightAllianceId, readyTime)
    if #self.dataList == 0 then
        self.leftAllianceId = leftAllianceId
        self.rightAllianceId = rightAllianceId
        self.leftRecord = nil
        self.rightRecord = nil
        DataCenter.GloryManager:SendGetMemberRecord(leftAllianceId, readyTime)
        DataCenter.GloryManager:SendGetMemberRecord(rightAllianceId, readyTime)
    end
    self:Refresh()
end

local function Refresh(self)
    self.rank_text:SetLocalText(self.filterType == FilterType.Whole and 150118 or 302338)
    self.dataList = self:GetDataListInternal()
    self:ShowScroll()
end

local function GetDataListInternal(self)
    local dataList = {}
    if self.leftRecord and self.rightRecord then
        for _, record in ipairs({ [1] = self.leftRecord, [2] = self.rightRecord }) do
            for _, v in ipairs(record.memberScoreDataList) do
                if self.filterType == FilterType.Whole or record.allianceId == LuaEntry.Player.allianceId then
                    local data = DeepCopy(v)
                    data.serverId = record.serverId
                    data.abbr = record.abbr
                    data.alName = record.alName
                    table.insert(dataList, data)
                end
            end
        end
    end
    table.sort(dataList, function(dataA, dataB)
        if dataA.score ~= dataB.score then
            if self.sortType == SortType.Asc then
                return dataA.score < dataB.score
            else
                return dataA.score > dataB.score
            end
        else
            return dataA.uid < dataB.uid
        end
    end)
    for i, data in ipairs(dataList) do
        data.rank = i
    end
    return dataList
end

local function OnFilterClick(self)
    if self.filterType == FilterType.Whole then
        self.filterType = FilterType.Ally
    else
        self.filterType = FilterType.Whole
    end
    self:Refresh()
end

local function OnSortClick(self)
    if self.sortType == SortType.Asc then
        self.sortType = SortType.Desc
    else
        self.sortType = SortType.Asc
    end
    self:Refresh()
end

local function OnGloryGetMemberRecord(self, allianceId)
    if self.leftAllianceId == allianceId then
        self.leftRecord = DataCenter.GloryManager:GetMemberRecord(allianceId)
    elseif self.rightAllianceId == allianceId then
        self.rightRecord = DataCenter.GloryManager:GetMemberRecord(allianceId)
    end
    self:Refresh()
end

UIGloryInfoRank.OnCreate= OnCreate
UIGloryInfoRank.OnDestroy = OnDestroy
UIGloryInfoRank.ComponentDefine = ComponentDefine
UIGloryInfoRank.ComponentDestroy = ComponentDestroy
UIGloryInfoRank.DataDefine = DataDefine
UIGloryInfoRank.DataDestroy = DataDestroy
UIGloryInfoRank.OnEnable = OnEnable
UIGloryInfoRank.OnDisable = OnDisable
UIGloryInfoRank.OnAddListener = OnAddListener
UIGloryInfoRank.OnRemoveListener = OnRemoveListener

UIGloryInfoRank.OnCreateCell = OnCreateCell
UIGloryInfoRank.OnDeleteCell = OnDeleteCell
UIGloryInfoRank.ShowScroll = ShowScroll

UIGloryInfoRank.ReInit = ReInit
UIGloryInfoRank.Refresh = Refresh
UIGloryInfoRank.GetDataListInternal = GetDataListInternal

UIGloryInfoRank.OnFilterClick = OnFilterClick
UIGloryInfoRank.OnSortClick = OnSortClick

UIGloryInfoRank.OnGloryGetMemberRecord = OnGloryGetMemberRecord

return UIGloryInfoRank