---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime:
---累充

local DailyCumulativeRecharge = BaseClass("DailyCumulativeRecharge", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UICumulativeItem = require "UI.UIGiftPackage.Component.DailyCumulativeRecharge.UIDailyCumulativeItem"
local view_path = "RightView"
local scroll_path = "RightView/Scroll"
local content_path = "RightView/Scroll/Content"
local actTypeIcon_img_path = "RightView/Rect_TopInfo/Img_ActTypeIcon"
local score_txt_path = "RightView/Rect_TopInfo/Txt_Score"
local getmore_btn_path = "RightView/Btn_GetMore"
local getmore_txt_path = "RightView/Btn_GetMore/Txt_GetMore"
local time_txt_path = "RightView/ActTime/remainTime"
local title_txt_path = "RightView/title_main"
local desc_txt_path = "RightView/Txt_Desc"
local intro_path = "RightView/Intro"
local txt_dailyDesc_path = "RightView/Img_DailyTime/Txt_DailyDesc"
local txt_dailyTime_path = "RightView/Img_DailyTime/Txt_DailyTime"
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)

    self.anim_car = nil
    self:ClearScroll()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.view_path = self:AddComponent(UIBaseComponent,view_path)
    self._score_txt = self:AddComponent(UITextMeshProUGUIEx,score_txt_path)
    self._actTypeIcon_img = self:AddComponent(UIImage,actTypeIcon_img_path)
    self.scroll = self:AddComponent(UIScrollRect, scroll_path)
    self.content_sv = self:AddComponent(GridInfinityScrollView, content_path)
    self._time_txt = self:AddComponent(UITextMeshProUGUIEx,time_txt_path)
    self._getMore_btn = self:AddComponent(UIButton,getmore_btn_path)
    self._getMore_btn:SetOnClick(function()
        self:OnClickGetMore()
    end)
    self.title_txt = self:AddComponent(UITextMeshProUGUIEx,title_txt_path)

    self.getMore_txt = self:AddComponent(UITextMeshProUGUIEx,getmore_txt_path)
    self.getMore_txt:SetLocalText(320413)
    self.desc_txt = self:AddComponent(UITextMeshProUGUIEx,desc_txt_path)
    self.desc_txt:SetLocalText(320799)
    self.intro_btn = self:AddComponent(UIButton, intro_path)
    self.intro_btn:SetOnClick(function()
        UIUtil.ShowIntro(Localization:GetString("320410"), Localization:GetString("100239"),Localization:GetString("320412"))
    end)

    self._dailyDesc_txt = self:AddComponent(UITextMeshProUGUIEx,txt_dailyDesc_path)
    self._dailyDesc_txt:SetLocalText(320798)
    self._dailyTime_txt = self:AddComponent(UITextMeshProUGUIEx,txt_dailyTime_path)
end


local function ComponentDestroy(self)
    self._score_txt = nil
    self._time_txt = nil
    self._getMore_btn = nil
    self.title_txt = nil
    self.desc_txt_path = nil
    self.intro_btn = nil
end

local function DataDefine(self)
    self.isFirst = true
    self.itemList = {}
    self.dataList = {}
    self.cell     = {}
    self.timer = nil
    self.timer_action = function(temp)
        self:RefreshTime()
    end
end

local function DataDestroy(self)
    self.itemList = nil
    self.dataList = nil
    self.cell     = nil
    self.isFirst  = nil
    self:DeleteTimer()
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.CumulativeReward, self.UpdateCellByStageId)
    self:AddUIListener(EventId.RefreshDailyCumulative, self.RefreshUI)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.CumulativeReward, self.UpdateCellByStageId)
    self:RemoveUIListener(EventId.RefreshDailyCumulative, self.RefreshUI)
end

local function RefreshUI(self,id)
    self.rechargeId,self.dataList = DataCenter.CumulativeRechargeManager:GetInfo(id)
    self._score_txt:SetText(self.dataList.score)
    self.curStage = DataCenter.CumulativeRechargeManager:GetCurStage(self.rechargeId)
    if self.isFirst then
        local OnInitCell = BindCallback(self, self.OnInitCell)
        local OnUpdateCell = BindCallback(self, self.OnUpdateCell)
        local OnDestroyCell = BindCallback(self, self.OnDestroyCell)
        self.content_sv:Init(OnInitCell, OnUpdateCell, OnDestroyCell)
        self.content_sv:SetItemCount(#self.dataList.stageInfo)
        self.isFirst = false
    else
        self.content_sv:ForceUpdate()
    end
    local canRecv = DataCenter.CumulativeRechargeManager:CheckCanRecv(self.rechargeId)
    if canRecv ~= 0 then
        self.content_sv:MoveItemByIndex(canRecv-1,0)
    else
        self.content_sv:MoveItemByIndex(self.curStage-1,0)
    end
    self:RefreshTime()
    self:AddTimer()
end

local function ReInit(self,welfarelist,id,index,curRechargeId)
    self.welfarelist = welfarelist
    local _name = welfarelist[index]:getName()
    self.title_txt:SetLocalText(_name)

    DataCenter.CumulativeRechargeManager:SendGetRechargeInfo(id)
    
    self.actTypePath = GetTableData("recharge", curRechargeId, "image2")
    self._actTypeIcon_img:LoadSprite(string.format(LoadPath.ItemPath, self.actTypePath))
    self.rechargeId,self.dataList = DataCenter.CumulativeRechargeManager:GetInfo(id)
    self._score_txt:SetText(self.dataList.score)
    self.curStage = DataCenter.CumulativeRechargeManager:GetCurStage(self.rechargeId)
    self.lastTime = UITimeManager:GetInstance():GetServerTime()
    if self.isFirst then
        local OnInitCell = BindCallback(self, self.OnInitCell)
        local OnUpdateCell = BindCallback(self, self.OnUpdateCell)
        local OnDestroyCell = BindCallback(self, self.OnDestroyCell)
        self.content_sv:Init(OnInitCell, OnUpdateCell, OnDestroyCell)
        self.content_sv:SetItemCount(#self.dataList.stageInfo)
        self.isFirst = false
    else
        self.content_sv:ForceUpdate()
    end

    local canRecv = DataCenter.CumulativeRechargeManager:CheckCanRecv(self.rechargeId)
    if canRecv ~= 0 then
        self.content_sv:MoveItemByIndex(canRecv-1,0)
    else
        self.content_sv:MoveItemByIndex(self.curStage-1,0)
    end
 
    self.actEnd = false
    self:RefreshTime()
    self:AddTimer()
end

local function OnInitCell(self, go, index)
    local item = self.scroll:AddComponent(UICumulativeItem, go)
    self.itemList[go] = item
end

local function OnUpdateCell(self, go, index)
    local item = self.itemList[go]
    local data = self.dataList.stageInfo[index + 1]
    go.name = self.dataList.stageInfo[index+1].needScore
    go:SetActive(true)

    local param = {}
    param.rechargeId = self.rechargeId
    param.info = data
    param.scrollView = self.scroll
    param.curScore = self.dataList.score
    param.curStage = self.curStage
    param.index = index + 1
    param.imgPath = self.actTypePath
    param.isFirst = (index + 1) == 1
    param.isLast1 = (index + 1) == #self.dataList.stageInfo
    param.isLast2 = (index + 1) == #self.dataList.stageInfo - 1
    param.showUp = param.info.needScore <= param.curScore
    param.showDown = false
    if (index + 1) == #self.dataList.stageInfo then
        param.showDown = param.info.needScore <= param.curScore
    else
        local nextData = self.dataList.stageInfo[index + 2]
        param.showDown = nextData.needScore <= self.dataList.score
    end
    item:ReInit(param)
    
    self.cell[data.stageId] = item
end

local function OnDestroyCell(self, go, index)

end

local function ClearScroll(self)
    self.scroll:RemoveComponents(UICumulativeItem)
    self.content_sv:DestroyChildNode()
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action, self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local deltaTime = self.dataList.endTime - curTime
    if deltaTime > 0 then
        self.actEnd = true
        self._time_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
    else
        self.actEnd = false
    end
    local remainTime = UITimeManager:GetInstance():GetResSecondsTo24()
    if remainTime and remainTime > 0 then
        self._dailyTime_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(remainTime * 1000))
    end
    if self.lastTime then
        if not UITimeManager:GetInstance():IsSameDayForServer(curTime // 1000, self.lastTime // 1000) then
            self:DeleteTimer()
            DataCenter.CumulativeRechargeManager:SendGetRechargeInfo(self.rechargeId)
        end
    end
end

local function DeleteTimer(self)
    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end
end

local function UpdateCellByStageId(self,param)
    self.cell[param]:RewardUpdate()
end

local function OnClickGetMore(self)
    for i = 1, #self.welfarelist do
        if self.welfarelist[i]:getType() ~= WelfareTagType.DailyCumulativeRecharge then
            self.view:GotoButtonType(self.welfarelist[i]:getType(),nil,WelfareTagType.DailyCumulativeRecharge)
            break
        end
    end
end

DailyCumulativeRecharge.OnCreate = OnCreate
DailyCumulativeRecharge.OnDestroy = OnDestroy
DailyCumulativeRecharge.OnEnable = OnEnable
DailyCumulativeRecharge.OnDisable = OnDisable
DailyCumulativeRecharge.ComponentDefine = ComponentDefine
DailyCumulativeRecharge.ComponentDestroy = ComponentDestroy
DailyCumulativeRecharge.DataDefine = DataDefine
DailyCumulativeRecharge.DataDestroy = DataDestroy
DailyCumulativeRecharge.OnAddListener = OnAddListener
DailyCumulativeRecharge.OnRemoveListener = OnRemoveListener
DailyCumulativeRecharge.RefreshUI = RefreshUI
DailyCumulativeRecharge.OnInitCell = OnInitCell
DailyCumulativeRecharge.OnUpdateCell = OnUpdateCell
DailyCumulativeRecharge.OnDestroyCell = OnDestroyCell
DailyCumulativeRecharge.ReInit = ReInit
DailyCumulativeRecharge.ClearScroll = ClearScroll
DailyCumulativeRecharge.AddTimer = AddTimer
DailyCumulativeRecharge.RefreshTime = RefreshTime
DailyCumulativeRecharge.DeleteTimer = DeleteTimer
DailyCumulativeRecharge.UpdateCellByStageId = UpdateCellByStageId
DailyCumulativeRecharge.OnClickGetMore = OnClickGetMore

return DailyCumulativeRecharge