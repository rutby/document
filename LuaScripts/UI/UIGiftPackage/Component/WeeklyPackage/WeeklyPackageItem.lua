---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/2/16 12:12
---
local GolloesCampItem = BaseClass("GolloesCampItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIGiftItem = require "UI.UIGiftPackage.Component.UIGiftItem"
local UIGray = CS.UIGray

local packageIcon_path = "Image/packageIcon"
local isHot_path = "Image/isHot"
local isHotTxt_path = "Image/isHot/isHotTxt"
local discount_path = "Image/discount"
local discountTxt_path = "Image/discount/discountTxt"
local limitTip_path = "Image/limit"
local buyBtn_path = "Image/Button"
local buyBtnTxt_path = "Image/Button/TxtPrice2"
local freeBtn_path = "Image/BuyBtn"
local freeBtnTxt_path = "Image/BuyBtn/BuyText"
local mask_path = "Image/mask"
local soldOutBg_path = "Image/boughBg"
local soldOut_path = "Image/boughBg/bought"
local rewards_path = "Image/ItemGroup/rewardItem%s/SmallItem%s"
local freeRedPoint_path = "Image/redDot"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.packageIconN = self:AddComponent(UIImage, packageIcon_path)
    self.isHotN = self:AddComponent(UIBaseContainer, isHot_path)
    self.isHotTxtN = self:AddComponent(UIText, isHotTxt_path)
    self.discountN = self:AddComponent(UIBaseContainer, discount_path)
    self.discountTxtN = self:AddComponent(UIText, discountTxt_path)
    self.limitTipN = self:AddComponent(UIText, limitTip_path)
    self.buyBtnN = self:AddComponent(UIButton, buyBtn_path)
    self.buyBtnImg = self:AddComponent(UIImage, buyBtn_path)
    self.buyBtnN:SetOnClick(function()
        self:OnClickBuyBtn()
    end)
    self.buyBtnTxtN = self:AddComponent(UIText, buyBtnTxt_path)
    self.freeBtnN = self:AddComponent(UIButton, freeBtn_path)
    self.freeBtnImg = self:AddComponent(UIImage, freeBtn_path)
    self.freeBtnN:SetOnClick(function()
        self:OnClickCliamFreePackage()
    end)
    self.freeBtnTxtN = self:AddComponent(UIText, freeBtnTxt_path)
    self.soldOutBgN = self:AddComponent(UIBaseContainer, soldOutBg_path)
    self.maskN = self:AddComponent(UIBaseContainer, mask_path)
    self.soldOutN = self:AddComponent(UIText, soldOut_path)
    self.soldOutN:SetLocalText(320268)
    
    self.rewardsTbN = {}
    for i = 1, 3 do
        local rewardItem = self:AddComponent(UIGiftItem, string.format(rewards_path, i, i))
        table.insert(self.rewardsTbN, rewardItem)
    end
    self.freeRedPointN = self:AddComponent(UIBaseContainer, freeRedPoint_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.packageIconN = nil
    self.isHotN = nil
    self.isHotTxtN = nil
    self.discountN = nil
    self.discountTxtN = nil
    self.limitTipN = nil
    self.buyBtnN = nil
    self.buyBtnTxtN = nil
    self.maskN = nil
    self.soldOutN = nil
    self.rewardsTbN = nil
    self.soldOutBgN = nil
end

--变量的定义
local function DataDefine(self)
    self.packageInfo = nil
    self.rewardList = nil
end

--变量的销毁
local function DataDestroy(self)
    self.packageInfo = nil
    self.rewardList = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.UpdateGiftPackData, self.RefreshUI)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.UpdateGiftPackData, self.RefreshUI)
    base.OnRemoveListener(self)
end


local function SetItem(self, tempPackage)
    self.packageInfo = tempPackage
    self.rewardList = self:GetCellsList()
    
    if not tempPackage.isWeeklyFreePackage then
        self.packageId = tempPackage:getID()
    end 
    
    self:RefreshUI()
end

local function RefreshUI(self)
    if self.packageId then
        self.packageInfo = GiftPackageData.get(self.packageId)
        self.rewardList = self:GetCellsList()
    end
    
    --图标
    local bgParam = self.packageInfo:getPopupImageMini()
    if bgParam and bgParam ~= "" then
        local bgPath = string.format("Assets/Main/Sprites/UI/UIweeklyPackage/%s", bgParam)
        self.packageIconN:LoadSprite(bgPath)
    end
    
    local discountTips = self.packageInfo:GetDiscountTips()
    --下方限购提示1
    if discountTips and discountTips[1] then
        self.limitTipN:SetText(discountTips[1])
    else
        self.limitTipN:SetText("")
    end
    --左上折扣提示2
    if discountTips and discountTips[2] then
        self.isHotN:SetActive(true)
        self.isHotTxtN:SetText(discountTips[2])
    else
        self.isHotN:SetActive(false)
    end

    -- 折扣3
    if discountTips and discountTips[3] then
        self.discountN:SetActive(true)
        self.discountTxtN:SetText(discountTips[3])
    else
        local hasPercent = self.packageInfo:hasPercent()
        if hasPercent then
            self.discountN:SetActive(true)
            self.discountTxtN:SetText(string.format("%s%%", self.packageInfo:getPercent()))
        else
            self.discountN:SetActive(false)
        end
    end
    
    --物品
    for i, tempItem in ipairs(self.rewardsTbN) do
        if i <= #self.rewardList then
            tempItem:SetActive(true)
            tempItem:ReInit(self.rewardList[i])
        else
            tempItem:SetActive(false)
        end
    end

    local strPrice = ""--DataCenter.PayManager:GetDollarText(self.packageInfo:getPrice(), self.packageInfo:getProductID())
    local boughtNum = 0--self.packageInfo:getHasGetCount()
    local maxNum = 0--self.packageInfo:getBuyTimes()
    if self.packageInfo.isWeeklyFreePackage then
        strPrice = Localization:GetString("130126")
        --local lastT = GiftPackageData.GetLastBuyFreeWeekPackageT()
        --local isSameWeek = UITimeManager:GetInstance():CheckIfIsSameWeek(lastT)
        boughtNum = GiftPackageData.CheckIfHasFreeWeeklyPackage() and 0 or 1
        maxNum = 1
        self.freeRedPointN:SetActive(true)
        
        self.freeBtnN:SetActive(true)
        self.buyBtnN:SetActive(false)
        self.freeBtnTxtN:SetText(strPrice)
    else
        strPrice = DataCenter.PayManager:GetDollarText(self.packageInfo:getPrice(), self.packageInfo:getProductID())
        boughtNum = self.packageInfo:getHasGetCount()
        maxNum = self.packageInfo:getBuyTimes()

        self.freeRedPointN:SetActive(false)
        self.freeBtnN:SetActive(false)
        self.buyBtnN:SetActive(true)
        self.buyBtnTxtN:SetText(strPrice)
        
    end
    
    if boughtNum >= maxNum then
        --self.buyBtnN:SetActive(true)
        --self.buyBtnTxtN:SetText(strPrice)
        --self.freeBtnN:SetActive(false)
        self.freeRedPointN:SetActive(false)
        self.soldOutBgN:SetActive(true)
        self.maskN:SetActive(true)
        UIGray.SetGray(self.freeBtnN.transform, true, true)
        UIGray.SetGray(self.transform, true, true)
        UIGray.SetGray(self.soldOutBgN.transform, false, true)
        
        self.buyBtnImg:SetColor(Color.New(1, 1, 1, 0))
        self.freeBtnImg:SetColor(Color.New(1, 1, 1, 0))
        self.buyBtnN:SetInteractable(false)
        self.freeBtnN:SetInteractable(false)
        --self.soldOutN:SetColor(Color.New(204/255, 94/255, 94/255, 1))
        
    else
        self.maskN:SetActive(false)
        self.soldOutBgN:SetActive(false)
        UIGray.SetGray(self.freeBtnN.transform, false, true)
        UIGray.SetGray(self.transform, false, true)
       
        self.buyBtnImg:SetColor(Color.New(1, 1, 1, 1))
        self.freeBtnImg:SetColor(Color.New(1, 1, 1, 1))
        self.buyBtnN:SetInteractable(true)
        self.freeBtnN:SetInteractable(true)
        --self.soldOutN:SetColor(Color.New(0.5, 0.5, 0.5, 1))
    end
    
    local remainTimes = maxNum - boughtNum
    remainTimes = remainTimes < 0 and 0 or remainTimes
    if remainTimes > 0 then
        self.limitTipN:SetText(Localization:GetString("320319", remainTimes))
    else
        self.limitTipN:SetText("")
    end
end


local function GetCellsList(self)
    local listParam = {}
    local info = self.packageInfo

    --免费礼包直接返回
    if self.packageInfo.isWeeklyFreePackage then
        for i, v in ipairs(self.packageInfo.rewards) do
            local tempParam = {}
            tempParam.type = RewardToResType[v.type]
            if type(v.value) == "table" then
                tempParam.itemId = v.value.id
                tempParam.count = v.value.num
            else
                tempParam.count = v.value
                tempParam.itemId = tempParam.type
            end
            table.insert(listParam, tempParam)
        end
        return listParam
    end
    
    local goldParam = {}
    local goldNum = tonumber(info:getDiamond())
    if goldNum > 0 then
        goldParam.count = string.GetFormattedSeperatorNum(goldNum)
        goldParam.itemId = ResourceType.Gold
        table.insert(listParam,goldParam)
    end
    
    --联盟礼物不在周礼包显示
    --local arrAlliance = info:getAllianceGift()
    --if arrAlliance ~= nil and #arrAlliance > 0 then
    --    for k,v in ipairs(arrAlliance) do
    --        local arr = string.split(v,";")
    --        if #arr > 4 then
    --            local param = {}-- UIGiftPackageCell.Param.New()
    --            param.iconName = string.format(LoadPath.UIAllianceGift, arr[1])
    --            param.itemName = arr[2]
    --            param.itemDes = arr[3]
    --            param.count = arr[4]
    --            param.itemColor = arr[5]
    --            table.insert(listParam,param)
    --        end
    --    end
    --end
    
    

    -- 英雄
    local heroStr = info:getHeroesStr()
    if (not string.IsNullOrEmpty(heroStr)) then
        local arr = string.split(heroStr, ";")
        if (#arr == 2) then
            local param = {}-- UIGiftPackageCell.Param.New()
            param.heroId = arr[1]
            param.count = arr[2]
            table.insert(listParam,param)
        end
    end

    -- 普通道具
    local str = info:getItemsStr()
    local _item_use = info:getItemUse()
    if _item_use ~= nil and _item_use ~= "" then
        str = _item_use .. "|" .. str
    end

    local arrMiddle = string.split(str,"|")
    if arrMiddle ~= nil and #arrMiddle > 0 then
        for k,v in ipairs(arrMiddle) do
            local arr = string.split(v,";")
            if arr[1] ~= "" then
                local param = {}-- UIGiftPackageCell.Param.New()
                param.itemId = arr[1]
                param.count = arr[2]
                table.insert(listParam,param)
            end
        end
    end

    return listParam
end

local function OnClickBuyBtn(self)
    self.view.ctrl:BuyGift(self.packageInfo)
end

local function OnClickCliamFreePackage(self)
    SFSNetwork.SendMessage(MsgDefines.BuyFreeWeeklyPackage)
end

local function ShowArrow(self)
    local param = {}
    param.position = self.buyBtnN.transform.position
    param.arrowType = ArrowType.Normal
    param.positionType = PositionType.Screen
    TimerManager:GetInstance():DelayInvoke(function()
        DataCenter.ArrowManager:ShowArrow(param)
    end, 0.1)
end


GolloesCampItem.OnCreate = OnCreate
GolloesCampItem.OnDestroy = OnDestroy
GolloesCampItem.OnEnable = OnEnable
GolloesCampItem.OnDisable = OnDisable
GolloesCampItem.ComponentDefine = ComponentDefine
GolloesCampItem.ComponentDestroy = ComponentDestroy
GolloesCampItem.DataDefine = DataDefine
GolloesCampItem.DataDestroy = DataDestroy
GolloesCampItem.OnAddListener = OnAddListener
GolloesCampItem.OnRemoveListener = OnRemoveListener

GolloesCampItem.SetItem = SetItem
GolloesCampItem.RefreshUI = RefreshUI
GolloesCampItem.GetCellsList = GetCellsList
GolloesCampItem.OnClickBuyBtn = OnClickBuyBtn
GolloesCampItem.OnClickCliamFreePackage = OnClickCliamFreePackage
GolloesCampItem.ShowArrow = ShowArrow

return GolloesCampItem