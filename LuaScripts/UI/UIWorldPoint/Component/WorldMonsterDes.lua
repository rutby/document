---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/9/27 20:44
---
local RewardItem = require "UI.UIWorldPoint.Component.WorldPointRewardItem"
local WorldMonsterDes = BaseClass("WorldMonsterDes", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local main_obj_path = "BuildInfo"
local des_obj_path = "BuildDetails"
local firstRewardScroll_path  = "BuildInfo/ScrollViewFirst"
local first_content_path = "BuildInfo/ScrollViewFirst/Viewport/FirstContent"
local content_path = "BuildInfo/ScrollView/Viewport/Content"
local time_obj_path = "BuildInfo/monsterLayout/time"
local time_txt_path = "BuildInfo/monsterLayout/time/timeLabel"
local tips_path = "BuildInfo/tips"
local tips1_txt_path = "BuildInfo/tips/commendText"
local tips2_txt_path = "BuildInfo/tips/commendText2"
local boosreward_path = "BuildInfo/tips/BossReward"
local des_txt_path = "BuildDetails/desTxt"
local power_rect_path = "BuildInfo/powerRecommend"
local power_txt_path = "BuildInfo/powerRecommend/Recommend_Power"
local tip_path = "BuildInfo/monsterLayout/simple_tip"
local monsterLayout_path = "BuildInfo/monsterLayout"
local tip_1_path = "BuildInfo/monsterLayout/simple_tip/simple_tip_1"
local firstKill_path = "BuildInfo/firstKill"
local firstKill_txt_path = "BuildInfo/firstKill/Txt_FirstKill"
local reward_txt_path = "BuildInfo/rewardDes/rewardTxt"
local animator_path = ""
local lvPowerTips = {[1] = 302017,[2] = 302018,[3] = 302019,[4] = 302020,[5] = 302021}
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetAllCellDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:OnReturnClick()
    self:DeleteTimer()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.animator = self:AddComponent(UIAnimator, animator_path)
    self.main_obj = self:AddComponent(UIBaseContainer,main_obj_path)
    self.des_obj = self:AddComponent(UIBaseContainer,des_obj_path)
    self.main_obj_canvas = self:AddComponent(UICanvasGroup,main_obj_path)
    self.des_obj_canvas = self:AddComponent(UICanvasGroup,des_obj_path)
    self.main_obj_canvas:SetAlpha(1)
    self.des_obj_canvas:SetAlpha(1)
    self.firstRewardScroll = self:AddComponent(UIBaseContainer,firstRewardScroll_path)
    self.first_content = self:AddComponent(UIBaseContainer,first_content_path)
    self.content = self:AddComponent(UIBaseContainer,content_path)
    self.time_obj = self:AddComponent(UIBaseContainer,time_obj_path)
    self.monsterLayout = self:AddComponent(UIBaseContainer,monsterLayout_path)
    self.time_txt = self:AddComponent(UITextMeshProUGUIEx,time_txt_path)
    self.tips_txt = self:AddComponent(UITextMeshProUGUIEx,tips1_txt_path)
    self.tips2_txt = self:AddComponent(UITextMeshProUGUIEx,tips2_txt_path)
    self.boosReward = self:AddComponent(RewardItem,boosreward_path)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx,des_txt_path)
    self.power_rect = self:AddComponent(UIBaseContainer,power_rect_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx,power_txt_path)
    self.tips_path = self:AddComponent(UIBaseContainer,tips_path)
    self.tip = self:AddComponent(UITextMeshProUGUIEx, tip_path)
    self.tip_1 = self:AddComponent(UITextMeshProUGUIEx, tip_1_path)
    self.firstKill = self:AddComponent(UIBaseContainer,firstKill_path)
    self.firstKill_txt = self:AddComponent(UITextMeshProUGUIEx,firstKill_txt_path)
    self.reward_txt = self:AddComponent(UITextMeshProUGUIEx,reward_txt_path)
    self.reward_txt:SetLocalText(450084)
end

--控件的销毁
local function ComponentDestroy(self)
    self.btn = nil
    self.btnImage = nil
    self.power_txt = nil
    self.power_rect = nil
end

--变量的定义
local function DataDefine(self)
    self.data = nil
    self.timer_action = function(temp)
        self:RefreshTime()
    end
end

--变量的销毁
local function DataDestroy(self)
    self.data = nil
end

local function SetAllCellDestroy(self)
    self.first_content:RemoveComponents(RewardItem)
    if self.firstModel~=nil then
        for k,v in pairs(self.firstModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.firstModel = {}
    self.content:RemoveComponents(RewardItem)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end
local function RefreshData(self,param)
    self.data = param
    self.des_txt:SetLocalText(self.data.des)
    self.tips2_txt:SetActive(false)
    self.boosReward:SetActive(false)
    self.tips_path:SetActive(true)
    self.tip:SetActive(false)
    self.power_rect:SetActive(self.view.ctrl.type == WorldPointUIType.Boss)
    -- if param.eventId and param.eventId ~= "" then
    --     self.firstKill:SetActive(false)
    -- else
    --     
    -- end
    self.firstKill:SetActive(self.view.ctrl.type == WorldPointUIType.Monster and param.isFirstKill and #self.data.firstRewardStr>0 )
    self.firstRewardScroll:SetActive(self.view.ctrl.type == WorldPointUIType.Monster and param.isFirstKill and #self.data.firstRewardStr>0 )
    self.monsterLayout:SetActive(true)
    if self.view.ctrl.type == WorldPointUIType.Monster then
        self.time_obj:SetActive(not CS.SceneManager:IsInCity())
        if self.data.canAttack == 1 then
            self.tips_txt:SetText(self.data.recommend_power) 
        else
            self.tips_txt:SetLocalText(128008, DataCenter.MonsterManager:GetCurCanAttackMaxLevel())
        end
        if CS.SceneManager:IsInWorld() then
            self:AddTimer()
            self:RefreshTime()
        end
        self.tip:SetActive(true)
        self.tip:SetText("")
        local attackMonster = MarchUtil.GetCostStaminaByTargetType(MarchTargetType.ATTACK_MONSTER)
        self.tip_1:SetText(math.floor(attackMonster))
        self.firstKill_txt:SetLocalText(121512)
    elseif self.view.ctrl.type == WorldPointUIType.Explore then
        self.time_obj:SetActive(false)
        self.tips_txt:SetText(self.data.recommend_power)
        local detectEventData = DataCenter.RadarCenterDataManager:GetDetectEventInfo(self.data.uuid)
        if detectEventData ~= nil then
            local config = DataCenter.DetectEventTemplateManager:GetDetectEventTemplate(detectEventData.eventId)
            if config ~= nil and (config:getValue("type") == DetectEventType.DetectEventPVE or config:getValue("type") == DetectEventType.HeroTrial or config:getValue("type") == DetectEventType.SPECIAL_OPS) and not string.IsNullOrEmpty(config:getValue("para2")) then
                local k9 = LuaEntry.DataConfig:TryGetNum("car_action_stamina", "k9")
                if k9>0 then
                    self.tip:SetActive(true)
                    self.tip:SetText("")
                    self.tip_1:SetText(math.floor(k9))
                end
            end
        end
        
    elseif self.view.ctrl.type == WorldPointUIType.Boss then
        self.time_obj:SetActive(false)
        self.monsterLayout:SetActive(false)
        self:AddTimer()
        self:RefreshTime()
        self.tips_path:SetActive(false)
        self.tips2_txt:SetActive(true)
        self.boosReward:SetActive(true)
        self.tips_txt:SetLocalText(302008)
        self.tips2_txt:SetLocalText(302117, self.data.restNum)
        
        CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.tips_txt.rectTransform)
        CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.tips2_txt.rectTransform)
        --local strRecommendPower = Localization:GetString(lvPowerTips[self.data.level])
        if self.data.limit then-- and DataCenter.BuildManager.MainLv < self.data.limit
            local limitTip = Localization:GetString("143574", self.data.limit)
            --strRecommendPower = strRecommendPower .. "\n" .. limitTip
            self.power_txt:SetText(limitTip)
        end
        
        --self.power_txt:SetLocalText(300644, self.data.recommend_power)
    elseif self.view.ctrl.type == WorldPointUIType.Sample then
        self.time_obj:SetActive(true)
        self:AddTimer()
        self:RefreshTime()
        self.tips_txt:SetText("")
        local detectEventData = DataCenter.RadarCenterDataManager:GetDetectEventInfo(self.data.uuid)
        if detectEventData ~= nil then
            local config = DataCenter.DetectEventTemplateManager:GetDetectEventTemplate(detectEventData.eventId)
            if config ~= nil and config:getValue("type") == DetectEventType.DetectEventPickGarbage then
                local k10 = LuaEntry.DataConfig:TryGetNum("car_action_stamina", "k10")
                if k10>0 then
                    self.tip:SetActive(true)
                    self.tip:SetText("")
                    self.tip_1:SetText(math.floor(k10))
                end
            end
        end
    elseif self.view.ctrl.type == WorldPointUIType.PickGarbage then
        self.time_obj:SetActive(true)
        self:AddTimer()
        self:RefreshTime()
        self.tips_txt:SetText("")
        local k8 = LuaEntry.DataConfig:TryGetNum("car_action_stamina", "k8")
        if k8>0 then
            self.tip:SetActive(true)
            self.tip:SetText("")
            self.tip_1:SetText(math.floor(k8))
        end
    elseif self.view.ctrl.type == WorldPointUIType.SingleMapGarbage then
        self.time_obj:SetActive(false)
        self.tips_txt:SetText("")
    end
    self:SetAllCellDestroy()
    local firstList = self.data.firstRewardStr
    if firstList~=nil then
        local num =0
        for i = 1, table.length(firstList) do
            --复制基础prefab，每次循环创建一次
            num = num+1
            self.firstModel[i] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.first_content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cell = self.first_content:AddComponent(RewardItem,nameStr)
                cell:RefreshData(firstList[i])
            end)
        end
    end
    local list = self.data.rewardStr
    if list~=nil then
        local num =0
        for i = 1, table.length(list) do
            --复制基础prefab，每次循环创建一次
            num = num+1
            self.model[i] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cell = self.content:AddComponent(RewardItem,nameStr)
                cell:RefreshData(list[i])
            end)
        end
        if self.data.exp ~= nil and self.data.exp>0 then
            self.model[num+1] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local oneData = {}
                oneData.count = self.data.exp
                oneData.itemColor = DataCenter.ItemTemplateManager:GetToolBgByColor(ItemColor.GREEN)
                oneData.iconName = string.format(LoadPath.ItemPath, "item230001")
                oneData.itemFlag = ""
                oneData.rewardType = RewardType.EXP
                oneData.itemName = Localization:GetString("100083")
                oneData.itemDesc = Localization:GetString("302010",string.GetFormattedSeperatorNum(self.data.exp))
                oneData.isLocal = true
                local cell = self.content:AddComponent(RewardItem,nameStr)
                cell:RefreshData(oneData)
            end)
        end
    end
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    if self.data == nil then
        return
    end
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local deltaTime = self.data.refreshTime - curTime
    if self.data~=nil and deltaTime>0 then
        self.time_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
    else
        self.time_txt:SetText("")
    end
end

local function OnInfoClick(self)
    self.animator:Enable(true)
    self.animator:Play("switchEnter",0,0)
end
--返回
local function OnReturnClick(self)
    self.animator:Enable(true)
    self.animator:Play("switchOut",0,0)
end
WorldMonsterDes.OnCreate = OnCreate
WorldMonsterDes.OnDestroy = OnDestroy
WorldMonsterDes.OnEnable = OnEnable
WorldMonsterDes.OnDisable = OnDisable
WorldMonsterDes.ComponentDefine = ComponentDefine
WorldMonsterDes.ComponentDestroy = ComponentDestroy
WorldMonsterDes.DataDefine = DataDefine
WorldMonsterDes.DataDestroy = DataDestroy
WorldMonsterDes.AddTimer = AddTimer
WorldMonsterDes.DeleteTimer = DeleteTimer
WorldMonsterDes.RefreshTime = RefreshTime
WorldMonsterDes.RefreshData = RefreshData
WorldMonsterDes.SetAllCellDestroy = SetAllCellDestroy
WorldMonsterDes.OnReturnClick =OnReturnClick
WorldMonsterDes.OnInfoClick = OnInfoClick
return WorldMonsterDes