---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/4/21 16:15
---
local WorldActBossDes = BaseClass("WorldActBossDes", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local icon_path = "BuildInfo/Image"
local slider_path = "BuildInfo/Slider"
local rest_num_path = "BuildInfo/Slider/restNum"
local rest_des_path = "BuildInfo/restDes"
local reset_time_path = "BuildInfo/resetTime"
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:DeleteTimer()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.icon = self:AddComponent(UIImage,icon_path)
    self.slider = self:AddComponent(UISlider,slider_path)
    self.rest_des = self:AddComponent(UITextMeshProUGUIEx,rest_des_path)
    self.rest_num = self:AddComponent(UITextMeshProUGUIEx,rest_num_path)
    self.reset_time = self:AddComponent(UITextMeshProUGUIEx,reset_time_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.icon = nil
end

--变量的定义
local function DataDefine(self)
    self.param = nil
    self.isUpdate = false
    self.timer_action = function(temp)
        self:RefreshTime()
    end
end

--变量的销毁
local function DataDestroy(self)
    self.param = nil
end

local function RefreshData(self,param)
    self.data = param
    self.isUpdate = false
    --self.icon:LoadSprite(self.data.icon)
    self.reset_time:SetText("")
    self.rest_des:SetLocalText(self.data.des)
   
end
local function RefreshServerData(self,serverData)
    local maxBlood = serverData.initHealth
    local curBlood = serverData.health
    if maxBlood ==nil or maxBlood<=0 then
        maxBlood = 1
        curBlood = 1
    end
    self:SetBloodSlider(curBlood,maxBlood)
    self.data.startTime = serverData.actStart
    self.data.endTime = serverData.actEnd
    self:CheckShowTime()
end
local function CheckShowTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.finishTime = 0
    self.isUpdate = false
    if self.data.startTime>curTime then
        self.finishTime = self.data.startTime
        self.isUpdate = true
        self.dialogId = 302178
        self:AddTimer()
        self:RefreshTime()
    elseif self.data.endTime>curTime then
        self.finishTime = self.data.endTime
        self.isUpdate = true
        self.dialogId = 302177
        self:AddTimer()
        self:RefreshTime()
    else
        self:DeleteTimer()
        self.dialogId = 302190
        self.reset_time:SetText(Localization:GetString(self.dialogId))
    end
end
local function SetBloodSlider(self,curBlood,maxBlood)
    local tempValue = math.min((curBlood / math.max(maxBlood,1)),1)
    self.slider:SetValue(tempValue)
    self.rest_num:SetText(string.GetFormattedPercentStr(tempValue))
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local deltaTime = self.finishTime-curTime
    if deltaTime>0 then
        local cdTime = Localization:GetString(self.dialogId,UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
        if self.data.isPuzzleMonster ~= true then
            local times = DataCenter.ActBossDataManager:GetRestTransNum()
            local maxNum = LuaEntry.DataConfig:TryGetNum("ship_boss", "k11")
            local remainTimes = Localization:GetString("372286") .. times .. "/" .. maxNum
            self.reset_time:SetText(cdTime .. "\n" .. remainTimes)
        else
            self.reset_time:SetText(cdTime)
        end
    else
        self:CheckShowTime()
    end
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.ShowActBossBattleValue, self.RefreshBloodSlider)

end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.ShowActBossBattleValue, self.RefreshBloodSlider)
end

local function RefreshBloodSlider(self, data)
    if self.data == nil or self.data.isPuzzleMonster ~= true then
        return
    end
    local str = data
    if str~=nil then
        local strArr = string.split(str,";")
        if #strArr>3 then
            local marchUuid = tonumber(strArr[1])
            if marchUuid == self.data.uuid then
                local hp = tonumber(strArr[3])
                local hpMax = tonumber(strArr[4])
                self:SetBloodSlider(hp, hpMax)
            end
        end
    end
end

WorldActBossDes.RefreshBloodSlider = RefreshBloodSlider
WorldActBossDes.OnRemoveListener = OnRemoveListener
WorldActBossDes.OnAddListener = OnAddListener
WorldActBossDes.OnCreate = OnCreate
WorldActBossDes.OnDestroy = OnDestroy
WorldActBossDes.OnEnable = OnEnable
WorldActBossDes.OnDisable = OnDisable
WorldActBossDes.ComponentDefine = ComponentDefine
WorldActBossDes.ComponentDestroy = ComponentDestroy
WorldActBossDes.DataDefine = DataDefine
WorldActBossDes.DataDestroy = DataDestroy
WorldActBossDes.RefreshData = RefreshData
WorldActBossDes.RefreshTime =RefreshTime
WorldActBossDes.AddTimer = AddTimer
WorldActBossDes.DeleteTimer = DeleteTimer
WorldActBossDes.SetBloodSlider =SetBloodSlider
WorldActBossDes.CheckShowTime =CheckShowTime
WorldActBossDes.RefreshServerData =RefreshServerData
return WorldActBossDes