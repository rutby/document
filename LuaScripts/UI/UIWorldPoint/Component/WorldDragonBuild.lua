---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/5/25 14:29
---
local WorldDragonBuild = BaseClass("WorldDragonBuild", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local img_tab_1_path = "imgTab1"
local img_tab_2_path = "imgTab2"
local name_des_path = "imgTab1/layout1/allianceDes"
local name_path = "imgTab1/layout1/allianceName"
local alliance_btn_path = "imgTab1/layout1/btn_alliance"
local add_1_des_path = "imgTab1/layout2/speedDes"
local add_1_num_path = "imgTab1/layout2/speedNum"
local add_2_num_path = "imgTab1/layout3/forceNum"
local score_add_num_path = "imgTab1/layout5/addNum"
local score_add_des_path = "imgTab1/layout5/scoreAdd"
local layout_path = "imgTab2/layout4"
local name_special_path = "imgTab2/layout4/allianceNameSpecial"
local name_des_special_path = "imgTab2/layout4/allianceDesSpecial"
local add_2_des_path = "imgTab1/layout3/forceDes"
local add_layout_1_path = "imgTab1/layout2"
local add_layout_2_path = "imgTab1/layout3"
local image_path = "Image"
local txt_time_path = "TextTime"
local txt_des_special_path = "imgTab2/desTxtSpecial"


local TimeState = 
{
    Normal = 0,
    NotOpen = 1,
    DragonSecretCreate = 2,
    Protect = 3,
    
}
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:DeleteTimer()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.img_tab_1 = self:AddComponent(UIBaseContainer,img_tab_1_path)
    self.img_tab_2 = self:AddComponent(UIBaseContainer,img_tab_2_path)
    
    self.name_des = self:AddComponent(UITextMeshProUGUIEx,name_des_path)
    self.name_des:SetLocalText(376069)
    self.name = self:AddComponent(UITextMeshProUGUIEx,name_path)
    self.btn_alliance = self:AddComponent(UIButton,alliance_btn_path)
    self.btn_alliance:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickAlliance()
    end)
    self.add_layout_1 = self:AddComponent(UIBaseContainer,add_layout_1_path)
    self.add_layout_2 = self:AddComponent(UIBaseContainer,add_layout_2_path)
    self.add_1_des = self:AddComponent(UITextMeshProUGUIEx,add_1_des_path)
    
    self.add_1_num = self:AddComponent(UITextMeshProUGUIEx,add_1_num_path)
    self.add_2_des = self:AddComponent(UITextMeshProUGUIEx,add_2_des_path)
    self.add_2_num = self:AddComponent(UITextMeshProUGUIEx,add_2_num_path)
    self.txt_score_des = self:AddComponent(UITextMeshProUGUIEx,score_add_des_path)
    self.txt_score_des:SetLocalText(376071)
    self.txt_score = self:AddComponent(UITextMeshProUGUIEx,score_add_num_path)
    self.layout = self:AddComponent(UIBaseContainer,layout_path)
    self.name_special = self:AddComponent(UITextMeshProUGUIEx,name_special_path)
    self.name_des_special = self:AddComponent(UITextMeshProUGUIEx,name_des_special_path)
    self.txt_des_special = self:AddComponent(UITextMeshProUGUIEx,txt_des_special_path)
    self.txt_time = self:AddComponent(UITextMeshProUGUIEx,txt_time_path)
    self.img = self:AddComponent(UIImage,image_path)
    self.endTime = 0
    self.curState = TimeState.Normal
end

--控件的销毁
local function ComponentDestroy(self)
end

--变量的定义
local function DataDefine(self)
    self.timer_action = function(temp)
        self:RefreshTime()
    end
end

--变量的销毁
local function DataDestroy(self)
end

local function RefreshData(self,param)
    self.data = param
    self.curState = TimeState.Normal
    
    if self.data~=nil then
        self.img:LoadSprite(self.data.iconPath)
        if self.data.buildId == DragonBuildingTypes.DragonCenterBuild or self.data.buildId == DragonBuildingTypes.DragonAllianceFlagOther or self.data.buildId == DragonBuildingTypes.DragonAllianceFlagSelf or self.view.ctrl.type == WorldPointUIType.DragonSecretKey then
            self.img_tab_2:SetActive(true)
            self.img_tab_1:SetActive(false)
            if self.data.buildId == DragonBuildingTypes.DragonCenterBuild then
                self.layout:SetActive(true)
                self.txt_des_special:SetLocalText(376074)
                self.name_des_special:SetLocalText(376073)
                local k13 = LuaEntry.DataConfig:TryGetNum("dragon_battle_base", "k13")
                self.name_special:SetText(k13)
            elseif self.data.buildId == DragonBuildingTypes.DragonAllianceFlagSelf or self.data.buildId == DragonBuildingTypes.DragonAllianceFlagOther then
                self.layout:SetActive(false)
                self.txt_des_special:SetLocalText(376013)
                self.name_des_special:SetText("")
                self.name_special:SetText("")
            else
                self.txt_des_special:SetLocalText(376074)
                self.name_des_special:SetLocalText(376073)
                local k13 = LuaEntry.DataConfig:TryGetNum("dragon_battle_base", "k13")
                self.name_special:SetText(string.GetFormattedSeperatorNum(k13))
            end
            local curTime = UITimeManager:GetInstance():GetServerTime()
            if self.data.state >0 then
                self.curState = TimeState.Normal
                self.endTime = 0
                if self.data.state ==1 then
                    self.txt_time:SetText(Localization:GetString("376120",Localization:GetString("376122")))
                elseif self.data.state ==2 then
                    self.txt_time:SetText(Localization:GetString("376120",Localization:GetString("376123")))
                end
                
            end
            if curTime<self.data.openTime then
                self.endTime = self.data.openTime
                self.curState = TimeState.NotOpen
            elseif curTime<self.data.startTime then
                self.endTime = self.data.startTime
                self.curState = TimeState.DragonSecretCreate
            else
                self.curState = TimeState.Normal
                self.endTime = 0
            end
            self.txt_time:SetText("")
            if curTime>self.endTime then
                self:DeleteTimer()
            else
                self:AddTimer()
                self:RefreshTime()
            end
        else
            self.img_tab_2:SetActive(false)
            self.img_tab_1:SetActive(true)
            if self.data.allianceId~=nil and self.data.allianceId~="" then
                self.name:SetText(self.data.abbr)
                self.btn_alliance:SetActive(true)
            else
                self.name:SetText(Localization:GetString("100206"))
                self.btn_alliance:SetActive(false)
            end
            local scoreStr = string.GetFormattedSeperatorNum(math.floor(self.data.alliancePoint)).."/"..Localization:GetString("100165")
            self.txt_score:SetText(scoreStr)
            local item1 = self.data.effectList[1]
            local item2 = self.data.effectList[2]
            if item1~=nil then
                self.add_layout_1:SetActive(true)
                self.add_1_des:SetLocalText(item1.descID)
                local buffAddNum = ""
                local value = item1.value
                local type = item1.num_type
                if type == EffectLocalTypeInEffectDesc.Num then
                    buffAddNum = string.GetFormattedSeperatorNum(value)
                elseif type == EffectLocalTypeInEffectDesc.Percent then
                    buffAddNum = string.GetFormattedPercentStr(value/100)
                elseif type == EffectLocalTypeInEffectDesc.Thousandth then
                    buffAddNum = string.GetFormattedThousandthStr(value/1000)
                end
                self.add_1_num:SetText("+"..buffAddNum)
            else
                self.add_1_des:SetText("")
                self.add_1_num:SetText("")
                self.add_layout_1:SetActive(false)
            end

            if item2~=nil then
                self.add_layout_2:SetActive(true)
                self.add_2_des:SetLocalText(item2.descID)
                local buffAddNum = ""
                local value = item2.value
                local type = item2.num_type
                if type == EffectLocalTypeInEffectDesc.Num then
                    buffAddNum = string.GetFormattedSeperatorNum(value)
                elseif type == EffectLocalTypeInEffectDesc.Percent then
                    buffAddNum = string.GetFormattedPercentStr(value/100)
                elseif type == EffectLocalTypeInEffectDesc.Thousandth then
                    buffAddNum = string.GetFormattedThousandthStr(value/1000)
                end
                self.add_2_num:SetText("+"..buffAddNum)
            else
                self.add_2_des:SetText("")
                self.add_2_num:SetText("")
                self.add_layout_2:SetActive(false)
            end
            local curTime = UITimeManager:GetInstance():GetServerTime()
            if curTime<self.data.openTime then
                self.endTime = self.data.openTime
                self.curState = TimeState.NotOpen
            elseif curTime<self.data.protectTime then
                self.endTime = self.data.protectTime
                self.curState = TimeState.Protect
            else
                self.curState = TimeState.Normal
                self.endTime = 0
            end
            self.txt_time:SetText("")
            if curTime>self.endTime then
                self:DeleteTimer()
            else
                self:AddTimer()
                self:RefreshTime()
            end
        end
        CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.rectTransform)
    end
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    if self.endTime ==nil or self.endTime<=0 then
        return
    end
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local deltaTime = self.endTime -curTime
    if deltaTime>0 then
        if self.curState == TimeState.Protect then
            self.txt_time:SetText(Localization:GetString("110290").." : "..UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
        elseif self.curState == TimeState.NotOpen then
            self.txt_time:SetText(Localization:GetString("110129",UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime)))
        elseif self.curState == TimeState.DragonSecretCreate then
            if self.data~=nil and self.data.rewardCount>0 then
                self.txt_time:SetText(Localization:GetString("376091",UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime),Localization:GetString("376123")))
            else
                self.txt_time:SetText(Localization:GetString("376091",UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime),Localization:GetString("376122")))
            end
            
        end
    else
        self.endTime = 0
        self.txt_time:SetText("")
    end
end

local function SetData(self,pointId)
end

local function OnClickAlliance(self)
    if self.data~=nil and self.data.allianceId~=nil and self.data.allianceId~="" then
        local allianceId = self.data.allianceId
        if allianceId~= LuaEntry.Player.allianceId then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceDetail,{ anim = true, isBlur = true},"", allianceId)
        else
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceMainTable,{ anim = true})
        end
    end
end


WorldDragonBuild.OnCreate = OnCreate
WorldDragonBuild.OnDestroy = OnDestroy
WorldDragonBuild.OnEnable = OnEnable
WorldDragonBuild.OnDisable = OnDisable
WorldDragonBuild.ComponentDefine = ComponentDefine
WorldDragonBuild.ComponentDestroy = ComponentDestroy
WorldDragonBuild.DataDefine = DataDefine
WorldDragonBuild.DataDestroy = DataDestroy
WorldDragonBuild.AddTimer = AddTimer
WorldDragonBuild.DeleteTimer = DeleteTimer
WorldDragonBuild.RefreshTime = RefreshTime
WorldDragonBuild.RefreshData = RefreshData
WorldDragonBuild.SetData = SetData
WorldDragonBuild.OnClickAlliance = OnClickAlliance
return WorldDragonBuild