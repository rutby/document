---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2022/4/1 20:44
---

local WorldPlunderDes = BaseClass("WorldPlunderDes", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local desc_path = "Desc"
local info_path = "Info"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.desc_text = self:AddComponent(UITextMeshProUGUIEx, desc_path)
    self.info_btn = self:AddComponent(UIButton, info_path)
    self.info_btn:SetOnClick(function()
        self:OnInfoClick()
    end)
end

local function ComponentDestroy(self)
    self.desc_text = nil
    self.info_btn = nil
end

local function DataDefine(self)
    self.zone = BuildZoneType.No
    self.infoTips = {}
end

local function DataDestroy(self)
    self.zone = nil
    self.infoTips = nil
end

local function RefreshData(self, data)
    self:SetActive(false)
    
    if CS.SceneManager:IsInCity() then
        return
    end
    
    local buildId = DataCenter.BuildManager:GetBuildIdByPointId(data.playerData.pointId)
    if buildId == nil or buildId == BuildingTypes.FUN_BUILD_MAIN or buildId == BuildingTypes.APS_BUILD_WORMHOLE_SUB or buildId == BuildingTypes.WORM_HOLE_CROSS or BuildingUtils.IsInEdenSubwayGroup(buildId)==true or WorldSeasonBuild[buildId] then
        return
    end
    
    local buildTemplate = DataCenter.BuildTemplateManager:GetBuildingDesTemplate(buildId)
    if buildTemplate == nil then
        return
    end
    
    local zone = buildTemplate.zoneType

    self.infoTips = {}
    
    local canPlunder = false
    if data.playerData.plunderResRate and data.playerData.plunderResRate > 0 then
        if LuaEntry.Effect:GetGameEffect(EffectDefine.PLUNDER_REST_COUNT) > 0 and zone ~= BuildZoneType.No or
           buildId == BuildingTypes.FUN_BUILD_STONE or buildId == BuildingTypes.FUN_BUILD_WATER
        then
            canPlunder = true
        end
    end
    self.desc_text:SetLocalText(canPlunder and 300134 or 300135) -- 可掠夺 / 不可掠夺

    if buildId == BuildingTypes.FUN_BUILD_STONE or buildId == BuildingTypes.FUN_BUILD_WATER then
        table.insert(self.infoTips, Localization:GetString("300136", data.playerData.plunderResRate)) -- 资源建筑（放在最前）
    end
    
    if zone == BuildZoneType.Trade then
        table.insert(self.infoTips, Localization:GetString("300137")) -- 农业区
    elseif zone == BuildZoneType.Military then
        table.insert(self.infoTips, Localization:GetString("300138")) -- 商业区
    elseif zone == BuildZoneType.Hero then
        table.insert(self.infoTips, Localization:GetString("300139")) -- 军事区
    end

    if buildId ~= BuildingTypes.FUN_BUILD_STONE and buildId ~= BuildingTypes.FUN_BUILD_WATER then
        table.insert(self.infoTips, Localization:GetString("300140")) -- 非资源建筑（放在最后）
    end
    
    self:SetActive(true)
end

local function OnInfoClick(self)
    local param = {}
    param.type = "desc"
    param.title = ""
    param.desc = string.join(self.infoTips, "\n") 
    param.alignObject = self.info_btn
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemTips, {anim = true}, param)
end

WorldPlunderDes.GetName = GetName
WorldPlunderDes.OnCreate = OnCreate
WorldPlunderDes.OnDestroy = OnDestroy
WorldPlunderDes.OnEnable = OnEnable
WorldPlunderDes.OnDisable = OnDisable
WorldPlunderDes.ComponentDefine = ComponentDefine
WorldPlunderDes.ComponentDestroy = ComponentDestroy
WorldPlunderDes.DataDefine = DataDefine
WorldPlunderDes.DataDestroy = DataDestroy

WorldPlunderDes.RefreshData = RefreshData
WorldPlunderDes.OnInfoClick = OnInfoClick

return WorldPlunderDes