---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/9/27 20:45
---
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local WorldCollectDes = BaseClass("WorldCollectDes", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local icon_path = "bg/Image"
local des_txt_path = "bg/desTxt"
local special_obj_path = "bg/specialObj"
local slider_path = "bg/specialObj/Slider"
local rest_num_path = "bg/specialObj/Slider/restNum"
local rest_des_path = "bg/specialObj/restDes"
local power_txt_path = "bg/specialObj/TextPower"
local layout2_path = "bg/layout2"
local res_num_path = "bg/layout2/resNum"
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:DeleteTimer()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.icon = self:AddComponent(UIImage,icon_path)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx,des_txt_path)
    self.special_obj = self:AddComponent(UIBaseContainer,special_obj_path)
    self.slider = self:AddComponent(UISlider,slider_path)
    self.rest_des = self:AddComponent(UITextMeshProUGUIEx,rest_des_path)
    self.rest_num = self:AddComponent(UITextMeshProUGUIEx,rest_num_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx,power_txt_path)
    self.layout2 = self:AddComponent(UIBaseContainer,layout2_path)
    self.speed_txt = self:AddComponent(UITextMeshProUGUIEx,res_num_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.icon = nil
    self.des_txt = nil
end

--变量的定义
local function DataDefine(self)
    self.param = nil
    self.isUpdate = false
    self.collectStartTime = 0
    self.timer_action = function(temp)
        self:RefreshTime()
    end
end

--变量的销毁
local function DataDestroy(self)
    self.param = nil
end

local function RefreshData(self,param)
    self.data = param
    self.isUpdate = false
    self.icon:LoadSprite(self.data.icon)
    self.layout2:SetActive(false)
    if self.view.ctrl.type == WorldPointUIType.CollectPoint then
        self.des_txt:SetText("")
        self.special_obj:SetActive(true)
        self.rest_num:SetText("")
        self.slider:SetValue(0)
        self.rest_des:SetText(Localization:GetString("104291","<color=#482e28>"..Localization:GetString("100206")))
        if self.data.isDesert == true and LuaEntry.Player.serverType ~= ServerType.DRAGON_BATTLE_FIGHT_SERVER then
            self.power_txt:SetText(Localization:GetString("300644",string.GetFormattedSeperatorNum(self.data.recommend_power)))
        elseif LuaEntry.Player.serverType == ServerType.DRAGON_BATTLE_FIGHT_SERVER then
            self.power_txt:SetText(Localization:GetString("376072"))
            self.layout2:SetActive(true)
            local speed = toInt(toInt(self.data.speed)/60)
            self.speed_txt:SetText(speed.."/min")
        else
            self.power_txt:SetText("")
        end
    elseif self.view.ctrl.type == WorldPointUIType.CityResPoint then
        self.des_txt:SetLocalText(self.data.desc)
        self.special_obj:SetActive(false)
        self.power_txt:SetText("")
    end
end


local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    if self.isUpdate == true then
        if self.serverData ~=nil then
            local curTime = UITimeManager:GetInstance():GetServerTime()
            local deltaTime = curTime-self.collectStartTime
            if deltaTime<0 then
                deltaTime = 0
            end
            local realNum = deltaTime*self.serverData.speed/1000
            if realNum<0 then
                realNum = 0
            end
            local restNum = self.serverData.remainRes-realNum
            if restNum>0 then
                local tempValue = math.min((restNum / math.max(self.serverData.initRes,1)),1)
                self.slider:SetValue(tempValue)
                self.rest_num:SetText(string.GetFormattedSeperatorNum(math.floor(restNum)).."/"..string.GetFormattedSeperatorNum(math.floor(self.serverData.initRes)))
                if self.serverData.speed<=0 then
                    self.collectStartTime = 0
                    self.isUpdate = false
                end
            else
                self.collectStartTime = 0
                self.isUpdate = false
                self.rest_num:SetText("0/"..string.GetFormattedSeperatorNum(math.floor(self.serverData.initRes)))
                self.slider:SetValue(0)
            end
        end
    end
end

local function UpdateInfo(self,data)
    self.isUpdate = false
    self.serverData = data.playerData
    if self.serverData~=nil and self.view.ctrl.type == WorldPointUIType.CollectPoint then
        if self.serverData.remainRes>0 then
            self.collectStartTime = UITimeManager:GetInstance():GetServerTime()
            self.isUpdate = true
            self:AddTimer()
            self:RefreshTime()
        else
            self.rest_num:SetText("0/"..string.GetFormattedSeperatorNum(math.floor(self.serverData.initRes)))
            self.slider:SetValue(0)
        end
    else
        self.rest_num:SetText("")
        self.slider:SetValue(0)
    end
end
WorldCollectDes.OnCreate = OnCreate
WorldCollectDes.OnDestroy = OnDestroy
WorldCollectDes.OnEnable = OnEnable
WorldCollectDes.OnDisable = OnDisable
WorldCollectDes.ComponentDefine = ComponentDefine
WorldCollectDes.ComponentDestroy = ComponentDestroy
WorldCollectDes.DataDefine = DataDefine
WorldCollectDes.DataDestroy = DataDestroy
WorldCollectDes.RefreshData = RefreshData
WorldCollectDes.UpdateInfo =UpdateInfo
WorldCollectDes.RefreshTime =RefreshTime
WorldCollectDes.AddTimer = AddTimer
WorldCollectDes.DeleteTimer = DeleteTimer
return WorldCollectDes