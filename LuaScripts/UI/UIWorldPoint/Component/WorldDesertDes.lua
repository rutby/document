---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/11/8 15:07
---
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local RewardItem = require "UI.UIWorldPoint.Component.WorldPointRewardItem"
local WorldDesertDes = BaseClass("WorldDesertDes", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local icon_path = "img/Image"
local power_txt_path = "TextPower"
local player_des_path = "img/layout1/playerDes"
local player_name_path = "img/layout1/playerName"
local player_info_path = "img/layout1/btn_desertPlay"
--local res_des_path = "img/layout2/resDes"
local res_name_path = "img/layout2/resNum"
local power_des_path = "img/layout3/powerDes"
local power_name_path = "img/layout3/powerNum"
local force_des_path = "img/layout4/forceDes"
local force_name_path = "img/layout4/forceNum"
local layout_5_path = "img/layout5"
local score_des_path = "img/layout5/scoreDes"
local score_name_path = "img/layout5/scoreNum"
local layout_6_path = "img/layout6"
local level_des_path = "img/layout6/levelDes"
local level_name_path = "img/layout6/levelNum"
local hurt_name_path = "layout/warnObj/hurtNum"
local battle_state_btn_path = "layout/warnObj/battle_state_btn"
local battle_state_img_path = "layout/warnObj/battle_state_btn/battle_img"
local scroll_path = "ScrollView"
local content_path = "ScrollView/Viewport/Content"
local this_obj_path = ""
local tip_path = "layout/staminaObj"
local warn_path = "layout/warnObj"
local time_path = "layout/timeObj"
local time_txt_path = "layout/timeObj/time_txt"
local tip_1_path = "layout/staminaObj/simple_tip/ele_icon/simple_tip_1"
local command_path = "Command"
local command_icon_path = "Command/CommandIcon"

local ruin_path = "layout/ruinObj"
local ruin_text_path = "layout/ruinObj/ruinText"
local ruin_text1_path = "layout/ruinObj/ruinText1"

local CommandType =
{
    None = 0,
    GiveUp = 1,
    CancelGiveUp = 2,
    Protect = 3,
}

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetAllCellDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:DeleteTimer()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.icon = self:AddComponent(UIImage,icon_path)
    self.player_name = self:AddComponent(UITextMeshProUGUIEx,player_name_path)
    self.player_des = self:AddComponent(UITextMeshProUGUIEx,player_des_path)
    self.player_info = self:AddComponent(UIButton,player_info_path)
    self.player_info:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickPlayerInfo()
    end)
    --self.res_des = self:AddComponent(UITextMeshProUGUIEx,res_des_path)
    self.res_name = self:AddComponent(UITextMeshProUGUIEx,res_name_path)
    self.hurt_name = self:AddComponent(UITextMeshProUGUIEx,hurt_name_path)
    self.power_des = self:AddComponent(UITextMeshProUGUIEx,power_des_path)
    self.power_txt = self:AddComponent(UITextMeshProUGUIEx,power_name_path)
    self.force_des = self:AddComponent(UITextMeshProUGUIEx,force_des_path)
    self.force_txt = self:AddComponent(UITextMeshProUGUIEx,force_name_path)
    self.layout5 = self:AddComponent(UITextMeshProUGUIEx,layout_5_path)
    self.score_des = self:AddComponent(UITextMeshProUGUIEx,score_des_path)
    self.score_name = self:AddComponent(UITextMeshProUGUIEx,score_name_path)
    self.layout6 = self:AddComponent(UITextMeshProUGUIEx,layout_6_path)
    self.level_des = self:AddComponent(UITextMeshProUGUIEx,level_des_path)
    self.level_name = self:AddComponent(UITextMeshProUGUIEx,level_name_path)
    self.warn = self:AddComponent(UIBaseContainer, warn_path)
    self.time_obj = self:AddComponent(UIBaseContainer, time_path)
    self.time_txt = self:AddComponent(UITextMeshProUGUIEx, time_txt_path)
    self.battle_state_btn = self:AddComponent(UIButton, battle_state_btn_path)
    self.battle_state_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBattleStateClick()
    end)

    self.battle_state_img = self:AddComponent(UIImage, battle_state_img_path)
    self.scroll = self:AddComponent(UIBaseContainer,scroll_path)
    self.content = self:AddComponent(UIBaseContainer,content_path)
    self.tip = self:AddComponent(UIBaseContainer, tip_path)
    self.tip_1 = self:AddComponent(UITextMeshProUGUIEx, tip_1_path)
    self.this_obj = self:AddComponent(UIBaseContainer,this_obj_path)
    self.command_btn = self:AddComponent(UIButton, command_path)
    self.command_btn:SetOnClick(function()
        self:OnCommandClick()
    end)
    self.command_image = self:AddComponent(UIImage, command_icon_path)
    self.ruin = self:AddComponent(UIBaseContainer, ruin_path)
    self.ruin_text = self:AddComponent(UITextMeshProUGUIEx, ruin_text_path)
    self.ruin_text1 = self:AddComponent(UITextMeshProUGUIEx, ruin_text1_path)
    self.ruin_text1:SetLocalText(309011)
end

--控件的销毁
local function ComponentDestroy(self)
    self.icon = nil
    self.player_name = nil
    self.player_des = nil
    --self.res_des = nil
    self.res_name = nil
    self.hurt_name = nil
    self.power_txt = nil
end

--变量的定义
local function DataDefine(self)
    self.param = nil
    self.timer_action = function(temp)
        self:RefreshTime()
    end
    self.endTime = 0
    self.isUpdate = false
end

--变量的销毁
local function DataDestroy(self)
    self.param = nil
end

local function RefreshData(self,param)
    self.isUpdate = false
    self.data = param
    self.player_des:SetText(Localization:GetString("110236"))
    self.player_name:SetText("")
    self.player_info:SetActive(false)
    self.icon:LoadSprite(self.data.pic)
    --self.res_des:SetText(Localization:GetString("110238"))
    local resStr = string.GetFormattedSeperatorNum(self.data.resSpeed).."/h"
    self.res_name:SetText(resStr)
    self.power_des:SetText(Localization:GetString("110334"))
    self.power_txt:SetText(string.GetFormattedSeperatorNum(self.data.recommend_power))
    self.force_des:SetText(Localization:GetString("110453"))
    self.force_txt:SetText(string.GetFormattedSeperatorNum(self.data.force))
    local height = 0
    if self.data.season_mastery~=nil  then
        self.layout5:SetActive(true)
        self.score_des:SetText(Localization:GetString("111031"))
        self.score_name:SetText(string.GetFormattedSeperatorNum(self.data.season_mastery))
        height=height+22
    else
        self.layout5:SetActive(false)
    end
    if self.data.targetLevel~=nil and self.data.targetLevel>0 then
        self.layout6:SetActive(true)
        self.level_des:SetLocalText("111228")
        self.level_name:SetText("Lv."..self.data.targetLevel)
        height=height+22
    else
        self.layout6:SetActive(false)
    end
    local warn = self:CheckBattleState()
    local stamina = false
    local timeObj = false
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.commandType = CommandType.None
    if self.view.ctrl.ownerUid == LuaEntry.Player.uid then
        if self.data.giveUpEndTime > curTime then
            -- 正在放弃
            self.commandType = CommandType.CancelGiveUp
            self.isUpdate = true
            self.endTime = self.data.giveUpEndTime
            self.time_obj:SetActive(true)
            timeObj = true
            self:AddTimer()
            self:RefreshTime()
        elseif self.data.protectEndTime > curTime then
            -- 保护期
            self.commandType = CommandType.Protect
            self.isUpdate = true
            self.endTime = self.data.protectEndTime
            self.time_obj:SetActive(true)
            timeObj = true
            self:AddTimer()
            self:RefreshTime()
        else
            -- 正常
            self.time_obj:SetActive(false)
            self.commandType = CommandType.GiveUp
        end
    else
        self.time_obj:SetActive(false)
    end
    self:RefreshCommandBtn()
    local isEmptyDesert = false
    if self.data.level~=nil and self.data.level<=0 then
        isEmptyDesert = true
    end
    if self.view.ctrl.ownerUid == LuaEntry.Player.uid then
        stamina = true
        self.tip:SetActive(true)
        local attackCost = MarchUtil.GetCostStaminaByTargetType(MarchTargetType.TRAIN_DESERT,nil,nil,nil,isEmptyDesert)
        self.tip_1:SetText(math.floor(attackCost))
    elseif self.view.ctrl.ownerUid ~= LuaEntry.Player.uid and self.view.ctrl.isAlliance == false then
        stamina = true
        self.tip:SetActive(true)
        local attackCost = MarchUtil.GetCostStaminaByTargetType(MarchTargetType.ATTACK_DESERT,nil,nil,nil,isEmptyDesert)
        self.tip_1:SetText(math.floor(attackCost))
    else
        self.tip:SetActive(false)
    end
    if self.data.isRuin == true then
        self.isUpdate = true
        self.endTime = self.data.endTime
        self:AddTimer()
        self:RefreshTime()
    end

    self:SetAllCellDestroy()
    local list = self.data.rewardStr
    local num =0
    if list and next(list) then
        self.scroll:SetActive(true)
        local size = 200
        if stamina ==true then
            size = size+50
        end
        if warn ==true then
            size = size+50
        end
        if timeObj == true then
            size = size+50
        end
        if self.data.isRuin == true then
            size = size + 80
        end

        size = size+height
        self.this_obj:SetSizeDelta(Vector2(self.this_obj:GetSizeDelta().x,size))
        if self.data.exp ~= nil and self.data.exp>0 then
            self.model[num+1] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local oneData = {}
                oneData.count = self.data.exp
                oneData.itemColor = DataCenter.ItemTemplateManager:GetToolBgByColor(ItemColor.GREEN)
                oneData.iconName = string.format(LoadPath.ItemPath, "item230001")
                oneData.itemFlag = ""
                oneData.rewardType = RewardType.EXP
                oneData.itemName = Localization:GetString("100083")
                oneData.itemDesc = Localization:GetString("302010",string.GetFormattedSeperatorNum(self.data.exp))
                oneData.isLocal = true
                local cell = self.content:AddComponent(RewardItem,nameStr)
                cell:RefreshData(oneData)
            end)
        end
        for i = 1, table.length(list) do
            --复制基础prefab，每次循环创建一次
            num = num+1
            self.model[i] = self:GameObjectInstantiateAsync(UIAssets.WorldPointRewardItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cell = self.content:AddComponent(RewardItem,nameStr)
                cell:RefreshData(list[i])
            end)
        end
    else
        local size = 100
        if stamina ==true then
            size = size+50
        end
        if warn ==true then
            size = size+50
        end
        if self.data.isRuin == true then
            size = size + 80
        end
        size = size+height
        self.this_obj:SetSizeDelta(Vector2(self.this_obj:GetSizeDelta().x,size))
        self.scroll:SetActive(false)
    end
end

local function UpdateInfo(self,data)
    self.serverData = data.playerData
    if self.serverData~=nil and self.serverData.desertInfo~=nil and self.serverData.desertInfo.ownerUid~=nil and self.serverData.desertInfo.ownerUid~="" then
        local name = self.serverData.name
        if self.serverData.alAbbr~=nil and self.serverData.alAbbr~="" then
            name = "["..self.serverData.alAbbr.."]"..self.serverData.name
        end
        if self.serverData.srcServer~=nil and self.serverData.srcServer~=LuaEntry.Player:GetSelfServerId() then
            name = "#"..self.serverData.srcServer.." "..name
        end
        self.player_name:SetText(name)
        self.player_info:SetActive(true)
    else
        self.player_name:SetText(Localization:GetString("100206"))
    end
    
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end

    self.timer:Start()
end

local function RefreshTime(self)
    if self.isUpdate == true then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local deltaTime = self.endTime - curTime
        if self.data.isRuin == true then
            if deltaTime>0 then
                self.ruin_text:SetLocalText(309012, UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
            else
                self.ruin_text:SetText("")
            end
        else
            
            if deltaTime>0 then
                if self.commandType == CommandType.Protect then
                    self.time_txt:SetText(Localization:GetString("111187")..UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
                elseif self.commandType == CommandType.CancelGiveUp then
                    self.time_txt:SetText(Localization:GetString("111188")..UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
                else
                    self.time_txt:SetText(Localization:GetString("100238")..UITimeManager:GetInstance():MilliSecondToFmtString(deltaTime))
                end
                
            end
        end
    end
end

local function CheckBattleState(self)
    local showWarn = false
    self.ruin:SetActive(self.data.isRuin == true)
    if self.view.ctrl.ownerUid ~= LuaEntry.Player.uid and self.view.ctrl.isAlliance ==true then
        self.warn:SetActive(false)
        --self.battle_state_img:SetActive(false)
        --self.hurt_name:SetText("")
    else
        if self.data.selfPercent >=0 then
            --self.battle_state_img:SetActive(false)
            --self.hurt_name:SetText("")
            self.warn:SetActive(false)
            --self.battleStateTitle = Localization:GetString("110331")
            --self.battleStateStr = ""
            --local str = string.GetFormattedSeperatorNum(math.floor(self.data.selfValue)).."/"..string.GetFormattedSeperatorNum(math.floor(self.data.resistance))
            --self.battle_state_img:LoadSprite("Assets/Main/Sprites/UI/UITroopsNew/UITroops_btn_combat01.png")
            --self.hurt_name:SetText(Localization:GetString("110333",str,"-"..string.GetFormattedPercentStr(self.data.selfPercent)))
        else
            showWarn = true
            self.warn:SetActive(true)
            self.battleStateTitle = Localization:GetString("110330")
            self.battleStateStr = Localization:GetString("110332",string.GetFormattedPercentStr(-self.data.selfPercent),string.GetFormattedPercentStr(self.data.otherPercent))
            local str = string.GetFormattedSeperatorNum(math.floor(self.data.selfValue)).."/"..string.GetFormattedSeperatorNum(math.floor(self.data.resistance))
            self.battle_state_img:LoadSprite(string.format(LoadPath.CommonNewPath, "UITroops_btn_combat03"))
            self.hurt_name:SetText(Localization:GetString("110333",str,string.GetFormattedPercentStr(self.data.selfPercent)))
            DataCenter.GuideManager:CheckDoTriggerGuide(GuideTriggerType.ClickOutValueDesertTile, SaveGuideDoneValue)
        end
    end
    return showWarn
end

local function OnBattleStateClick(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.battle_state_btn.gameObject.transform.position + Vector3.New(20, 0, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    if self.data.selfPercent >=0 then
        param.content = self.battleStateTitle
    else
        param.title = self.battleStateTitle
        if self.battleStateStr~=nil and self.battleStateStr~="" then
            param.content = self.battleStateStr
        end
    end
    
    param.dir = UIHeroTipView.Direction.LEFT
    param.defWidth = 340
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

local function RefreshCommandBtn(self)
    if self.commandType == CommandType.None then
        self.command_btn:SetActive(false)
    elseif self.commandType == CommandType.GiveUp or self.commandType == CommandType.Protect then
        self.command_btn:SetActive(true)
        self.command_image:LoadSprite(string.format(LoadPath.UIBuildBtns, "uibuild_btn_chaichu"))
    elseif self.commandType == CommandType.CancelGiveUp then
        self.command_btn:SetActive(true)
        self.command_image:LoadSprite(string.format(LoadPath.UIBuildBtns, "uibuild_btn_canceldismantle"))
    end
end

local function OnCommandClick(self)
    local uuid = self.view.ctrl.uuid
    if uuid==nil or uuid == 0 then
        return
    end
    if self.commandType == CommandType.GiveUp or self.commandType == CommandType.Protect then
        DataCenter.DesertDataManager:GiveUp(uuid, function()
            self.view.ctrl:CloseSelf()
        end)
    elseif self.commandType == CommandType.CancelGiveUp then
        DataCenter.DesertDataManager:CancelGiveUp(uuid, function()
            self.view.ctrl:CloseSelf()
        end)
    end
end

local function SetAllCellDestroy(self)
    self.content:RemoveComponents(RewardItem)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end

local function OnClickPlayerInfo(self)
    if self.serverData~=nil and self.serverData.desertInfo~=nil and self.serverData.desertInfo.ownerUid~=nil and self.serverData.desertInfo.ownerUid~="" then
        local uid = self.serverData.desertInfo.ownerUid
        if uid == LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIPlayerInfo, {anim = true, hideTop = true}, uid)
        else
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo,uid)
        end
    end
end

local function OnInfoClick(self)
    local score = 0
    if self.data.score>=1 then
        score = self.data.score
    end
    local des = Localization:GetString("110527")..": "..Localization:GetString("110561",score)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.view.btn_detail.gameObject.transform.position + Vector3.New(0, -33, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    param.content = des
    param.dir = UIHeroTipView.Direction.BELOW
    param.defWidth = 200
    param.pivot = 0.5
    param.position = position
    param.deltaX = 0
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

WorldDesertDes.OnCreate = OnCreate
WorldDesertDes.OnDestroy = OnDestroy
WorldDesertDes.OnEnable = OnEnable
WorldDesertDes.OnDisable = OnDisable
WorldDesertDes.ComponentDefine = ComponentDefine
WorldDesertDes.ComponentDestroy = ComponentDestroy
WorldDesertDes.DataDefine = DataDefine
WorldDesertDes.DataDestroy = DataDestroy
WorldDesertDes.RefreshData = RefreshData
WorldDesertDes.UpdateInfo =UpdateInfo
WorldDesertDes.RefreshTime = RefreshTime
WorldDesertDes.AddTimer =AddTimer
WorldDesertDes.DeleteTimer =DeleteTimer
WorldDesertDes.CheckBattleState = CheckBattleState
WorldDesertDes.OnBattleStateClick =OnBattleStateClick
WorldDesertDes.RefreshCommandBtn = RefreshCommandBtn
WorldDesertDes.OnCommandClick =OnCommandClick
WorldDesertDes.SetAllCellDestroy = SetAllCellDestroy
WorldDesertDes.OnClickPlayerInfo = OnClickPlayerInfo
WorldDesertDes.OnInfoClick = OnInfoClick
return WorldDesertDes