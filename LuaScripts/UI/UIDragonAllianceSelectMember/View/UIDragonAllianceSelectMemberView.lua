---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/6/8 10:12
---
local DragonMemberSelectCell = require "UI.UIDragonAllianceSelectMember.Component.DragonMemberSelectCell"
local MemberTipItem = require "UI.UIDragonAllianceSelectMember.Component.MemberTipItem"
local UIDragonAllianceSelectMemberView = BaseClass("UIDragonAllianceSelectMemberView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization

local txt_title_path ="UICommonPopUpTitle/bg_mid/titleText"
local close_btn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonPopUpTitle/panel"
local scroll_path = "ScrollView"
local match_score_path = "MatchScore"
local des_1_path = "des1Obj/des1"
local des_2_path = "des2Obj/des2"
local match_des_path = "HeroStateBg/MatchDes"
local match_icon_path = "HeroStateBg/matchIcon"
local match_btn_path = "HeroStateBg/changeBtn"
local add_btn_path = "leftBtn"
local cancel_btn_path = "rightBtn"
local function OnCreate(self)
    base.OnCreate(self)
    self.canSignUp = self:GetUserData()
    DataCenter.ActDragonManager:SendGetPlayerList()
    --SFSNetwork.SendMessage(MsgDefines.SeasonBalanceGiveRecord)
    self.txt_title = self:AddComponent(UITextMeshProUGUIEx, txt_title_path)
    self.txt_title:SetText(Localization:GetString("376065"))
    self.match_score = self:AddComponent(UIText, match_score_path)
    self.des_1 = self:AddComponent(UIText, des_1_path)
    self.des_2 = self:AddComponent(UIText, des_2_path)
    self.match_des = self:AddComponent(UIText, match_des_path)
    self.match_des:SetText(Localization:GetString("376060"))
    self.match_icon = self:AddComponent(UIImage,match_icon_path)
    self.match_btn = self:AddComponent(UIButton, match_btn_path)
    self.match_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:ChangeSelectType()
    end)
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)
    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.return_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)
    self.ScrollView = self:AddComponent(UIScrollView, scroll_path)
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    self.auto_btn = self:AddComponent(UIButton,add_btn_path)
    self.auto_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnOneKeyAdd()
    end)
    self.auto_txt = self:AddComponent(UIText,"leftBtn/leftTxt")
    self.auto_txt:SetText(Localization:GetString("376062"))
    self.cancel_btn = self:AddComponent(UIButton,cancel_btn_path)
    self.cancel_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnOneKeyCancel()
    end)
    self.cancel_txt = self:AddComponent(UIText,"rightBtn/rightTxt")
    self.cancel_txt:SetText(Localization:GetString("376063"))
    self._des_txt = self:AddComponent(UIText,"desTxt")
    self._des_txt:SetText(Localization:GetString("376061"))
    self.tips = self:AddComponent(MemberTipItem,"selectTip")
    self.tips:SetActive(false)
    self.showDatalist ={}
    self.selectType = false
end

local function OnDestroy(self)
    self:ClearScroll()
    base.OnDestroy(self)
end


local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GetDagonPlayerList, self.RefreshList)

end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.GetDagonPlayerList, self.RefreshList)
end

local function RefreshList(self)
    if self.selectType == false then
        self.match_icon:LoadSprite("Assets/Main/Sprites/UI/UIAccount/Common_btn_dropdown02.png")
    else
        self.match_icon:LoadSprite("Assets/Main/Sprites/UI/UIAccount/Common_btn_upup.png")
    end
    self:UpdateNum()
    self:ClearScroll()
    self.showDatalist = self.ctrl:GetAllMemberList(self.selectType)
    if #self.showDatalist > 0 then
        self.ScrollView:SetTotalCount(#self.showDatalist)
        self.ScrollView:RefillCells()
    end
end

local function UpdateNum(self)
    local totalPower = DataCenter.ActDragonManager:GetTotalPowerBySelect()
    self.match_score:SetText(Localization:GetString("280127").." "..string.GetFormattedSeperatorNum(math.floor(totalPower)))
    local maxNumMain = LuaEntry.DataConfig:TryGetNum("dragon_battle_base", "k4")
    local curNumMain = DataCenter.ActDragonManager:GetCurNumByState(DragonPlayerState.Main)
    local maxNumSub = LuaEntry.DataConfig:TryGetNum("dragon_battle_base", "k5")
    local curNumSub = DataCenter.ActDragonManager:GetCurNumByState(DragonPlayerState.Sub)
    local mainStr = Localization:GetString("376056", curNumMain.."/"..maxNumMain)
    local subStr = Localization:GetString("376057", curNumSub.."/"..maxNumSub)
    self.des_1:SetText(mainStr)
    self.des_2:SetText(subStr)
end

local function ChangeSelectType(self)
    self.selectType = (self.selectType ==false)
    self:RefreshList()
end
local function ClearScroll(self)
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(DragonMemberSelectCell)
    self.showDatalist = {}
end

local function OnItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(DragonMemberSelectCell, itemObj)
    cellItem:SetItemShow(self.showDatalist[index])
end

local function OnItemMoveOut(self, itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, DragonMemberSelectCell)
end

local function HideTip(self)
    self.tips:SetActive(false)
end

local function ShowTip(self,pos,uid,item)
    self.tips:SetActive(true)
    self.tips:SetData(pos,uid,item)
end

local function SetPlayerState(self,uid,state)
    if state == DragonPlayerState.None then
        DataCenter.ActDragonManager:CancelPlayer(uid)
    else
        DataCenter.ActDragonManager:SelectPlayer(uid,state)
    end
    self:UpdateNum()
end
local function OnOneKeyAdd(self)
    if self.canSignUp ==false then
        UIUtil.ShowTipsId(376124)
        return
    end
    if DataCenter.AllianceBaseDataManager:IsR4orR5()==false then
        UIUtil.ShowTipsId(376061)
        return
    end
    SFSNetwork.SendMessage(MsgDefines.DragonAutoAssignPlayer)
end

local function OnOneKeyCancel(self)
    if self.canSignUp ==false then
        UIUtil.ShowTipsId(376124)
        return
    end
    if DataCenter.AllianceBaseDataManager:IsR4orR5()==false then
        UIUtil.ShowTipsId(376061)
        return
    end
    SFSNetwork.SendMessage(MsgDefines.DragonRevokeAllPlayer)
end


UIDragonAllianceSelectMemberView.OnCreate= OnCreate
UIDragonAllianceSelectMemberView.OnDestroy = OnDestroy
UIDragonAllianceSelectMemberView.OnEnable = OnEnable
UIDragonAllianceSelectMemberView.OnDisable = OnDisable
UIDragonAllianceSelectMemberView.OnAddListener = OnAddListener
UIDragonAllianceSelectMemberView.OnRemoveListener = OnRemoveListener
UIDragonAllianceSelectMemberView.RefreshList = RefreshList
UIDragonAllianceSelectMemberView.ClearScroll = ClearScroll
UIDragonAllianceSelectMemberView.OnItemMoveIn = OnItemMoveIn
UIDragonAllianceSelectMemberView.OnItemMoveOut = OnItemMoveOut
UIDragonAllianceSelectMemberView.ChangeSelectType = ChangeSelectType
UIDragonAllianceSelectMemberView.HideTip =HideTip
UIDragonAllianceSelectMemberView.ShowTip = ShowTip
UIDragonAllianceSelectMemberView.SetPlayerState = SetPlayerState
UIDragonAllianceSelectMemberView.OnOneKeyAdd =OnOneKeyAdd
UIDragonAllianceSelectMemberView.OnOneKeyCancel = OnOneKeyCancel
UIDragonAllianceSelectMemberView.UpdateNum = UpdateNum
return UIDragonAllianceSelectMemberView