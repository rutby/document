---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/6/7 18:43
---
local ArenaRankItem = BaseClass("ArenaRankItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local bg_path = "rankInfo"
local bgBtn_path = "rankInfo/bgBtn"
local rankNum_path = "rankInfo/rank"
local rankImg_path = "rankInfo/rankImg"
local playerHead_path = "rankInfo/playerFlag/UIPlayerHead/HeadIcon"
local playerHeadFg_path = "rankInfo/playerFlag/UIPlayerHead/Foreground"
local playerHeadBtn_path = "rankInfo/playerFlag/UIPlayerHead"
local name_path = "rankInfo/playerName"
local power_path = "rankInfo/power"
local score_path = "rankInfo/starObj/starNum"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.bgN = self:AddComponent(UIImage, bg_path)
    self.bgBtn = self:AddComponent(UIButton, bgBtn_path)
    self.bgBtn:SetOnClick(function()
        self:OnClickBg()
    end)
    self.rankNumN = self:AddComponent(UITextMeshProUGUIEx, rankNum_path)
    self.rankImgN = self:AddComponent(UIImage, rankImg_path)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.playerHeadBtnN = self:AddComponent(UIButton, playerHeadBtn_path)
    self.playerHeadBtnN:SetOnClick(function()
        self:OnClickPlayerHeadBtn()
    end)
    self.nameN = self:AddComponent(UITextMeshProUGUIEx, name_path)
    self.powerN = self:AddComponent(UITextMeshProUGUIEx, power_path)
    self.scoreN = self:AddComponent(UITextMeshProUGUIEx, score_path)
end

--控件的销毁
local function ComponentDestroy(self)
end

--变量的定义
local function DataDefine(self)
    self.rankInfo = nil
    self.index = 1
end

--变量的销毁
local function DataDestroy(self)
    self.rankInfo = nil
    self.index = 1
end

local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.OnClaimRewardEffFinish, self.RefreshNeed)

end

local function OnRemoveListener(self)
    --self:RemoveUIListener(EventId.OnClaimRewardEffFinish, self.RefreshNeed)
    base.OnRemoveListener(self)
end


--param = {showChallenge = false, index = 1}
local function SetItem(self, rankInfo, param)
    self.rankInfo = rankInfo
    self.index = param and param.index or 1

    self:RefreshAll()
end

local function RefreshAll(self)
    if self.rankInfo == nil then
        self:ShowSelf()
    else
        self:ShowOther()
    end
end

local function ShowSelf(self)
    local selfInfo = DataCenter.ArenaManager:GetSelfInfo()
    self.rankImgN:SetActive(false)
    if selfInfo.selfRank < 0 then
        self.rankNumN:SetActive(true)
        self.rankNumN:SetText("999+")
        self.scoreN:SetText(selfInfo.selfScore)
    else
        self.rankNumN:SetText(selfInfo.selfRank)
        self.scoreN:SetText(selfInfo.selfScore)
        if selfInfo.selfRank < 4 then
            self.rankImgN:SetActive(true)
            self.rankNumN:SetActive(false)
            
            self.rankImgN:LoadSprite("Assets/Main/Sprites/UI/Common/UIalliance_rankingbg0" .. selfInfo.selfRank)
        else
            
            self.rankNumN:SetActive(true)
            self.rankImgN:SetActive(false)
        end
    end

    self.playerHeadN:SetData(LuaEntry.Player.uid, LuaEntry.Player.pic, LuaEntry.Player.picVer)
    local fgImg = LuaEntry.Player:GetHeadBgImg()
    if not string.IsNullOrEmpty(fgImg) then
        self.playerHeadFgN:SetActive(true)
        self.playerHeadFgN:LoadSprite(fgImg)
    else
        self.playerHeadFgN:SetActive(false)
    end

    if LuaEntry.Player:IsInAlliance() then
        local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBase then
            abbr = allianceBase.abbr
            self.nameN:SetText("[" .. allianceBase.abbr .. "]" .. LuaEntry.Player.name)
        else
            self.nameN:SetText(LuaEntry.Player.name)
        end
    else
        self.nameN:SetText(LuaEntry.Player.name)
    end

    self.powerN:SetText(string.GetFormattedStr(selfInfo.selfPower))
end

local function ShowOther(self)


    if self.rankInfo.type == 0 then
        self.rankNumN:SetActive(true)
        self.rankNumN:SetText(self.rankInfo.score)
        self.rankImgN:SetActive(false)
        self.nameN:SetLocalText(100184)
        self.powerN:SetText(string.GetFormattedStr(self.rankInfo.power))
        self.scoreN:SetText(self.rankInfo.score)
    else
        if self.rankInfo.rank < 4 then
            self.rankNumN:SetActive(false)
            self.rankImgN:SetActive(true)
            self.bgN:LoadSprite("Assets/Main/Sprites/UI/UIArena/arena_img_columns0" .. self.rankInfo.rank)
            self.rankImgN:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg0" .. self.rankInfo.rank)
        else
            self.rankImgN:SetActive(false)
            self.rankNumN:SetActive(true)
            self.rankNumN:SetText(self.rankInfo.rank)
            self.bgN:LoadSprite("Assets/Main/Sprites/UI/UIArena/arena_img_columns04")
        end
        self.playerHeadN:SetData(self.rankInfo.uid, self.rankInfo.pic, self.rankInfo.picVer)
        local tempAbbr = not string.IsNullOrEmpty(self.rankInfo.abbr) and "[" .. self.rankInfo.abbr .. "]" or ""
        self.nameN:SetText(tempAbbr .. self.rankInfo.name)
        self.powerN:SetText(string.GetFormattedStr(self.rankInfo.power))
        self.scoreN:SetText(self.rankInfo.score)
    end
end


local function OnClickPlayerHeadBtn(self)
    if self.rankInfo and self.rankInfo.type == 1 then
        if self.rankInfo.uid ~= LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo, self.rankInfo.uid)
        end
    end
end
local function OnClickBg(self)
    if self.rankInfo~=nil then
        if self.rankInfo.uid ~= LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIArenaPlayerDetail, {anim = true, isBlur = true},self.rankInfo)
        end
    end
end

ArenaRankItem.OnCreate = OnCreate
ArenaRankItem.OnDestroy = OnDestroy
ArenaRankItem.ComponentDefine = ComponentDefine
ArenaRankItem.ComponentDestroy = ComponentDestroy
ArenaRankItem.DataDefine = DataDefine
ArenaRankItem.DataDestroy = DataDestroy
ArenaRankItem.OnAddListener = OnAddListener
ArenaRankItem.OnRemoveListener = OnRemoveListener

ArenaRankItem.SetItem = SetItem
ArenaRankItem.RefreshAll = RefreshAll
ArenaRankItem.ShowSelf = ShowSelf
ArenaRankItem.ShowOther = ShowOther
ArenaRankItem.OnClickPlayerHeadBtn = OnClickPlayerHeadBtn
ArenaRankItem.OnClickBg =OnClickBg
return ArenaRankItem