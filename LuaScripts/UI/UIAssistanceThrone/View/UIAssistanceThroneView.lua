---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/3/20 21:43
---
local ThroneWarItem = require "UI.UIAssistanceThrone.Component.ThroneWarItem"
local ThroneWarJoinItem = require "UI.UIAssistanceThrone.Component.ThroneWarJoinItem"
local UIAssistanceThroneView = BaseClass("UIAssistanceThroneView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization

local txt_title_path ="UICommonPopUpTitle/bg_mid/titleText"
local close_btn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonPopUpTitle/panel"
local fight_team_obj_path = "ImgBg/ThroneWarItem"
local des_txt_path = "ImgBg/desObj/desTxt"
local rule_txt_path = "ImgBg/desObj/ruleTxt"
local layout_path = "ImgBg/layout"
local scroll_view_path = "ImgBg/layout/ScrollView"
local join_obj_path = "ImgBg/layout/ThroneWarJoinItem"
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DataDestroy()
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.title = self:AddComponent(UIText,txt_title_path)
    self.title:SetLocalText(250162)
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:OnCloseClick()
    end)
    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.return_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:OnCloseClick()
    end)
    self.join_obj = self:AddComponent(ThroneWarJoinItem,join_obj_path)
    self.fight_team_obj = self:AddComponent(ThroneWarItem,fight_team_obj_path)
    self.des_txt = self:AddComponent(UIText,des_txt_path)
    self.des_txt:SetLocalText(250106)
    self.rule_txt = self:AddComponent(UIText,rule_txt_path)
    self.rule_txt:SetLocalText(250116)
    self.layout = self:AddComponent(UIBaseContainer,layout_path)
    self.ScrollView = self:AddComponent(UIScrollView, scroll_view_path)
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    self.warList = {}
    self.cellList = {}
end

local function ComponentDestroy(self)
    self:ClearItemCell()
end

local function DataDefine(self)
end

local function DataDestroy(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GetAssistanceData, self.OnRefresh)
    self:AddUIListener(EventId.UpdateMarchItem,self.RefreshFirstMarch)
    self:AddUIListener(EventId.CancelAllianceTeam, self.OnCancelAllianceTeam)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.GetAssistanceData,self.OnRefresh)
    self:RemoveUIListener(EventId.UpdateMarchItem,self.RefreshFirstMarch)
    self:RemoveUIListener(EventId.CancelAllianceTeam, self.OnCancelAllianceTeam)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnCancelAllianceTeam(self)
    SFSNetwork.SendMessage(MsgDefines.AllianceAssistanceInfo, self.uuid, self.asType)
end
local function ReInit(self)
    local uuid,pointId, asType = self:GetUserData()
    self.uuid = tonumber(uuid)
    self.pointId = tonumber(pointId)
    self.asType = asType
    SFSNetwork.SendMessage(MsgDefines.AllianceAssistanceInfo, self.uuid, self.asType)
end

local function OnRefresh(self)
    self:ClearItemCell()
    local warData = self.ctrl:GetAssistanceArmyData(self.uuid)
    self.warList = warData.waitingArr
    self.fightData = warData.fightData
    self.isSelfJoin = warData.isSelfJoin
    if self.fightData~=nil then
        self.fight_team_obj:SetActive(true)
        self.fight_team_obj:RefreshData(self.fightData,true)
    else
        self.fight_team_obj:SetActive(false)
    end
    
    if self.isSelfJoin ==false then
        self.join_obj:SetActive(true)
    else
        self.join_obj:SetActive(false)
    end
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.layout.rectTransform)
    if #self.warList>0 then
        self.ScrollView:SetTotalCount(#self.warList)
        self.ScrollView:RefillCells()
    end
end
local function OnJoinClick(self)
    local pointId = self.pointId
    local uuid = self.uuid
    local show  = Setting:GetPrivateInt("SHOW_ASSISTANCE_THRONE",0)
    if show<=0 then
        UIUtil.ShowSecondMessage(Localization:GetString("100378"),Localization:GetString("250161"),2,"","", function()
            self.ctrl:OnCloseClick()
            MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_ASSISTANCE_THRONE, pointId, uuid,-1,1)
        end, function(needSellConfirm)
            if needSellConfirm== false then
                Setting:SetPrivateInt("SHOW_ASSISTANCE_THRONE",1)
            else
                Setting:SetPrivateInt("SHOW_ASSISTANCE_THRONE",0)
            end
        end)
    else
        self.ctrl:OnCloseClick()
        MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_ASSISTANCE_THRONE, pointId, uuid,-1,1)
    end
    
end


local function OnItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(ThroneWarItem, itemObj)
    cellItem:RefreshData(self.warList[index])
    self.cellList[index] = cellItem
end

local function OnItemMoveOut(self, itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, ThroneWarItem)
    self.cellList[index] = nil
end

local function ClearItemCell(self)
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(ThroneWarItem)
    self.warList = {}
    self.cellList = {}
end

local function OnCancelClick(self,uuid)
    self.ctrl:OnCancelClick(self.uuid,uuid)
end

local function RefreshFirstMarch(self)
    self.fight_team_obj:OnMarchRefresh()
end
UIAssistanceThroneView.OnCreate = OnCreate
UIAssistanceThroneView.OnDestroy = OnDestroy
UIAssistanceThroneView.ComponentDefine = ComponentDefine
UIAssistanceThroneView.ComponentDestroy = ComponentDestroy
UIAssistanceThroneView.DataDefine = DataDefine
UIAssistanceThroneView.DataDestroy = DataDestroy
UIAssistanceThroneView.OnEnable = OnEnable
UIAssistanceThroneView.OnDisable = OnDisable
UIAssistanceThroneView.OnAddListener = OnAddListener
UIAssistanceThroneView.OnRemoveListener = OnRemoveListener
UIAssistanceThroneView.ReInit = ReInit
UIAssistanceThroneView.OnJoinClick = OnJoinClick
UIAssistanceThroneView.ClearItemCell = ClearItemCell
UIAssistanceThroneView.OnItemMoveOut = OnItemMoveOut
UIAssistanceThroneView.OnItemMoveIn = OnItemMoveIn
UIAssistanceThroneView.OnRefresh =OnRefresh
UIAssistanceThroneView.OnCancelAllianceTeam = OnCancelAllianceTeam
UIAssistanceThroneView.OnCancelClick =OnCancelClick
UIAssistanceThroneView.RefreshFirstMarch = RefreshFirstMarch
return UIAssistanceThroneView