---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime: 

local UICrossDesertServerView = BaseClass("UICrossDesertServerView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local ServerCell = require "UI.UICrossDesertServer.Component.ServerCell"

function UICrossDesertServerView:OnCreate()
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

function UICrossDesertServerView:OnDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

function UICrossDesertServerView:ComponentDefine()
    self._title_text = self:AddComponent(UITextMeshProUGUIEx, "UICommonPopUpTitle/bg_mid/titleText")

    self._return_btn = self:AddComponent(UIButton, "UICommonPopUpTitle/panel")
    self._return_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)
    self._close_btn = self:AddComponent(UIButton, "UICommonPopUpTitle/bg_mid/CloseBtn")
    self._close_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self.ctrl:CloseSelf()
    end)

    self.scroll_view = self:AddComponent(UIScrollView, "ScrollViewList")
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)

    self._attack_btn = self:AddComponent(UIButton,"Btn_Attack")
    self._attack_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:ClickAttack()
    end)
    self._attack_txt = self:AddComponent(UIText,"Btn_Attack/Txt_Attack")
    self._attack_txt:SetLocalText(100150)
end

function UICrossDesertServerView:ComponentDestroy()

end

function UICrossDesertServerView:DataDefine()

end

function UICrossDesertServerView:DataDestroy()

end

function UICrossDesertServerView:OnAddListener()
    base.OnAddListener(self)
end

function UICrossDesertServerView:OnRemoveListener()
    base.OnRemoveListener(self)
end

function UICrossDesertServerView:OnEnable()
    base.OnEnable(self)
    local activityId = self:GetUserData()
    local activityInfo = DataCenter.ActivityListDataManager:GetActivityDataById(activityId)
    if activityInfo.servers and activityInfo.servers ~= "" then
        self.serverList = string.split(activityInfo.servers,";")
        self:ReInit()
    end

end

function UICrossDesertServerView:OnDisable()
    base.OnDisable(self)
end

function UICrossDesertServerView:ReInit()
    self.changeIndex = 0
    self._attack_btn:SetActive(false)
    self._title_text:SetLocalText(372995)
    self:ClearScroll()
    for i = 1 ,table.count(self.serverList) do
        if tonumber(self.serverList[i]) == LuaEntry.Player:GetSelfServerId() then
            table.remove(self.serverList,i)
            break
        end
    end
    if table.count(self.serverList) > 0 then
        self.scroll_view:SetTotalCount(#self.serverList)
        self.scroll_view:RefillCells()
    end
end

function UICrossDesertServerView:OnItemMoveIn(itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scroll_view:AddComponent(ServerCell, itemObj)
    cellItem:SetData(self.serverList[index],index)
end

function UICrossDesertServerView:OnItemMoveOut( itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, ServerCell)
end


function UICrossDesertServerView:ClearScroll()
    self.scroll_view:ClearCells()
    self.scroll_view:RemoveComponents(ServerCell)
end

function UICrossDesertServerView:ChangeServer(index)
    if index then
        self.changeIndex = index
    end
    self.scroll_view:RefillCells()
    self._attack_btn:SetActive(true)
end

function UICrossDesertServerView:ClickAttack()
    if self.changeIndex ~= 0 then
        local position = {}
        position.x = 1000
        position.y = 0
        position.z = 1000
        GoToUtil.CloseAllWindows()
        local isR4orR5 = DataCenter.AllianceBaseDataManager:IsR4orR5()
        --检查前哨战是否已经放置
        local flagData = DataCenter.AllianceMineManager:GetAllianceFlagData()
        if flagData~=nil then
            --已放置，跳转到前哨战
            local targetServerId = flagData.curServerId
            if targetServerId == tonumber(self.serverList[self.changeIndex]) then
                local pointId = flagData.pointId
                if pointId>0 then
                    local pos = SceneUtils.TileIndexToWorld(pointId,ForceChangeScene.World)
                    pos.x = pos.x-1
                    pos.y = pos.y
                    pos.z = pos.z-1
                    GoToUtil.GotoWorldPos(pos,nil,nil,function()
                        UIUtil.ShowTipsId(372994)
                    end,targetServerId)
                    --WorldArrowManager:GetInstance():ShowArrowEffect(0,position,ArrowType.Building)
                end
            else
                GoToUtil.GotoWorldPos(position,550,nil,function()
                    --提示建造前哨战
                    if isR4orR5 then
                        UIUtil.ShowTipsId(372992)
                    else
                        UIUtil.ShowTipsId(372993)
                    end
                end,tonumber(self.serverList[self.changeIndex]))
            end
        else
            --未放置，先跳转
            if tonumber(self.serverList[self.changeIndex])  == LuaEntry.Player:GetSelfServerId() then
                --本服
                GoToUtil.GotoWorldPos(position,550,nil,function()
                    --提示建造前哨战
                    if isR4orR5 then
                        UIUtil.ShowTipsId(372992)
                    else
                        UIUtil.ShowTipsId(372993)
                    end
                end)
            else
                --其他服
                GoToUtil.GotoWorldPos(position,550,nil,function()
                    --提示建造前哨战
                    if isR4orR5 then
                        UIUtil.ShowTipsId(372992)
                    else
                        UIUtil.ShowTipsId(372993)
                    end
                end,tonumber(self.serverList[self.changeIndex]))
            end
        end
    end
end



return UICrossDesertServerView