---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/8/11 11:36
---

local UIRateTip = BaseClass("UIRateTip", UIBaseView)
local base = UIBaseView
local UIRateTipItem = require "UI.UIRateTip.Component.UIRateTipItem"

local this_path = ""
local root_path = "Root"
local top_path = "Root/Top"
local desc_path = "Root/Top/Desc"
local bottom_path = "Root/Bottom"
local arrow_path = "Arrow"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.btn = self:AddComponent(UIButton, this_path)
    self.btn:SetOnClick(function()
        self:Clear()
        self.ctrl:CloseSelf()
    end)
    self.root_anim = self:AddComponent(UIAnimator, root_path)
    self.top_go = self:AddComponent(UIBaseContainer, top_path)
    self.desc_text = self:AddComponent(UIText, desc_path)
    self.bottom_go = self:AddComponent(UIBaseContainer, bottom_path)
    self.arrow_go = self:AddComponent(UIBaseContainer, arrow_path)
end

local function ComponentDestroy(self)
    
end

local function DataDefine(self)
    self.reqs = {}
    self.items = {}
end

local function DataDestroy(self)
    
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function ReInit(self)
    local param = self:GetUserData()
    if param == nil then
        return
    end
    
    local pos = param.pos or VecZero
    local desc = param.desc or ""
    local dataList = param.dataList or {}
    local isLeft = param.isLeft or false
    local offsetY = param.offsetY or 0
    
    local arrowPos = self.arrow_go.rectTransform.position
    arrowPos.x = pos.x
    arrowPos.y = pos.y
    self.arrow_go.rectTransform.position = arrowPos
    
    local arrowScale = self.arrow_go.rectTransform.localScale
    arrowScale.x = isLeft and -1 or 1
    self.arrow_go.rectTransform.localScale = arrowScale
    
    local pivot = self.root_anim.rectTransform.pivot
    pivot.x = isLeft and 1 or 0
    self.root_anim.rectTransform.pivot = pivot
    
    local rootPos = self.root_anim.rectTransform.position
    rootPos.x = pos.x + (isLeft and -2.5 or 2.5)
    rootPos.y = pos.y + offsetY
    self.root_anim.rectTransform.position = rootPos
    
    self.desc_text:SetText(desc)
    
    self.root_anim:SetActive(false)
    self.arrow_go:SetActive(false)
    local total = #dataList
    local cur = 0
    for i, data in ipairs(dataList) do
        if self.items[i] then
            self.items[i]:SetData(data)
        else
            if self.reqs[i] then
                self.reqs[i]:Destroy()
            end
            self.reqs[i] = self:GameObjectInstantiateAsync(UIAssets.UIRateTipItem, function(req)
                if req.isError then
                    return
                end
                local go = req.gameObject
                go.name = tostring(i)
                go.transform:SetParent(self.bottom_go.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)

                local item = self.bottom_go:AddComponent(UIRateTipItem, go.name)
                item:SetData(data)
                self.items[i] = item
                cur = cur + 1
                if cur == total then
                    self.root_anim:SetActive(true)
                    self.arrow_go:SetActive(true)
                    self.root_anim:Play("CommonPopup_movein", 0, 0)
                end
            end)
        end
    end
end

local function Clear(self)
    self.bottom_go:RemoveComponents(UIRateTipItem)
    for _, req in pairs(self.reqs) do
        req:Destroy()
    end
    self.reqs = {}
    self.items = {}
end

UIRateTip.OnCreate = OnCreate
UIRateTip.OnDestroy = OnDestroy
UIRateTip.OnEnable = OnEnable
UIRateTip.OnDisable = OnDisable
UIRateTip.ComponentDefine = ComponentDefine
UIRateTip.ComponentDestroy = ComponentDestroy
UIRateTip.DataDefine = DataDefine
UIRateTip.DataDestroy = DataDestroy
UIRateTip.OnAddListener = OnAddListener
UIRateTip.OnRemoveListener = OnRemoveListener

UIRateTip.ReInit = ReInit
UIRateTip.Clear = Clear

return UIRateTip