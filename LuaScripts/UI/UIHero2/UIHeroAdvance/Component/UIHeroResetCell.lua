---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhangliheng.
--- DateTime: 7/5/21 5:01 PM
---


local UIHeroResetCell = BaseClass("UIHeroResetCell", UIBaseContainer)
local base = UIBaseContainer
local UIHeroCell = require "UI.UIHero2.Common.UIHeroCellSmall"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
end

local function OnDestroy(self)
    self.parent = nil
    self.heroUuid = nil
    self.heroData = nil
    self.isAlreadySelect = nil

    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.heroCell = self:AddComponent(UIHeroCell, "UIHeroCellSmall")
    self.heroCell:ToggleRayCast(false)

    self.stateChecked = self:AddComponent(UIImage, "StateCheck")
    self.stateOccupy = self:AddComponent(UIBaseContainer, "StateOccupy")
    self.textFormationId = self:AddComponent(UITextMeshProUGUIEx, "StateOccupy/FormationBg/TextId")
    self.TextInvalidReason = self:AddComponent(UITextMeshProUGUIEx, "StateOccupy/TextInvalidReason")
    self.TextInvalidReason:SetLocalText(120166)
    local btn = self:AddComponent(UIButton, "")
    btn:SetOnClick(BindCallback(self, self.OnBtnClick))
end

local function ComponentDestroy(self)
    self.heroCell = nil
end

local function SetData(self, heroUuid)
    self.heroUuid = heroUuid
    self.heroData = DataCenter.HeroDataManager:GetHeroByUuid(self.heroUuid)

    local rankId = self.heroData:GetCurMilitaryRankId()
    self.heroCell:SetData(heroUuid, nil, rankId >= 22, true)
    self.stateChecked:LoadSprite(HeroUtils.GetRarityIconPath(self.heroData.rarity))

    local isInFormation, formationId, marchState = self.heroData:IsInFormation()
    if isInFormation then
        self.textFormationId:SetText(formationId)
    end

    self.stateOccupy:SetActive(isInFormation)
    
    self:UpdateHeroState()
end

local function SetParent(self, parent)
    self.parent = parent
end

local function UpdateHeroState(self)
    local coreUuid = self.parent:GetResetHeroUuid()
    self.stateChecked:SetActive(self.heroUuid == coreUuid)
end

local function OnBtnClick(self)
    local heroData = DataCenter.HeroDataManager:GetHeroByUuid(self.heroUuid)
    if heroData == nil or heroData:IsInFormation() then
        return
    end
    --取消、切换英雄
    local coreUuid = self.parent:GetResetHeroUuid()
    
    if self.heroUuid == coreUuid then
        self.parent:OnCancelHero()              --取消选择
    else
        self.parent:OnSelectHero(self.heroUuid) --切换选择
    end
end


UIHeroResetCell.OnCreate = OnCreate
UIHeroResetCell.OnDestroy = OnDestroy
UIHeroResetCell.ComponentDefine = ComponentDefine
UIHeroResetCell.ComponentDestroy = ComponentDestroy
UIHeroResetCell.SetData = SetData
UIHeroResetCell.SetParent = SetParent

UIHeroResetCell.UpdateHeroState = UpdateHeroState
UIHeroResetCell.OnBtnClick = OnBtnClick

return UIHeroResetCell
