---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhangliheng.
--- DateTime: 6/24/21 9:14 PM
---
--- 升阶消耗槽

local UIHeroAdvanceSlot = BaseClass("UIHeroAdvanceSlot", UIBaseContainer)
local base = UIBaseContainer

local UIHeroCell = require "UI.UIHero2.Common.UIHeroCellSmall_TextMeshPro"
local Localization = CS.GameEntry.Localization
local UIHeroStars = require 'UI.UIHero2.Common.UIHeroStars'

local default_hero_bg = "Assets/Main/Sprites/UI/UIHeroAdvance/UIheroupgrade_img_empty02"
local default_hero_fg = "Assets/Main/Sprites/UI/UIHeroAdvance/UIheroupgrade_img_empty01"
local default_hero_add = "Assets/Main/Sprites/UI/UIHeroAdvance/UIheroupgrade_img_addempty"
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()

    self.parent = nil
    self.heroUuid = nil
    self.heroData = nil
    
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.nodeEmpty = self:AddComponent(UIBaseContainer, 'Empty')
    self.imgRequireQuality = self:AddComponent(UIImage, "Empty/HeroNeedItem/LayerPoster/ImgPosterQualityBg")
    self.imgRequireFgQuality = self:AddComponent(UIImage, "Empty/HeroNeedItem/LayerPoster/ImgPosterQualityFg")
    self.imgRequireHeroIcon = self:AddComponent(UIImage, "Empty/HeroNeedItem/LayerPoster/ImgPosterQualityBg/ImgPosterIcon")
    self.imgRequireCamp = self:AddComponent(UIImage, "Empty/HeroNeedItem/imgCamp")
    --self.starBox = self:AddComponent(UIBaseContainer, "Empty/HeroNeedItem/StarBox")
    self.star = self:AddComponent(UIHeroStars, "Empty/HeroNeedItem/NodeArrow")
    self.imgMask = self:AddComponent(UIImage, 'Empty/HeroNeedItem/Mask')
    self.addBg = self:AddComponent(UIImage, 'Empty/addBg')
    self.heroCell = self:AddComponent(UIHeroCell, "UIHeroCellSmall")
    self.heroCell:ToggleRayCast(false)

    self.btn = self:AddComponent(UIButton, "")
    self.btn:SetOnClick(function()  
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBtnClick()
    end)
    self.closeBtn = self:AddComponent(UIButton, "Close")
    self.closeBtn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBtnClick()
    end)
    self.closeBtn:SetActive(false)
end

--控件的销毁
local function ComponentDestroy(self)
    self.imgRequireQuality = nil
    self.imgRequireHeroIcon = nil
    self.imgRequireCamp = nil
    --self.starBox = nil
    self.heroCell = nil
end

-- 全部刷新
local function SetData(self, heroUuid, requireType, requireQuality)
    self.heroUuid = heroUuid
    self.requireType = requireType
    self.requireQuality = requireQuality
    
    -- 默认空槽
    if heroUuid == nil then
        self:UpdateRequireDogFoodInfo()
    else
        self.heroData = DataCenter.HeroDataManager:GetHeroByUuid(self.heroUuid)
        self.heroCell:SetData(heroUuid, nil, nil, true)
        --self.heroCell:SetCampActive(false)
    end
    self.closeBtn:SetActive(heroUuid ~= nil)
    self.nodeEmpty:SetActive(heroUuid == nil)
    self.heroCell:SetActive(heroUuid ~= nil)
end

local function SetParent(self, parent)
    self.parent = parent
end


--- 显示所需狗粮的相关要求(品质、阵营、[英雄类型])
local function UpdateRequireDogFoodInfo(self)
    local curAdvanceUuid = HeroAdvanceController:GetInstance():GetAdvanceHeroUuid()
    if curAdvanceUuid == nil or curAdvanceUuid == 0 then
        --print("#zlh# UpdateRequireDogFoodInfo SetActive(false)")
        self:SetActive(false)
        return
    end

    local coreHeroData = DataCenter.HeroDataManager:GetHeroByUuid(curAdvanceUuid)
    self.coreHeroData = coreHeroData
    local heroConfig = LocalController:instance():getLine(HeroUtils.GetHeroXmlName(), coreHeroData.heroId)

    self.imgMask:LoadSprite(HeroUtils.GetQualityIconPath(self.requireQuality))
    
    local rarity = heroConfig['rarity']
    local param = {}
    param.showStarNum = self.requireQuality
    param.maxStarNum = HeroUtils.GetMaxStarByRarity(rarity)
    self.star:SetData(param)

    --self.starNum:SetText(requireQuality)
    --local starNum = HeroUtils.GetStarNumByQuality(requireQuality)
    --self.starBox.gameObject:SetActive(starNum > 0)
    --if starNum > 0 then
    --    for i=1, HeroUtils.HeroStarMax do
    --        local star = self.starBox.transform:Find("star".. i)
    --        star.gameObject:SetActive(starNum >= i)
    --    end
    --end
    --self.imgRequireCamp:LoadSprite(HeroUtils.GetCampIconPath(requireCamp))
    self.imgRequireCamp:SetActive(false)
    if self.requireType == 1 then
        self.imgRequireHeroIcon:LoadSprite(HeroUtils.GetHeroIconPath(coreHeroData.heroId))
        self.imgRequireQuality:LoadSprite(HeroUtils.GetPosterSelectRarityPath(heroConfig['rarity'], true))
        self.imgRequireFgQuality:LoadSprite(HeroUtils.GetPosterSelectRarityPath(heroConfig['rarity'], false))
        self.addBg:LoadSprite(HeroUtils.GetPosterAddRarityPath(heroConfig['rarity']))
    else
        self.imgRequireQuality:LoadSprite(default_hero_bg)
        self.imgRequireFgQuality:LoadSprite(default_hero_fg)
        self.addBg:LoadSprite(default_hero_add)
    end
    self.imgRequireHeroIcon:SetActive(self.requireType == 1)                              
end

local function OnBtnClick(self)
    if self.heroUuid ~= nil then
        -- 取消选择当前狗粮
        self.parent:OnToggleDogFood(self.heroUuid)
        self.heroUuid = nil
        --print("#zlh# cancel dogFod heroUuid")
    else
        local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
        local scaleFactor = UIManager:GetInstance():GetScaleFactor()
        local position = self.btn.transform.position + Vector3.New(0, 30, 0) * scaleFactor

        --local reqQualityStr = string.format("<color='%s'>%s</color>", HeroUtils.GetQualityColorStr(self.requireQuality),  HeroUtils.GetQualityName(self.requireQuality));
        local reqQualityStr = math.floor(self.requireQuality / 2)
        local heroName = HeroUtils.GetHeroNameByConfigId(self.coreHeroData.heroId)
        local tip = self.requireType == 1 and Localization:GetString('129123', reqQualityStr, heroName) or Localization:GetString('129120', reqQualityStr)
        if reqQualityStr == 0 then
            tip = Localization:GetString('129221', heroName)
        end
        local param = UIHeroTipView.Param.New()
        param.content = Localization:GetString("129119") .. "\n" .. tip
        param.dir = UIHeroTipView.Direction.ABOVE
        param.defWidth = 280
        param.pivot = 0.3
        param.position = position

        UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
    end
end


UIHeroAdvanceSlot.OnCreate = OnCreate
UIHeroAdvanceSlot.OnDestroy = OnDestroy
UIHeroAdvanceSlot.OnEnable = OnEnable
UIHeroAdvanceSlot.OnDisable = OnDisable
UIHeroAdvanceSlot.ComponentDefine = ComponentDefine
UIHeroAdvanceSlot.ComponentDestroy = ComponentDestroy
UIHeroAdvanceSlot.SetData = SetData
UIHeroAdvanceSlot.SetParent = SetParent

UIHeroAdvanceSlot.UpdateRequireDogFoodInfo = UpdateRequireDogFoodInfo
UIHeroAdvanceSlot.OnBtnClick = OnBtnClick

return UIHeroAdvanceSlot
