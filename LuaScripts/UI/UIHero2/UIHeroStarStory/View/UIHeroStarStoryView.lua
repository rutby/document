---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhangliheng.
--- DateTime: 7/15/21 4:52 PM
---
local UIHeroStarStoryView = BaseClass("UIHeroStarStoryView", UIBaseView)
local base = UIBaseView
local HeroInfo = require "DataCenter.HeroData.HeroInfo"
local Param = DataClass("Param", ParamData)
local Localization = CS.GameEntry.Localization
local UICommonTab = require "UI.UICommonTab.UICommonTab"
local UIGray = CS.UIGray

local close_path = "Root/CloseBtn"
local hero_name_path = "Root/HeroNameTitle"
local hero_img_path = "Root/HeroImg"
local storynum_txt_path = "Root/StroyTitle"
local hero_storydesc_path = "Root/HeroContent"
local hero_locknode_path = "Root/LockNode"
local hero_lockdesc_path = "Root/LockNode/LockDesc"
local hero_box_path = "Root/box"
local tab_path = "Root/TabList/Tab%s"
local tab_red_path = "Root/TabList/Tab%s/Tab%sRed"

local TabCount = 4

local TabType =
{
    OneStory = 1,
    TwoStory = 2,
    ThreeStory = 3,
    FourStory = 4,
}
   
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    self:OnInit()
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.HeroStarStoryResult, self.RefreshInfo)
end 

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.HeroStarStoryResult, self.RefreshInfo)
end 

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self:OnCloseClick()
    end)
    self.box_btn = self:AddComponent(UIButton, hero_box_path)
    self.box_btn:SetOnClick(function()
        self:OnBoxClick()
    end)

    self.heroName_text = self:AddComponent(UITextMeshProUGUIEx, hero_name_path)
    self.hero_img = self:AddComponent(UIImage,hero_img_path)
    self.hero_storyNum_text = self:AddComponent(UITextMeshProUGUIEx,storynum_txt_path)
    self.hero_storyDesc_text = self:AddComponent(UITextMeshProUGUIEx,hero_storydesc_path)
    self.hero_lock_node = self:AddComponent(UIBaseContainer,hero_locknode_path)
    self.hero_lock_desc = self:AddComponent(UITextMeshProUGUIEx,hero_lockdesc_path)

    self.tabs = {}
    self.tab_red_goes = {}
    for i = 1, TabCount do
        self.tabs[i] = self:AddComponent(UICommonTab, string.format(tab_path, i))
        self.tabs[i]:SetSelected(false)
        self.tabs[i]:SetOnClick(function()
            self:OnTabClick(i)
        end)
        self.tab_red_goes[i] = self:AddComponent(UIBaseContainer, string.format(tab_red_path, i, i))
        self.tabs[i]:SetName(RomeNum[i]) 
    end
   
end

local function OnInit(self)
    self.herodata = self:GetUserData()
    local curRankId = self.herodata:GetCurMilitaryRankId()
    local level = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "level"))
    local stage = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "stage"))
    self.starTypeTab = string.split(self.herodata.config.background,"|")
	self:RefreshTabRed()
    local tmpNum = 1
    for i = 1,TabType.FourStory  do 
        local isGetBox  = self.herodata:GetBackStoryRewarDict(i)
        if i <= level and  not isGetBox  then --等级满足 
            self:OnTabClick(i)
            return 
        end 
        if i <= level then 
            tmpNum = i
        end 
    end 
    self:OnTabClick(tmpNum)
end 


local function RefreshInfo(self)
    self:OnRefreshQuality()
    self:RefreshTabRed()
end 


local function OnCloseClick(self)
    self.ctrl:CloseSelf()
end 

local function OnTabClick(self, index)
    for i = 1, TabCount do
        self.tabs[i]:SetSelected(i == index)
    end
    self.curIndex = index
    self.heroName_text:SetLocalText(self.herodata.config.name) 
    if index == TabType.OneStory then 
        self.hero_storyNum_text:SetLocalText(321436) 
    elseif index == TabType.TwoStory  then
        self.hero_storyNum_text:SetLocalText(321437) 
    elseif index == TabType.ThreeStory then
        self.hero_storyNum_text:SetLocalText(321438) 
    elseif index == TabType.FourStory then 
        self.hero_storyNum_text:SetLocalText(321439)

    end 
    local itemData = self.starTypeTab[index]
	local strs = string.split(itemData,";")
    self.hero_storyDesc_text:SetLocalText(strs[2]) 

    self:OnRefreshQuality()
    self:RefreshTabRed()
end

local function OnBoxClick(self, index)
    --self.herodata = self:GetUserData()
    if self.curIndex > 0 then 
        DataCenter.HeroStarStoryManager:SendGetStoryRewardParam(self.herodata.heroId,self.curIndex)
    end 

end


local function OnRefreshQuality(self)
	local rowData = self.starTypeTab[self.curIndex]
	local strs = string.split(rowData,";")
	local rankId = strs[1]
    local level = tonumber(GetTableData(TableName. HeroMilitaryRank, rankId, "level"))
    local stage = tonumber(GetTableData(TableName. HeroMilitaryRank, rankId, "stage"))
	local curRankId = self.herodata:GetCurMilitaryRankId()
	local curLevel = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "level"))
    if self.curIndex <= curLevel then --等级满足 
        self.hero_lock_node:SetActive(false)
        self.hero_storyDesc_text:SetActive(true)
        self.hero_lock_desc:SetActive(false)
    else
        self.hero_lock_node:SetActive(true)
        self.hero_storyDesc_text:SetActive(false)
        self.hero_lock_desc:SetActive(true)
        local num = Mathf.Abs(level - self.curIndex ) 
        local str = ""
        local stageNum = 5 - stage
        if stage ==  0 then
            --str = Localization:GetString("321440",Localization:GetString("129269", self.curIndex - 1 ))
			str = Localization:GetString("321440",Localization:GetString("129269", self.curIndex - 1 ))
        else 
            --str = Localization:GetString("321440",Localization:GetString("129270", num - 1, stageNum))
			str = Localization:GetString("321440",Localization:GetString("129270", self.curIndex - 1, Mathf.Abs(stage)))
        end
        self.hero_lock_desc:SetText(str)
    end 
    self:OnRefreshBoxState()
end 

local function OnRefreshBoxState(self,level)
	local curRankId = self.herodata:GetCurMilitaryRankId()
	local level = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "level"))
	local stage = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "stage"))
    local isGetBox  = self.herodata:GetBackStoryRewarDict(self.curIndex)
    self.box_btn:SetActive((not isGetBox)  and  self.curIndex <= level )
    --if (not isGetBox)  and  self.curIndex <= level  then 
    --    self:RefreshBoxBtnEffect(true)
    --end
end


local function RefreshTabRed(self)
	local curRankId = self.herodata:GetCurMilitaryRankId()
    local level = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "level"))
    local stage = tonumber(GetTableData(TableName. HeroMilitaryRank, curRankId, "stage"))
    for i = 1 , TabCount do 
        local isGetBox  = self.herodata:GetBackStoryRewarDict(i)
        self.tab_red_goes[i]:SetActive((not isGetBox) and i <= level)
    end 

end

local function RefreshBoxBtnEffect(self,boo)
    local req = nil
    if  boo then 
        local req = self:GameObjectInstantiateAsync(UIAssets.UIHeroStarStoryBoxEffect, function(request)
            if request.isError then
                return
            end
            local go = request.gameObject
            go.transform:SetParent(self.box_btn.transform)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go.transform:Set_localPosition(ResetPosition.x, ResetPosition.y + 5, ResetPosition.z)
        end)
    else
        if  req ~= nil then 
            req:Destroy()
        end 

    end 

end

local function ComponentDestroy(self)

end


UIHeroStarStoryView.Param = Param
UIHeroStarStoryView.Direction = Direction
UIHeroStarStoryView.OnCreate= OnCreate
UIHeroStarStoryView.OnDestroy = OnDestroy
UIHeroStarStoryView.OnEnable = OnEnable
UIHeroStarStoryView.OnDisable = OnDisable
UIHeroStarStoryView.ComponentDefine = ComponentDefine
UIHeroStarStoryView.ComponentDestroy = ComponentDestroy
UIHeroStarStoryView.OnInit = OnInit
UIHeroStarStoryView.OnAddListener = OnAddListener
UIHeroStarStoryView.OnRemoveListener = OnRemoveListener
UIHeroStarStoryView.RefreshInfo = RefreshInfo

UIHeroStarStoryView.OnCloseClick = OnCloseClick
UIHeroStarStoryView.OnBoxClick = OnBoxClick
UIHeroStarStoryView.OnTabClick= OnTabClick
UIHeroStarStoryView.OnRefreshBoxState = OnRefreshBoxState
UIHeroStarStoryView.OnRefreshQuality = OnRefreshQuality
UIHeroStarStoryView.RefreshTabRed = RefreshTabRed
UIHeroStarStoryView.RefreshBoxBtnEffect = RefreshBoxBtnEffect

return UIHeroStarStoryView

