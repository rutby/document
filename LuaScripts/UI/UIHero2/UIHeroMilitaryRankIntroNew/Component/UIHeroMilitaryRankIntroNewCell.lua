---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/2/1 21:44
---


local UIHeroMilitaryRankIntroNewCell = BaseClass("UIHeroMilitaryRankIntroNewCell", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local name_text_path = "NameText"
local military_icon_path = "MilitaryIcon"

local attack_btn_path = "Attr/Attack/AttackIcon"
local defence_btn_path = "Attr/Defence/DefenceIcon"
local troop_btn_path = "Attr/Troop/TroopIcon"

local attack_text_path = "Attr/Attack/AttackText"
local defence_text_path = "Attr/Defence/DefenceText"
local troop_text_path = "Attr/Troop/TroopText"
local power_text_path = "Power/PowerText"

local bg_path = "Cell_BG"

local skill_text_path = "SkillText"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.bg = self:AddComponent(UIImage, bg_path)
    self.military_icon = self:AddComponent(UIImage, military_icon_path)
    
    --self.attack_title = self:AddComponent(UIText, attack_title_path)
    --self.defence_title = self:AddComponent(UIText, defence_title_path)
    --self.troop_title = self:AddComponent(UIText, troop_title_path)
    --self.attack_title:SetLocalText(140310)
    --self.defence_title:SetLocalText(100150)
    --self.troop_title:SetLocalText(130066)

    self.attack_text = self:AddComponent(UITextMeshProUGUIEx, attack_text_path)
    self.defence_text = self:AddComponent(UITextMeshProUGUIEx, defence_text_path)
    self.troop_text = self:AddComponent(UITextMeshProUGUIEx, troop_text_path)
    self.power_text = self:AddComponent(UITextMeshProUGUIEx, power_text_path)

    self.name_text = self:AddComponent(UITextMeshProUGUIEx, name_text_path)
    self.skill_text = self:AddComponent(UITextMeshProUGUIEx, skill_text_path)
    self.attack_btn = self:AddComponent(UIButton, attack_btn_path)
    self.defence_btn = self:AddComponent(UIButton, defence_btn_path)
    self.troop_btn = self:AddComponent(UIButton, troop_btn_path)
    
    self.attack_btn:SetOnClick(function()
        self:OnIconClick("150155", self.attack_btn.transform.position)
    end)
    self.defence_btn:SetOnClick(function()
        self:OnIconClick("220207", self.defence_btn.transform.position)
    end)
    self.troop_btn:SetOnClick(function()
        self:OnIconClick("150182", self.troop_btn.transform.position)
    end)
end

local function ComponentDestroy(self)
    
end

local function SetData(self, data)
    self.data = data

    self.military_icon:LoadSprite(HeroUtils.GetMilitaryRankIcon(data.rankId))
    self.name_text:SetLocalText(HeroUtils.GetMilitaryRankName(data.rankId))

    local level = GetTableData(TableName.HeroMilitaryRank, data.rankId, 'level')
    local curLevel = GetTableData(TableName.HeroMilitaryRank, data.curRank, 'level')
    self.skill_text:SetLocalText(129282, level)
    local troopStr = GetTableData(TableName.HeroMilitaryRank, data.rankId, 'troop')
    local atkStr = GetTableData(TableName.HeroMilitaryRank, data.rankId, 'atk')
    local defStr = GetTableData(TableName.HeroMilitaryRank, data.rankId, 'def')

    local troop = troopStr[data.rarity]
    local atk = atkStr[data.rarity]
    local def = defStr[data.rarity]

    self.attack_text:SetText(string.GetFormattedSeperatorNum(tostring(atk)))
    self.defence_text:SetText(string.GetFormattedSeperatorNum(tostring(def)))
    self.troop_text:SetText(string.GetFormattedSeperatorNum(tostring(troop)))

    local k1 = LuaEntry.DataConfig:TryGetNum("power_setting", "k1")
    local k5 = LuaEntry.DataConfig:TryGetNum("power_setting", "k5")
    if k5 <=0 then
        k5 = 1
    end
    local power = Mathf.Round(Mathf.Pow((toInt(atk) + toInt(def)),k5) * k1)
    self.power_text:SetText(string.GetFormattedSeperatorNum(tostring(power)))

    self:SetCurrentRank(level == curLevel)
end

local function SetCurrentRank(self, isCurrent)
    if isCurrent then
        self.bg:LoadSprite(string.format(LoadPath.HeroDetailPath, "UIhero_rank_preview_bg01_now"))
    else
        self.bg:LoadSprite(string.format(LoadPath.HeroDetailPath, "UIhero_rank_preview_bg02"))
    end
end

local function OnIconClick(self, str, pos)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position =  Vector3.New(pos.x, pos.y - 30 * scaleFactor, 0)

    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString(str)
    param.dir = UIHeroTipView.Direction.BELOW
    param.defWidth = 180
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

UIHeroMilitaryRankIntroNewCell.OnCreate = OnCreate
UIHeroMilitaryRankIntroNewCell.OnDestroy = OnDestroy
UIHeroMilitaryRankIntroNewCell.ComponentDefine = ComponentDefine
UIHeroMilitaryRankIntroNewCell.ComponentDestroy = ComponentDestroy
UIHeroMilitaryRankIntroNewCell.SetData = SetData
UIHeroMilitaryRankIntroNewCell.SetCurrentRank = SetCurrentRank
UIHeroMilitaryRankIntroNewCell.OnIconClick = OnIconClick


return UIHeroMilitaryRankIntroNewCell