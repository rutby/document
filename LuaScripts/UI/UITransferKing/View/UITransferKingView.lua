---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/5/25 12:10
---

local UITransferKing = BaseClass("UITransferKing", UIBaseView)
local base = UIBaseView
local UITransferKingItem = require "UI.UITransferKing.Component.UITransferKingItem"
local Localization = CS.GameEntry.Localization

local return_path = "UICommonPopUpTitle/panel"
local close_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local top_text_path = "Bg/Top/TopText"
local middle_text_path = "Bg/MiddleText"
local bottom_text_path = "Bg/BottomText"
local scroll_path = "Bg/Mask/Scroll"
local content_path = "Bg/Mask/Scroll/Content"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ClearScroll()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.return_btn = self:AddComponent(UIButton, return_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.title_text = self:AddComponent(UIText, title_path)
    self.title_text:SetLocalText(309045)
    self.top_text = self:AddComponent(UIText, top_text_path)
    self.top_text:SetLocalText(309046)
    self.middle_text = self:AddComponent(UIText, middle_text_path)
    self.bottom_text = self:AddComponent(UIText, bottom_text_path)
    self.scroll_go = self:AddComponent(UIBaseContainer, scroll_path)
    self.content_sv = self:AddComponent(GridInfinityScrollView, content_path)
    local OnInitCell = BindCallback(self, self.OnInitCell)
    local OnUpdateCell = BindCallback(self, self.OnUpdateCell)
    local OnDestroyCell = BindCallback(self, self.OnDestroyCell)
    self.content_sv:Init(OnInitCell, OnUpdateCell, OnDestroyCell)
end

local function ComponentDestroy(self)
    
end

local function DataDefine(self)
    self.members = {}
    self.items = {}
end

local function DataDestroy(self)
    
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function OnInitCell(self, go, index)
    local item = self.scroll_go:AddComponent(UITransferKingItem, go)
    self.items[go] = item
end

local function OnUpdateCell(self, go, index)
    index = index + 1
    local item = self.items[go]
    go.name = tostring(index)
    item:SetData(self.members[index], function()
        self:OnItemClick(index)
    end)
end

local function OnDestroyCell(self, go, index)
    
end

local function ClearScroll(self)
    self.scroll_go:RemoveComponents(UITransferKingItem)
    self.content_sv:DestroyChildNode()
end

local function ReInit(self)
    self.members = {}
    for _, member in pairs(DataCenter.AllianceMemberDataManager:GetAllMember()) do
        if LuaEntry.Player.uid ~= member.uid then
            table.insert(self.members, member)
        end
    end
    table.sort(self.members, function(memberA, memberB)
        if memberA.rank ~= memberB.rank then
            return memberA.rank > memberB.rank
        elseif memberA.power ~= memberB.power then
            return memberA.power > memberB.power
        else
            return memberA.uid < memberB.uid
        end
    end)
    self.content_sv:SetItemCount(#self.members)
    self.content_sv:MoveItemByIndex(0, 0)
end

local function OnItemClick(self, index)
    local member = self.members[index]
    UIUtil.ShowMessage(Localization:GetString("250397"), 2, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL, function()
        SFSNetwork.SendMessage(MsgDefines.TransferKing, member.uid)
    end)
end

UITransferKing.OnCreate = OnCreate
UITransferKing.OnDestroy = OnDestroy
UITransferKing.OnEnable = OnEnable
UITransferKing.OnDisable = OnDisable
UITransferKing.ComponentDefine = ComponentDefine
UITransferKing.ComponentDestroy = ComponentDestroy
UITransferKing.DataDefine = DataDefine
UITransferKing.DataDestroy = DataDestroy
UITransferKing.OnAddListener = OnAddListener
UITransferKing.OnRemoveListener = OnRemoveListener

UITransferKing.OnInitCell = OnInitCell
UITransferKing.OnUpdateCell = OnUpdateCell
UITransferKing.OnDestroyCell = OnDestroyCell
UITransferKing.ClearScroll = ClearScroll

UITransferKing.ReInit = ReInit
UITransferKing.OnItemClick = OnItemClick

return UITransferKing