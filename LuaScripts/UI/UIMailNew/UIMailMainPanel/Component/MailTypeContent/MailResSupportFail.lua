---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/14 14:39
---
local MailResSupportFail = BaseClass("MailResSupportFail", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local rapidjson = require "rapidjson"
local MailScoutResourceItem = require "UI.UIMailNew.UIMailMainPanel.Component.MailTypeContent.ScoutType.MailScoutResourceItem"

local mailTitle_path = "UIMailItemTitle/txtMainTitle"
local mailSubTitle_path = "UIMailItemTitle/txtSubTitle"
local mailTime_path = "UIMailItemTitle/txtTime"
local mailDesc_path = "Des"
local resContent_path = "grid"
local resTemplate_path = "grid/resItem"

local function OnCreate(self)
    base.OnCreate(self)
    self.mailTitleN = self:AddComponent(UITextMeshProUGUIEx, mailTitle_path)
    self.mailSubTitleN = self:AddComponent(UITextMeshProUGUIEx, mailSubTitle_path)
    self.mailTimeN = self:AddComponent(UITextMeshProUGUIEx, mailTime_path)
    self.mailDescN = self:AddComponent(UITextMeshProUGUIEx, mailDesc_path)
    self.resContentN = self:AddComponent(UIBaseContainer, resContent_path)
    self.resTemplateN = self:AddComponent(UIBaseContainer, resTemplate_path)
    self.resTemplateN.gameObject:GameObjectCreatePool()
    self.resTemplateN:SetActive(false)
end

local function OnDestroy(self)
    self.mailTitleN = nil
    self.mailSubTitleN = nil
    self.mailTimeN = nil
    self.mailDescN = nil
    self.resContentN = nil
    self.resTemplateN = nil
    base.OnDestroy(self)
end

local function setData(self, mailData)
    self.mailData = mailData

    self.resContentN:RemoveComponents(MailScoutResourceItem)
    self.resTemplateN.gameObject:GameObjectRecycleAll()

    self.mailTitleN:SetText(MailShowHelper.GetMainTitle(self.mailData))
    self.mailSubTitleN:SetText(MailShowHelper.GetMailSubTitle(self.mailData))
    self.mailTimeN:SetText(MailShowHelper.GetRelativeCreateTime(self.mailData))
    

    local contents = rapidjson.decode(self.mailData["contents"])
    local mailObj = contents["obj"]
    if not mailObj then
        return
    end
    
    self.mailDescN:SetLocalText(311075,  mailObj.userName) 
    local list = mailObj.resArr
    if list~=nil then
        for i = 1, table.length(list) do
            --复制基础prefab，每次循环创建一次
            local item = self.resTemplateN.gameObject:GameObjectSpawn(self.resContentN.transform)
            item:SetActive(true)
            item.name = "item"..i
            local cell = self.resContentN:AddComponent(MailScoutResourceItem,item.name)
            cell:RefreshData(list[i])
        end
        EventManager:GetInstance():Broadcast(EventId.ContentLayoutReposition)
    end
end

MailResSupportFail.OnCreate = OnCreate
MailResSupportFail.OnDestroy = OnDestroy
MailResSupportFail.setData = setData
return MailResSupportFail