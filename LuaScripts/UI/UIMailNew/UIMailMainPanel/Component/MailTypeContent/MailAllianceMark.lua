---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/8 17:21
---
local MailAllianceMark = BaseClass("MailAllianceMark", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local rapidjson = require "rapidjson"

local title_path = "UIMailItemTitle/txtMainTitle"
local subTitle_path = "UIMailItemTitle/txtSubTitle"
local time_path = "UIMailItemTitle/txtTime"
local icon_path = "ImageContainer/Image"
local tip_path = "Tip"
local name_path = "Name"
local btn_path = "btnGetReward"
local btnTxt_path = "btnGetReward/txtGetReward"

local function OnCreate(self)
    base.OnCreate(self)
    
    self.titleN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.subTitleN = self:AddComponent(UITextMeshProUGUIEx, subTitle_path)
    self.timeN = self:AddComponent(UITextMeshProUGUIEx, time_path)
    self.iconN = self:AddComponent(UIImage, icon_path)
    self.tipN = self:AddComponent(UITextMeshProUGUIEx, tip_path)
    self.typeNameN = self:AddComponent(UITextMeshProUGUIEx, name_path)
    self.BtnN = self:AddComponent(UIButton, btn_path)
    self.BtnN:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickJumpBtn()
    end)
    self.btnTxtN = self:AddComponent(UITextMeshProUGUIEx, btnTxt_path)
    self.btnTxtN:SetLocalText(110003) 
end

local function OnDestroy(self)
    base.OnDestroy(self)
end

local function setData(self, mailInfo)
    self.mailInfo = mailInfo
    self:ParseContent()
    self:RefreshUI()
end

local function ParseContent(self)
    if self.mailInfo == nil then
        return;
    end
    if string.IsNullOrEmpty(self.mailInfo.contents) then
        return;
    end
    local contentData = rapidjson.decode(self.mailInfo.contents)-- daJson.decode(self.mailInfo.contents)
    local data = contentData["obj"]
    local markInfo = {}
    markInfo.server = data.server
    markInfo.pointId = data.pointId
    markInfo.markName = data.markName
    markInfo.markType = data.markType
    markInfo.name = data.name
    markInfo.rank = data.rank
    self.markInfo = markInfo
end

local function RefreshUI(self)
    local strMainTitle = MailShowHelper.GetMainTitle(self.mailInfo)
    self.titleN:SetText(strMainTitle)
    local strSubTitle = MailShowHelper.GetMailSubTitle(self.mailInfo)
    self.subTitleN:SetText(strSubTitle)
    local strTime = MailShowHelper.GetAbstractCreateTime(self.mailInfo)
    self.timeN:SetText(strTime)
    
    local iconPath = string.format(LoadPath.AllianceMark, AllianceMarkIconName[self.markInfo.markType])
    self.iconN:LoadSprite(iconPath)
    
    local param1 = self.markInfo.rank == 5 and (Localization:GetString("390006") .. ": ") or ""
    local param2 = self.markInfo.name
    local param3 = Localization:GetString(AllianceMarkName[self.markInfo.markType])
    local param4 = ""-- string.IsNullOrEmpty(self.markInfo.markName) and "" or (":" .. self.markInfo.markName)
    if param3 ~= self.markInfo.markName then
        local tempMarkName = string.split(self.markInfo.markName, ";")
        if #tempMarkName == 1 then
            param4 = ": " .. self.markInfo.markName
        else
            param4 = ": " .. Localization:GetString(tempMarkName[2])
        end
    end
    self.tipN:SetLocalText(390815,  param1,  param2,  param3,  param4) 
    
    --local strName = Localization:GetString(AllianceMarkName[self.markInfo.markType])
    --if self.markName and self.markName ~= "" then
    --    strName = strName .. ":" .. self.markName
    --end
    self.typeNameN:SetText("")
end

local function OnClickJumpBtn(self)
    local targetPoint = (self.markInfo.pointId - self.markInfo.pointId % 10) / 10
    self.view.ctrl:OnClickAlMarkBtn(targetPoint, self.markInfo.server)
end


MailAllianceMark.OnCreate = OnCreate
MailAllianceMark.OnDestroy = OnDestroy
MailAllianceMark.setData = setData
MailAllianceMark.OnClickJumpBtn = OnClickJumpBtn
MailAllianceMark.ParseContent = ParseContent
MailAllianceMark.RefreshUI = RefreshUI

return MailAllianceMark