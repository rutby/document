---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 8/12/21 3:35 PM
---
local ReportParseHelper = require "DataCenter.MailData.MailDetailModule.MailDetailReportParseHelper"
local UIMailDetailReportItemContentObj = BaseClass("UIMailDetailReportItemContentObj",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local _cp_txtRoundIdx = "objTitle/txtRoundIdx"
local _cp_txtTotalTroopCnt = "objTitle/txtTotalTroopCnt"
local _cp_txtTotalTroopLost = "objTitle/txtTotalTroopLost"

local _cp_txtSelfName = "Image/objSelf/txtSelfName"
local _cp_txtSelfTroopCnt = "Image/objSelf/txtSelfTroopCnt"
local _cp_txtSelfTroopLost = "Image/objSelf/txtSelfTroopLost"

local _cp_txtOtherName = "Image/objOther/txtOtherName"
local _cp_txtOtherTroopCnt = "Image/objOther/txtOtherTroopCnt"
local _cp_txtOtherTroopLost = "Image/objOther/txtOtherTroopLost"

local _cp_btnShowContent = "Image/btnShowContent"
local _cp_imgClose = "Image/btnShowContent/imgClose"
local _cp_imgOpen = "Image/btnShowContent/imgOpen"

local _cp_txtContent = "Image/txtLayout/txtContent"
local _cp_txtLayout = "Image/txtLayout"
local _cp_root = ""


function UIMailDetailReportItemContentObj:OnCreate()
    base.OnCreate(self)

    self._txtRoundIdx = self:AddComponent(UITextMeshProUGUI, _cp_txtRoundIdx)
    self._txtTotalTroopCnt = self:AddComponent(UITextMeshProUGUI, _cp_txtTotalTroopCnt)
    self._txtTotalTroopLost = self:AddComponent(UITextMeshProUGUI, _cp_txtTotalTroopLost)

    self._txtSelfName = self:AddComponent(UITextMeshProUGUI, _cp_txtSelfName)
    self._txtSelfTroopCnt = self:AddComponent(UITextMeshProUGUI, _cp_txtSelfTroopCnt)
    self._txtSelfTroopLost = self:AddComponent(UITextMeshProUGUI, _cp_txtSelfTroopLost)

    self._txtOtherName = self:AddComponent(UITextMeshProUGUI, _cp_txtOtherName)
    self._txtOtherTroopCnt = self:AddComponent(UITextMeshProUGUI, _cp_txtOtherTroopCnt)
    self._txtOtherTroopLost = self:AddComponent(UITextMeshProUGUI, _cp_txtOtherTroopLost)

    self._btnShowContent = self:AddComponent(UIButton, _cp_btnShowContent)
    self._btnShowContent:SetOnClick(BindCallback(self, self.OnClickShowContent))

    self._imgClose = self:AddComponent(UIImage, _cp_imgClose)
    self._imgOpen = self:AddComponent(UIImage, _cp_imgOpen)
    
    self._txtContent = self:AddComponent(UITextMeshProUGUI, _cp_txtContent)
    self._txtLayout = self:AddComponent(UITextMeshProUGUI, _cp_txtLayout)
    self._root = self:AddComponent(UIBaseContainer, _cp_root)
end

function UIMailDetailReportItemContentObj:SetData( rounddata )
    local roundValue = rounddata["value"] or {}
    local roundIdx = roundValue["index"] or 0
    self._mailId = roundValue["mailId"]
    self.roundIdx = roundIdx
    self.show = roundValue["show"] or false
	local roundIndex = roundValue["roundIdx"] or 0
    self._mailData = self.view.mailInfo--DataCenter.MailDataManager:GetMailInfoById(mailId)
    if (self._mailData == nil) then
        return
    end
    self._roundFight = self._mailData:GetMailExt():GetFightReportByRoundIndex(roundIndex)
    if (self._roundFight == nil) then
        return
    end
    local healthObj = ReportParseHelper:GetHealthByIndex( roundIdx )
    local needExchange = self._mailData:GetMailExt():CheckIfNeedExchange()
    local health_self = {}
    local health_other = {}
    if needExchange == true then
        health_self = healthObj["other"] or {}
        health_other = healthObj["self"] or {}
    else
        health_self = healthObj["self"] or {}
        health_other = healthObj["other"] or {}
    end
    local health_self_cnt = health_self["total"] or 0
    local health_self_demage = health_self["demage"] or 0
    local health_other_cnt = health_other["total"] or 0
    local health_other_demage = health_other["demage"] or 0
    
    self._txtSelfName:SetLocalText(310164) 
    self._txtSelfTroopCnt:SetText(health_self_cnt)
    self._txtSelfTroopLost:SetText(health_self_demage)
    self._txtOtherName:SetLocalText(310165) 
    self._txtOtherTroopCnt:SetText(health_other_cnt)
    self._txtOtherTroopLost:SetText(health_other_demage)
    
    local item = ReportParseHelper:GetInfoByIndex(roundIdx)
    local strMsg = ""
    local LSpecialList = item["SPECIAL_SELF"]
    if (LSpecialList~=nil and #LSpecialList>0) then
        for _, skill in pairs(LSpecialList) do
            strMsg = strMsg .. self:GetLSpecialDesc(skill) .. "\n"
        end
    end
    local RSpecialList = item["SPECIAL_OTHER"]
    if (RSpecialList~=nil and #RSpecialList>0) then
        for _, skill in pairs(RSpecialList) do
            strMsg = strMsg .. self:GetRSpecialDesc(skill) .. "\n"
        end
    end
    local bufflist = item["BUFF"]
    if (not table.IsNullOrEmpty(bufflist)) then
        for _, buff in pairs(bufflist) do
            strMsg = strMsg .. buff:GetDesc() .. "\n"
        end
    end
    local actionlist = item["ACTION"]
    if (not table.IsNullOrEmpty(actionlist)) then
        for _, action in pairs(actionlist) do
            strMsg = strMsg .. action:GetDesc() .. "\n"
        end
    end

    local height = 0
    -- self._root.rectTransform:Set_sizeDelta(674, 150)
    if (self.show) then
        self._txtLayout:SetActive(true)
        self._imgOpen:SetActive(true)
        self._imgClose:SetActive(false)
        self._txtContent:SetText(strMsg)
        height = self._txtContent:GetHeight() + 44
    else
        self._txtLayout:SetActive(false)
        self._imgOpen:SetActive(false)
        self._imgClose:SetActive(true)
        self._txtContent:SetText("")
        height = self._txtContent:GetHeight()
    end
    
    self._root.rectTransform:Set_sizeDelta(674, 150 + height)
    
          
    -- 第几回合
    local nRoundIdx = self:GetRoundIndex()
    self._txtRoundIdx:SetLocalText(100283,  nRoundIdx) 
    
    self._txtTotalTroopCnt:SetLocalText(311058) 
    self._txtTotalTroopLost:SetLocalText(311059) 
end

function UIMailDetailReportItemContentObj:GetRoundIndex()
    local mailData = self.view.mailInfo--DataCenter.MailDataManager:GetMailInfoById(self._mailId)
    if (mailData == nil) then
        return 0
    end
    return self.roundIdx - mailData:GetMailExt():GetStartRound() + 1
end

function UIMailDetailReportItemContentObj:OnClickShowContent()
    local param = {}
    param["index"] = self.roundIdx
    param["action"] = not self.show
    EventManager:GetInstance():Broadcast(EventId.MailDetailReport_ClickItem, param)
end

function UIMailDetailReportItemContentObj:GetSelfName()
    local sBattleType = self._roundFight:GetSelfBattleType()
    if (sBattleType == BattleType.RallyFormation) then
        return self._roundFight:GetOnlySelfAbbr()
    else
        return self._roundFight:GetSelfName()
    end
end

function UIMailDetailReportItemContentObj:GetOtherName()
    local oBattleType = self._roundFight:GetTargetBattleType()
    if (oBattleType == BattleType.RallyFormation) then
        return self._roundFight:GetOnlyTargetAbbr()
    else
        return self._roundFight:GetTargetName()
    end
end
--261008={0}发动了{1}！{2}获得了{3}效果
function UIMailDetailReportItemContentObj:GetLSpecialDesc(skillData)
    local sName = self:GetSelfName()
    local tName = self:GetOtherName()
    tName = eMailDetailTxtColor.Red_Start .."[" .. tName .."]" .. eMailDetailTxtColor.End
    sName = eMailDetailTxtColor.Green_Start .."[" .. sName .."]" .. eMailDetailTxtColor.End
    local skillId = skillData.id or 0
    local skillIdName = GetTableData(TableName.SkillTab,skillId, "name")
    local object = GetTableData(TableName.SkillTab,skillId, "object")
    local skillName = Localization:GetString(skillIdName)
    if (skillIdName == "") then
        skillName = skillName .. "-skillId:" .. tostring(skillId)
    end
    local effectId = skillData.effectId
    local effectName = ""
    local effectValue = ""
    effectName = GetTableData(TableName.EffectNumDesc, effectId, "des")
    effectName = Localization:GetString(effectName)
    local effectNum = tonumber(skillData.numDes)
    if effectNum>0 then
        effectNum = "+"..effectNum
    end
    local effectType = toInt(GetTableData(TableName.EffectNumDesc, effectId, "type"))
    if (effectType == EffectLocalTypeInEffectDesc.Percent) then
        effectValue = effectNum .. "%"
    else
        effectValue = effectNum
    end
    local result = Localization:GetString("261008", sName, skillName, sName, effectName, effectValue)
    if object == "1" then
        result = Localization:GetString("261008", sName, skillName, tName, effectName, effectValue)
    end
    
    return result
end
function UIMailDetailReportItemContentObj:GetRSpecialDesc(skillData)
    local sName = self:GetSelfName()
    local tName = self:GetOtherName()
    tName = eMailDetailTxtColor.Red_Start .."[" .. tName .."]" .. eMailDetailTxtColor.End
    sName = eMailDetailTxtColor.Green_Start .."[" .. sName .."]" .. eMailDetailTxtColor.End
    local skillId = skillData.id or 0
    local skillIdName = GetTableData(TableName.SkillTab,skillId, "name")
    local object = GetTableData(TableName.SkillTab,skillId, "object")
    local skillName = Localization:GetString(skillIdName)
    if (skillIdName == "") then
        skillName = skillName .. "-skillId:" .. tostring(skillId)
    end
    local effectId = skillData.effectId
    local effectName = ""
    local effectValue = ""
    effectName = GetTableData(TableName.EffectNumDesc, effectId, "des")
    effectName = Localization:GetString(effectName)
    local effectNum = tonumber(skillData.numDes)
    if effectNum>0 then
        effectNum = "+"..effectNum
    end
    local effectType = toInt(GetTableData(TableName.EffectNumDesc, effectId, "type"))
    if (effectType == EffectLocalTypeInEffectDesc.Percent) then
        effectValue = effectNum .. "%"
    else
        effectValue = effectNum
    end
    local result = Localization:GetString("261008", tName, skillName, tName, effectName, effectValue)
    if object == "1" then
        result = Localization:GetString("261008", tName, skillName, sName, effectName, effectValue)
    end
    -- return "· "..result
    return result
end

return UIMailDetailReportItemContentObj