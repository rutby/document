---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 8/11/21 9:15 PM
---
local UIMailDetailReportItemTitleObj = BaseClass("UIMailDetailReportItemTitleObj",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local _cp_txtTitle = "objTitle/txtTitle"
local _cp_txtContent = "objContent/txtContent"


function UIMailDetailReportItemTitleObj:OnCreate()
    base.OnCreate(self)
    self.root = self:AddComponent(UIBaseContainer, "")
    self.txtTitle = self:AddComponent(UITextMeshProUGUI, _cp_txtTitle)
    self.txtContent = self:AddComponent(UITextMeshProUGUI, _cp_txtContent)
end

function UIMailDetailReportItemTitleObj:SetData( value )
    local itemType = value["type"]
    local itemValue = value["value"] or {}
    local mailId = itemValue["mailId"] or ""
    local roundIdx = itemValue["roundIdx"] or 0
    self._mailData = self.view.mailInfo--DataCenter.MailDataManager:GetMailInfoById(mailId)
    if (self._mailData == nil) then
        return
    end
    self._roundFight = self._mailData:GetMailExt():GetFightReportByRoundIndex(roundIdx)
    if (self._roundFight == nil) then
        return
    end
    local textH = 0
    if (itemType == eMailDetailItemType.Title_Summary) then
        self:ShowTopSummary(value["value"])
    elseif (itemType == eMailDetailItemType.Title_Self) then
        self:ShowSelfSummary(value["value"])
    elseif (itemType == eMailDetailItemType.Title_Other) then
        self:ShowOtherSummary(value["value"])
    elseif (itemType == eMailDetailItemType.Title_Result) then
        self:ShowResult(value["value"])
    end
    --textH = self.txtContent:GetHeight()
    --textH = textH > 40 and textH + 76 or 110
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.root.rectTransform)
    --
    --self.root.rectTransform:Set_sizeDelta(674, textH)
end

function UIMailDetailReportItemTitleObj:GetSelfName()
    local sBattleType = self._roundFight:GetSelfBattleType()
    if (sBattleType == BattleType.RallyFormation) then
        return self._roundFight:GetOnlySelfAbbr()
    else
        return self._roundFight:GetSelfName()
    end
end

function UIMailDetailReportItemTitleObj:GetOtherName()
    local oBattleType = self._roundFight:GetTargetBattleType()
    if (oBattleType == BattleType.RallyFormation) then
        return self._roundFight:GetOnlyTargetAbbr()
    else
        return self._roundFight:GetTargetName()
    end
end

function UIMailDetailReportItemTitleObj:ShowResult()
    local name = ""
    local totalTroopCnt = 0
    local totalTroopLost = 0
    local battleResult = self._roundFight:GetBattleResult()
    if (battleResult == FightResult.SELF_WIN) then
        name = self:GetSelfName()
        name = eMailDetailTxtColor.Green_Start .. name .. eMailDetailTxtColor.End
        totalTroopCnt = self._roundFight:GetArmyObjAttTotalCnt(eMailSoldierAttr.Total, true)
        totalTroopLost = self._roundFight:GetSoldierAttrDisById(eMailSoldierAttr.Lost, true)
    else
        name = self:GetOtherName()
        name = eMailDetailTxtColor.Red_Start .. name .. eMailDetailTxtColor.End
        totalTroopCnt = self._roundFight:GetArmyObjAttTotalCnt(eMailSoldierAttr.Total, false)
        totalTroopLost = self._roundFight:GetSoldierAttrDisById(eMailSoldierAttr.Lost, false)
    end
    local alive = totalTroopCnt - totalTroopLost
    --self.txtContent:SetLocalText(310163,  name,  alive) 
	self.txtContent:SetText(Localization:GetString("310163", name, alive))
    self.txtTitle:SetLocalText(310162) 
end

function UIMailDetailReportItemTitleObj:ShowTopSummary()
    self.txtTitle:SetLocalText(310156) 
    local strContent = ""
    local sName = self:GetSelfName()
    local oName = self:GetOtherName()
    local sName = eMailDetailTxtColor.Green_Start .. sName .. eMailDetailTxtColor.End
    local oName = eMailDetailTxtColor.Red_Start .. oName .. eMailDetailTxtColor.End
    strContent = Localization:GetString("310157", sName, oName)
    self.txtContent:SetText(strContent)
end

function UIMailDetailReportItemTitleObj:ShowSelfSummary()
    self.txtTitle:SetLocalText(310158) 
    local sName = self:GetSelfName()
    sName = eMailDetailTxtColor.Green_Start .. sName .. eMailDetailTxtColor.End
    local totalTroopCnt = self._roundFight:GetArmyObjAttTotalCnt(eMailSoldierAttr.Total, true)
    local health = self._roundFight:GetTroopHealth(true)
    local strMsg = Localization:GetString("311077", sName, totalTroopCnt, health)
    self.txtContent:SetText(strMsg)
end

function UIMailDetailReportItemTitleObj:ShowOtherSummary()
    self.txtTitle:SetLocalText(310159) 
    local sName = self:GetOtherName()
    sName = eMailDetailTxtColor.Red_Start .. sName .. eMailDetailTxtColor.End
    local health = self._roundFight:GetTroopHealth(false)
    local strMsg = Localization:GetString("311057", sName, health)
    self.txtContent:SetText(strMsg)
end

return UIMailDetailReportItemTitleObj