---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/3/29 16:52
---
local BattleAbbr = require "UI.UIWorldBattleNews.Component.BattleAbbr"
local UIWorldNewsTipsView = BaseClass("UIWorldNewsTipsView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local Screen = CS.UnityEngine.Screen

function UIWorldNewsTipsView:OnCreate()
    base.OnCreate(self)
    local pointId = self:GetUserData()
    self.pointId = tonumber(pointId)
    self.show_pos_obj = self:AddComponent(UIBaseContainer, "showPos")
    self.left_obj = self:AddComponent(UIBaseContainer, "showPos/left")
    self.right_obj = self:AddComponent(UIBaseContainer,  "showPos/right")
    self.top_obj = self:AddComponent(UIBaseContainer, "showPos/top")
    self.bottom_obj = self:AddComponent(UIBaseContainer, "showPos/bottom")

    self.view_obj = self:AddComponent(UIBaseContainer, "Root")
    self.title = self:AddComponent(UITextMeshProUGUIEx,"Root/titleText")
    self.title:SetText(Localization:GetString("302152"))
    self.alliance_des = self:AddComponent(UITextMeshProUGUIEx,"Root/desText")
    self.alliance_des:SetText(Localization:GetString("302145"))
    self.alliance_btn = self:AddComponent(UIButton, "Root/desText/btn_alliance")
    self.alliance_btn:SetOnClick(function()
        self:OnDetailClick()
    end)
    self.empty = self:AddComponent(UITextMeshProUGUIEx,"Root/emptyText")
    self.empty:SetText(Localization:GetString("302156"))
    self.left_abbr = self:AddComponent(BattleAbbr,"Root/allianceContent/abbrA")
    self.right_abbr = self:AddComponent(BattleAbbr,"Root/allianceContent/abbrB")
    self.btn = self:AddComponent(UIButton,"Root/Button")
    self.btn:SetOnClick(function()
        self:OnGotoClick()
    end)
    self.btnPanel = self:AddComponent(UIButton, "panel")
    self.btnPanel:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.btn_txt = self:AddComponent(UITextMeshProUGUIEx,"Root/Button/btnTxt")
    self.btn_txt:SetLocalText(110088)
end

function UIWorldNewsTipsView:OnDestroy()
    self.pointId = nil
    self.view_obj = nil
    self.show_pos_obj = nil
    self.left_obj = nil
    self.right_obj = nil
    self.top_obj = nil
    self.bottom_obj = nil
    self.alliance_des = nil
    self.empty = nil
    self.btn = nil
    self.btn_txt = nil
    base.OnDestroy(self)
end

function UIWorldNewsTipsView:OnAddListener()
    self:AddUIListener(EventId.ChangeCameraLod, self.UpdateLod)
end

function UIWorldNewsTipsView:OnRemoveListener()
    self:RemoveUIListener(EventId.ChangeCameraLod, self.UpdateLod)
end

function UIWorldNewsTipsView:OnEnable()
    base.OnEnable(self)
    CS.SceneManager.World:SetUseInput(true)
    self:SetPosition()
    self:SetData()
end

function UIWorldNewsTipsView:OnDisable()
    base.OnDisable(self)
end

function UIWorldNewsTipsView:SetData()
    local data = self.ctrl:GetAreaData(self.pointId)
    if #data.allianceAbbrList>0 then
        self.empty:SetActive(false)
        self.alliance_btn:SetActive(#data.allianceAbbrList>2)
        if #data.allianceAbbrList>0 then
            local A = data.allianceAbbrList[1]
            self.left_abbr:SetActive(true)
            self.left_abbr:SetText(A)
            if #data.allianceAbbrList>1 then
                local B = data.allianceAbbrList[2]
                self.right_abbr:SetActive(true)
                self.right_abbr:SetText(B)
            else
                self.right_abbr:SetActive(false)
            end
        else
            self.left_abbr:SetActive(false)
            self.right_abbr:SetActive(false)
        end
    else
        self.empty:SetActive(true)
    end
end


function UIWorldNewsTipsView:OnGotoClick()
    local pos = self.pointId
    GoToUtil.GotoWorldPos(SceneUtils.TileIndexToWorld(pos,ForceChangeScene.World), 32,LookAtFocusTime)
    self.view.ctrl:CloseSelf()
end
function UIWorldNewsTipsView:SetPosition()
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local screenPos = CS.SceneManager.World:WorldToScreenPoint(SceneUtils.TileIndexToWorld(self.pointId))
    self.lastPos = screenPos
    local screenCenterPos = Vector3.New(Screen.width/(2*scaleFactor), Screen.height/(2*scaleFactor), 0)
    local deltaX = screenPos.x - screenCenterPos.x
    local deltaY = screenPos.y - screenCenterPos.y
    local absX = math.abs(deltaX)
    local absY = math.abs(deltaY)
    self.left_obj:SetActive(deltaX<=0 and absX>=absY)
    self.right_obj:SetActive(deltaX>0 and absX>=absY)
    self.top_obj:SetActive(deltaY>0 and absX< absY)
    self.bottom_obj:SetActive(deltaY<=0 and absX<absY)
    local rect = self.show_pos_obj.rectTransform.rect
    local verticalOffset = (rect.height/2)
    local horizontalOffset = (rect.width/2)
    local posOffset = Vector3.New(0, 0, 0)
    if self.left_obj:GetActive() then
        posOffset.x = horizontalOffset+70
    elseif self.right_obj:GetActive() then
        posOffset.x = -horizontalOffset-70
    elseif self.top_obj:GetActive() then
        posOffset.y = -verticalOffset-70
    elseif self.bottom_obj:GetActive() then
        posOffset.y = verticalOffset+70
    end
    self.show_pos_obj.transform.position = screenPos
    local anchoredPosition = self.show_pos_obj.rectTransform.anchoredPosition
    local tempAnchoredPosition = Vector2.New(anchoredPosition.x + posOffset.x,anchoredPosition.y + posOffset.y)
    self.show_pos_obj.rectTransform.anchoredPosition = tempAnchoredPosition

    if tempAnchoredPosition.x>0 then
        tempAnchoredPosition.x = math.min(tempAnchoredPosition.x + horizontalOffset,screenCenterPos.x) - horizontalOffset
    else
        tempAnchoredPosition.x = math.max(tempAnchoredPosition.x - horizontalOffset,-screenCenterPos.x) + horizontalOffset
    end

    if tempAnchoredPosition.y>0 then
        tempAnchoredPosition.y = math.min(tempAnchoredPosition.y + verticalOffset,screenCenterPos.y) - verticalOffset
    else
        tempAnchoredPosition.y = math.max(tempAnchoredPosition.y - verticalOffset,-screenCenterPos.y) + verticalOffset
    end
    self.view_obj.rectTransform.anchoredPosition = tempAnchoredPosition
end

function UIWorldNewsTipsView:UpdateLod(lod)
    self.ctrl:CloseSelf()
end
function UIWorldNewsTipsView:OnDetailClick()
    local x = self.alliance_btn.transform.position.x
    local y = self.alliance_btn.transform.position.y
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIWorldNewsAbbrDetail,self.pointId,x,y)
end
return UIWorldNewsTipsView