---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/12/5 12:06
---

local UIDecorationIcons = BaseClass("UIDecorationIcons", UIBaseContainer)
local base = UIBaseContainer
local UIDecorationIconCell = require "UI.UIDecoration.UIDecorationMain.Component.UIDecorationIconCell"
local UIDecorationTittleItem = require "UI.UIDecoration.UIDecorationMain.Component.UIDecorationTittleItem"
local Localization = CS.GameEntry.Localization
local twoColScroll_view_path = "TowColScrollView"
local oneColScroll_view_path = "OneColScrollView"
local unlock_btn_path = "UnlockBtn"
local unlock_btn_text_path = "UnlockBtn/UnlockBtnText"
local unlock_redDot_path = "UnlockBtn/UnlockBtnRedDot"

local remain_time_path = "RemainTime"
local remain_time_text_path = "RemainTime/RemainTimeText"
local remain_time_add_btn_path = "RemainTime/RemainTimeText/RemainTimeAddBtn"
local remain_time_add_btn_redDot_path = "RemainTime/RemainTimeText/RemainTimeAddBtn/RedDotWithoutNum"

local use_btn_path = "UseBtn"
local use_btn_text_path = "UseBtn/UseBtnText"

local in_use_btn_path = "InUseBtn"
local in_use_btn_text_path = "InUseBtn/InUseBtnText"

--创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.twoColScroll_view = self:AddComponent(UIScrollView, twoColScroll_view_path)
    self.twoColScroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateTowColCell(itemObj, index)
    end)
    self.twoColScroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteTwoColCell(itemObj, index)
    end)
    self.oneColScroll_view = self:AddComponent(UIScrollView, oneColScroll_view_path)
    self.oneColScroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateOneColCell(itemObj, index)
    end)
    self.oneColScroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteOneColCell(itemObj, index)
    end)
    self.unlock_btn = self:AddComponent(UIButton, unlock_btn_path)
    self.unlock_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnUnlockClick()
    end)
    self.unlock_redDot = self:AddComponent(UIBaseContainer, unlock_redDot_path)
    self.unlock_redDot:SetActive(false)
    self.btn_text = self:AddComponent(UITextMeshProUGUIEx, unlock_btn_text_path)
    self.btn_text:SetLocalText(130056)
    
    self.remain_time = self:AddComponent(UIBaseContainer, remain_time_path)
    self.remain_time_text = self:AddComponent(UITextMeshProUGUIEx, remain_time_text_path)
    self.remain_time_add_btn = self:AddComponent(UIButton, remain_time_add_btn_path)
    self.remain_time_add_btn_redDot = self:AddComponent(UIImage, remain_time_add_btn_redDot_path)
    self.remain_time_add_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnUnlockClick()
    end)

    self.use_btn = self:AddComponent(UIButton, use_btn_path)
    self.use_btn_text = self:AddComponent(UITextMeshProUGUIEx, use_btn_text_path)
    self.use_btn_text:SetLocalText(110046)
    self.use_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnUseClick()
    end)

    self.timer_action = function(temp)
        self:RefreshRemainTime()
    end

    self.in_use_btn = self:AddComponent(UIButton, in_use_btn_path)
    self.in_use_btn_text = self:AddComponent(UITextMeshProUGUIEx, in_use_btn_text_path)
    self.in_use_btn_text:SetLocalText(129001)
    CS.UIGray.SetGray(self.in_use_btn.transform, true, false)
    self:AddTimer()
end

local function ComponentDestroy(self)
    self:ClearTwoScroll()
    self:ClearOneScroll()
    self:DeleteTimer()
    self.twoColScroll_view = nil
    self.oneColScroll_view = nil
end

local function DataDefine(self)
    self.cells = {}
    self.index = 1
    self.onBtnClick = function(index) 
        self:OnCellBtnClick(index)
    end
end

local function DataDestroy(self)
    self.cells = {}
    self.index = 1
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action, self, false,false,false)
    end

    self.timer:Start()
end

local function SetData(self, dataList, currentSelect, curSelectType, callback, formationUuid)
    self.formationUuid = formationUuid or 0
    self.dataList = dataList
    self.index = self:GetSelectIndexBySkinId(currentSelect)
    self.curSelectType = curSelectType
    self.callback = callback
    self:RefreshScrollView()
    self:RefreshBtn()
    self:RefreshRemainTime()
end

local function RefreshScrollView(self)
    self.cells = {}
    if self.curSelectType == DecorationType.DecorationType_Head_Frame or self.curSelectType == DecorationType.DecorationType_Main_City 
            or self.curSelectType == DecorationType.DecorationType_MarchSkin then
        self.oneColScroll_view:SetActive(false)
        self.twoColScroll_view:SetActive(true)
        self:ClearTwoScroll()
        local count = table.count(self.dataList)
        self.twoColScroll_view:SetTotalCount(count)
        self.twoColScroll_view:RefillCells()
    elseif self.curSelectType == DecorationType.DecorationType_TittleName then
        self.oneColScroll_view:SetActive(true)
        self.twoColScroll_view:SetActive(false)
        self:ClearOneScroll()
        local count = table.count(self.dataList)
        self.oneColScroll_view:SetTotalCount(count)
        self.oneColScroll_view:RefillCells()
    end
end

local function OnCreateTowColCell(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.twoColScroll_view:AddComponent(UIDecorationIconCell, itemObj)

    local param = {}
    param.data = self.dataList[index]
    param.select = index == self.index
    param.onBtnClick = self.onBtnClick
    param.index = index
    cellItem:ReInit(param)
    self.cells[index] = cellItem
end

local function OnDeleteTwoColCell(self,itemObj, index)
    self.cells[index] = nil
    self.twoColScroll_view:RemoveComponent(itemObj.name, UIDecorationIconCell)
end

local function ClearTwoScroll(self)
    self.cells = {}
    self.twoColScroll_view:ClearCells()
    self.twoColScroll_view:RemoveComponents(UIDecorationIconCell)
end

local function OnCreateOneColCell(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.oneColScroll_view:AddComponent(UIDecorationTittleItem, itemObj)
    local param = {}
    param.data = self.dataList[index]
    param.select = index == self.index
    param.onBtnClick = self.onBtnClick
    param.index = index
    cellItem:ReInit(param)
    self.cells[index] = cellItem
end

local function OnDeleteOneColCell(self,itemObj, index)
    self.cells[index] = nil
    self.oneColScroll_view:RemoveComponent(itemObj.name, UIDecorationTittleItem)
end

local function ClearOneScroll(self)
    self.cells = {}
    self.oneColScroll_view:ClearCells()
    self.oneColScroll_view:RemoveComponents(UIDecorationTittleItem)
end

local function OnUnlockClick(self)
    self.view.ctrl:DoWhenClickUnlock(self:GetSelectSkinId())
end

local function RefreshBtn(self)
    local id = self:GetSelectSkinId()
    local data = DataCenter.DecorationDataManager:GetSkinDataById(id)
    local template = DataCenter.DecorationTemplateManager:GetTemplate(id)
    
    local showTime = false
    local showAdd = false
    local showUnlock = true
    local showAddRedDot = false
    if data == nil then
        if template:IsDefault() then
            showTime = true
            showUnlock = false
        end
    else
        if data:IsInExpireTime() then
            showUnlock = false
            showTime = true
        end
        showAdd = data.expireTime > 0
    end

    showAdd = showAdd and template.type_gain ~= DecorationGainType.DecorationGainType_Female
    self.unlock_btn:SetActive(showUnlock)
    local showUnlockRedDot = false
    for k, v in ipairs(self.dataList) do
        if v.id == id then
            showUnlockRedDot = v.showRedPoint
            showAddRedDot = v.showAddRedPoint
            break
        end
    end
    self.unlock_redDot:SetActive(showUnlockRedDot)
    self.remain_time:SetActive(showTime)
    
    self.remain_time_add_btn:SetActive(showAdd)
    self.remain_time_add_btn_redDot:SetActive(showAddRedDot)
    local showUse = false

    if template:IsDefault() then
        local currentUse = DataCenter.DecorationDataManager:GetCurrentSkinByType(template.type, self.formationUuid)
        if currentUse ~= nil and currentUse ~= id then
            if data == nil or not data:IsWear(self.formationUuid) then
                showUse = true
            end
        end
    else
        showUse = data and not data:IsWear(self.formationUuid) and data:IsInExpireTime()
    end
    self.use_btn:SetActive(showUse)
    self.in_use_btn:SetActive(template.id == DataCenter.DecorationDataManager:GetCurrentSkinByType(template.type, self.formationUuid))
end

local function RefreshRemainTime(self)
    if self.remain_time and self.remain_time:GetActive() then
        local id = self:GetSelectSkinId()
        local now = UITimeManager:GetInstance():GetServerTime()
        local template = DataCenter.DecorationTemplateManager:GetTemplate(id)
        local restTimeStr = ""
        local data = DataCenter.DecorationDataManager:GetSkinDataById(id)
        if data ~= nil then
            local restTime = data.expireTime - now
            restTime = math.max(0, restTime)
            restTimeStr = UITimeManager:GetInstance():MilliSecondToFmtString(restTime)
            if data.expireTime <= 0 then
                restTimeStr = Localization:GetString("280098")
            end
        else
            if template:IsDefault() then
                restTimeStr = Localization:GetString("280098")
            end
        end
        self.remain_time_text:SetText(restTimeStr)
    end
end

local function OnUseClick(self)
    local id = self:GetSelectSkinId()
    local template = DataCenter.DecorationTemplateManager:GetTemplate(id)
    if template == nil then
        return
    end
    local lastSex = LuaEntry.Player:GetSex()
    if lastSex ~= SexType.Woman and template.type_gain == DecorationGainType.DecorationGainType_Female then
        UIUtil.ShowTipsId(320608)
        return
    end
    if template:IsDefault() then
        local currentUse = DataCenter.DecorationDataManager:GetCurrentSkinByType(template.type, self.formationUuid)
        if currentUse ~= id then
            DataCenter.DecorationDataManager:TakeOffSkin(currentUse, self.formationUuid)
        end
    else
        DataCenter.DecorationDataManager:WearSkin(id, self.formationUuid)
    end
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function OnUserSkinUpdate(self)
    self:RefreshScrollView()
    self:RefreshBtn()
    self:RefreshRemainTime()
end

function UIDecorationIcons:OnCellBtnClick(index)
    if self.index ~= index then
        self:SetCellSelect(self.index, false)
        self.index = index
        self:SetCellSelect(self.index, true)
        self:RefreshBtn()
        self:RefreshRemainTime()
        if self.callback ~= nil then
            self.callback(self:GetSelectSkinId())
        end
    end
end

function UIDecorationIcons:SetCellSelect(index, select)
    local cell = self.cells[index]
    if cell ~= nil then
        cell:Select(select)
    end
end

function UIDecorationIcons:GetSelectSkinId()
    local data = self.dataList[self.index]
    if data ~= nil then
        return data.id
    end
end

function UIDecorationIcons:GetSelectIndexBySkinId(skinId)
    local result = 1
    if self.dataList ~= nil then
        for k,v in ipairs(self.dataList) do
            if v.id == skinId then
                result = k
                break
            end
        end
    end
    return result
end

function UIDecorationIcons:SetSelectSkinById(skinId, formationUuid, dataList)
    self.dataList = dataList
    self.formationUuid = formationUuid
    local index = self:GetSelectIndexBySkinId(skinId)
    if self.index ~= index then
        self:SetCellSelect(self.index, false)
        self.index = index
        self:SetCellSelect(self.index, true)
        self:RefreshRemainTime()
    end
  
    self:RefreshBtn()
end

UIDecorationIcons.OnUserSkinUpdate = OnUserSkinUpdate
UIDecorationIcons.OnAddListener = OnAddListener
UIDecorationIcons.OnRemoveListener = OnRemoveListener
UIDecorationIcons.RefreshRemainTime = RefreshRemainTime
UIDecorationIcons.RefreshBtn = RefreshBtn
UIDecorationIcons.OnUnlockClick = OnUnlockClick
UIDecorationIcons.RefreshScrollView = RefreshScrollView
UIDecorationIcons.OnDeleteTwoColCell = OnDeleteTwoColCell
UIDecorationIcons.OnCreateTowColCell = OnCreateTowColCell
UIDecorationIcons.ClearTwoScroll = ClearTwoScroll
UIDecorationIcons.OnDeleteOneColCell = OnDeleteOneColCell
UIDecorationIcons.OnCreateOneColCell = OnCreateOneColCell
UIDecorationIcons.ClearOneScroll = ClearOneScroll
UIDecorationIcons.OnCreate = OnCreate
UIDecorationIcons.OnDestroy = OnDestroy
UIDecorationIcons.OnEnable = OnEnable
UIDecorationIcons.OnDisable = OnDisable
UIDecorationIcons.ComponentDefine = ComponentDefine
UIDecorationIcons.ComponentDestroy = ComponentDestroy
UIDecorationIcons.DataDefine = DataDefine
UIDecorationIcons.DataDestroy = DataDestroy
UIDecorationIcons.SetData = SetData
UIDecorationIcons.DeleteTimer = DeleteTimer
UIDecorationIcons.AddTimer = AddTimer
UIDecorationIcons.OnUseClick = OnUseClick
return UIDecorationIcons