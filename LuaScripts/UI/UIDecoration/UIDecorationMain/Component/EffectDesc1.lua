---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/2/10 15:44
---


local EffectDesc1 = BaseClass("EffectDesc1", UIBaseContainer)
local base = UIBaseContainer
local cell = require "UI.UIDecoration.UIDecorationMain.Component.EffectCell"
local quality_path = "QualityBg/QualityText"
local name_path = "NameText"
local use_title_path = "UseTitle"
local use_effect_path = "UseEffect"

local own_title_path = "OwnTitle"
local own_effect_path = "OwnEffect"
local quality_bg_path= "QualityBg"

local prefab_path = "Assets/Main/Prefab_Dir/UI/ActivityCenter/BarterShop/DecoraionEffectCell.prefab"
--创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetAllGetCellDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.quality = self:AddComponent(UITextMeshProUGUIEx, quality_path)
    self.name = self:AddComponent(UITextMeshProUGUIEx, name_path)
    self.use_title = self:AddComponent(UITextMeshProUGUIEx, use_title_path)
    self.use_title:SetLocalText(320564)

    self.use_effect = self:AddComponent(UIBaseContainer, use_effect_path)
    self.own_title = self:AddComponent(UITextMeshProUGUIEx, own_title_path)
    self.own_effect = self:AddComponent(UIBaseContainer, own_effect_path)
    self.own_title:SetLocalText(320565)

    self.quality_bg = self:AddComponent(UIImage, quality_bg_path)
end

local function ComponentDestroy(self)
 
end

local function DataDefine(self)

end

local function DataDestroy(self)

end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ReInit(self, data)
    self.data = data
    self:RefreshView()
end

local function RefreshView(self)
    self.quality:SetText(self.data.quality)
    self.name:SetText(self.data.name)
    self.name:SetColor(self.data.color)
    self.quality_bg:LoadSprite(self.data.qualityBg)
    
    if string.IsNullOrEmpty(self.data.useEffect) then
        self.use_title:SetActive(false)
        self.use_effect:SetActive(false)
    else
        self.use_title:SetActive(true)
        self.use_effect:SetActive(true)
        if self.models1 == nil or not next(self.models1) then
            self.models1 = {}
            for k, v in ipairs(self.data.wearEffects) do
                self.models1[k] = self:GameObjectInstantiateAsync(prefab_path, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.transform:SetParent(self.use_effect.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    go.transform:Set_localPosition(ResetPosition)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local item = self.use_effect:AddComponent(cell, go.name)
                    item:ReInit(v)
                end)
            end
        end
        --self.use_effect:SetText(self.data.useEffect)
    end
    if string.IsNullOrEmpty(self.data.ownEffect) then
        self.own_title:SetActive(false)
        self.own_effect:SetActive(false)
    else
        self.own_title:SetActive(true)
        self.own_effect:SetActive(true)
        --self.own_effect:SetText(self.data.ownEffect)
        if self.models2 == nil or not next(self.models2) then
            self.models2 = {}
            for k, v in ipairs(self.data.ownEffects) do
                self.models2[k] = self:GameObjectInstantiateAsync(prefab_path, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.transform:SetParent(self.own_effect.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    go.transform:Set_localPosition(ResetPosition)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local item = self.own_effect:AddComponent(cell, go.name)
                    item:ReInit(v)
                end)
            end
        end
    end
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.rectTransform)
end

local function SetAllGetCellDestroy(self)
    self.own_effect:RemoveComponents(cell)
    self.use_effect:RemoveComponents(cell)
    if self.models1~=nil then
        for k,v in pairs(self.models1) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    if self.models2~=nil then
        for k,v in pairs(self.models2) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.models1 = nil
    self.models2 = nil
end

EffectDesc1.OnCreate = OnCreate
EffectDesc1.OnDestroy = OnDestroy
EffectDesc1.OnEnable = OnEnable
EffectDesc1.OnDisable = OnDisable
EffectDesc1.ComponentDefine = ComponentDefine
EffectDesc1.ComponentDestroy = ComponentDestroy
EffectDesc1.DataDefine = DataDefine
EffectDesc1.DataDestroy = DataDestroy
EffectDesc1.ReInit = ReInit
EffectDesc1.RefreshView = RefreshView
EffectDesc1.SetAllGetCellDestroy = SetAllGetCellDestroy

return EffectDesc1