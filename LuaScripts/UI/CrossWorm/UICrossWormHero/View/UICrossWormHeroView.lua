---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/23 12:11
---

local UICrossWormHero = BaseClass("UICrossWormHero", UIBaseView)
local base = UIBaseView
local UIHeroCellSmall = require "UI.UIHero2.Common.UIHeroCellSmall"
local Localization = CS.GameEntry.Localization

local return_path = "UICommonPopUpTitle/panel"
local close_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local info_path = "Top/Info"
local name_path = "Top/Name"
local desc_path = "Top/Desc"
local pic_path = "Top/Pic"
local slider_path = "Top/Slider"
local hp_path = "Top/Slider/Hp"
local hero_btn_path = "Bottom/HeroBtn"
local hero_desc_path = "Bottom/HeroDesc"
local hero_path = "Bottom/HeroList/HeroBg%s/Hero%s"
local attack_path = "Bottom/Attack"
local defence_path = "Bottom/Defence"

local HeroCount = 5

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.return_btn = self:AddComponent(UIButton, return_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.title_text = self:AddComponent(UIText, title_path)
    self.title_text:SetLocalText(143599)
    self.info_btn = self:AddComponent(UIButton, info_path)
    self.info_btn:SetOnClick(function()
        self:OnInfoClick()
    end)
    self.name_text = self:AddComponent(UIText, name_path)
    self.name_text:SetLocalText(143599)
    self.desc_text = self:AddComponent(UIText, desc_path)
    self.desc_text:SetLocalText(143650)
    self.pic_image = self:AddComponent(UIImage, pic_path)
    self.slider = self:AddComponent(UISlider, slider_path)
    self.hp_text = self:AddComponent(UIText, hp_path)
    self.hero_btn = self:AddComponent(UIButton, hero_btn_path)
    self.hero_btn:SetOnClick(function()
        self:OnHeroBtnClick()
    end)
    self.hero_desc_text = self:AddComponent(UIText, hero_desc_path)
    self.hero_desc_text:SetLocalText(143655)
    self.heroes = {}
    for i = 1, HeroCount do
        self.heroes[i] = self:AddComponent(UIHeroCellSmall, string.format(hero_path, i, i))
    end
    self.attack_text = self:AddComponent(UIText, attack_path)
    self.defence_text = self:AddComponent(UIText, defence_path)
end

local function ComponentDestroy(self)
    self.return_btn = nil
    self.close_btn = nil
    self.title_text = nil
    self.info_btn = nil
    self.name_text = nil
    self.desc_text = nil
    self.pic_image = nil
    self.slider = nil
    self.hp_text = nil
    self.hero_btn = nil
    self.hero_desc_text = nil
    self.heroes = nil
    self.attack_text = nil
    self.defence_text = nil
end

local function DataDefine(self)
    self.bUuid = 0
    self.buildData = nil
end

local function DataDestroy(self)
    self.bUuid = nil
    self.buildData = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.CrossWormSaveHero, self.OnCrossWormSaveHero)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.CrossWormSaveHero, self.OnCrossWormSaveHero)
    base.OnRemoveListener(self)
end

local function ReInit(self)
    self.bUuid = self:GetUserData()
    self.buildData = DataCenter.BuildManager:GetBuildingDataByUuid(self.bUuid)
    self:Refresh()
end

local function Refresh(self)
    local heroUuids = DataCenter.CrossWormManager:GetDefenceHeroUuids()
    self:ShowHeroes(heroUuids)

    local curHp = self.buildData:GetCurHp()
    local maxHp = self.buildData:GetMaxHp()
    self.slider:SetValue(curHp / maxHp)
    self.hp_text:SetText(string.GetFormattedSeperatorNum(curHp) .. "/" .. string.GetFormattedSeperatorNum(maxHp))
end

local function ShowHeroes(self, heroUuids)
    local atk, def = 0, 0
    for i = 1, HeroCount do
        local heroUuid = heroUuids[i]
        if heroUuid then
            local heroData = DataCenter.HeroDataManager:GetHeroByUuid(heroUuid)
            atk = atk + heroData.atk
            def = def + heroData.def
            self.heroes[i]:SetActive(true)
            self.heroes[i]:SetData(heroUuid)
        else
            self.heroes[i]:SetActive(false)
        end
    end
    self.attack_text:SetText(string.GetFormattedSeperatorNum(atk))
    self.defence_text:SetText(string.GetFormattedSeperatorNum(def))
end

local function GetSelectableHeroUuids(self)
    local heroDataList = DataCenter.HeroDataManager:GetMasterHeroList()
    table.sort(heroDataList, function(heroDataA, heroDataB)
        if heroDataA.rarity ~= heroDataB.rarity then
            return heroDataA.rarity < heroDataB.rarity
        end
        if heroDataA.level ~= heroDataB.level then
            return heroDataA.level > heroDataB.level
        end
        if heroDataA.quality ~= heroDataB.quality then
            return heroDataA.quality > heroDataB.quality
        end
        return heroDataA.heroId < heroDataB.heroId
    end)
    local heroUuids = {}
    for _, heroData in ipairs(heroDataList) do
        table.insert(heroUuids, heroData.uuid)
    end
    return heroUuids
end

local function OnInfoClick(self)
    
end

local function OnHeroBtnClick(self)
    local param = {}
    param.heroUuids = self:GetSelectableHeroUuids()
    param.selectHeroUuids = DataCenter.CrossWormManager:GetDefenceHeroUuids()
    param.alwaysHeroUuids = DataCenter.CrossWormManager:GetDefenceHeroUuids()
    param.onSelect = function(heroUuids)
        self:ShowHeroes(heroUuids)
    end
    param.onHide = function(heroUuids)
        self:ShowHeroes(heroUuids)
        DataCenter.CrossWormManager:SendSaveHero(heroUuids)
    end
    UIUtil.ShowSelectHero(param)
end

local function OnCrossWormSaveHero(self)
    self:Refresh()
end

UICrossWormHero.OnCreate = OnCreate
UICrossWormHero.OnDestroy = OnDestroy
UICrossWormHero.OnEnable = OnEnable
UICrossWormHero.OnDisable = OnDisable
UICrossWormHero.ComponentDefine = ComponentDefine
UICrossWormHero.ComponentDestroy = ComponentDestroy
UICrossWormHero.DataDefine = DataDefine
UICrossWormHero.DataDestroy = DataDestroy
UICrossWormHero.OnAddListener = OnAddListener
UICrossWormHero.OnRemoveListener = OnRemoveListener

UICrossWormHero.ReInit = ReInit
UICrossWormHero.Refresh = Refresh
UICrossWormHero.ShowHeroes = ShowHeroes
UICrossWormHero.GetSelectableHeroUuids = GetSelectableHeroUuids

UICrossWormHero.OnInfoClick = OnInfoClick
UICrossWormHero.OnHeroBtnClick = OnHeroBtnClick

UICrossWormHero.OnCrossWormSaveHero = OnCrossWormSaveHero

return UICrossWormHero