---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/21 17:42
---

local UICrossWormResource = BaseClass("UICrossWormResource", UIBaseContainer)
local base = UIBaseContainer
local UICrossWormLeft = require "UI.CrossWorm.UICrossWorm.Component.UICrossWormLeft"
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local Localization = CS.GameEntry.Localization

local top_path = "Top"
local top_desc_path = "Top/TopDesc"
local top_info_path = "Top/TopDesc/TopInfo"
local reward_path = "Top/RewardList/Reward%s"
local reward_icon_path = "Top/RewardList/Reward%s/RewardIcon%s"
local reward_count_path = "Top/RewardList/Reward%s/RewardCount%s"
local plunder_btn_path = "Top/Plunder"
local plunder_text_path = "Top/Plunder/PlunderText"

local mid_path = "Mid"
local mid_desc_path = "Mid/MidDesc"
local mid_info_path = "Mid/MidDesc/MidInfo"
local slider_path = "Mid/Slider"
local time_path = "Mid/Slider/Time"
local transport_btn_path = "Mid/Transport"
local transport_text_path = "Mid/Transport/TransportText"

local bottom_path = "Bottom"
local bottom_desc_path = "Bottom/Viewport/Content/BottomDesc"

local left_path = "UICrossWormLeft"

local RewardCount = 4

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.top_go = self:AddComponent(UIBaseContainer, top_path)
    self.mid_go = self:AddComponent(UIBaseContainer, mid_path)
    self.bottom_go = self:AddComponent(UIBaseContainer, bottom_path)
    self.left = self:AddComponent(UICrossWormLeft, left_path)
    self.top_desc_text = self:AddComponent(UIText, top_desc_path)
    self.top_desc_text:SetLocalText(143643)
    self.mid_desc_text = self:AddComponent(UIText, mid_desc_path)
    self.mid_desc_text:SetLocalText(143644)
    self.bottom_desc_text = self:AddComponent(UIText, bottom_desc_path)
    self.bottom_desc_text:SetLocalText(143645)
    self.reward_goes = {}
    self.reward_icon_images = {}
    self.reward_count_texts = {}
    for i = 1, RewardCount do
        self.reward_goes[i] = self:AddComponent(UIBaseContainer, string.format(reward_path, i))
        self.reward_icon_images[i] = self:AddComponent(UIImage, string.format(reward_icon_path, i, i))
        self.reward_count_texts[i] = self:AddComponent(UIText, string.format(reward_count_path, i, i))
    end
    self.top_info_btn = self:AddComponent(UIButton, top_info_path)
    self.top_info_btn:SetOnClick(function()
        self:OnTopInfoClick()
    end)
    self.mid_info_btn = self:AddComponent(UIButton, mid_info_path)
    self.mid_info_btn:SetOnClick(function()
        self:OnMidInfoClick()
    end)
    self.slider = self:AddComponent(UISlider, slider_path)
    self.time_text = self:AddComponent(UIText, time_path)
    self.plunder_btn = self:AddComponent(UIButton, plunder_btn_path)
    self.plunder_btn:SetOnClick(function()
        self:OnPlunderClick()
    end)
    self.plunder_text = self:AddComponent(UIText, plunder_text_path)
    self.plunder_text:SetLocalText(110036)
    self.transport_btn = self:AddComponent(UIButton, transport_btn_path)
    self.transport_btn:SetOnClick(function()
        self:OnTransportClick()
    end)
    self.transport_text = self:AddComponent(UIText, transport_text_path)
    self.transport_text:SetLocalText(110036)
end

local function ComponentDestroy(self)
    self.top_go = nil
    self.mid_go = nil
    self.bottom_go = nil
    self.left = nil
    self.top_desc_text = nil
    self.mid_desc_text = nil
    self.bottom_desc_text = nil
    self.reward_goes = nil
    self.reward_icon_images = nil
    self.reward_count_texts = nil
    self.top_info_btn = nil
    self.mid_info_btn = nil
    self.slider = nil
    self.time_text = nil
    self.plunder_btn = nil
    self.plunder_text = nil
    self.transport_btn = nil
    self.transport_text = nil
end

local function DataDefine(self)
    self.buildData = nil
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.TimerAction, self, false, false, false)
        self.timer:Start()
    end
    self.isTransporting = false
end

local function DataDestroy(self)
    self.buildData = nil
    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end
    self.isTransporting = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.CrossWormPlunderUpdate, self.OnCrossWormPlunderUpdate)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.CrossWormPlunderUpdate, self.OnCrossWormPlunderUpdate)
    base.OnRemoveListener(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:Refresh()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function Refresh(self)
    self.buildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.WORM_HOLE_CROSS)
    
    local plunderData = DataCenter.CrossWormManager:GetPlunderData()
    local previewList = plunderData:GetPreviewList()
    for i = 1, RewardCount do
        self.reward_icon_images[i]:LoadSprite(previewList[i].icon)
        self.reward_count_texts[i]:SetText(string.GetFormattedStr(previewList[i].count))
        CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.reward_count_texts[i].rectTransform)
    end
    self.isTransporting = not plunderData:IsEmpty()
    self:TimerAction()
end

local function TimerAction(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local lastTime = DataCenter.CrossWormManager:GetTransportLastTime()
    local interval = DataCenter.CrossWormManager:GetTransportInterval()
    local nextTime = lastTime + interval
    if self.isTransporting and curTime >= lastTime and curTime <= nextTime then
        local usedTime = curTime - lastTime
        local restTime = nextTime - curTime
        local restTimeStr = UITimeManager:GetInstance():MilliSecondToFmtString(restTime)
        self.time_text:SetText(restTimeStr)
        self.slider:SetValue(usedTime / interval)
        self.mid_go:SetActive(true)
    else
        self.time_text:SetText("")
        self.slider:SetValue(0)
        self.mid_go:SetActive(false)
    end
end

local function OnTopInfoClick(self)
    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString("143659")
    param.dir = UIHeroTipView.Direction.BELOW
    param.defWidth = 300
    param.pivot = 0.5
    param.position = self.top_info_btn.transform.position + Vector3.New(0, -15, 0)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

local function OnMidInfoClick(self)
    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString("143660", DataCenter.CrossWormManager:GetTransportWeight())
    param.dir = UIHeroTipView.Direction.BELOW
    param.defWidth = 300
    param.pivot = 0.5
    param.position = self.mid_info_btn.transform.position + Vector3.New(0, -15, 0)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

local function OnPlunderClick(self)
    if self.buildData == nil then
        UIUtil.ShowTipsId(104273)
        return
    end
    
    local plunderData = DataCenter.CrossWormManager:GetPlunderData()
    local rewardList = plunderData:GetRewardList()
    UIManager:GetInstance():OpenWindow(UIWindowNames.UICrossWormItemList, { anim = true }, rewardList)
end

local function OnTransportClick(self)
    if self.buildData == nil then
        UIUtil.ShowTipsId(104273)
        return
    end
    
    local plunderData = DataCenter.CrossWormManager:GetTransportPlunderData()
    local rewardList = plunderData:GetRewardList()
    local previewList = plunderData:GetPreviewList()
    UIManager:GetInstance():OpenWindow(UIWindowNames.UICrossWormItemList, { anim = true }, rewardList, previewList)
end

local function OnCrossWormPlunderUpdate(self)
    self:Refresh()
end

UICrossWormResource.OnCreate = OnCreate
UICrossWormResource.OnDestroy = OnDestroy
UICrossWormResource.ComponentDefine = ComponentDefine
UICrossWormResource.ComponentDestroy = ComponentDestroy
UICrossWormResource.DataDefine = DataDefine
UICrossWormResource.DataDestroy = DataDestroy
UICrossWormResource.OnAddListener = OnAddListener
UICrossWormResource.OnRemoveListener = OnRemoveListener
UICrossWormResource.OnEnable = OnEnable
UICrossWormResource.OnDisable = OnDisable

UICrossWormResource.Refresh = Refresh
UICrossWormResource.TimerAction = TimerAction

UICrossWormResource.OnTopInfoClick = OnTopInfoClick
UICrossWormResource.OnMidInfoClick = OnMidInfoClick
UICrossWormResource.OnPlunderClick = OnPlunderClick
UICrossWormResource.OnTransportClick = OnTransportClick

UICrossWormResource.OnCrossWormPlunderUpdate = OnCrossWormPlunderUpdate

return UICrossWormResource