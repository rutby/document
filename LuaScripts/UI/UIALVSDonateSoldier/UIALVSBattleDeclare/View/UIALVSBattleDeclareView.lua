---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/1 14:45
---

local UIALVSBattleDeclare = BaseClass("UIALVSBattleDeclare", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local UIALVSBattleDeclareItem = require "UI.UIALVSDonateSoldier.UIALVSBattleDeclare.Component.UIALVSBattleDeclareItem"
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"

local return_path = "UICommonPopUpTitle/panel"
local close_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local rank_path = "Top/Rank"
local rank_icon_path = "Top/RankIcon"
local left_alliance_name_path = "Top/LeftAllianceName"
local left_power_path = "Top/LeftPower"
local left_score_path = "Top/LeftScore"
local left_alliance_flag_path = "Top/LeftAllianceFlag"
local right_desc_path = "Top/RightDesc"
local match_btn_path = "Match"
local match_text_path = "Match/MatchText"
local scroll_view_path = "ScrollView"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    --请求列表信息
    self:SetSelfAllianceInfo()
    DataCenter.ActivityALVSDonateSoldierManager:SendGetALVSDonateArmyDeclareWarListMessage()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.return_btn = self:AddComponent(UIButton, return_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.title_text = self:AddComponent(UIText, title_path)
    self.rank_text = self:AddComponent(UIText, rank_path)
    self.rank_icon_image = self:AddComponent(UIImage, rank_icon_path)
    self.left_alliance_name_text = self:AddComponent(UIText, left_alliance_name_path)
    self.left_power_text = self:AddComponent(UIText, left_power_path)
    self.left_score_text = self:AddComponent(UIText, left_score_path)
    self.left_alliance_flag = self:AddComponent(AllianceFlagItem, left_alliance_flag_path)
    self.right_desc_text = self:AddComponent(UIText, right_desc_path)
    self.match_btn = self:AddComponent(UIButton, match_btn_path)
    self.match_btn:SetOnClick(function()
        self:OnMatchClick()
    end)
    self.match_text = self:AddComponent(UIText, match_text_path)
    self.match_text:SetLocalText(302839)
    self.scroll_view = self:AddComponent(UIScrollView, scroll_view_path)
    self.scroll_view:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateCell(itemObj, index)
    end)
    self.scroll_view:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteCell(itemObj, index)
    end)
end

local function ComponentDestroy(self)
    self.return_btn = nil
    self.close_btn = nil
    self.title_text = nil
    self.scroll_view = nil
end

local function DataDefine(self)
    self.allianceData = nil
    self.warData = nil
    self.dataList = {}
end

local function DataDestroy(self)
    self.allianceData = nil
    self.warData = nil
    self.dataList = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.ALVSDeclareAllianceListReturn, self.OnGloryGetDeclareAlliance)
    self:AddUIListener(EventId.PushALVSMatchSuccessReturn, self.OnDeclareComplete)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.ALVSDeclareAllianceListReturn, self.OnGloryGetDeclareAlliance)
    self:RemoveUIListener(EventId.PushALVSMatchSuccessReturn, self.OnDeclareComplete)
    base.OnRemoveListener(self)
end

local function OnCreateCell(self, itemObj, index)
    itemObj.name = tostring(index)
    local item = self.scroll_view:AddComponent(UIALVSBattleDeclareItem, itemObj)
    item:SetData(self.dataList[index])
end

local function OnDeleteCell(self, itemObj, index)
    self.scroll_view:RemoveComponent(itemObj.name, UIALVSBattleDeclareItem)
end

local function ShowScroll(self)
    local count = #self.dataList
    if count > 0 then
        self.scroll_view:SetActive(true)
        self.scroll_view:SetTotalCount(count)
        self.scroll_view:RefillCells()
    else
        self.scroll_view:SetActive(false)
    end
end

local function SetSelfAllianceInfo(self)
    local allianceData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
    local warData = DataCenter.GloryManager:GetWarData()
    self.allianceData = allianceData
    self.warData = warData
    if warData.seasonRank <= 3 then
        self.rank_text:SetActive(false)
        self.rank_icon_image:SetActive(true)
        self.rank_icon_image:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg0" .. warData.seasonRank)
    else
        self.rank_text:SetActive(true)
        self.rank_text:SetText(warData.seasonRank)
        self.rank_icon_image:SetActive(false)
    end
    self.left_alliance_name_text:SetText(UIUtil.GetAllianceWholeName(allianceData.ownerServerId, allianceData.abbr, allianceData.allianceName))
    self.left_power_text:SetText(string.GetFormattedSeperatorNum(allianceData.fightPower))
    self.left_score_text:SetText(string.GetFormattedSeperatorNum(warData.seasonScore))
    self.left_alliance_flag:SetData(allianceData.icon)
    self.right_desc_text:SetText("")
end

local function Refresh(self)
    self.dataList = DataCenter.ActivityALVSDonateSoldierManager:GetDeclareAllianceArr()
    if self.dataList ~= nil then
        self:ShowScroll()
    end
end

-- 随机匹配按钮
local function OnMatchClick(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIALVSBattleRandomMatch, { anim = true})
end

local function OnGloryGetDeclareAlliance(self)
    self:Refresh()
end

-- 宣战完成 关闭界面
local function OnDeclareComplete(self)
    self.ctrl:CloseSelf()
end

UIALVSBattleDeclare.OnCreate = OnCreate
UIALVSBattleDeclare.OnDestroy = OnDestroy
UIALVSBattleDeclare.OnEnable = OnEnable
UIALVSBattleDeclare.OnDisable = OnDisable
UIALVSBattleDeclare.ComponentDefine = ComponentDefine
UIALVSBattleDeclare.ComponentDestroy = ComponentDestroy
UIALVSBattleDeclare.DataDefine = DataDefine
UIALVSBattleDeclare.DataDestroy = DataDestroy
UIALVSBattleDeclare.OnAddListener = OnAddListener
UIALVSBattleDeclare.OnRemoveListener = OnRemoveListener

UIALVSBattleDeclare.OnCreateCell = OnCreateCell
UIALVSBattleDeclare.OnDeleteCell = OnDeleteCell
UIALVSBattleDeclare.SetSelfAllianceInfo = SetSelfAllianceInfo
UIALVSBattleDeclare.ShowScroll = ShowScroll
UIALVSBattleDeclare.Refresh = Refresh

UIALVSBattleDeclare.OnMatchClick = OnMatchClick

UIALVSBattleDeclare.OnGloryGetDeclareAlliance = OnGloryGetDeclareAlliance
UIALVSBattleDeclare.OnDeclareComplete = OnDeclareComplete

return UIALVSBattleDeclare