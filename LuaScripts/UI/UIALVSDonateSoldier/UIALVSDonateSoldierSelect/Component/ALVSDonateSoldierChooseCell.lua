---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/7/8 20:53
---
local DonateSoldierChooseCell = BaseClass("DonateSoldierChooseCell",UIBaseContainer)
local base = UIBaseContainer

local input_path = "InputField"
local slider_path = "Slider"
local icon_path = "soldierIcon"
local level_path = "levelTxt"
local solider_name_path = "soldierName"

local function OnCreate(self)
    base.OnCreate(self)
    self.input = self:AddComponent(UIInput,input_path)
    self.input:SetText(0)
    self.input:SetOnEndEdit(function (value)
        self:IptOnValueChange(value)
    end)
    self.slider = self:AddComponent(UISlider,slider_path)
    self.slider:SetValue(0)
    self.slider:SetOnValueChanged(function (value)
        self:OnValueChange(value)
    end)
    self.icon = self:AddComponent(UIImage,icon_path)
    self.level = self:AddComponent(UIText,level_path)
    self.solider_name = self:AddComponent(UIText,solider_name_path)
end

local function OnDestroy(self)
    self.input = nil
    self.slider = nil
    self.icon = nil
    self.level = nil
    self.solider_name= nil
    base.OnDestroy(self)
end

local function InitData(self, armyId, reachMaxCheckFunc)
    self.armyId = armyId
    self.data = self.view.ctrl:GetArmyData(self.armyId)
    self.icon:LoadSprite(self.data.icon)
    local maxNum = 0
    if self.data.maxNum ~= nil then
        maxNum = self.data.maxNum
    end
    self.maxNum = maxNum
    self.level:SetText(self.data.level)
    self.solider_name:SetText(self.data.name)
    self:RefreshData()
    self.reachMaxCheckFunc = reachMaxCheckFunc
end
local function RefreshData(self)
    self.curNum = self.view.ctrl:GetCurrentSoldierNum(self.armyId)
    local percent = self.curNum/math.max(1,self.maxNum)
    self.slider:SetValue(percent)
end


local function OnValueChange(self,val)
    local cnt = math.floor(val * self.maxNum +0.5)
    cnt = self.view.ctrl:CheckMax(self.armyId, cnt)

    if self.view.ctrl.CheckCurrArmyDonateScoreReachMaxLimit then
        local reachLimit, donateCnt = self.view.ctrl:CheckCurrArmyDonateScoreReachMaxLimit(self.armyId, cnt)
        cnt = donateCnt
        if self.reachMaxCheckFunc then
            self.reachMaxCheckFunc(reachLimit)
        end
    end

    self.input:SetText(string.GetFormattedSeperatorNum(math.floor(cnt)))
    self.curNum = cnt
    self.view.ctrl:SetCurrentSoldierNum(self.armyId,cnt)
    self.view:UpdateViewState()
    local percent = cnt/(math.max(1,self.maxNum))
    self.slider:SetValue(percent)
end

local function IptOnValueChange(self,value)
    local cnt = tonumber(value)
    
    local reachLimit, donateCnt = self.view.ctrl:CheckCurrArmyDonateScoreReachMaxLimit(self.armyId, cnt)
    cnt = donateCnt
    if self.reachMaxCheckFunc then
        self.reachMaxCheckFunc(reachLimit)
    end
    
    cnt = self.view.ctrl:CheckMax(self.armyId, cnt)
    cnt = math.floor(cnt+0.5)
    local percent = cnt/(math.max(1,self.maxNum))
    self.slider:SetValue(percent)
end


DonateSoldierChooseCell.OnCreate= OnCreate
DonateSoldierChooseCell.OnDestroy = OnDestroy
DonateSoldierChooseCell.InitData= InitData
DonateSoldierChooseCell.RefreshData = RefreshData
DonateSoldierChooseCell.OnValueChange= OnValueChange
DonateSoldierChooseCell.IptOnValueChange= IptOnValueChange

return DonateSoldierChooseCell