---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2022/1/25 15:38
---

local UIComplexTipItem = BaseClass("UIComplexTipItem", UIBaseContainer)
local base = UIBaseContainer
local UIHeroCellSmall = require "UI.UIHero2.Common.UIHeroCellSmall"
local ResourceManager = CS.GameEntry.Resource

local this_path = ""
local bg_path = "Bg"
local content_path = "Bg/Content"

local ITEM_POS_Y = 195
local ITEM_MOVE_Y = 80
local PrefabPath =
{
    [ComplexTipType.Text] = "Assets/Main/Prefabs/UI/UIComplexTip/UIComplexTipItemText.prefab",
    [ComplexTipType.Hero] = "Assets/Main/Prefabs/UI/UIComplexTip/UIComplexTipItemHero.prefab",
    [ComplexTipType.Image] = "Assets/Main/Prefabs/UI/UIComplexTip/UIComplexTipItemImage.prefab",
}

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.canvas_group = self:AddComponent(UICanvasGroup, this_path)
    self.bg_go = self:AddComponent(UIBaseContainer, bg_path)
    self.content_go = self:AddComponent(UIBaseContainer, content_path)
end

local function ComponentDestroy(self)
    self.content_go:RemoveComponents(UIBaseComponent)
    for _, req in pairs(self.reqDict) do
        req:Destroy()
    end
    
    self.canvas_group = nil
    self.bg_go = nil
    self.content_go = nil
end

local function DataDefine(self)
    self.tipInfo = nil
    self.reqDict = {}
end

local function DataDestroy(self)
    self.tipInfo = nil
    self.reqDict = nil
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function SetTipInfo(self, tipInfo)
    self.tipInfo = tipInfo
    self.bg_go.rectTransform:Set_sizeDelta(tipInfo.width, tipInfo.height)
    for i, content in ipairs(self.tipInfo.content) do
        local req = ResourceManager:InstantiateAsync(PrefabPath[content.type])
        req:completed('+', function()
            if req.isError then
                return
            end

            local name = tostring(i)
            self.reqDict[name] = req

            local go = req.gameObject
            go:SetActive(true)
            go.transform:SetParent(self.content_go.transform)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go.name = name

            if content.type == ComplexTipType.Text then
                local text = self.content_go:AddComponent(UIText, name)
                text:SetText(content.str)
            elseif content.type == ComplexTipType.Hero then
                local hero = self.content_go:AddComponent(UIHeroCellSmall, name .. "/Hero")
                hero:SetData(content.heroUuid)
            elseif content.type == ComplexTipType.Image then
                local image = self.content_go:AddComponent(UIImage, name)
                image:LoadSprite(content.path)
            end

            CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(go.transform)
        end)
    end
end

local function DoAnim(self, callback)
    self.canvas_group:SetAlpha(0)
    self.rectTransform:Set_anchoredPosition(0, ITEM_POS_Y - ITEM_MOVE_Y)
    DOTween:Sequence()
    :Append(self.canvas_group.unity_canvas_group:DOFade(1, self.tipInfo.fadeDuration))
    :Join(self.rectTransform:DOAnchorPosY(ITEM_POS_Y, self.tipInfo.fadeDuration))
    :AppendInterval(self.tipInfo.duration)
    :Append(self.canvas_group.unity_canvas_group:DOFade(0, self.tipInfo.fadeDuration))
    :Join(self.rectTransform:DOAnchorPosY(ITEM_POS_Y + ITEM_MOVE_Y, self.tipInfo.fadeDuration))
    :AppendCallback(callback)
end

UIComplexTipItem.OnCreate= OnCreate
UIComplexTipItem.OnDestroy = OnDestroy
UIComplexTipItem.ComponentDefine = ComponentDefine
UIComplexTipItem.ComponentDestroy = ComponentDestroy
UIComplexTipItem.DataDefine = DataDefine
UIComplexTipItem.DataDestroy = DataDestroy
UIComplexTipItem.OnEnable = OnEnable
UIComplexTipItem.OnDisable = OnDisable

UIComplexTipItem.SetTipInfo = SetTipInfo
UIComplexTipItem.DoAnim = DoAnim

return UIComplexTipItem