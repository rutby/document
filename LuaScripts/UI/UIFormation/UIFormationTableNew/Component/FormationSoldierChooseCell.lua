---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/7/8 20:53
---
local FormationSoldierChooseCell = BaseClass("FormationSoldierChooseCell",UIBaseContainer)
local base = UIBaseContainer

local input_path = "InputField"
local slider_path = "Slider"
local icon_path = "soldierIcon"
local level_path = "soldierIcon/UISoldier_img_levelbg/levelTxt"
local solider_name_path = "soldierName"

local function OnCreate(self)
    base.OnCreate(self)
    self.input = self:AddComponent(UITMPInput,input_path)
    self.input:SetText(0)
    self.input:SetOnEndEdit(function (value)
        self:IptOnValueChange(value)
    end)
    self.slider = self:AddComponent(UISlider,slider_path)
    self.slider:SetValue(0)
    self.slider:SetOnValueChanged(function (value)
        self:OnValueChange(value)
    end)
    self.icon = self:AddComponent(UIImage,icon_path)
    self.level = self:AddComponent(UITextMeshProUGUIEx,level_path)
    self.solider_name = self:AddComponent(UITextMeshProUGUIEx,solider_name_path)
end

local function OnDestroy(self)
    self.input = nil
    self.slider = nil
    self.icon = nil
    self.level = nil
    self.solider_name= nil
    base.OnDestroy(self)
end

local function InitData(self,armyId)
    self.armyId = armyId
    self.data = self.view.ctrl:GetArmyData(self.armyId)
    self.icon:LoadSprite(self.data.icon)
    local maxNum = 0
    if self.data.maxNum ~= nil then
        maxNum = self.data.maxNum
    end
    self.maxNum = maxNum
    local template = DataCenter.ArmyTemplateManager:GetArmyTemplate(self.armyId)
    if template ~= nil then
        self.level:SetText(RomeNum[template.show_level])
    else
        self.level:SetText(self.data.level)
    end
    self.solider_name:SetText(self.data.name)
    self:RefreshData()
end
local function RefreshData(self)
    self.curNum = self.view.ctrl:GetCurrentSoldierNum(self.armyId)
    local percent = self.curNum/math.max(1,self.maxNum)
    self.slider:SetValue(percent)
end


local function OnValueChange(self,val)
    local cnt = math.floor(val * self.maxNum +0.5)
    cnt = self.view.ctrl:CheckMax(self.armyId, cnt)
    self.input:SetText(string.GetFormattedSeperatorNum(math.floor(cnt)))
    self.curNum = cnt
    self.view.ctrl:SetCurrentSoldierNum(self.armyId,cnt)
    self.view:UpdateViewState()
    local percent = cnt/(math.max(1,self.maxNum))
    self.slider:SetValue(percent)
end
local function IptOnValueChange(self,value)
    local cnt = tonumber(value)
    cnt = self.view.ctrl:CheckMax(self.armyId, cnt)
    cnt = math.floor(cnt+0.5)
    local percent = cnt/(math.max(1,self.maxNum))
    self.slider:SetValue(percent)
end


FormationSoldierChooseCell.OnCreate= OnCreate
FormationSoldierChooseCell.OnDestroy = OnDestroy
FormationSoldierChooseCell.InitData= InitData
FormationSoldierChooseCell.RefreshData = RefreshData
FormationSoldierChooseCell.OnValueChange= OnValueChange
FormationSoldierChooseCell.IptOnValueChange= IptOnValueChange

return FormationSoldierChooseCell