---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/9/16 15:04
---
local FormationCreateTipNew = BaseClass("FormationCreateTipNew", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local des_txt_path ="bg/desTxt"
local create_btn_path ="enterBtn"
local create_txt_path = "enterBtn/enterText"
local back_toggle_path = "backToggle"
local back_toggle_txt_path = "backToggle/backToggle_txt"
local arrow_path = "common_img_tipsarrow"
local function OnCreate(self)
    base.OnCreate(self)
    self.arrow = self:AddComponent(UIBaseContainer,arrow_path)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx, des_txt_path)
    self.des_txt:SetLocalText(GameDialogDefine.CREATE_ARMY_FORMATION) 
    self.create_txt = self:AddComponent(UITextMeshProUGUIEx, create_txt_path)
    self.create_btn = self:AddComponent(UIButton, create_btn_path)
    self.create_btn:SetOnClick(function ()
        self:OnEditClick()
    end)
    self.back_toggle = self:AddComponent(UIToggle, back_toggle_path)
    self.back_toggle:SetIsOn(true)
    self.back_toggle_txt = self:AddComponent(UITextMeshProUGUIEx,back_toggle_txt_path)
    self.back_toggle_txt:SetLocalText(104309)
    self.autoBackHome = MarchUtil.GetAutoBackHomeState(self.view.ctrl.targetType) --1自动返回，0为留在原地
    self.back_toggle:SetIsOn(self.autoBackHome ==1)
    self.back_toggle:SetOnValueChanged(function()
        self:ToggleControlBorS()
    end)
    self.showLackStamina = nil
end

local function OnDestroy(self)
    self.des_txt = nil
    self.btn_txt = nil
    self.enter_btn = nil
    self.showLackStamina = nil
    base.OnDestroy(self)
end
local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end
 
local function RefreshData(self,posX,posY,formationData)
    if self.view.ctrl.targetType == MarchTargetType.ATTACK_DESERT or self.view.ctrl.targetType == MarchTargetType.ATTACK_ARMY or self.view.ctrl.targetType == MarchTargetType.TRAIN_DESERT or self.view.ctrl.targetType == MarchTargetType.ATTACK_MONSTER  then
        self.back_toggle:SetActive(true)
    else
        self.back_toggle:SetActive(false)
    end
    self.uuid =  formationData.uuid
    self.index = formationData.index
    self:SetPosition(posX,posY)
    --self.data = data
    --if self.uuid~=nil then
    --    local time = self.view:GetTimeInFormation(self.uuid)
    --    self:RefreshTimeByUuid(self.uuid,time)
    --end
    self:RefreshStaminaState()
    self:RefreshEditBtnText()
end

local function ToggleControlBorS(self)
    local autoBackHome =1
    if self.back_toggle:GetIsOn() then
        autoBackHome =1
    else
        autoBackHome = 0
    end
    if self.autoBackHome~=autoBackHome then
        if autoBackHome ==1 then
            UIUtil.ShowTipsId(104310)
        else
            UIUtil.ShowTipsId(104311)
        end
        self.autoBackHome = autoBackHome
    end
    MarchUtil.SetAutoBackHomeState(self.view.ctrl.targetType,self.autoBackHome)
    self.view.ctrl:RefreshAutoBack()
end

local function OnEditClick(self)
    self.view:HideAllShowTip()
    --if self.view.ctrl.targetType ~= MarchTargetType.CROSS_SERVER_WORM then
    --    if CrossServerUtil:GetIsCrossServer() then
    --        UIUtil.ShowTipsId(121423)
    --        return
    --    end
    --end
    if self.showLackStamina then
        local lackTab = {}
        local param = {}
        param.type = ResLackType.Res
        param.id = ResourceType.FORMATION_STAMINA
        local maxNum = LuaEntry.Player:GetMaxPveStamina()
        if maxNum > 0 then
            maxNum = Mathf.Floor(maxNum)
        end
        param.targetNum = maxNum
        table.insert(lackTab,param)
        GoToResLack.GoToItemResLackList(lackTab)
        --UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationAddStamina)
    else
        self.view:OnEditClick(self.uuid,true)
    end
end
local function RefreshTimeByUuid(self,uuid,time)
    if uuid~=nil and self.uuid~=nil and uuid == self.uuid then

    end
end
local function SetPosition(self,posX,posY)
    if self.view.WindowName == UIWindowNames.UIMain then
        local v3 = self.transform.position
        --v3.x = posX
        v3.y = posY
        self.transform.position = v3
    else
        local v3 = self.arrow.transform.position
        v3.x = posX
        --v3.y = posY
        self.arrow.transform.position = v3
    end
    
end

local function RefreshStaminaState(self)
    if self.view.ctrl.targetType>0 then
        if self.uuid~=nil then
            local costPoint = self.view.ctrl:GetCostStaminaByTargetType(self.view.ctrl.targetType)
            if costPoint>1 then
                local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(self.uuid)
                if formation~=nil then
                    local curStamina = LuaEntry.Player:GetCurStamina()
                    if curStamina < costPoint then
                        self.showLackStamina = true
                        return
                    end
                end
            end
        end
    end
    if self.showLackStamina == true then
        self.showLackStamina = false
        self:RefreshEditBtnText()
    end
end


local function RefreshEditBtnText(self)
    if self.showLackStamina then
        self.create_txt:SetLocalText(GameDialogDefine.ADD_STAMINA)
    else
        self.create_txt:SetLocalText(100645)
    end
end


FormationCreateTipNew.OnDestroy = OnDestroy
FormationCreateTipNew.OnCreate = OnCreate
FormationCreateTipNew.OnEnable = OnEnable
FormationCreateTipNew.OnDisable = OnDisable
FormationCreateTipNew.RefreshData = RefreshData
FormationCreateTipNew.SetPosition = SetPosition
FormationCreateTipNew.RefreshTimeByUuid = RefreshTimeByUuid
FormationCreateTipNew.OnEditClick= OnEditClick
FormationCreateTipNew.RefreshEditBtnText= RefreshEditBtnText
FormationCreateTipNew.RefreshStaminaState= RefreshStaminaState
FormationCreateTipNew.ToggleControlBorS = ToggleControlBorS
return FormationCreateTipNew