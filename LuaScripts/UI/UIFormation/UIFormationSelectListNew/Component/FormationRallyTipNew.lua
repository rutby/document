---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/9/16 15:05
---
local FormationCreateTipNew = BaseClass("FormationCreateTipNew", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local des_path = "bg/headBg/desTxt"
local toggle1_path = "checkObj/item1"
local toggle2_path = "checkObj/item2"
local toggle3_path = "checkObj/item3"
local toggle4_path = "checkObj/item4"
local no_path_btn_path = "noPathBtn"
local no_path_btn_txt_path = "noPathBtn/noPathBtn_txt"
local rally_txt_path = "enterBtn/btnDes/Txt1"
local rally_btn_path = "enterBtn"
local btn_num_path = "enterBtn/btnDes/txt2"
local function OnCreate(self)
    base.OnCreate(self)
    local list = self.view.ctrl:GetRallyTimeList()
    self.des = self:AddComponent(UITextMeshProUGUIEx,des_path)
    self.des:SetLocalText(390138) 
    self.toggle1 = self:AddComponent(UIToggle, toggle1_path)
    self.toggle1:SetIsOn(true)
    self.toggle1:SetOnValueChanged(function(tf)
        if tf then
            self:ToggleControlBorS()
        end
    end)
    self.toggle1.text = self.toggle1:AddComponent(UITextMeshProUGUIEx, "Text_num")
    self.toggle1.text:SetText(list[1]..Localization:GetString("100165"))

    self.toggle2 = self:AddComponent(UIToggle, toggle2_path)
    self.toggle2:SetIsOn(false)
    self.toggle2:SetOnValueChanged(function(tf)
        if tf then
            self:ToggleControlBorS()
        end
    end)
    self.toggle2.text = self.toggle2:AddComponent(UITextMeshProUGUIEx, "Text_num")
    self.toggle2.text:SetText(list[2]..Localization:GetString("100165"))

    self.toggle3 = self:AddComponent(UIToggle, toggle3_path)
    self.toggle3:SetIsOn(false)
    self.toggle3:SetOnValueChanged(function(tf)
        if tf then
            self:ToggleControlBorS()
        end
    end)
    self.toggle3.text = self.toggle3:AddComponent(UITextMeshProUGUIEx, "Text_num")
    self.toggle3.text:SetText(list[3]..Localization:GetString("100165"))

    self.toggle4 = self:AddComponent(UIToggle, toggle4_path)
    self.toggle4:SetIsOn(false)
    self.toggle4:SetOnValueChanged(function(tf)
        if tf then
            self:ToggleControlBorS()
        end
    end)
    self.toggle4.text = self.toggle4:AddComponent(UITextMeshProUGUIEx, "Text_num")
    self.toggle4.text:SetText(list[4]..Localization:GetString("100165"))

    self.rally_btn = self:AddComponent(UIButton, rally_btn_path)
    self.rally_btn:SetOnClick(function()  
SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnEditClick()
    end)
    self.rally_txt = self:AddComponent(UITextMeshProUGUIEx,rally_txt_path)
    self.no_path_btn_txt = self:AddComponent(UITextMeshProUGUIEx, no_path_btn_txt_path)
    self.no_path_btn_txt:SetLocalText(111147)
    self.no_path_btn = self:AddComponent(UIButton, no_path_btn_path)
    self.no_path_btn:SetOnClick(function ()
        UIUtil.ShowTipsId(111070)
    end)
    self.btn_num = self:AddComponent(UITextMeshProUGUIEx, btn_num_path)
    self.showLackStamina = nil
    self.isCanNotReach = false
end

local function OnDestroy(self)
    self.des_txt = nil
    self.btn_txt = nil
    self.enter_btn = nil
    self.showLackStamina = nil
    base.OnDestroy(self)
end
local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function RefreshData(self,posX,posY,formationData)
    self.uuid =  formationData.uuid
    self.index = formationData.index
    self:SetPosition(posX,posY)
    --self.data = data
    self:ToggleControlBorS()
    self:RefreshStaminaState()
    self:RefreshEditBtnText()
    self:RefreshTimeByUuid(self.uuid)
end
local function ToggleControlBorS(self)
    self.timeIndex =0
    if self.toggle1:GetIsOn() then
        self.timeIndex = 1
    elseif self.toggle2:GetIsOn() then
        self.timeIndex = 2
    elseif self.toggle3:GetIsOn() then
        self.timeIndex = 3
    elseif self.toggle4:GetIsOn() then
        self.timeIndex = 4
    end
    self.view.ctrl:SetTimeIndex(self.timeIndex)
end

local function OnEditClick(self)
    if self.showLackStamina then
        --UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationAddStamina)
        local lackTab = {}
        local param = {}
        param.type = ResLackType.Res
        param.id = ResourceType.FORMATION_STAMINA
        local maxNum = LuaEntry.Player:GetMaxPveStamina()
        if maxNum > 0 then
            maxNum = Mathf.Floor(maxNum)
        end
        param.targetNum = maxNum
        table.insert(lackTab,param)
        GoToResLack.GoToItemResLackList(lackTab)
    else
        self.view:OnEditClick(self.uuid,true)
    end
end
local function SetPosition(self,posX,posY)
    local v3 = self.transform.position
    v3.x = posX
    v3.y = posY
    self.transform.position = v3
end

local function RefreshTimeByUuid(self,uuid)
    self.isCanNotReach = false
    if uuid~=nil and self.uuid~=nil and uuid == self.uuid then
        local time = self.view:GetTimeInFormation(self.uuid)
        if time<0 then
            self.isCanNotReach = true
        else
            local realTime = time*1000
            self.btn_num:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(realTime))
        end
    end
    if self.isCanNotReach then
        self.no_path_btn:SetActive(true)
        self.rally_btn:SetActive(false)
    else
        self.no_path_btn:SetActive(false)
        self.rally_btn:SetActive(true)
    end
end

local function RefreshStaminaState(self)
    if self.view.ctrl.targetType>0 then
        if self.uuid~=nil then
            local costPoint = self.view.ctrl:GetCostStaminaByTargetType(self.view.ctrl.targetType)
            if costPoint>1 then
                local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(self.uuid)
                if formation~=nil then
                    local curStamina = LuaEntry.Player:GetCurStamina()
                    if curStamina < costPoint then
                        self.showLackStamina = true
                        return
                    end
                end
            end
        end
    end
    if self.showLackStamina == true then
        self.showLackStamina = false
        self:RefreshEditBtnText()
    end
end


local function RefreshEditBtnText(self)
    if self.showLackStamina then
        self.rally_txt:SetLocalText(GameDialogDefine.ADD_STAMINA)
    else
        self.rally_txt:SetLocalText(300038)
    end
end



FormationCreateTipNew.OnDestroy = OnDestroy
FormationCreateTipNew.OnCreate = OnCreate
FormationCreateTipNew.OnEnable = OnEnable
FormationCreateTipNew.OnDisable = OnDisable
FormationCreateTipNew.RefreshData = RefreshData
FormationCreateTipNew.SetPosition = SetPosition
FormationCreateTipNew.RefreshTimeByUuid = RefreshTimeByUuid
FormationCreateTipNew.OnEditClick= OnEditClick
FormationCreateTipNew.ToggleControlBorS = ToggleControlBorS
FormationCreateTipNew.RefreshEditBtnText = RefreshEditBtnText
FormationCreateTipNew.RefreshStaminaState = RefreshStaminaState

return FormationCreateTipNew