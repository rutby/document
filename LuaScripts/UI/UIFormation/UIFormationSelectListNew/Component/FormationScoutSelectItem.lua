---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/11/1 15:41
---

local FormationScoutSelectItem = BaseClass("FormationScoutSelectItem", UIBaseContainer)
local base = UIBaseContainer

local locked_node_path = "lockObj"
local locked_tip_path = "lockObj/unlockLv"
--local locked_tip_unlock_path = "lockObj/TxtUnlock"
local unlocked_node_path = "unLockObj"
local unlocked_selected_path = "unLockObj/marchObj/selectImg"
local unlocked_state_icon = "unLockObj/marchObj/stateIcon"
local unlocked_select_btn = "unLockObj/marchObj"
local scoutIndexNum_path = "nameNum"
local num_txt_path = "unLockObj/powerNum"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.LockedNode = self:AddComponent(UIBaseContainer, locked_node_path)
    self.LockedTipNum = self:AddComponent(UITextMeshProUGUIEx, locked_tip_path)
    self.LockedBtn = self:AddComponent(UIButton, locked_node_path)
    self.LockedBtn:SetOnClick(function()
        self:OnClickLockBtn()
    end)
    --self.LockedTip = self:AddComponent(UITextMeshProUGUIEx, locked_tip_unlock_path)
    --self.LockedTip:SetLocalText(100598) 
    self.UnlockedNode = self:AddComponent(UIBaseContainer, unlocked_node_path)
    self.UnlockedSelected = self:AddComponent(UIBaseContainer, unlocked_selected_path)
    self.UnlockedStateIcon = self:AddComponent(UIImage, unlocked_state_icon)
    self.UnlockedSelectBtn = self:AddComponent(UIButton, unlocked_select_btn)
    self.UnlockedSelectBtn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnSelectBtnClick()
    end)
    self.scoutIndexNum = self:AddComponent(UITextMeshProUGUIEx, scoutIndexNum_path)
    self.num_txt = self:AddComponent(UITextMeshProUGUIEx, num_txt_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.LockedNode = nil
    self.LockedTipNum = nil
    self.UnlockedNode = nil
    self.UnlockedSelected = nil
    self.UnlockedStateIcon = nil
    self.UnlockedSelectBtn = nil
    --self.LockedTip = nil
end

--变量的定义
local function DataDefine(self)
    self.formationIndex = nil
end

--变量的销毁
local function DataDestroy(self)
    self.formationIndex = nil
end

local function RefreshUI(self, formationIndex)
    self.isUpdate = false
    self.startTime = 0
    self.endTime = 0
    self.canClick= true
    self.num_txt:SetText("")
    self.formationIndex = formationIndex
    self.scoutIndexNum:SetText(formationIndex)
    local unlockCount = DataCenter.ArmyFormationDataManager:GetMaxInvesFormationCount()
    local formationInfo = self.view.ctrl:GetInvesFormationInfoByIndex(formationIndex)
    if formationIndex > unlockCount then -- formationInfo.FormationInfo == nil then
        self.UnlockedNode:SetActive(false)
        self.LockedNode:SetActive(true)
        --local unlockLv = self.view:GetScoutTroopUnlockLv(self.formationIndex)
        self.LockedTipNum:SetText("")--CS.GameEntry.Localization:GetString("126005", unlockLv))
    else
        self.UnlockedNode:SetActive(true)
        self.LockedNode:SetActive(false)
        if formationInfo.MarchInfo == nil then
            self:SetMarchState(MarchStatus.STATION, MarchTargetType.STATE)
        else
            local curTime = UITimeManager:GetInstance():GetServerTime()
            if formationInfo.MarchInfo.endTime> curTime then
                self.startTime = formationInfo.MarchInfo.startTime
                self.endTime =formationInfo.MarchInfo.endTime
                self.isUpdate = true
                self:UpdateTime()
            end
            self:SetMarchState(formationInfo.MarchInfo:GetMarchStatus(), formationInfo.MarchInfo:GetMarchTargetType())
        end
    end
    --UnlockedSelectBtn

end

local function SetMarchState(self, status, target)
    if status == MarchStatus.STATION then
        self.UnlockedStateIcon:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_icon_march_waiting")
    else
        if target == MarchTargetType.BACK_HOME then
            self.UnlockedStateIcon:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_icon_march_return")
        else
            self.UnlockedStateIcon:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_icon_march_scout")
        end
    end
end

local function SetSelected(self, isSelected)
    self.UnlockedSelected:SetActive(isSelected)
    if isSelected then
        local posX = self.UnlockedSelectBtn.transform.position.x
        local posY = self.UnlockedSelectBtn.transform.position.y
        self.view:ResetScoutSelectTipPosition(posX, posY)
    end
end

local function OnSelectBtnClick(self)
    self:SetSelected(true)
    self.view:OnClickScoutTroopItem(self.formationIndex)
    if not self.view.ctrl.targetPoint or self.view.ctrl.targetPoint <= 0 then
        local formationInfo = self.view.ctrl:GetInvesFormationInfoByIndex(self.formationIndex)
        if formationInfo.MarchInfo == nil then
            local pos = LuaEntry.Player:GetMainWorldPos()
            GoToUtil.GotoWorldPos(SceneUtils.TileIndexToWorld(pos,ForceChangeScene.World),nil,nil ,function()
                local position = SceneUtils.TileIndexToWorld(pos,ForceChangeScene.World)+ Vector3.New(-1,0,-1)
                WorldArrowManager:GetInstance():ShowArrowEffect(0,position,ArrowType.Building)
            end)
        else
            DataCenter.WorldMarchDataManager:TrackMarch(formationInfo.MarchInfo.uuid)
            WorldMarchTileUIManager:GetInstance():ShowTroop(formationInfo.MarchInfo.uuid)
        end
    end 
end

local function OnClickLockBtn(self)
    UIUtil.ShowTipsId(110208)
    --local unlockLv = self.view:GetScoutTroopUnlockLv(self.formationIndex)
    --UIUtil.ShowTips(CS.GameEntry.Localization:GetString("126005", unlockLv))
end

local function UpdateTime(self)
    if self.isUpdate then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local deltaTime = self.endTime-curTime
        if deltaTime >0 then
            self.num_txt:SetText(UITimeManager:GetInstance():MilliSecondToFmtStringSpecial(deltaTime))
        else
            self.num_txt:SetText("")
            self.isUpdate = false
        end
    end
end

FormationScoutSelectItem.OnCreate = OnCreate
FormationScoutSelectItem.OnDestroy = OnDestroy
FormationScoutSelectItem.OnEnable = OnEnable
FormationScoutSelectItem.OnDisable = OnDisable
FormationScoutSelectItem.ComponentDefine = ComponentDefine
FormationScoutSelectItem.ComponentDestroy = ComponentDestroy
FormationScoutSelectItem.DataDefine = DataDefine
FormationScoutSelectItem.DataDestroy = DataDestroy

FormationScoutSelectItem.RefreshUI = RefreshUI
FormationScoutSelectItem.SetSelected = SetSelected
FormationScoutSelectItem.OnSelectBtnClick = OnSelectBtnClick
FormationScoutSelectItem.SetMarchState = SetMarchState
FormationScoutSelectItem.OnClickLockBtn = OnClickLockBtn
FormationScoutSelectItem.UpdateTime= UpdateTime
return FormationScoutSelectItem