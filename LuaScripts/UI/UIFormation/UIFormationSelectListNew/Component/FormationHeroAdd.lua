---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/11/30 15:51
---
local FormationHeroAdd= BaseClass("FormationHeroAdd",UIBaseContainer)
local base = UIBaseContainer
local add_img_path = "addImage"
local lock_img_path = "lockImage"
local add_effect_path = "addImage/effect"
local unlock_level_path = "lockImage/unlockLevel"
local Localization = CS.GameEntry.Localization
local function OnCreate(self)
    base.OnCreate(self)
    self.btn = self:AddComponent(UIButton,"")
    self.btn:SetOnClick(function ()
        self:OnSelectClick()
    end)
    self.add_img = self:AddComponent(UIImage,add_img_path)
    self.lock_img = self:AddComponent(UIImage,lock_img_path)
    self.add_effect = self:AddComponent(UIBaseContainer,add_effect_path)
    self.unlock_level_text = self:AddComponent(UITextMeshProUGUIEx, unlock_level_path)
end

local function RefreshData(self,index,formationUuid,canAdd,garage)
    --local unlockLevel = DataCenter.GarageRefitManager:GetSlotUnlockLevel(garage, index)
    --local refitData = DataCenter.GarageRefitManager:GetGarageRefitData(garage)
    --local isLock = refitData and refitData.level < unlockLevel

    self.formationUuid = formationUuid
    self.heroIndex = index
    self.isLock = false
    self.unlockLevel = 0--unlockLevel
    self.canAdd = canAdd
    self.garage = garage
    self.formationUuid = formationUuid
    self.heroIndex = index
    local showEffect = false
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    if formation~=nil then
        local maxNum = MarchUtil.GetMaxHeroValueByFormationIndex(formation.index)
        self.isLock =(index>maxNum)
        if self.canAdd== true and self.isLock==false then
            local canAddNum = MarchUtil.GetCanAddHeroNum(formation:GetCurHeroes(),formation.index)
            if canAddNum>0 then
                showEffect= true
            end
        end
    end
    self.lock_img:SetActive(self.isLock)
    
    self.add_effect:SetActive(showEffect)
    if self.isLock==false then
        self.add_img:SetActive(true)
        --self.add_img:LoadSprite("Assets/Main/Sprites/UI/UITroopsNew/UITroops_img_add.png")
    else
        self.add_img:SetActive(false)
    end
    self.unlock_level_text:SetText("Lv." .. 999)
end

local function OnSelectClick(self)
    --self.view.ctrl:SetCurIndex(self.index)
    if self.isLock==false then
        if self.canAdd == true then
            self.view:HideAllShowTip()
            self.view:OnEditClick(self.formationUuid,false)
        else
            UIUtil.ShowSingleTip(Localization:GetString("121000"))
        end
    else
        if self.unlockLevel > 0 then
            --UIUtil.ShowSingleTip(Localization:GetString("140329", self.unlockLevel))
            local tip = Localization:GetString("140329", self.unlockLevel)
            UIUtil.ShowMessage(tip, 2, GameDialogDefine.GOTO, GameDialogDefine.CANCEL, function()
                GoToUtil.GotoCityByBuildId(self.garage, WorldTileBtnType.GarageRefit)
            end)
        end
        
        --local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(self.formationUuid)
        --if formation~=nil then
        --    local buildId = MarchUtil.GetFormationBuildNameByIndex(formation.index)
        --    self.formationUnLockIndex = {}
        --    local buildTemplate = DataCenter.BuildTemplateManager:GetBuildingDesTemplate(buildId)
        --    if buildTemplate~=nil then
        --        local vecPara1 = string.split(buildTemplate.para1,"|")
        --        for k,v in ipairs(vecPara1) do
        --            local vec1 = string.split(v,";")
        --            if #vec1 >= 2 then
        --                self.formationUnLockIndex[tonumber(vec1[1])] = tonumber(vec1[2])
        --            end
        --        end
        --        local scienceId = self.formationUnLockIndex[self.heroIndex]
        --        if scienceId~=nil then
        --            local scienceLv = math.fmod(scienceId,100)
        --            local realScienceId = scienceId - scienceLv
        --            local template = DataCenter.ScienceTemplateManager:GetScienceTemplate(realScienceId,scienceLv)
        --            if template ~= nil then
        --                UIUtil.ShowSingleTip(Localization:GetString("150210",Localization:GetString(template.name)))
        --            end
        --        end
        --    end
        --end
        
        --local formationIndex =self.view.ctrl.curIndex
    end
end

FormationHeroAdd.OnSelectClick =OnSelectClick
FormationHeroAdd.OnCreate = OnCreate
FormationHeroAdd.RefreshData = RefreshData
return FormationHeroAdd