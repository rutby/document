---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/9/23 15:00
---SelectAttackTimesPanel.lua

local SelectAttackTimesPanel = BaseClass("SelectAttackTimesPanel", UIBaseContainer)

local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local desTxt_path = "bg/headBg/desTxt"
local confirmBtn_path = "enterBtn"
local confirmBtnTxt_path = "enterBtn/enterText"
local time_obj_path = "enterBtn/btnDes"
local btn_txt_path = "enterBtn/btnDes/Txt1"
local btn_num_path = "enterBtn/btnDes/txt2"
local toggle_path = "checkObj/item"
local back_toggle_path = "backToggle"
local back_toggle_txt_path = "backToggle/backToggle_txt"
local no_path_btn_path = "noPathBtn"
local no_path_btn_txt_path = "noPathBtn/noPathBtn_txt"
-- 创建 
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.descTxtN = self:AddComponent(UITextMeshProUGUIEx, desTxt_path)
    
    self.confirmBtnN = self:AddComponent(UIButton, confirmBtn_path)
    self.confirmBtnN:SetOnClick(function()
        self:OnClickConfirmBtn()
    end)
    self.confirmBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, confirmBtnTxt_path)
    self.confirmBtnTxtN:SetText(Localization:GetString("150122"))
    self.time_obj = self:AddComponent(UIBaseContainer,time_obj_path)
    self.btn_txt = self:AddComponent(UITextMeshProUGUIEx, btn_txt_path)
    self.btn_txt:SetText(Localization:GetString("150122"))
    self.btn_num = self:AddComponent(UITextMeshProUGUIEx, btn_num_path)
    self.toggleItemsTb = {}
    for i = 1, 4 do
        local togglePath = toggle_path .. i
        local newTog = {}
        local tempTog = self:AddComponent(UIToggle, togglePath)
        tempTog:SetOnValueChanged(function(tf)
            if tf then
                self:SetSelectedIndex(i)
            end
        end)
        newTog.togN = tempTog
        newTog.TogTxtN = tempTog:AddComponent(UITextMeshProUGUIEx, "Text_num")
        table.insert(self.toggleItemsTb, newTog)
    end

    self.back_toggle = self:AddComponent(UIToggle, back_toggle_path)
    if self.view.ctrl.targetType then
        if self.view.ctrl.targetType == MarchTargetType.TRAIN_DESERT then
            self.back_toggle:SetActive(true)
            self.back_toggle:SetIsOn(true)
            self.back_toggle_txt = self:AddComponent(UITextMeshProUGUIEx,back_toggle_txt_path)
            self.back_toggle_txt:SetLocalText(104309)
            self.autoBackHome = MarchUtil.GetAutoBackHomeState(self.view.ctrl.targetType) --1自动返回，0为留在原地
            self.back_toggle:SetIsOn(self.autoBackHome ==1)
        else
            self.back_toggle:SetActive(false)
        end
    else
        self.back_toggle:SetActive(false)
    end
    self.back_toggle:SetOnValueChanged(function()
        self:ToggleControlBorS()
    end)
    self.no_path_btn_txt = self:AddComponent(UITextMeshProUGUIEx, no_path_btn_txt_path)
    self.no_path_btn_txt:SetLocalText(111147)
    self.no_path_btn = self:AddComponent(UIButton, no_path_btn_path)
    self.no_path_btn:SetOnClick(function ()
        UIUtil.ShowTipsId(111070)
    end)
end

--控件的销毁
local function ComponentDestroy(self)
    self.descTxtN = nil
    self.confirmBtnN = nil
    self.confirmBtnTxtN = nil
    self.toggleItemsTb = nil
end

--变量的定义
local function DataDefine(self)
    self.curSelectIndex = 1
    self.OnConfirmCallBack = nil
end

--变量的销毁
local function DataDestroy(self)
    self.curSelectIndex = nil
    self.OnConfirmCallBack = nil
end


local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
end

local function OnRemoveListener(self)
    --self:RemoveUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
    base.OnRemoveListener(self)
end

local function ShowPanel(self, defaultIndex, isMarch, confirmCallback,showTime)
    self:SetSelectedIndex(defaultIndex)
    self.OnConfirmCallBack = confirmCallback

    for i, v in ipairs(self.toggleItemsTb) do
        if i == self.curSelectIndex then
            v.togN:SetIsOn(true)
        else
            v.togN:SetIsOn(false)
        end
    end

    if isMarch then
        self.confirmBtnTxtN:SetText(Localization:GetString("150122"))
        self.btn_txt:SetText(Localization:GetString("150122"))
    else
        self.confirmBtnTxtN:SetText(Localization:GetString("100645"))
        self.btn_txt:SetText(Localization:GetString("100645"))
    end
    if showTime~=nil then
        if showTime<0 then
            self.no_path_btn:SetActive(true)
            self.confirmBtnN:SetActive(false)
        else
            self.confirmBtnN:SetActive(true)
            self.no_path_btn:SetActive(false)
            self.confirmBtnTxtN:SetActive(false)
            self.time_obj:SetActive(true)
            local realTime = showTime*1000
            self.btn_num:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(realTime))
        end
        
    else
        self.confirmBtnN:SetActive(true)
        self.time_obj:SetActive(false)
        self.confirmBtnTxtN:SetActive(true)
        self.no_path_btn:SetActive(false)
    end
    for i, v in ipairs(self.toggleItemsTb) do
        local kn = "k" .. i
        local times = LuaEntry.DataConfig:TryGetNum("destroy_times", kn) or 0
        if self.view.ctrl.targetType == MarchTargetType.TRAIN_DESERT then
            times = LuaEntry.DataConfig:TryGetNum("desert_train_times", kn) or 0
        end
        if times <= 1000 then
            v.TogTxtN:SetText(Localization:GetString("302317", times))
        else
            v.TogTxtN:SetText(Localization:GetString("302318"))
        end
    end
    if self.view.ctrl.targetType and self.view.ctrl.targetType == MarchTargetType.TRAIN_DESERT then
        self.descTxtN:SetText(Localization:GetString("372535"))
    else
        self.descTxtN:SetText(Localization:GetString("302319"))
    end
end

local function SetSelectedIndex(self, tempIndex)
    self.curSelectIndex = tempIndex or self.curSelectIndex

    local kn = "k" .. self.curSelectIndex
    local times = LuaEntry.DataConfig:TryGetNum("destroy_times", kn) or 0
    if self.view.ctrl.targetType == MarchTargetType.TRAIN_DESERT then
        times = LuaEntry.DataConfig:TryGetNum("desert_train_times", kn) or 0
    end
    if self.view.ctrl.SetAttackTimes then
        self.view.ctrl:SetAttackTimes(times)
    end
    if self.view.RefreshCost then
        self.view:RefreshCost()
    end
end

local function OnClickConfirmBtn(self)
    local costPoint = 0
    if self.view.ctrl.targetType ~= nil and  self.view.ctrl.targetType>=0 then
        costPoint = self.view.ctrl:GetCostStaminaByTargetType(self.view.ctrl.targetType)
    end
    if costPoint > LuaEntry.Player:GetCurStamina() then
        UIUtil.ShowTipsId(134004)
        return
    end
    
    if self.OnConfirmCallBack then
        self.OnConfirmCallBack(self.curSelectIndex)
    end
end


local function ToggleControlBorS(self)
    local autoBackHome =1
    if self.back_toggle:GetIsOn() then
        autoBackHome =1
    else
        autoBackHome = 0
    end
    if self.autoBackHome~=autoBackHome then
        if autoBackHome ==1 then
            UIUtil.ShowTipsId(104310)
        else
            UIUtil.ShowTipsId(104311)
        end
        self.autoBackHome = autoBackHome
    end
    MarchUtil.SetAutoBackHomeState(self.view.ctrl.targetType,self.autoBackHome)
    self.view.ctrl:RefreshAutoBack()
end


SelectAttackTimesPanel.OnCreate = OnCreate
SelectAttackTimesPanel.OnDestroy = OnDestroy
SelectAttackTimesPanel.ComponentDefine = ComponentDefine
SelectAttackTimesPanel.ComponentDestroy = ComponentDestroy
SelectAttackTimesPanel.DataDefine = DataDefine
SelectAttackTimesPanel.DataDestroy = DataDestroy
SelectAttackTimesPanel.OnAddListener = OnAddListener
SelectAttackTimesPanel.OnRemoveListener = OnRemoveListener

SelectAttackTimesPanel.ShowPanel = ShowPanel
SelectAttackTimesPanel.SetSelectedIndex = SetSelectedIndex
SelectAttackTimesPanel.OnClickConfirmBtn = OnClickConfirmBtn
SelectAttackTimesPanel.ToggleControlBorS = ToggleControlBorS

return SelectAttackTimesPanel