---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 24224.
--- DateTime: 2022/5/30 17:24
---
local FormationStaminaSlider_TextMeshPro = BaseClass("FormationStaminaSlider_TextMeshPro",UIBaseContainer)
local base = UIBaseContainer
local slider_path = "Slider"
local total_num_path = "Slider/totalNum"
local cost_num_path = "costNum"
local stamina_des_btn_path = "stateBtn"
local add_btn_path ="addButton"
local Localization = CS.GameEntry.Localization
local function OnCreate(self)
    base.OnCreate(self)
    self.des_btn = self:AddComponent(UIButton,stamina_des_btn_path)
    self.des_btn:SetOnClick(function ()
        self:OnDesClick()
    end)
    self.add_btn = self:AddComponent(UIButton,add_btn_path)
    self.add_btn:SetOnClick(function ()
        self:OnAddClick()
    end)
    self.slider = self:AddComponent(UISlider,slider_path)
    self.total_num = self:AddComponent(UITextMeshProUGUIEx,total_num_path)
    self.cost_num = self:AddComponent(UITextMeshProUGUIEx,cost_num_path)
end
-- 显示
local function OnEnable(self)
    base.OnEnable(self)
    self:InitData()
end

-- 隐藏
local function OnDisable(self)
    self.isTop = nil
    base.OnDisable(self)
end

local function InitData(self)
    self.curNum = LuaEntry.Player:GetCurStamina()
    local costPoint = 0
    if self.view.ctrl.targetType ~= nil and  self.view.ctrl.targetType>=0 then
        costPoint = self.view.ctrl:GetCostStaminaByTargetType(self.view.ctrl.targetType)
    end
    if costPoint>0 then
        self.cost_num:SetText("-"..costPoint)
    else
        self.cost_num:SetText("")
    end
    self.isTop = false
    self:UpdateStamina()
end

local function UpdateCost(self)
    local costPoint = 0
    if self.view.ctrl.targetType ~= nil and  self.view.ctrl.targetType>=0 then
        costPoint = self.view.ctrl:GetCostStaminaByTargetType(self.view.ctrl.targetType)
    end
    if costPoint>0 then
        self.cost_num:SetText("-"..costPoint)
    elseif costPoint == -1 then
        self.cost_num:SetLocalText(130262)
    else
        self.cost_num:SetText("")
    end
end
local function UpdateStamina(self)
    self.maxNum = 100
    local config = DataCenter.ArmyFormationDataManager:GetConfigData()
    if config~=nil then
        self.maxNum = config.FormationStaminaMax
    end
    self.curNum = LuaEntry.Player:GetCurStamina()
    local tempValue = math.min(1,(self.curNum/self.maxNum))
    self.slider:SetValue(tempValue)
    self.total_num:SetText(string.GetFormattedSeperatorNum(math.floor(self.curNum)).."/"..string.GetFormattedSeperatorNum(math.floor(self.maxNum)))
end

local function OnDesClick(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.des_btn.gameObject.transform.position + Vector3.New(-19, 30, 0) * scaleFactor
    if self.isTop == true then
        position = self.des_btn.gameObject.transform.position + Vector3.New(-19, -140, 0) * scaleFactor
    end
    local endTime =0
    
    
    local config = DataCenter.ArmyFormationDataManager:GetConfigData()
    if config ~= nil then
        local maxNum = config.FormationStaminaMax
        local resumeSpeed = config.FormationStaminaUpdateTime
        local title = Localization:GetString(tostring(GameDialogDefine.STAMINA_RESUME_ONR_POINT_NEED_TIME), math.ceil(resumeSpeed))

        local speedAddEffect = LuaEntry.Effect:GetGameEffect(EffectDefine.STAMINA_RECOVER_SPEED_ADD)
        local content0 = speedAddEffect > 0 and  (Localization:GetString("320292").."+"..math.floor(speedAddEffect).."%") or ""
        local content1 =Localization:GetString("104199")
        local content2 =Localization:GetString("104200")
        endTime = LuaEntry.Player.lastStaminaTime + (maxNum - LuaEntry.Player.stamina) * resumeSpeed * 1000

        local param = {}
        param.title = title
        param.content0 = content0
        param.content1 = content1
        param.content2 = content2
        param.endTime = endTime
        param.position = position
        param.isTop = self.isTop
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationTip, { anim = false }, param)
    end
end

local function OnAddClick(self)
    --UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationAddStamina)
    local lackTab = {}
    local param = {}
    param.type = ResLackType.Res
    param.id = ResourceType.FORMATION_STAMINA
    local maxNum = LuaEntry.Player:GetMaxPveStamina()
    if maxNum > 0 then
        maxNum = Mathf.Floor(maxNum)
    end
    param.targetNum = maxNum
    table.insert(lackTab,param)
    GoToResLack.GoToItemResLackList(lackTab)
end

local function SetTipTop(self)
    self.isTop = true
end
FormationStaminaSlider_TextMeshPro.OnEnable =OnEnable
FormationStaminaSlider_TextMeshPro.OnCreate = OnCreate
FormationStaminaSlider_TextMeshPro.OnDisable = OnDisable
FormationStaminaSlider_TextMeshPro.InitData = InitData
FormationStaminaSlider_TextMeshPro.UpdateStamina = UpdateStamina
FormationStaminaSlider_TextMeshPro.OnDesClick =OnDesClick
FormationStaminaSlider_TextMeshPro.OnAddClick =OnAddClick
FormationStaminaSlider_TextMeshPro.SetTipTop = SetTipTop
FormationStaminaSlider_TextMeshPro.UpdateCost =UpdateCost
return FormationStaminaSlider_TextMeshPro