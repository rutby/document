---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/8/21 16:29
---
local EdenSpecialMoveItem = BaseClass("EdenSpecialMoveItem", UIBaseContainer)
local base = UIBaseContainer
local btn_path ="edenMoveBtn"
local txt_path = "edenMoveBtn/moveBg/moveName"
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:DeleteTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.btn = self:AddComponent(UIButton, btn_path)
    self.btn:SetOnClick(function()
        self:OnClick()
    end)
    self.txt = self:AddComponent(UIText, txt_path)
    self.timer_action = function(temp)
        self:RefreshTime()
    end
    self.isLock = false
end

local function ComponentDestroy(self)
    self.btn = nil
end
local function DataDefine(self)
end
local function DataDestroy(self)
end
local function RefreshData(self)
    if LuaEntry.Player.serverType == ServerType.EDEN_SERVER then
        self.endTime = 0
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local foldStartTime = LuaEntry.Player:GetEdenMoveTime()
        local k3 = LuaEntry.DataConfig:TryGetNum("eden_born", "k3")
        self.endTime = k3*1000+foldStartTime
        if curTime< self.endTime then
            self.isLock = true
            self:RefreshTime()
            self:AddTimer()
        else
            self.isLock = false
            self.endTime = 0
            self.txt:SetLocalText(111201)
            self:DeleteTimer()
        end
        CS.UIGray.SetGray(self.btn.transform, self.isLock, self.isLock ==false)
    else
        self.isLock = false
        self:SetActive(false)
        self:DeleteTimer()
    end
end
local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end
    self.timer:Start()
end
local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function RefreshTime(self)
    if self.isLock == true then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        if curTime< self.endTime then
            local leftTime = self.endTime - curTime
            local leftTimeStr = UITimeManager:GetInstance():MilliSecondToFmtString(leftTime)
            self.txt:SetText(leftTimeStr)
        else
            self.isLock = false
            self:RefreshData()
        end
    end
end

local function OnClick(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIEdenMoveTip)
end

EdenSpecialMoveItem.OnCreate =OnCreate
EdenSpecialMoveItem.OnDestroy =OnDestroy
EdenSpecialMoveItem.OnEnable =OnEnable
EdenSpecialMoveItem.OnDisable =OnDisable
EdenSpecialMoveItem.ComponentDefine =ComponentDefine
EdenSpecialMoveItem.ComponentDestroy =ComponentDestroy
EdenSpecialMoveItem.DataDefine =DataDefine
EdenSpecialMoveItem.DataDestroy =DataDestroy
EdenSpecialMoveItem.RefreshData =RefreshData
EdenSpecialMoveItem.OnClick = OnClick
EdenSpecialMoveItem.RefreshTime =RefreshTime
EdenSpecialMoveItem.DeleteTimer = DeleteTimer
EdenSpecialMoveItem.AddTimer = AddTimer
return EdenSpecialMoveItem