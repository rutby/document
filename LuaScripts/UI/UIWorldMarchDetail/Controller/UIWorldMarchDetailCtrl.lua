---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/9/20 11:20
---
local UIWorldMarchDetailCtrl = BaseClass("UIWorldMarchDetailCtrl", UIBaseCtrl)
local Data = CS.GameEntry.Data
local Localization = CS.GameEntry.Localization
function UIWorldMarchDetailCtrl:CloseSelf()
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIWorldMarchDetail)
end

function UIWorldMarchDetailCtrl:Close()
    UIManager:GetInstance():DestroyWindowByLayer(UILayer.Normal)
end

function UIWorldMarchDetailCtrl:GetInMarchFormationUuidList()
    local list = {}
    local allList = DataCenter.ArmyFormationDataManager:GetArmyFormationList()
    if allList ~= nil then
        for k,v in pairs(allList) do
            if v ~= nil and v.state == ArmyFormationState.March then
                local march = DataCenter.WorldMarchDataManager:GetOwnerFormationMarch(LuaEntry.Player.uid, v.uuid, LuaEntry.Player.allianceId)
                if march~=nil then
                    table.insert(list,v)
                end
            end
        end
    end
    if #list>0 then
        table.sort(list,function(a,b)
            return a.index < b.index
        end)
    end
    return list
end
function UIWorldMarchDetailCtrl:GetFormationPowerByUuid(formationUuid)
    local totalPower = 0
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    if formation~=nil then
        totalPower = MarchUtil.GetFormationPower(formation:GetCurHeroes(),formation.soldiers,formation.index,MarchUtil.GetCampAddParam(formation:GetCurHeroes()))
    end
    return totalPower
end

function UIWorldMarchDetailCtrl:GetCurSoldierNum(formationUuid)
    local totalNum = 0
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    if formation~=nil then
        table.walk(formation.soldiers,function(k,v)
            if v>0 then
                totalNum = totalNum+v
            end
        end)
    end
    return totalNum
end

function UIWorldMarchDetailCtrl:GetMarchData(formationUuid)
    local oneData = {}
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    local Player = LuaEntry.Player
    if formation~=nil then
        oneData.formationUuid = formation.uuid
        oneData.index = formation.index
        --oneData.power = self:GetFormationPowerByUuid(formation.uuid)
        oneData.curSoldierNum = self:GetCurSoldierNum(formation.uuid)
        oneData.heroDataList ={}
        local heroData = formation:GetCurHeroes()
        if heroData~=nil and table.count(heroData)>0 then
            table.walksort(heroData,function (leftKey,rightKey)
                return heroData[leftKey] < heroData[rightKey]
            end,function(k,v)
                if k~=nil then
                    local heroOneData = {}
                    heroOneData.heroUuid = k
                    table.insert(oneData.heroDataList,heroOneData)
                end
            end)
        end
        local march = DataCenter.WorldMarchDataManager:GetOwnerFormationMarch(Player.uid, formation.uuid, Player.allianceId)
        if march~=nil then
            oneData.status = march:GetMarchStatus()
            oneData.targetType = march:GetMarchTargetType()
            oneData.marchType = march:GetMarchType()
            oneData.marchUuid = march.uuid
            oneData.targetUuid = march.targetUuid
            oneData.startTime = march.startTime
            oneData.endTime = march.endTime
            oneData.targetPoint = march.targetPos
            oneData.serverId = march.serverId
            return oneData
        end
    end
end

function UIWorldMarchDetailCtrl:GetStateDes(status)
    if status == MarchStatus.ATTACKING then
        return "120125"
    end
    if status == MarchStatus.MOVING or status == MarchStatus.CHASING then
        return "120166"
    end
    if status == MarchStatus.ASSISTANCE then
        return "120165"
    end
    if status == MarchStatus.COLLECTING then
        return "300039"
    end
    return "300542"
end

function UIWorldMarchDetailCtrl:GetTargetDes(targetType)
    if targetType == MarchTargetType.STATE then
        return "100610"
    end
    if targetType == MarchTargetType.ATTACK_MONSTER then
        return "121486"
    end
    if targetType == MarchTargetType.COLLECT or targetType == MarchTargetType.BUILD_ALLIANCE_BUILDING or targetType == MarchTargetType.COLLECT_ALLIANCE_BUILD_RESOURCE or targetType == MarchTargetType.ASSISTANCE_COLLECT_ACT_ALLIANCE_MINE then
        return "121487"
    end
    if targetType == MarchTargetType.BACK_HOME then
        return "121488"
    end
    if targetType == MarchTargetType.ATTACK_BUILDING or targetType == MarchTargetType.ATTACK_ALLIANCE_BUILDING or targetType == MarchTargetType.ATTACK_ACT_ALLIANCE_MINE or targetType ==  MarchTargetType.ATTACK_DRAGON_BUILDING or targetType == MarchTargetType.TRIGGER_DRAGON_BUILDING then
        return "121486"
    end
    if targetType == MarchTargetType.ATTACK_ARMY then
        return "121491"
    end
    if targetType == MarchTargetType.JOIN_RALLY then
        return "121489"
    end
    if targetType == MarchTargetType.RALLY_FOR_BOSS then
        return "121490"
    end
    if targetType == MarchTargetType.RALLY_FOR_BUILDING  or targetType == MarchTargetType.RALLY_FOR_ACT_ALLIANCE_MINE then
        return "121490"
    end
    if targetType == MarchTargetType.ATTACK_ARMY_COLLECT then
        return "121491"
    end
    if targetType == MarchTargetType.ATTACK_CITY or targetType == MarchTargetType.DIRECT_ATTACK_CITY then
        return "121492"
    end
    if targetType == MarchTargetType.RALLY_FOR_CITY then
        return "121493"
    end
    if targetType == MarchTargetType.ASSISTANCE_BUILD then
        return "121494"
    end
    if targetType == MarchTargetType.ASSISTANCE_CITY then
        return "121495"
    end
    if targetType == MarchTargetType.GO_WORM_HOLE then
        return "121496"
    end
    if targetType == MarchTargetType.ATTACK_ALLIANCE_CITY then
        return "121500"
    end
    if targetType == MarchTargetType.ASSISTANCE_ALLIANCE_CITY or targetType == MarchTargetType.ASSISTANCE_ALLIANCE_BUILDING or targetType == MarchTargetType.RALLY_ASSISTANCE_THRONE or targetType == MarchTargetType.ASSISTANCE_DRAGON_BUILDING then
        return "121501"
    end
    if targetType == MarchTargetType.RALLY_FOR_ALLIANCE_CITY or targetType == MarchTargetType.RALLY_ALLIANCE_BUILDING or targetType == MarchTargetType.RALLY_THRONE or targetType == MarchTargetType.RALLY_DRAGON_BUILDING then
        return "121502"
    end
    if targetType == MarchTargetType.BUILD_WORM_HOLE then
        return "121503"
    end
    if targetType == MarchTargetType.TRANSPORT_ACT_BOSS then
        return "121504"
    end
    if targetType == MarchTargetType.DIRECT_ATTACK_ACT_BOSS then
        return "121486"
    end
    if targetType == MarchTargetType.CROSS_SERVER_WORM then
        return "121505"
    end
    return "121485"
end

return UIWorldMarchDetailCtrl