---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/7/27 22:12
---MineCaveLogNewItem

local MineCaveLogNewItem = BaseClass("MineCaveLogNewItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local playerHead_path = "rankInfo/playerFlag/UIPlayerHead/HeadIcon"
local playerHeadFg_path = "rankInfo/playerFlag/UIPlayerHead/Foreground"
local playerNation_path = "rankInfo/playerFlag/UIPlayerHead/countryFlag"
local tip_path = "rankInfo/tip"
local winImg_path = "rankInfo/winImg"
local winTxt_path = "rankInfo/winImg/result_win"
local loseImg_path = "rankInfo/loseImg"
local loseTxt_path = "rankInfo/loseImg/result_lose"
local reportBtn_path = "rankInfo/btnReport"
-- local reportBtnTxt_path = "rankInfo/btnReport/btnReportTxt"
-- local showDetailBtn_path = "rankInfo/showDetailBtn"
-- local showDetailImg_path = "rankInfo/showDetailBtn/arrow"
local detailContainer_path = "rankInfo/detail"
local detailTxt_path = "rankInfo/detail/detailTxt"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.playerNationN = self:AddComponent(UIImage, playerNation_path)
    self.tipN = self:AddComponent(UITextMeshProUGUIEx, tip_path)
    self.winImgN = self:AddComponent(UIImage, winImg_path)
    self.winTxtN = self:AddComponent(UITextMeshProUGUIEx, winTxt_path)
    self.winTxtN:SetLocalText(390186)
    self.loseImgN = self:AddComponent(UIImage, loseImg_path)
    self.loseTxtN = self:AddComponent(UITextMeshProUGUIEx, loseTxt_path)
    self.loseTxtN:SetLocalText(390187)
    self.reportBtnN = self:AddComponent(UIButton, reportBtn_path)
    self.reportBtnN:SetOnClick(function()
        self:OnClickReportBtn()
    end)
    -- self.reportBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, reportBtnTxt_path)
    -- self.reportBtnTxtN:SetLocalText(100092)
    -- self.showDetailBtnN = self:AddComponent(UIButton, showDetailBtn_path)
    -- self.showDetailBtnN:SetOnClick(function()
    --     self:OnClickDetailBtn()
    -- end)
    --self.showDetailImgN = self:AddComponent(UIImage, showDetailImg_path)
    self.detailContainerN = self:AddComponent(UIBaseContainer, detailContainer_path)
    self.detailTxtN = self:AddComponent(UITextMeshProUGUIEx, detailTxt_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.playerHeadN = nil
    self.playerHeadFgN = nil
    self.playerNationN = nil
    self.tipN = nil
    self.winImgN = nil
    self.loseImgN = nil
    self.reportBtnN = nil
    -- self.reportBtnTxtN = nil
    -- self.showDetailBtnN = nil
    self.showDetailImgN = nil
    self.detailContainerN = nil
    self.detailTxtN = nil
end

--变量的定义
local function DataDefine(self)
    self.logInfo = nil
    self.params = nil
end

--变量的销毁
local function DataDestroy(self)
    self.logInfo = nil
    self.params = nil
end

--[[
local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.BarterShopExchangeSucc, self.OnGetBarterSucc)

end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.BarterShopExchangeSucc, self.OnGetBarterSucc)
    base.OnRemoveListener(self)
end
--]]

--self.params = {index, callback}
local function SetItem(self, logInfo, params)
    self.logInfo = logInfo
    self.params = params
    
    self:RefreshAll()
end

local function RefreshAll(self)
    self.playerHeadN:SetData(self.logInfo.playerUid, self.logInfo.playerPic, self.logInfo.playerPicVer)
    
    local fgImg = self.logInfo:GetHeadBgImg()
    if fgImg then
        self.playerHeadFgN:SetActive(true)
        self.playerHeadFgN:LoadSprite(fgImg)
    else
        self.playerHeadFgN:SetActive(false)
    end
    
    self.playerNationN:SetActive(false)

    local playerName = ""
    if string.IsNullOrEmpty(self.logInfo.playerName) then
        playerName = Localization:GetString("302219")
    else
        if string.IsNullOrEmpty(self.logInfo.playerAlAbbr) then
            playerName = self.logInfo.playerName
        else
            playerName = "[" .. self.logInfo.playerAlAbbr .. "]" .. self.logInfo.playerName
        end
    end
    local strTip = ""
    local isAttacker = self.logInfo.plunderType == MineCavePlunderType.AttackWin or self.logInfo.plunderType == MineCavePlunderType.AttackFail
    if not isAttacker then
        strTip = Localization:GetString("302291", playerName, Localization:GetString("302292"))
    else
        strTip = Localization:GetString("302291", Localization:GetString("302292"), playerName)
    end
    self.tipN:SetText(strTip)
    
    local isWin = self.logInfo.plunderType == MineCavePlunderType.AttackWin or self.logInfo.plunderType == MineCavePlunderType.DefenseWin
    self.winImgN:SetActive(isWin)
    self.loseImgN:SetActive(not isWin)

    local strDetail = ""
    if self.logInfo.plunderType == MineCavePlunderType.AttackWin then
        if string.IsNullOrEmpty(self.logInfo.rewardType) then
            strDetail = Localization:GetString("302294")
        else
            local resName = DataCenter.RewardManager:GetNameByType(self.logInfo.rewardType, self.logInfo.itemId)
            strDetail = Localization:GetString("302293", playerName, self.logInfo.rewardNum, resName)
        end

    elseif self.logInfo.plunderType == MineCavePlunderType.DefenseFail then
        local resName = DataCenter.RewardManager:GetNameByType(self.logInfo.rewardType, self.logInfo.itemId)
        strDetail = Localization:GetString("302228", playerName, self.logInfo.rewardNum, resName)
    else
        strDetail = Localization:GetString("302294")
    end
    self.detailTxtN:SetText(strDetail)

    --self.showDetailImgN:SetLocalScaleXYZ(1, 1, 1)
    
    self.detailContainerN:SetActive(true)
end

local function ShowDetailByExternal(self, isShow)
    local scaleX = isShow and -1 or 1
    --self.showDetailImgN:SetLocalScaleXYZ(scaleX, 1, 1)
    --self.detailContainerN:SetActive(isShow)
end

local function OnClickReportBtn(self)
    SFSNetwork.SendMessage(MsgDefines.UserGetMineCaveReport,self.logInfo.uuid)
end

local function OnClickDetailBtn(self)
    if self.params.callback then
        self.params.callback(self.params.index)
    end
end

MineCaveLogNewItem.OnCreate = OnCreate
MineCaveLogNewItem.OnDestroy = OnDestroy
MineCaveLogNewItem.ComponentDefine = ComponentDefine
MineCaveLogNewItem.ComponentDestroy = ComponentDestroy
MineCaveLogNewItem.DataDefine = DataDefine
MineCaveLogNewItem.DataDestroy = DataDestroy

MineCaveLogNewItem.SetItem = SetItem
MineCaveLogNewItem.RefreshAll = RefreshAll
MineCaveLogNewItem.ShowDetailByExternal = ShowDetailByExternal
MineCaveLogNewItem.OnClickReportBtn = OnClickReportBtn
MineCaveLogNewItem.OnClickDetailBtn = OnClickDetailBtn

return MineCaveLogNewItem