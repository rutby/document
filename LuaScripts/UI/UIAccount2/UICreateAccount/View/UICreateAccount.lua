---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhangliheng.
--- DateTime: 8/12/21 9:49 PM
---


local UICreateAccount = BaseClass("UICreateAccount",UIBaseView)
local base = UIBaseView
local UIGray = CS.UIGray
local Localization = CS.GameEntry.Localization
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.textTitle      = self:AddComponent(UITextMeshProUGUIEx, 'UICommonMiniPopUpTitle/Bg_mid/titleText')
    self.textTip1       = self:AddComponent(UITextMeshProUGUIEx, 'Root/TextTopTip')

    self.textTitleMail  = self:AddComponent(UITextMeshProUGUIEx, 'Root/InputFieldMail/TextTitleMail')
    self.textPlaceHolder1 = self:AddComponent(UITextMeshProUGUIEx, 'Root/InputFieldMail/Text Area/Placeholder1')
    
    self.textBtnSubmit = self:AddComponent(UITextMeshProUGUIEx, 'Root/BtnSubmit/TextSubmit')
    
    self.textMailInvalidTip = self:AddComponent(UITextMeshProUGUIEx, 'Root/InputFieldMail/TextMailInvalidTip')
    self.textSuffixInvalidTip = self:AddComponent(UITextMeshProUGUIEx, 'Root/InputFieldSuffix/TextSuffixInvalidTip')
    
    self.inputFieldMail = self:AddComponent(UITMPInput, 'Root/InputFieldMail')
    self.inputFieldSuffix = self:AddComponent(UITMPInput, 'Root/InputFieldSuffix')

    self.textPlaceHolder2 = self:AddComponent(UITextMeshProUGUIEx, 'Root/InputFieldSuffix/Text Area/Placeholder2')
    
    self.panelCloseBtn = self:AddComponent(UIButton,"UICommonMiniPopUpTitle/panel")
    self.btnClose  = self:AddComponent(UIButton,  'UICommonMiniPopUpTitle/Bg_mid/CloseBtn')
    self.btnSubmit = self:AddComponent(UIButton,  'Root/BtnSubmit')
    
    self.textTitle:SetLocalText(280101) 
    self.textTip1:SetLocalText(280113) 
    self.textTitleMail:SetLocalText(280039)
    self.textPlaceHolder1:SetLocalText(280102)
    self.textPlaceHolder2:SetLocalText(208215)--@gmail.com
    self.textBtnSubmit:SetLocalText(280108)
    self.inputFieldSuffix:SetLocalText(208215)
    self.textMailInvalidTip:SetActive(false)
    self.textSuffixInvalidTip:SetActive(false)

    self.panelCloseBtn:SetOnClick(BindCallback(self.ctrl, self.ctrl.CloseSelf))
    self.btnClose:SetOnClick(BindCallback(self.ctrl, self.ctrl.CloseSelf))
    self.btnSubmit:SetOnClick(BindCallback(self, self.OnBtnSubmitClick))

    self.inputFieldMail:SetOnValueChange(BindCallback(self, self.OnInputMailEnd))
    self.inputFieldSuffix:SetOnValueChange(BindCallback(self, self.OnInputSuffixEnd))


    UIGray.SetGray(self.btnSubmit.transform, false,true)

end

local function ComponentDestroy(self)
    self.textTitle      = nil
    self.textTip1       = nil

    self.textTitleMail  = nil
    self.textPlaceHolder1 = nil
    self.textPlaceHolder2 = nil

    self.textBtnSubmit = nil
    self.inputFieldMail:SetText("")
    self.textMailInvalidTip:SetActive(false)
    self.textSuffixInvalidTip:SetActive(false)
    self.inputFieldMail = nil

    self.inputFieldSuffix:SetText("")
    self.inputFieldSuffix = nil
    self.btnClose  = nil
    self.btnSubmit = nil
end

local function OnInputMailEnd(self, value)
    local username = value --self.inputFieldMail:GetText()
    if username == nil or username == "" then
        self.textMailInvalidTip:SetLocalText(280112) 
        self.textMailInvalidTip:SetActive(true)
        return
    end
    
    local regex = '^[%w%._%-%+]'
    if not username:match(regex) then
        self.textMailInvalidTip:SetLocalText(280112) 
        self.textMailInvalidTip:SetActive(true)
        return
    end

    self.textMailInvalidTip:SetText('')
    self.textMailInvalidTip:SetActive(false)
end

local function OnInputSuffixEnd(self, value)
    local suffix = value 
    if suffix == nil or suffix == "" then
        self.textSuffixInvalidTip:SetLocalText(280112)
        self.textSuffixInvalidTip:SetActive(true)
        return
    end

    local regex = '@[%w%._%-%+]+%a$'
    if not suffix:match(regex) then
        self.textSuffixInvalidTip:SetLocalText(280112)
        self.textSuffixInvalidTip:SetActive(true)
        return
    end

    self.textSuffixInvalidTip:SetText('')
    self.textSuffixInvalidTip:SetActive(false)
end

local function OnBtnSubmitClick(self)
    local name = self.inputFieldMail:GetText()
    local suffix   = self.inputFieldSuffix:GetText()
    --验证用户名格式是否合法
    if name == nil or name == "" then
        UIUtil.ShowTipsId(280112) 
        return
    end
    if suffix == "" then
        suffix = Localization:GetString("208215")
    end
    local username = name..suffix
    --邮箱格式不正确
    local regex = '^[%w%._%-%+]+@[%w%._%-%+]+%a$'
    if not username:match(regex) then
        UIUtil.ShowTipsId(280112)
        return
    end
    SFSNetwork.SendMessage(MsgDefines.AccountBind, {userName = username})
end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.AccountBindEvent, self.AccountBindSignal)
    self:AddUIListener(EventId.AccountChangePwdEvent, self.AccountChangePwdSignal)
    self:AddUIListener(EventId.AccountChangeEvent, self.AccountChangeSignal)
    self:AddUIListener(EventId.CreateAccountMailFail, self.MailFailSignal)
    
end


local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.AccountBindEvent, self.AccountBindSignal)
    self:RemoveUIListener(EventId.AccountChangePwdEvent, self.AccountChangePwdSignal)
    self:RemoveUIListener(EventId.AccountChangeEvent, self.AccountChangeSignal)
    self:RemoveUIListener(EventId.CreateAccountMailFail, self.MailFailSignal)
end

local function AccountBindSignal(self)
    self.ctrl:CloseSelf()
end

local function AccountChangePwdSignal(self)
    self.ctrl:CloseSelf()
end

local function AccountChangeSignal(self)
    self.ctrl:CloseSelf()
end

local function MailFailSignal(self)
    UIGray.SetGray(self.btnSubmit.transform, false,true)
end


UICreateAccount.OnCreate= OnCreate
UICreateAccount.OnDestroy = OnDestroy
UICreateAccount.ComponentDefine = ComponentDefine
UICreateAccount.ComponentDestroy = ComponentDestroy

UICreateAccount.OnAddListener = OnAddListener
UICreateAccount.OnRemoveListener = OnRemoveListener
UICreateAccount.AccountBindSignal = AccountBindSignal
UICreateAccount.AccountChangePwdSignal = AccountChangePwdSignal
UICreateAccount.AccountChangeSignal = AccountChangeSignal
UICreateAccount.MailFailSignal = MailFailSignal

UICreateAccount.OnInputMailEnd = OnInputMailEnd
UICreateAccount.OnInputSuffixEnd = OnInputSuffixEnd
UICreateAccount.OnBtnSubmitClick = OnBtnSubmitClick


return UICreateAccount