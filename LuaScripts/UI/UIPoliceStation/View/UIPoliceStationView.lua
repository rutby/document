---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/2/28 21:34
---
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local UIPoliceStationCell = require"UI.UIPoliceStation.Component.UIPoliceStationCell"
local UIPoliceStationView = BaseClass("UIPoliceStationView", UIBaseView)
local base = UIBaseView

local Localization = CS.GameEntry.Localization

local close_btn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonMidPopUpTitle/panel"
local title_txt_Path = "UICommonMidPopUpTitle/bg_mid/titleText"
local content_path = "BuildInfo/Content"
local des_txt_path = "BuildInfo/DesText"
local info_btn_path = "BuildInfo/InfoBtn"
--创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.info_btn = self:AddComponent(UIButton, info_btn_path)
    self.title_txt = self:AddComponent(UITextMeshProUGUIEx, title_txt_Path)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx, des_txt_path)
    self.title_txt:SetLocalText(140311)
    self.des_txt:SetLocalText(140312)
    self.content = self:AddComponent(UIBaseContainer, content_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.info_btn:SetOnClick(function()
        self:OnInfoClick()
    end)
    
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
end

local function ComponentDestroy(self)
    self.close_btn = nil
    self.return_btn = nil
    self.title_txt = nil
    self.forceContent = nil
end

local function DataDefine(self)
    SFSNetwork.SendMessage(MsgDefines.GetUserGuardArmy)
end

local function DataDestroy(self)

end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.GetPlayerPoliceStationData, self.RefreshData)

end
local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.GetPlayerPoliceStationData,self.RefreshData)
end


local function RefreshData(self,data)
    self:SetAllCellDestroy()
    local armyList = self.ctrl:GetPoliceArmyList()
    for k,v in pairs(armyList) do
        if self.model[k]==nil then
            self.model[k] = self:GameObjectInstantiateAsync(UIAssets.UIPoliceStationCell, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject;
                go.gameObject:SetActive(true)
                go.transform:SetParent(self.content.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local cell = self.content:AddComponent(UIPoliceStationCell,nameStr)
                cell:ReInit(v)
            end)
        end
    end
end

local function SetAllCellDestroy(self)
    self.content:RemoveComponents(UIPoliceStationCell)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
end

local function OnInfoClick(self)
    local des = Localization:GetString("140337")
    if des ~="" then
        local scaleFactor = UIManager:GetInstance():GetScaleFactor()
        local position = self.info_btn.transform.position + Vector3.New(15, 0, 0) * scaleFactor

        local param = UIHeroTipView.Param.New()
        param.content = des
        param.dir = UIHeroTipView.Direction.RIGHT
        param.defWidth = 300
        param.pivot = 0.8
        param.position = position
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
    end
end
UIPoliceStationView.OnCreate = OnCreate
UIPoliceStationView.OnDestroy = OnDestroy
UIPoliceStationView.OnEnable = OnEnable
UIPoliceStationView.OnDisable = OnDisable
UIPoliceStationView.ComponentDefine = ComponentDefine
UIPoliceStationView.ComponentDestroy = ComponentDestroy
UIPoliceStationView.DataDefine = DataDefine
UIPoliceStationView.DataDestroy = DataDestroy
UIPoliceStationView.OnAddListener = OnAddListener
UIPoliceStationView.OnRemoveListener = OnRemoveListener
UIPoliceStationView.RefreshData = RefreshData
UIPoliceStationView.SetAllCellDestroy = SetAllCellDestroy
UIPoliceStationView.OnInfoClick =OnInfoClick
return UIPoliceStationView