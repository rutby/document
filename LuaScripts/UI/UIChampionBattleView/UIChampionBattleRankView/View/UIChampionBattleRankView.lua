---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/9 15:23
---

local UIChampionBattleRankView = BaseClass("UIChampionBattleRankView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local UIChampionBattleRankCell = require "UI.UIChampionBattleView.UIChampionBattleRankView.Component.UIChampionBattleRankCell"

local loopListView2_path = "ImgBg/container2Go/loopListView2"
local titleTxt_path = "UICommonPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local selfObj_path = "ImgBg/selfObj"
local selfRankTxt_path = "ImgBg/selfObj/selfRankTxt"
local selfWinTxt_path = "ImgBg/selfObj/selfWinTxt"
local selfLoseTxt_path = "ImgBg/selfObj/selfLoseTxt"

local selfLevelTxt_path = "ImgBg/selfObj/selfLevelTxt"
local selfHeadIcon_path = "ImgBg/selfObj/playerFlag/UIPlayerHead/HeadIcon"
local selfHeadBg_path = "ImgBg/selfObj/playerFlag/UIPlayerHead/Foreground"
local selfFirstTxt_path = "ImgBg/selfObj/selfFirstTxt"
local selfSecondTxt_path = "ImgBg/selfObj/selfSecondTxt"
local container2Go_path = "ImgBg/container2Go"
local loopListView1_path = "ImgBg/container1Go/loopListView1"
local container1Go_path = "ImgBg/container1Go"
local maskBtn_path = "UICommonPopUpTitle/panel"
local empty_txt_path = "ImgBg/TxtEmpty"
local rankTitle_path = "ImgBg/Top/RankTxt"
local nickNameTitle_path = "ImgBg/Top/NickNameTxt"
local scoreTitle_path = "ImgBg/Top/ScoreTxt"
local winTitle_path = "ImgBg/Top/WinTxt"
local loseTitle_path = "ImgBg/Top/LoseTxt"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()

    self:UpdateRankList()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.loopListView2 = self:AddComponent(UIScrollView, loopListView2_path)
    self.loopListView2:SetOnItemMoveIn(function(itemObj, curIndex)
        self:SetWeeklyRankItemIn(itemObj, curIndex)
    end)
    self.loopListView2:SetOnItemMoveOut(function(itemObj, curIndex)
        self:SetWeeklyRankItemOut(itemObj, curIndex)
    end)
    self.titleTxt = self:AddComponent(UITextMeshProUGUIEx, titleTxt_path)
    self.titleTxt:SetLocalText(302127)
    self.closeBtn = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.selfObj = self:AddComponent(UIBaseContainer, selfObj_path)
    self.selfRankTxt = self:AddComponent(UIText, selfRankTxt_path)
    self.selfLevelTxt = self:AddComponent(UIText, selfLevelTxt_path)
    self.selfHeadIcon = self:AddComponent(UIPlayerHead, selfHeadIcon_path)
    self.selfHeadBg = self:AddComponent(UIImage, selfHeadBg_path)
    self.selfWinTxt = self:AddComponent(UIText, selfWinTxt_path)
    self.selfLoseTxt = self:AddComponent(UIText, selfLoseTxt_path)

    self.selfFirstTxt = self:AddComponent(UIText, selfFirstTxt_path)
    self.selfSecondTxt = self:AddComponent(UIText, selfSecondTxt_path)
    self.container2Go = self:AddComponent(UIBaseContainer, container2Go_path)
    self.loopListView1 = self:AddComponent(UIScrollView, loopListView1_path)
    self.loopListView1:SetOnItemMoveIn(function(itemObj, curIndex)
        self:SetDailyRankItemIn(itemObj, curIndex)
    end)
    self.loopListView1:SetOnItemMoveOut(function(itemObj, curIndex)
        self:SetDailyRankItemOut(itemObj, curIndex)
    end)
    self.container1Go = self:AddComponent(UIBaseContainer, container1Go_path)

    self.maskBtn = self:AddComponent(UIButton, maskBtn_path)
    self.maskBtn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.empty_txt = self:AddComponent(UIText, empty_txt_path)
    self.empty_txt:SetLocalText(371004)
    self.rankTxt = self:AddComponent(UIText, rankTitle_path)
    self.rankTxt:SetLocalText(302128)
    self.nickNameTxt = self:AddComponent(UIText, nickNameTitle_path)
    self.nickNameTxt:SetLocalText(302129)
    self.scoreTxt = self:AddComponent(UIText, scoreTitle_path)
    self.scoreTxt:SetLocalText(302126)
    --self.leagueTxt = self:AddComponent(UIText, leagueTitle_path)
    --self.leagueTxt:SetLocalText(361058)
    self.winTitle = self:AddComponent(UIText, winTitle_path)
    self.loseTitle = self:AddComponent(UIText, loseTitle_path)
    self.winTitle:SetLocalText(302122)
    self.loseTitle:SetLocalText(302123)
end

local function ComponentDestroy(self)
    self.loopListView2 = nil
    self.titleTxt = nil
    self.closeBtn = nil
    self.selfObj = nil
    self.selfRankTxt = nil
    self.selfLevelTxt = nil
    self.winTitle = nil
    self.loseTitle = nil
    self.selfHeadIcon = nil
    self.tab1Tog = nil
    self.leagueTog = nil
    self.content = nil
    self.selfFirstTxt = nil
    self.selfSecondTxt = nil
    self.container2Go = nil
    self.loopListView1 = nil
    self.container1Go = nil
    self.container1Animator = nil
    self.container2Animator = nil
    self.maskBtn = nil
    self.rankTxt = nil
    self.nickNameTxt = nil
    self.scoreTxt = nil
    self.leagueTxt = nil
end

local function DataDefine(self)

end

local function DataDestroy(self)

end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.ChampionBattleRankDataBack, self.RefreshRankList)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.ChampionBattleRankDataBack, self.RefreshRankList)
end

local function UpdateRankList(self)
    DataCenter.ActChampionBattleManager:SendChampionBattleRankData()
end

local function RefreshRankList(self, message)
    self.data = message
    if self.data == nil then
        return
    end
    --data
    self.rankList = self.data.rankList
    self.selfRank = self.data.selfRank
    self.selfLoseRound = self.data.selfLoseRound
    self.selfScore = self.data.selfScore
    self.selfWinRound = self.data.selfWinRound

    --if self.selfRank ~= nil then
        self.curSv = self.loopListView1
    --else
    --    self.curSv = self.loopListView2
    --end

    self:ClearScroll()
    if #self.rankList > 0 then
        local totalCount = #self.rankList
        self.curSv:SetTotalCount(totalCount)
        self.curSv:RefillCells()
        self.empty_txt:SetActive(false)
    else
        self.empty_txt:SetActive(true)
    end

    self:SetSelfInfo()
end

local function SetSelfInfo(self)
    --self.selfObj:SetActive(false)
    self.selfHeadIcon.gameObject:SetActive(true)
    local selfPic = LuaEntry.Player:GetPic()
    local selfPicVer = LuaEntry.Player.picVer
    local uid = LuaEntry.Player.uid
    self.selfHeadIcon:SetData(uid,selfPic,selfPicVer)

    local fgImg = LuaEntry.Player:GetHeadBgImg()
    if not string.IsNullOrEmpty(fgImg) then
        self.selfHeadBg:SetActive(true)
        self.selfHeadBg:LoadSprite(fgImg)
    else
        self.selfHeadBg:SetActive(false)
    end

    local name = LuaEntry.Player.name
    local allianceData = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
    self.selfFirstTxt:SetText(name)
    if allianceData ~= nil then
        --self.selfSecondTxt:SetText("["..allianceData.abbr.."]"..allianceData.allianceName)
        self.selfSecondTxt:SetText("["..allianceData.abbr.."]")
    else
        self.selfSecondTxt:SetText("")
    end
    self.selfObj:SetActive(true)

    if self.selfRank ~= nil then
        local score = self.selfScore
        --if score == 0 then
        --    self.selfRankTxt:SetLocalText(361054)
        --else
        self.selfRankTxt:SetText(self.selfRank)
        --end
        self.selfWinTxt:SetText(self.selfWinRound)
        self.selfLoseTxt:SetText(self.selfLoseRound)

        local scoreStr = string.GetFormattedSeperatorNum(score)
        self.selfLevelTxt:SetText(scoreStr)
    else
        self.selfRankTxt:SetText("-")
        self.selfWinTxt:SetText("0")
        self.selfLoseTxt:SetText("0")
        self.selfLevelTxt:SetText("0")
    end
end

local function SetDailyRankItemIn(self, itemObj, curIndex)
    itemObj.name = tostring(curIndex)
    local cellItem = self.curSv:AddComponent(UIChampionBattleRankCell, itemObj)
    cellItem:RefreshItem(self.rankList[curIndex], curIndex)
end

local function SetDailyRankItemOut(self, itemObj, curIndex)
    self.curSv:RemoveComponents(itemObj.name, UIChampionBattleRankCell)
end

local function SetWeeklyRankItemIn(self, itemObj, curIndex)
    itemObj.name = tostring(curIndex)
    local cellItem = self.curSv:AddComponent(UIChampionBattleRankCell, itemObj)
    cellItem:RefreshItem(self.rankList[curIndex], curIndex)
end

local function SetWeeklyRankItemOut(self, itemObj, curIndex)
    self.curSv:RemoveComponents(itemObj.name, UIChampionBattleRankCell)
end


local function ClearScroll(self)
    self.loopListView1:ClearCells()
    self.loopListView1:RemoveComponents(UIChampionBattleRankCell)

    self.loopListView2:ClearCells()
    self.loopListView2:RemoveComponents(UIChampionBattleRankCell)
end

UIChampionBattleRankView.OnCreate = OnCreate
UIChampionBattleRankView.OnDestroy = OnDestroy
UIChampionBattleRankView.OnEnable = OnEnable
UIChampionBattleRankView.OnDisable = OnDisable
UIChampionBattleRankView.ComponentDefine = ComponentDefine
UIChampionBattleRankView.ComponentDestroy = ComponentDestroy
UIChampionBattleRankView.DataDefine = DataDefine
UIChampionBattleRankView.DataDestroy = DataDestroy
UIChampionBattleRankView.OnAddListener = OnAddListener
UIChampionBattleRankView.OnRemoveListener = OnRemoveListener
UIChampionBattleRankView.SetDailyRankItemIn = SetDailyRankItemIn
UIChampionBattleRankView.SetDailyRankItemOut = SetDailyRankItemOut
UIChampionBattleRankView.SetWeeklyRankItemIn = SetWeeklyRankItemIn
UIChampionBattleRankView.SetWeeklyRankItemOut = SetWeeklyRankItemOut
UIChampionBattleRankView.RefreshRankList = RefreshRankList
UIChampionBattleRankView.UpdateRankList = UpdateRankList
UIChampionBattleRankView.ClearScroll = ClearScroll
UIChampionBattleRankView.SetSelfInfo = SetSelfInfo

return UIChampionBattleRankView