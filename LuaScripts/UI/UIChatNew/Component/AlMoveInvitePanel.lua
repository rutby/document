---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/11/23 15:09
---AlMoveInvitePanel

local Localization = CS.GameEntry.Localization
local AlMoveInvitePanel = BaseClass("AlMoveInvitePanel", UIBaseContainer)
local base = UIBaseContainer
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"

local playerHead_path = "UIPlayerHead"
local playerHeadIcon_path = "UIPlayerHead/HeadIcon"
local alFlag_path = "AllianceFlag"
local alNameTxt_path = "alName"
local inviteTxt_path = "inviteTxt"
local inviteTxtBtn_path = "inviteTxt"
local confirmBtn_path = "moveBtn"
local confirmInviteTxt_path = "moveBtn/inviteBtnTxt"
local confirmTxt_path = "moveBtn/cost/moveBtnTxt"
local cost_path = "moveBtn/cost"
local costFreeTxt_path = "moveBtn/cost/costFree"
local costItem_path = "moveBtn/cost/Item_go"
local costItemIcon_path = "moveBtn/cost/Item_go/costItem"
local costGold_path = "moveBtn/cost/Gold_go"
local costGoldTxt_path = "moveBtn/cost/costGoldCount"
local closeBtn_path = "closeBtn"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
    self:SetPanel()
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.playerHeadN = self:AddComponent(UIBaseContainer, playerHead_path)
    self.playerHeadIconN = self:AddComponent(UIPlayerHead, playerHeadIcon_path)
    self.alFlagN = self:AddComponent(AllianceFlagItem, alFlag_path)
    self.alNameTxtN = self:AddComponent(UITextMeshProUGUIEx, alNameTxt_path)
    self.inviteTxtN = self:AddComponent(UITextMeshProUGUIEx, inviteTxt_path)
    self.inviteTxtBtnN = self:AddComponent(UIButton, inviteTxtBtn_path)
    self.inviteTxtBtnN:SetOnClick(function()
        self:OnClickInviteTxtBtn()
    end)
    self.confirmBtnN = self:AddComponent(UIButton, confirmBtn_path)
    self.confirmBtnN:SetOnClick(function()
        self:OnClickConfirmBtn()
    end)
    self.confirmInviteTxtN = self:AddComponent(UITextMeshProUGUIEx, confirmInviteTxt_path)
    self.confirmInviteTxtN:SetLocalText(390198)
    self.confirmBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, confirmTxt_path)
    self.confirmBtnTxtN:SetLocalText(300035)
    self.costFreeTxtN = self:AddComponent(UITextMeshProUGUIEx, costFreeTxt_path)
    self.costFreeTxtN:SetLocalText(130126)
    self.costN = self:AddComponent(UIBaseContainer, cost_path)
    self.costItemN = self:AddComponent(UIBaseContainer, costItem_path)
    self.costItemIconN = self:AddComponent(UIImage, costItemIcon_path)
    self.costGoldN = self:AddComponent(UIBaseContainer, costGold_path)
    self.costGoldTxtN = self:AddComponent(UITextMeshProUGUIEx, costGoldTxt_path)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
end

--控件的销毁
local function ComponentDestroy(self)
    self.playerHeadIconN = nil
    self.alFlagN = nil
    self.alNameTxtN = nil
    self.inviteTxtN = nil
    self.confirmBtnN = nil
    self.confirmBtnTxtN = nil
    self.costFreeTxtN = nil
    self.costItemN = nil
    self.costItemIconN = nil
    self.costGoldN = nil
    self.costGoldTxtN = nil
    self.closeBtnN = nil
end

--变量的定义
local function DataDefine(self)
    self.inviteType = AlMoveInviteType.None
    self.costType = 0
end

local function DataDestroy(self)
    self.inviteType = nil
    self.costType = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)

end

local function OnRemoveListener(self)

    base.OnRemoveListener(self)
end

local function SetPanel(self)
    self.confirmInviteTxtN:SetActive(false)
    self.confirmBtnTxtN:SetActive(false)
    self.costN:SetActive(false)
    self.inviteType = DataCenter.AllianceBaseDataManager:GetAlMoveInvite(UIWindowNames.UIChat)
    if self.inviteType == AlMoveInviteType.LeaderInvite then
        local leaderInfo = DataCenter.AllianceBaseDataManager:GetLeaderInfo()
        if leaderInfo then
            self.playerHeadN:SetActive(true)
            self.alFlagN:SetActive(false)
            self.confirmBtnTxtN:SetActive(true)
            self.costN:SetActive(true)
            self.playerHeadIconN:SetData(leaderInfo.uid, leaderInfo.pic, leaderInfo.picVer)
            local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
            self.alNameTxtN:SetText("[" .. allianceBase.abbr .. "] " .. leaderInfo.name)
            local targetPoint = DataCenter.AllianceBaseDataManager:GetAlMoveInviteTargetPoint(self.inviteType)
            local targetPos = SceneUtils.IndexToTilePos(targetPoint, ForceChangeScene.World)
            local strPos = "(" .. targetPos.x .. ", " .. targetPos.y .. ")"
            self.inviteTxtN:SetText(Localization:GetString("391115", Localization:GetString("302336") .. strPos))
        else
            self:SetActive(false)
        end
    elseif self.inviteType == AlMoveInviteType.SystemInvite then
        local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBase then
            self.playerHeadN:SetActive(false)
            self.alFlagN:SetActive(true)
            self.confirmBtnTxtN:SetActive(true)
            self.costN:SetActive(true)
            self.alFlagN:SetData(allianceBase.icon)
            local leaderInfo = DataCenter.AllianceBaseDataManager:GetLeaderInfo()
            local tempName = leaderInfo and leaderInfo.name or allianceBase.allianceName
            self.alNameTxtN:SetText("[" .. allianceBase.abbr .. "] " .. tempName)
            local targetPoint = DataCenter.AllianceBaseDataManager:GetAlMoveInviteTargetPoint(self.inviteType)
            local targetPos = SceneUtils.IndexToTilePos(targetPoint, ForceChangeScene.World)
            local strPos = "(" .. targetPos.x .. ", " .. targetPos.y .. ")"
            self.inviteTxtN:SetText(Localization:GetString("391115", Localization:GetString("390327") .. strPos))
        else
            self:SetActive(false)
        end
    elseif self.inviteType == AlMoveInviteType.InviteTip then
        local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBase then
            self.playerHeadN:SetActive(false)
            self.alFlagN:SetActive(true)
            self.confirmInviteTxtN:SetActive(true)
            self.alFlagN:SetData(allianceBase.icon)
            local leaderInfo = DataCenter.AllianceBaseDataManager:GetLeaderInfo()
            --local tempName = leaderInfo and leaderInfo.name or allianceBase.allianceName
            self.alNameTxtN:SetLocalText(391077)
            --local targetPoint = DataCenter.AllianceBaseDataManager:GetAlMoveInviteTargetPoint()
            --local targetPos = SceneUtils.IndexToTilePos(targetPoint, ForceChangeScene.World)
            --local strPos = "(" .. targetPos.x .. ", " .. targetPos.y .. ")"
            self.inviteTxtN:SetLocalText(391119)
        else
            self:SetActive(false)
        end
    else
        self:SetActive(false)
    end
    
    self:SetCost()
end

local function SetCost(self)
    if LuaEntry.Player:CheckIfHasFreeAlMove() then
        self.costFreeTxtN:SetActive(true)
        self.costItemN:SetActive(false)
        self.costGoldN:SetActive(false)
        self.costType = 1
    else
        self.costFreeTxtN:SetActive(false)
        local item = DataCenter.ItemData:GetItemById(SpecialItemId.ITEM_ALLIANCE_CITY_MOVE)
        local itemCount = item and item.count or 0
        if itemCount > 0 then
            self.costItemN:SetActive(true)
            self.costGoldN:SetActive(false)
            self.costType = 2
        else
            self.costItemN:SetActive(false)
            self.costGoldN:SetActive(true)
            local price = LuaEntry.DataConfig:TryGetNum("union_move", "k3") or 0
            self.costGoldTxtN:SetText(price)
            self.costType = 3
        end
    end
end


local function OnClickConfirmBtn(self)
    if self.inviteType == AlMoveInviteType.InviteTip then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceMainTable,{ anim = true}, nil, 3, AllianceButtonType.AllianceMoveInvite)
        DataCenter.AllianceBaseDataManager:SetInviteViewed(self.inviteType)
        self:SetActive(false)
        self.view.ctrl:CloseSelf()
        --SFSNetwork.SendMessage(MsgDefines.InviteMoveCity)
        --UIUtil.ShowTipsId(390196)
    else
        if DataCenter.AllianceBaseDataManager:CheckIfIsVirtualLeader() then
            UIUtil.ShowTipsId(390863)
            DataCenter.AllianceBaseDataManager:SetInviteViewed(self.inviteType)
        else
            --local tipType = self.inviteType == AlMoveInviteType.LeaderInvite and MoveCityTipType.LeaderInvite or MoveCityTipType.SystemInvite
            DataCenter.AllianceBaseDataManager:OpenMoveCityTipWithReq(self.inviteType)
        end
    end
    
end

local function OnClickCloseBtn(self)
    if self.inviteType == AlMoveInviteType.InviteTip then
        DataCenter.AllianceBaseDataManager:SetInviteViewed(AlMoveInviteType.LeaderInvite)
    else
        UIUtil.ShowTipsId(391114)
        SFSNetwork.SendMessage(MsgDefines.RefuseAllianceMoveInvite)
        DataCenter.AllianceBaseDataManager:SetInviteResponded(self.inviteType)
        self:SetActive(false)
    end
end

local function OnClickInviteTxtBtn(self)
    if self.inviteType == AlMoveInviteType.SystemInvite or self.inviteType == AlMoveInviteType.LeaderInvite then
        local targetPoint = DataCenter.AllianceBaseDataManager:GetAlMoveInviteTargetPoint(self.inviteType)
        GoToUtil.GotoWorldPos(SceneUtils.TileIndexToWorld(targetPoint,ForceChangeScene.World), CS.SceneManager.World.InitZoom)
    end
end

AlMoveInvitePanel.OnCreate = OnCreate
AlMoveInvitePanel.OnDestroy = OnDestroy
AlMoveInvitePanel.OnEnable = OnEnable
AlMoveInvitePanel.OnDisable = OnDisable
AlMoveInvitePanel.ComponentDefine = ComponentDefine
AlMoveInvitePanel.ComponentDestroy = ComponentDestroy
AlMoveInvitePanel.DataDefine = DataDefine
AlMoveInvitePanel.DataDestroy = DataDestroy
AlMoveInvitePanel.OnAddListener = OnAddListener
AlMoveInvitePanel.OnRemoveListener = OnRemoveListener

AlMoveInvitePanel.SetPanel = SetPanel
AlMoveInvitePanel.SetCost = SetCost
AlMoveInvitePanel.OnClickConfirmBtn = OnClickConfirmBtn
AlMoveInvitePanel.OnClickCloseBtn = OnClickCloseBtn
AlMoveInvitePanel.OnClickInviteTxtBtn = OnClickInviteTxtBtn

return AlMoveInvitePanel