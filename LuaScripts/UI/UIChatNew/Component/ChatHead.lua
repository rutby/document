---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/21/21 9:59 AM
---
local ChatHead = BaseClass("ChatHead", UIBaseContainer)
local base = UIBaseContainer

local _cp_headImg = "Image";
local _cp_headBtn = "HeadBtn"
local _cp_headFg = "HeadFg"
local _cp_countryFlag = "countryFlag"

function ChatHead:ComponentDefine()
    self._headImg = self.transform:Find(_cp_headImg):GetComponent(typeof(CS.UIPlayerHead))
    if self._headImg~=nil then
        if IsNull(self._headImg) then
            self.chatGameObjectIsNull = 1
        else
            self.chatGameObjectIsNull = 0
        end
        self.chatIsNull = 0
    else
        self.chatIsNull = 1
        self.chatGameObjectIsNull = 1
    end
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.chatCreateTime = curTime
    self._imgUser = self:AddComponent(UIImage, _cp_headImg)
    self._chatHeadFg = self:AddComponent(UIImage, _cp_headFg)
    self._countryFlag = self:AddComponent(UIImage, _cp_countryFlag)
    self._headBtn = self:AddComponent(UIButton, _cp_headBtn) -- 根节点是个按钮组件
    self._headBtn:SetOnClick(function ()
        self:OnClickBtn()
    end)
end

function ChatHead:DataDefine()
    self.chatCreateTime = 0
    self.chatIsNull = 1
    self.chatGameObjectIsNull = 1
    self.chatDestroyTime = 0
    self._chatdata = nil
    self._userInfo = nil
    self._lastUid = nil
    self._lastPic = nil
    self._lastPicVer = nil
end
function ChatHead:OnDestroy()
    local curTime = UITimeManager:GetInstance():GetServerTime()
    self.chatDestroyTime = curTime
    base.OnDestroy(self)
end
function ChatHead:OnCreate()
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 打开
function ChatHead:OnEnable()
    base.OnEnable(self)
end

-- 关闭
function ChatHead:OnDisable()
    base.OnDisable(self)
end

function ChatHead:OnAddListener()
    self:AddUIListener(EventId.UPDATE_MSG_USERINFO, self.UpdateHeadAfterCmdRecv);
end

function ChatHead:OnRemoveListener()
    self:RemoveUIListener(EventId.UPDATE_MSG_USERINFO, self.UpdateHeadAfterCmdRecv);
end

function ChatHead:UpdateHead( userinfo, chatdata )
    self._userInfo = userinfo
    self._chatdata = chatdata
	self:__UpdateHead()
    self:CheckVipFrame()
    self:ShowCountryFlag()
end

function ChatHead:CheckVipFrame()
    if self._chatHeadFg then
        if self._userInfo then
            local tempFg = self._userInfo:GetHeadBgImg()
            if tempFg then
                self._chatHeadFg:SetActive(true)
                self._chatHeadFg:LoadSprite(tempFg)
            else
                self._chatHeadFg:SetActive(false)
            end
        else
            self._chatHeadFg:SetActive(false)
        end
    end
end

function ChatHead:ShowCountryFlag()
    if self._userInfo and self._userInfo.uid ~= ChatGMUserId then
        local tempNation = self._userInfo and self._userInfo.nation or DefaultNation
        if not LuaEntry.Player:IsHideCountryFlag() then
            self._countryFlag:SetActive(true)
            local nationTemplate = DataCenter.NationTemplateManager:GetNationTemplate(tempNation)
            local flagPath = nationTemplate:GetNationFlagPath()
            self._countryFlag:LoadSprite(flagPath)
        else
            self._countryFlag:SetActive(false)
        end
    else
        self._countryFlag:SetActive(false)
    end
end

function ChatHead:__UpdateHead()
	if (self._userInfo ~= nil) then
		-- 设置默认头像
		local userId = self._userInfo["uid"] or ""
		local userPic = self._userInfo["headPic"] or ""
        if (self._userInfo:IsGmUser()) then
            userPic = self._userInfo:GetGMIcon()
        end
		local userPicVer = self._userInfo["headPicVer"] or 0
		self._headImg:SetData(userId, userPic, userPicVer)
	else
		-- 设置自定义头像
		self._headImg:UseSystemHead()
	end
end

function ChatHead:ShowGmImage()
    self._imgUser:LoadSprite("Assets/Main/Sprites/UI/UIHeadIcon/player_head_2.png")
end

function ChatHead:UpdateHeadAfterCmdRecv()
   self:__UpdateHead()
end

function ChatHead:OnClickBtn()
    if (self._chatdata == nil or self._userInfo == nil) then
        return
    end
    
    local playerUid = self._userInfo["uid"]
    if (string.IsNullOrEmpty(playerUid)) then
        return
    end
    if (playerUid == ChatGMUserId) then
        return
    end
    if (playerUid == ChatInterface.getPlayerUid()) then
        return
    end
    local param = {}
    param["chatdata"] = self._chatdata
	param["userinfo"] = self._userInfo
    param["targetPos"] = self._headImg.transform
    --local _tmpPos = self._headImg.transform.position
    --ChatPrint(">>>> targetPos:  X: " .. tostring(_tmpPos.x) .. "  Y: " .. tostring(_tmpPos.y) .. "  Z: " .. tostring(_tmpPos.z))
	UIManager:GetInstance():OpenWindow(UIWindowNames.UIChatCommanderTips,{ anim = false }, param)
end

return ChatHead