---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/30/21 6:27 PM
---
--[[
    这个是聊天界面中左侧房间列表的滑动管理器.在这个地方通过EventTrigger来统一管理
    
    1.左右滑动的时候,检测roomcell是否点中,如果点中则控制cell的scrollrect来相应,
        如果没有点中roomcell,则对chatview进行左右拖动的处理
    2.如果上下滑动,则直接对scrollrectlist进行相应,进行上下滑动的处理
]]


local ChatRoomCellSlideNode = BaseClass("ChatRoomCellSlideNode")



function ChatRoomCellSlideNode:__init( ... )
    local param = { ... }
    self._scrollRectList = {}

    if (table.length(param) > 0) then
        param = param[1]
    end

    self._chatView = param["chatview"]
    
    local _scrollRect1 = param["mScrollRect1"]
    self._scrollRectList[#self._scrollRectList+1] = _scrollRect1

    -- 用来表示当前左右滑动的情况下,指定的房间
    self._curRoomCell = nil 
    -- 水平滑动
    self._isHorizontal = false
    -- 是否正在移动整体的聊天界面
    self._isMovingChatPanel = false

    self._isDragChild = false
    self._d0 = 0.3
    self._isComplete = true
    self._touchScreenPosX = 0
    self._moveDistance = 72/1920 * Screen.width

    -- 记录初始位置
    self._touchBeganPosition = nil;

end

function ChatRoomCellSlideNode:GetMoveDeltaX()
    local deltaX = 0
    if CS.SDKManager.IS_UNITY_EDITOR() then
        deltaX = CS.UnityEngine.Input:GetAxis("Mouse X");
    elseif CS.SDKManager.IS_UNITY_ANDROID() or CS.SDKManager.IS_UNITY_IOS() then
        deltaX = CS.UnityEngine.Input:GetTouch(0).deltaPosition.x;
    end
    return deltaX
end

-- 停止所有scroll滑动
function ChatRoomCellSlideNode:StopAllMovement()
    self._isComplete = true
    for _, v in pairs(self._scrollRectList) do
        v:StopMovement()
    end
    --for _, v in pairs(self._chatRoomCellList) do
    --    v:StopMovement()
    --end
end

function ChatRoomCellSlideNode:OnBeginDrag( eventData )
    self:StopAllMovement()
    self._chatRoomCellList = self._chatView:GetRoomNodeList()
    local touchDeltaPosition = eventData.delta
    self._touchScreenPosX = eventData.position.x;
    self._curRoomCell = nil
    if (Mathf.Abs(touchDeltaPosition.x) < Mathf.Abs(touchDeltaPosition.y)) then -- 表示左右滑动
        self:OnBeginDragVertical(eventData)
    else
        self:OnBeginDragHorizontal(eventData)
    end
end

-- 水平滑动
function ChatRoomCellSlideNode:OnBeginDragHorizontal(eventData)
    -- 检测是否是房间列表滑动,如果是则使用 _curRoomCell 表示指定房间列表
    self._isHorizontal = true
    for _, v in pairs(self._chatRoomCellList) do
        if (v:IsReceiver(eventData.position)) then
            self._curRoomCell = v;
            v:OnBeginDrag(eventData)
            goto continue
        end
    end
    ::continue::
    self:StopAllMovement()
end

-- 竖直滑动
function ChatRoomCellSlideNode:OnBeginDragVertical(eventData) 
    self._isHorizontal = false
    for _, v in pairs(self._scrollRectList) do
        v:OnBeginDrag(eventData)
    end
end

function ChatRoomCellSlideNode:OnDrag(eventData)
    if (self._isHorizontal == true) then
        self:OnDragHorizontal(eventData)
    else
        self:OnDragVertical(eventData)
    end
end

-- 水平 drag 房间列表+整个聊天界面的左右滑动[检测超过一定竖直,直接做dotween动画]
function ChatRoomCellSlideNode:OnDragHorizontal( eventData )
    self:StopAllMovement()
    -- 如果 _curRoomCell 不为空,表示刚触发的时候为拖动房间
    if (self._curRoomCell ~= nil) then
        self._curRoomCell:OnDrag(eventData)
    else -- 对聊天界面如果拖动超过一定范围直接做动画移动
        if (Mathf.Abs(eventData.position.x - self._touchScreenPosX) > self._moveDistance) then
            -- 防止拖动时多次触发
            if (self._isMovingChatPanel == true) then
                return
            end
            self._isMovingChatPanel = true
            if (eventData.delta.x > 0) then
                self._chatView:SlideRight(0)
            else
                self._chatView:SlideLeft()
            end
        end
    end
end
-- 竖直 drag 直接对列表进行上下拖动
function ChatRoomCellSlideNode:OnDragVertical(eventData)
    for _, v in pairs(self._scrollRectList) do
        v:OnDrag(eventData)
    end
end

function ChatRoomCellSlideNode:OnEndDrag(eventData)
    if (self._isHorizontal) then
        self:OnEndDragHorizontal(eventData)
    else
        self:OnEndDragVertical(eventData)
    end
end

function ChatRoomCellSlideNode:OnEndDragHorizontal(eventData)
    if(self._curRoomCell ~= nil) then -- 移动的是roomcell
        for _, v in pairs(self._chatRoomCellList) do
            if (v ~= self._curRoomCell) then
                v:ResetLeftAlign()
            else
                v:OnEndDrag(eventData)
            end
        end
    else
        self._isMovingChatPanel = false
    end
end

function ChatRoomCellSlideNode:OnEndDragVertical(eventData)
    for _, v in pairs(self._scrollRectList) do
        v:OnEndDrag(eventData)
    end
end


return ChatRoomCellSlideNode