---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/31 14:43
---


local IChatItem = require("UI.UIChatNew.Component.ChatItem.IChatItem")
local ChatItemAllianceTaskShare = BaseClass("ChatItemAllianceTaskShare", IChatItem)
local base = IChatItem
local Localization = CS.GameEntry.Localization
local ChatHead = require("UI.UIChatNew.Component.ChatHead")
local ChatUserName = require "UI.UIChatNew.Component.ChatItem.ChatUserName"
local rapidjson = require "rapidjson"

local _cp_chatHead = "ChatHead"
local _cp_ShareTitle = "ChatShareNode/Image/ShareTitle";
local _cp_shareMsg = "ChatShareNode/ShareIconNode/ShareMsg/ShareMsg"
local _cp_shareNode = "ChatShareNode";
local _cp_chatNameLayout = "ChatNameLayout"
local _cp_shareIcon = "ChatShareNode/ShareIconNode/Image"
local _cp_prog = "ChatShareNode/ShareIconNode/Progress"
local _cp_progTxt = "ChatShareNode/ShareIconNode/Progress/Txt_Progress"

local Const_Min_ShareNodeHeight = 120
local Const_OneLineHeight = 26



local UnityOutLine = typeof(CS.UnityEngine.UI.Outline)
function ChatItemAllianceTaskShare:ComponentDefine()
    self._chatHead = self:AddComponent(ChatHead, _cp_chatHead)
    self._shareTitle = self:AddComponent(UITextMeshProUGUIEx, _cp_ShareTitle)
    --self._shareTitleOutline = self._shareTitle.gameObject:GetComponent(UnityOutLine)
    self._shareMsg = self:AddComponent(UITextMeshProUGUIEx, _cp_shareMsg)
    self._shareNode = self:AddComponent(UIButton, _cp_shareNode)
    self._shareNode:SetOnClick(BindCallback(self, self.OnClickBg) )
    self._chatNameLayout = self:AddComponent(ChatUserName, _cp_chatNameLayout)
    self._shareIcon = self:AddComponent(UIImage, _cp_shareIcon)
    self._shareProg = self:AddComponent(UISlider, _cp_prog)
    self._shareProgTxt = self:AddComponent(UITextMeshProUGUIEx, _cp_progTxt)
end

function ChatItemAllianceTaskShare:OnClickBg()
    if (self.attachInfo ~= nil) then
        EventManager:GetInstance():Broadcast(ChatInterface.getEventEnum().LF_CloseChatView,true)
        local tempIndex = DataCenter.AllianceTaskManager:GetTaskIndex(self.attachInfo.taskId)
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceTask, tempIndex)
    end
end

function ChatItemAllianceTaskShare:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

function ChatItemAllianceTaskShare:UpdateItem( chatdata, index )
    base.UpdateItem(self, chatdata, index)
    if (chatdata == nil) then
        return
    end
    local attachmentId = chatdata["attachmentId"] or ""
    local tabAttachment = rapidjson.decode(attachmentId) or {}
    self.attachInfo = tabAttachment

    --self._shareIcon:LoadSprite("Assets/Main/Sprites/UI/UIMain/UIMainNew/UIMain_btn_alliance.png")

    local msgTb = chatdata:getMessageParam(false)
    self._shareTitle:SetLocalText(msgTb.taskName)
    --self._shareTitle:SetColor(Const_Color_Green)
    --self._shareTitleOutline.effectColor = Const_Green_Outline
    self._shareMsg:SetLocalText(310000)
    local maxProg = msgTb.maxProg or 100
    self._shareProg:SetValue(msgTb.curProg / maxProg)
    self._shareProgTxt:SetText(msgTb.curProg .. "/" .. maxProg)

    local senderUid = chatdata["senderUid"]
    local _userInfo = ChatManager2:GetInstance().User:getChatUserInfo(senderUid, true)
    if (self._chatNameLayout) then
        self._chatNameLayout:UpdateName(_userInfo, chatdata)
    end

    -- 获取文本的高度,最小高度是120,之前预留了一行的高度,所以在获取真实高度的时候,需要将之前一行的高度给减去
    -- 给分享框设置尺寸
    local height = self._shareMsg:GetHeight()
    local curHeight = Const_Min_ShareNodeHeight+height-Const_OneLineHeight
    height = Mathf.Max(Const_Min_ShareNodeHeight, curHeight)
    local size_x, size_y = self._shareNode.rectTransform:Get_sizeDelta()
    self._shareNode.rectTransform:Set_sizeDelta(size_x, height)

    -- 给当前节点设置尺寸
    local r_x, _ = self.rectTransform:Get_sizeDelta()
    self.rectTransform:Set_sizeDelta(r_x, height+40)

    self:UpdateTopOffset()
end

-- override
function ChatItemAllianceTaskShare:GetTopOffset()
    if self._chatNameLayout then
        return self._chatNameLayout:GetTopOffset()
    else
        return 0
    end
end

-- override
function ChatItemAllianceTaskShare:UpdateTopOffset()
    local initOffset = 40
    local topOffset = self:GetTopOffset()
    local sizeX, sizeY = self.rectTransform:Get_sizeDelta()
    self.rectTransform:Set_sizeDelta(sizeX, sizeY + topOffset)
    self:SetTransPosY(self._shareNode.rectTransform, - (initOffset + topOffset))
end

return ChatItemAllianceTaskShare