---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 7/5/21 4:40 PM
---
--[[
    联盟分享
]]

local IChatItem = require("UI.UIChatNew.Component.ChatItem.IChatItem")
local ChatItemAllianceShare = BaseClass("ChatItemAllianceShare", IChatItem)
local base = IChatItem
local Localization = CS.GameEntry.Localization
local ChatHead = require("UI.UIChatNew.Component.ChatHead")
local ChatUserName = require "UI.UIChatNew.Component.ChatItem.ChatUserName"

local _cp_headIcon = "ChatHead"
local _cp_chatName = "ChatNameLayout"
local _cp_chatShareNode = "ChatShareAllianceNode"
local _cp_allianceImg = "ChatShareAllianceNode/alliance_icon_bg/alliance_icon"
local _cp_btnApply = "ChatShareAllianceNode/btnJump"
local _cp_txtApply = "ChatShareAllianceNode/btnJump/btnTxt"
local _cp_imgBg = "ChatShareAllianceNode/Image" -- 背景图

function ChatItemAllianceShare:ComponentDefine()
    self._chatHead = self:AddComponent(ChatHead, _cp_headIcon)
    self._chatShareNode = self:AddComponent(UIBaseContainer, _cp_chatShareNode)
    self._allianceImg = self:AddComponent(UIImage, _cp_allianceImg)
    self._btnApply = self:AddComponent(UIButton, _cp_btnApply)
    self._btnApply:SetOnClick(BindCallback(self, self.OnClickBtnJump))
    self._txtApply = self:AddComponent(UITextMeshProUGUIEx, _cp_txtApply)
    self._imgBg = self:AddComponent(UIBaseContainer, _cp_imgBg)
    -- 名字节点,左侧的有,右侧的没有,find后再addcomponent
    if (self.transform:Find(_cp_chatName) ~= nil) then
        self._chatUserName = self:AddComponent(ChatUserName, _cp_chatName)
    end
end

function ChatItemAllianceShare:OnClickBtnJump()
    if (self._chatData["post"] > 0) then
		EventManager:GetInstance():Broadcast(ChatInterface.getEventEnum().CHAT_SHARE_EXECUTE_CMD, self._chatData)
    end
end

function ChatItemAllianceShare:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

function ChatItemAllianceShare:UpdateUserInfo()
    
end

function ChatItemAllianceShare:UpdateItem( _chatdata )
    if (_chatdata == nil) then
        return
    end

    self._chatData = _chatdata
    local senderUid = self._chatData["senderUid"]
    self._userInfo = ChatManager2:GetInstance().User:getChatUserInfo(senderUid, true)
    -- 
    local _nameText = self._chatShareNode.transform:Find("AllianceName"):GetComponent(typeof(CS.UnityEngine.UI.Text))
    local _power = self._chatShareNode.transform:Find("Power"):GetComponent(typeof(CS.UnityEngine.UI.Text))
    local _member = self._chatShareNode.transform:Find("Member"):GetComponent(typeof(CS.UnityEngine.UI.Text))
    local _shareMsg = self._chatShareNode.transform:Find("ShareMsg"):GetComponent(typeof(CS.UnityEngine.UI.Text))
	
	-- 获取到消息相关的参数，然后显示
	local param = _chatdata:getMessageParam()
	if param then
		if param.abbr and param.name then
    		_nameText.text = "[" .. param.abbr .. "]" .. param.name
		end
		
		if param.power then
    		_power.text = Localization:GetString("100253") .. tostring(param.power)
		end
		
		if param.c and param.mc then
    		_member.text = Localization:GetString("390199") .. ": " .. param.c .. "/" .. param.mc
		end
    	_shareMsg.text = _chatdata:getMessageWithExtra(false)
	    self:AdjustView(_shareMsg)
    end
	
    self._txtApply:SetLocalText(110003) 
    
    -- 头像部分处理
    if (self._chatHead ~= nil) then
        self._chatHead:UpdateHead(self._userInfo, self._chatData)
    end
    
    -- 名字部分
    if (self._chatUserName) then
        self._chatUserName:UpdateName(self._userInfo, self._chatData)
    end
    
    --local _message = _chatdata:getMessageWithExtra(false)
    --self._text:SetText(_message)
    ---- 设置背板高度,在语言部分高度+6
    --local textHeight = self._text:GetHeight()
    ---- emoji控件有点问题,暂时没有细查 preferredWidth 不会随着换行而减小
    --local preferredWidth = self._text:GetWidth()
    --local sizeDeltaX = self._text.rectTransform.sizeDelta.x
    --local setX = preferredWidth  > sizeDeltaX and sizeDeltaX or preferredWidth
    --local textWidth = setX+5
    --self._imgBg.rectTransform.sizeDelta = Vector2.New(textWidth, textHeight)
    --local selfWidth = self.rectTransform.sizeDelta.x
    --self.rectTransform.sizeDelta = Vector2.New(selfWidth, textHeight+5)
end

-- 调整界面布局
function ChatItemAllianceShare:AdjustView( lbShare )
    -- 获取文本框的大小,在文本框大小的基础上加上固定值[上面联盟信息部分的大小和中间区域的一个固定值]
    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate( lbShare.rectTransform)
    --local oldBgWidth = self._imgBg.rectTransform.sizeDelta.x
	local oldBgWidth, _ = self._imgBg.rectTransform:Get_sizeDelta()
    local oldBgHeight = 100
    local labelHeight = lbShare.preferredHeight
    
	--[[
    local bgSize = Vector2.New(oldBgWidth, oldBgHeight+labelHeight+15) -- +15是为了底部留一些空隙
    -- 设置背景大小
    self._imgBg.rectTransform.sizeDelta = bgSize
    -- 设置分享节点的大小
    self._chatShareNode.rectTransform.sizeDelta = bgSize
    -- 设置cell大小
    local oldCellSize = self.rectTransform.sizeDelta
    self.rectTransform.sizeDelta = Vector2.New(oldCellSize.x, oldBgHeight+labelHeight+15+24) -- +15是为了底部留一些空隙 +24是上面还有名字的节点
	]]
	
	local x = oldBgWidth
	local y = oldBgHeight+labelHeight+15-- +15是为了底部留一些空隙
	-- 设置背景大小
	self._imgBg.rectTransform:Set_sizeDelta(x, y)
	-- 设置分享节点的大小
	self._chatShareNode.rectTransform:Set_sizeDelta(x, y)
	-- 设置cell大小
	local oldCellSize_x, oldCellSize_y = self.rectTransform:Get_sizeDelta()
	self.rectTransform:Set_sizeDelta(oldCellSize_x, y+24) -- +15是为了底部留一些空隙 +24是上面还有名字的节点

end

return ChatItemAllianceShare