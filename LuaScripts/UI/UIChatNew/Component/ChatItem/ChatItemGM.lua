---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/2/7 20:57
---
local IChatItem = require("UI.UIChatNew.Component.ChatItem.IChatItem")
local ChatItemGM = BaseClass("ChatItemGM", IChatItem)
local base = IChatItem
local Localization = CS.GameEntry.Localization
local ChatHead = require("UI.UIChatNew.Component.ChatHead")
local ChatUserName = require "UI.UIChatNew.Component.ChatItem.ChatUserName"
local ChatViewController = require "UI.UIChatNew.Controller.ChatViewUtils"
local _cp_chatHead = "ChatHead"
local _cp_chatUserName = "ChatNameLayout"

local _cp_anchorTransform = "ChatAnchor";
local _cp_bgImg = "ChatAnchor/Background";
local _cp_chatNormalBg = "ChatAnchor/Background/NormalBg";
local _cp_dlgText = "ChatAnchor/Background/DialogText";
local _cp_dividingLine = "ChatAnchor/Background/DialogText/Image";

local _cp_clickObj = "ChatAnchor/Background/clickObj"
local _cp_detailBtn = "ChatAnchor/Background/clickObj/detailBtn"
local _cp_detailText = "ChatAnchor/Background/clickObj/detailBtn/detailBtnTxt"
local _cp_chatBtn = "ChatAnchor/Background/clickObj/chatBtn"
local _cp_chatText = "ChatAnchor/Background/clickObj/chatBtn/chatBtnTxt"
local UnityOutLine = typeof(CS.UnityEngine.UI.Outline)

function ChatItemGM:ComponentDefine()
    self._chatHead = self:AddComponent(ChatHead, _cp_chatHead)
    self._chatUserName = self:AddComponent(ChatUserName, _cp_chatUserName)

    self._rectTransform = self.rectTransform
    self._anchorTransform = self.transform:Find(_cp_anchorTransform):GetComponent(typeof(CS.UnityEngine.RectTransform))

    self._bgImg = self:AddComponent(UIImage, _cp_bgImg)
    self._chatNormalBg = self:AddComponent(UIImage, _cp_chatNormalBg)
    self._dlgText = self:AddComponent(UIText, _cp_dlgText)
    self._dividingLine = self:AddComponent(UIImage, _cp_dividingLine)
    self._clickObj = self:AddComponent(UIBaseContainer, _cp_clickObj)
    self._detailBtn = self:AddComponent(UIButton, _cp_detailBtn)
    self._detailBtn:SetOnClick(BindCallback(self, self.OnDetailClick))
    self._detailBtn:SetActive(false)
    self._detailText = self:AddComponent(UITextMeshProUGUIEx, _cp_detailText)
    self._detailText:SetLocalText(121544)
    self._chatBtn = self:AddComponent(UIButton, _cp_chatBtn)
    self._chatBtn:SetOnClick(BindCallback(self, self.OnChatClick))
    self._chatText = self:AddComponent(UITextMeshProUGUIEx, _cp_chatText)
    self._chatText:SetLocalText(121545)
    self._chatBtn:SetActive(false)
end


function ChatItemGM:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

function ChatItemGM:UpdateItem( chatdata, index )
    base.UpdateItem(self, chatdata, index)
    if (chatdata == nil) then
        return
    end
    if (self._dlgText ~= nil) then
        self._dlgText.gameObject:SetActive(true)
    end
    self._dlgText:SetText(self._chatData:getMessageWithExtra(false))
    local maxWidth = self._chatViewController:GetChatItemMaxWidth()
    local minHeight = self._chatViewController:GetChatLeftItemMinHeight()
    self:SetSize(Vector2.New(maxWidth, minHeight))

    local textWidth = self._dlgText:GetWidth()
    local textHeight = self._dlgText:GetHeight()
    local topHeight = 50
    local x,y = self._clickObj.rectTransform:Get_sizeDelta()
    local _width = Mathf.Min(textWidth+127, maxWidth)
    local _height = Mathf.Max(textHeight+16+topHeight+y,minHeight)
    self:UpdateSpecialLayout(_width, _height,false)
end

-- override
function ChatItemGM:GetTopOffset()
    if self._chatNameLayout then
        return self._chatNameLayout:GetTopOffset()
    else
        return 0
    end
end

function ChatItemGM:UpdateSpecialLayout( sourceWidth, sourceHeight)
    local size = Vector2.New(sourceWidth, sourceHeight)
    self:SetSize(size)
end

function ChatItemGM:SetSize( _size )
    local _, anchor_sizeDelta_cy = self._anchorTransform:Get_sizeDelta()
    local rect_sizeDelta_cx, _ = self._rectTransform:Get_sizeDelta()
    local topOffset = self:GetTopOffset()

    self._anchorTransform:Set_sizeDelta(Mathf.Ceil(_size.x), anchor_sizeDelta_cy)
    self._rectTransform:Set_sizeDelta(rect_sizeDelta_cx, Mathf.Ceil(_size.y + topOffset))

    self:SetTransPosY(self._anchorTransform, - topOffset)
end

function ChatItemGM:GetSize()
    local anchor_sizeDelta_cx, _ = self._anchorTransform:Get_sizeDelta()
    local _, rect_sizeDelta_cy = self._rectTransform:Get_sizeDelta()

    return Vector2.New(anchor_sizeDelta_cx, rect_sizeDelta_cy)
end

function ChatItemGM:OnDetailClick()
    --local url = "https://metapoint.club/faq/aps/i18n/"
    --local targetLang = ChatInterface.getLanguageName()
    --if targetLang~=nil and targetLang~="" then
    --    url = url..targetLang
    --else
    --    url = url.."en"
    --end
    --CS.UnityEngine.Application.OpenURL(url);
end
function ChatItemGM:OnChatClick()
    self._chatViewController:SetStartGmChatTime(UITimeManager:GetInstance():GetServerSeconds())
    self.view:UpdateGmChatBtn()
end
return ChatItemGM