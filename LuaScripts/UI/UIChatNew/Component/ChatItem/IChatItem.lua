---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/11/21 7:15 PM
---

local IChatItem = BaseClass("IChatItem", UIBaseContainer)
local base = UIBaseContainer

local chat_scroll_view_path = ""; -- 定义event节点

function IChatItem:UpdateItem( _chatdata, index )
    self._chatData = _chatdata
    self.index =index
    self:UpdateUserInfoWithNew()
end

function IChatItem:OnAddListener()
    base.OnAddListener(self)

    local ChatEventEnum = ChatInterface.getEventEnum()
    self:AddUIListener(EventId.UPDATE_MSG_USERINFO, self.UpdateUserInfoWithNew);
    self:AddUIListener(ChatEventEnum.UPDATE_USER_MSG, self.UpdateMsg);
end

function IChatItem:OnRemoveListener()

    local ChatEventEnum = ChatInterface.getEventEnum()
    self:RemoveUIListener(EventId.UPDATE_MSG_USERINFO, self.UpdateUserInfoWithNew);
    self:RemoveUIListener(ChatEventEnum.UPDATE_USER_MSG, self.UpdateMsg);
    base.OnRemoveListener(self)
end

function IChatItem:UpdateMsg(chatData)
    if self._chatData == nil or chatData == nil then
        return
    end
    local oldResId = self._chatData:getSeqId()
    local newResId = chatData:getSeqId()
    if oldResId == newResId then
        self._chatData = chatData
        self:UpdateItem(self._chatData,self.index)
    end
end
function IChatItem:UpdateUserInfoWithNew()
    if (self._chatData == nil) then
        return
    end
    local senderUid = self._chatData["senderUid"]
    self._userInfo = ChatInterface.getUserData(senderUid)
    --local str = table.dump(self._userInfo, "测试", 20)
    --print(">>>lsz 更新了.更新了 \n" .. tostring(str))
    if (self._chatHead ~= nil) then
        local ok, errorMsg = xpcall(function()
            self._chatHead:UpdateHead(self._userInfo, self._chatData)
        end, debug.traceback)
        if not ok then
            local chatIsNull = self._chatHead.chatIsNull
            local chatGameObjectIsNull = self._chatHead.chatGameObjectIsNull
            local chatCreateTime = self._chatHead.chatCreateTime
            local chatDestroyTime = self._chatHead.chatDestroyTime
            local errorStr = "target is Destroyed"
            if chatIsNull~=nil and chatGameObjectIsNull~=nil and chatCreateTime~=nil and chatDestroyTime~=nil then
                errorStr = "chatIsNull:"..chatIsNull.."chatGameObjectIsNull:"..chatGameObjectIsNull.."chatCreateTime"..chatCreateTime.."chatDestroyTime"..chatDestroyTime
            end
            local now = UITimeManager:GetInstance():GetServerSeconds()
            local errorMsgStr = "the chatHeadGameObject is Null:"..errorStr..errorMsg
            CommonUtil.SendErrorMessageToServer(now, now, errorMsgStr)
            Logger.LogError(errorMsgStr)
        end
    end
    
    if (self._chatUserName) then
        self._chatUserName:UpdateName(self._userInfo, self._chatData)
    end
end

-- 创建
function IChatItem:OnCreate()
    base.OnCreate(self)
    self._chatIndex = 0
    self._chatViewController = require("UI.UIChatNew.Controller.ChatViewUtils"):GetInstance()
    
    self.event_trigger = self:AddComponent(UIEventTrigger, chat_scroll_view_path)

    self.event_trigger:OnBeginDrag(function(eventData)
        self:OnBeginDrag(eventData)
    end)
    self.event_trigger:OnDrag(function(eventData)
        self:OnDrag(eventData)
    end)
    self.event_trigger:OnEndDrag(function(eventData)
        self:OnEndDrag(eventData)
    end)
    
end

function IChatItem:SetContentViewScript( chatMainView )
    self._contentViewScript = chatMainView
end


function IChatItem:OnBeginDrag( eventData )
    local _chatMainView = self._chatViewController:GetChatMainView()
    if (_chatMainView ~= nil and _chatMainView:getSlideNode() ) then
        _chatMainView:getSlideNode():OnBeginDrag( eventData )
    end
end

function IChatItem:OnDrag( eventData )
    local _chatMainView = self._chatViewController:GetChatMainView()
    if (_chatMainView ~= nil and _chatMainView:getSlideNode() ) then
        _chatMainView:getSlideNode():OnDrag( eventData )
    end
end

function IChatItem:OnEndDrag( eventData )
    local _chatMainView = self._chatViewController:GetChatMainView()
    if (_chatMainView ~= nil and _chatMainView:getSlideNode() ) then
        _chatMainView:getSlideNode():OnEndDrag( eventData )
    end
end

-- 销毁
function IChatItem:OnDestroy()

    base.OnDestroy(self)
end

-- virtual
function IChatItem:GetTopOffset()
    return 0
end

-- virtual
function IChatItem:UpdateTopOffset()
    
end

function IChatItem:SetTransPosY(rectTrans, posY)
    local posX, _ = rectTrans:Get_anchoredPosition()
    rectTrans:Set_anchoredPosition(posX, posY)
    local minX, _ = rectTrans:Get_offsetMin()
    rectTrans:Set_offsetMin(minX, 0)
end

return IChatItem