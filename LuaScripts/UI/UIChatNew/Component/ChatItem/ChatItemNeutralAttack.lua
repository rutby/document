---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 1/13/22 11:03 AM
local IChatItem = require("UI.UIChatNew.Component.ChatItem.IChatItem")
local ChatItemNeutralAttack = BaseClass("ChatItemNeutralAttack", IChatItem)
local base = IChatItem
local Localization = CS.GameEntry.Localization
local rapidjson = require "rapidjson"
local _cp_text = "ChatAnchor/Background/DialogText";
local _cp_obj_ChatAnchor = "ChatAnchor";
local _cp_bg = "ChatAnchor/Background"
local _cp_background = "Image"

function ChatItemNeutralAttack:ComponentDefine()
    self._obj = self:AddComponent(UIBaseContainer, _cp_obj_ChatAnchor)
    self._text = self:AddComponent(UITextMeshProUGUIEx, _cp_text)
    self._background = self:AddComponent(UIImage, _cp_background)
    self._bgBtnLongPress = self:AddComponent(UIButton_LongPress, _cp_bg)
    if (self._bgBtnLongPress) then
        self._bgBtnLongPress:SetTouchBgGray(true)
        self._bgBtnLongPress:SetClickAction(function ()
            self:GotoAction()
        end)
    end
end

function ChatItemNeutralAttack:GotoAction()
    if CS.SceneManager:IsInCity() then
        return
    end
    local extra = self._chatdata.extra or {}
    local allianceCityInfo = extra.allianceCityInfo or ""
    local tabCityInfo = rapidjson.decode(allianceCityInfo)
    if (tabCityInfo == nil) then
        return 
    end
    local cityId = tabCityInfo.cityId or 0
    local strPos = GetTableData(TableName.WorldCity, cityId, 'location')
    local tabPos = string.split(strPos, '|')
    if (table.count(tabPos) ~= 2) then
        return
    end
    local vec2 = CS.UnityEngine.Vector2Int(tonumber(tabPos[1]), tonumber(tabPos[2]))
    local pointId = SceneUtils.TilePosToIndex(vec2)
    GoToUtil.CloseAllWindows()
    EventManager:GetInstance():Broadcast(EventId.UIMAIN_VISIBLE, true)
    GoToUtil.MoveToWorldPoint(pointId)
end

function ChatItemNeutralAttack:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

function ChatItemNeutralAttack:UpdateItem( _chatdata )
    if (_chatdata == nil) then
        return
    end
    self._chatdata = _chatdata
    local maxWidth = 512--self._chatViewController:GetChatItemMaxWidth()
    local minHeight = 0--136
    --self._obj.rectTransform:Set_sizeDelta(maxWidth, minHeight)
    
    local str = _chatdata:getMessageWithExtra(true)
    self._text:SetText(str)
    local txtHeight = self._text:GetHeight()
    --self._obj.rectTransform:Set_sizeDelta(maxWidth, minHeight--[[Mathf.Max(txtHeight+60, minHeight)]])
end

return ChatItemNeutralAttack