---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/31 14:43
---


local IChatItem = require("UI.UIChatNew.Component.ChatItem.IChatItem")
local ChatItemAllianceRecruitShare = BaseClass("ChatItemAllianceRecruitShare", IChatItem)
local base = IChatItem
local Localization = CS.GameEntry.Localization
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"
local ChatHead = require("UI.UIChatNew.Component.ChatHead")
local ChatUserName = require "UI.UIChatNew.Component.ChatItem.ChatUserName"
local rapidjson = require "rapidjson"

local chatNameLayout_path = "ChatNameLayout"
local chatHead_path = "ChatHead"
local chatShareNode_path = "ChatShareNode"
local shareTitle_path = "ChatShareNode/Image/ShareTitle"
local countryFlag_path = "ChatShareNode/ShareIconNode/countryFlag"
local allianceFlag_path = "ChatShareNode/ShareIconNode/AllianceFlag"
local recruitTip_path = "ChatShareNode/ShareIconNode/recruitTip"
local peopleNum_path = "ChatShareNode/ShareIconNode/people/peopleNum"
local detailBtn_path = "ChatShareNode/ShareIconNode/detailBtn"
local detailBtnTxt_path = "ChatShareNode/ShareIconNode/detailBtn/detailBtnTxt"
local joinBtn_path = "ChatShareNode/ShareIconNode/joinBtn"
local joinBtnTxt_path = "ChatShareNode/ShareIconNode/joinBtn/joinBtnTxt"

local Const_Min_ShareNodeHeight = 120
local Const_OneLineHeight = 26

function ChatItemAllianceRecruitShare:ComponentDefine()
    self.chatNameLayoutN = self:AddComponent(ChatUserName, chatNameLayout_path)
    self._chatHead = self:AddComponent(ChatHead, chatHead_path)
    self.chatShareNodeN = self:AddComponent(UIBaseContainer, chatShareNode_path)
    self.shareTitleN = self:AddComponent(UITextMeshProUGUIEx, shareTitle_path)
    self.countryFlagN = self:AddComponent(UIImage, countryFlag_path)
    self.allianceFlagN = self:AddComponent(AllianceFlagItem, allianceFlag_path)
    self.recruitTipN = self:AddComponent(UITextMeshProUGUIEx, recruitTip_path)
    self.peopleNumN = self:AddComponent(UITextMeshProUGUIEx, peopleNum_path)
    self.detailBtnN = self:AddComponent(UIButton, detailBtn_path)
    self.detailBtnN:SetOnClick(function()
        self:OnClickDetailBtn()
    end)
    self.detailBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, detailBtnTxt_path)
    self.detailBtnTxtN:SetLocalText(100092)
    self.joinBtnN = self:AddComponent(UIButton, joinBtn_path)
    self.joinBtnN:SetOnClick(function()
        self:OnClickJoinBtn()
    end)
    self.joinBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, joinBtnTxt_path)
    self.joinBtnTxtN:SetLocalText(110037)
end

function ChatItemAllianceRecruitShare:OnClickBg()
    if (self.attachInfo ~= nil) then
        EventManager:GetInstance():Broadcast(ChatInterface.getEventEnum().LF_CloseChatView,true)
        local tempIndex = DataCenter.AllianceTaskManager:GetTaskIndex(self.attachInfo.taskId)
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceTask, tempIndex)
    end
end

function ChatItemAllianceRecruitShare:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
end

function ChatItemAllianceRecruitShare:UpdateItem( chatdata, index )
    base.UpdateItem(self, chatdata, index)
    if (chatdata == nil) then
        return
    end
    self.attachInfo = chatdata:getMessageParam(false)
    
    self.shareTitleN:SetText("[" .. self.attachInfo.abbr .. "]" .. self.attachInfo.name)

    if not LuaEntry.Player:IsHideCountryFlag() then
        self.countryFlagN:SetActive(true)
        local nationTemplate = DataCenter.NationTemplateManager:GetNationTemplate(self.attachInfo.country)
        self.countryFlagN:LoadSprite(nationTemplate:GetNationFlagPath())
    else
        self.countryFlagN:SetActive(false)
    end
    self.allianceFlagN:SetData(self.attachInfo.allianceFlag)
    self.recruitTipN:SetText(self.attachInfo.recruitTip)
    self.peopleNumN:SetText(self.attachInfo.memberNum)
    if self.attachInfo.needApply == 1 then
        self.joinBtnTxtN:SetLocalText(110090)
    else
        self.joinBtnTxtN:SetLocalText(110037)
    end
    
    --名字
    local senderUid = chatdata["senderUid"]
    local _userInfo = ChatManager2:GetInstance().User:getChatUserInfo(senderUid, true)
    if (self.chatNameLayoutN) then
        self.chatNameLayoutN:UpdateName(_userInfo, chatdata)
    end

    -- 获取文本的高度,最小高度是120,之前预留了一行的高度,所以在获取真实高度的时候,需要将之前一行的高度给减去
    -- 给分享框设置尺寸
    --local height = self._shareMsg:GetHeight()
    --local curHeight = Const_Min_ShareNodeHeight+height-Const_OneLineHeight
    --height = Mathf.Max(Const_Min_ShareNodeHeight, curHeight)
    --local size_x, size_y = self._shareNode.rectTransform:Get_sizeDelta()
    --self._shareNode.rectTransform:Set_sizeDelta(size_x, height)

    -- 给当前节点设置尺寸O
    --local r_x, _ = self.rectTransform:Get_sizeDelta()
    --self.rectTransform:Set_sizeDelta(r_x, height+40)

    self:UpdateTopOffset()
end

function ChatItemAllianceRecruitShare:OnClickDetailBtn()
    if not DataCenter.BuildManager:HasBuilding(BuildingTypes.FUND_BUILD_ALLIANCE_CENTER) then
        return UIUtil.ShowTipsId(121373)
    end
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceDetail,{ anim = true },self.attachInfo.name, self.attachInfo.uid)
end

function ChatItemAllianceRecruitShare:OnClickJoinBtn()
    if not DataCenter.BuildManager:HasBuilding(BuildingTypes.FUND_BUILD_ALLIANCE_CENTER) then
        return UIUtil.ShowTipsId(121373)
    end
    if LuaEntry.Player:IsInAlliance() then
        UIUtil.ShowTips(Localization:GetString("E100056"))
    else
        local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
        if seasonId == 5 then
            if DataCenter.RobotWarsManager:GetSelfCamp()>0 and DataCenter.GloryManager:IsSameCampByAllianceId(self.attachInfo.uid) == false then
                return UIUtil.ShowTipsId(111093)
            end
        end
        local joinType = self.attachInfo.needApply and 1 or 0
        SFSNetwork.SendMessage(MsgDefines.AlApply, self.attachInfo.uid, joinType, self.attachInfo.language)
    end
end

-- override
function ChatItemAllianceRecruitShare:GetTopOffset()
    if self.chatNameLayoutN then
        return self.chatNameLayoutN:GetTopOffset()
    else
        return 0
    end
end

-- override
function ChatItemAllianceRecruitShare:UpdateTopOffset()
    local initOffset = 40
    local topOffset = self:GetTopOffset()
    local sizeX, sizeY = self.rectTransform:Get_sizeDelta()
    self.rectTransform:Set_sizeDelta(sizeX, sizeY + topOffset)
    self:SetTransPosY(self.chatShareNodeN.rectTransform, - (initOffset + topOffset))
end

return ChatItemAllianceRecruitShare