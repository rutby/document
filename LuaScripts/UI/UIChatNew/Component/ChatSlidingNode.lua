---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mac.
--- DateTime: 6/10/21 11:15 AM
---

local ChatSlidingNode = BaseClass("ChatSlidingNode")

function ChatSlidingNode:__init( ... )
    local param = { ... }
    self._scrollRectList = {}
    self._scrollLoopList = {}
    self._scrollViewList = {}

    if (table.length(param) > 0) then
        param = param[1]
    end

    self._chatView = param["chatview"]
    self._rootScrollRect = param["rootScrollRect"]
    
    
    
    local _scrollRect1 = param["mScrollRect1"]
    if (_scrollRect1) then
        local _scrollLoopList1 = _scrollRect1.transform:GetComponent(typeof(CS.SuperScrollView.LoopListView2))
        self._scrollRectList[#self._scrollRectList+1] = _scrollRect1
        self._scrollLoopList[#self._scrollLoopList+1] = _scrollLoopList1
    end

    local _scrollRect2 = param["mScrollRect2"]
    if (_scrollRect2) then
        local _scrollLoopList2 = _scrollRect1.transform:GetComponent(typeof(CS.SuperScrollView.LoopListView2))
        self._scrollRectList[#self._scrollRectList+1] = _scrollRect2
        self._scrollLoopList[#self._scrollLoopList+1] = _scrollLoopList2
    end

    local _scrollRect3 = param["mScrollRect3"]
    if (_scrollRect3) then
        local _scrollLoopList3 = _scrollRect3.transform:GetComponent(typeof(CS.SuperScrollView.LoopListView2))
        self._scrollRectList[#self._scrollRectList+1] = _scrollRect3
        self._scrollLoopList[#self._scrollLoopList+1] = _scrollLoopList3
    end

    local _scrollView = param["mScrollView"]
    self._scrollViewList[#self._scrollViewList+1] = _scrollView
    
    self._isDragChild = false
    self._d0 = 0.3
    self._isComplete = true
    self._touchScreenPosX = 0
    self._moveDistance = 72/1920 * Screen.width
    
    -- 记录初始位置
    self._touchBeganPosition = nil;
    
end

function ChatSlidingNode:GetMoveDeltaX()
    local deltaX = 0
    if CS.SDKManager.IS_UNITY_EDITOR() then
        deltaX = CS.UnityEngine.Input:GetAxis("Mouse X");
    elseif CS.SDKManager.IS_UNITY_ANDROID() or CS.SDKManager.IS_UNITY_IOS() then
        deltaX = CS.UnityEngine.Input:GetTouch(0).deltaPosition.x;
    end
    return deltaX
end


function ChatSlidingNode:OnBeginDrag( eventData )
    
    local touchDeltaPosition = eventData.delta
    self._touchScreenPosX = eventData.position.x;
    
    if (Mathf.Abs(touchDeltaPosition.x) < Mathf.Abs(touchDeltaPosition.y)) then
        self._isDragChild = true
        for _, v in ipairs(self._scrollLoopList) do
            v:OnBeginDrag(eventData)
        end
        for _, v in ipairs(self._scrollRectList) do
            v:OnBeginDrag(eventData)
        end
        for _, v in ipairs(self._scrollViewList) do
            v:OnBeginDrag(eventData)
        end
        if (self._rootScrollRect) then
            self._rootScrollRect:StopMovement()
        end
    else
        self._isDragChild = false
        for _, v in ipairs(self._scrollRectList) do
            v:StopMovement()
        end
        for _, v in ipairs(self._scrollViewList) do
            v:StopMovement()
        end
    end
end

function ChatSlidingNode:OnDrag(eventData)
    if (self._isDragChild) then
        for _, v in ipairs(self._scrollLoopList) do
            v:OnDrag(eventData)
        end
        for _, v in ipairs(self._scrollRectList) do
            v:OnDrag(eventData)
        end
        for _, v in ipairs(self._scrollViewList) do
            v:OnDrag(eventData)
        end
    else
        if (not self._isComplete or self._rootScrollRect == nil) then
            return
        end
        if (Mathf.Abs(eventData.position.x - self._touchScreenPosX) > self._moveDistance) then
            self._isComplete = false
            --if (eventData.delta.x > 0) then
            --    self._chatView:SlideRight(0)
            --else
            --    self._chatView:SlideLeft()
            --end
        end
    end
end


function ChatSlidingNode:OnEndDrag(eventData)
    if (self._isDragChild) then
        for _, v in ipairs(self._scrollLoopList) do
            v:OnEndDrag(eventData)
        end
        for _, v in ipairs(self._scrollRectList) do
            v:OnEndDrag(eventData)
        end
        for _, v in ipairs(self._scrollViewList) do
            v:OnEndDrag(eventData)
        end
    else
        self._isComplete = true
    end
end


return ChatSlidingNode