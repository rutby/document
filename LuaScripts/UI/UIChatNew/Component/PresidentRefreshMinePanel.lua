---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/4/11 18:00
---

local Localization = CS.GameEntry.Localization
local PresidentRefreshMinePanel = BaseClass("PresidentRefreshMinePanel", UIBaseContainer)
local base = UIBaseContainer
local player_btn_path = "UIPlayerHead"
local playerHeadFg_path = "UIPlayerHead/Foreground"
local playerHeadIcon_path = "UIPlayerHead/HeadIcon"
local alNameTxt_path = "alName"
local inviteTxt_path = "inviteTxt"
local inviteTxtBtn_path = "inviteTxt"
local gotoBtn_path = "GotoBtn"
local gotoBtnTxt_path = "GotoBtn/GotoBtnTxt"

local closeBtn_path = "closeBtn"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
    self:SetPanel()
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.playerHeadIconN = self:AddComponent(UIPlayerHead, playerHeadIcon_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.alNameTxtN = self:AddComponent(UITextMeshProUGUIEx, alNameTxt_path)
    self.inviteTxtN = self:AddComponent(UITextMeshProUGUIEx, inviteTxt_path)
    self.inviteTxtBtnN = self:AddComponent(UIButton, inviteTxtBtn_path)
    self.inviteTxtBtnN:SetOnClick(function()
        self:OnClickInviteTxtBtn()
    end)
    self.gotoBtnN = self:AddComponent(UIButton, gotoBtn_path)
    self.gotoBtnN:SetOnClick(function()
        self:OnClickGotoBtn()
    end)
    self.gotoBtnTxt = self:AddComponent(UITextMeshProUGUIEx, gotoBtnTxt_path)
    self.gotoBtnTxt:SetLocalText(110003)
    
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.player_btn = self:AddComponent(UIButton, player_btn_path)
    self.player_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClickHead()
    end)
end

--控件的销毁
local function ComponentDestroy(self)

end

--变量的定义
local function DataDefine(self)

end

local function DataDestroy(self)

end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function SetPanel(self)
    self.data = self:GetPanelData()
    if self.data == nil then
        self:SetActive(false)
        return 
    end
    self.playerHeadIconN:SetData(self.data.userInfo.uid, self.data.userInfo.pic, self.data.userInfo.picVer)
    local headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(self.data.userInfo.headSkinId, self.data.userInfo.headSkinET)
    if headBgImg then
        self.playerHeadFgN:SetActive(true)
        self.playerHeadFgN:LoadSprite(headBgImg)
    else
        self.playerHeadFgN:SetActive(false)
    end
    self.inviteTxtN:SetText(self.data.text)
    self.alNameTxtN:SetText(self.data.name)

end

local function OnClickGotoBtn(self)
    local pos = self.data.pos
    if SceneUtils.GetIsInWorld() then
        GoToUtil.CloseAllWindows()
    end

    GoToUtil.GotoWorldPos(pos, CS.SceneManager.World.InitZoom)
end

local function OnClickCloseBtn(self)
    DataCenter.PresidentMineRefreshManager:SetCloseChatMessage()
    self:SetActive(false)
end

local function OnClickInviteTxtBtn(self)
    local pos = self.data.pos
    if SceneUtils.GetIsInWorld() then
        GoToUtil.CloseAllWindows()
    end

    GoToUtil.GotoWorldPos(pos, CS.SceneManager.World.InitZoom)
end

local function GetPanelData(self)
    local info = DataCenter.PresidentMineRefreshManager:GetInfo()
    local para1 = DataCenter.PresidentMineRefreshManager:GetPresidentAuthorityActivityPara1()
    if info == nil or para1 == nil or info.userInfo == nil or string.IsNullOrEmpty(info.userInfo.uid) then
        return nil
    end
    local result = {}
    local pos = SceneUtils.TileIndexToWorld(info.pointId, ForceChangeScene.World)
    local tilePos = SceneUtils.IndexToTilePos(info.pointId, ForceChangeScene.World)

    result.pos = pos
    result.userInfo = DeepCopy(info.userInfo)
    local nameStr = ""
    if info.userInfo.allianceAbbr then
        nameStr = '['..info.userInfo.allianceAbbr..']'
    end
    nameStr = nameStr..info.userInfo.name
    result.name = nameStr
    local strPos = "(" .. toInt(tilePos.x) .. "," .. toInt(tilePos.y) .. ")"
    result.text = Localization:GetString(para1.skillDescInWorldChannel, strPos)
    return result
end

local function OnClickHead(self)
    if self.data.userInfo.uid ~= LuaEntry.Player.uid then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo, self.data.userInfo.uid)
    else
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIPlayerInfo,LuaEntry.Player.uid)
    end
end

PresidentRefreshMinePanel.OnCreate = OnCreate
PresidentRefreshMinePanel.OnDestroy = OnDestroy
PresidentRefreshMinePanel.OnEnable = OnEnable
PresidentRefreshMinePanel.OnDisable = OnDisable
PresidentRefreshMinePanel.ComponentDefine = ComponentDefine
PresidentRefreshMinePanel.ComponentDestroy = ComponentDestroy
PresidentRefreshMinePanel.DataDefine = DataDefine
PresidentRefreshMinePanel.DataDestroy = DataDestroy
PresidentRefreshMinePanel.OnAddListener = OnAddListener
PresidentRefreshMinePanel.OnRemoveListener = OnRemoveListener
PresidentRefreshMinePanel.GetPanelData = GetPanelData
PresidentRefreshMinePanel.SetPanel = SetPanel
PresidentRefreshMinePanel.OnClickGotoBtn = OnClickGotoBtn
PresidentRefreshMinePanel.OnClickCloseBtn = OnClickCloseBtn
PresidentRefreshMinePanel.OnClickInviteTxtBtn = OnClickInviteTxtBtn
PresidentRefreshMinePanel.OnClickHead = OnClickHead

return PresidentRefreshMinePanel