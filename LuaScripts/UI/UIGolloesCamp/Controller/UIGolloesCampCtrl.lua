---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/11/4 21:35
---

local UIGolloesCampCtrl = BaseClass("UIGolloesCampCtrl", UIBaseCtrl)
local Localization = CS.GameEntry.Localization

local function CloseSelf(self)
    UIManager.Instance:DestroyWindow(UIWindowNames.UIGolloesCamp, {anim = true})
end

local function Close(self)
    UIManager.Instance:DestroyWindowByLayer(UILayer.Normal, false)
end

local function OpenMonthCardPanel(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIGiftPackage, { anim = true },
            {
                welfareTagType = WelfareTagType.MonthCard,
                --curRechargeId = rechargeId,
            })
    self:CloseSelf()
end

local function ClaimDailyRewards(self, mcId)
    SFSNetwork.SendMessage(MsgDefines.ClaimGolloesDailyReward, mcId)
end

local function ClaimFreeRewards(self)
    SFSNetwork.SendMessage(MsgDefines.ClaimGolloesFreeReward)
end

local function GetExploreEndTime(self)
    local endT = DataCenter.GolloesCampManager:GetGolloesMarchEndTime(GolloesType.Explorer)
    return endT
end

local function GetTraderEndTime(self)
    local endT = DataCenter.GolloesCampManager:GetGolloesMarchEndTime(GolloesType.Trader)
    return endT
end

local function GetGolloesWarriorBuffEndTime(self)

    --else
    --    local strEffId = LuaEntry.DataConfig:TryGetStr("golloes_dispatch_para", "k10")
    --    local effIdTb = string.split(strEffId, ";")
    --    for i, v in ipairs(effIdTb) do
    --        local effId = tonumber(v)
    --        if intKey == effId then
    --            param.endTime = numValue
    --            param.totalTime = statItem.time * 1000
    --            param.intKey = intKey
    --        end
    --    end
    local strEffId = LuaEntry.DataConfig:TryGetStr("golloes_dispatch_para", "k10")
    local effIdTb = string.split(strEffId, ";")
    if #effIdTb > 0 then
        local tempId = tonumber(effIdTb[1])
        local timeInfo = DataCenter.StatusManager:GetBuffTimeInfo(tempId)
        if timeInfo then
            return timeInfo.endTime
        end
    end
    return -1
end

local function ActiveGolloesFunc(self, golloesType)
    --if CS.SceneManager:IsInCity() then
    --    UIUtil.ShowTipsId(320242) 
    --    return
    --end
    
    if golloesType == GolloesType.Worker then
        --local freeSpeedTime = DataCenter.GolloesCampManager:GetFreeSpeedTime()
        --local hasFreeTime = self:MilliSecondToFmtString(freeSpeedTime)-- UITimeManager:GetInstance():MilliSecondToFmtString(freeSpeedTime)
        --local perFreeTimeS = LuaEntry.DataConfig:TryGetNum("golloes_dispatch_para", "k3")
        --local perFreeTime = self:MilliSecondToFmtString(perFreeTimeS * 1000)-- UITimeManager:GetInstance():MilliSecondToFmtString(perFreeTimeS * 1000)
        --local strTip = Localization:GetString("320256", hasFreeTime, perFreeTime) 
        --UIUtil.ShowMessage(strTip,2,nil,nil,function ()
        --    --self:CloseSelf()
        --end,nil,nil)
        local num = self:IsEasySend() and DataCenter.GolloesCampManager:GetGolloesCount(golloesType) or 1
        local t = LuaEntry.DataConfig:TryGetNum("golloes_dispatch_para", "k3")
        SFSNetwork.SendMessage(MsgDefines.ActiveGolloesFunc, 1, num)
        SoundUtil.PlayEffect(GolloesSound[GolloesType.Worker])
        UIUtil.ShowTips(Localization:GetString("320329", num * t // 3600))
    elseif golloesType == GolloesType.Warrior then
        --UIUtil.ShowMessage(Localization:GetString("320259"),2,nil,nil,function ()
        --    --self:CloseSelf()
        --end,nil,nil)
        SFSNetwork.SendMessage(MsgDefines.ActiveGolloesFunc, 2)
        SoundUtil.PlayEffect(GolloesSound[GolloesType.Warrior])
        UIUtil.ShowTipsId(320332)
    elseif golloesType == GolloesType.Explorer then
        --UIUtil.ShowMessage(Localization:GetString("320257"),2,nil,nil,function ()
        --    --self:CloseSelf()
        --end,nil,nil)
        self:TryExplore()
    elseif golloesType == GolloesType.Trader then
        if not LuaEntry.Player:IsInAlliance() then
            UIUtil.ShowTipsId(GameDialogDefine.NO_JOIN_ALLIANCE)
            GoToUtil.GotoOpenView(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
            return
        end
        local canSendNum = DataCenter.GolloesCampManager:GetFreeFormationByGolloesType(GolloesType.Trader)
        if canSendNum > 0 then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceMemberDetail,{ anim = true, back = { ui = UIWindowNames.UIGolloesCamp, anim = true }},LuaEntry.Player.allianceId, AllianceMemberOpenType.GolloesTrande)
        else
            UIUtil.ShowTipsId(320334)
        end
        --self:CloseSelf()
    end
end

local function MilliSecondToFmtString(self, ms)
    local secs,delta = math.modf(ms/1000)
    if delta > 0 then
        secs = secs + 1
    end
    local temp = ""
    --local day = math.modf(secs / (OneDayTime))
    local hour = math.modf(secs/(60*60))--%24
    local minute = math.modf(secs/60)%60
    local second = math.floor(secs%60)
    return string.format("%d:%02d:%02d",hour,minute,second)
end

local function TryExplore(self)
    --local pointId = self:GetRandomPoint()
    local canSendNum, formationUuids = DataCenter.GolloesCampManager:GetFreeFormationByGolloesType(GolloesType.Explorer)
    if canSendNum > 0 then
        if self:IsEasySend() then
            local total = DataCenter.GolloesCampManager:GetGolloesCount(GolloesType.Explorer)
            local num = math.min(total, canSendNum)
            for i = 1, num do
                self:StartExplore(0, formationUuids[i])
            end
            if num < total then
                UIUtil.ShowTipsId(320929)
            end
        else
            self:StartExplore(0, formationUuids[1])
        end
        SoundUtil.PlayEffect(GolloesSound[GolloesType.Explorer])
        UIUtil.ShowTipsId(320330)
    else
        UIUtil.ShowTipsId(320333)
    end
end

local function StartExplore(self, pointId, formationUuid)
    local marchTargetType = MarchTargetType.GOLLOES_EXPLORE
    local sfsObj = SFSObject.New()
    sfsObj:PutLong("uuid", formationUuid)
    local formationArray = SFSArray.New()
    sfsObj:PutSFSArray("formations", formationArray)
    local heroArray = SFSArray.New()
    sfsObj:PutSFSArray("heroInfos", heroArray)
    local dataObj = sfsObj
    local startPoint = LuaEntry.Player:GetMainWorldPos()
    --local buildList = DataCenter.BuildManager:GetAllBuildingByItemIdWithoutPickUp(BuildingTypes.FUN_BUILD_GROCERY_STORE)
    --if buildList~=nil and table.count(buildList) > 0 and buildList[1]~=nil then
    --    startPoint = buildList[1].pointId
    --end
    local targetUuid = DataCenter.GuideManager:InGuide() and 1 or 0
    MarchUtil.StartMarch(marchTargetType, pointId, targetUuid, -1, 0, formationUuid, 1, dataObj,startPoint)
end

local function GetRandomPoint(self)
    --local buildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.FUN_BUILD_MAIN)
    --local centerPos = SceneUtils.TileIndexToWorld(buildData.pointId)
    --local targetPoint = nil
    --while true do
    --    centerPos.x = centerPos.x + math.random(-30,30)
    --    centerPos.z = centerPos.z + math.random(-30,30)
    --    local tempP = SceneUtils.WorldToTileIndex(centerPos)
    --    local info = CS.SceneManager.World:GetPointInfo(tempP)
    --    if not info then
    --        targetPoint = tempP
    --        break
    --    end
    --end
    return 0
end

local function JumpToGolloesTroop(self, golloesType)
    local worldMarch, formationInfo = DataCenter.GolloesCampManager:GetGolloesMarchByType(golloesType)
    if worldMarch then
        DataCenter.WorldMarchDataManager:TrackMarch(worldMarch.uuid)
        WorldMarchTileUIManager:GetInstance():ShowTroop(worldMarch.uuid)
        self:CloseSelf()
    end
end

local function IsEasySend(self)
	local isEasySend = LuaEntry.Effect:GetGameEffect(EffectDefine.EASY_GOLLOES_SEND) > 0
    return isEasySend
end

local function GePackageInfo(self)
    local package = GiftPackageData.GetGolloesCampPacks()
    if package and #package > 0 then
        return package[1]
    end
    return nil
end

UIGolloesCampCtrl.CloseSelf = CloseSelf
UIGolloesCampCtrl.Close = Close

UIGolloesCampCtrl.OpenMonthCardPanel = OpenMonthCardPanel
UIGolloesCampCtrl.ClaimDailyRewards = ClaimDailyRewards
UIGolloesCampCtrl.GetExploreEndTime = GetExploreEndTime
UIGolloesCampCtrl.GetTraderEndTime = GetTraderEndTime
UIGolloesCampCtrl.GetGolloesWarriorBuffEndTime = GetGolloesWarriorBuffEndTime
UIGolloesCampCtrl.ActiveGolloesFunc = ActiveGolloesFunc
UIGolloesCampCtrl.StartExplore = StartExplore
UIGolloesCampCtrl.TryExplore = TryExplore
UIGolloesCampCtrl.GetRandomPoint = GetRandomPoint
UIGolloesCampCtrl.JumpToGolloesTroop = JumpToGolloesTroop
UIGolloesCampCtrl.MilliSecondToFmtString = MilliSecondToFmtString
UIGolloesCampCtrl.ClaimFreeRewards = ClaimFreeRewards
UIGolloesCampCtrl.IsEasySend = IsEasySend
UIGolloesCampCtrl.GePackageInfo = GePackageInfo
return UIGolloesCampCtrl