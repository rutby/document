---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/11/5 14:39
---
local GolloesCampItem = BaseClass("GolloesCampItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"

local root_path = ""
local bgBtn_path = "bgBtn"
local operation_path = "operation"
local golloesName1Txt_path = "operation/name2/name1"
local golloesName2Txt_path = "operation/name2"
local golloesCostTxt_path = "operation/cost/costNum"
local golloesCostIcon_path = "operation/cost/costIcon"
local golloesJumpBtn_path = "operation/jumpBtn"
local golloesJumpTipTxt_path = "operation/jumpBtn/jumpTip"
local claimRewardBtn_path = "operation/claimBtn"
local rewardNum_path = "operation/claimBtn/rewardNum"
local selectedImg_path = "operation/selected"

--local bgImg_path = "operation/bgImg"
local golloesIcon_path = "operation/Icon"
local costBg_path = "operation/cost"
local claimBg_path = "operation/claimBtn/claimBgImg"


-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:DelTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.rootN = self:AddComponent(UIBaseContainer, root_path)
    self.bgBtnN = self:AddComponent(UIButton, bgBtn_path)
    self.bgBtnN:SetOnClick(function()
        self:OnClickBgBtn()
    end)
    self.operationN = self:AddComponent(UIAnimator, operation_path)
    self.golloesTxtN = self:AddComponent(UITextMeshProUGUIEx, golloesName1Txt_path)
    self.golloesTxtN:SetLocalText(300603)
    self.golloesNameTxtN = self:AddComponent(UITextMeshProUGUIEx, golloesName2Txt_path)
    self.golloesIconN = self:AddComponent(UIImage, golloesIcon_path)
    --self.bgN = self:AddComponent(UIImage, bgImg_path)
    self.costBgN = self:AddComponent(UIImage, costBg_path)
    self.claimBgN = self:AddComponent(UIImage, claimBg_path)
    self.golloesCostTxtN = self:AddComponent(UITextMeshProUGUIEx, golloesCostTxt_path)
    self.golloesCostIconN = self:AddComponent(UIImage, golloesCostIcon_path)
    self.golloesJumpBtnN = self:AddComponent(UIButton, golloesJumpBtn_path)
    self.golloesJumpBtnN:SetOnClick(function()
        --self:OnClickJumpBtn()
    end)
    self.golloesJumpTipTxtN = self:AddComponent(UITextMeshProUGUIEx, golloesJumpTipTxt_path)
    self.claimRewardBtnN = self:AddComponent(UIButton, claimRewardBtn_path)
    self.claimRewardBtnN:SetOnClick(function()
        self:OnClickClaimBtn()
    end)
    self.rewardNumN = self:AddComponent(UITextMeshProUGUIEx, rewardNum_path)
    self.selectedImgN = self:AddComponent(UIBaseContainer, selectedImg_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.bgBtnN = nil
    self.golloesNameTxtN = nil
    self.golloesIconN = nil
    self.golloesCostTxtN = nil
    self.golloesJumpBtnN = nil
    self.golloesJumpTipTxtN = nil
    self.claimRewardBtnN = nil
    self.selectedImgN = nil
end

--变量的定义
local function DataDefine(self)
    self.golloesType = nil
    self.TimerAction = function()
        self:RefreshRemainTime()
    end
    self.endTime = nil
    local strCost = LuaEntry.DataConfig:TryGetStr("golloes_dispatch_para", "k2")
    self.golloesCostTb = string.split(strCost, ";")
end 

--变量的销毁
local function DataDestroy(self)
    self.golloesType = nil
    self.TimerAction = nil
    self.endTime = nil
end

local function RefreshItem(self, golloesType)
    self.golloesType = golloesType
    
    local golloesShow = GolloesShow[self.golloesType]

    self.golloesNameTxtN:SetLocalText(golloesShow.name)
    --self.golloesNameTxtN:SetColor(golloesShow.color)
    self.golloesIconN:LoadSprite(string.format(LoadPath.GolloesCampPath,golloesShow.icon))
    --self.bgN:LoadSprite(string.format(LoadPath.GolloesCampPath,golloesShow.bg))
    self.costBgN:LoadSprite(string.format(LoadPath.GolloesCampPath,golloesShow.costBg))
    self.golloesCostIconN:LoadSprite(string.format(LoadPath.GolloesCampPath,golloesShow.costIcon))
    --self.claimBgN:LoadSprite(string.format(LoadPath.GolloesCampPath,golloesShow.claimBg))
    
    --self.golloesCostTxtN:SetText(self.golloesCostTb[self.golloesType])
    local ownNum = DataCenter.GolloesCampManager:GetGolloesCount(self.golloesType)
    self.golloesCostTxtN:SetText(ownNum)
    --self.golloesCostTxtN:SetColor(golloesShow.color)--Color.New(0.39, 0.58, 0.94,1))

    if self.golloesType == GolloesType.Worker then
        self:ShowGolloesWorker()
    elseif self.golloesType == GolloesType.Explorer then
        self:ShowGolloesExplorer()
    elseif self.golloesType == GolloesType.Trader then
        self:ShowGolloesTrader()
    elseif self.golloesType == GolloesType.Warrior then
        self:ShowGolloesWarrior()
    end

    --local golloesMonthCard = DataCenter.MonthCardNewManager:GetGolloesMonthCard()
    --if not golloesMonthCard:IsBought() then
    --    self.golloesNameTxtN:SetActive(false)
    --end
end

local function ShowGolloesWorker(self)
    self.claimRewardBtnN:SetActive(false)
    self.golloesNameTxtN:SetActive(true)
    self.golloesJumpBtnN:SetActive(false)
    self.golloesJumpTipTxtN:SetActive(false)
end

local function ShowGolloesExplorer(self)
    local rewardNum = DataCenter.GolloesCampManager:GetGolloesRewardNum(self.golloesType)
    if rewardNum > 0 then
        self.claimRewardBtnN:SetActive(true)
        self.rewardNumN:SetText("x" .. rewardNum)
    else
        self.claimRewardBtnN:SetActive(false)
    end

    --self.endTime = self.view.ctrl:GetExploreEndTime();
    local hasMarch = DataCenter.GolloesCampManager:CheckIfHasMarch(self.golloesType)
    if hasMarch then
        self.golloesNameTxtN:SetActive(false)
        self.golloesJumpBtnN:SetActive(true)
        self.golloesJumpTipTxtN:SetActive(true)
        self.golloesJumpTipTxtN:SetLocalText(320236)
    else
        self.golloesNameTxtN:SetActive(true)
        self.golloesJumpBtnN:SetActive(false)
        self.golloesJumpTipTxtN:SetActive(false)
    end
end

local function ShowGolloesTrader(self)
    local rewardNum = DataCenter.GolloesCampManager:GetGolloesRewardNum(self.golloesType)
    if rewardNum > 0 then
        self.claimRewardBtnN:SetActive(true)
        self.rewardNumN:SetText("x" .. rewardNum)
    else
        self.claimRewardBtnN:SetActive(false)
    end

    local hasMarch = DataCenter.GolloesCampManager:CheckIfHasMarch(self.golloesType)
    if hasMarch then
        self.golloesNameTxtN:SetActive(false)
        self.golloesJumpBtnN:SetActive(true)
        self.golloesJumpTipTxtN:SetActive(true)
        self.golloesJumpTipTxtN:SetLocalText(320236)
    else
        self.golloesNameTxtN:SetActive(true)
        self.golloesJumpBtnN:SetActive(false)
        self.golloesJumpTipTxtN:SetActive(false)
    end
end

local function ShowGolloesWarrior(self)
    self.claimRewardBtnN:SetActive(false)

    self.endTime = self.view.ctrl:GetGolloesWarriorBuffEndTime()
    if self.endTime > 0 then
        self.golloesNameTxtN:SetActive(false)
        self.golloesJumpBtnN:SetActive(true)
        self.golloesJumpTipTxtN:SetActive(true)
        self:AddTimer()
        self:RefreshRemainTime(self)
    else
        self.golloesNameTxtN:SetActive(true)
        self.golloesJumpTipTxtN:SetActive(false)
    end
end

local function SetSelected(self, isSelect)
    self.selectedImgN:SetActive(isSelect)
    
    local tempScale = isSelect and 1.05 or 1.0
    self.rootN.transform:DOScale(Vector3.New(tempScale, tempScale, 1), 0.2)
end

local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.TimerAction , self, false,false,false)
    end
    self.timer:Start()
end

local function RefreshRemainTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = self.endTime - curTime
    if remainTime > 0 then
        self.golloesJumpTipTxtN:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(remainTime))
    else
        self.golloesNameTxtN:SetActive(true)
        self.golloesJumpTipTxtN:SetActive(false)
        self:DelTimer()
    end
end

local function DelTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function ShowBenefitTip(self)
    local golloesShow = GolloesShow[self.golloesType]
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.bgBtnN.transform.position + Vector3.New(golloesShow.tipOffsetX, 30, 0) * scaleFactor
    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString(golloesShow.desc)
    param.title = Localization:GetString(golloesShow.name)
    param.dir = UIHeroTipView.Direction.ABOVE
    param.defWidth = 366
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end


local function OnClickBgBtn(self)
    --self.operationN:Play("V_ui_gulu_gollescampltem_dianji", 0, 0)

    self.view:TrySelectGolloes(self.golloesType)
    --local golloesMonthCard = DataCenter.MonthCardNewManager:GetGolloesMonthCard()
    --if golloesMonthCard and golloesMonthCard:IsBought() then
    --    return
    --end
    --self:ShowBenefitTip()
end

local function OnClickJumpBtn(self)
    if self.golloesType == GolloesType.Explorer or self.golloesType == GolloesType.Trader then
        self.view.ctrl:JumpToGolloesTroop(self.golloesType)
    end
end

local function OnClickClaimBtn(self)
    SoundUtil.PlayEffect(SoundAssets.Music_Effect_Common_GetReward)
    if self.golloesType == GolloesType.Explorer then
        SFSNetwork.SendMessage(MsgDefines.ClaimGolloesReward, 1)
    elseif self.golloesType == GolloesType.Trader then
        SFSNetwork.SendMessage(MsgDefines.ClaimGolloesReward, 2)
    end
end



GolloesCampItem.OnCreate = OnCreate
GolloesCampItem.OnDestroy = OnDestroy
GolloesCampItem.OnEnable = OnEnable
GolloesCampItem.OnDisable = OnDisable
GolloesCampItem.ComponentDefine = ComponentDefine
GolloesCampItem.ComponentDestroy = ComponentDestroy
GolloesCampItem.DataDefine = DataDefine
GolloesCampItem.DataDestroy = DataDestroy

GolloesCampItem.RefreshItem = RefreshItem
GolloesCampItem.ShowGolloesWorker = ShowGolloesWorker
GolloesCampItem.ShowGolloesExplorer = ShowGolloesExplorer
GolloesCampItem.ShowGolloesTrader = ShowGolloesTrader
GolloesCampItem.ShowGolloesWarrior = ShowGolloesWarrior
GolloesCampItem.SetSelected = SetSelected
GolloesCampItem.OnClickBgBtn = OnClickBgBtn
GolloesCampItem.OnClickSendBtn = OnClickSendBtn
GolloesCampItem.OnClickClaimBtn = OnClickClaimBtn
GolloesCampItem.AddTimer = AddTimer
GolloesCampItem.RefreshRemainTime = RefreshRemainTime
GolloesCampItem.DelTimer = DelTimer
GolloesCampItem.ShowBenefitTip = ShowBenefitTip
GolloesCampItem.OnClickJumpBtn = OnClickJumpBtn

return GolloesCampItem