---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/3/9 20:15
---
local Localization = CS.GameEntry.Localization
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local WorldNewsLayer = BaseClass("WorldNewsLayer", UIBaseContainer)
local base = UIBaseContainer
local NewsEventItem = require "UI.UIRadarCenter.UIDetectEvent.Component.NewsEventItem"
local WorldNewsCell = require "UI.UIAlliance.UIAllianceWarMainTable.Component.WorldNewsCell"
local battleObj = "battleObj"
local event_items_path = "newsGo"
local infoBtn_path = "infoBtn"
local msgItem_path = "msgItem"
local msg_txt_path = "msgItem/Text"
local MapScale = 0.7

--创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.battleObj = self:AddComponent(WorldNewsCell,battleObj)
    self.event_items = self:AddComponent(UIBaseContainer, event_items_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.msgItem = self:AddComponent(UIBaseContainer, msgItem_path)
    self.msg_txt = self:AddComponent(UITextMeshProUGUIEx, msg_txt_path)
    self.msg_txt:SetLocalText("302154")
end

local function ComponentDestroy(self)
    self:SetAllCellDestroy()
end

local function DataDefine(self)

end

local function DataDestroy(self)

end

local function OnEnable(self)
    base.OnEnable(self)
    
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.UpdateWorldZoneNews, self.ReInit)

end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.UpdateWorldZoneNews, self.ReInit)
end

local function InitData(self)
    self.currentSelectPointId = 0
    self.battleObj:SetActive(false)
    self.msgItem:SetActive(false)
    DataCenter.WorldNewsDataManager:SendRequest()
end
local function ReInit(self)
    self:SetAllCellDestroy()
    self.newsTable = self.view.ctrl:GetAreaNewsList()
    self.view:UpdateRedDot()
    local list = table.values(self.newsTable)
    if list~=nil and #list>0 then
        self.msgItem:SetActive(false)
        for i = 1, table.length(list) do
            self.models[i]= self:GameObjectInstantiateAsync(UIAssets.NewsEventItem, function(request)
                if request.isError then
                    return
                end
                local go = request.gameObject
                go:SetActive(true)
                go.transform:SetParent(self.event_items.transform)
                go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)

                local nameStr = tostring(NameCount)
                go.name = nameStr
                NameCount = NameCount + 1
                local data = list[i]
                self.itemInfoCells[data.pointId] = self.event_items:AddComponent(NewsEventItem, nameStr)
                self.itemInfoCells[data.pointId]:SetUuid(data, self.currentSelectPointId)
                local tfx = go:GetComponent(typeof(CS.UnityEngine.RectTransform))
                local v2 = SceneUtils.IndexToTilePos(data.pointId)
                tfx:Set_anchoredPosition(v2.x *MapScale,v2.y*MapScale)
                go.transform:SetAsLastSibling()
            end)
        end
    else
        self.msgItem:SetActive(true)
    end
    self:OnSelectNewsByPoint(self.currentSelectPointId)
end

local function SetAllCellDestroy(self)
    self.event_items:RemoveComponents(WorldNewsCell)
    if self.models~=nil then
        for k,v in pairs(self.models) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.models = {}
    self.itemInfoCells = {}
end

local function OnSelectNewsByPoint(self,pointId)
    self.currentSelectPointId = pointId
    if self.itemInfoCells~=nil then
        for k,v in pairs(self.itemInfoCells) do
            v:SetSelectUuid(self.currentSelectPointId)
        end
    end
    if self.newsTable~=nil then
        local data = self.newsTable[pointId]
        if data~=nil then
            self.battleObj:SetActive(true)
            self.battleObj:ReInit(data)
        else
            self.battleObj:SetActive(false)
        end
    end
end

local function OnClickInfoBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.infoBtnN.gameObject.transform.position + Vector3.New(-20, 0, 0) * scaleFactor
    local param = UIHeroTipView.Param.New()
    param.content = Localization:GetString("320825")
    param.dir = UIHeroTipView.Direction.LEFT
    param.defWidth = 200
    param.pivot = 0.8
    param.position = position
    param.deltaX = 0
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end
WorldNewsLayer.OnCreate = OnCreate
WorldNewsLayer.OnDestroy = OnDestroy
WorldNewsLayer.OnEnable = OnEnable
WorldNewsLayer.OnDisable = OnDisable
WorldNewsLayer.ComponentDefine = ComponentDefine
WorldNewsLayer.ComponentDestroy = ComponentDestroy
WorldNewsLayer.DataDefine = DataDefine
WorldNewsLayer.DataDestroy = DataDestroy
WorldNewsLayer.ReInit = ReInit
WorldNewsLayer.SetAllCellDestroy = SetAllCellDestroy
WorldNewsLayer.OnSelectNewsByPoint = OnSelectNewsByPoint
WorldNewsLayer.OnAddListener =OnAddListener
WorldNewsLayer.OnRemoveListener = OnRemoveListener
WorldNewsLayer.InitData = InitData
WorldNewsLayer.OnClickInfoBtn= OnClickInfoBtn
return WorldNewsLayer