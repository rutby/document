---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/8/3 18:14
---

local UITurfWar = BaseClass("UITurfWar", UIBaseContainer)
local base = UIBaseContainer
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"
local UICommonItemChange = require "UI.UICommonItem.UICommonItemChange"
local Localization = CS.GameEntry.Localization

local title_path = "Root/Title"
local subtitle_path = "Root/Subtitle"
local time_bg_path = "Root/TimeBg"
local time_path = "Root/TimeBg/Time"
local desc_path = "Root/Desc"
local list_path = "Root/List"
local go_path = "Root/Go"
local go_text_path = "Root/Go/GoText"
local winner_path = "Root/Winner"
local winner_flag_path = "Root/Winner/WinnerFlag"
local winner_desc_path = "Root/Winner/WinnerDesc"
local winner_name_path = "Root/Winner/WinnerName"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.title_text = self:AddComponent(UIText, title_path)
    self.subtitle_text = self:AddComponent(UIText, subtitle_path)
    self.time_bg_go = self:AddComponent(UIBaseContainer, time_bg_path)
    self.time_text = self:AddComponent(UIText, time_path)
    self.desc_text = self:AddComponent(UIText, desc_path)
    self.desc_text:SetLocalText(375060)
    self.list_go = self:AddComponent(UIBaseContainer, list_path)
    self.go_btn = self:AddComponent(UIButton, go_path)
    self.go_btn:SetOnClick(function()
        self:OnGoClick()
    end)
    self.go_text = self:AddComponent(UIText, go_text_path)
    self.go_text:SetLocalText(110088)
    self.winner_go = self:AddComponent(UIBaseContainer, winner_path)
    self.winner_flag = self:AddComponent(AllianceFlagItem, winner_flag_path)
    self.winner_desc_text = self:AddComponent(UIText, winner_desc_path)
    self.winner_desc_text:SetLocalText(375061)
    self.winner_name_text = self:AddComponent(UIText, winner_name_path)
end

local function ComponentDestroy(self)
end

local function DataDefine(self)
    self.req = {}
    self.rewards = {}
    self.rateDataList = {}
    self.openTime = 0
    self.timer = TimerManager:GetInstance():GetTimer(0.5, self.TimerAction, self, false, false, false)
    self.timer:Start()
end

local function DataDestroy(self)
    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.TurfWarGetInfo, self.OnGetInfo)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.TurfWarGetInfo, self.OnGetInfo)
    base.OnRemoveListener(self)
end

local function SetData(self, actId)
    self.actId = actId
    local actData = DataCenter.ActivityListDataManager:GetActivityDataById(actId)
    self.title_text:SetLocalText(actData.name)
    self.subtitle_text:SetLocalText(actData.desc_info)
    
    self.rewards = {}
    for _, str in ipairs(string.split(actData.para2, "|")) do
        local spls = string.split(str, ";")
        if #spls == 3 then
            local reward = {}
            reward.rewardType = tonumber(spls[1])
            reward.itemId = tonumber(spls[2])
            reward.count = tonumber(spls[3])
            table.insert(self.rewards, reward)
        end
    end
    self:ShowRewards()
    
    self.rateDataList = {}
    for _, str in ipairs(string.split(actData.para3, "|")) do
        local spls = string.split(str, ";")
        if #spls == 3 then
            local reward = {}
            reward.rewardType = RewardType.GOODS
            reward.itemId = tonumber(spls[1])
            
            local data = {}
            data.reward = reward
            data.count = tonumber(spls[2])
            data.rate = tonumber(spls[3])
            table.insert(self.rateDataList, data)
        end
    end
    
    SFSNetwork.SendMessage(MsgDefines.GetEdenOccupyThroneActivityInfo, actId)
end

local function ShowRewards(self)
    self:DestroyAllReq()
    for i, reward in ipairs(self.rewards) do
        self.req[i] = self:GameObjectInstantiateAsync(UIAssets.UICommonItemChange97, function(request)
            if request.isError then
                return
            end
            local go = request.gameObject
            local go_tf = go.transform
            go.gameObject:SetActive(true)
            go_tf:SetParent(self.list_go.transform)
            go_tf:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            go_tf:Set_localPosition(ResetPosition.x, ResetPosition.y, ResetPosition.z)
            local nameStr = tostring(NameCount)
            go.name = nameStr
            NameCount = NameCount + 1
            local item = self.list_go:AddComponent(UICommonItemChange, nameStr)
            item:ReInit(reward)
            if reward.rewardType == RewardType.GOODS then
                local itemTemplate = DataCenter.ItemTemplateManager:GetItemTemplate(reward.itemId)
                if itemTemplate.type == GOODS_TYPE.GOODS_TYPE_5 then
                    item:SetOnClick(function()
                        self:OnRateBoxClick(item)
                    end)
                end
            end
        end)
    end
end

local function TimerAction(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local restTime = math.floor(self.openTime - curTime)
    if restTime >= 0 then
        local restTimeStr = UITimeManager:GetInstance():MilliSecondToFmtString(restTime)
        self.time_text:SetText(Localization:GetString("375059", restTimeStr))
    elseif restTime == -1 then
        self:SetData(self.actId)
    end
end

local function OnGoClick(self)
    local maxLvTemplate = nil
    for _, template in pairs(DataCenter.AllianceCityTemplateManager:GetAllTemplate()) do
        if maxLvTemplate == nil or maxLvTemplate.level < template.level then
            maxLvTemplate = template
        end
    end
    if maxLvTemplate then
        GoToUtil.CloseAllWindows()
        local pointId = SceneUtils.TilePosToIndex(maxLvTemplate.pos, ForceChangeScene.World)
        local worldPos = SceneUtils.TileIndexToWorld(pointId, ForceChangeScene.World)
        worldPos.x = worldPos.x - 6
        worldPos.z = worldPos.z - 6
        pointId = SceneUtils.WorldToTileIndex(worldPos, ForceChangeScene.World)
        GoToUtil.GotoWorldPos(worldPos, CS.SceneManager.World.InitZoom, LookAtFocusTime, function()
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIWorldSiegePoint, maxLvTemplate.id, pointId)
        end)
    end
end

local function OnRateBoxClick(self, item)
    local param = {}
    param.pos = item.transform.position
    param.desc = Localization:GetString("105073")
    param.dataList = self.rateDataList
    param.isLeft = false
    param.offsetY = 75
    UIUtil.ShowRateTip(param)
end

local function OnGetInfo(self, message)
    if message["activityId"] == tonumber(self.actId) then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        self.openTime = message["throneOpenTime"]
        if curTime >= self.openTime then
            local occupyInfo = message["occupyInfo"]
            if occupyInfo and not string.IsNullOrEmpty(occupyInfo.allianceId) then
                -- 已产生胜者
                self.time_bg_go:SetActive(false)
                self.desc_text:SetActive(false)
                self.winner_go:SetActive(true)
                self.winner_name_text:SetText(string.format("[%s] %s", occupyInfo.abbr, occupyInfo.allianceName))
            else
                -- 进行中
                self.time_bg_go:SetActive(false)
                self.desc_text:SetActive(true)
                self.winner_go:SetActive(false)
            end
        else
            -- 预告
            self.time_bg_go:SetActive(true)
            self.desc_text:SetActive(false)
            self.winner_go:SetActive(false)
            self:TimerAction()
        end
    end
end

function UITurfWar:DestroyAllReq()
    for k, v in ipairs(self.req) do
        v:Destroy()
    end
    self.req = {}
end

UITurfWar.OnCreate = OnCreate
UITurfWar.OnDestroy = OnDestroy
UITurfWar.OnEnable = OnEnable
UITurfWar.OnDisable = OnDisable
UITurfWar.ComponentDefine = ComponentDefine
UITurfWar.ComponentDestroy = ComponentDestroy
UITurfWar.DataDefine = DataDefine
UITurfWar.DataDestroy = DataDestroy
UITurfWar.OnAddListener = OnAddListener
UITurfWar.OnRemoveListener = OnRemoveListener

UITurfWar.SetData = SetData
UITurfWar.ShowRewards = ShowRewards
UITurfWar.TimerAction = TimerAction
UITurfWar.OnGoClick = OnGoClick
UITurfWar.OnRateBoxClick = OnRateBoxClick
UITurfWar.OnGetInfo = OnGetInfo

return UITurfWar