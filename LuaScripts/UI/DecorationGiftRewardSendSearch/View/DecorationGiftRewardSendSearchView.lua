---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/2/7 20:16
---

local Cell = require "UI.DecorationGiftRewardSendSearch.Component.DecorationGiftRewardSendSearchCell"
local DecorationGiftRewardSendSearchView = BaseClass("DecorationGiftRewardSendSearchView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization

local txt_title_path ="UICommonMidPopUpTitle/bg_mid/titleText"
local close_btn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonMidPopUpTitle/panel"
local scroll_path = "ImgBg/ScrollView"

local server_title_path = "ImgBg/ServerTitle"
local server_input_path = "ImgBg/InputFieldServer"
local server_place_holder_txt_path = "ImgBg/InputFieldServer/PlaceholderServer"

local name_title_path = "ImgBg/NameTitle"
local name_input_path = "ImgBg/InputFieldName"
local name_place_holder_txt_path = "ImgBg/InputFieldName/PlaceholderName"

local search_btn_path = "ImgBg/BtnSearch"
local emptyTxt_path = "ImgBg/TxtEmpty"

local function OnCreate(self)
    base.OnCreate(self)
    local data, user = self:GetUserData()
    self.data = data
    self.user = user
    self.txt_title = self:AddComponent(UIText, txt_title_path)
    self.txt_title:SetLocalText(320758)

    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf(self.data, self.user)
    end)

    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf(self.data, self.user)
    end)

    self.server_title = self:AddComponent(UIText, server_title_path)
    self.server_title:SetLocalText(320762)
    self.serverInput = self:AddComponent(UIInput, server_input_path)
    self.serverInput:SetOnEndEdit(function (value)
        self:IptOnServerValueChange(value)
    end)
    self.server_place_holder_txt = self:AddComponent(UIText, server_place_holder_txt_path)
    self.server_place_holder_txt:SetText("")
    self.serverInput:SetText("")
    self.name_title = self:AddComponent(UIText, name_title_path)
    self.name_title:SetLocalText(320763)
    self.nameInput = self:AddComponent(UIInput, name_input_path)
    self.nameInput:SetOnEndEdit(function (value)
        self:IptOnNameValueChange(value)
    end)
    self.nameInput:SetText("")
    self.name_place_holder_txt = self:AddComponent(UIText, name_place_holder_txt_path)
    self.name_place_holder_txt:SetText("")

    --self.search_btn = self:AddComponent(UIButton, search_btn_path)
    --self.search_btn:SetOnClick(function()
    --    SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
    --    self:OnClickSearch()
    --end)
    
    self.ScrollView = self:AddComponent(UIScrollView, scroll_path)
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnAllianceItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnAllianceItemMoveOut(itemObj, index)
    end)

    self.EmptyTxt = self:AddComponent(UIText, emptyTxt_path)
    --self.EmptyTxt:SetLocalText(390856)
    self.EmptyTxt:SetActive(false)
    self.inputValueServer = ""
    self.inputValueName = ""
end

local function OnDestroy(self)
    self:ClearScroll()
    self.txt_title = nil
    self.close_btn = nil
    self.return_btn = nil
    self.input = nil
    self.search_btn = nil
    
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAllianceItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(Cell, itemObj)
    cellItem:SetData(self.dataList[index])
end

local function OnAllianceItemMoveOut(self, itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, Cell)
end

local function ClearScroll(self)
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(Cell)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.SendContactGiftSearchBack, self.OnSearchBack)

end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.SendContactGiftSearchBack, self.OnSearchBack)
    base.OnRemoveListener(self)
end

local function IptOnServerValueChange(self,value)
    self.inputValueServer = value
    self:SendSearchCmd()
end

local function IptOnNameValueChange(self,value)
    self.inputValueName = value
    self:SendSearchCmd()
end

local function SendSearchCmd(self)
    if not string.IsNullOrEmpty(self.inputValueServer) and not string.IsNullOrEmpty(self.inputValueName) and #self.inputValueName >= 3 then
        local server = toInt(self.inputValueServer)
        if server > 0 then
            SFSNetwork.SendMessage(MsgDefines.SendContactGiftSearch, server, self.inputValueName)
        end
    end
end

--local function OnClickSearch(self)
--    if self.inputValue ==nil or self.inputValue=="" then
--        self.currentAllianceId = ""
--        self.ctrl:SendSearchMessageToServer(1,1,"",0, true)
--    else
--        self.ctrl:SendSearchMessageToServer(1,1,self.inputValue,0)
--    end
--end

local function OnSearchBack(self, message)
    self.dataList = {}
    if message["searchRet"] then
        for k, v in ipairs(message["searchRet"]) do
            if v.uid ~= LuaEntry.Player.uid then
                table.insert(self.dataList, DeepCopy(v))
            end
        end
    end
    
    self:ShowCells()
end

local function ShowCells(self)
    self:ClearScroll()
    local count = #self.dataList
    if count == 0 then
        return
    end
    self.ScrollView:SetTotalCount(count)
    self.ScrollView:RefillCells()
end


local function SelectPlayer(self, user)
    self.ctrl:CloseSelf(self.data, user)
end

DecorationGiftRewardSendSearchView.OnCreate= OnCreate
DecorationGiftRewardSendSearchView.OnDestroy = OnDestroy
DecorationGiftRewardSendSearchView.OnEnable = OnEnable
DecorationGiftRewardSendSearchView.OnDisable = OnDisable
DecorationGiftRewardSendSearchView.OnAllianceItemMoveIn = OnAllianceItemMoveIn
DecorationGiftRewardSendSearchView.OnAllianceItemMoveOut = OnAllianceItemMoveOut
DecorationGiftRewardSendSearchView.ClearScroll = ClearScroll
DecorationGiftRewardSendSearchView.OnAddListener = OnAddListener
DecorationGiftRewardSendSearchView.OnRemoveListener = OnRemoveListener
DecorationGiftRewardSendSearchView.IptOnServerValueChange = IptOnServerValueChange
DecorationGiftRewardSendSearchView.IptOnNameValueChange = IptOnNameValueChange
DecorationGiftRewardSendSearchView.SendSearchCmd = SendSearchCmd
DecorationGiftRewardSendSearchView.OnSearchBack = OnSearchBack
DecorationGiftRewardSendSearchView.SelectPlayer = SelectPlayer
DecorationGiftRewardSendSearchView.ShowCells = ShowCells

return DecorationGiftRewardSendSearchView