---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2022/7/28 17:13
---

local UIHeroOfficialCounterTip = BaseClass("UIHeroOfficialCounterTip", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local close_path = "Close"
local root_path = "Root"
local title_path = "Root/Bg/Title"
local left_camp_path = "Root/Bg/Top/LeftCamp"
local right_camp_path = "Root/Bg/Top/RightCamp"
local desc_path = "Root/Bg/Desc"
local arrow_path = "Root/Arrow"

--local CounterCamp =
--{
--    [0] = 2,
--    [1] = 3,
--    [2] = 1,
--    [3] = 0,
--}
--
local CounterDesc =
{
    [0] = "133017",
    [1] = "133015",
    [2] = "133014",
    [3] = "133016",
}

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.root_anim = self:AddComponent(UIAnimator, root_path)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self:OnCloseClick()
    end)
    self.title_text = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.left_camp_image = self:AddComponent(UIImage, left_camp_path)
    self.right_camp_image = self:AddComponent(UIImage, right_camp_path)
    self.desc_text = self:AddComponent(UITextMeshProUGUIEx, desc_path)
    self.arrow_go = self:AddComponent(UIBaseContainer, arrow_path)
end

local function ComponentDestroy(self)
    self.root_anim = nil
    self.close_btn = nil
    self.title_text = nil
    self.left_camp_image = nil
    self.right_camp_image = nil
    self.desc_text = nil
    self.arrow_go = nil
end

local function DataDefine(self)
    self.camp = 0
    self.pos = 0
    self.itemList = {}
end

local function DataDestroy(self)
    self.camp = nil
    self.pos = nil
    self.itemList = nil
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function SetData(self, camp, pos)
    self.camp = camp
    self.pos = pos

    local template = DataCenter.HeroOfficialManager:GetTemplate(camp, pos)
    local templateList = DataCenter.HeroOfficialManager:GetTemplateList(camp, pos)
    local nextTemplate = nil
    for _, t in ipairs(templateList) do
        if t.buffLv == template.buffLv + 1 then
            nextTemplate = t
            break
        end
    end

    self.title_text:SetLocalText(template.name)
    self.left_camp_image:LoadSprite(HeroUtils.GetCampIconPath(camp))
    local restraintCamp = HeroUtils.GetHeroRestraintType(camp)
    self.right_camp_image:LoadSprite(HeroUtils.GetCampIconPath(restraintCamp))

    local maxVal = template.maxVal
    local str = ""
    local buildingLv = DataCenter.HeroOfficialManager:GetBuildingLv()
    if buildingLv >= template.unlockLv then
        str = str .. Localization:GetString(CounterDesc[camp], maxVal .. "%")
        if nextTemplate ~= nil then
            str = str .. "\n\n"
            str = str .. Localization:GetString("133006", "Lv." .. nextTemplate.unlockLv)
            str = str .. ":\n"
            str = str .. Localization:GetString(CounterDesc[camp], nextTemplate.maxVal .. "%")
        end
    else
        str = str .. Localization:GetString("133006", "Lv." .. template.unlockLv)
        str = str .. ":\n"
        str = str .. Localization:GetString(CounterDesc[camp], maxVal .. "%")
    end
    self.desc_text:SetText(str)

    -- unity problem
    TimerManager:GetInstance():DelayInvoke(function()
        if self.root_anim ~= nil then
            CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.root_anim.rectTransform)
        end
    end, 0.05)
end

local function Show(self)
    self:SetActive(true)
    self.root_anim:Play("CommonPopup_movein", 0, 0)
end

local function OnCloseClick(self)
    self:SetActive(false)
end

UIHeroOfficialCounterTip.OnCreate= OnCreate
UIHeroOfficialCounterTip.OnDestroy = OnDestroy
UIHeroOfficialCounterTip.ComponentDefine = ComponentDefine
UIHeroOfficialCounterTip.ComponentDestroy = ComponentDestroy
UIHeroOfficialCounterTip.DataDefine = DataDefine
UIHeroOfficialCounterTip.DataDestroy = DataDestroy
UIHeroOfficialCounterTip.OnEnable = OnEnable
UIHeroOfficialCounterTip.OnDisable = OnDisable

UIHeroOfficialCounterTip.SetData = SetData
UIHeroOfficialCounterTip.Show = Show
UIHeroOfficialCounterTip.OnCloseClick = OnCloseClick

return UIHeroOfficialCounterTip