---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl.
--- DateTime: 
---
local UISubWayCtrl = BaseClass("UISubWayCtrl", UIBaseCtrl)
local Data = CS.GameEntry.Data
local Localization = CS.GameEntry.Localization
function UISubWayCtrl:CloseSelf()
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UISubWay)
end

function UISubWayCtrl:Close()
    UIManager:GetInstance():DestroyWindowByLayer(UILayer.Normal)
end

function UISubWayCtrl:GetFormationPowerByUuid(formationUuid)
    local totalPower = 0
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    if formation~=nil then
        totalPower = MarchUtil.GetFormationPower(formation:GetCurHeroes(),formation.soldiers,formation.index,MarchUtil.GetCampAddParam(formation:GetCurHeroes()))
    end
    return totalPower
end

function UISubWayCtrl:GetCurSoldierNum(formationUuid)
    local totalNum = 0
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    if formation~=nil then
        table.walk(formation.soldiers,function(k,v)
            if v>0 then
                totalNum = totalNum+v
            end
        end)
    end
    return totalNum
end

function UISubWayCtrl:GetMarchData(marchUuid,formationUuid)
    local oneData = {}
    local formation = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(formationUuid)
    local Player = LuaEntry.Player
    if formation~=nil then
        oneData.formationUuid = formation.uuid
        oneData.index = formation.index
        oneData.power = self:GetFormationPowerByUuid(formation.uuid)
        oneData.curSoldierNum = self:GetCurSoldierNum(formation.uuid)
        oneData.heroDataList ={}
        local heroData = formation:GetCurHeroes()
        if heroData~=nil and table.count(heroData)>0 then
            table.walksort(heroData,function (leftKey,rightKey)
                return heroData[leftKey] < heroData[rightKey]
            end,function(k,v)
                if k~=nil then
                    local heroOneData = {}
                    heroOneData.heroUuid = k
                    table.insert(oneData.heroDataList,heroOneData)
                end
            end)
        end
        local march = DataCenter.WorldMarchDataManager:GetOwnerFormationMarch(Player.uid, formation.uuid, Player.allianceId)
        if march~=nil then
            oneData.status = march:GetMarchStatus()
            oneData.targetType = march:GetMarchTargetType()
            oneData.marchUuid = march.uuid
            oneData.targetUuid = march.targetUuid
            oneData.startTime = march.startTime
            oneData.endTime = march.endTime
            if march.targetUuid == 0 then
                local pointId = march.startPos
                local info = DataCenter.WorldPointManager:GetPointInfo(pointId)
                if info and info.PointType == WorldPointType.PlayerBuilding then
                    oneData.targetUuid = info.uuid
                end
            end
            return oneData
        end
    end
end


--获取在虫洞中的部队以及正在前往虫洞的部队
function UISubWayCtrl:GetInWormHoleMarch()
    local list = {}
    local selfMarch = DataCenter.WorldMarchDataManager:GetOwnerMarches(LuaEntry.Player.uid, LuaEntry.Player.allianceId)
    if #selfMarch > 0 then
        for i = 1, #selfMarch do
            local march = selfMarch[i]
            if march:GetMarchStatus() == MarchStatus.IN_WORM_HOLE or march:GetMarchStatus() == MarchStatus.CROSS_SERVER or march:GetMarchTargetType() == MarchTargetType.CROSS_SERVER_WORM or march:GetMarchTargetType() == MarchTargetType.GO_WORM_HOLE then
                table.insert(list,march)
            end
        end
    end
    return list
end



return UISubWayCtrl