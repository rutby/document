---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/1/3 17:58
---

local UIPVEHeroHead = BaseClass("UIPVEHeroHead", UIBaseContainer)
local base = UIBaseContainer
local UIGray = CS.UIGray

local this_path = ""
local normal_path = "Normal"
local hero_path = "Normal/Mask/Hero"
local black_path = "Normal/Mask/Black"
local frame_path = "Normal/Frame"
local time_path = "Normal/Time"
local slider_path = "Normal/Slider"
local skill_path = "SkillBg/Skill"

local MaxAnger = 1000
local AngerPerSec = 100
local SkillDuration = 1

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.btn = self:AddComponent(UIButton, this_path)
    self.btn:SetOnClick(function()
        self:OnClick()
    end)
    self.anim = self:AddComponent(UIAnimator, this_path)
    self.normal_go = self:AddComponent(UIBaseContainer, normal_path)
    self.hero_image = self:AddComponent(UIImage, hero_path)
    self.black_image = self:AddComponent(UIImage, black_path)
    self.frame_image = self:AddComponent(UIImage, frame_path)
    self.time_text = self:AddComponent(UITextMeshProUGUIEx, time_path)
    self.slider = self:AddComponent(UISlider, slider_path)
    self.skill_image = self:AddComponent(UIImage, skill_path)
end

local function ComponentDestroy(self)
    
end

local function DataDefine(self)
    self.isDead = false
    self.usingSkill = false
    self.anger = 0
    self.angerTween = nil
end

local function DataDestroy(self)
    if self.angerTween then
        self.angerTween:Kill()
        self.angerTween = nil
    end
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function SetHeroId(self, heroId)
    self.isDead = false
    self.anger = 0
    self.heroId = heroId
    self.normal_go:SetActive(true)
    local icon = HeroUtils.GetHeroIconPath(heroId)
    local rarity = GetTableData(HeroUtils.GetHeroXmlName(), heroId, "rarity")
    self.hero_image:LoadSprite(icon)
    self.frame_image:LoadSprite(string.format(LoadPath.UIPve, "pve_fight_frame_" .. rarity))
    self.black_image:SetFillAmount(0)
    self.time_text:SetText("")
    self.slider:SetValue(1)
    UIGray.SetGray(self.hero_image.transform, false)
    self:TweenAnger()
    self.anim:Play("Eff_UI_Common_Skill_Loop", 0, 0)
end

local function SetHp(self, cur, max)
    local val = Mathf.Clamp(cur / max, 0, 1)
    self.slider:SetValue(val)
    if cur <= 0 then
        self.isDead = true
        self.black_image:SetFillAmount(0)
        self.time_text:SetText("")
        if self.angerTween then
            self.angerTween:Kill()
        end
        UIGray.SetGray(self.hero_image.transform, true)
    else
        self.isDead = false
    end
end

local function AddAnger(self, addAnger)
    self.anger = Mathf.Clamp(self.anger + addAnger, 0, MaxAnger)
    self:TweenAnger()
end

local function TweenAnger(self)
    if self.isDead then
        return
    end
    if self.angerTween then
        self.angerTween:Kill()
    end
    self.angerTween = DOTween.To(function(anger)
        self.anger = anger
        local restAnger = MaxAnger - anger
        self.time_text:SetText(string.format("%.1f", restAnger / AngerPerSec))
        self.black_image:SetFillAmount(restAnger / MaxAnger)
    end, self.anger, MaxAnger, (MaxAnger - self.anger) / AngerPerSec):SetEase(CS.DG.Tweening.Ease.Linear):OnComplete(function()
        self.time_text:SetText("")
        self.black_image:SetFillAmount(0)
    end)
end

local function UseSkill(self, skillId)
    self.skill_image:LoadSprite(HeroUtils.GetSkillIcon(skillId))
    self.anim:Play("Eff_UI_Common_Skill_Switch", 0, 0)
end

local function OnClick(self, data)
    
end

UIPVEHeroHead.OnCreate= OnCreate
UIPVEHeroHead.OnDestroy = OnDestroy
UIPVEHeroHead.ComponentDefine = ComponentDefine
UIPVEHeroHead.ComponentDestroy = ComponentDestroy
UIPVEHeroHead.DataDefine = DataDefine
UIPVEHeroHead.DataDestroy = DataDestroy
UIPVEHeroHead.OnEnable = OnEnable
UIPVEHeroHead.OnDisable = OnDisable
UIPVEHeroHead.OnAddListener = OnAddListener
UIPVEHeroHead.OnRemoveListener = OnRemoveListener

UIPVEHeroHead.SetHeroId = SetHeroId
UIPVEHeroHead.SetHp = SetHp
UIPVEHeroHead.AddAnger = AddAnger
UIPVEHeroHead.TweenAnger = TweenAnger
UIPVEHeroHead.UseSkill = UseSkill
UIPVEHeroHead.OnClick = OnClick

return UIPVEHeroHead