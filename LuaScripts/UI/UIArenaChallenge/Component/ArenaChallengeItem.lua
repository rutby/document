
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/6/7 18:43
---
local ArenaChallengeItem = BaseClass("ArenaChallengeItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local bgBtn_path = "rankInfo/bgBtn"
local playerHead_path = "rankInfo/playerFlag/UIPlayerHead/HeadIcon"
local playerHeadFg_path = "rankInfo/playerFlag/UIPlayerHead/Foreground"
local playerHeadBtn_path = "rankInfo/playerFlag/UIPlayerHead"
local name_path = "rankInfo/playerName"
local power_path = "rankInfo/power"
local score_path = "rankInfo/rankNum"
local challengeBtn_path = "rankInfo/challengeBtn"
local challengeBtnTxt_path = "rankInfo/challengeBtn/layout/fightBtnTxt"
local challengeCost_path = "rankInfo/challengeBtn/layout/fightCost"
local challengeCostNum_path = "rankInfo/challengeBtn/layout/fightCost/costTicketNum"
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.bgBtn = self:AddComponent(UIButton, bgBtn_path)
    self.bgBtn:SetOnClick(function()
        self:OnClickBg()
    end)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.playerHeadBtnN = self:AddComponent(UIButton, playerHeadBtn_path)
    self.playerHeadBtnN:SetOnClick(function()
        self:OnClickPlayerHeadBtn()
    end)
    self.nameN = self:AddComponent(UITextMeshProUGUIEx, name_path)
    self.powerN = self:AddComponent(UITextMeshProUGUIEx, power_path)
    self.scoreN = self:AddComponent(UITextMeshProUGUIEx, score_path)

    self.challengeBtnN = self:AddComponent(UIButton, challengeBtn_path)
    self.challengeBtnN:SetOnClick(function()
        self:OnClickChallengeBtn()
    end)
    self.challengeBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, challengeBtnTxt_path)
    self.challengeBtnTxtN:SetLocalText(372258)
    self.challengeCostN = self:AddComponent(UIBaseContainer, challengeCost_path)
    self.challengeCostN:SetActive(false)
    self.challengeCostNumN = self:AddComponent(UITextMeshProUGUIEx, challengeCostNum_path)
end

--控件的销毁
local function ComponentDestroy(self)
end

--变量的定义
local function DataDefine(self)
    self.rankInfo = nil
    self.index = 1
end

--变量的销毁
local function DataDestroy(self)
    self.rankInfo = nil
    self.index = 1
end

local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.OnClaimRewardEffFinish, self.RefreshNeed)

end

local function OnRemoveListener(self)
    --self:RemoveUIListener(EventId.OnClaimRewardEffFinish, self.RefreshNeed)
    base.OnRemoveListener(self)
end


--param = {showChallenge = false, index = 1}
local function SetItem(self, rankInfo, param)
    self.rankInfo = rankInfo
    self.index = param and param.index or 1
    self.challengeBtnN:SetActive(param and param.showChallenge)
    self:RefreshAll()
end

local function RefreshAll(self)
    if self.rankInfo == nil then
        self:ShowSelf()
    else
        self:ShowOther()
    end
end

local function ShowSelf(self)
    local selfInfo = DataCenter.ArenaManager:GetSelfInfo()
    self.scoreN:SetText(selfInfo.selfScore)
    self.playerHeadN:SetData(LuaEntry.Player.uid, LuaEntry.Player.pic, LuaEntry.Player.picVer)
    local fgImg = LuaEntry.Player:GetHeadBgImg()
    if not string.IsNullOrEmpty(fgImg) then
        self.playerHeadFgN:SetActive(true)
        self.playerHeadFgN:LoadSprite(fgImg)
    else
        self.playerHeadFgN:SetActive(false)
    end

    if LuaEntry.Player:IsInAlliance() then
        local allianceBase = DataCenter.AllianceBaseDataManager:GetAllianceBaseData()
        if allianceBase then
            abbr = allianceBase.abbr
            self.nameN:SetText("[" .. allianceBase.abbr .. "]" .. LuaEntry.Player.name)
        else
            self.nameN:SetText(LuaEntry.Player.name)
        end
    else
        self.nameN:SetText(LuaEntry.Player.name)
    end

    self.powerN:SetText(string.GetFormattedStr(selfInfo.selfPower))
end

local function ShowOther(self)


    if self.rankInfo.type == 0 then
        self.nameN:SetLocalText(100184)
        self.powerN:SetText(string.GetFormattedStr(self.rankInfo.power))
        self.scoreN:SetText(self.rankInfo.score)
    else
        self.playerHeadN:SetData(self.rankInfo.uid, self.rankInfo.pic, self.rankInfo.picVer)
        local tempAbbr = not string.IsNullOrEmpty(self.rankInfo.abbr) and "[" .. self.rankInfo.abbr .. "]" or ""
        self.nameN:SetText(tempAbbr .. self.rankInfo.name)
        self.powerN:SetText(string.GetFormattedStr(self.rankInfo.power))
        self.scoreN:SetText(self.rankInfo.score)
    end

    local selfInfo = DataCenter.ArenaManager:GetSelfInfo()
    local maxChallengeTimes = LuaEntry.DataConfig:TryGetNum("arena","k2")
    local remainTimes = maxChallengeTimes - selfInfo.fightTimes
    if remainTimes > 0 then
        self.challengeCostN:SetActive(false)--true)--临时隐藏
        self.challengeCostNumN:SetLocalText(130126)
        CS.UIGray.SetGray(self.challengeBtnN.transform, false, true)
    else
        local good = DataCenter.ItemData:GetItemById(ArenaTicketId)
        local num = good and good.count or 0
        if num > 0 then
            self.challengeCostN:SetActive(true)
            self.challengeCostNumN:SetText("x1")
            CS.UIGray.SetGray(self.challengeBtnN.transform, false, true)
        else
            self.challengeCostN:SetActive(false)
            CS.UIGray.SetGray(self.challengeBtnN.transform, true, false)
        end
    end
    
end


local function OnClickPlayerHeadBtn(self)
    if self.rankInfo and self.rankInfo.type == 1 then
        if self.rankInfo.uid ~= LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo, self.rankInfo.uid)
        end
    end
end

local function OnClickChallengeBtn(self)
    local canFight, tipId = DataCenter.ArenaManager:CheckIfCanChallenge()
    if not canFight then
        UIUtil.ShowTipsId(tipId)
        return
    end

    self.view.ctrl:CloseSelf()
    DataCenter.ArenaManager:CacheUIName(UIWindowNames.UIArenaChallenge)
    DataCenter.ArenaManager:SetTargetEnemyInfo(self.rankInfo)
    local param = {}
    param.scene = "PveScene1"
    param.pveEntrance = PveEntrance.ArenaBattle
    DataCenter.BattleLevel:Enter(param)
end

local function OnClickBg(self)
    if self.rankInfo~=nil then
        if self.rankInfo.uid ~= LuaEntry.Player.uid then
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIArenaPlayerDetail, {anim = true, isBlur = true},self.rankInfo)
        end
    end
end
ArenaChallengeItem.OnCreate = OnCreate
ArenaChallengeItem.OnDestroy = OnDestroy
ArenaChallengeItem.ComponentDefine = ComponentDefine
ArenaChallengeItem.ComponentDestroy = ComponentDestroy
ArenaChallengeItem.DataDefine = DataDefine
ArenaChallengeItem.DataDestroy = DataDestroy
ArenaChallengeItem.OnAddListener = OnAddListener
ArenaChallengeItem.OnRemoveListener = OnRemoveListener

ArenaChallengeItem.SetItem = SetItem
ArenaChallengeItem.RefreshAll = RefreshAll
ArenaChallengeItem.ShowSelf = ShowSelf
ArenaChallengeItem.ShowOther = ShowOther
ArenaChallengeItem.OnClickPlayerHeadBtn = OnClickPlayerHeadBtn
ArenaChallengeItem.OnClickChallengeBtn = OnClickChallengeBtn
ArenaChallengeItem.OnClickBg =OnClickBg
return ArenaChallengeItem