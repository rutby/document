---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/6/25 17:25
---
local UIStaminaBallView = BaseClass("UIStaminaBallView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local close_btn_path = "Back"
local title_text_path = "title"
local intro_btn_path = "title/IntroBtn"
local detail_btn_path = "Slider/detailBtn"
local intro_txt_path = "Text_intro"
local des_txt_path = "Slider/Text_des"
local btn_path = "btn"
local btn_text_path = "btn/btnText"
local slider_path = "Slider"
local slider_num_path = "Slider/Text_num"
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
    DataCenter.StaminaBallManager:GetStaminaDataRequest()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.title_text = self:AddComponent(UIText, title_text_path)
    self.intro_txt = self:AddComponent(UIText, intro_txt_path)
    self.des_txt = self:AddComponent(UIText, des_txt_path)
    self.des_txt:SetLocalText(376171)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.intro_btn = self:AddComponent(UIButton, intro_btn_path)
    self.intro_btn:SetOnClick(function()
        self:OnIntroClick()
    end)
    self.detail_btn = self:AddComponent(UIButton, detail_btn_path)
    self.detail_btn:SetOnClick(function()
        self:OnDetailClick()
    end)
    self.btn = self:AddComponent(UIButton, btn_path)
    self.btn:SetOnClick(function()
        self:OnBtnClick()
    end)
    self.btn_text = self:AddComponent(UIText, btn_text_path)
    self.btn_text:SetLocalText(376172)
    self.slider = self:AddComponent(UISlider, slider_path)
    self.slider_num = self:AddComponent(UIText, slider_num_path)
end

local function ComponentDestroy(self)
end

local function DataDefine(self)

end

local function DataDestroy(self)

end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.StaminaBallData,self.ReInit)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.StaminaBallData,self.ReInit)
    base.OnRemoveListener(self)
end

local function ReInit(self)
    self.activityInfo = nil
    local dataList = DataCenter.ActivityListDataManager:GetActivityDataByType(ActivityEnum.ActivityType.StaminaBall)
    if table.count(dataList) > 0 then
        self.activityInfo = dataList[1]
    end
    if self.activityInfo == nil then
    else
        self.title_text:SetLocalText(self.activityInfo.name)
        self.intro_txt:SetLocalText(self.activityInfo.desc_info)
    end

    local max = DataCenter.StaminaBallManager:GetMaxStamina()
    local cur = DataCenter.StaminaBallManager:GetOldStamina()
    
    local maxNum = max
    local curNum = DataCenter.StaminaBallManager:GetExpByStamina(cur)
    if curNum>0 then
        CS.UIGray.SetGray(self.btn.transform, false, true)
    else
        CS.UIGray.SetGray(self.btn.transform, true, false)
    end
    
    local percent = math.min((curNum/math.max(maxNum,1)),1)
    self.slider:SetValue(percent)
    self.slider_num:SetText(string.GetFormattedSeperatorNum(math.floor(curNum)).."/"..string.GetFormattedSeperatorNum(math.floor(maxNum)))
end

local function OnIntroClick(self)
    if self.activityInfo~=nil then
        UIUtil.ShowIntro(Localization:GetString("376169"), Localization:GetString("376176"),Localization:GetString(self.activityInfo.story))
    end
end

local function OnBtnClick(self)
    SFSNetwork.SendMessage(MsgDefines.UserRewardStaminaBubble)
    self.ctrl:CloseSelf()
end
local function OnDetailClick(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local todayStamina = DataCenter.StaminaBallManager:GetTodayStamina()
    local canGetNum = DataCenter.StaminaBallManager:GetExpByStamina(todayStamina)
    local position = self.detail_btn.transform.position + Vector3.New(20, 0, 0) * scaleFactor
    local infoStr = Localization:GetString("376173")..": "..string.GetFormattedSeperatorNum(math.floor(todayStamina)).."\n"..Localization:GetString("376174")..": "..string.GetFormattedSeperatorNum(math.floor(canGetNum))

    local param = UIHeroTipView.Param.New()
    param.content = infoStr
    param.dir = UIHeroTipView.Direction.RIGHT
    param.defWidth = 300
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end
UIStaminaBallView.OnCreate = OnCreate
UIStaminaBallView.OnDestroy = OnDestroy
UIStaminaBallView.ComponentDefine = ComponentDefine
UIStaminaBallView.ComponentDestroy = ComponentDestroy
UIStaminaBallView.DataDefine = DataDefine
UIStaminaBallView.DataDestroy = DataDestroy
UIStaminaBallView.ReInit = ReInit
UIStaminaBallView.OnIntroClick = OnIntroClick
UIStaminaBallView.OnDetailClick =OnDetailClick
UIStaminaBallView.OnBtnClick = OnBtnClick
UIStaminaBallView.OnAddListener= OnAddListener
UIStaminaBallView.OnRemoveListener= OnRemoveListener
return UIStaminaBallView