---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/6/16 10:11
---
local UIDragonBuffTipView = BaseClass("UIDragonBuffTipView", UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    local param = self:GetUserData()
    self.param = param
end

local function OnDestroy(self)
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    local btnPanel = self:AddComponent(UIButton, "Panel")
    btnPanel:SetOnClick(BindCallback(self.ctrl, self.ctrl.CloseSelf))
    self.root = self:AddComponent(UIBaseContainer, "tips")
    self.layout1 = self:AddComponent(UIBaseContainer,"tips/Root/Image/layout1")
    self.title1 = self:AddComponent(UIText,"tips/Root/Image/layout1/TextTitle1")
    self.title1:SetLocalText(376147)
    self.des1 = self:AddComponent(UIText,"tips/Root/Image/layout1/des1")
    self.layout2 = self:AddComponent(UIBaseContainer,"tips/Root/Image/layout2")
    self.title2 = self:AddComponent(UIText,"tips/Root/Image/layout2/TextTitle2")
    self.title2:SetLocalText(376149)
    self.des2 = self:AddComponent(UIText,"tips/Root/Image/layout2/des2")
    self.layout3 = self:AddComponent(UIBaseContainer,"tips/Root/Image/layout3")
    self.title3 = self:AddComponent(UIText,"tips/Root/Image/layout3/TextTitle3")
    self.title3:SetLocalText(376163)
    self.des3 = self:AddComponent(UIText,"tips/Root/Image/layout3/des3")
    self.textTitle = self:AddComponent(UIText, "tips/Root/TextTitle")
    self.textTitle:SetLocalText(376152)
end

local function ComponentDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:SetData()
end

local function OnDisable(self)
    base.OnDisable(self)
end


local function SetData(self)
    if self.param~=nil then
        local rootRt = self.root.rectTransform
        rootRt.position = self.param.position
    end
    local layout1List = {}
    local k6 = LuaEntry.DataConfig:TryGetStr("dragon_battle_base", "k6")
    local str = string.split(k6,"|")
    if str~=nil and #str>0 then
        for i =1,#str do
            local s = str[i]
            local arr = string.split(s,";")
            if #arr ==2 then
                local e1 = tonumber(arr[1])
                local e2 = tonumber(arr[2])
                if e1~=nil and e2~=nil and e1>0 and e2>0 then
                    layout1List[e1] = e2
                end
            end
        end
    end
    local str1 = ""
    for k,v in pairs(layout1List) do
        if v>0 then
            local effectId = k
            local value = tonumber(v)
            local effectName = GetTableData(TableName.EffectNumDesc, effectId, "des")
            local buffAddNum = ""
            effectName = Localization:GetString(effectName)
            local effectType = GetTableData(TableName.EffectNumDesc, effectId, "type")
            effectType = tonumber(effectType)
            if effectType == EffectLocalTypeInEffectDesc.Num then
                buffAddNum = string.GetFormattedSeperatorNum(value)
            elseif effectType == EffectLocalTypeInEffectDesc.Percent then
                buffAddNum = string.GetFormattedPercentStr(value/100)
            elseif effectType == EffectLocalTypeInEffectDesc.Thousandth then
                buffAddNum = string.GetFormattedThousandthStr(value/1000)
            end
            str1 = str1..effectName..": "..buffAddNum.."\n"
        end
    end
    self.des1:SetText(str1)
    local hurtEffectId = 35065
    local hurtNum = 0
    local k14 = LuaEntry.DataConfig:TryGetNum("dragon_battle_base", "k14")
    local k16 = LuaEntry.DataConfig:TryGetStr("dragon_battle_base", "k16")
    str = string.split(k16,"|")
    if str~=nil and #str>0 then
        for i =1,#str do
            local s = str[i]
            local arr = string.split(s,";")
            if #arr ==2 then
                local e1 = tonumber(arr[1])
                local e2 = tonumber(arr[2])
                if e1 ==hurtEffectId then
                    hurtNum = e2
                end
            end
        end
    end
    local str2 = Localization:GetString("376150").." "..string.GetFormattedPercentStr(k14).."\n"..Localization:GetString("376151")..":  "..hurtNum.."%".."\n"
    self.des2:SetText(str2)
    local str3 = ""
    self.dragonInfo = DataCenter.ActDragonManager:GetDragonInfo()
    local curTime = UITimeManager:GetInstance():GetServerTime()
    if self.dragonInfo~=nil and self.dragonInfo.timeInfo~=nil then
        if self.dragonInfo.matchResult == 1 then    --匹配到对手
            if self.dragonInfo.timeInfo.battleOpenTime~=nil and curTime > self.dragonInfo.timeInfo.battleOpenTime and self.dragonInfo.timeInfo.endTime~=nil and curTime < self.dragonInfo.timeInfo.endTime then
                local dic = DataCenter.ActDragonManager:GetDragonEffectData()
                if dic~=nil then
                    for k,v in pairs(dic) do
                        if layout1List[k] == nil  then
                            if v>0 then
                                local effectId = k
                                local value = tonumber(v)
                                local effectName = GetTableData(TableName.EffectNumDesc, effectId, "des")
                                local buffAddNum = ""
                                effectName = Localization:GetString(effectName)
                                local effectType = GetTableData(TableName.EffectNumDesc, effectId, "type")
                                effectType = tonumber(effectType)
                                if effectType == EffectLocalTypeInEffectDesc.Num then
                                    buffAddNum = string.GetFormattedSeperatorNum(value)
                                elseif effectType == EffectLocalTypeInEffectDesc.Percent then
                                    buffAddNum = string.GetFormattedPercentStr(value/100)
                                elseif effectType == EffectLocalTypeInEffectDesc.Thousandth then
                                    buffAddNum = string.GetFormattedThousandthStr(value/1000)
                                end
                                str3 = str3..effectName..": "..buffAddNum.."\n"
                            end
                        end
                    end
                end
            end
        end
    end
    
    if str3~="" then
        self.layout3:SetActive(true)
        self.des3:SetText(str3)
    else
        self.layout3:SetActive(false)
    end
    
end
UIDragonBuffTipView.OnCreate= OnCreate
UIDragonBuffTipView.OnDestroy = OnDestroy
UIDragonBuffTipView.ComponentDefine = ComponentDefine
UIDragonBuffTipView.ComponentDestroy = ComponentDestroy
UIDragonBuffTipView.OnEnable =OnEnable
UIDragonBuffTipView.OnDisable =OnDisable
UIDragonBuffTipView.SetData =SetData


return UIDragonBuffTipView