---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
---UIChatReportView.lua

local base = UIBaseView--Variable
local UIChatReportView = BaseClass("UIChatReportView", base)--Variable
local Localization = CS.GameEntry.Localization
local ChatReportItem = require "UI.UIChatReport.Component.UIChatReportItem"


local Conf = {
    {
        ReportType = ChatReportType.Politics,
        Type = 0,
        Dialog = "208240",
    },
    {
        ReportType = ChatReportType.Ads,
        Type = 0,
        Dialog = "208241",
    },
    {
        ReportType = ChatReportType.Gambling,
        Type = 0,
        Dialog = "208242",
    },
    {
        ReportType = ChatReportType.Gm,
        Type = 0,
        Dialog = "208243",
    },
    {
        ReportType = ChatReportType.Sexy,
        Type = 0,
        Dialog = "208244",
    },
    {
        ReportType = ChatReportType.Attack,
        Type = 0,
        Dialog = "208245",
    },
    {
        ReportType = ChatReportType.NickName,
        Type = 1,
        Dialog = "208246",
    },
    {
        ReportType = ChatReportType.HeadIcon,
        Type = 1,
        Dialog = "208247",
    },
    {
        ReportType = ChatReportType.Other,
        Type = 0,
        Dialog = "208248",
    },
}

local title_path = "UICommonMidPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonMidPopUpTitle/bg_mid/CloseBtn"
-- local targetPlayerTxt_path = "ImgBg/txtTargetPlayer"
local playerName_path = "ImgBg/txtPlayerName"
local reasonTxt_path = "ImgBg/reason"
local choices_path = "ImgBg/choices/choiceItem"
local input_path = "ImgBg/InputField"
local reasonIptDefault_path = "ImgBg/InputField/Text Area/Placeholder"

local cancelBtn_path = "ImgBg/cancelBtn"
local cancelBtnTxt_path = "ImgBg/cancelBtn/cancelBtnTxt"
local confirmBtn_path = "ImgBg/confirmBtn"
local confirmBtnTxt_path = "ImgBg/confirmBtn/confirmBtnTxt"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
    self:Init()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.titleN:SetLocalText(208251)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.playerNameN = self:AddComponent(UITextMeshProUGUIEx, playerName_path)
    self.reasonTxtN = self:AddComponent(UITextMeshProUGUIEx, reasonTxt_path)
    self.reasonTxtN:SetLocalText(208253)
    self.choiceItemsTb = {}
    for i = 1, 9 do
        local tempPath = choices_path .. i
        local item = self:AddComponent(ChatReportItem, tempPath)
        table.insert(self.choiceItemsTb, item)
    end
    self.reasonIptN = self:AddComponent(UITMPInput, input_path)
    self.reasonIptN:SetOnEndEdit(function(value)
        self:RefreshReportBtn()
    end)
    self.reasonIptDefaultN = self:AddComponent(UITextMeshProUGUIEx, reasonIptDefault_path)
    self.reasonIptDefaultN:SetLocalText(208249)
    self.cancelBtnN = self:AddComponent(UIButton, cancelBtn_path)
    self.cancelBtnN:SetOnClick(function()
        self:OnClickCancelBtn()
    end)
    self.cancelBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, cancelBtnTxt_path)
    self.cancelBtnTxtN:SetLocalText(110106)
    self.confirmBtnN = self:AddComponent(UIButton, confirmBtn_path)
    self.confirmBtnN:SetOnClick(function()
        self:OnClickConfirmBtn()
    end)
    self.confirmBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, confirmBtnTxt_path)
    self.confirmBtnTxtN:SetLocalText(110006)
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.closeBtnN = nil
    -- self.targetPlayerTxtN = nil
    self.playerNameN = nil
    self.choiceItemsTb = nil
    self.reasonIptN = nil
    self.reasonIptDefaultN = nil
    self.cancelBtnN = nil
    self.cancelBtnTxtN = nil
    self.confirmBtnN = nil
    self.confirmBtnTxtN = nil
end

local function DataDefine(self)
    self.chatData = nil
    self.curReportItem = nil
end

local function DataDestroy(self)
    self.chatData = nil
    self.curReportItem = nil
end

local function Init(self)
    self.chatData = self:GetUserData()
    
    self:RefreshAll()
end

local function RefreshAll(self)
    self.playerNameN:SetText(Localization:GetString("208252", "<color=#fb3b3b>"..self.chatData:getSenderName()))

    for i, v in ipairs(self.choiceItemsTb) do
        if i <= #Conf then
            v:SetActive(true)
            v:SetItem(Conf[i])
        else
            v:SetActive(false)
        end
    end
    
    self:RefreshReportBtn()
end

local function RefreshReportBtn(self)
    if not self.curReportItem then
        CS.UIGray.SetGray(self.confirmBtnN.transform, true, false)
        return
    end

    local tempConf = self.curReportItem:GetReportConf()
    if tempConf.ReportType == ChatReportType.Other then
        local extra = self.reasonIptN:GetText()
        if string.IsNullOrEmpty(extra) or string.IsNullOrEmpty(string.trim(extra)) then
            CS.UIGray.SetGray(self.confirmBtnN.transform, true, false)
            return
        end
    end

    CS.UIGray.SetGray(self.confirmBtnN.transform, false, true)
end

local function OnSelectOne(self, reportItem)
    if self.curReportItem then
        self.curReportItem:SetSelected(false)
    end
    self.curReportItem = reportItem
    
    self:RefreshReportBtn()
end

local function OnClickCloseBtn(self)
    self.ctrl:CloseSelf()
end

local function OnClickConfirmBtn(self)
    if not self.curReportItem then
        return
    end
    
    local tempConf = self.curReportItem:GetReportConf()

    local extraNote = ""
    if tempConf.ReportType == ChatReportType.Other then
        extraNote = self.reasonIptN:GetText()
        if string.IsNullOrEmpty(extraNote) then
            return
        end
    end
    
    ChatManager2:GetInstance():ReportChat(self.chatData, tempConf.Type, tempConf.ReportType)
    UIUtil.ShowTipsId(280063)
    self.ctrl:CloseSelf()
end

local function OnClickCancelBtn(self)
    self.ctrl:CloseSelf()
end


UIChatReportView.OnCreate = OnCreate 
UIChatReportView.OnDestroy = OnDestroy
--UIChatReportView.OnAddListener = OnAddListener
--UIChatReportView.OnRemoveListener = OnRemoveListener
UIChatReportView.ComponentDefine = ComponentDefine
UIChatReportView.ComponentDestroy = ComponentDestroy
UIChatReportView.DataDefine = DataDefine
UIChatReportView.DataDestroy = DataDestroy

UIChatReportView.Init = Init
UIChatReportView.RefreshAll = RefreshAll
UIChatReportView.OnSelectOne = OnSelectOne
UIChatReportView.RefreshReportBtn = RefreshReportBtn
UIChatReportView.OnClickCloseBtn = OnClickCloseBtn
UIChatReportView.OnClickCancelBtn = OnClickCancelBtn
UIChatReportView.OnClickConfirmBtn = OnClickConfirmBtn

return UIChatReportView