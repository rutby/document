---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/17 16:35
---

local UIMasterySkillBtn = BaseClass("UIMasterySkillBtn", UIBaseContainer)
local base = UIBaseContainer
local UIGray = CS.UIGray

local btn_path = ""
local btn_text_path = "Text"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.btn = self:AddComponent(UIButton, btn_path)
    self.btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnClick()
    end)
    self.btn_text = self:AddComponent(UIText, btn_text_path)
end

local function ComponentDestroy(self)
    self.btn = nil
    self.btn_text = nil
end

local function DataDefine(self)
    self.skill = 0
    self.state = MasterySkillState.None
    self.endTime = 0
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.TimerAction, self, false, false, false)
        self.timer:Start()
    end
end

local function DataDestroy(self)
    self.skill = nil
    self.state = nil
    self.endTime = nil
    if self.timer then
        self.timer:Stop()
        self.timer = nil
    end
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.MasteryUseSkill, self.OnMasteryUseSkill)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.MasteryUseSkill, self.OnMasteryUseSkill)
    base.OnRemoveListener(self)
end

local function SetData(self, skill)
    self.skill = skill
    self:Refresh()
end

local function Refresh(self)
    local template = DataCenter.MasteryManager:GetTemplateBySkill(self.skill)
    local skillTemplate = DataCenter.MasteryManager:GetSkillTemplate(self.skill)
    if template == nil or skillTemplate == nil then
        return
    end
    
    self.state, self.endTime = DataCenter.MasteryManager:GetSkillState(self.skill)
    
    if self.state == MasterySkillState.Closed or self.state == MasterySkillState.NoUse then
        self.btn_text:SetLocalText(120105)
        self.btn:LoadSprite(string.format(LoadPath.CommonNewPath, "common_btn_yellow71"))
        UIGray.SetGray(self.btn.transform, true, false)
    elseif self.state == MasterySkillState.Normal then
        self.btn_text:SetLocalText(110046)
        self.btn:LoadSprite(string.format(LoadPath.CommonNewPath, "Common_btn_green71"))
        UIGray.SetGray(self.btn.transform, false, true)
    elseif self.state == MasterySkillState.Locked then
        self.btn_text:SetLocalText(130056)
        self.btn:LoadSprite(string.format(LoadPath.CommonNewPath, "common_btn_yellow71"))
        UIGray.SetGray(self.btn.transform, false, true)
    elseif self.state == MasterySkillState.CD then
        self.btn_text:SetText("")
        self.btn:LoadSprite(string.format(LoadPath.CommonNewPath, "common_btn_yellow71"))
        UIGray.SetGray(self.btn.transform, true, false)
        self:TimerAction()
    end
end

local function TimerAction(self)
    if self.state == MasterySkillState.CD then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        local restTime = self.endTime - curTime
        if restTime >= 0 then
            self.btn_text:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(restTime))
        else
            self:Refresh()
        end
    end
end

local function OnClick(self)
    DataCenter.MasteryManager:TryUseSkill(self.skill)
end

local function OnMasteryUseSkill(self, skill)
    if self.skill == skill then
        self:Refresh()
    end
end

UIMasterySkillBtn.OnCreate= OnCreate
UIMasterySkillBtn.OnDestroy = OnDestroy
UIMasterySkillBtn.ComponentDefine = ComponentDefine
UIMasterySkillBtn.ComponentDestroy = ComponentDestroy
UIMasterySkillBtn.DataDefine = DataDefine
UIMasterySkillBtn.DataDestroy = DataDestroy
UIMasterySkillBtn.OnEnable = OnEnable
UIMasterySkillBtn.OnDisable = OnDisable
UIMasterySkillBtn.OnAddListener = OnAddListener
UIMasterySkillBtn.OnRemoveListener = OnRemoveListener

UIMasterySkillBtn.SetData = SetData
UIMasterySkillBtn.Refresh = Refresh
UIMasterySkillBtn.TimerAction = TimerAction

UIMasterySkillBtn.OnClick = OnClick

UIMasterySkillBtn.OnMasteryUseSkill = OnMasteryUseSkill

return UIMasterySkillBtn