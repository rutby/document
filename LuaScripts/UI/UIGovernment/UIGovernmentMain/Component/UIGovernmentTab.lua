---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/13 20:54
---

local UIGovernmentTab = BaseClass("UIGovernmentTab", UIBaseContainer)
local base = UIBaseContainer
local GovernmentConst = require("DataCenter.GovernmentManager.GovernmentConst")
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local Title = require "UI.UIGovernment.UIGovernmentMain.Component.UIGovernmentTabTitle"
local Cell = require "UI.UIGovernment.UIGovernmentMain.Component.UIGovernmentTabCellLine"
local Localization = CS.GameEntry.Localization
--创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
    self:GetDataFromServer()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.title = self:AddComponent(UIText, "rewardTitle")
    self.title:SetLocalText(250005)
    self.content = self:AddComponent(UIBaseContainer, 'LoopScroll/Viewport/Content')
    self.scroll_view = self:AddComponent(UILoopListView2, 'LoopScroll')
    self.scroll_view:InitListView(0, function(loopView, index)
        return self:OnGetItemByIndex(loopView, index)
    end)
    
    self.tip_btn = self:AddComponent(UIButton, "rewardTitle/infoBtn")
    self.tip_btn:SetOnClick(function()
        self:OnClickTipBtn()
    end)

end

local function ComponentDestroy(self)
    self:ClearScroll()
end

local function DataDefine(self)

end

local function DataDestroy(self)

end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ReInit(self, data)
    self.data = data
    self:GetDataFromServer()
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.KingdomPositionInfoUpdate, self.OnDataChange)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.KingdomPositionInfoUpdate, self.OnDataChange)
    base.OnRemoveListener(self)
end
local function OnGetItemByIndex(self, loopScroll, index)
    index = index + 1 --C#控件索引从0开始 
    if index < 1 or index > #self.dataList then
        return nil
    end

    local dt = self.dataList[index]

    --标题行-- titleLine
    if dt.type == GovernmentConst.Official_Appoint_Cell_Type.Official_Appoint_Cell_Type_Title then
        local item = loopScroll:NewListViewItem('TitleLine')
        local script = self.content:GetComponent(item.gameObject.name, Title)
        if script == nil then
            local objectName = self:GetItemNameSequence()
            item.gameObject.name = objectName
            if (not item.IsInitHandlerCalled) then
                item.IsInitHandlerCalled = true
            end

            script = self.content:AddComponent(Title, objectName)
        end

        script:SetActive(true)
        script:SetData(dt)
        return item
    end

    --数据行
    local item = loopScroll:NewListViewItem('Cells')
    local script = self.content:GetComponent(item.gameObject.name, Cell)
    if script == nil then
        local objectName = self:GetItemNameSequence()
        item.gameObject.name = objectName
        if (not item.IsInitHandlerCalled) then
            item.IsInitHandlerCalled = true
        end

        script = self.content:AddComponent(Cell, objectName)
    end

    script:SetActive(true)
    script:SetData(dt, BindCallback(self, self.OnCellClick))
    return item
end

local function ClearScroll(self)
    self.content:RemoveComponents(Cell)
    self.content:RemoveComponents(Title)
    self.scroll_view:ClearAllItems()
end

local function ShowScroll(self)
    self.dataList = self.view.ctrl:GetGovernmentTabData().list
    local count = table.count(self.dataList)

    self.scroll_view:SetListItemCount(count, false, false)
    self.scroll_view:RefreshAllShownItem()
end

local function RefreshView(self)
    self:ShowScroll()
end

local function GetDataFromServer(self)
    DataCenter.GovernmentManager:GetKingdomPositions(LuaEntry.Player:GetSrcServerId())
end

local function OnCellClick(self, data)
    local positionInfo = DataCenter.GovernmentManager:GetPositionInfoByPositionId(data.id)
    local para = {}
    if positionInfo ~= nil then
        para.uid = positionInfo.uid
        para.pic = positionInfo.pic
        para.picVer = positionInfo.picVer
        para.headSkinId = positionInfo.headSkinId
        para.headSkinET = positionInfo.headSkinET
        para.serverId = LuaEntry.Player:GetSelfServerId()
    end
    para.canAssign = DataCenter.GovernmentManager:IsSelfPresident() and data.id ~= GovernmentConst.King_Position_id

    UIManager:GetInstance():OpenWindow(UIWindowNames.UIGovernmentInfo, {anim = true}, data.id, para)
end

local function GetItemNameSequence(self)
    NameCount = NameCount + 1
    return tostring(NameCount)
end

local function OnDataChange(self)
    self:RefreshView()
end

local function OnClickTipBtn(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.tip_btn.transform.position + Vector3.New(0, -30, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    local str = Localization:GetString("250125")
    param.content = str
    param.dir = UIHeroTipView.Direction.BELOW
    param.defWidth = 300
    param.pivot = 0.85
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

UIGovernmentTab.OnClickTipBtn = OnClickTipBtn
UIGovernmentTab.OnCreate = OnCreate
UIGovernmentTab.OnDestroy = OnDestroy
UIGovernmentTab.OnEnable = OnEnable
UIGovernmentTab.OnDisable = OnDisable
UIGovernmentTab.ComponentDefine = ComponentDefine
UIGovernmentTab.ComponentDestroy = ComponentDestroy
UIGovernmentTab.DataDefine = DataDefine
UIGovernmentTab.DataDestroy = DataDestroy
UIGovernmentTab.ReInit = ReInit
UIGovernmentTab.OnGetItemByIndex = OnGetItemByIndex
UIGovernmentTab.ClearScroll = ClearScroll
UIGovernmentTab.ShowScroll = ShowScroll
UIGovernmentTab.RefreshView = RefreshView
UIGovernmentTab.GetDataFromServer = GetDataFromServer
UIGovernmentTab.OnCellClick = OnCellClick
UIGovernmentTab.GetItemNameSequence = GetItemNameSequence
UIGovernmentTab.OnAddListener = OnAddListener
UIGovernmentTab.OnRemoveListener = OnRemoveListener
UIGovernmentTab.OnDataChange = OnDataChange

return UIGovernmentTab