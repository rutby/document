---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/3/20 16:33
---
local UIPositionAppointView = BaseClass("UIPositionAppointView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local Cell = require("UI.UIGovernment.UIPositionAppoint.Component.UIPositionAppointViewCell")

local txt_title_path ="UICommonPopUpTitle/bg_mid/titleText"
local close_btn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local return_btn_path = "UICommonPopUpTitle/panel"
local scroll_path = "ImgBg/ScrollView"
local txt_title1_path = "ImgBg/title_1"

local function OnCreate(self)
    base.OnCreate(self)
    self.txt_title = self:AddComponent(UITextMeshProUGUIEx, txt_title_path)
    self.txt_title:SetLocalText(250014)
    self.txt_title1 = self:AddComponent(UIText, txt_title1_path)
    self.txt_title1:SetLocalText(250077)

    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf(self.data, self.user)
    end)

    self.return_btn = self:AddComponent(UIButton, return_btn_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf(self.data, self.user)
    end)
    
    self.ScrollView = self:AddComponent(UIScrollView, scroll_path)
    self.ScrollView:SetOnItemMoveIn(function(itemObj, index)
        self:OnAllianceItemMoveIn(itemObj, index)
    end)
    self.ScrollView:SetOnItemMoveOut(function(itemObj, index)
        self:OnAllianceItemMoveOut(itemObj, index)
    end)

    self.player_head = self:AddComponent(UIPlayerHead, "ImgBg/UIThroneRewardSelectMemberCell/head/UIPlayerHead/HeadIcon")
    self.headBg = self:AddComponent(UIImage, "ImgBg/UIThroneRewardSelectMemberCell/head/UIPlayerHead")
    self.headFg = self:AddComponent(UIImage, "ImgBg/UIThroneRewardSelectMemberCell/head/UIPlayerHead/Foreground")
    self.power = self:AddComponent(UIText, "ImgBg/UIThroneRewardSelectMemberCell/power")
    self.name = self:AddComponent(UIText, "ImgBg/UIThroneRewardSelectMemberCell/NameLayoutGo/NameTxt")
    
    self:OnOpen()
end

local function OnDestroy(self)
    self:ClearScroll()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAllianceItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.ScrollView:AddComponent(Cell, itemObj)
    cellItem:SetData(self.dataList[index])
end

local function OnAllianceItemMoveOut(self, itemObj, index)
    self.ScrollView:RemoveComponent(itemObj.name, Cell)
end

local function ClearScroll(self)
    self.ScrollView:ClearCells()
    self.ScrollView:RemoveComponents(Cell)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.KingdomPositionInfoUpdate, self.OnDataChange)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.KingdomPositionInfoUpdate, self.OnDataChange)
    base.OnRemoveListener(self)
end

local function ShowCells(self)
    self:ClearScroll()
    local count = #self.dataList
    if count == 0 then
        return
    end
    self.ScrollView:SetTotalCount(count)
    self.ScrollView:RefillCells()
end

local function OnOpen(self)
    self:GetDataFromServer()
end

local function GetDataFromServer(self)
    DataCenter.GovernmentManager:GetKingdomPositions(LuaEntry.Player:GetSrcServerId())
end

local function OnDataChange(self)
    self.data = self:GetUserData()
    self.dataList = self.ctrl:GetPanelData(self.data.ownerUid, self.data.name)
    
    self.player_head:SetData(self.data.ownerUid, self.data.pic, self.data.picVer)
    local headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(self.data.headSkinId, self.data.headSkinET)
    if headBgImg ~= nil then
        self.headFg:SetActive(true)
        self.headFg:LoadSprite(headBgImg)
    else
        self.headFg:SetActive(false)
    end
    self.power:SetText(string.GetFormattedSeperatorNum(self.data.power))
    self.name:SetText(self.data.name)

    self:ShowCells()
end

UIPositionAppointView.OnCreate= OnCreate
UIPositionAppointView.OnDestroy = OnDestroy
UIPositionAppointView.OnEnable = OnEnable
UIPositionAppointView.OnDisable = OnDisable
UIPositionAppointView.OnAllianceItemMoveIn = OnAllianceItemMoveIn
UIPositionAppointView.OnAllianceItemMoveOut = OnAllianceItemMoveOut
UIPositionAppointView.ClearScroll = ClearScroll
UIPositionAppointView.OnAddListener = OnAddListener
UIPositionAppointView.OnRemoveListener = OnRemoveListener
UIPositionAppointView.ShowCells = ShowCells
UIPositionAppointView.OnOpen = OnOpen
UIPositionAppointView.GetDataFromServer = GetDataFromServer
UIPositionAppointView.OnDataChange = OnDataChange

return UIPositionAppointView