---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/1/18 17:26
---
local UIFiveStarGetView = BaseClass("UIFiveStarGetView",UIBaseView)
local base = UIBaseView
local Setting = CS.GameEntry.Setting
local Localization = CS.GameEntry.Localization
local title_text_path = "Image/titleText"
local close_btn_path = "Image/CloseBtn"
local content_text_path = "Image/DesName"
local left_btn_path = "Image/BtnGo/LeftBtn"
local left_btn_text_path = "Image/BtnGo/LeftBtn/LeftBtnName"
local right_btn_path = "Image/BtnGo/BtnFeedback"
local right_btn_text_path = "Image/BtnGo/BtnFeedback/FeedbackBtnName"
local resource_cell_path = "Image/ResourceCell"
local function OnCreate(self)
    base.OnCreate(self)
    self.isApple = CS.SDKManager.IS_UNITY_IPHONE()
    self:ComponentDefine()
end

local function ComponentDefine(self)
    self.title_text = self:AddComponent(UITextMeshProUGUIEx, title_text_path)
    self.close_btn = self:AddComponent(UIButton, close_btn_path)
    self.close_btn:SetOnClick(function ()
        if self.state>0 then
            self:OnBtnClick()
        else
            local num = Setting:GetPrivateInt("APS_FiveStar_Close", 0)
            Setting:SetPrivateInt("APS_FiveStar_Close",(num+1))
            EventManager:GetInstance():Broadcast(EventId.CheckFiveStar)
            self.ctrl:CloseSelf()
        end
    end)
    
    --左侧按钮(跳转/领取)
    self.content_text = self:AddComponent(UITextMeshProUGUIEx, content_text_path)
    self.resource_des = self:AddComponent(UITextMeshProUGUIEx,"Image/resourceDes")
    self.resource_des:SetLocalText(170557)
    self.resource_cell = self:AddComponent(UIBaseContainer,resource_cell_path)
    self.resource_cell:SetActive(self.isApple==false)
    self.resource_des:SetActive(self.isApple)
    self.left_btn_img = self:AddComponent(UIImage, left_btn_path)
    self.left_btn = self:AddComponent(UIButton, left_btn_path)
    self.left_btn:SetOnClick(function ()
        self:OnBtnClick()
    end)
    self.left_btn_text = self:AddComponent(UITextMeshProUGUIEx, left_btn_text_path)
    
    --右侧按钮(吐槽)
    self.right_btn = self:AddComponent(UIButton, right_btn_path)
    self.right_btn:SetOnClick(function()
        self:OnFeedbackBtnClick()
    end)
    self.right_btn_text = self:AddComponent(UITextMeshProUGUIEx, right_btn_text_path);
    self.right_btn_text:SetText(Localization:GetString("121553"));
    self.state = Setting:GetPrivateInt("APS_FiveStar_Jump", 0)
    
end


local function OnDestroy(self)
    self.title_text = nil
    self.close_btn = nil
    self.content_text = nil

    self.left_btn = nil
    self.left_btn_text = nil
    self.right_btn = nil
    self.right_btn_text = nil
    self.btn_text_shadow = nil;
    
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    -- 五星好评吐槽开关
    self.is_feed_back_on = LuaEntry.DataConfig:CheckSwitch("five_star_roast")
    self:RefreshView()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.FiveStarFeedbackComplete, self.onFeedbackComplete)
end


local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.FiveStarFeedbackComplete, self.onFeedbackComplete)
    base.OnRemoveListener(self)
end


local function RefreshView(self)
    self.title_text:SetText(Localization:GetString("170460"))
    if self.isApple then
        self.content_text:SetText(Localization:GetString("170556"))
    else
        self.content_text:SetText(Localization:GetString("170461"))
    end
    
    self:SetButtonState()
end

-- 原始版本的按钮样式
local function OriginStyleSetButtonState(self)
    if self.state>0 then
        self.left_btn_img:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_btn_green101.png")
        self.left_btn_text:SetText(Localization:GetString("170004"))
        -- 原始版本不显示吐槽按钮
        self.right_btn:SetActive(false)
    else
        self.left_btn_img:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_btn_yellow101.png")
        self.left_btn_text:SetText(Localization:GetString("121554"))

        -- 原始版本不显示吐槽按钮
        self.right_btn:SetActive(false)
    end
end

-- 五星吐槽版本的按钮样式
local function FeedbackStyleSetButtonState(self)
    if self.state>0 then
        self.left_btn_text:SetText(Localization:GetString("170004"))

        -- 吐槽版本 已经吐槽过或者点赞完成的玩家不显示吐槽按钮
        self.right_btn:SetActive(false)
    else
        self.left_btn_text:SetText(Localization:GetString("121554"))

        -- 吐槽版本 没有吐槽或者前往评价的 要显示吐槽按钮
        self.right_btn:SetActive(true)
    end
end

local function SetButtonState(self)
    if self.is_feed_back_on then
        self:FeedbackStyleSetButtonState()
    else
        self:OriginStyleSetButtonState()
    end
end


local function OnBtnClick(self)
    if self.isApple then
        DataCenter.GuideManager:SendLogMessage(FiveStarTaskId, StatTTType.FiveStarJump,"")
        CS.UnityEngine.Application.OpenURL(CS.GameEntry.GlobalData.downloadurl);
        Setting:SetPrivateInt("APS_FiveStar",1)
        EventManager:GetInstance():Broadcast(EventId.CheckFiveStar)
        self.ctrl:CloseSelf()
    else
        if self.state>0 then
            Setting:SetPrivateInt("APS_FiveStar",1)
            EventManager:GetInstance():Broadcast(EventId.CheckFiveStar)
            SFSNetwork.SendMessage(MsgDefines.TaskRewardGet,{id = FiveStarTaskId})
            DataCenter.GuideManager:SendLogMessage(FiveStarTaskId, StatTTType.FiveStarReceive,"")
            self.ctrl:CloseSelf()
        else
            SFSNetwork.SendMessage(MsgDefines.FiveStar,1, "")
            DataCenter.GuideManager:SendLogMessage(FiveStarTaskId, StatTTType.FiveStarJump,"")
            CS.UnityEngine.Application.OpenURL(CS.GameEntry.GlobalData.downloadurl);
            Setting:SetPrivateInt("APS_FiveStar_Jump",1)
            TimerManager:GetInstance():DelayInvoke(function()
                self.state = 1
                self:SetButtonState()
            end,1.5)
        end
    end
    
end

--点击吐槽按钮 打开新界面
local function OnFeedbackBtnClick(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFiveStarFeedBack)
end

--吐槽完成 进入发奖逻辑
local function onFeedbackComplete(self)
    self.state = 1
    self:SetButtonState()
end

UIFiveStarGetView.OnCreate = OnCreate
UIFiveStarGetView.OnDestroy = OnDestroy
UIFiveStarGetView.OnEnable = OnEnable
UIFiveStarGetView.OnDisable = OnDisable
UIFiveStarGetView.OnAddListener = OnAddListener
UIFiveStarGetView.OnRemoveListener = OnRemoveListener
UIFiveStarGetView.ComponentDefine = ComponentDefine
UIFiveStarGetView.RefreshView = RefreshView
UIFiveStarGetView.SetButtonState = SetButtonState
UIFiveStarGetView.OnBtnClick = OnBtnClick
UIFiveStarGetView.OnFeedbackBtnClick = OnFeedbackBtnClick
UIFiveStarGetView.onFeedbackComplete = onFeedbackComplete
UIFiveStarGetView.OriginStyleSetButtonState = OriginStyleSetButtonState
UIFiveStarGetView.FeedbackStyleSetButtonState = FeedbackStyleSetButtonState

return UIFiveStarGetView