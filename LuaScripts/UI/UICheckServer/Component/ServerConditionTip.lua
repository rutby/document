---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/4/17 17:06
---
local ServerConditionTip = BaseClass("ServerConditionTip", UIBaseContainer)
local ServerConditionTipItem = require "UI.UICheckServer.Component.ServerConditionTipItem"
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local title_path = "Root/img/TextTitle"
local root_path ="Root"
local item1_path ="Root/Content/checkItem1"
local item2_path ="Root/Content/checkItem2"
local item3_path ="Root/Content/checkItem3"
local item4_path ="Root/Content/checkItem4"
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.title = self:AddComponent(UIText,title_path)
    self.title:SetText(Localization:GetString("250306",""))
    self.root = self:AddComponent(UIBaseContainer,root_path)
    self.item1 = self:AddComponent(ServerConditionTipItem,item1_path)
    self.item2 = self:AddComponent(ServerConditionTipItem,item2_path)
    self.item3 = self:AddComponent(ServerConditionTipItem,item3_path)
    --self.item4 = self:AddComponent(ServerConditionTipItem,item4_path)
    self.close_btn = self:AddComponent(UIButton, "Panel")
    self.close_btn:SetOnClick(function()
        self.view:HideTips()
    end)
    
end

local function ComponentDestroy(self)
    self.title = nil
    self.name = nil
    self.num = nil
end

local function DataDefine(self)
end

local function DataDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function RefreshCondition(self,data)
    local isFit = true
    if data==nil then
        return false
    end
    local season = data.season
    local seasonDes = Localization:GetString("250309","S"..(season+1))
    --if season == DataCenter.SeasonDataManager:GetSeason() then
    --    self.item1:SetData(seasonDes,true)
    --else
    --    self.item1:SetData(seasonDes,false)
    --    isFit = false
    --end
    self.item1:SetActive(false)
    local targetPower = data.targetPowerLimit
    local selfPower = data.maxPower
    local powerDes = Localization:GetString("250310",string.GetFormattedSeperatorNum(targetPower))
    if selfPower<=targetPower then
        self.item2:SetData(powerDes,true)
    else
        local applyData = DataCenter.MigrateDataManager:OnGetMigrateApplyDataByServerId(data.serverId)
        local showRed =true
        if applyData~=nil then
            local applyState = applyData.state
            if applyState == MigrateApplyType.AGREE then
                local curTime = UITimeManager:GetInstance():GetServerTime()
                local deltaTime = LuaEntry.DataConfig:TryGetNum("aps_migrate_server", "k5")
                local endTime = applyData.approveTime+(deltaTime*1000*60)
                if endTime> curTime then
                    showRed = false
                end
            end
        end
        if showRed ==true then
            self.item2:SetData(powerDes,false)
            isFit = false
        else
            self.item2:SetData(powerDes,true)
        end
        
    end
    
    local minCityLevel = 30
    if data.condition~=nil and data.condition[1]~=nil then
        minCityLevel = data.condition[1]
    end
    local mainLv = DataCenter.BuildManager.MainLv
    local lvDes = Localization:GetString("250311",minCityLevel)
    if mainLv>=minCityLevel then
        self.item3:SetData(lvDes,true)
    else
        self.item3:SetData(lvDes,false)
        isFit = false
    end
    --local allianceDes = Localization:GetString("250318")
    --if LuaEntry.Player:IsInAlliance() ==false then
    --    self.item4:SetData(allianceDes,true)
    --else
    --    self.item4:SetData(allianceDes,false)
    --    isFit = false
    --end
    return isFit
end

local function OnSetPos(self,pos)
    self.root.transform.position = pos
end


ServerConditionTip.OnCreate= OnCreate
ServerConditionTip.OnDestroy = OnDestroy
ServerConditionTip.ComponentDefine = ComponentDefine
ServerConditionTip.ComponentDestroy = ComponentDestroy
ServerConditionTip.DataDefine = DataDefine
ServerConditionTip.DataDestroy = DataDestroy
ServerConditionTip.OnEnable = OnEnable
ServerConditionTip.OnDisable = OnDisable
ServerConditionTip.RefreshCondition = RefreshCondition
ServerConditionTip.OnSetPos = OnSetPos
return ServerConditionTip