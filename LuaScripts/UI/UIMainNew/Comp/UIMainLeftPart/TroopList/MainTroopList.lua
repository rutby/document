---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/11/16 19:00
---
local FormationCreateTipNew = require "UI.UIFormation.UIFormationSelectListNew.Component.FormationCreateTipNew"
local FormationArmyTipNew = require "UI.UIFormation.UIFormationSelectListNew.Component.FormationArmyTipNew"
local FormationSelectListCellNew = require "UI.UIFormation.UIFormationSelectListNew.Component.FormationSelectListCellNew"
local MainTroopList = BaseClass("MainTroopList",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local ResourceManager = CS.GameEntry.Resource
local content_path = "layout"
local detail_btn_path = "Button"
local formation_army_tip_path = "FormationArmyTips"
local rally_army_tip_path = "RallyArmyTip"
local create_army_tip_path = "CreateArmyTip"
local add_obj_path = "AddObj"
local add_btn_path = "AddObj/addBtn"

local function OnCreate(self)
    base.OnCreate(self)
    self.view.ctrl:InitData()
    self.content = self:AddComponent(UIBaseContainer,content_path)
    self.formation_army_tip = self:AddComponent(FormationArmyTipNew,formation_army_tip_path)
    self.formation_army_tip:SetActive(false)
    self.create_army_tip = self:AddComponent(FormationCreateTipNew,create_army_tip_path)
    self.create_army_tip:SetActive(false)
    self.detail_btn = self:AddComponent(UIButton, detail_btn_path)
    self.detail_btn:SetOnClick(function()
        self:OnClickDetailBtn()
    end)
    self.timer_action = function(temp)
        self:RefreshFormationStamina()
    end
    self.add_obj = self:AddComponent(UIBaseContainer, add_obj_path)
    self.add_btn = self:AddComponent(UIButton, add_btn_path)
    self.add_btn:SetOnClick(function()
        self:OnAddBtn()
    end)
    self.FormationTimeList = {}
    self.formationList={}
    self.FormationPowerList ={}
end

local function OnDestroy(self)
    self.title = nil
    self.content = nil
    self.return_btn =nil
    self.formationList = nil
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:OnRefresh()
    self:AddTimer()
end

local function OnDisable(self)
    self:DeleteTimer()
    base.OnDisable(self)
end

local function ClearContent(self)
    self.content:RemoveComponents(FormationSelectListCellNew)
    if self.model~=nil then
        for k,v in pairs(self.model) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.model ={}
    self.formationList={}
end
local function OnRefresh(self,show)
    self:ClearContent()
    self.listCount = 0
    self.maxCount =0
    local data = self.view.ctrl:GetFormationListData()
    if data~=nil then
        self.maxCount =data.maxNum
        local list = data.list
        if list~=nil then
            self.listCount = 0
            for i = 1, #list do
                local showUnLock = true
                local formationInfo = DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(list[i])
                local index = i
                if formationInfo~=nil then
                    index = formationInfo.index
                    if index == 4 then
                        local hasMonthCard = DataCenter.MonthCardNewManager:CheckIfMonthCardActive()
                        if hasMonthCard == false then
                            if formationInfo then
                                local march = DataCenter.WorldMarchDataManager:GetOwnerFormationMarch(LuaEntry.Player.uid, formationInfo.uuid, LuaEntry.Player.allianceId)
                                if march ==nil then
                                    showUnLock = false
                                end
                            else
                                showUnLock = false
                            end
                        end
                    end
                    if self.model[index]==nil and showUnLock == true then
                        self.listCount = self.listCount+1
                        local uuid = list[i]
                        self.model[index] = self:GameObjectInstantiateAsync(UIAssets.UIMainFormationSelectListCellNew, function(request)
                            if request.isError then
                                return
                            end
                            local go = request.gameObject;
                            go.gameObject:SetActive(true)
                            go.transform:SetParent(self.content.transform)
                            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                            local nameStr = tostring(NameCount)
                            go.name = nameStr
                            NameCount = NameCount + 1
                            local cell = self.content:AddComponent(FormationSelectListCellNew,nameStr)
                            if uuid~=nil then
                                cell:SetUuidAndIndex(index,uuid)
                                cell:RefreshData(show)
                            else
                                cell:SetUuidAndIndex(index)
                                cell:RefreshData(show)
                            end
                            self.formationList[index] = cell
                        end)
                    end
                    
                end
            end
        end
    end
    self.add_btn:SetActive(self.maxCount>self.listCount)
end

local function OnMonthCardUnlock(self,data)
    self:OnRefresh()
end
local function OnMarchRefresh(self)
    if self.formationList~=nil then
        table.walk(self.formationList,function (k,v)
            v:RefreshMarchData()
        end)
    end
end

local function OnFormationRefresh(self)
    if CS.SceneManager.IsInPVE() then
        return
    end
    local list = {}
    local data = self.view.ctrl:GetFormationListData()
    if data~=nil then
        list = data.list
    end
    if self.formationList~=nil then
        table.walk(self.formationList,function (k,v)
            local formationInfo =DataCenter.ArmyFormationDataManager:GetOneArmyInfoByUuid(list[k])
            local index = k
            if formationInfo~=nil then
                index = formationInfo.index
            end
            if list[k]~=nil then
                v:SetUuidAndIndex(index,list[k])
            end
            if index == 4 then
                local showUnLock = true
                local hasMonthCard = DataCenter.MonthCardNewManager:CheckIfMonthCardActive()
                if hasMonthCard == false then
                    if formationInfo then
                        local march = DataCenter.WorldMarchDataManager:GetOwnerFormationMarch(LuaEntry.Player.uid, formationInfo.uuid, LuaEntry.Player.allianceId)
                        if march ==nil then
                            showUnLock = false
                        end
                    else
                        showUnLock = false
                    end
                end
                if showUnLock == false then
                    v:SetUuidAndIndex(index)
                end
            end
            v:RefreshData()
        end)
    end
end

local function OnSelectClick(self,uuid)
    table.walk(self.formationList,function(k,v)
        v:OnSelectClick(uuid)
    end)
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.MarchItemUpdateSelf, self.OnMarchRefresh)
    self:AddUIListener(EventId.ArmyFormatUpdate, self.OnFormationRefresh)
    --self:AddUIListener(EventId.ShowTroopBattleValue, self.ShowTroopBattleSignal)
    self:AddUIListener(EventId.ArmyFormationSave, self.OnFormationRefresh)
    self:AddUIListener(EventId.HideMarchTip,self.OnResetMarchTip)
    self:AddUIListener(EventId.TrainArmyData, self.OnFormationRefresh)
    self:AddUIListener(EventId.HeroLvUpSuccess, self.OnFormationRefresh)
    self:AddUIListener(EventId.PveLevelExit, self.OnFormationRefresh)
    self:AddUIListener(EventId.ShowFormationSelect,self.ShowFormationSelect)
    self:AddUIListener(EventId.HideFormationSelect,self.HideFormationSelect)
    self:AddUIListener(EventId.FormationStaminaUpdate,self.RefreshFormationStamina)
    self:AddUIListener(EventId.MonthCardInfoUpdated,self.OnMonthCardUnlock)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.MarchItemUpdateSelf,self.OnMarchRefresh)
    self:RemoveUIListener(EventId.ArmyFormatUpdate, self.OnFormationRefresh)
    --self:RemoveUIListener(EventId.ShowTroopBattleValue, self.ShowTroopBattleSignal)
    self:RemoveUIListener(EventId.ArmyFormationSave, self.OnFormationRefresh)
    self:RemoveUIListener(EventId.HideMarchTip,self.OnResetMarchTip)
    self:RemoveUIListener(EventId.TrainArmyData, self.OnFormationRefresh)
    self:RemoveUIListener(EventId.HeroLvUpSuccess, self.OnFormationRefresh)
    self:RemoveUIListener(EventId.ShowFormationSelect,self.ShowFormationSelect)
    self:RemoveUIListener(EventId.HideFormationSelect,self.HideFormationSelect)
    self:RemoveUIListener(EventId.FormationStaminaUpdate,self.RefreshFormationStamina)
    self:RemoveUIListener(EventId.PveLevelExit, self.OnFormationRefresh)
    self:RemoveUIListener(EventId.MonthCardInfoUpdated,self.OnMonthCardUnlock)
end


local function ShowFormationArmyTip(self,posX,posY,formationData)
    self.formation_army_tip:SetActive(true)
    self.create_army_tip:SetActive(false)
    self.formation_army_tip:RefreshData(posX,posY,formationData)
end

local function HideAllShowTip(self)
    self.formation_army_tip:ResetOldUuid()
    self.formation_army_tip:SetActive(false)
    self.create_army_tip:SetActive(false)
end

local function OnResetMarchTip(self)
    self.view.ctrl:SetSelectFormationUuid(0)
    self:HideAllShowTip()
end
--local function ShowTroopBattleSignal(self,data)
--    local str = data
--    if str~=nil then
--        local strArr = string.split(str,";")
--        if #strArr>3 then
--            local marchUuid = tonumber(strArr[1])
--            local hp = tonumber(strArr[3])
--            local hpMax = tonumber(strArr[4])
--            if self.formationList~=nil then
--                table.walk(self.formationList,function (k,v)
--                    v:RefreshSlider(marchUuid,hp,hpMax)
--                end)
--            end
--        end
--    end
--end

local function ShowFormationSelect(self,data)
    local marchUuid = tonumber(data)
    local info = DataCenter.WorldMarchDataManager:GetMarch(marchUuid)
    if info~=nil then
        local formationUuid = info.ownerFormationUuid
        self.view.ctrl:SetSelectFormationUuid(formationUuid)
        table.walk(self.formationList,function(k,v)
            v:OnSelectClick(formationUuid)
        end)
    end
end

local function HideFormationSelect(self,data)
    local marchUuid = tonumber(data)
    local info = DataCenter.WorldMarchDataManager:GetMarch(marchUuid)
    if info~=nil then
        local formationUuid = info.ownerFormationUuid
        if self.view.ctrl.selectFormationUuid==0 or self.view.ctrl.selectFormationUuid == formationUuid then
            self.view.ctrl:SetSelectFormationUuid(0)
            self:HideAllShowTip()
            table.walk(self.formationList,function(k,v)
                v:OnSelectClick(0)
            end)
        end
       
    end
end

local function ShowFormationCreateTip(self,posX,posY,formationData)
    self.formation_army_tip:SetActive(false)
    self.create_army_tip:SetActive(true)
    self.create_army_tip:RefreshData(posX,posY,formationData)
end

local function ShowFormationRallyTip(self,posX,posY,formationData)
    self.formation_army_tip:SetActive(false)
    self.create_army_tip:SetActive(false)
    self.rally_army_tip:RefreshData(posX,posY,formationData)
end

local function GetTimeInFormation(self,formationUuid)
    return self.view.ctrl:GetTimeFormCurPosToTarPos(formationUuid)
end

local function OnAtkClick(self,uuid)
    self.view.ctrl:OnAtkClick(uuid)
end

local function OnEditClick(self,uuid,needAutoFix)
    self.view.ctrl:OnEditClick(uuid,needAutoFix)

end
local function OnCreateClick(self,uuid)
    self.view.ctrl:OnCreateClick(uuid)

end




local function AddTimer(self)
    --local speedAddEffect = LuaEntry.Effect:GetGameEffect(EffectDefine.STAMINA_RECOVER_SPEED_ADD)
    --local timeBase = LuaEntry.DataConfig:TryGetNum("car_stamina", "k2")
    --local k2 = timeBase/(1+(speedAddEffect/100))
    --if k2>0 then
        if self.timer == nil then
            self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
        end
        self.timer:Start()
    --end
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function RefreshFormationStamina(self)
    if self.formationList~=nil then
        table.walk(self.formationList,function (k,v)
            v:UpdateTime()
        end)
    end
end

local function OnClickDetailBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIWorldMarchDetail)
end

local function OnAddBtn(self)
    --if self.maxCount~=nil and self.listCount~=nil and self.maxCount>self.listCount then
    --    local needIndex = self.listCount+1
    --    local name = self.view.ctrl:GetFormationBuildNameByIndex(needIndex)
    --    UIUtil.ShowSingleTip(Localization:GetString(GameDialogDefine.UNLOCK_ARMY_FORMATION,name))
    --end
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationAdd,{anim = true,isBlur = true})
end

MainTroopList.OnCreate = OnCreate
MainTroopList.OnDestroy = OnDestroy
MainTroopList.OnRefresh = OnRefresh
MainTroopList.OnEnable = OnEnable
MainTroopList.OnDisable = OnDisable
MainTroopList.OnAddListener = OnAddListener
MainTroopList.OnRemoveListener = OnRemoveListener
MainTroopList.OnMarchRefresh = OnMarchRefresh
MainTroopList.ShowFormationArmyTip = ShowFormationArmyTip
MainTroopList.ShowFormationRallyTip = ShowFormationRallyTip
MainTroopList.ShowFormationCreateTip = ShowFormationCreateTip
MainTroopList.ClearContent = ClearContent
MainTroopList.GetTimeInFormation= GetTimeInFormation
MainTroopList.OnAtkClick =OnAtkClick
MainTroopList.OnEditClick = OnEditClick
MainTroopList.OnCreateClick = OnCreateClick
MainTroopList.OnSelectClick = OnSelectClick
MainTroopList.HideAllShowTip = HideAllShowTip

MainTroopList.OnResetMarchTip =OnResetMarchTip
MainTroopList.ShowFormationSelect = ShowFormationSelect
MainTroopList.HideFormationSelect = HideFormationSelect
MainTroopList.OnFormationRefresh = OnFormationRefresh
MainTroopList.AddTimer =AddTimer
MainTroopList.DeleteTimer =DeleteTimer
MainTroopList.RefreshFormationStamina =RefreshFormationStamina
MainTroopList.OnAddBtn = OnAddBtn
MainTroopList.OnClickDetailBtn =OnClickDetailBtn
MainTroopList.OnMonthCardUnlock= OnMonthCardUnlock
return MainTroopList