---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/9/19 14:20
---
local UICommonMessageSpecialBarView = BaseClass("UICommonMessageSpecialBarView",UIBaseView)
local base = UIBaseView
local Localization = CS.GameEntry.Localization
local CommonMessageSpecialBarItem = require "UI.UICommonMessageSpecialBar.View.CommonMessageSpecialBarItem"

local closeBtn_path = "Panel"
local messageItem_path = "Panel/msgItem"

local timeBeforeFadeOut = 0.6

local function OnCreate(self)
    base.OnCreate(self)

    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.messageItems = {}
    for i = 1, 2 do
        local tempItem = self:AddComponent(CommonMessageSpecialBarItem, messageItem_path .. i)
        table.insert(self.messageItems, tempItem)
    end

    self.isReady = true
    self.displayTime = 0
    self.inUseItems = self.messageItems--暂时没用
    self.outUseItems = {}--暂时没用
    self.displayingIndex = 0
    self:TryDisplayNext()
end

local function OnDestroy(self)
    for i, v in ipairs(self.messageItems) do
        v:ResetItem()
    end

    self.closeBtnN = nil
    self.messageItems = nil
    self.msgQueue = nil

    self:DeleteTimer()

    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self.isReady = true
end

local function OnDisable(self)
    base.OnDisable(self)
end


--新提示
--playerHead = {uid = "", pic = "", picVer = ""}
local function AddNewMsg(self, newMsg, showTime)
    if not self.msgQueue then
        self.msgQueue = {}
    end
    if self.msgQueue == nil then
        self.msgQueue = {}
    end
    if showTime~=nil then
        self.showEndTime = showTime
    else
        self.showEndTime = 2
    end
    table.insert(self.msgQueue, newMsg)
    self:TryDisplayNext()

    if not self.timer then
        self.timer = TimerManager:GetInstance():GetTimer(timeBeforeFadeOut, self.TimerAction , self, false,false,false)
        self.timer:Start()
    end
    if self.isReady then
        self.timer:Reset()
    end
end

local function AddNewMsg_Msg(self, msg,showTime, playerHead,heroHead)
    local newMsg = {
        msg = msg,
        playerHead = playerHead,
        heroHead = heroHead,
    }
    self:AddNewMsg(newMsg, showTime)
end
local function TryDisplayNext(self)
    if self.isReady then
        if self.msgQueue and #self.msgQueue > 0 then
            local freeItem, freeIndex = self:GetOneFreeItem()
            local nextMsg = self:GetNextMsg()
            freeItem:ResetItem()
            freeItem:FadeIn(nextMsg)
            self.displayTime = 0

            local displayingItem = self:GetDisplayingItem()
            if displayingItem then
                displayingItem:FadeOut()
            end
            self.displayingIndex = freeIndex
            self.isReady = false
        else
            if self.displayTime >= self.showEndTime then
                self.ctrl:CloseSelf()
            end
        end
    end
end

local function GetNextMsg(self)
    while(true) do
        if self.msgQueue and #self.msgQueue > 0 then
            local msg = self.msgQueue[1]
            table.remove(self.msgQueue, 1)
            if msg then
                return msg
            end
        end
    end
end

local function TimerAction(self)
    if self.displayTime == nil then
        return
    end
    self.isReady = true
    self.displayTime = self.displayTime + timeBeforeFadeOut
    self:TryDisplayNext()
end

local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

--临时只有两个，可扩展支持同时显示多个
local function GetOneFreeItem(self)
    if self.displayingIndex ~= 1 then
        return self.messageItems[1], 1
    else
        return self.messageItems[2], 2
    end
end

local function GetDisplayingItem(self)
    if self.displayingIndex ~= 0 then
        return self.messageItems[self.displayingIndex]
    else
        return nil
    end
end


UICommonMessageSpecialBarView.OnCreate = OnCreate
UICommonMessageSpecialBarView.OnDestroy = OnDestroy
UICommonMessageSpecialBarView.OnEnable = OnEnable
UICommonMessageSpecialBarView.OnDisable = OnDisable
UICommonMessageSpecialBarView.AddNewMsg =AddNewMsg
UICommonMessageSpecialBarView.TryDisplayNext =TryDisplayNext
UICommonMessageSpecialBarView.DeleteTimer =DeleteTimer
UICommonMessageSpecialBarView.GetNextMsg =GetNextMsg
UICommonMessageSpecialBarView.TimerAction =TimerAction
UICommonMessageSpecialBarView.GetOneFreeItem =GetOneFreeItem
UICommonMessageSpecialBarView.GetDisplayingItem =GetDisplayingItem
UICommonMessageSpecialBarView.AddNewMsg_Msg =AddNewMsg_Msg
return UICommonMessageSpecialBarView