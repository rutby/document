---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2022/3/22 12:03
--- DigActivityRankItem.lua

local DigActivityRankItem = BaseClass("DigActivityRankItem",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UIGolloesCardsRPCell = require "UI.UIActivityCenterTable.Component.GolloesCards.UIGolloesCardsRPCell"

local rank_path = "rankNum"
local rankImg_path = "firstImg"
local playerHead_path = "UIPlayerHead/HeadIcon"
local playerHeadFg_path = ""
local playerHeadBtn_path = "UIPlayerHead"
local name_path = "nameLayout/firstNameTxt"
local alName_path = "nameLayout/secondNameTxt"
local score_path = "score"
local scoreTxt_path = "scoreTxt"
local scrollView_path = "scrollView_Reward"
local content_path = "scrollView_Reward/Viewport/Content"

-- 创建 
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.rankN = self:AddComponent(UIText, rank_path)
    self.rankImgN = self:AddComponent(UIImage, rankImg_path)
    self.playerHeadN = self:AddComponent(UIPlayerHead, playerHead_path)
    self.playerHeadFgN = self:AddComponent(UIImage, playerHeadFg_path)
    self.playerHeadBtnN = self:AddComponent(UIButton, playerHeadBtn_path)
    self.playerHeadBtnN:SetOnClick(function()
        self:OnClickPlayerHeadBtn()
    end)
    self.nameN = self:AddComponent(UIText, name_path)
    self.alNameN = self:AddComponent(UIText, alName_path)
    self.scoreN = self:AddComponent(UIText, score_path)
    self.scoreTxtN = self:AddComponent(UIText, scoreTxt_path)
    self.scoreTxtN:SetLocalText(302042)
    self.scrollViewN = self:AddComponent(UIScrollView, scrollView_path)
    self.scrollViewN:SetOnItemMoveIn(function(itemObj, index)
        self:OnCreateCell(itemObj, index)
    end)
    self.scrollViewN:SetOnItemMoveOut(function(itemObj, index)
        self:OnDeleteCell(itemObj, index)
    end)
    self.contentN = self:AddComponent(UIBaseContainer, content_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.rankN = nil
    self.rankImgN = nil
    self.playerHeadN = nil
    self.playerHeadBtnN = nil
    self.nameN = nil
    self.alNameN = nil
    self.scoreN = nil
    self.scoreTxtN = nil
    self.scrollViewN = nil
    self.contentN = nil
end

--变量的定义
local function DataDefine(self)
    self.rankInfo = nil
end

--变量的销毁
local function DataDestroy(self)
    self.rankInfo = nil
end


local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    --self:RemoveUIListener(EventId.OnUpdateAlLeaderCandidates, self.OnCandidateInfoUpdated)
end

local function SetData(self, rankInfo, isSelf)
    self.rankInfo = rankInfo

    if self.rankInfo.rank <= 0 then
        self.rankN:SetActive(true)
        self.rankN:SetText("-")
        self.rankImgN:SetActive(false)
    elseif self.rankInfo.rank <= 3 then
        self.rankN:SetActive(false)
        self.rankImgN:SetActive(true)
        self.rankImgN:LoadSprite("Assets/Main/Sprites/UI/UIAlliance/rank/UIalliance_rankingbg0" .. self.rankInfo.rank)
    else
        self.rankN:SetActive(true)
        self.rankImgN:SetActive(false)
        self.rankN:SetText(self.rankInfo.rank)
    end
    
    self.playerHeadN:SetData(self.rankInfo.uid, self.rankInfo.pic, self.rankInfo.picVer)

    local headBgImg = ""
    if self.rankInfo == LuaEntry.Player.uid then
        headBgImg = DataCenter.DecorationDataManager:GetSelfHeadFrame()
    else
        headBgImg = DataCenter.DecorationDataManager:GetHeadFrame(self.rankInfo.headSkinId, self.rankInfo.headSkinET)
    end
    self.playerHeadFgN:LoadSprite(headBgImg)
    
    local name = self.rankInfo.name
    if not isSelf and self.rankInfo.serverId and self.rankInfo.serverId ~= 0 then
        name = Localization:GetString('372761',self.rankInfo.serverId,self.rankInfo.name)
    end
    self.nameN:SetText(name)
    if string.IsNullOrEmpty(self.rankInfo.alliancename) then
        self.alNameN:SetActive(false)
    else
        self.alNameN:SetActive(true)
        self.alNameN:SetText("[" .. self.rankInfo.abbr .. "] " .. self.rankInfo.alliancename)
    end
    self.scoreN:SetText(self.rankInfo.score)

    if self.rankInfo.reward then
        self.scrollViewN:SetTotalCount(#self.rankInfo.reward)
        self.scrollViewN:RefillCells()
    end
end

local function OnCreateCell(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scrollViewN:AddComponent(UIGolloesCardsRPCell, itemObj)
    local data = self.rankInfo.reward[index]
    cellItem:SetData(data)
end

local function OnDeleteCell(self,itemObj, index)
    self.scrollViewN:RemoveComponent(itemObj.name, UIGolloesCardsRPCell)
end

local function ClearScroll(self)
    self.scrollViewN:ClearCells()
    self.scrollViewN:RemoveComponents(UIGolloesCardsRPCell)
end


local function OnClickPlayerHeadBtn(self)
    if self.rankInfo.uid ~= LuaEntry.Player.uid then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIOtherPlayerInfo, self.rankInfo.uid)
    end
end



DigActivityRankItem.OnCreate = OnCreate
DigActivityRankItem.OnDestroy = OnDestroy
DigActivityRankItem.OnEnable = OnEnable
DigActivityRankItem.OnDisable = OnDisable
DigActivityRankItem.ComponentDefine = ComponentDefine
DigActivityRankItem.ComponentDestroy = ComponentDestroy
DigActivityRankItem.DataDefine = DataDefine
DigActivityRankItem.DataDestroy = DataDestroy
DigActivityRankItem.OnAddListener = OnAddListener
DigActivityRankItem.OnRemoveListener = OnRemoveListener

DigActivityRankItem.SetData = SetData
DigActivityRankItem.OnCreateCell = OnCreateCell
DigActivityRankItem.OnDeleteCell = OnDeleteCell
DigActivityRankItem.ClearScroll = ClearScroll
DigActivityRankItem.OnClickPlayerHeadBtn = OnClickPlayerHeadBtn


return DigActivityRankItem