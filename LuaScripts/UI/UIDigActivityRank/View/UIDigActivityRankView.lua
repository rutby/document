---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
--- UIDigActivityRankView.lua

local base = UIBaseView--Variable
local UIDigActivityRankView = BaseClass("UIDigActivityRankView", base)--Variable
local Localization = CS.GameEntry.Localization
local DigActivityRankItem = require "UI.UIDigActivityRank.Component.DigActivityRankItem"

local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local headName_path = "ImgBg/Rect_Rank/head/headName"
local headScore_path = "ImgBg/Rect_Rank/head/headScore"
local headReward_path = "ImgBg/Rect_Rank/head/headReward"
local selfRankItem_path = "ImgBg/Rect_Rank/selfRankItem"
local scrollView_path = "ImgBg/Rect_Rank/ScrollView"
local content_path = "ImgBg/Rect_Rank/ScrollView/Viewport/Content"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
    self:InitData()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UIText, title_path)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.headNameN = self:AddComponent(UIText, headName_path)
    self.headNameN:SetLocalText(302129)
    self.headScoreN = self:AddComponent(UIText, headScore_path)
    self.headScoreN:SetLocalText(372773)
    self.headRewardN = self:AddComponent(UIText, headReward_path)
    self.headRewardN:SetLocalText(302026)
    self.selfRankItemN = self:AddComponent(DigActivityRankItem, selfRankItem_path)
    self.scrollViewN = self:AddComponent(UIScrollView, scrollView_path)
    self.scrollViewN:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.scrollViewN:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    self.contentN = self:AddComponent(UIBaseContainer, content_path)
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.closeBtnN = nil
    self.headNameN = nil
    self.headScoreN = nil
    self.headRewardN = nil
    self.selfRankItemN = nil
    self.scrollViewN = nil
    self.contentN = nil
end

local function DataDefine(self)
    self.activityId = nil
end

local function DataDestroy(self)
    self.activityId = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnDigActivityRankInfoUpdate, self.RefreshAll)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnDigActivityRankInfoUpdate, self.RefreshAll)
end

local function InitData(self)
    local id, strServer = self:GetUserData()
    self.activityId = id

    DataCenter.DigActivityManager:GetDigRankReq(self.activityId)

    if string.IsNullOrEmpty(strServer) then
        self.titleN:SetLocalText(390040)
    else
        self.titleN:SetLocalText(372614, strServer)
    end
    
    self:RefreshAll()
end

local function RefreshAll(self)
    self.rankInfo = DataCenter.DigActivityManager:GetDigRankInfo(self.activityId)
    if not self.rankInfo then
        return
    end
    
    local selfRankInfo = DataCenter.DigActivityManager:GetSelfRank(self.activityId)
    self.selfRankItemN:SetData(selfRankInfo, true)
    
    self.rankList = DataCenter.DigActivityManager:GetRankList(self.activityId)
    if #self.rankList > 0 then
        self.scrollViewN:SetTotalCount(#self.rankList)
        self.scrollViewN:RefillCells()
    end
end

local function OnItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scrollViewN:AddComponent(DigActivityRankItem, itemObj)
    cellItem:SetData(self.rankList[index], false)
end

local function OnItemMoveOut(self, itemObj, index)
    self.scrollViewN:RemoveComponent(itemObj.name, DigActivityRankItem)
end

local function ClearScroll(self)
    self.scrollViewN:ClearCells()
    self.scrollViewN:RemoveComponents(DigActivityRankItem)
end

local function OnClickCloseBtn(self)
    self.ctrl:CloseSelf()
end

UIDigActivityRankView.OnCreate = OnCreate
UIDigActivityRankView.OnDestroy = OnDestroy
UIDigActivityRankView.OnAddListener = OnAddListener
UIDigActivityRankView.OnRemoveListener = OnRemoveListener
UIDigActivityRankView.ComponentDefine = ComponentDefine
UIDigActivityRankView.ComponentDestroy = ComponentDestroy
UIDigActivityRankView.DataDefine = DataDefine
UIDigActivityRankView.DataDestroy = DataDestroy

UIDigActivityRankView.InitData = InitData
UIDigActivityRankView.RefreshAll = RefreshAll
UIDigActivityRankView.OnItemMoveIn = OnItemMoveIn
UIDigActivityRankView.OnItemMoveOut = OnItemMoveOut
UIDigActivityRankView.ClearScroll = ClearScroll
UIDigActivityRankView.OnClickCloseBtn = OnClickCloseBtn

return UIDigActivityRankView