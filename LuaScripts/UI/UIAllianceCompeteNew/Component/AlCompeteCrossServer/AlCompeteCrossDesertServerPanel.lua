---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/2/16 19:51
---
local base = UIBaseView--Variable
local AlCompeteCrossDesertServerPanel = BaseClass("AlCompeteCrossDesertServerPanel", base)--Variable
local Localization = CS.GameEntry.Localization
local AllianceFlagItem = require "UI.UIAlliance.UIAllianceFlag.Component.AllianceFlagItem"
local AllianceFlag = require "UI.UIAllianceCompeteNew.Component.AlCompeteCrossServer.AllianceFlag"
local title_path = "startGo/middleGo/titleTxt"
local subTitle_path = "startGo/middleGo/desTxt"
local actTime_path = "startGo/middleGo/timeTxt"
local cdTip_path = "startGo/middleGo/timeTxt/cdTip"
local cdTime_path = "startGo/middleGo/timeTxt/cdTxt"
local allianceFlagL_path = "startGo/redGo/redAllianceIcon/AllianceFlagRed"
local allianceFlagR_path = "startGo/blueGo/blueAllianceIcon/AllianceFlagBlue"
local alNameL_path = "startGo/redGo/redAllianceGo/redAllianceNameTxt"
local alNameR_path = "startGo/blueGo/blueAllianceGo/blueAllianceNameTxt"
local attackBtn_path = "startGo/attackBtn"
local attackBtnTxt_path = "startGo/attackBtn/attackTxt"
local attackTip_path = "startGo/attackTip"
local allianceFlag_path = "startGo/allianceFlag"

local infoBtn_path = "startGo/middleGo/titleTxt/infoBtn"                                                                                                                           

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DelTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    if SeasonUtil.IsInSeasonDesertMode() then
        self.titleN:SetText(Localization:GetString("110559"))
    else
        self.titleN:SetText(Localization:GetString("110214"))
    end

    self.subTitleN = self:AddComponent(UIText, subTitle_path)
    if SeasonUtil.IsInSeasonDesertMode() then
        self.subTitleN:SetText(Localization:GetString("110560"))
    else
        self.subTitleN:SetText(Localization:GetString("372418"))
    end
    self.actTimeN = self:AddComponent(UIBaseContainer, actTime_path)
    self.cdTipN = self:AddComponent(UITextMeshProUGUIEx, cdTip_path)
    self.cdTimeN = self:AddComponent(UITextMeshProUGUIEx, cdTime_path)
    self.allianceFlagLN = self:AddComponent(AllianceFlagItem, allianceFlagL_path)
    self.allianceFlagRN = self:AddComponent(AllianceFlagItem, allianceFlagR_path)
    self.alNameLN = self:AddComponent(UITextMeshProUGUIEx, alNameL_path)
    self.alNameRN = self:AddComponent(UITextMeshProUGUIEx, alNameR_path)
    self.attackBtnN = self:AddComponent(UIButton, attackBtn_path)
    self.attackBtnN:SetOnClick(function()
        self:OnClickAttackBtn()
    end)
    self.attackBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, attackBtnTxt_path)
    self.attackBtnTxtN:SetLocalText(100150)
    self.attackTipN = self:AddComponent(UITextMeshProUGUIEx, attackTip_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.allianceFlagObj = self:AddComponent(AllianceFlag,allianceFlag_path)
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.subTitleN = nil
    self.cdTipN = nil
    self.cdTimeN = nil
    self.allianceFlagLN = nil
    self.allianceFlagRN = nil
    self.alNameLN = nil
    self.alNameRN = nil
    self.attackBtnN = nil
    self.attackBtnTxtN = nil
    self.attackTipN = nil
    self.infoBtnN = nil
end

local function DataDefine(self)
    self.activityInfo = nil
    self.eventInfo = nil
    self.isCrossServerOpen = nil
    self.curStatus = nil
end

local function DataDestroy(self)
    self.activityInfo = nil
    self.eventInfo = nil
    self.isCrossServerOpen = nil
    self.curStatus = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    --self:AddUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
end

local function OnRemoveListener(self)
    --self:RemoveUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function ShowPanel(self)
    self.activityInfo = DataCenter.ActivityListDataManager:GetActivityDataById(EnumActivity.AllianceCompete.ActId)
    if not self.activityInfo then
        return
    end
    self.eventInfo = self.activityInfo:GetEventInfo()
    if not self.eventInfo then
        return
    end
    self:RefreshAll()
end

local function RefreshAll(self)
    self:SetTimeTip()

    local myAllianceId = LuaEntry.Player.allianceId
    local allianceList = self.eventInfo.vsAllianceList
    table.walk(allianceList , function(k,v)
        local name = string.format("#%s [%s] %s" , v.serverId, v.abbr,v.alName)
        if k == myAllianceId then
            self.alNameLN:SetText(name)
            self.allianceFlagLN:SetData(v.icon)
        else
            self.alNameRN:SetText(name)
            self.allianceFlagRN:SetData(v.icon)
            self.attackTipN:SetText(Localization:GetString("372419", v.serverId, v.abbr))
        end
    end)
end

local function SetTimeTip(self)
    local _, startT, endT = self.eventInfo:CheckIfShowCrossDesert()
    local serverTime = UITimeManager:GetInstance():GetServerTime()
    if serverTime < startT then
        --self.actTimeN:SetActive(true)
        self.cdTipN:SetText(Localization:GetString("372114"))
        self.endTime = startT
        self.cdTimeN:SetActive(true)
        self:AddTimer()
        CS.UIGray.SetGray(self.attackBtnN.transform, true, true)

        self.isCrossServerOpen = false
        self.curStatus = 1
    elseif serverTime < endT then
        --self.actTimeN:SetActive(true)
        self.cdTipN:SetText(Localization:GetString("372420"))
        self.endTime = endT
        self.cdTimeN:SetActive(true)
        self:AddTimer()
        CS.UIGray.SetGray(self.attackBtnN.transform, false, true)
        self.isCrossServerOpen = true
        self.curStatus = 2
    else
        --self.actTimeN:SetActive(false)
        self.endTime = nil
        self.cdTipN:SetText(Localization:GetString("370100"))
        self.cdTimeN:SetActive(false)
        self:DelTimer()
        CS.UIGray.SetGray(self.attackBtnN.transform, true, true)
        self.isCrossServerOpen = false
        self.curStatus = 3
    end
end

local function AddTimer(self)
    self.TimerAction = function()
        self:SetRemainTime()
    end

    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.TimerAction , self, false,false,false)
    end
    self.timer:Start()
    self:SetRemainTime()
end

local function SetRemainTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    if self.endTime then
        local remainT = self.endTime - curTime
        if remainT > 0 then
            self.cdTimeN:SetText(UITimeManager:GetInstance():MilliSecondToFmtString(remainT))
        else
            self:DelTimer()
            self:SetTimeTip()
        end
    else
        self:SetTimeTip()
    end
end

local function DelTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function OnClickAttackBtn(self)
    if self.curStatus == 2 then
        if CrossServerUtil.GetCrossServerIsInSameSeason() == false then
            UIUtil.ShowTips(Localization:GetString("372604"))
        else
            local fightServerId = DataCenter.AllianceCompeteDataManager:GetFightServerId()
            if fightServerId>0 then
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIAlCompeteTips,fightServerId,2)
            end
        end
    elseif self.curStatus == 1 then
        UIUtil.ShowTips(Localization:GetString("E100172"))
    elseif self.curStatus == 3 then
        UIUtil.ShowTips(Localization:GetString("370100"))
    end
end

local function OnClickInfoBtn(self)
    UIUtil.ShowIntro(Localization:GetString("110214"), Localization:GetString("110223"), Localization:GetString("110550"))
end

AlCompeteCrossDesertServerPanel.OnCreate = OnCreate
AlCompeteCrossDesertServerPanel.OnDestroy = OnDestroy
AlCompeteCrossDesertServerPanel.OnAddListener = OnAddListener
AlCompeteCrossDesertServerPanel.OnRemoveListener = OnRemoveListener
AlCompeteCrossDesertServerPanel.ComponentDefine = ComponentDefine
AlCompeteCrossDesertServerPanel.ComponentDestroy = ComponentDestroy
AlCompeteCrossDesertServerPanel.DataDefine = DataDefine
AlCompeteCrossDesertServerPanel.DataDestroy = DataDestroy

AlCompeteCrossDesertServerPanel.ShowPanel = ShowPanel
AlCompeteCrossDesertServerPanel.RefreshAll = RefreshAll
AlCompeteCrossDesertServerPanel.SetTimeTip = SetTimeTip
AlCompeteCrossDesertServerPanel.AddTimer = AddTimer
AlCompeteCrossDesertServerPanel.SetRemainTime = SetRemainTime
AlCompeteCrossDesertServerPanel.DelTimer = DelTimer
AlCompeteCrossDesertServerPanel.OnClickAttackBtn = OnClickAttackBtn
AlCompeteCrossDesertServerPanel.OnClickInfoBtn = OnClickInfoBtn


return AlCompeteCrossDesertServerPanel