---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/2/14 22:05
---
local AllianceFlag = BaseClass("AllianceFlag", UIBaseContainer)
local base = UIBaseContainer
local btn_path ="flagObj"
local txt_path = "flagObj/flagBg/flagName"
local des_txt_path = "flagObj/desTxt"
local num_tip_path = "flagObj/numTip"
local Localization = CS.GameEntry.Localization
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:DeleteTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
    self:RefreshData()
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.btn = self:AddComponent(UIBaseContainer, btn_path)
    --self.btn:SetOnClick(function()
    --    self:OnClick()
    --end)
    self.txt = self:AddComponent(UIText, txt_path)
    self.timer_action = function(temp)
        self:RefreshTime()
    end
    self.desTxt = self:AddComponent(UIText, des_txt_path)
    self.num_tip = self:AddComponent(UIText, num_tip_path)
    self.isInProtectTime = false
    self.isInMaxTime = false
end

local function ComponentDestroy(self)
    self.btn = nil
end

local function DataDefine(self)
end
local function DataDestroy(self)
end

local function RefreshData(self)
    self.fightServerId = DataCenter.AllianceCompeteDataManager:GetFightServerId()
    if  SeasonUtil.IsInSeasonDesertMode() then
        local placeTime = DataCenter.AllianceMineManager:GetAllianceFlagPlaceTime()
        local totalTime = LuaEntry.DataConfig:TryGetNum("allance_build", "k7")
        local restTime = totalTime-placeTime
        if restTime<=0 then
            restTime =0
        end
        local timeStr = Localization:GetString("110538")..": "..restTime.."/"..totalTime
        self.num_tip:SetText(timeStr)
        local flagData = DataCenter.AllianceMineManager:GetAllianceFlagData()
        self.btn:SetActive(true)
        self.isInProtectTime = false
        self.isInMaxTime = false
        if flagData == nil then
            local isInAct = false
            local actInfo = DataCenter.ActivityListDataManager:GetActivityDataById(EnumActivity.AllianceCompete.ActId)
            if actInfo then
                local eventInfo = actInfo:GetEventInfo()
                if eventInfo and eventInfo:CheckIfShowCrossDesert() then
                    isInAct = true
                end
            end
            local isR4orR5 = DataCenter.AllianceBaseDataManager:IsR4orR5()
            if isInAct and isR4orR5 ==false then
                self.desTxt:SetLocalText(110595)
            else
                self.desTxt:SetLocalText(110537)
            end
            self.txt:SetLocalText(110536)
            self.txt:SetColorRGBA(1, 0.89, 0.79, 1)
            if restTime<=0 then
                self.isInMaxTime = true
            else
                self.endTime = 0
                local curTime = UITimeManager:GetInstance():GetServerTime()
                local foldStartTime = DataCenter.AllianceMineManager:GetAllianceFlagDestroyTime()
                local k6 = LuaEntry.DataConfig:TryGetNum("allance_build", "k6")
                self.endTime = k6*1000+foldStartTime
                if curTime< self.endTime then
                    self.isInProtectTime = true
                    self:RefreshTime()
                    self:AddTimer()
                else
                    self.isInProtectTime = false
                    self.endTime = 0
                    if isInAct then
                        if isR4orR5 then
                            self.txt:SetLocalText(110600)
                            self.txt:SetColor(WorldGreenColor)
                        else
                            self.txt:SetLocalText(110599)
                            self.txt:SetColor(WorldRedColor)
                        end
                        
                    else
                        self.txt:SetLocalText(110536)
                        self.txt:SetColorRGBA(1, 0.89, 0.79, 1)
                    end
                    
                    self:DeleteTimer()
                end
            end
        else
            self.desTxt:SetLocalText(110596)
            self.txt:SetLocalText(110539)
            self.txt:SetColorRGBA(1, 0.89, 0.79, 1)
        end

    else
        self.btn:SetActive(false)
        self:DeleteTimer()
    end
end
local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.AllianceFlagUpdate, self.RefreshData)

end
local function AddTimer(self)
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(1, self.timer_action , self, false,false,false)
    end
    self.timer:Start()
end
local function DeleteTimer(self)
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

local function RefreshTime(self)
    if self.isInProtectTime == true then
        local curTime = UITimeManager:GetInstance():GetServerTime()
        if curTime< self.endTime then
            local leftTime = self.endTime - curTime
            local leftTimeStr = UITimeManager:GetInstance():MilliSecondToFmtString(leftTime)
            self.txt:SetText(leftTimeStr)
        else
            self.isInProtectTime = false
            self:RefreshData()
        end
    end
end
local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.AllianceFlagUpdate, self.RefreshData)
    base.OnRemoveListener(self)
end


AllianceFlag.OnCreate =OnCreate
AllianceFlag.OnDestroy =OnDestroy
AllianceFlag.OnEnable =OnEnable
AllianceFlag.OnDisable =OnDisable
AllianceFlag.ComponentDefine =ComponentDefine
AllianceFlag.ComponentDestroy =ComponentDestroy
AllianceFlag.DataDefine =DataDefine
AllianceFlag.DataDestroy =DataDestroy
AllianceFlag.RefreshData =RefreshData
AllianceFlag.OnAddListener = OnAddListener
AllianceFlag.OnRemoveListener = OnRemoveListener
AllianceFlag.RefreshTime = RefreshTime
AllianceFlag.AddTimer = AddTimer
AllianceFlag.DeleteTimer =DeleteTimer
return AllianceFlag