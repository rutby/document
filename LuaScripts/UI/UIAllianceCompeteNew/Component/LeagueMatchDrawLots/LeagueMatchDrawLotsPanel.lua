---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/2/27 16:07
-- LeagueMatchDrawLotsPanel.lua

local base = UIBaseView--Variable
local Tb = BaseClass("LeagueMatchDrawLotsPanel", base)--Variable
local Localization = CS.GameEntry.Localization
local LeagueMatchDrawLotsItem = require "UI.UIAllianceCompeteNew.Component.LeagueMatchDrawLots.LeagueMatchDrawLotsItem"

--local title_path = "main/Title/titleTxt"
--local subTitle_path = "main/Title/desTxt"
local groupName_path = "main/Title/groupName"
local scrollView_path = "main/ScrollView"
local content_path = "main/ScrollView/Viewport/Content"
local drawLotsBtn_path = "main/drawLotsBtn"
local drawLotsBtnTxt_path = "main/drawLotsBtn/drawLotsBtnTxt"
local infoBtn_path = "rightLayer/infoBtn"
local allianceBtn_path = "rightLayer/allianceBtn"
local allianceBtnTxt_path = "rightLayer/allianceBtn/allianceBtnTxt"
local rewardBtn_path = "rightLayer/rewardBtn"
local rewardBtnTxt_path = "rightLayer/rewardBtn/rewardBtnTxt"
local endTime_path = "main/timeTxt"
local startTime_path = "main/startTxt"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DelCountDownTimer()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    --self.titleN = self:AddComponent(UIText, title_path)
    --self.titleN:SetLocalText("")
    --self.subTitleN = self:AddComponent(UIText, subTitle_path)
    --self.subTitleN:SetLocalText("")
    self.groupNameN = self:AddComponent(UITextMeshProUGUIEx, groupName_path)
    self.infoBtnN = self:AddComponent(UIButton, infoBtn_path)
    self.infoBtnN:SetOnClick(function()
        self:OnClickInfoBtn()
    end)
    self.allianceBtnN = self:AddComponent(UIButton, allianceBtn_path)
    self.allianceBtnN:SetOnClick(function()
        self:OnClickAllianceBtn()
    end)
    self.allianceBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, allianceBtnTxt_path)
    self.allianceBtnTxtN:SetLocalText(390796)
    self.rewardBtnN = self:AddComponent(UIButton, rewardBtn_path)
    self.rewardBtnN:SetOnClick(function()
        self:OnClickRewardBtn()
    end)
    self.rewardBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, rewardBtnTxt_path)
    self.rewardBtnTxtN:SetLocalText(130065)
    self.endTimeN = self:AddComponent(UITextMeshProUGUIEx, endTime_path)
    self.startTimeN = self:AddComponent(UITextMeshProUGUIEx, startTime_path)

    self.scrollViewN = self:AddComponent(UIScrollView, scrollView_path)
    self.scrollViewN:SetOnItemMoveIn(function(itemObj, index)
        self:OnItemMoveIn(itemObj, index)
    end)
    self.scrollViewN:SetOnItemMoveOut(function(itemObj, index)
        self:OnItemMoveOut(itemObj, index)
    end)
    self.contentN = self:AddComponent(UIBaseContainer, content_path)
    self.drawLotsBtnN = self:AddComponent(UIButton, drawLotsBtn_path)
    self.drawLotsBtnN:SetOnClick(function()
        self:OnClickDrawLotsBtn()
    end)
    self.drawLotsBtnTxtN = self:AddComponent(UITextMeshProUGUIEx, drawLotsBtnTxt_path)
    self.drawLotsBtnTxtN:SetLocalText("372623")
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.subTitleN = nil
    self.infoBtnN = nil
    self.allianceBtnN = nil
    self.allianceBtnTxtN = nil
    self.rewardBtnN = nil
    self.rewardBtnTxtN = nil
    self.scrollViewN = nil
    self.contentN = nil
    self.drawLotsBtnN = nil
    self.drawLotsBtnTxtN = nil
end

local function DataDefine(self)
    self.myMatchInfo = nil
    self.allianceInfoDic = {}
    self.groupItemTb = {}
end

local function DataDestroy(self)
    self.myMatchInfo = nil
    self.allianceInfoDic = nil
    self.groupItemTb = nil
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnLeagueMatchGroupUpdate, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.OnLeagueMatchGroupUpdate, self.RefreshAll)
    base.OnRemoveListener(self)
end

local function ShowPanel(self)
    DataCenter.LeagueMatchManager:GetCurSeasonGroupReq()
    self:RefreshAll()
end

local function RefreshAll(self)
    if IsNull(self.gameObject) then
        return
    end

    self.baseInfo = DataCenter.LeagueMatchManager:GetLeagueMatchBaseInfo()
    self.myMatchInfo = DataCenter.LeagueMatchManager:GetMyMatchInfo()
    self.allianceInfoDic = DataCenter.LeagueMatchManager:GetDrawLotsGroupDic()

    if not self.myMatchInfo or not self.myMatchInfo.duelInfo or not self.allianceInfoDic or not self.baseInfo then
        return
    end
    
    local duelInfo = self.myMatchInfo.duelInfo
    local groupType = ""
    if duelInfo.rankType == SegmentType.Silver then
        groupType = Localization:GetString("372611")
    elseif duelInfo.rankType == SegmentType.Gold then
        groupType = Localization:GetString("372612")
    elseif duelInfo.rankType == SegmentType.Diamond then
        groupType = Localization:GetString("372613")
    end

    local strArr = string.split(duelInfo.group, "_")
    local groupName = Localization:GetString("372629") .. groupType .. " " .. strArr[1] .. "-" .. strArr[3]
    self.groupNameN:SetText(groupName)

    if duelInfo.position == 0 then
        CS.UIGray.SetGray(self.drawLotsBtnN.transform, false, true)

    else
        CS.UIGray.SetGray(self.drawLotsBtnN.transform, true, false)
    end

    self.scrollViewN:SetTotalCount(LeagueMatchGroupAllianceCount / 2)
    self.scrollViewN:RefillCells()
    
    self:ShowCountDown()
    --self:AddCountDownTimer()
    --self:RefreshRemainTime()
end


local function OnItemMoveIn(self,itemObj, index)
    itemObj.name = tostring(index)
    local cellItem = self.scrollViewN:AddComponent(LeagueMatchDrawLotsItem, itemObj)
    local positionR = index * 2
    local positionL = positionR - 1
    cellItem:SetItem(positionL, positionR, self.allianceInfoDic[positionL], self.allianceInfoDic[positionR])
end

local function OnItemMoveOut(self, itemObj, index)
    self.scrollViewN:RemoveComponent(itemObj.name, LeagueMatchDrawLotsItem)
end

local function ClearScroll(self)
    self.scrollViewN:ClearCells()
    self.scrollViewN:RemoveComponents(LeagueMatchDrawLotsItem)
end

local function ShowCountDown(self)
    self.timerTxtN = nil
    self.endTime = 0

    local tempStage = DataCenter.LeagueMatchManager:GetLeagueMatchStage()
    if tempStage == LeagueMatchStage.DrawLots then
        self.drawLotsBtnN:SetActive(true)
        self.endTimeN:SetActive(true)
        self.startTimeN:SetActive(false)
        self.timerTxtN = self.endTimeN
        self.endTime = self.baseInfo.drawEndTime
        self.strTimeTip = "372625"
    elseif tempStage == LeagueMatchStage.DrawLotsFinished then
        self.drawLotsBtnN:SetActive(false)
        self.endTimeN:SetActive(false)
        self.startTimeN:SetActive(true)
        self.timerTxtN = self.startTimeN
        self.endTime = self.baseInfo.seasonStartTime
        self.strTimeTip = "302011"
    else
        self:DelCountDownTimer()
    end
    if self.timerTxtN then
        self:AddCountDownTimer()
        self:RefreshRemainTime()
    end
end

local function AddCountDownTimer(self)
    self.CountDownTimerAction = function()
        self:RefreshRemainTime()
    end

    if self.countDownTimer == nil then
        self.countDownTimer = TimerManager:GetInstance():GetTimer(1, self.CountDownTimerAction , self, false,false,false)
    end
    self.countDownTimer:Start()
end

local function RefreshRemainTime(self)
    local curTime = UITimeManager:GetInstance():GetServerTime()
    local remainTime = self.endTime - curTime
    if remainTime >= 0 then
        self.timerTxtN:SetText(Localization:GetString(self.strTimeTip, UITimeManager:GetInstance():MilliSecondToFmtString(remainTime)))
    else
        self.timerTxtN:SetText("")
        self:ShowCountDown()
    end
end

local function DelCountDownTimer(self)
    if self.countDownTimer ~= nil then
        self.countDownTimer:Stop()
        self.countDownTimer = nil
    end
end


local function OnClickInfoBtn(self)
    UIUtil.ShowIntro(Localization:GetString("100239"), Localization:GetString("100239")
    , Localization:GetString("372813"))
end

local function OnClickDrawLotsBtn(self)
    if DataCenter.AllianceBaseDataManager:IsSelfLeader() then
        DataCenter.LeagueMatchManager:DrawLotsReq()
    else
        UIUtil.ShowTipsId(372626)
    end
end

local function OnClickAllianceBtn(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UILeagueMatchAlliances)
end

local function OnClickRewardBtn(self)
    local targetTab = 3
    local targetSeg = SegmentType.Silver
    local matchInfo = DataCenter.LeagueMatchManager:GetMyMatchInfo()
    local duelInfo = matchInfo and matchInfo.duelInfo-- DataCenter.LeagueMatchManager:GetMyCurDuelInfo()
    if duelInfo then
        if duelInfo.rankType == SegmentType.Silver then
            targetSeg = SegmentType.Silver
        elseif duelInfo.rankType == SegmentType.Gold then
            targetSeg = SegmentType.Gold
        else
            targetSeg = SegmentType.Diamond
        end
    end
    UIManager:GetInstance():OpenWindow(UIWindowNames.UILeagueMatchReward, { anim = true }, targetTab, targetSeg)
end


Tb.OnCreate = OnCreate
Tb.OnDestroy = OnDestroy
Tb.OnAddListener = OnAddListener
Tb.OnRemoveListener = OnRemoveListener
Tb.ComponentDefine = ComponentDefine
Tb.ComponentDestroy = ComponentDestroy
Tb.DataDefine = DataDefine
Tb.DataDestroy = DataDestroy

Tb.ShowPanel = ShowPanel
Tb.RefreshAll = RefreshAll
Tb.OnItemMoveIn = OnItemMoveIn
Tb.OnItemMoveOut = OnItemMoveOut
Tb.ClearScroll = ClearScroll
Tb.AddCountDownTimer = AddCountDownTimer
Tb.RefreshRemainTime = RefreshRemainTime
Tb.DelCountDownTimer = DelCountDownTimer
Tb.OnClickInfoBtn = OnClickInfoBtn
Tb.OnClickDrawLotsBtn = OnClickDrawLotsBtn
Tb.OnClickAllianceBtn = OnClickAllianceBtn
Tb.OnClickRewardBtn = OnClickRewardBtn
Tb.ShowCountDown = ShowCountDown

return Tb
