---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wsf.
---
---
---@class UIParkour.FormationUI.Component.HeroPVERenderTexture
local HeroPVERenderTexture = BaseClass("HeroPVERenderTexture", UIBaseContainer)
local QualitySettingUtil = require "Util.QualitySettingUtil"
local base = UIBaseContainer
local RenderTextureFormat = CS.UnityEngine.RenderTextureFormat
local RenderTexture = CS.UnityEngine.RenderTexture
HeroPVERenderTexture.openedRef = 0

local function OnCreate(self)
    base.OnCreate(self)
    -- self.rtHeight = 1440
    -- self.rtWidth = 810

    -- self.rawImage = self:AddComponent(UIRawImage, "")

    -- 复制一份主相机
    -- local MainCamera = CS.UnityEngine.Camera.main
    -- self.camera = CS.UnityEngine.GameObject.Instantiate(MainCamera.gameObject)
    -- self.camera.transform.position = MainCamera.transform.position
    -- self.camera.transform.rotation = MainCamera.transform.rotation
    -- self.camera.transform.localScale = MainCamera.transform.localScale
    -- self.cameraComp = self.camera:GetComponent(typeof(CS.UnityEngine.Camera))
    -- self:OnRenderTexture(self.cameraComp)

    self.cameraComp = CS.UnityEngine.Camera.main
end

local function ReleaseCamera(self)
    if not IsNull(self.camera) then
        CS.UnityEngine.GameObject.Destroy(self.camera)
        self.camera = nil
    end
end

local function OnDestroy(self)
    -- self:ReleaseTexture()
    -- ReleaseCamera(self)
    -- self.rawImage = nil
    self.cameraComp = nil
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

---设置renderTexture
local function OnRenderTexture(self, camera)
    if IsNull(camera) then
        Logger.LogError("#zlh# OnRenderTexture camera is nil!")
        return
    end
    --打开毛发renderfeature

    if self.renderTexture == nil then
        local scale = 1
        local qulity = QualitySettingUtil.GetQulity()
        if qulity < 2 then
            scale = 0.8
        end
        local rtWidth = self.rtWidth---math.floor(Screen.width * scale)
        local rtHeight = self.rtHeight--math.floor(Screen.height * scale)
        local rtFormat = RenderTextureFormat.ARGB32
        -- if qulity >= 2 then
        -- if CS.UnityEngine.SystemInfo.SupportsRenderTextureFormat(RenderTextureFormat.ARGB32) then
        --     rtFormat = RenderTextureFormat.ARGB32
        -- else
        --     rtFormat = RenderTextureFormat.DefaultHDR
        -- end
        -- end
        self.renderTexture = RenderTexture.GetTemporary(rtWidth, rtHeight, 24, rtFormat)
        self.renderTexture.name = "BattleEdit"
        --self.renderTexture.autoGenerateMips = false
        self.rawImage:SetTexture(self.renderTexture)
        self.rawImage:SetEnable(true)
        self.rawImage:SetColor(Color.New(1, 1, 1, 1))
    end

    camera.targetTexture = self.renderTexture
end

---释放renderTexture
local function ReleaseTexture(self)
    self.rawImage:SetTexture(nil)

    -- for _, camera in pairs(self.heroCameras) do
    --     if camera ~= nil then
    --         camera.targetTexture = nil
    --     end
    -- end

    if not IsNull(self.cameraComp) then
        self.cameraComp.targetTexture = nil
    end

    if self.renderTexture ~= nil then
        RenderTexture.ReleaseTemporary(self.renderTexture)
        self.renderTexture = nil
    end
end

--- 恢复角色位置
local function ResetPositions(self)
    DataCenter.LWBattleManager:GetCurBattleLogic():ResetHeroPos()
end

--- 移动角色位置
---@param index number
local function MoveHeroSlotPos(self, index, screenPos)
    local ray = self.cameraComp:ScreenPointToRay(Vector3.New(screenPos.x, screenPos.y, 0))
    --print("screenPos.x = "..screenPos.x.." screenPos.y = "..screenPos.y)
    local origin = ray.origin
    local direction = ray.direction
    -- 计算当y等于0时的x和z
    -- origin.y + t * direction.y = 0
    -- t = -origin.y / direction.y
    local t = -origin.y / direction.y
    local x = origin.x + t * direction.x
    local z = origin.z + t * direction.z
    local pos = Vector3.New(x, 0, z)
    DataCenter.LWBattleManager:GetCurBattleLogic():SetHeroPos(index, pos)
end

--- 移动固定槽位到其他槽位为止
local function HeroSlotMoveToIndex(self,index,dstIndex,time)
    DataCenter.LWBattleManager:GetCurBattleLogic():HeroMoveToIndex(index,dstIndex,time)
end

HeroPVERenderTexture.OnCreate = OnCreate
HeroPVERenderTexture.OnDestroy = OnDestroy
HeroPVERenderTexture.OnEnable = OnEnable
HeroPVERenderTexture.OnDisable = OnDisable


HeroPVERenderTexture.OnRenderTexture = OnRenderTexture
HeroPVERenderTexture.ReleaseTexture = ReleaseTexture
HeroPVERenderTexture.ResetPositions = ResetPositions
HeroPVERenderTexture.MoveHeroSlotPos = MoveHeroSlotPos
HeroPVERenderTexture.HeroSlotMoveToIndex = HeroSlotMoveToIndex

return HeroPVERenderTexture
