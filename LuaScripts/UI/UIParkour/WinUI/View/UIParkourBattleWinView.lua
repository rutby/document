---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by w.
--- DateTime: 2022/11/30 13:00
---

local UIParkourBattleWin = BaseClass("UIParkourBattleWin", UIBaseView)
local base = UIBaseView

local UIStatisticList = require "UI.UIParkour.WinUI.Component.UIParkourBattleStatisticHeroList"

function UIParkourBattleWin:OnCreate()
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

function UIParkourBattleWin:OnDestroy()
    if not IsNull(self.tabTween) then
        self.tabTween:Kill()
        self.tabTween = nil
    end
    if self.reqs ~= nil then
        for _, v in pairs(self.reqs) do
            v:Destroy()
        end
        self.reqs = nil
    end

    if self.delayCheck then
        self.delayCheck:Stop()
        self.delayCheck = nil
    end
    base.OnDestroy(self)
end

function UIParkourBattleWin:ComponentDefine()
    self.layout = self:AddComponent(UIBaseContainer, "Layout")
    self.backBtn = self:AddComponent(UIButton, "Layout/BackBtn")
    self.backBtn:SetOnClick(function()
        self:OnBackBtnClick()
    end)

    self.canvasGroup = self.transform:Find("Layout"):GetComponent(typeof(CS.UnityEngine.CanvasGroup))
    self.canvasGroup.alpha = 0

    self.backBtnText = self:AddComponent(UITextMeshProUGUIEx, "Layout/BackBtn/BackBtnText")
    self.victoryText = self:AddComponent(UITextMeshProUGUIEx, "Layout/Title/VictoryGo/VictoryText")

    self.backBtnText:SetLocalText(300520)
    self.victoryText:SetLocalText(376064)

    ----伤害统计----
    self.tabBtns =
    {
        self:AddComponent(UIButton, "Layout/Bg/Tabs/MakeBtn"),
        self:AddComponent(UIButton, "Layout/Bg/Tabs/TakeBtn"),
    }
    for i, tabBtn in ipairs(self.tabBtns) do
        local idx = i
        tabBtn:SetOnClick(function()
            self:OnTabBtnClick(idx)
        end)
    end

    self.tabComps =
    {
        self:AddComponent(UIStatisticList, "Layout/MakeDmgScroll", "makeDmg"),
        self:AddComponent(UIStatisticList, "Layout/TakeDmgScroll", "takeDmg"),
    }
    self.tabIdx = 1

    self.highlightMask = self:AddComponent(UIBaseContainer, "Layout/Bg/Tabs/Highlight/Mask")
    self.highlightInner = self:AddComponent(UIBaseContainer, "Layout/Bg/Tabs/Highlight/Mask/Inner")
    self.highlightMask:SetAnchoredPositionXY(0, -1)
    self.highlightInner:SetAnchoredPositionXY(0, 0)

    self.makeBtnText = self:AddComponent(UITextMeshProUGUIEx, "Layout/Bg/Tabs/MakeBtn/MakeBtnText")
    self.makeBtnText:SetLocalText(321430)
    self.makeBtnHighText = self:AddComponent(UITextMeshProUGUIEx, "Layout/Bg/Tabs/Highlight/Mask/Inner/MakeBtnHigh/MakeBtnHighText")
    self.makeBtnHighText:SetLocalText(321430)
    self.takeBtnText = self:AddComponent(UITextMeshProUGUIEx, "Layout/Bg/Tabs/TakeBtn/TakeBtnText")
    self.takeBtnText:SetLocalText(321431)
    self.takeBtnHighText = self:AddComponent(UITextMeshProUGUIEx, "Layout/Bg/Tabs/Highlight/Mask/Inner/TakeBtnHigh/TakeBtnHighText")
    self.takeBtnHighText:SetLocalText(321431)

    for i, tabCom in ipairs(self.tabComps) do
        tabCom:SetActive(i == self.tabIdx)
    end
end

function UIParkourBattleWin:DataDefine()
    
end

function UIParkourBattleWin:OnEnable()
    base.OnEnable(self)
    self.active = true
    self:ReInit()
end

function UIParkourBattleWin:OnDisable()
    self.active = false
    base.OnDisable(self)
end

function UIParkourBattleWin:OnAddListener()
    base.OnAddListener(self)
    self:AddUIListener(EventId.OnKeyCodeEscape, self.OnKeyCodeEscape)

end

function UIParkourBattleWin:OnRemoveListener()
    self:RemoveUIListener(EventId.OnKeyCodeEscape, self.OnKeyCodeEscape)

    base.OnRemoveListener(self)
end

function UIParkourBattleWin:ReInit()
    DataCenter.LWSoundManager:PlaySound(10024)
    TimerManager:GetInstance():DelayInvoke(function()
        if self.active then
            self.canvasGroup:DOFade(1, 0.2)
            self:ShowStatisticalData()
        end
    end, 1)
end

function UIParkourBattleWin:ShowStatisticalData()
    for i, tabComp in ipairs(self.tabComps) do
        if i == self.tabIdx then
            tabComp:SetActive(true)
            tabComp:RefreshView()
            tabComp:FadeIn()
        else
            tabComp:SetActive(false)
        end
    end
end

function UIParkourBattleWin:OnTabBtnClick(idx)
    if self.tabIdx == idx then
        return
    end

    self.tabIdx = idx
    self:ShowStatisticalData()

    if not IsNull(self.tabTween) then
        self.tabTween:Kill()
        self.tabTween = nil
    end
    self.tabTween = DOTween.To(function()
        return self.highlightMask:GetAnchoredPositionX()
    end, function(value)
        self.highlightMask:SetAnchoredPositionXY(value, -1)
        self.highlightInner:SetAnchoredPositionXY(-value, 0)
    end, (self.tabIdx - 1) * 334, 0.5):SetEase(CS.DG.Tweening.Ease.OutQuint)
end

function UIParkourBattleWin:OnBackBtnClick()
    self.ctrl:CloseSelf()
    DataCenter.LWBattleManager:Exit()
end

function UIParkourBattleWin:OnKeyCodeEscape()
    TimerManager:GetInstance():DelayFrameInvoke(function()
        self:OnBackBtnClick()
    end, 1)
end

return UIParkourBattleWin
