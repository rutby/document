---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/10/25 14:33
---
local UIWorldSiegePointBtn = BaseClass("UIWorldSiegePointBtn", UIBaseContainer)
local base = UIBaseContainer
local Sound = CS.GameEntry.Sound
local Localization = CS.GameEntry.Localization
local ResourceManager = CS.GameEntry.Resource

local this_path = ""
local btn_image_path = "BtnImage"
--local time_obj_path = "BtnImage/Image"
local effect_path = "effect"
local btnNameBg_rect_path = "BtnImage/Rect_BtnNameBg"
local btnName_txt_path = "BtnImage/Rect_BtnNameBg/Txt_BtnName"
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.btn = self:AddComponent(UIButton, btn_image_path)
    self.btnImage = self:AddComponent(UIImage, btn_image_path)
    --self.time_obj = self:AddComponent(UIBaseContainer, time_obj_path)
    --self.time_obj:SetActive(false)
    self.anim = self:AddComponent(UIAnimator, this_path)
    self.btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBtnClick()
    end)

    self._btnNameBg_rect = self:AddComponent(UIBaseContainer,btnNameBg_rect_path)
    self._btnName_txt = self:AddComponent(UITextMeshProUGUIEx,btnName_txt_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.btn = nil
    self.btnImage = nil
    self.time_obj = nil
    self.anim = nil
end

--变量的定义
local function DataDefine(self)
    self.param = nil
end

--变量的销毁
local function DataDestroy(self)
    self.param = nil
end

-- 全部刷新
local function ReInit(self,param)
    self.param = param
    self.btnImage:LoadSprite(string.format(LoadPath.UIBuildBtns, WorldPointBtnTypeImage[param.btnType]))
    self.btnImage.transform.localPosition = param.position

    self:RefreshBtnName()
end

local function RefreshBtnName(self)
    self._btnNameBg_rect:SetActive(false)
    local dialog = nil
    if self.param.btnType == WorldPointBtnType.DeclareWar  then
        dialog = 302812
    elseif self.param.btnType == WorldPointBtnType.AttackCity  then  
        dialog = 100150
    elseif self.param.btnType == WorldPointBtnType.RallyCity or self.param.btnType == WorldPointBtnType.RallyThrone then
        dialog = 104316
    elseif self.param.btnType == WorldPointBtnType.AssistanceCity or self.param.btnType == WorldPointBtnType.RallyAssistanceThrone then
        dialog = 300516
    elseif self.param.btnType == WorldPointBtnType.ScoutCity or self.param.btnType == WorldPointBtnType.ScoutThrone then
        dialog = 121498
    elseif self.param.btnType == WorldPointBtnType.BlackKnight then
        dialog = GameDialogDefine.BLACK_KNIGHT
    elseif self.param.btnType == WorldPointBtnType.DonateSoldier then
        dialog = 372775
    elseif self.param.btnType == WorldPointBtnType.AllianceCityRank then
        dialog = 130065
    end
    if dialog then
        self._btnNameBg_rect:SetActive(true)
        self._btnName_txt:SetLocalText(dialog)
    end
end

local function OnBtnClick(self)
   if self.param.btnType == WorldPointBtnType.AttackCity then
       local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
       if seasonId == 5 then
           if LuaEntry.Player.serverType == ServerType.NORMAL then
               UIUtil.ShowTipsId(111206)
               return
           end
       end
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.ATTACK_CITY)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       
       --检查有无宣战
       local data = DataCenter.AllianceDeclareWarManager:GetSelfDeclareWarData()
       if data then
           --检查是否自己联盟所宣战的
           if self.param.info.cityId ~= tonumber(data.content) then
               return  UIUtil.ShowTipsId(302325)
           else
               local curTime = UITimeManager:GetInstance():GetServerTime()
               if curTime >= tonumber(data.et) then
                   return UIUtil.ShowTipsId(302312)
               end
           end
       else
           return  UIUtil.ShowTipsId(302312)
       end
       
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172)
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           local myAlId = LuaEntry.Player.allianceId
           local myCities = DataCenter.WorldAllianceCityDataManager:GetCitiesByAlId(myAlId)
           local cityMax = LuaEntry.DataConfig:TryGetNum("worldcity_s0", "k12")
           local effectNum = LuaEntry.Effect:GetGameEffect(EffectDefine.ALLIANCE_CITY_MAX_NUM)
           cityMax = cityMax + effectNum
           if table.count(myCities) >= cityMax then
               UIUtil.ShowTipsId(300727)
               return
               
           end
           if DataCenter.WorldAllianceCityDataManager:GetAllianceAlreadyHaveCity(allianceuid)==true then
               if DataCenter.WorldAllianceCityDataManager:GetCityIsNearBySelfAlliance(allianceuid,self.param.info.cityId) ==false then
                   UIUtil.ShowTipsId(300711) 
                   return
               end
           end
           if DataCenter.WorldAllianceCityDataManager:GetCityIsNearByAllianceDesert(allianceuid,self.param.info.cityId) ==false then
               UIUtil.ShowTipsId(110250)
               return
           end
           local targetPoint = self.param.info.pointId
           if self.param.info.eden_city_type == WorldCityType.AlliancePass then
               local tempPId = 0
               local strPos = GetTableData(TableName.WorldCity, self.param.info.cityId, 'location')
               local size = GetTableData(TableName.WorldCity,self.param.info.cityId, "size")
               local tabPos = string.split(strPos, '|')
               if (table.count(tabPos) == 2) then
                   local vec2 = CS.UnityEngine.Vector2Int(tonumber(tabPos[1]), tonumber(tabPos[2]))
                   local rangeList = BuildingUtils.GetBuildRoundPos(vec2,size)
                   for i=1,#rangeList do
                       if tempPId <=0 then
                           local v2 = rangeList[i]
                           local pId = SceneUtils.TilePosToIndex(v2,ForceChangeScene.World)
                           if SeasonUtil.IsDesertOccupy(pId) then
                               tempPId = pId
                               targetPoint = pId
                           end
                       end
                   end
               end
               
           end
           MarchUtil.OnClickStartMarch(MarchTargetType.ATTACK_ALLIANCE_CITY, targetPoint, self.param.info.uuid,-1,0)
       end
    elseif self.param.btnType == WorldPointBtnType.AllianceCityRank then
       UIManager:GetInstance():OpenWindow(UIWindowNames.UIRuinRewardDetail,{anim = true,isBlur = true},self.param.info.level,self.param.info.cityId)
    elseif self.param.btnType == WorldPointBtnType.RallyCity then
       --检查有无宣战
       local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
       if seasonId == 5 then
           if LuaEntry.Player.serverType == ServerType.NORMAL then
               UIUtil.ShowTipsId(111206)
               return
           end
       end
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.RALLY_FOR_ALLIANCE_CITY)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local data = DataCenter.AllianceDeclareWarManager:GetSelfDeclareWarData()
       if data then
           --检查是否自己联盟所宣战的
           if self.param.info.cityId ~= tonumber(data.content) then
               return  UIUtil.ShowTipsId(302325)
           else
               local curTime = UITimeManager:GetInstance():GetServerTime()
               if curTime >= tonumber(data.et) then
                   return UIUtil.ShowTipsId(302312)
               end
           end
       else
           return  UIUtil.ShowTipsId(302312)
       end

       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172)
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           local myAlId = LuaEntry.Player.allianceId
           local myCities = DataCenter.WorldAllianceCityDataManager:GetCitiesByAlId(myAlId)
           local cityMax = LuaEntry.DataConfig:TryGetNum("worldcity_s0", "k12")
           local effectNum = LuaEntry.Effect:GetGameEffect(EffectDefine.ALLIANCE_CITY_MAX_NUM)
           cityMax = cityMax + effectNum
           if table.count(myCities) >= cityMax then
               UIUtil.ShowTipsId(300727)
               return
           elseif DataCenter.WorldAllianceCityDataManager:GetAllianceAlreadyHaveCity(allianceuid)==true then
               if DataCenter.WorldAllianceCityDataManager:GetCityIsNearBySelfAlliance(allianceuid,self.param.info.cityId) ==false then
                   UIUtil.ShowTipsId(300711)
                   return
               end
               if DataCenter.WorldAllianceCityDataManager:GetCityIsNearByAllianceDesert(allianceuid,self.param.info.cityId) ==false then
                   UIUtil.ShowTipsId(110250)
                   return
               end
           else
               if self.param.info.level>1 then
                   UIUtil.ShowTipsId(300710)
                   return
               end
           end
           local selfMarchList = DataCenter.WorldMarchDataManager:GetOwnerMarches(LuaEntry.Player.uid, LuaEntry.Player.allianceId)
           for i, march in pairs(selfMarchList) do
               if (march:GetMarchTargetType() == MarchTargetType.RALLY_FOR_ALLIANCE_CITY) and march.targetUuid == self.param.info.uuid then
                   UIUtil.ShowTipsId(121601)
                   return
               end
           end
           MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_FOR_ALLIANCE_CITY, self.param.info.pointId, self.param.info.uuid,-1,1)
       end
       
    elseif self.param.btnType == WorldPointBtnType.AssistanceCity then
       local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
       if seasonId == 5 then
           if LuaEntry.Player.serverType == ServerType.NORMAL then
               UIUtil.ShowTipsId(111206)
               return
           end
       end
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.ASSISTANCE_ALLIANCE_CITY)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172) 
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationAssistance,NormalBlurPanelAnim,self.param.info.uuid,"",self.param.info.pointId,AssistanceType.AllianceCity)
       end
    elseif self.param.btnType == WorldPointBtnType.ScoutCity then
       local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
       if seasonId == 5 then
           if LuaEntry.Player.serverType == ServerType.NORMAL then
               UIUtil.ShowTipsId(111206)
               return
           end
       end
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.SCOUT_ALLIANCE_CITY)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172) 
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           --检查有无宣战
           local data = DataCenter.AllianceDeclareWarManager:GetSelfDeclareWarData()
           if data then
               --检查是否自己联盟所宣战的
               if self.param.info.cityId ~= tonumber(data.content) then
                   return  UIUtil.ShowTipsId(302325)
               end
           else
               return  UIUtil.ShowTipsId(302312)
           end
           
           local buildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.FUN_BUILD_RADAR_CENTER)
           if not buildData then
               UIUtil.ShowTipsId(300608) 
               self.view.ctrl:CloseSelf()
               return
           end
           if self.param.info.level>1 and DataCenter.WorldAllianceCityDataManager:GetAllianceAlreadyHaveCity(LuaEntry.Player.allianceId)==false then
               UIUtil.ShowTipsId(302013) 
               return
           end
           local needConfirm,status, title , content,needBreakProtect = DataCenter.StatusManager:ShowTipForWarFever()
           if needBreakProtect ==  true then
               local tempUuid = self.param.info.uuid
               local tempPointId = self.param.info.pointId
               UIUtil.ShowMessage(Localization:GetString("120016"), 1, GameDialogDefine.CONFIRM, GameDialogDefine.CANCEL,function()
                   UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationSelectListNew,{ anim = true, UIMainAnim = UIMainAnimType.AllHide }, 2, MarchTargetType.SCOUT_ALLIANCE_CITY, tempPointId,tempUuid)
               end, function()
               end)
           else
               UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationSelectListNew,{ anim = true, UIMainAnim = UIMainAnimType.AllHide }, 2, MarchTargetType.SCOUT_ALLIANCE_CITY,self.param.info.pointId,self.param.info.uuid)
           end
       end
   elseif self.param.btnType == WorldPointBtnType.DeclareWar then
       local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
       if seasonId == 5 then
           if LuaEntry.Player.serverType == ServerType.NORMAL then
               UIUtil.ShowTipsId(111206)
               return
           end
       end
       if DataCenter.AllianceBaseDataManager:IsR4orR5() then
           local data = DataCenter.AllianceDeclareWarManager:GetSelfDeclareWarData()
           if data then
               UIUtil.ShowTipsId(143548)
               return
           end
           local myAlId = LuaEntry.Player.allianceId
           local myCities = DataCenter.WorldAllianceCityDataManager:GetCitiesByAlId(myAlId)
           local cityMax = LuaEntry.DataConfig:TryGetNum("worldcity_s0", "k12")
           local effectNum = LuaEntry.Effect:GetGameEffect(EffectDefine.ALLIANCE_CITY_MAX_NUM)
           cityMax = cityMax + effectNum
           if table.count(myCities) >= cityMax then
               UIUtil.ShowTipsId(300727)
               return
           elseif DataCenter.WorldAllianceCityDataManager:GetAllianceAlreadyHaveCity(LuaEntry.Player.allianceId)==true then
               if DataCenter.WorldAllianceCityDataManager:GetCityIsNearBySelfAlliance(LuaEntry.Player.allianceId,self.param.info.cityId) ==false then
                   if self.param.info.eden_city_type == WorldCityType.StrongHold then
                       UIManager:GetInstance():OpenWindow(UIWindowNames.UIEdenChooseCity, self.param.info.cityId)
                       self.view.ctrl:CloseSelf()
                       return
                   else
                       UIUtil.ShowTipsId(111186)
                       return
                   end
               end
           else
               if self.param.info.eden_city_type == WorldCityType.StrongHold then
                   UIManager:GetInstance():OpenWindow(UIWindowNames.UIEdenChooseCity, self.param.info.cityId)
                   self.view.ctrl:CloseSelf()
                   return
               else
                   if self.param.info.level>1 then
                       UIUtil.ShowTipsId(111185)
                       return
                   end
               end
               
           end
           local param = {}
           param.cityId = self.param.info.cityId
           param.pointId = self.param.info.pointId
           param.uuid = self.param.info.uuid
           DataCenter.AllianceDeclareWarManager:SetWarCityParam(param)
           SFSNetwork.SendMessage(MsgDefines.AllianceGetCityDeclareTimes)
           --UIManager:GetInstance():OpenWindow(UIWindowNames.UIWorldDeclareWar,{ anim = true, UIMainAnim = UIMainAnimType.AllHide },self.param.info.cityId,self.param.info.pointId,self.param.info.uuid)
       else
           UIUtil.ShowTipsId(143604)
       end
   elseif self.param.btnType == WorldPointBtnType.BlackKnight then
       --打开黑骑士简易信息界面
       UIManager:GetInstance():OpenWindow(UIWindowNames.UIBlackKnightInfo, NormalBlurPanelAnim)
   elseif self.param.btnType == WorldPointBtnType.RallyThrone then
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.RALLY_THRONE)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172)
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           if self.data~=nil and self.data.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
               param.content = Localization:GetString("250160")
           end
           local pointId= self.param.info.pointId
           local uuid = self.param.info.uuid
           local show  = Setting:GetPrivateInt("SHOW_ATK_THRONE",0)
           if show<=0 then
               UIUtil.ShowSecondMessage(Localization:GetString("100378"),Localization:GetString("250161"),2,"","", function()
                   MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_THRONE, pointId, uuid,-1,1)
               end, function(needSellConfirm)
                   if needSellConfirm== false then
                       Setting:SetPrivateInt("SHOW_ATK_THRONE",1)
                   else
                       Setting:SetPrivateInt("SHOW_ATK_THRONE",0)
                   end
               end)
           else
               MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_THRONE, pointId, uuid,-1,1)
           end

       end
   elseif self.param.btnType == WorldPointBtnType.RallyAssistanceThrone then
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.RALLY_ASSISTANCE_THRONE)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172)
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAssistanceThrone,self.param.info.uuid,self.param.info.pointId,AssistanceType.AllianceCity)
       end
       --SFSNetwork.SendMessage(MsgDefines.AllianceAssistanceInfo, self.param.info.uuid, AssistanceType.Throne)
       --if not DataCenter.BuildManager:IsExistBuildByTypeLv(BuildingTypes.FUN_BUILD_SMITHY,1) then
       --    GoToUtil.GotoCityByBuildId(BuildingTypes.FUN_BUILD_SMITHY,WorldTileBtnType.City_Upgrade)
       --    local buildList = DataCenter.BuildManager:GetAllBuildingByItemIdWithoutPickUp(BuildingTypes.FUN_BUILD_MAIN)
       --    if buildList~=nil and table.count(buildList) > 0 and buildList[1] ~=nil then
       --        local posEnd = buildList[1].pointId
       --        GoToUtil.GotoPos(SceneUtils.TileIndexToWorld(posEnd), CS.SceneManager.World.InitZoom)
       --    end
       --    return
       --else
       --    local allianceuid = LuaEntry.Player.allianceId
       --    if allianceuid == "" then
       --        UIUtil.ShowTipsId(390172)
       --        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true})
       --    elseif LuaEntry.Effect:GetGameEffect(EffectDefine.APS_ALLIANCE_TEAM_MAX_ARMY) <= 1 then
       --        local building = DataCenter.BuildTemplateManager:GetBuildingDesTemplate(BuildingTypes.FUN_BUILD_SMITHY)
       --        if building~=nil then
       --            local name = Localization:GetString(building.name)
       --            UIUtil.ShowTips(Localization:GetString("390812",name))
       --        end
       --    else
       --        MarchUtil.OnClickStartMarch(MarchTargetType.RALLY_ASSISTANCE_THRONE, self.param.info.pointId, self.param.info.uuid,-1,1)
       --    end
       --end
   elseif self.param.btnType == WorldPointBtnType.ScoutThrone then
       if  SeasonUtil.IsInSeasonDesertMode() and CrossServerUtil:GetIsCrossServer() then
           local state,dialog = CrossServerUtil.CheckCanUseInDeclareWarTarget(MarchTargetType.SCOUT_THRONE)
           if state ==false then
               UIUtil.ShowTipsId(dialog)
               return
           end
       end
       local allianceuid = LuaEntry.Player.allianceId
       if allianceuid == "" then
           UIUtil.ShowTipsId(390172)
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceIntro,{ anim = true,isBlur = true})
       else
           local buildData = DataCenter.BuildManager:GetFunbuildByItemID(BuildingTypes.FUN_BUILD_RADAR_CENTER)
           if not buildData then
               UIUtil.ShowTipsId(300608)
               self.view.ctrl:CloseSelf()
               return
           end
           UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormationSelectListNew,{ anim = true, UIMainAnim = UIMainAnimType.AllHide }, 2, MarchTargetType.SCOUT_THRONE,self.param.info.pointId,self.param.info.uuid)
       end
   elseif self.param.btnType == WorldPointBtnType.DonateSoldier then
        --打开捐兵活动黑骑士信息界面
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIDonateSoldierInfo)
   end
    self.view.ctrl:CloseSelf()
end

local function PlayAnim(self,name)
    self.anim:Play(name,0,0)
end

UIWorldSiegePointBtn.OnCreate = OnCreate
UIWorldSiegePointBtn.OnDestroy = OnDestroy
UIWorldSiegePointBtn.OnEnable = OnEnable
UIWorldSiegePointBtn.OnDisable = OnDisable
UIWorldSiegePointBtn.ComponentDefine = ComponentDefine
UIWorldSiegePointBtn.ComponentDestroy = ComponentDestroy
UIWorldSiegePointBtn.DataDefine = DataDefine
UIWorldSiegePointBtn.DataDestroy = DataDestroy
UIWorldSiegePointBtn.ReInit = ReInit
UIWorldSiegePointBtn.RefreshBtnName = RefreshBtnName
UIWorldSiegePointBtn.OnBtnClick = OnBtnClick
UIWorldSiegePointBtn.PlayAnim = PlayAnim
return UIWorldSiegePointBtn