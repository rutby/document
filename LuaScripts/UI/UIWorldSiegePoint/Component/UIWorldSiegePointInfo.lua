---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2021/10/25 14:34
---
local UIHeroTipView = require "UI.UIHero2.UIHeroTip.View.UIHeroTipView"
local UICommonItem = require "UI.UICommonItem.UICommonItem"
local UIWorldSiegeRewardCell = require "UI.UIWorldSiegePoint.Component.UIWorldSiegeRewardCell"
local WorldSiegeContributePanel = require "UI.UIWorldSiegePoint.Component.WorldSiegeContributePanel"
local UserCell = require "UI.UIWorldSiegePoint.Component.WorldSiegeUserCell"
local UIWorldSiegePointInfo = BaseClass("UIWorldSiegePointInfo", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local main_obj_path = "BuildInfo"
local des_obj_path = "BuildDetails"
local build_des_path = "BuildInfo/middleObj/buildDes"
local rank_obj_path = "BuildInfo/middleObj/rankObj"
local reward_item_path = "BuildInfo/rewardItem"
local city_soldier_des_path = "BuildInfo/middleObj/buildDes/soldierlayout/citySoliderDes"
local btn_alliance_path = "BuildInfo/middleObj/buildDes/soldierlayout/rightLayout/btn_alliance"
local city_alliance_name_path = "BuildInfo/middleObj/buildDes/soldierlayout/rightLayout/NameText"
local layout1_obj_path = "BuildInfo/middleObj/buildDes/layout1"
local city_add_des_path = "BuildInfo/middleObj/buildDes/layout1/cityAddDes"
local city_add_num_path = "BuildInfo/middleObj/buildDes/layout1/cityAddNum"
local city_add_num_des_path = "BuildInfo/middleObj/buildDes/layout1/cityAddNum/cityAddNumDes"
local layout2_obj_path = "BuildInfo/middleObj/buildDes/layout2"
local city_add_des_2_path = "BuildInfo/middleObj/buildDes/layout2/cityAddDes2"
local city_add_num_2_path = "BuildInfo/middleObj/buildDes/layout2/cityAddNum2"
local city_add_num_des_2_path = "BuildInfo/middleObj/buildDes/layout2/cityAddNum2/cityAddNumDes2"
local layout3_obj_path = "BuildInfo/middleObj/buildDes/layout3"
local city_add_des_3_path = "BuildInfo/middleObj/buildDes/layout3/cityAddDes3"
local city_add_num_3_path = "BuildInfo/middleObj/buildDes/layout3/cityAddNum3"
local city_add_num_des_btn_path = "BuildInfo/middleObj/buildDes/layout3/cityAddNumDesBtn3"
local layout4_obj_path = "BuildInfo/middleObj/buildDes/layout4"
local city_add_des_4_path = "BuildInfo/middleObj/buildDes/layout4/cityAddDes4"
local city_add_num_4_path = "BuildInfo/middleObj/buildDes/layout4/cityAddNum4"
local layout5_obj_path = "BuildInfo/middleObj/buildDes/layout5"
local city_add_des_5_path = "BuildInfo/middleObj/buildDes/layout5/cityAddDes5"
local city_add_num_5_path = "BuildInfo/middleObj/buildDes/layout5/cityAddNum5"
local layout6_obj_path = "BuildInfo/middleObj/buildDes/layout6"
local city_add_des_6_path = "BuildInfo/middleObj/buildDes/layout6/cityAddDes6"
local city_add_num_6_path = "BuildInfo/middleObj/buildDes/layout6/cityAddNum6"
local layout7_obj_path = "BuildInfo/middleObj/buildDes/layout7"
local city_add_des_7_path = "BuildInfo/middleObj/buildDes/layout7/cityAddDes7"
local city_add_num_7_path = "BuildInfo/middleObj/buildDes/layout7/cityAddNum7"
local time_obj_path = "BuildInfo/timelayout"
local time_label_path = "BuildInfo/timelayout/timeLabel"
local time_icon_path = "BuildInfo/timelayout/timeLabel/timeIcon"
local reward_txt_path = "BuildInfo/rewardItem/nameLayout/rewardText"
local reward_content_path = "BuildInfo/rewardItem/rewardContent"
local first_occupy_obj_path = "BuildInfo/firstOccupy"
local first_occupy_name_path = "BuildInfo/firstOccupy/allianceName"
local first_occupy_data_path = "BuildInfo/firstOccupy/allianceData"
local rank_detail_path = "BuildInfo/firstOccupy/rankDetailBtn"
local kings_obj_path ="BuildInfo/kingObj"
local kings_btn_path = "BuildInfo/kingObj/Btn_Manage"
local kings_txt_path = "BuildInfo/kingObj/Btn_Manage/manageTxt"
local kings_des_path = "BuildInfo/kingObj/kingName"
local kings_name_path = "BuildInfo/kingObj/kingData"
local tips_obj_path ="BuildInfo/tipslayout"
local tips_txt_path = "BuildInfo/tipslayout/tipsLabel"
local eden_tips_obj_path ="BuildInfo/Edenlayout"
local eden_tips_txt_path = "BuildInfo/Edenlayout/edenLabel"
local warn_path = "BuildInfo/resistancelayout"
local hurt_name_path = "BuildInfo/resistancelayout/warnObj/hurtNum"
local battle_state_btn_path = "BuildInfo/resistancelayout/warnObj/battle_state_btn"
local battle_state_img_path = "BuildInfo/resistancelayout/warnObj/battle_state_btn/battle_img"

local declareWarList_rect_path = "BuildInfo/Rect_DeclareWarList"
local declareWarList_btn_path = "BuildInfo/Rect_DeclareWarList/Btn_DeclareWarList"
local warList_txt_path = "BuildInfo/Rect_DeclareWarList/Btn_DeclareWarList/Txt_WarList"


local detail_title_path = "BuildDetails/ScrollView/Viewport/Content/detailTitle/detailDesTitle"
local des_txt_path = "BuildDetails/ScrollView/Viewport/Content/detailTitle/desTxt"
local atk_obj_path = "BuildDetails/ScrollView/Viewport/Content/atkObj"
local atk_name_des_path = "BuildDetails/ScrollView/Viewport/Content/atkObj/Image/atkNameTxt"
local atk_num_des_path = "BuildDetails/ScrollView/Viewport/Content/atkObj/Image/atkNumTxt"
local atk_content_path = "BuildDetails/ScrollView/Viewport/Content/atkObj/atkContent"

local kill_reward_title_path = "BuildDetails/ScrollView/Viewport/Content/killRewardTitle"
local kill_reward_title_txt_path = "BuildDetails/ScrollView/Viewport/Content/killRewardTitle/killDesTxt"
local kill_reward_content_path = "BuildDetails/ScrollView/Viewport/Content/killRewardContent"

local occupy_reward_title_path = "BuildDetails/ScrollView/Viewport/Content/occupyRewardTitle"
local occupy_reward_title_txt_path = "BuildDetails/ScrollView/Viewport/Content/occupyRewardTitle/occupyDesTxt"
local occupy_reward_content_path = "BuildDetails/ScrollView/Viewport/Content/occupyRewardContent"

local explain_txt_path = "BuildDetails/ScrollView/Viewport/Content/explainDesc"

local animator_path = ""
-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

-- 销毁
local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

-- 显示
local function OnEnable(self)
    base.OnEnable(self)
end

-- 隐藏
local function OnDisable(self)
    self:OnReturnClick()
    base.OnDisable(self)
end


--控件的定义
local function ComponentDefine(self)
    self.animator = self:AddComponent(UIAnimator, animator_path)
    self.main_obj = self:AddComponent(UIBaseContainer,main_obj_path)
    self.build_des = self:AddComponent(UICanvasGroup,build_des_path)
    self.build_des:SetAlpha(1)
    self.build_des:SetInteractable(true)
    self.build_des:SetBlocksRaycasts(true)
    self.rank_obj = self:AddComponent(WorldSiegeContributePanel,rank_obj_path)
    self.rank_obj_canvas = self:AddComponent(UICanvasGroup,rank_obj_path)
    self.rank_obj_canvas:SetAlpha(0)
    self.rank_obj_canvas:SetInteractable(false)
    self.rank_obj_canvas:SetBlocksRaycasts(false)
    self.reward_item = self:AddComponent(UIBaseContainer,reward_item_path)
    self.reward_content = self:AddComponent(UIBaseContainer,reward_content_path)
    self.main_obj_canvas = self:AddComponent(UICanvasGroup,main_obj_path)
    self.main_obj_canvas:SetAlpha(1)
    self.btn_alliance = self:AddComponent(UIButton, btn_alliance_path)
    self.btn_alliance:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnAllianceClick()
    end)
    self.time_obj = self:AddComponent(UIBaseContainer,time_obj_path)
    self.time_txt = self:AddComponent(UITextMeshProUGUIEx,time_label_path)
    self.time_icon = self:AddComponent(UIImage,time_icon_path)
    self.city_soldier_des = self:AddComponent(UITextMeshProUGUIEx,city_soldier_des_path)
    self.city_soldier_des:SetLocalText(300696)
    self.layout1_obj = self:AddComponent(UIBaseContainer,layout1_obj_path)
    self.city_add_des = self:AddComponent(UITextMeshProUGUIEx,city_add_des_path)
    self.city_add_des:SetLocalText(300698)
    self.layout2_obj = self:AddComponent(UIBaseContainer,layout2_obj_path)
    self.city_add_des_2 = self:AddComponent(UITextMeshProUGUIEx,city_add_des_2_path)
    self.city_add_des_2:SetLocalText(300698)
    self.layout3_obj = self:AddComponent(UIBaseContainer,layout3_obj_path)
    self.city_add_des_3 = self:AddComponent(UITextMeshProUGUIEx,city_add_des_3_path)
    self.city_add_des_3:SetLocalText(302014)
    self.layout4_obj = self:AddComponent(UIBaseContainer, layout4_obj_path)
    self.city_add_des_4 = self:AddComponent(UITextMeshProUGUIEx, city_add_des_4_path)
    self.city_add_des_4:SetText(Localization:GetString("390963")..": ")
    self.city_add_num_4 = self:AddComponent(UITextMeshProUGUIEx, city_add_num_4_path)
    
    self.layout5_obj = self:AddComponent(UIBaseContainer, layout5_obj_path)
    self.city_add_des_5 = self:AddComponent(UITextMeshProUGUIEx, city_add_des_5_path)
    self.city_add_des_5:SetText(Localization:GetString("110524")..": ")
    self.city_add_num_5 = self:AddComponent(UITextMeshProUGUIEx, city_add_num_5_path)
    
    self.layout6_obj = self:AddComponent(UIBaseContainer, layout6_obj_path)
    self.city_add_des_6 = self:AddComponent(UITextMeshProUGUIEx, city_add_des_6_path)
    self.city_add_des_6:SetText(Localization:GetString("110527")..": ")
    self.city_add_num_6 = self:AddComponent(UITextMeshProUGUIEx, city_add_num_6_path)

    self.layout7_obj = self:AddComponent(UIBaseContainer, layout7_obj_path)
    self.city_add_des_7 = self:AddComponent(UITextMeshProUGUIEx, city_add_des_7_path)
    self.city_add_des_7:SetText(Localization:GetString("104334")..": ")
    self.city_add_num_7 = self:AddComponent(UITextMeshProUGUIEx, city_add_num_7_path)
    
    self.hurt_name = self:AddComponent(UITextMeshProUGUIEx,hurt_name_path)
    self.warn = self:AddComponent(UIBaseContainer, warn_path)
    self.battle_state_btn = self:AddComponent(UIButton, battle_state_btn_path)
    self.battle_state_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBattleStateClick()
    end)

    self.battle_state_img = self:AddComponent(UIImage, battle_state_img_path)
    
    self.reward_txt = self:AddComponent(UITextMeshProUGUIEx,reward_txt_path)
    self.reward_txt:SetLocalText(300702)
    self.city_add_num_des = self:AddComponent(UITextMeshProUGUIEx,city_add_num_des_path)
    self.city_add_num = self:AddComponent(UITextMeshProUGUIEx,city_add_num_path)
    self.city_add_num_des_2 = self:AddComponent(UITextMeshProUGUIEx,city_add_num_des_2_path)
    self.city_add_num_2 = self:AddComponent(UITextMeshProUGUIEx,city_add_num_2_path)
    self.city_add_num_3 = self:AddComponent(UITextMeshProUGUIEx,city_add_num_3_path)
    self.city_add_num_des_btn = self:AddComponent(UIButton, city_add_num_des_btn_path)
    self.city_add_num_des_btn:SetOnClick(function()
        self:OnDesClick()
    end)
    self.city_alliance_name = self:AddComponent(UITextMeshProUGUIEx,city_alliance_name_path)
    self.first_occupy_obj = self:AddComponent(UIBaseContainer,first_occupy_obj_path)
    self.first_occupy_name = self:AddComponent(UITextMeshProUGUIEx,first_occupy_name_path)
    self.first_occupy_data = self:AddComponent(UITextMeshProUGUIEx,first_occupy_data_path)
    self.rank_detail_btn = self:AddComponent(UIButton, rank_detail_path)
    self.rank_detail_btn:SetOnClick(function()
        self:OnRankDetailClick()
    end)
    self.kings_obj = self:AddComponent(UIBaseContainer,kings_obj_path)
    self.kings_btn = self:AddComponent(UIButton,kings_btn_path)
    self.kings_btn:SetOnClick(function()
        self:OnKingsClick()
    end)
    self.kings_txt = self:AddComponent(UITextMeshProUGUIEx,kings_txt_path)
    self.kings_txt:SetLocalText(250002)
    self.kings_des = self:AddComponent(UITextMeshProUGUIEx,kings_des_path)
    self.kings_name = self:AddComponent(UITextMeshProUGUIEx,kings_name_path)
    self.tips_obj = self:AddComponent(UIBaseContainer,tips_obj_path)
    self.tips_txt = self:AddComponent(UITextMeshProUGUIEx,tips_txt_path)
    self.eden_tips_obj = self:AddComponent(UIBaseContainer,eden_tips_obj_path)
    self.eden_tips_txt = self:AddComponent(UITextMeshProUGUIEx,eden_tips_txt_path)
    self.declareWarList_rect = self:AddComponent(UIBaseComponent,declareWarList_rect_path)
    self.declareWarList_btn = self:AddComponent(UIButton,declareWarList_btn_path)
    self.warList_txt = self:AddComponent(UITextMeshProUGUIEx,warList_txt_path)
    self.warList_txt:SetLocalText(143549)
    self.declareWarList_btn:SetOnClick(function()
        self:OnClickDeclareWarList()
    end)
    
    self.des_obj_canvas = self:AddComponent(UICanvasGroup,des_obj_path)
    self.des_obj = self:AddComponent(UIBaseContainer,des_obj_path)
    self.atk_content = self:AddComponent(UIBaseContainer,atk_content_path)
    self.atk_obj = self:AddComponent(UIBaseContainer,atk_obj_path)
    self.atk_obj:SetActive(false)
    self.des_obj_canvas:SetAlpha(0)
    self.des_obj:SetActive(false)
    self.des_txt = self:AddComponent(UITextMeshProUGUIEx,des_txt_path)
    self.des_txt:SetLocalText(300706)
    self.detail_title = self:AddComponent(UITextMeshProUGUIEx,detail_title_path)
    self.detail_title:SetLocalText(300705) 
    self.atk_name_des = self:AddComponent(UITextMeshProUGUIEx,atk_name_des_path)
    self.atk_name_des:SetLocalText(300717) 
    self.atk_num_des = self:AddComponent(UITextMeshProUGUIEx,atk_num_des_path)
    self.atk_num_des:SetLocalText(300718) 
    
    self.kill_reward_title_obj = self:AddComponent(UIBaseContainer,kill_reward_title_path)
    self.kill_reward_title_txt = self:AddComponent(UITextMeshProUGUIEx,kill_reward_title_txt_path)
    self.kill_reward_title_txt:SetLocalText(300729)
    self.kill_reward_content = self:AddComponent(UIBaseContainer,kill_reward_content_path)
    
    self.occupy_reward_title_obj = self:AddComponent(UIBaseContainer,occupy_reward_title_path)
    self.occupy_reward_title_txt = self:AddComponent(UITextMeshProUGUIEx,occupy_reward_title_txt_path)
    self.occupy_reward_title_txt:SetLocalText(300730)
    self.occupy_reward_content = self:AddComponent(UIBaseContainer,occupy_reward_content_path)
    
    self.explain_txt_path = self:AddComponent(UITextMeshProUGUIEx,explain_txt_path)
    self.explain_txt_path:SetLocalText(110451)
end

--控件的销毁
local function ComponentDestroy(self)
    self.btn = nil
    self.btnImage = nil
end

--变量的定义
local function DataDefine(self)
    self.data = nil
    self.showTimeState = AllianceCityShowTimeState.None
    self.endTime = 0
    self.timeStr = ""
    self.getRankList = false
end

--变量的销毁
local function DataDestroy(self)
    self.data = nil
end

local function SetRewardCellDestroy(self)
    self.reward_content:RemoveComponents(UICommonItem)
    if self.rewardModel~=nil then
        for k,v in pairs(self.rewardModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.rewardModel ={}
end

local function SetAtkCellDestroy(self)
    self.atk_content:RemoveComponents(UserCell)
    if self.atkModel~=nil then
        for k,v in pairs(self.atkModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.atkModel ={}
end

local function SetKillRewardDestroy(self)
    self.kill_reward_content:RemoveComponents(UIWorldSiegeRewardCell)
    if self.killModel~=nil then
        for k,v in pairs(self.killModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.killModel ={}
end

local function SetOccupyRewardDestroy(self)
    self.occupy_reward_content:RemoveComponents(UIWorldSiegeRewardCell)
    if self.occupyModel~=nil then
        for k,v in pairs(self.occupyModel) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.occupyModel ={}
end

local function InitData(self,param)
    self.data = param
    self.getRankList = false
    if self.data.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
        self.des_txt:SetText("")
        self.detail_title:SetText("")
        self.explain_txt_path:SetLocalText(250033)
        local curPresident = DataCenter.GovernmentManager:GetCurPresident()
        if curPresident == nil then
            self.kings_des:SetLocalText(250122)
            self.kings_name:SetText("")
        else
            self.kings_name:SetLocalText(250003)
            local presidentName = ""
            if string.IsNullOrEmpty(curPresident.allianceAbbr) then
                presidentName = curPresident.name
            else
                presidentName = "[" .. curPresident.allianceAbbr .. "]" .. curPresident.name
            end
            self.kings_des:SetText(presidentName)
        end
    else
        self.des_txt:SetLocalText(300706)
        self.detail_title:SetLocalText(300705)
        self.explain_txt_path:SetLocalText(110451)
    end
    local nameStr = Localization:GetString("100206")
    if self.data.state == AllianceCityState.OCCUPIED or self.data.state == AllianceCityState.InProgress then
        nameStr = "["..self.data.alAbbr.."]"..self.data.alName
        self.btn_alliance:SetActive(true)
    else
        self.btn_alliance:SetActive(false)
    end
    self.city_alliance_name:SetText(nameStr)
    if self.data.buffDes~=nil then
        self.layout1_obj:SetActive(true)
        self.city_add_num_des:SetLocalText(self.data.buffDes)
        self.city_add_num:SetText("+"..self.data.buffAddNum)
    else
        self.layout1_obj:SetActive(false)
    end
    if self.data.buffDes2~=nil then
        self.layout2_obj:SetActive(true)
        self.city_add_num_des_2:SetLocalText(self.data.buffDes2) 
        self.city_add_num_2:SetText("+"..self.data.buffAddNum2)
    else
        self.layout2_obj:SetActive(false)
    end
    if self.data.dead_rate~=nil and self.data.dead_rate~="" then
        self.layout3_obj:SetActive(true)
        self.city_add_num_3:SetText(self.data.dead_rate)
    else
        self.layout3_obj:SetActive(false)
    end

    local seasonId = DataCenter.SeasonDataManager:GetSeasonId()
    if seasonId == 1 or seasonId == 5 then
        if self.data.forceNum~=nil and self.data.forceNum~= "" then
            self.layout5_obj:SetActive(true)
            self.city_add_num_5:SetText(string.GetFormattedSeperatorNum(math.floor(tonumber(self.data.forceNum))))
        else
            self.layout5_obj:SetActive(false)
        end
    else
        self.layout5_obj:SetActive(false)
    end

    if self.data.forceAddSpeed~=nil and self.data.forceAddSpeed~= ""then
        local num = tonumber(self.data.forceAddSpeed)
        if num~=nil and num>0 then
            self.layout6_obj:SetActive(true)
            self.city_add_num_6:SetText("+"..num.."/H")
        else
            self.layout6_obj:SetActive(false)
        end
    else
        self.layout6_obj:SetActive(false)
    end

    --if (self.data.cityId ~=THRONE_ID or LuaEntry.Player.serverType ~= ServerType.NORMAL) and self.data.eden_city_type == WorldCityType.AllianceCity then
    --    self.layout7_obj:SetActive(true)
    --    local k8 = LuaEntry.DataConfig:TryGetNum("armyspeed", "k8")
    --    self.city_add_num_7:SetText(string.GetFormattedPercentStr(k8/100))
    --else
        self.layout7_obj:SetActive(false)
    --end
    
    local speed = GetTableData(TableName.WorldCity, self.data.cityId, 'alliance_res_speed')
    if self.data~=nil and self.data.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
        if CrossServerUtil:GetIsCrossServer() then
            self.kings_obj:SetActive(false)
        else
            self.kings_obj:SetActive(false)
        end
        
        self.layout4_obj:SetActive(false)
    else
        self.kings_obj:SetActive(false)
        self.city_add_num_4:SetText(speed .. "/h")
        self.layout4_obj:SetActive(true)
    end
    
    self.first_occupy_obj:SetActive(false)
    if self.data.state == AllianceCityState.NEUTRAL then
        self.reward_item:SetActive(false)
        self:SetRewardCellDestroy()
        local list = self.data.rewardStr
        if list~=nil then
            local num =0
            for i = 1, table.length(list) do
                --复制基础prefab，每次循环创建一次
                num = num+1
                self.rewardModel[i] = self:GameObjectInstantiateAsync(UIAssets.UICommonItemSize, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.gameObject:SetActive(true)
                    go.transform:SetParent(self.reward_content.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local cell = self.reward_content:AddComponent(UICommonItem,nameStr)
                    cell:ReInit(list[i])
                end)
            end
        end
    else
        self.reward_item:SetActive(false)
    end
    if self.data.isInAlliance == true then
        local num = string.format("<color=#27C68C> %s</color>",string.GetFormattedSeperatorNum(math.floor(self.data.recommend_num)))
        local tips = Localization:GetString("302070",math.floor(self.data.recommend_level),num)
        self.tips_txt:SetText(tips)
        self.tips_txt:SetColor(Color.New(0.7176471,0.4,0.1882353,1))
    else
        self.tips_txt:SetLocalText(300707)
        self.tips_txt:SetColor(Color.New(0.9176,0.2588,0.2588,1))
    end
    self.tips_obj:SetActive(self.data.cityId ~=THRONE_ID or LuaEntry.Player.serverType ~= ServerType.NORMAL )

    self.eden_tips_obj:SetActive(self.data.eden_city_type == WorldCityType.StrongHold or self.data.eden_city_type == WorldCityType.AlliancePass)
    if self.data.eden_city_type == WorldCityType.StrongHold then
        self.eden_tips_txt:SetLocalText(111072)
    elseif self.data.eden_city_type == WorldCityType.AlliancePass then
        self.eden_tips_txt:SetLocalText(111074)
    end
    local warDataList  = DataCenter.AllianceDeclareWarManager:GetWarDataByCityId(self.data.cityId)
    if next(warDataList) then
        self.declareWarList_rect:SetActive(false)
    else
        self.declareWarList_rect:SetActive(false)
    end

    if #self.data.kill_reward_list>0 and (self.data.cityId ~=THRONE_ID or LuaEntry.Player.serverType ~= ServerType.NORMAL)  then
        self.kill_reward_title_obj:SetActive(true)
        self:SetKillRewardDestroy()
        local list = self.data.kill_reward_list
        if list~=nil then
            local num =0
            for i = 1, table.length(list) do
                --复制基础prefab，每次循环创建一次
                num = num+1
                self.killModel[i] = self:GameObjectInstantiateAsync(UIAssets.WorldSiegeRewardCell, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.gameObject:SetActive(true)
                    go.transform:SetParent(self.kill_reward_content.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local cell = self.kill_reward_content:AddComponent(UIWorldSiegeRewardCell,nameStr)
                    cell:RefreshData(list[i],i)
                end)
            end
        end
    else
        self.kill_reward_title_obj:SetActive(false)
    end
    if #self.data.destroy_reward_list>0 and (self.data.cityId ~=THRONE_ID or LuaEntry.Player.serverType ~= ServerType.NORMAL)  then
        self.occupy_reward_title_obj:SetActive(true)
        self:SetOccupyRewardDestroy()
        local list = self.data.destroy_reward_list
        if list~=nil then
            local num =0
            for i = 1, table.length(list) do
                --复制基础prefab，每次循环创建一次
                num = num+1
                self.occupyModel[i] = self:GameObjectInstantiateAsync(UIAssets.WorldSiegeRewardCell, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.gameObject:SetActive(true)
                    go.transform:SetParent(self.occupy_reward_content.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local cell = self.occupy_reward_content:AddComponent(UIWorldSiegeRewardCell,nameStr)
                    cell:RefreshData(list[i],i)
                end)
            end
        end
    else
        self.occupy_reward_title_obj:SetActive(false)
    end
    self:CheckBattleState()
end


local function CheckBattleState(self)
    self.battleStateStr = nil
    local showWarn = false
    if self.data~=nil and (self.data.cityId~=THRONE_ID or LuaEntry.Player.serverType ~= ServerType.NORMAL) then
        if self.data.selfPercent >=0 then
            self.warn:SetActive(false)
        else
            showWarn = true
            self.warn:SetActive(true)
            self.battleStateTitle = Localization:GetString("110330")
            self.battleStateStr = Localization:GetString("110332",string.GetFormattedPercentStr(-self.data.selfPercent),string.GetFormattedPercentStr(self.data.otherPercent))
            local str = string.GetFormattedSeperatorNum(math.floor(self.data.selfValue)).."/"..string.GetFormattedSeperatorNum(math.floor(self.data.resistance))
            self.battle_state_img:LoadSprite(string.format(LoadPath.CommonNewPath, "UITroops_btn_combat03"))
            self.hurt_name:SetText(Localization:GetString("110333",str,string.GetFormattedPercentStr(self.data.selfPercent)))
        end
    else
        self.warn:SetActive(false)
    end
    
    return showWarn
end

local function OnBattleStateClick(self)
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.battle_state_btn.gameObject.transform.position + Vector3.New(20, 0, 0) * scaleFactor

    local param = UIHeroTipView.Param.New()
    if self.data.selfPercent >=0 then
        param.content = self.battleStateTitle
    else
        param.title = self.battleStateTitle
        if self.battleStateStr~=nil and self.battleStateStr~="" then
            param.content = self.battleStateStr
        end
    end

    param.dir = UIHeroTipView.Direction.RIGHT
    param.defWidth = 340
    param.pivot = 0.5
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end


local function CheckCurTime(self)
    self.state = AllianceCityShowTimeState.None
    self.endTime = 0
    if self.data~=nil and self.data.uuid~=nil then
        if self.data.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
            local curTime = UITimeManager:GetInstance():GetServerSeconds()
            if self.data.openTime==nil or (self.data.openTime <=0 and self.data.protectTime <=0) then
                self.state = AllianceCityShowTimeState.ThroneNotOpen
            elseif self.data.openTime < curTime then
                if curTime<=self.data.protectTime then
                    self.state = AllianceCityShowTimeState.ThroneAttack
                    self.endTime = self.data.protectTime
                end
            else
                self.state = AllianceCityShowTimeState.ThroneProtect
                self.endTime = self.data.openTime
            end
        else
            if self.data~=nil and self.serverData~=nil then
                local curTime = UITimeManager:GetInstance():GetServerSeconds()
                if self.data.openTime < curTime and self.data.openTime ~= -1 then
                    if self.data.protectTime<curTime then
                        local recoverTime = (self.serverData.battleStartTime/1000)+ self.data.monsterRecoverTime
                        if recoverTime >= curTime then
                            self.state = AllianceCityShowTimeState.Recover
                            self.endTime = recoverTime
                        end
                    else
                        self.state = AllianceCityShowTimeState.UnAttack
                        self.endTime = self.data.protectTime
                    end
                else
                    self.state = AllianceCityShowTimeState.Lock
                    self.endTime = self.data.openTime
                end
            end
        end
    end
   
    if self.state == AllianceCityShowTimeState.Recover then
        self.time_obj:SetActive(true)
        self.timeStr = Localization:GetString("300700")..": "
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/UIBuildBtns/UIworld_icon_scout.png")
    elseif self.state == AllianceCityShowTimeState.UnAttack then
        self.time_obj:SetActive(true)
        self.timeStr = Localization:GetString("300701")..": "
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/UIBuildBtns/UIworld_icon_defend.png")
    elseif self.state == AllianceCityShowTimeState.Lock then
        self.time_obj:SetActive(true)
        if LuaEntry.Player.serverType == ServerType.EDEN_SERVER then
            if self.data.eden_city_type == WorldCityType.AllianceCity then
                self.timeStr = Localization:GetString("111164")..":"
            elseif self.data.eden_city_type == WorldCityType.AlliancePass then
                self.timeStr = Localization:GetString("111165")..":"
            elseif self.data.eden_city_type == WorldCityType.StrongHold then
                self.timeStr = Localization:GetString("111166")..":"
            end
        else
            self.timeStr = Localization:GetString("372111","") 
        end
        
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_icon_time_green.png")
    elseif self.state == AllianceCityShowTimeState.ThroneAttack then
        self.time_obj:SetActive(true)
        self.timeStr = Localization:GetString("250104","")
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/Common/New/Common_icon_time_green.png")
    elseif self.state == AllianceCityShowTimeState.ThroneProtect then
        self.time_obj:SetActive(true)
        self.timeStr = Localization:GetString("250105","")
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/UIBuildBtns/UIworld_icon_defend.png")
    elseif self.state == AllianceCityShowTimeState.ThroneNotOpen then
        self.time_obj:SetActive(true)
        self.timeStr = Localization:GetString("250105","")
        self.time_icon:LoadSprite("Assets/Main/Sprites/UI/UIBuildBtns/UIworld_icon_defend.png")
    else
        self.time_obj:SetActive(false)
    end
end

--打开宣战遗迹列
local function OnClickDeclareWarList(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIDeclareWarList,{ anim = true},self.data.cityId)
end


local function UpdateTime(self)
    if self.state == AllianceCityShowTimeState.ThroneNotOpen then
        self.time_txt:SetText(self.timeStr)
    else
        if self.endTime>0 and self.state~=AllianceCityShowTimeState.None then
            local curTime = UITimeManager:GetInstance():GetServerSeconds()
            local deltaTime = self.endTime - curTime
            if deltaTime>0 then
                self.time_txt:SetText(self.timeStr..UITimeManager:GetInstance():SecondToFmtString(deltaTime))
            else
                self.time_txt:SetText(self.timeStr.."00:00:00")
            end
        elseif self.endTime == -1 then
            if LuaEntry.Player.serverType == ServerType.EDEN_SERVER then
                if self.data.belong_eden_camp~=nil and self.data.belong_eden_camp >0 then
                    self.time_txt:SetLocalText(111232)
                    return
                end
            end
            
            self.time_txt:SetLocalText(120105)
        end
    end
    
end


local function RefreshData(self,data)
    self.serverData = data
    self.getRankList = false
    if self.serverData~=nil then
        self:CheckFirstOccupy()
        self:CheckCurTime()
		self:UpdateTime()
        if self.data~=nil then
            local show = true
            local curTime = UITimeManager:GetInstance():GetServerSeconds()
            local tempOpenTime = self.data.openTime or -1
            if tempOpenTime> curTime or tempOpenTime == -1 then
                show = false
            elseif self.view.ctrl.cityId == THRONE_ID and self.data.openTime <=0 and self.data.protectTime<=0 and LuaEntry.Player.serverType == ServerType.NORMAL then
                show = false
            end
            if show == true and self.serverData.attackList and #self.serverData.attackList > 0 then
                if self.view.ctrl.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
                    --local has = false
                    --for i = 1, table.length(self.serverData.attackList) do
                    --    if has == false then
                    --        local temp = self.serverData.attackList[i]
                    --        if temp.buildPoint>0 or temp.allianceId == self.data.allianceId then
                    --            has = true
                    --        end
                    --    end
                    --end
                    --if has then
                    --else
                    --end
                else
                    self.rank_obj:ShowPanel(self.serverData)
                    self.getRankList = true
                end
            else
            end
        end
    end
end

local function CheckFirstOccupy(self)
    if self.data ==nil  then
        return
    end
    if self.serverData~=nil then
        if self.serverData.firstOccupyInfo~=nil then
            if self.data.cityId == THRONE_ID and LuaEntry.Player.serverType == ServerType.NORMAL then
                self.reward_item:SetActive(false)
                self.first_occupy_obj:SetActive(false)
                return
            end
            if self.serverData.firstOccupyInfo.firstOccupyTime~=nil and self.serverData.firstOccupyInfo.firstOccupyTime>0 then
                self.reward_item:SetActive(false)
                if self.data~=nil and self.data.state == AllianceCityState.NEUTRAL then
                    local nameStr = Localization:GetString("100206").."("..Localization:GetString("302131")..")"
                    self.city_alliance_name:SetText(nameStr)
                end
            end
            if self.serverData.firstOccupyInfo.alAbbr~=nil and self.serverData.firstOccupyInfo.alAbbr~="" then
                self.first_occupy_obj:SetActive(true)
                self.reward_item:SetActive(false)
                local nameStr = "["..self.serverData.firstOccupyInfo.alAbbr.."]"..self.serverData.firstOccupyInfo.alName
                self.first_occupy_name:SetText(nameStr)
                local second = 0
                if self.serverData.firstOccupyInfo.firstOccupyTime>0 then
                    second = math.floor(self.serverData.firstOccupyInfo.firstOccupyTime/1000)
                end
                local timeStr = UITimeManager:GetInstance():GetTimeToMD(second)
                self.first_occupy_data:SetText(Localization:GetString("300728",timeStr))
                return
            end
        else
            if self.data~=nil and self.data.state == AllianceCityState.NEUTRAL then
                self.reward_item:SetActive(true)
            end
        end
    else
        if self.data~=nil and self.data.state == AllianceCityState.NEUTRAL then
            self.reward_item:SetActive(true)
        end
    end
    self.first_occupy_obj:SetActive(false)
end
local function OnInfoClick(self)
    --self.animator:Enable(true)
    --self.animator:Play("switchEnter",0,0)
    self.main_obj_canvas:SetAlpha(0)
    self.des_obj_canvas:SetAlpha(1)
    self.des_obj:SetActive(true)
end
--返回
local function OnReturnClick(self)
    self.main_obj_canvas:SetAlpha(1)
    self.des_obj_canvas:SetAlpha(0)
    self.des_obj:SetActive(false)
    --self.animator:Enable(true)
    --self.animator:Play("switchOut",0,0)
end

local function OnAllianceClick(self)
    if self.data~=nil then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIAllianceDetail,{ anim = true, isBlur = true},self.data.alName,self.data.allianceId)
    end
end

local function OnKingsClick(self)
    self.view.ctrl:CloseSelf()
    UIUtil.ShowTipsId(430155)
    --todo:UIManager:GetInstance():OpenWindow(UIWindowNames.UIGovernmentMain)
end

local function OnDesClick(self)
    --local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    --local position = self.city_add_num_des_btn.transform.position + Vector3.New(0, -30, 0) * scaleFactor
    --
    --local param = UIHeroTipView.Param.New()
    --param.content = Localization:GetString("302015")
    --if self.data~=nil and self.data.cityId == THRONE_ID then
    --    param.content = Localization:GetString("250160")
    --end
    --param.dir = UIHeroTipView.Direction.BELOW
    --param.defWidth = 180
    --param.pivot = 0.5
    --param.position = position
    --UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
    
    local content = "——————————".."\n"..Localization:GetString("121586")
    local injuryMsg = Localization:GetString("121581")..self.data.injury_rate.."%"
    local woundedMsg = Localization:GetString("121582")..self.data.wounded_rate.."%"
    local deadMsg = Localization:GetString("302014")..self.data.dead_rate
    local msg = deadMsg.."\n"..injuryMsg.."\n"..woundedMsg.."\n"..content
    local scaleFactor = UIManager:GetInstance():GetScaleFactor()
    local position = self.city_add_num_des_btn.transform.position + Vector3.New(40, 15, 0) * scaleFactor
    local param = {}
    param.content = msg
    param.dir = 1
    param.defWidth = 300
    param.pivot = 0.25
    param.position = position
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroTip, { anim = false }, param)
end

local function OnReturnDesClick(self)
    self.rank_obj_canvas:SetAlpha(0)
    self.rank_obj_canvas:SetInteractable(false)
    self.rank_obj_canvas:SetBlocksRaycasts(false)
    self.build_des:SetAlpha(1)
    self.build_des:SetInteractable(true)
    self.build_des:SetBlocksRaycasts(true)
end

local function OnRankDetailClick(self)
    if self.getRankList ==false then
        UIUtil.ShowTipsId(450110)
        return
    end
    self.rank_obj_canvas:SetAlpha(1)
    self.rank_obj_canvas:SetInteractable(true)
    self.rank_obj_canvas:SetBlocksRaycasts(true)
    self.build_des:SetAlpha(0)
    self.build_des:SetInteractable(false)
    self.build_des:SetBlocksRaycasts(false)
end
UIWorldSiegePointInfo.OnCreate = OnCreate
UIWorldSiegePointInfo.OnDestroy = OnDestroy
UIWorldSiegePointInfo.OnEnable = OnEnable
UIWorldSiegePointInfo.OnDisable = OnDisable
UIWorldSiegePointInfo.ComponentDefine = ComponentDefine
UIWorldSiegePointInfo.ComponentDestroy = ComponentDestroy
UIWorldSiegePointInfo.DataDefine = DataDefine
UIWorldSiegePointInfo.DataDestroy = DataDestroy
UIWorldSiegePointInfo.RefreshData = RefreshData
UIWorldSiegePointInfo.OnReturnClick =OnReturnClick
UIWorldSiegePointInfo.OnInfoClick = OnInfoClick
UIWorldSiegePointInfo.InitData = InitData
UIWorldSiegePointInfo.CheckCurTime = CheckCurTime
UIWorldSiegePointInfo.UpdateTime = UpdateTime
UIWorldSiegePointInfo.SetAtkCellDestroy = SetAtkCellDestroy
UIWorldSiegePointInfo.SetRewardCellDestroy = SetRewardCellDestroy
UIWorldSiegePointInfo.CheckFirstOccupy = CheckFirstOccupy
UIWorldSiegePointInfo.OnAllianceClick = OnAllianceClick
UIWorldSiegePointInfo.SetKillRewardDestroy =SetKillRewardDestroy
UIWorldSiegePointInfo.SetOccupyRewardDestroy = SetOccupyRewardDestroy
UIWorldSiegePointInfo.OnDesClick =OnDesClick
UIWorldSiegePointInfo.OnClickDeclareWarList = OnClickDeclareWarList
UIWorldSiegePointInfo.CheckBattleState =CheckBattleState
UIWorldSiegePointInfo.OnBattleStateClick =OnBattleStateClick
UIWorldSiegePointInfo.OnKingsClick =OnKingsClick
UIWorldSiegePointInfo.OnRankDetailClick =OnRankDetailClick
UIWorldSiegePointInfo.OnReturnDesClick =OnReturnDesClick
return UIWorldSiegePointInfo