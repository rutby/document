---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2023/3/22 11:24
---
local WorldSiegeThroneScorePanel = BaseClass("WorldSiegeThroneScorePanel", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization
local UserCell = require "UI.UIWorldSiegePoint.Component.WorldSiegeThroneUserCell"

local title_path = "bg/Top/NameText"
local introGroup_path = "bg/layout/intro"
local introBackBtn_path = "bg/layout/intro/btn_return"
local introSv_path = "bg/layout/intro/introSv"
local introTxt_path = "bg/layout/intro/introSv/Viewport/introTxt"
local rankGroup_path = "bg/layout/rank"
local rankBackBtn_path = "bg/layout/rank/btn_detail"
local rankContent_path = "bg/layout/rank/ScrollView/Viewport/Content"

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

-- 销毁
local function OnDestroy(self)
    self:SetRankCellsDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

--控件的定义
local function ComponentDefine(self)
    self.titleN = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.titleN:SetText(Localization:GetString("250028"))
    self.introN = self:AddComponent(UIBaseContainer, introGroup_path)
    self.introBackBtnN = self:AddComponent(UIButton, introBackBtn_path)
    self.introBackBtnN:SetOnClick(function()
        self:OnClickIntroBackBtn()
    end)
    self.introSvN = self:AddComponent(UIScrollRect, introSv_path)
    self.introTxtN = self:AddComponent(UITextMeshProUGUIEx, introTxt_path)
    self.introTxtN:SetLocalText(250118)
    self.rankN = self:AddComponent(UIBaseContainer, rankGroup_path)
    self.rankBackBtnN = self:AddComponent(UIButton, rankBackBtn_path)
    self.rankBackBtnN:SetOnClick(function()
        self:OnClickRankBackBtn()
    end)
    self.rankContentN = self:AddComponent(UIBaseContainer, rankContent_path)
end

--控件的销毁
local function ComponentDestroy(self)
    self.titleN = nil
    self.introN = nil
    self.introBackBtnN = nil
    self.introTxtN = nil
    self.rankN = nil
    self.rankBackBtnN = nil
    self.rankContentN = nil
end

--变量的定义
local function DataDefine(self)
    self.serverData = nil
end

--变量的销毁
local function DataDestroy(self)
    self.serverData = nil
end

local function ShowPanel(self, data,curAllianceId)
    self.serverData = data
    self.curAllianceId = curAllianceId
    self:ShowRank()
end

local function ShowRank(self)
    self.introN:SetActive(false)
    self.rankN:SetActive(true)

    self:RefreshRankList()
end

local function ShowIntro(self)
    self.introN:SetActive(true)
    self.rankN:SetActive(false)
    self.introSvN:SetVerticalNormalizedPosition(1)
end

local function RefreshRankList(self)
    self:SetRankCellsDestroy()
    self.rankModels = {}
    if self.serverData~=nil then
        if #self.serverData.attackList>0 then
            local list = {}
            for i = 1, table.length(self.serverData.attackList) do
                local data = self.serverData.attackList[i]
                if data.buildPoint>0 or data.allianceId == self.curAllianceId then
                    local oneData = {}
                    oneData.alAbbr = data.alAbbr
                    oneData.alName = data.alName
                    oneData.allianceId = data.allianceId
                    oneData.buildPoint = data.buildPoint
                    oneData.sortPoint = data.buildPoint
                    if data.allianceId == self.curAllianceId then
                        local startTime = self.serverData.battleStartTime
                        if startTime>0 then
                            local curTime = UITimeManager:GetInstance():GetServerTime()
                            local startNum = data.buildPoint
                            local addSpeed = LuaEntry.DataConfig:TryGetNum("president_occupation_rate","k1")
                            local totalTime = curTime - startTime
                            if totalTime<0 then
                                totalTime = 0
                            end
                            oneData.sortPoint = startNum+((totalTime*addSpeed)/1000)
                        end
                    end
                    table.insert(list,oneData)
                end
            end
            table.sort(list,function(a,b)
                return a.sortPoint>b.sortPoint
            end)
            for i = 1, table.length(list) do
                --复制基础prefab，每次循环创建一次
                local data = list[i]
                self.rankModels[i] = self:GameObjectInstantiateAsync(UIAssets.WorldSiegeThroneUserCell, function(request)
                    if request.isError then
                        return
                    end
                    local go = request.gameObject;
                    go.gameObject:SetActive(true)
                    go.transform:SetParent(self.rankContentN.transform)
                    go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
                    local nameStr = tostring(NameCount)
                    go.name = nameStr
                    NameCount = NameCount + 1
                    local cell = self.rankContentN:AddComponent(UserCell,nameStr)
                    cell:RefreshData(data,i,self.serverData,self.curAllianceId)
                end)
            end
        end
    end
end

local function SetRankCellsDestroy(self)
    self.rankContentN:RemoveComponents(UserCell)
    if self.rankModels~=nil then
        for k,v in pairs(self.rankModels) do
            if v ~= nil then
                self:GameObjectDestroy(v)
            end
        end
    end
    self.rankModels ={}
end


local function OnClickIntroBackBtn(self)
    self:ShowRank()
end

local function OnClickRankBackBtn(self)
    self:ShowIntro()
end

WorldSiegeThroneScorePanel.OnCreate = OnCreate
WorldSiegeThroneScorePanel.OnDestroy = OnDestroy
WorldSiegeThroneScorePanel.ComponentDefine = ComponentDefine
WorldSiegeThroneScorePanel.ComponentDestroy = ComponentDestroy
WorldSiegeThroneScorePanel.DataDefine = DataDefine
WorldSiegeThroneScorePanel.DataDestroy = DataDestroy

WorldSiegeThroneScorePanel.ShowPanel = ShowPanel
WorldSiegeThroneScorePanel.ShowRank = ShowRank
WorldSiegeThroneScorePanel.ShowIntro = ShowIntro
WorldSiegeThroneScorePanel.RefreshRankList = RefreshRankList
WorldSiegeThroneScorePanel.SetRankCellsDestroy = SetRankCellsDestroy
WorldSiegeThroneScorePanel.OnClickIntroBackBtn = OnClickIntroBackBtn
WorldSiegeThroneScorePanel.OnClickRankBackBtn = OnClickRankBackBtn

return WorldSiegeThroneScorePanel