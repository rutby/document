---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2023/4/24 16:31
---

local UIReserveToSoldierCtrl = BaseClass("UIReserveToSoldierCtrl", UIBaseCtrl)
local Localization = CS.GameEntry.Localization

local function __init(self)
    self.curSelect = {}
    self.leftNum = DataCenter.ArmyManager:GetArmyNumMax() - DataCenter.ArmyManager:GetTotalArmyNum()
end

local function __delete(self)
    self.curSelect = {}
    self.leftNum = 0
end

local function CloseSelf(self)
    UIManager:GetInstance():DestroyWindow(UIWindowNames.UIReServeToSoldier)
end

local function GetPanelData(self)
    local result = {}
    local all = DataCenter.ArmyManager:GetAllReserveArmy()
    for k, v in pairs(all) do
        local template = DataCenter.ArmyTemplateManager:GetArmyTemplate(k) 
        if v > 0 and template then
            local para = {}
            para.armyId = k
            para.maxNum = v
            para.icon = string.format(LoadPath.SoldierIcons, template.icon)
            para.name = Localization:GetString("111027", Localization:GetString(template.name))
            para.level = template.level
            table.insert(result, para)
        end
    end
    local soliderInfo = {}
    soliderInfo.max = DataCenter.ArmyManager:GetArmyNumMax()
    soliderInfo.current = DataCenter.ArmyManager:GetTotalArmyNum()
    return result, soliderInfo
end

local function GetCurrentSoldierNum(self, id)
    return self.curSelect[id] or 0
end

local function SetNumAndCheckMax(self, id, num)
    local total = 0
    for k, v in pairs(self.curSelect) do
        if id ~= k then
            total = total + v
        end
    end
    num = math.min(num, self.leftNum - total)
    num = math.max(num, 0)
    self.curSelect[id] = num
    return num
end

local function DoConvert(self)
    local total = 0
    for _, v in pairs(self.curSelect) do
        total = total + v
    end
    if total == 0 then
         return
    end
    SFSNetwork.SendMessage(MsgDefines.PrepareFillArmy, self.curSelect)
    self:CloseSelf()
end

UIReserveToSoldierCtrl.CloseSelf = CloseSelf
UIReserveToSoldierCtrl.GetPanelData = GetPanelData
UIReserveToSoldierCtrl.__init = __init
UIReserveToSoldierCtrl.__delete = __delete
UIReserveToSoldierCtrl.DoConvert = DoConvert
UIReserveToSoldierCtrl.GetCurrentSoldierNum = GetCurrentSoldierNum
UIReserveToSoldierCtrl.SetNumAndCheckMax = SetNumAndCheckMax

return UIReserveToSoldierCtrl