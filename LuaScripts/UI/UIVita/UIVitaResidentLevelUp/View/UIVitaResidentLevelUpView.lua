---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2024/3/18 20:59
---

local UIVitaResidentLevelUp = BaseClass("UIVitaResidentLevelUp", UIBaseView)
local base = UIBaseView

local close_path = "Bg/Close"
local return_path = "Panel"
local body_path = "Body"
local title_path = "Bg/Title"
local desc_path = "Bg/Desc"
local ok_path = "Bg/Ok"
local ok_text_path = "Bg/Ok/Vert/OkText"
local cost_icon_path = "Bg/Ok/Vert/Hori/CostIcon"
local cost_count_path = "Bg/Ok/Vert/Hori/CostCount"

local function OnCreate(self)
    base.OnCreate(self)
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    self:DataDestroy()
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.close_btn = self:AddComponent(UIButton, close_path)
    self.close_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.return_btn = self:AddComponent(UIButton, return_path)
    self.return_btn:SetOnClick(function()
        self.ctrl:CloseSelf()
    end)
    self.body_image = self:AddComponent(UIImage, body_path)
    self.title_text = self:AddComponent(UITextMeshProUGUIEx, title_path)
    self.desc_text = self:AddComponent(UITextMeshProUGUIEx, desc_path)
    self.ok_btn = self:AddComponent(UIButton, ok_path)
    self.ok_btn:SetOnClick(function()
        self:OnOkClick()
    end)
    self.ok_text = self:AddComponent(UITextMeshProUGUIEx, ok_text_path)
    self.ok_text:SetLocalText(320757)
    self.cost_icon_image = self:AddComponent(UIImage, cost_icon_path)
    self.cost_count_text = self:AddComponent(UITextMeshProUGUIEx, cost_count_path)
end

local function ComponentDestroy(self)

end

local function DataDefine(self)
    
end

local function DataDestroy(self)
    
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.ResourceUpdated, self.RefreshCost)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.ResourceUpdated, self.RefreshCost)
    base.OnRemoveListener(self)
end

local function ReInit(self)
    self.uuid = self:GetUserData()
    self.residentData = DataCenter.VitaManager:GetResidentData(self.uuid)
    local need = DataCenter.VitaManager:GetConfig(VitaDefines.ConfigKey.LevelUpNeedRes)[self.residentData.level]
    self.resType = need.resType
    self.count = need.count
    
    local icon = GetTableData(TableName.VitaResident, self.residentData.id, "half_body")
    local name = GetTableData(TableName.VitaResident, self.residentData.id, "name")
    local descStr = tostring(GetTableData(TableName.VitaResident, self.residentData.id, "level_up_message"))
    local desc = table.randomArrayValue(string.split(descStr, ";"))
    self.body_image:LoadSprite(string.format(LoadPath.UIGuideTalk, icon))
    self.title_text:SetLocalText(name)
    self.desc_text:SetLocalText(desc)
    
    self:RefreshCost()
end

local function RefreshCost(self)
    local have = LuaEntry.Resource:GetCntByResType(self.resType)
    self.enough = have >= self.count
    self.cost_icon_image:LoadSprite(DataCenter.ResourceManager:GetResourceIconByType(self.resType))
    self.cost_count_text:SetText(string.format("<color=%s>%s</color>/%s", self.enough and "white" or "red", string.GetFormattedStr(have), string.GetFormattedStr(self.count)))
end

local function Update(self)
    if self.residentData == nil then
        return
    end
    local data = DataCenter.CityResidentManager:GetData(self.uuid)
    if data and data:HasObj() then
        CS.SceneManager.World:AutoLookat(data:GetPos(), CityResidentZoom.Resident, 0.1)
    end
end

local function OnOkClick(self)
    if self.enough then
        DataCenter.VitaManager:SendLevelUp(self.uuid)
    else
        local lackTab = {}
        local param = {}
        param.type = ResLackType.Res
        param.id = self.resType
        param.targetNum = self.count
        table.insert(lackTab, param)
        GoToResLack.GoToItemResLackList(lackTab)
    end
end

UIVitaResidentLevelUp.OnCreate = OnCreate
UIVitaResidentLevelUp.OnDestroy = OnDestroy
UIVitaResidentLevelUp.OnEnable = OnEnable
UIVitaResidentLevelUp.OnDisable = OnDisable
UIVitaResidentLevelUp.ComponentDefine = ComponentDefine
UIVitaResidentLevelUp.ComponentDestroy = ComponentDestroy
UIVitaResidentLevelUp.DataDefine = DataDefine
UIVitaResidentLevelUp.DataDestroy = DataDestroy
UIVitaResidentLevelUp.OnAddListener = OnAddListener
UIVitaResidentLevelUp.OnRemoveListener = OnRemoveListener

UIVitaResidentLevelUp.ReInit = ReInit
UIVitaResidentLevelUp.RefreshCost = RefreshCost
UIVitaResidentLevelUp.Update = Update
UIVitaResidentLevelUp.OnOkClick = OnOkClick

return UIVitaResidentLevelUp