---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by 1.
--- DateTime: 2021/9/15 16:38
---

local base = UIBaseView--Variable
local UIHeroResetShopView = BaseClass("UIHeroResetShopView", base)--Variable
local Localization = CS.GameEntry.Localization
local ShopCell = require "UI.UIHeroResetShop.Component.ShopCell"
local title_path = "UICommonPopUpTitle/bg_mid/titleText"
local closeBtn_path = "UICommonPopUpTitle/bg_mid/CloseBtn"
local scroll_view_path = "ImgBg/ScrollView"
local content_path = "ImgBg/ScrollView/Content"
local const_img_path = "ImgBg/Top/refresh/refreshIcon"
local const_txt_path = "ImgBg/Top/refresh/refreshCost"
local intro_btn_path = "ImgBg/Top/Intro"

local function OnCreate(self)
    base.OnCreate(self)

    local signal = {ResourceType.Water,ResourceType.Metal,ResourceType.Electricity,ResourceType.Money}
    local param = {}
    param.list = signal
    param.uiName = UIWindowNames.UIHeroResetShop
    EventManager:GetInstance():Broadcast(EventId.ShowMainUIExtraResource,param)
    self.listGO = {}
    self:ComponentDefine()
    self:DataDefine()
end

local function OnDestroy(self)
    EventManager:GetInstance():Broadcast(EventId.HideMainUIExtraResource,UIWindowNames.UIHeroResetShop)
    self:ClearItemCell()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.titleN = self:AddComponent(UIText, title_path)
    self.titleN:SetLocalText(129224)
    self.closeBtnN = self:AddComponent(UIButton, closeBtn_path)
    self.closeBtnN:SetOnClick(function()
        self:OnClickCloseBtn()
    end)
    self.const_img = self:AddComponent(UIImage,const_img_path)
    self.const_txt = self:AddComponent(UIText,const_txt_path)

    self.intro_btn = self:AddComponent(UIButton, intro_btn_path)
    self.intro_btn:SetOnClick(function()
        self:OnIntroClick()
    end)
    
    self.scroll_view = self:AddComponent(UIBaseContainer, scroll_view_path)
    self.content = self:AddComponent(GridInfinityScrollView, content_path)
end

local function ComponentDestroy(self)
    self.titleN = nil
    self.closeBtnN = nil
    self.intro_btn = nil
    self.scroll_view = nil
    self.content = nil
    self.const_img:SetActive(false)
    self.const_img = nil
    self.const_txt = nil
end

local function DataDefine(self)
    self.isFirst = true
    SFSNetwork.SendMessage(MsgDefines.GetCommonShopInfo, CommonShopType.HeroReset)
end

local function DataDestroy(self)
    self.isFirst = nil
end


local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:AddUIListener(EventId.OnBuyCommonGoodsSucc, self.RefreshAll)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.UpdateOneCommonShop, self.RefreshAll)
    self:RemoveUIListener(EventId.OnBuyCommonGoodsSucc, self.RefreshAll)
    base.OnRemoveListener(self)
end

--活动说明
local function OnIntroClick(self)
    UIUtil.ShowIntro(Localization:GetString("129224"), Localization:GetString("302027"),Localization:GetString("104242"))
end

local function RefreshAll(self)
    self.goodsList = DataCenter.CommonShopManager:GetGoodsListByShopType(CommonShopType.HeroReset)
    if self.isFirst then
        self.isFirst = false
        local bindFunc1 = BindCallback(self, self.OnInitScroll)
        local bindFunc2 = BindCallback(self, self.OnUpdateScroll)
        local bindFunc3 = BindCallback(self, self.OnDestroyScrollItem)
        self.content:Init(bindFunc1,bindFunc2, bindFunc3)
        self.content:SetItemCount(#self.goodsList)
    else
        self.content:ForceUpdate()
    end
    if self.goodsList then
        local currency_change = nil
        for i = 1 ,#self.goodsList do
            if self.goodsList[i].itemId == "" then
                currency_change = self.goodsList[i].currency_change
            end
        end
        if currency_change then
            local goods = DataCenter.ItemTemplateManager:GetItemTemplate(currency_change)
            if goods then
                self.const_img:SetActive(true)
                self.const_img:LoadSprite(string.format(LoadPath.ItemPath, goods.icon))
            end
            local item = DataCenter.ItemData:GetItemById(currency_change)
            if item then
                self.const_txt:SetText(string.GetFormattedSeperatorNum(tonumber(item.count)))
            else
                self.const_txt:SetText(0)
            end
        end
    end
end

local function OnInitScroll(self,go,index)
    local item = self.scroll_view:AddComponent(ShopCell, go)
    self.listGO[go] = item
end

local function OnUpdateScroll(self,go,index)
    local conf = self.goodsList[index + 1]
    go.name = conf.id
    local cellItem = self.listGO[go]
    if not cellItem then
        return
    end
    cellItem:SetItem(self.goodsList[index + 1])
end

local function OnDestroyScrollItem(self,go, index)

end

local function ClearItemCell(self)
    self.scroll_view:RemoveComponents(ShopCell)
    self.content:DestroyChildNode()
end

local function OnClickCloseBtn(self)
    self.ctrl:CloseSelf()
end

UIHeroResetShopView.OnCreate = OnCreate
UIHeroResetShopView.OnDestroy = OnDestroy
UIHeroResetShopView.OnAddListener = OnAddListener
UIHeroResetShopView.OnRemoveListener = OnRemoveListener
UIHeroResetShopView.ComponentDefine = ComponentDefine
UIHeroResetShopView.ComponentDestroy = ComponentDestroy
UIHeroResetShopView.DataDefine = DataDefine
UIHeroResetShopView.DataDestroy = DataDestroy

UIHeroResetShopView.RefreshAll = RefreshAll
UIHeroResetShopView.OnIntroClick = OnIntroClick
UIHeroResetShopView.OnInitScroll = OnInitScroll
UIHeroResetShopView.OnUpdateScroll = OnUpdateScroll
UIHeroResetShopView.OnDestroyScrollItem = OnDestroyScrollItem
UIHeroResetShopView.ClearItemCell = ClearItemCell
UIHeroResetShopView.OnClickCloseBtn = OnClickCloseBtn

return UIHeroResetShopView