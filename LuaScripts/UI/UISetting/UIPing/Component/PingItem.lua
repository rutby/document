---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Imaginaerum.
--- DateTime: 2022/9/6 16:47
---
local PingItem = BaseClass("PingItem", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

-- 创建
function PingItem:OnCreate()
    base.OnCreate(self)
    self._name_txt = self:AddComponent(UIText,"Txt_name")
    self._des = self:AddComponent(UIText,"Txt_result")
    self.btn = self:AddComponent(UIButton, "challengeBtn")
    self.btn:SetOnClick(function()
        self:OnPingClick()
    end)
    self.pingScript = self.transform:Find(""):GetComponent(typeof(CS.UnityPing))
    self.timer = nil
    self.timer_action = function(temp)
        self:RefreshTime()
    end
    self.pingCount = 0
    self.receiveCount = 0
    self.totalCount = 0
    self.ReceiveList = {}
end

-- 销毁
function PingItem:OnDestroy()
    self:DeleteTimer()
    base.OnDestroy(self)
end

-- 显示
function PingItem:OnEnable()
    base.OnEnable(self)
end

-- 隐藏
function PingItem:OnDisable()
    base.OnDisable(self)
end

function PingItem:InitData(url,name)
    self.url = url
    self._name_txt:SetText(name)
    self._des:SetText("")
end

function PingItem:OnChooseClick()
    self:OnPingClick()
end


function PingItem:DeleteTimer()
    if self.timer ~= nil then
        self.timer:Stop()
        self.timer = nil
    end
end

function PingItem:AddTimer()
    if self.timer == nil then
        self.timer = TimerManager:GetInstance():GetTimer(2, self.timer_action, self, false,false,false)
    end

    self.timer:Start()
end

function PingItem:RefreshTime()
    self.pingCount = self.pingCount-1
    if self.pingCount>=0 then
        self.pingScript:CreatePing(self.url,function(time)
            self:OnReceiveTime(time)
        end)
    else
        self:DeleteTimer()
    end
end

function PingItem:OnReceiveTime(time)
    Logger.Log("receive time"..time)
    self.receiveCount = self.receiveCount-1
    if time>0 then
        table.insert(self.ReceiveList,time)
    end
    if self.receiveCount<=0 then
        self:ShowResult()
    end
end

function PingItem:ShowResult()
    local min= 0
    local max = 0
    local average = 0
    local receiveCount = #self.ReceiveList
    local sendCount = self.totalCount
    local lostCount = sendCount-receiveCount
    if receiveCount>0 then
        table.sort(self.ReceiveList,function(a,b)
            return a<b
        end)
        min = self.ReceiveList[1]
        max = self.ReceiveList[#self.ReceiveList]
        local count = 0
        for i = 1,receiveCount do
            count = count+self.ReceiveList[i]
        end
        average = count/receiveCount
    end
    local str = string.format("数据包:已发送=%d 已接收=%d 丢失=%d \n 最短=%.2fms 最长=%.2fms 平均=%.2fms",sendCount,receiveCount,lostCount,min,max,average)
    self._des:SetText(str)
    self:ResetData()
end

function PingItem:OnPingClick()
    self:ResetData()
    local pingCount = self.view:GetPingCount()
    if pingCount<=0 then
        pingCount = 20
    end
    self.pingCount = pingCount
    self.receiveCount = pingCount
    self.totalCount = pingCount
    self.ReceiveList = {}
    self._des:SetText("数据收集中")
    self:AddTimer()
    self:RefreshTime()
end

function PingItem:ResetData()
    self.pingCount = 0
    self.receiveCount = 0
    self.totalCount = 0
    self.ReceiveList = {}
    self:DeleteTimer()
end
return PingItem