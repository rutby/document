---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/2/14 16:36
---

local UIPackBar = BaseClass("UIPackBar", UIBaseContainer)
local base = UIBaseContainer
local UIGiftPackagePoint = require "UI.UIGiftPackage.Component.UIGiftPackagePoint"

local bg_path = "Bg"
local name_path = "Bg/Name"
local mask_path = "Bg/Mask"
local desc_path = "Bg/Mask/Desc"
local icon_path = "Bg/Icon"
local buy_btn_path = "Bg/Buy"
local buy_text_path = "Bg/Buy/BuyText"
local point_path = "Bg/UIGiftPackagePoint"

local SCROLL_DURATION = 2
local WAIT_DURATION = 2

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.bg_go = self:AddComponent(UIBaseContainer, bg_path)
    self.name_text = self:AddComponent(UIText, name_path)
    self.mask_go = self:AddComponent(UIBaseContainer, mask_path)
    self.desc_text = self:AddComponent(UIText, desc_path)
    self.icon_image = self:AddComponent(UIImage, icon_path)
    self.buy_btn = self:AddComponent(UIButton, buy_btn_path)
    self.buy_btn:SetOnClick(function()
        self:OnBuyClick()
    end)
    self.buy_text = self:AddComponent(UIText, buy_text_path)
    self.point_rect = self:AddComponent(UIGiftPackagePoint, point_path)
end

local function ComponentDestroy(self)
    self.bg_go = nil
    self.name_text = nil
    self.mask_go = nil
    self.desc_text = nil
    self.icon_image = nil
    self.buy_btn = nil
    self.buy_text = nil
    self.point_rect = nil
end

local function DataDefine(self)
    self.data = nil
    self.seq = nil
end

local function DataDestroy(self)
    self.data = nil
    if self.seq then
        self.seq:Kill()
        self.seq = nil
    end
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function SetData(self, data)
    self.data = data
    self:Refresh()
end

local function Refresh(self)
    if self.data == nil then
        self.bg_go:SetActive(false)
        return
    end
    
    local pack = GiftPackManager.get(self.data.packId)
    if pack == nil or pack:isBought() then
        self.bg_go:SetActive(false)
        return
    end
    
    self.bg_go:SetActive(true)
    self.name_text:SetText(self.data.name)
    self.desc_text:SetText(self.data.desc)
    self.icon_image:LoadSprite(self.data.icon)
    self.buy_text:SetText(DataCenter.PayManager:GetDollarText(pack:getPrice(), pack:getProductID()))
    self.point_rect:RefreshPoint(pack)

    CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.desc_text.rectTransform)
    local x = self.desc_text.rectTransform.sizeDelta.x - self.mask_go.rectTransform.sizeDelta.x
    if self.seq then
        self.seq:Kill()
    end
    if x > 0 then
        self.seq = DOTween.Sequence()
        self.seq:AppendCallback(function()
            self.desc_text.rectTransform.localPosition = Vector2.New(0, 0)
        end)
        self.seq:AppendInterval(WAIT_DURATION)
        self.seq:Append(self.desc_text.rectTransform:DOLocalMoveX(-x, SCROLL_DURATION))
        self.seq:AppendInterval(WAIT_DURATION)
        self.seq:SetLoops(-1)
    end
end

local function OnBuyClick(self)
    local pack = GiftPackManager.get(self.data.packId)
    if pack ~= nil and not pack:isBought() then
        DataCenter.PayManager:BuyGift(pack)
    end
end

UIPackBar.OnCreate= OnCreate
UIPackBar.OnDestroy = OnDestroy
UIPackBar.ComponentDefine = ComponentDefine
UIPackBar.ComponentDestroy = ComponentDestroy
UIPackBar.DataDefine = DataDefine
UIPackBar.DataDestroy = DataDestroy
UIPackBar.OnAddListener = OnAddListener
UIPackBar.OnRemoveListener = OnRemoveListener
UIPackBar.OnEnable = OnEnable
UIPackBar.OnDisable = OnDisable

UIPackBar.SetData = SetData
UIPackBar.Refresh = Refresh
UIPackBar.OnBuyClick = OnBuyClick

return UIPackBar