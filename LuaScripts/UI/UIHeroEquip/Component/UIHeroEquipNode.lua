---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by admin.
--- DateTime: 2024/3/28 12:59
---
local UIHeroEquipNode = BaseClass("UIHeroEquipNode",UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

local UIHeroEquipSlot = require "UI.UIHeroEquip.Component.UIHeroEquipSlot"
local UIHeroEquipCell = require "UI.UIHeroEquip.Component.UIHeroEquipCell"

local equip_slot_path = "icon/UIHeroEquipSlot%s"
local equip_path = "icon/UIHeroEquipCell%s"
local install_btn_path = "InstallBtn"
local install_text_path = "InstallBtn/InstallBtnText"
local uninstall_btn_path = "UninstallBtn"
local uninstall_text_path = "UninstallBtn/UninstallBtnText"
local install_red_path = "InstallBtn/RedPointNum"

function UIHeroEquipNode:OnCreate()
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

function UIHeroEquipNode:OnDestroy()
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

function UIHeroEquipNode:DataDefine()
    self.equipSlot = {}
    self.equipCell = {}
    self.heroId = 0
end

function UIHeroEquipNode:DataDestroy()
    self.equipSlot = {}
    self.equipCell = {}
    self.heroId = 0
end

function UIHeroEquipNode:ComponentDefine()
    for i = 1, HeroEquipConst.EquipSlot do
        self.equipSlot[i] = self:AddComponent(UIHeroEquipSlot, string.format(equip_slot_path, i))
        self.equipCell[i] = self:AddComponent(UIHeroEquipCell, string.format(equip_path, i))
    end

    self:DefineBtn()
    self.installRed = self:AddComponent(UIBaseContainer, install_red_path)
end

function UIHeroEquipNode:ComponentDestroy()

end

function UIHeroEquipNode:SetData(heroId)
    self.heroId = heroId
    
    self:RefreshEquips()
end

function UIHeroEquipNode:OnAddListener()
    base.OnAddListener(self)
    self:AddUIListener(EventId.HeroEquipInstall, self.RefreshEquips)
    self:AddUIListener(EventId.HeroEquipUninstall, self.RefreshEquips)
end

function UIHeroEquipNode:OnRemoveListener()
    base.OnRemoveListener(self)
    self:RemoveUIListener(EventId.HeroEquipInstall, self.RefreshEquips)
    self:RemoveUIListener(EventId.HeroEquipUninstall, self.RefreshEquips)
end

function UIHeroEquipNode:RefreshEquips()
    table.walk(self.equipSlot,function(slot, cell)
        cell:SetData(self.heroId, slot, function()
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroEquipReplace, { anim = true,isBlur = true },self.heroId, slot)
        end)
        cell:CheckRed()
    end)
    table.walk(self.equipCell,function(slot, cell)
        local equip = DataCenter.HeroEquipManager:GetEquipByHeroIdAndSlot(self.heroId, slot)
        if equip == nil then
            self.equipSlot[slot]:SetActive(true)
            cell:SetActive(false)
        else
            self.equipSlot[slot]:SetActive(false)
            cell:SetActive(true)
            cell:SetData(equip, function()
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIHeroEquipInfo, NormalBlurPanelAnim, equip.uuid)
            end)
            cell:CheckArrow()
        end
    end)

    local suggestList = DataCenter.HeroEquipManager:GetSuggestUnEquipUuidListByHeroId(self.heroId)
    local hasSuggest = #suggestList > 0
    self.installBtn:SetInteractable(hasSuggest)
    self.installRed:SetActive(hasSuggest)
    local wearList = DataCenter.HeroEquipManager:GetWearEquipUuidListByHeroId(self.heroId)
    self.uninstallBtn:SetInteractable(#wearList > 0)
end

function UIHeroEquipNode:DefineBtn()
    self.installBtn = self:AddComponent(UIButton, install_btn_path)
    self.installBtn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnInstallBtnClick()
    end)
    self.installBtnText = self:AddComponent(UITextMeshProUGUIEx, install_text_path)
    self.installBtnText:SetLocalText(GameDialogDefine.HERO_EQUIP25)
    
    self.uninstallBtn = self:AddComponent(UIButton, uninstall_btn_path)
    self.uninstallBtn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnUninstallBtnClick()
    end)
    self.uninstallBtnText = self:AddComponent(UITextMeshProUGUIEx, uninstall_text_path)
    self.uninstallBtnText:SetLocalText(GameDialogDefine.HERO_EQUIP24)
end

function UIHeroEquipNode:OnInstallBtnClick()
    local suggestList = DataCenter.HeroEquipManager:GetSuggestUnEquipUuidListByHeroId(self.heroId)
    DataCenter.HeroEquipManager:HeroEquipInstall(self.heroId, suggestList);
end

function UIHeroEquipNode:OnUninstallBtnClick()
    local wearList = DataCenter.HeroEquipManager:GetWearEquipUuidListByHeroId(self.heroId)
    DataCenter.HeroEquipManager:HeroEquipUninstall(self.heroId, wearList);
end

return UIHeroEquipNode