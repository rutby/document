---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/3/13 15:20
---

local UIMasteryOverviewItem = BaseClass("UIMasteryOverviewItem", UIBaseContainer)
local base = UIBaseContainer
local UIMasteryOverviewLine = require "UI.UIMasteryOverview.Component.UIMasteryOverviewLine"
local Localization = CS.GameEntry.Localization

local icon_path = "Head/Icon"
local title_path = "Head/Title"
local list_path = "List"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:DataDestroy()
    self:ComponentDestroy()
    base.OnDestroy(self)
end

local function ComponentDefine(self)
    self.icon_image = self:AddComponent(UIImage, icon_path)
    self.title_text = self:AddComponent(UIText, title_path)
    self.list_go = self:AddComponent(UIBaseContainer, list_path)
end

local function ComponentDestroy(self)
    self.icon_image = nil
    self.title_text = nil
    self.list_go = nil
end

local function DataDefine(self)
    self.home = 0
    self.lineReqs = {}
end

local function DataDestroy(self)
    self.home = nil
    self:ClearLines()
    self.lineReqs = nil
end

local function OnEnable(self)
    base.OnEnable(self)
end

local function OnDisable(self)
    base.OnDisable(self)
end

local function OnAddListener(self)
    base.OnAddListener(self)
end

local function OnRemoveListener(self)
    base.OnRemoveListener(self)
end

local function SetData(self, home)
    self.home = home
    self.title_text:SetLocalText(MasteryHomeTitle[home])
    self.icon_image:LoadSprite(LoadPath.UIMastery .. "UImaster_icon_" .. home .. "_small")
    self:ShowLines()
end

local function ShowLines(self)
    self:ClearLines()
    local plan = DataCenter.MasteryManager:GetCurPlan()
    local effectDict, effectList = {}, {}
    local groups = DataCenter.MasteryManager:GetGroupsByHome(self.home)
    for _, group in ipairs(groups) do
        local level = plan:GetGroupLevel(group)
        if level > 0 then
            local template = DataCenter.MasteryManager:GetTemplate(group, level)
            if template.tempData:getValue("overview") == 1 then
                local tEffectDict = template.tempData.extraPara
                for effectId, val in pairs(tEffectDict) do
                    effectDict[effectId] = (effectDict[effectId] or 0) + val
                end
            end
        end
    end
    for effectId, val in pairs(effectDict) do
        table.insert(effectList, { effectId = effectId, val = val })
    end
    table.sort(effectList, function(a, b)
        return a.effectId < b.effectId
    end)
    for i, v in pairs(effectList) do
        local type = GetTableData("effect_num_des", v.effectId, "type")
        local desc = GetTableData("effect_num_des", v.effectId, "des")
        local leftText = string.IsNullOrEmpty(desc) and tostring(v.effectId) or Localization:GetString(desc)
        local rightText = UIUtil.GetEffectNumByType(v.val, type)
        local isFinal = (i == #effectList)
        self.lineReqs[i] = self:GameObjectInstantiateAsync(UIAssets.UIMasteryOverviewLine, function(req)
            if req.isError then
                return
            end
            
            local go = req.gameObject
            go.name = tostring(v.effectId)
            go:SetActive(true)
            go.transform:SetParent(self.list_go.transform)
            go.transform:Set_localScale(ResetScale.x, ResetScale.y, ResetScale.z)
            
            local line = self.list_go:AddComponent(UIMasteryOverviewLine, go.name)
            line:SetData(leftText, rightText, isFinal)
            CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.list_go.transform)
            CS.UnityEngine.UI.LayoutRebuilder.ForceRebuildLayoutImmediate(self.transform)
        end)
    end
end

local function ClearLines(self)
    self.list_go:RemoveComponents(UIMasteryOverviewLine)
    for _, req in pairs(self.lineReqs) do
        req:Destroy()
    end
end

UIMasteryOverviewItem.OnCreate= OnCreate
UIMasteryOverviewItem.OnDestroy = OnDestroy
UIMasteryOverviewItem.ComponentDefine = ComponentDefine
UIMasteryOverviewItem.ComponentDestroy = ComponentDestroy
UIMasteryOverviewItem.DataDefine = DataDefine
UIMasteryOverviewItem.DataDestroy = DataDestroy
UIMasteryOverviewItem.OnEnable = OnEnable
UIMasteryOverviewItem.OnDisable = OnDisable
UIMasteryOverviewItem.OnAddListener = OnAddListener
UIMasteryOverviewItem.OnRemoveListener = OnRemoveListener

UIMasteryOverviewItem.SetData = SetData
UIMasteryOverviewItem.ShowLines = ShowLines
UIMasteryOverviewItem.ClearLines = ClearLines

return UIMasteryOverviewItem