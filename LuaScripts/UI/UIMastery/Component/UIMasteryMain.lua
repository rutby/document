---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Beef.
--- DateTime: 2023/6/7 14:26
---

local UIMasteryMain = BaseClass("UIMasteryMain", UIBaseContainer)
local base = UIBaseContainer
local UIMasteryPoint = require "UI.UIMastery.Component.UIMasteryPoint"
local UIMasteryPlan = require "UI.UIMastery.Component.UIMasteryPlan"
local UIMasteryLevel = require "UI.UIMastery.Component.UIMasteryLevel"
local UIMasteryPage = require "UI.UIMastery.Component.UIMasteryPage"
local Localization = CS.GameEntry.Localization
local UIGray = CS.UIGray

local title_path = "Title"
local info_path = "Title/Info"
local gather_path = "Gather"
local gather_num_path = "Gather/GatherNum"
local gather_name_path = "GatherName"
local build_path = "Build"
local build_num_path = "Build/BuildNum"
local build_name_path = "BuildName"
local battle_path = "Battle"
local battle_num_path = "Battle/BattleNum"
local battle_name_path = "BattleName"
local overview_btn_path = "Overview"
local overview_text_path = "Overview/OverviewText"
local skill_btn_path = "Skill"
local skill_text_path = "Skill/SkillText"
local point_path = "UIMasteryPoint"
local plan_path = "UIMasteryPlan"
local level_path = "UIMasteryLevel"
local page_path = "UIMasteryPage"
local pageTemp_path = "UIMasteryPageTemp"
local tempTips_path = "UIMasteryPageTemp/Txt_TempTips"
local tempTitle_path = "UIMasteryPageTemp/Txt_TempTitle"

local function OnCreate(self)
    base.OnCreate(self)
    self:DataDefine()
    self:ComponentDefine()
end

local function OnDestroy(self)
    self:ComponentDestroy()
    self:DataDestroy()
    base.OnDestroy(self)
end

local function OnEnable(self)
    base.OnEnable(self)
    self:ReInit()
end

local function OnDisable(self)
    DataCenter.MasteryManager:SetMasteryTempPage(0)
    EventManager:GetInstance():Broadcast(EventId.MasteryUpdate)
    base.OnDisable(self)
end

local function ComponentDefine(self)
    self.title_text = self:AddComponent(UIText, title_path)
    self.title_text:SetLocalText(110700)
    self.info_btn = self:AddComponent(UIButton, info_path)
    self.info_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnInfoClick()
    end)
    self.gather_btn = self:AddComponent(UIButton, gather_path)
    self.gather_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnGatherClick()
    end)
    self.gather_num_text = self:AddComponent(UIText, gather_num_path)
    self.gather_name_text = self:AddComponent(UIText, gather_name_path)
    self.gather_name_text:SetLocalText(110716)
    self.build_btn = self:AddComponent(UIButton, build_path)
    self.build_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBuildClick()
    end)
    self.build_num_text = self:AddComponent(UIText, build_num_path)
    self.build_name_text = self:AddComponent(UIText, build_name_path)
    self.build_name_text:SetLocalText(110717)
    self.battle_btn = self:AddComponent(UIButton, battle_path)
    self.battle_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnBattleClick()
    end)
    self.battle_num_text = self:AddComponent(UIText, battle_num_path)
    self.battle_name_text = self:AddComponent(UIText, battle_name_path)
    self.battle_name_text:SetLocalText(110718)
    self.overview_btn = self:AddComponent(UIButton, overview_btn_path)
    self.overview_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnOverviewClick()
    end)
    self.overview_text = self:AddComponent(UIText, overview_text_path)
    self.overview_text:SetLocalText(110707)
    self.skill_btn = self:AddComponent(UIButton, skill_btn_path)
    self.skill_btn:SetOnClick(function()
        SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
        self:OnSkillClick()
    end)
    self.skill_text = self:AddComponent(UIText, skill_text_path)
    self.skill_text:SetLocalText(150106)
    self.point = self:AddComponent(UIMasteryPoint, point_path)
    self.plan = self:AddComponent(UIMasteryPlan, plan_path)
    self.level = self:AddComponent(UIMasteryLevel, level_path)
    self.page = self:AddComponent(UIMasteryPage,page_path)
    
    self.pageTemp = self:AddComponent(UIBaseContainer,pageTemp_path)
    self._tempTips_txt = self:AddComponent(UIText,tempTips_path)
    self._tempTitle_txt = self:AddComponent(UIText,tempTitle_path)
    self._tempTips_txt:SetLocalText(111039)
end

local function ComponentDestroy(self)
    local rootRt = self.pageTemp.rectTransform
    DOTween.Kill(rootRt)
    rootRt:Set_localScale(1, 1, 0)
    self.back_btn = nil
    self.title_text = nil
    self.info_btn = nil
    self.gather_btn = nil
    self.gather_num_text = nil
    self.gather_name_text = nil
    self.build_btn = nil
    self.build_num_text = nil
    self.build_name_text = nil
    self.battle_btn = nil
    self.battle_num_text = nil
    self.battle_name_text = nil
    self.overview_btn = nil
    self.overview_text = nil
    self.skill_btn = nil
    self.skill_text = nil
    self.point = nil
    self.plan = nil
    self.level = nil
end

local function DataDefine(self)
    DataCenter.MasteryManager:SetMasteryTempPage(0)
end

local function DataDestroy(self)
    
end

local function OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(EventId.MasteryLearn, self.Refresh)
    self:AddUIListener(EventId.MasteryReset, self.Refresh)
    self:AddUIListener(EventId.MasteryUpdate, self.Refresh)
    self:AddUIListener(EventId.MasteryChangePlan, self.Refresh)
    self:AddUIListener(EventId.MasteryChangeName, self.ChangePageName)
    self:AddUIListener(EventId.UpdateGiftPackData, self.OnBuyPackage)
end

local function OnRemoveListener(self)
    self:RemoveUIListener(EventId.MasteryLearn, self.Refresh)
    self:RemoveUIListener(EventId.MasteryReset, self.Refresh)
    self:RemoveUIListener(EventId.MasteryUpdate, self.Refresh)
    self:RemoveUIListener(EventId.MasteryChangePlan, self.Refresh)
    self:RemoveUIListener(EventId.MasteryChangeName, self.ChangePageName)
    self:RemoveUIListener(EventId.UpdateGiftPackData, self.OnBuyPackage)
    base.OnRemoveListener(self)
end

local function ReInit(self)
    self:Refresh()
end

local function Refresh(self,refreshType)
    local plan = DataCenter.MasteryManager:GetCurPlan()
    
    local isGatherOpen, gatherNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Gather)
    if isGatherOpen then
        UIGray.SetGray(self.gather_btn.transform, false, true)
        local gatherLv = plan:GetUsePointByHome(MasteryHome.Gather)
        self.gather_num_text:SetText(string.GetFormattedSeperatorNum(gatherLv))
    else
        UIGray.SetGray(self.gather_btn.transform, true, true)
        self.gather_num_text:SetLocalText(300505, gatherNeedLv)
    end
    
    local isBuildOpen, buildNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Build)
    if isBuildOpen then
        UIGray.SetGray(self.build_btn.transform, false, true)
        local buildLv = plan:GetUsePointByHome(MasteryHome.Build)
        self.build_num_text:SetText(string.GetFormattedSeperatorNum(buildLv))
    else
        UIGray.SetGray(self.build_btn.transform, true, true)
        self.build_num_text:SetLocalText(300505, buildNeedLv)
    end
    
    local isBattleOpen, battleNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Battle)
    if isBattleOpen then
        UIGray.SetGray(self.battle_btn.transform, false, true)
        local battleLv = plan:GetUsePointByHome(MasteryHome.Battle)
        self.battle_num_text:SetText(string.GetFormattedSeperatorNum(battleLv))
    else
        UIGray.SetGray(self.battle_btn.transform, true, true)
        self.battle_num_text:SetLocalText(300505, battleNeedLv)
    end
    
    self.point:Refresh()
    self.plan:Refresh()
    self.level:Refresh()
    self.page:Refresh(refreshType)
    local tempPlanIndex = DataCenter.MasteryManager:GetTempPlanIndex()
    if tempPlanIndex and tempPlanIndex ~= 0 and tempPlanIndex ~= DataCenter.MasteryManager:GetCurPlanIndex() then
        self.pageTemp:SetActive(true)
        
        local rootRt = self.pageTemp.rectTransform
        DOTween.Kill(rootRt)
        rootRt:Set_localScale(0, 1, 0)
        rootRt:DOScale(Vector3.New(1, 1, 0), 0.3):SetEase(CS.DG.Tweening.Ease.InOutCubic)
        
        local name = DataCenter.MasteryManager:GetPageName(tempPlanIndex)
        if name == "" then
            self._tempTitle_txt:SetLocalText(111038,Localization:GetString("110704",tempPlanIndex))
        else
            self._tempTitle_txt:SetLocalText(111038,name)
        end
    else
        self.pageTemp:SetActive(false)
    end
end


local function OnBuyPackage(self)
    self.page:Refresh()
end

local function ChangePageName(self)
    self.page:UpdateName()
end

local function OnInfoClick(self)
    UIUtil.ShowIntro(Localization:GetString("110700"), "", Localization:GetString("110721"))
end

local function OnGatherClick(self)
    DataCenter.MasteryManager:ShowHome(MasteryHome.Gather)
end

local function OnBuildClick(self)
    DataCenter.MasteryManager:ShowHome(MasteryHome.Build)
end

local function OnBattleClick(self)
    DataCenter.MasteryManager:ShowHome(MasteryHome.Battle)
end

local function OnOverviewClick(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIMasteryOverview)
end

local function OnSkillClick(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIMasterySkill)
end

UIMasteryMain.OnCreate = OnCreate
UIMasteryMain.OnDestroy = OnDestroy
UIMasteryMain.OnEnable = OnEnable
UIMasteryMain.OnDisable = OnDisable
UIMasteryMain.ComponentDefine = ComponentDefine
UIMasteryMain.ComponentDestroy = ComponentDestroy
UIMasteryMain.DataDefine = DataDefine
UIMasteryMain.DataDestroy = DataDestroy
UIMasteryMain.OnAddListener = OnAddListener
UIMasteryMain.OnRemoveListener = OnRemoveListener

UIMasteryMain.ReInit = ReInit
UIMasteryMain.Refresh = Refresh
UIMasteryMain.ChangePageName = ChangePageName
UIMasteryMain.OnBuyPackage = OnBuyPackage
UIMasteryMain.OnInfoClick = OnInfoClick
UIMasteryMain.OnGatherClick = OnGatherClick
UIMasteryMain.OnBuildClick = OnBuildClick
UIMasteryMain.OnBattleClick = OnBattleClick
UIMasteryMain.OnOverviewClick = OnOverviewClick
UIMasteryMain.OnSkillClick = OnSkillClick

return UIMasteryMain