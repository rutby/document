---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zzl
--- DateTime: 2023/4/23 17:35
---

local MasteryPage = BaseClass("MasteryPage", UIBaseContainer)
local base = UIBaseContainer
local Localization = CS.GameEntry.Localization

function MasteryPage:OnCreate()
	base.OnCreate(self)
	self:DataDefine()
	self:ComponentDefine()
end
  
function MasteryPage:OnDestroy()
	self:ComponentDestroy()
	self:DataDestroy()
	base.OnDestroy(self)
end

function MasteryPage:ComponentDefine()
	
	self._masteryPage_btn = self:AddComponent(UIButton,"")
	self._masteryPage_btn:SetOnClick(function()
		SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
		self:OnChangePage()
	end)
	
	self._pageName_txt = self:AddComponent(UIText,"Txt_PageName")
	self._pageName_btn = self:AddComponent(UIButton,"Txt_PageName/Btn_PageName")
	self._pageName_btn:SetOnClick(function()
		SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
		self:OnChangeNameClick()
	end)
	
	self._typePageLv1_txt = self:AddComponent(UIText,"Txt_TypePageLv1")
	self._typePageLv2_txt = self:AddComponent(UIText,"Txt_TypePageLv2")
	self._typePageLv3_txt = self:AddComponent(UIText,"Txt_TypePageLv3")
	
	self._bg_img = self:AddComponent(UIImage,"Img_Bg")
	self._select_rect = self:AddComponent(UIBaseContainer,"Img_Bg/Rect_Select")
	
	self._lock_rect = self:AddComponent(UIBaseContainer,"Rect_Lock")
	self._lock_btn = self:AddComponent(UIButton,"Btn_Unlock")
	self._lock_btn:SetOnClick(function()
		SoundUtil.PlayEffect(SoundAssets.Music_Effect_Button)
		self:OnClickLock()
	end)
	self._lock_txt = self:AddComponent(UIText,"Btn_Unlock/Txt_Unlock")
	self._lock_txt:SetLocalText(130056)
end

function MasteryPage:ComponentDestroy()

end

function MasteryPage:DataDefine()

end

function MasteryPage:DataDestroy()

end

function MasteryPage:OnEnable()
	base.OnEnable(self)
end

function MasteryPage:OnDisable()
	base.OnDisable(self)
end

function MasteryPage:Refresh(index,callBack,isPack)
	self.callBack = callBack
	self:RefreshView(index,isPack)

end

function MasteryPage:RefreshView(index,isPack)
	self.index = index
	self.isPack = isPack
	--页签名字
	local name = DataCenter.MasteryManager:GetPageName(index)
	if name == "" then
		self._pageName_txt:SetLocalText(110704,index)
	else
		self._pageName_txt:SetText(name)
	end
	
	self._lock_rect:SetActive(isPack)
	self._lock_btn:SetActive(isPack)
	self._typePageLv1_txt:SetActive(not isPack)
	self._typePageLv2_txt:SetActive(not isPack)
	self._typePageLv3_txt:SetActive(not isPack)

	--检查当时是预览页还是本页
	local curPlanIndex = DataCenter.MasteryManager:GetCurPlanIndex()
	if index == curPlanIndex then
		self._bg_img:LoadSprite(LoadPath.UIMastery.."UImaster_icon_talent01")
	else
		self._bg_img:LoadSprite(LoadPath.UIMastery.."UImaster_icon_talent02")
	end

	local tempPlanIndex = DataCenter.MasteryManager:GetTempPlanIndex()
	if tempPlanIndex and tempPlanIndex ~= 0 and tempPlanIndex ~= curPlanIndex then
		curPlanIndex = tempPlanIndex
	end

	if index == curPlanIndex then
		self._select_rect:SetActive(true)
	else
		self._select_rect:SetActive(false)
	end
	local plan = DataCenter.MasteryManager:GetPlan(index)
	local isGatherOpen, gatherNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Gather)
	local isBuildOpen, buildNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Build)
	local isBattleOpen, battleNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Battle)
	if isGatherOpen then
		self._typePageLv1_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Gather)))
	else
		self._typePageLv1_txt:SetText(isPack and "" or 0)
	end
	if isBuildOpen then
		self._typePageLv2_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Build)))
	else
		self._typePageLv2_txt:SetText(isPack and "" or 0)
	end
	if isBattleOpen then
		self._typePageLv3_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Battle)))
	else
		self._typePageLv3_txt:SetText(isPack and "" or 0)
	end
end

--预览页签
function MasteryPage:RefreshSetTempPage(index)
	local tempPlanIndex = DataCenter.MasteryManager:GetTempPlanIndex()
	if tempPlanIndex and index == tempPlanIndex then
		self._select_rect:SetActive(true)
	else
		self._select_rect:SetActive(false)
	end
end

--重命名
function MasteryPage:OnChangeNameClick()
	if self.isPack then
		return
	end
	UIManager:GetInstance():OpenWindow(UIWindowNames.UIMasteryPageName,self.index)
end

--预览页签
function MasteryPage:OnChangePage()

	if self.isPack then
		return
	end
	
	local tempPlanIndex = DataCenter.MasteryManager:GetTempPlanIndex()
	if tempPlanIndex and self.index == tempPlanIndex then
		return
	else
		self._select_rect:SetActive(true)
		if self.callBack ~= nil then
			self.callBack(self.index)
		end
	end
end

--更新名字
function MasteryPage:UpdateName(index)
	local name = DataCenter.MasteryManager:GetPageName(index)
	if name == "" then
		self._pageName_txt:SetLocalText(110704,index)
	else
		self._pageName_txt:SetText(name)
	end
end

function MasteryPage:UpdateLv(index,isPack)
	self.isPack = isPack
	self._lock_rect:SetActive(isPack)
	self._lock_btn:SetActive(isPack)
	self._typePageLv1_txt:SetActive(not isPack)
	self._typePageLv2_txt:SetActive(not isPack)
	self._typePageLv3_txt:SetActive(not isPack)
	
	local plan = DataCenter.MasteryManager:GetPlan(index)
	local isGatherOpen, gatherNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Gather)
	local isBuildOpen, buildNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Build)
	local isBattleOpen, battleNeedLv = DataCenter.MasteryManager:IsHomeOpen(MasteryHome.Battle)
	if isGatherOpen then
		self._typePageLv1_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Gather)))
	else
		self._typePageLv1_txt:SetText(0)
	end
	if isBuildOpen then
		self._typePageLv2_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Build)))
	else
		self._typePageLv2_txt:SetText(0)
	end
	if isBattleOpen then
		self._typePageLv3_txt:SetText(string.GetFormattedSeperatorNum(plan:GetUsePointByHome(MasteryHome.Battle)))
	else
		self._typePageLv3_txt:SetText(0)
	end
end

function MasteryPage:OnClickLock()
	local packs = GiftPackManager.get("230509001")
	if packs  then
		UIUtil.ShowMessage(Localization:GetString("105065"), 1, "130056",nil, function()
			UIManager:GetInstance():OpenWindow(UIWindowNames.UIScrollPack, {anim = true},packs)
		end)
	end
	
end

return MasteryPage